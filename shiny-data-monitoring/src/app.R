

#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/


library(shiny)
library(scales)
library(forcats)
library(tidyverse)
library(ggplot2)
library(DT)
library(shinythemes)
library(plotly)
library(ggthemes)
library(Hmisc)
library(kableExtra) # to create nice tables
library(DT) # to create interactive tables
library(here)
library(hablar)
library(lubridate)
library(janitor)
library(UpSetR)


# notes for version.1.02 <- Redcap data downloaded as of 08/15 could not be used for fucntion retype() due to the following sleep related problematic variables :
#sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur, to solve this issue these variables were removed from the original dataset named "data", when
# while doing qulity checks on the  another dataset "data.sleep_hours" was created where sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur were selected and reformatted,
#test records and pt who have withdrawn were removed,
# Additionally at the following step # recode NAs to 8 in the original dataset, select DAG as well, data.sleep_hours was used instead of the original data to offset mismatch during full_join
#Read Data


tokenm1 <- rstudioapi::askForPassword("Enter your MCC1 API token")
tokenm2 <- rstudioapi::askForPassword("Enter your MCC2 API token")
tokenm1t <- rstudioapi::askForPassword("Enter your MCC1 Thoracic API token")
tokenm2k <- rstudioapi::askForPassword("Enter your MCC2 TKA API token")
#!/usr/bin/env Rscript


url <- "https://redcap.tacc.utexas.edu/api/"
formDatam1 <- list("token"=tokenm1,
                   content='report',
                   format='csv',
                   report_id='292',
                   csvDelimiter='',
                   rawOrLabel='raw',
                   rawOrLabelHeaders='raw',
                   exportCheckboxLabel='false',
                   returnFormat='csv'
)

m1_complete <- httr::POST(url, body = formDatam1, encode = "form")
m1_complete_result1 <- httr::content(m1_complete)


m1_complete_result1 <- m1_complete_result1 %>% 
  mutate(redcap_repeat_instrument=case_when(redcap_event_name == "baseline_visit_arm_1" & is.na(redcap_repeat_instrument)  ~ "other",
                                            TRUE ~ as.character(redcap_repeat_instrument)))


# filter the most recent baseline visit 
m1_result_baseline <- m1_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  group_by(record_id,redcap_event_name) %>%
  top_n(1,redcap_repeat_instance) %>% 
  ungroup()

#define function to remove columns where all rows have NA

not_all_na <- function(x) any(!is.na(x))


#create dataset for functional
m1_result_functional <- m1_result_baseline %>% 
  filter(redcap_repeat_instrument == "functional_testing") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)



#create  a dataset for QST
m1_result_qst <- m1_result_baseline %>% 
  filter(redcap_repeat_instrument == "qst_mcc1_v03") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#create  a dataset for blood
m1_result_bld <- m1_result_baseline %>% 
  filter(redcap_repeat_instrument == "blood_sample_collection_and_processing_crf") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#create  a dataset for imgaging
m1_result_img <- m1_result_baseline %>% 
  filter(redcap_repeat_instrument == "imaging_mcc1_v09") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#Create a dataset for other surveys


m1_complete_baseline_other <- m1_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  filter(redcap_repeat_instrument == "other")  %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument)


m1_baseline <- full_join(m1_result_functional,m1_result_bld, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m1_result_img, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m1_result_qst, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m1_complete_baseline_other , by = c("record_id","redcap_event_name","redcap_data_access_group")) 



event <- c("6wks_postop_arm_1",	
           "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")


m1_columns <- names(m1_baseline) 

m1_non_baseline <- m1_complete_result1 %>% 
  filter(redcap_event_name %in% event) %>% 
  select(names(m1_baseline))




data1 <- rbind(m1_non_baseline,m1_baseline)



#get list of Early withdrawals
url <- "https://redcap.tacc.utexas.edu/api/"
formData_withdraw <- list("token"=tokenm1,
                          content='report',
                          format='csv',
                          report_id='473',
                          csvDelimiter='',
                          rawOrLabel='raw',
                          rawOrLabelHeaders='raw',
                          exportCheckboxLabel='false',
                          returnFormat='csv'
)
response_withdraw <- httr::POST(url, body = formData_withdraw, encode = "form")
result_withdraw <- httr::content(response_withdraw)

result_withdraw <- result_withdraw %>% 
  filter(early_withdrawal_v04_complete == 2) %>% 
  select(record_id)

# pull visit date data mcc1
#!/usr/bin/env Rscript

url <- "https://redcap.tacc.utexas.edu/api/"
m1form_surg <- list("token"=tokenm1,
                    content='report',
                    format='csv',
                    report_id='494',
                    csvDelimiter='',
                    rawOrLabel='raw',
                    rawOrLabelHeaders='raw',
                    exportCheckboxLabel='false',
                    returnFormat='csv'
)
m1response_surg <- httr::POST(url, body = m1form_surg, encode = "form")
m1result_surg <- httr::content(m1response_surg)
print(m1result_surg)


# determine mcc1 days from today

m1days_from_sysdate <- m1result_surg %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,Sys.time(),units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,Sys.time(),units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,Sys.time(),units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "days_from_today") %>% 
  mutate(days_from_today = gsub("days","",days_from_today)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(days_from_today = round(as.numeric(days_from_today))) %>%
  mutate(last_seen = case_when(
    days_from_today >= -90 &  days_from_today  <= 0 ~ "0-90 days ago",
    days_from_today  >= -180 &  days_from_today  <= -91 ~ "91-180 days ago",
    days_from_today  >= 1 ~ "Future visit",
    TRUE ~ "more than 180 days ago"
  ))  %>% 
  mutate(last_seen = as.factor(last_seen))




#Read Data mcc2

# pull visit date data mcc2
#!/usr/bin/env Rscript

url <- "https://redcap.tacc.utexas.edu/api/"
m2form_surg <- list("token"=tokenm2,
                    content='report',
                    format='csv',
                    report_id='498',
                    csvDelimiter='',
                    rawOrLabel='raw',
                    rawOrLabelHeaders='raw',
                    exportCheckboxLabel='false',
                    returnFormat='csv'
)
m2response_surg <- httr::POST(url, body = m2form_surg, encode = "form")
m2result_surg <- httr::content(m2response_surg)




# determine mcc2 days from today

m2days_from_sysdate <- m2result_surg %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,Sys.time(),units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,Sys.time(),units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,Sys.time(),units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "days_from_today") %>% 
  mutate(days_from_today = gsub("days","",days_from_today)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(days_from_today = round(as.numeric(days_from_today))) %>%
  mutate(last_seen = case_when(
    days_from_today >= -90 &  days_from_today  <= 0 ~ "0-90 days ago",
    days_from_today  >= -180 &  days_from_today  <= -91 ~ "91-180 days ago",
    days_from_today  >= 1 ~ "Future visit",
    TRUE ~ "more than 180 days ago"
  )) %>% 
  mutate(last_seen = as.factor(last_seen))




#!/usr/bin/env Rscript
url <- "https://redcap.tacc.utexas.edu/api/"
formDatam2 <- list("token"=tokenm2,
                   content='report',
                   format='csv',
                   report_id='448',
                   csvDelimiter='',
                   rawOrLabel='raw',
                   rawOrLabelHeaders='raw',
                   exportCheckboxLabel='false',
                   returnFormat='csv'
)

m2_complete_response <- httr::POST(url, body = formDatam2, encode = "form")
m2_complete_result <- httr::content(m2_complete_response)
print(m2_complete_result)


m2_complete_result1 <- m2_complete_result %>% 
  mutate(redcap_repeat_instrument=case_when(redcap_event_name == "baseline_visit_arm_1" & is.na(redcap_repeat_instrument)  ~ "other",
                                            TRUE ~ as.character(redcap_repeat_instrument)))


# filter the most recent baseline visit 
m2_result_baseline <- m2_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  group_by(record_id,redcap_event_name) %>%
  top_n(1,redcap_repeat_instance) %>% 
  ungroup()

#define function to remove columns where all rows have NA

not_all_na <- function(x) any(!is.na(x))


#create dataset for functional
m2_result_functional <- m2_result_baseline %>% 
  filter(redcap_repeat_instrument == "functional_testing_mcc2_v01") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)



#create  a dataset for QST
m2_result_qst <- m2_result_baseline %>% 
  filter(redcap_repeat_instrument == "qst_mcc1_v03") %>% 
  select(where(not_all_na),record_id,
         redcap_event_name,
         redcap_repeat_instrument,
         redcap_repeat_instance,
         redcap_data_access_group,
         pmachgchestpainyn,
         pmapainregion,
         pmahighestloc,
         pmalowestloc,
         pmamostpain,
         pptremoter1val,
         pptremoter1val_d,
         pptremoter2val,
         pptremoter2val_d,
         pptremoter3val,
         pptremoter3val_d,
         dmacontr1pain,
         dmacontr1pain_d,
         dmacontr2pain,
         dmacontr2pain_d,
         dmacontr3pain,
         dmacontr3pain_d,
         dmacontr4pain,
         dmacontr4pain_d,
         dmacontr5pain,
         dmacontr5pain_d,
         dmaindxr1pain,
         dmaindxr1pain_d,
         dmaindxr2pain,
         dmaindxr2pain_d,
         dmaindxr3pain,
         dmaindxr3pain_d,
         dmaindxr4pain,
         dmaindxr4pain_d,
         dmaindxr5pain,
         dmaindxr5pain_d,
         dmasenscompare,
         dmaptcontr1pain,
         dmaptcontr1pain_d,
         dmaptcontr2pain,
         dmaptcontr2pain_d,
         dmaptcontr3pain,
         dmaptcontr3pain_d,
         dmaptcontr4pain,
         dmaptcontr4pain_d,
         dmaptcontr5pain,
         dmaptcontr5pain_d,
         dmaptindxr1pain,
         dmaptindxr1pain_d,
         dmaptindxr2pain,
         dmaptindxr2pain_d,
         dmaptindxr3pain,
         dmaptindxr3pain_d,
         dmaptindxr4pain,
         dmaptindxr4pain_d,
         dmaptindxr5pain,
         dmaptindxr5pain_d,
         dmaptspecsite_3m,
         dmaptsenscompare,
         dmatestcompyn,
         dmatestcompyn_3m,
         dmatestcompwhich___1,
         dmatestcompwhich___2,
         dmatestcompwhich_3m___1,
         dmatestcompwhich_3m___2,
         dmatestcompwhich_3m___3,
         dmatestcompwhich_3m___4,
         dmanotes,
         pptindxr1val,
         pptindxr1val_d,
         pptindxr2val,
         pptindxr2val_d,
         pptindxr3val,
         pptindxr3val_d,
         pptcompleteyn,
         pptnotes,
         tsremoter1initial,
         tsremoter1initial_d,
         tsremoter1final,
         tsremoter1final_d,
         tsremoter2initial,
         tsremoter2initial_d,
         tsremoter2final,
         tsremoter2final_d,
         tsremoter3initial,
         tsremoter3initial_d,
         tsremoter3final,
         tsremoter3final_d,
         tsremoteafter15,
         tsfinalpainremafts31,
         tsindxr1initial,
         tsindxr1initial_d,
         tsindxr1final,
         tsindxr1final_d,
         tsindxr2initial,
         tsindxr2initial_d,
         tsindxr2final,
         tsindxr2final_d,
         tsindxr3initial,
         tsindxr3initial_d,
         tsindxr3final,
         tsindxr3final_d,
         tsindxafter15,
         tsindxafter30,
         tscompleted,
         tsnotes,
         cpmcoldwatertemp,
         cpmcoldwaterpain30,
         cpmcoldwaterpain30_d,
         cpmcoldwaterpain60,
         cpmcoldwaterpain60_d,
         cpmbathrangeyn,
         cpmoutrangetime,
         cpmpptremr1val,
         cpmpptremr1val_d,
         cpmpptremr2val,
         cpmpptremr2val_d,
         cpmpptremr3val,
         cpmpptremr3val_d,
         cpmcompleteyn,
         cpmnotes,
         cuffpfmricontraindyn,
         cuffpfmrinondomleg,
         cuffpfmripressure,
         cuffpfmripressure_d,
         qst_mcc1_v03_complete) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)

#create  a dataset for blood
m2_result_bld <- m2_result_baseline %>% 
  filter(redcap_repeat_instrument == "blood_sample_collection_and_processing_crf") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#create  a dataset for imgaging
m2_result_img <- m2_result_baseline %>% 
  filter(redcap_repeat_instrument == "imaging_mcc2_v01") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#Create a dataset for other surveys


m2_complete_baseline_other <- m2_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  filter(redcap_repeat_instrument == "other")  %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument)


m2_baseline <- full_join(m2_result_functional,m2_result_bld, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m2_result_img, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m2_result_qst, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m2_complete_baseline_other , by = c("record_id","redcap_event_name","redcap_data_access_group")) 



event <- c("6wks_postop_arm_1",	
           "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")


m2_columns <- names(m2_baseline) 

m2_non_baseline <- m2_complete_result1 %>% 
  filter(redcap_event_name %in% event) %>% 
  select(names(m2_baseline))




mcc2data1 <- rbind(m2_non_baseline,m2_baseline)

# mcc2 withdrawals

#get list of Early withdrawals
url <- "https://redcap.tacc.utexas.edu/api/"
m2formData_withdraw <- list("token"=tokenm2,
                            content='report',
                            format='csv',
                            report_id='8',
                            csvDelimiter='',
                            rawOrLabel='raw',
                            rawOrLabelHeaders='raw',
                            exportCheckboxLabel='false',
                            returnFormat='csv'
)
m2response_withdraw <- httr::POST(url, body = m2formData_withdraw, encode = "form")
m2result_withdraw <- httr::content(m2response_withdraw)

m2result_withdraw <- m2result_withdraw %>% 
  filter(early_withdrawal_v04_complete == 2) %>% 
  select(record_id)


withdrawm2 <- m2result_withdraw$record_id 


# #explore parsing problems
# problems <- data1 %>% 
#    select(record_id,redcap_event_name,c(402,327,656,288)) %>% # select problematic cols
#   slice(1384,1407,1487,1478) #filter problematic rows
# #test records that should be ignored

# all sites
test_records <- c('10000','20000','40000','50000','60000','70000','80000','90000','100000','110000','120000')

# withdraw

withdrawm1 <- result_withdraw

#read data mcc1 thoracic

url <- "https://redcap.tacc.utexas.edu/api/"
formDatam1t <- list("token"=tokenm1t,
                    content='report',
                    format='csv',
                    report_id='546',
                    csvDelimiter='',
                    rawOrLabel='raw',
                    rawOrLabelHeaders='raw',
                    exportCheckboxLabel='false',
                    returnFormat='csv'
)

m1t_complete <- httr::POST(url, body = formDatam1t, encode = "form")
m1t_complete_result1 <- httr::content(m1t_complete)


m1t_complete_result1 <- m1t_complete_result1 %>% 
  mutate(redcap_repeat_instrument=case_when(redcap_event_name == "baseline_visit_arm_1" & is.na(redcap_repeat_instrument)  ~ "other",
                                            TRUE ~ as.character(redcap_repeat_instrument)))



# filter the most recent baseline visit 
m1t_result_baseline <- m1t_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  group_by(record_id,redcap_event_name) %>%
  top_n(1,redcap_repeat_instance) %>% 
  ungroup()

#define function to remove columns where all rows have NA

not_all_na <- function(x) any(!is.na(x))



new_row_func <- tibble(record_id = 9999, ftdbctestcmpltno = runif(1),ftdbcaddlnotes = runif(1)) %>% 
  mutate(ftdbcaddlnotes = as.character(ftdbcaddlnotes))


#create dataset for functional
m1t_result_functional <- m1t_result_baseline %>% 
  filter(redcap_repeat_instrument == "functional_testing_mcc2_v01") %>% 
  add_row(new_row_func) %>% # adding new row here with a value for ftdbctestcmpltno so that it doesnt get dropped during   select(where(not_all_na)) 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance) %>% 
  filter(record_id != 9999) 






#create  a dataset for QST

new_row_qst <- tibble(record_id = 9999, pmachgchestpainyn = runif(1),pmapainregion = runif(1),pmahighestloc= runif(1),
                      pmalowestloc = runif(1),pmamostpain = runif(1), dmaptcontr1pain= runif(1),dmaptcontr1pain_d = runif(1),
                      dmaptcontr2pain = runif(1),dmaptcontr2pain_d= runif(1), dmaptcontr3pain= runif(1),dmaptcontr3pain_d= runif(1),
                      dmaptcontr4pain= runif(1),dmaptcontr4pain_d = runif(1), dmaptcontr5pain= runif(1),         
                      dmaptcontr5pain_d= runif(1),dmaptindxr1pain= runif(1),dmaptindxr1pain_d = runif(1),dmaptindxr2pain= runif(1),dmaptindxr2pain_d= runif(1),       
                      dmaptindxr3pain= runif(1),dmaptindxr3pain_d= runif(1),dmaptindxr4pain= runif(1), dmaptindxr4pain_d= runif(1),dmaptindxr5pain= runif(1),         
                      dmaptindxr5pain_d= runif(1),dmaptspecsite_3m= runif(1),dmaptsenscompare= runif(1),dmatestcompyn= runif(1),dmatestcompyn_3m= runif(1),        
                      dmatestcompwhich___1= runif(1),dmatestcompwhich___2= runif(1), dmatestcompwhich_3m___1= runif(1),dmatestcompwhich_3m___2= runif(1),
                      dmatestcompwhich_3m___3 = runif(1),
                      dmatestcompwhich_3m___4 = runif(1),  dmanotes= runif(1),tsnotes= runif(1),cpmoutrangetime= runif(1),pptnotes= runif(1)) %>% 
  mutate(dmanotes = as.character(dmanotes)) %>% 
  mutate(tsnotes = as.character(tsnotes))  %>% 
  mutate(pptnotes = as.character(pptnotes)) 

m1t_result_qst <- m1t_result_baseline %>% 
  filter(redcap_repeat_instrument == "qst_mcc1_v03") %>% 
  add_row(new_row_qst) %>%
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)  %>% 
  filter(record_id != 9999) 




#create  a dataset for blood
m1t_result_bld <- m1t_result_baseline %>% 
  filter(redcap_repeat_instrument == "blood_sample_collection_and_processing_crf") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#create  a dataset for imgaging

#creat a pseudo row so that fmricufft1techrating2 does not get dropped because of all NAs for all subjects

new_row_imgm1t <- tibble(record_id = 9999, fmricufft1techrating2 = runif(1),fmricufft1repeated = runif(1),fmricuffcalfpressurerecal=runif(1),
                         fmricuffcalfpressurerecal2= runif(1))


m1t_result_img <- m1t_result_baseline %>% 
  filter(redcap_repeat_instrument == "imaging_mcc2_v01") %>%
  add_row(new_row_imgm1t) %>% # adding new row here with a value for fmricufft1techrating2 so that it doesnt get dropped during   select(where(not_all_na)) 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance) %>% 
  filter(record_id != 9999) 






#Create a dataset for other surveys


m1t_complete_baseline_other <- m1t_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  filter(redcap_repeat_instrument == "other")  %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument)


m1t_baseline <- full_join(m1t_result_functional,m1t_result_bld, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m1t_result_img, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m1t_result_qst, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m1t_complete_baseline_other , by = c("record_id","redcap_event_name","redcap_data_access_group")) 



event <- c("6wks_postop_arm_1",	
           "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")


m1t_columns <- names(m1t_baseline) 

m1t_non_baseline <- m1t_complete_result1 %>% 
  filter(redcap_event_name %in% event) %>% 
  select(names(m1t_baseline))



datam1t_1 <- rbind(m1t_non_baseline,m1t_baseline)


#get list of Early withdrawals
url <- "https://redcap.tacc.utexas.edu/api/"
formData_withdrawm1t <- list("token"=tokenm1t,
                             content='report',
                             format='csv',
                             report_id='309',
                             csvDelimiter='',
                             rawOrLabel='raw',
                             rawOrLabelHeaders='raw',
                             exportCheckboxLabel='false',
                             returnFormat='csv'
)
response_withdrawm1t <- httr::POST(url, body = formData_withdrawm1t, encode = "form")
result_withdrawm1t <- httr::content(response_withdrawm1t)

result_withdrawm1t <- result_withdrawm1t %>% 
  filter(early_withdrawal_v04_complete == 2) %>% 
  select(record_id)

withdrawm1t <- result_withdrawm1t

# pull visit date data mcc1
#!/usr/bin/env Rscript

url <- "https://redcap.tacc.utexas.edu/api/"
m1tform_surg <- list("token"=tokenm1t,
                     content='report',
                     format='csv',
                     report_id='499',
                     csvDelimiter='',
                     rawOrLabel='raw',
                     rawOrLabelHeaders='raw',
                     exportCheckboxLabel='false',
                     returnFormat='csv'
)
m1tresponse_surg <- httr::POST(url, body = m1tform_surg, encode = "form")
m1tresult_surg <- httr::content(m1tresponse_surg)
print(m1tresult_surg)


# determine mcc1 days from today

m1tdays_from_sysdate <- m1tresult_surg %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,Sys.time(),units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,Sys.time(),units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,Sys.time(),units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "days_from_today") %>% 
  mutate(days_from_today = gsub("days","",days_from_today)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(days_from_today = round(as.numeric(days_from_today))) %>%
  mutate(last_seen = case_when(
    days_from_today >= -90 &  days_from_today  <= 0 ~ "0-90 days ago",
    days_from_today  >= -180 &  days_from_today  <= -91 ~ "91-180 days ago",
    days_from_today  >= 1 ~ "Future visit",
    TRUE ~ "more than 180 days ago"
  ))  %>% 
  mutate(last_seen = as.factor(last_seen))



#read data mcc2 knee

url <- "https://redcap.tacc.utexas.edu/api/"
formDatam2k <- list("token"=tokenm2k,
                    content='report',
                    format='csv',
                    report_id='384',
                    csvDelimiter='',
                    rawOrLabel='raw',
                    rawOrLabelHeaders='raw',
                    exportCheckboxLabel='false',
                    returnFormat='csv'
)

m2k_complete <- httr::POST(url, body = formDatam2k, encode = "form")
m2k_complete_result1 <- httr::content(m2k_complete)


m2k_complete_result1 <- m2k_complete_result1 %>% 
  mutate(redcap_repeat_instrument=case_when(redcap_event_name == "baseline_visit_arm_1" & is.na(redcap_repeat_instrument)  ~ "other",
                                            TRUE ~ as.character(redcap_repeat_instrument)))



# filter the most recent baseline visit 
m2k_result_baseline <- m2k_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  group_by(record_id,redcap_event_name) %>%
  top_n(1,redcap_repeat_instance) %>% 
  ungroup()

#define function to remove columns where all rows have NA

not_all_na <- function(x) any(!is.na(x))


#create dataset for functional

new_row_funcm2k <- tibble(record_id = 9999, walk10incompletereason = runif(1))
m2k_result_functional <- m2k_result_baseline %>% 
  filter(redcap_repeat_instrument == "functional_testing") %>% 
  add_row(new_row_funcm2k) %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance) %>% 
  filter(record_id != 9999) 





#create  a dataset for QST
#creat a pseudo row so that tsnotes does not get dropped because of all NAs for all subjects

new_row_qstm2k <- tibble(record_id = 9999, tsnotes = runif(1)) %>% 
  mutate(tsnotes=as.character(tsnotes))


m2k_result_qst <- m2k_result_baseline %>% 
  filter(redcap_repeat_instrument == "qst_mcc1_v03") %>% 
  add_row(new_row_qstm2k) %>% # adding new row here with a value for tsnotes so that it doesnt get dropped during   select(where(not_all_na)) 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance) %>% 
  filter(record_id != 9999) 

#creat a pseudo row so that cpmoutrangetime does not get dropped because of all NAs for all subjects

new_row_bath_qstm2k <- tibble(record_id = 9999, cpmoutrangetime = runif(1))


m2k_result_qst <- m2k_result_baseline %>% 
  filter(redcap_repeat_instrument == "qst_mcc1_v03") %>% 
  add_row(new_row_bath_qstm2k) %>% # adding new row here with a value for cpmoutrangetime so that it doesnt get dropped during   select(where(not_all_na)) 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance) %>% 
  filter(record_id != 9999) 


#create  a dataset for blood
m2k_result_bld <- m2k_result_baseline %>% 
  filter(redcap_repeat_instrument == "blood_sample_collection_and_processing_crf") %>% 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance)


#create  a dataset for imgaging

#creat a pseudo row so that fmricufft1techrating2 does not get dropped because of all NAs for all subjects

new_row_imgm2k <- tibble(record_id = 9999, fmricufft1techrating2 = runif(1))


m2k_result_img <- m2k_result_baseline %>% 
  filter(redcap_repeat_instrument == "imaging_mcc1_v09") %>%
  add_row(new_row_imgm2k) %>% # adding new row here with a value for fmricufft1techrating2 so that it doesnt get dropped during   select(where(not_all_na)) 
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument,-redcap_repeat_instance) %>% 
  filter(record_id != 9999) 






#Create a dataset for other surveys
#creat a pseudo row so that bpi_mbm_z3_rate does not get dropped because of all NAs for all subjects

new_row_bpim2k <- tibble(record_id = 9999, bpi_mbm_z3_rate = runif(1),bpi_mbm_z3_dur = runif(1))


m2k_complete_baseline_other <- m2k_complete_result1  %>%
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  filter(redcap_repeat_instrument == "other")  %>% 
  add_row(new_row_bpim2k) %>%
  select(where(not_all_na)) %>% 
  select(-redcap_repeat_instrument) %>% 
  filter(record_id != 9999) 



m2k_baseline <- full_join(m2k_result_functional,m2k_result_bld, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m2k_result_img, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m2k_result_qst, by = c("record_id","redcap_event_name","redcap_data_access_group")) %>% 
  full_join(.,m2k_complete_baseline_other , by = c("record_id","redcap_event_name","redcap_data_access_group")) 



event <- c("6wks_postop_arm_1",	
           "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")


m2k_columns <- names(m2k_baseline) 

m2k_non_baseline <- m2k_complete_result1 %>% 
  filter(redcap_event_name %in% event) %>% 
  select(names(m2k_baseline))


datam2k1 <- rbind(m2k_non_baseline,m2k_baseline)


#get list of Early withdrawals
url <- "https://redcap.tacc.utexas.edu/api/"
formData_withdrawm2k <- list("token"=tokenm2k,
                             content='report',
                             format='csv',
                             report_id='333',
                             csvDelimiter='',
                             rawOrLabel='raw',
                             rawOrLabelHeaders='raw',
                             exportCheckboxLabel='false',
                             returnFormat='csv'
)
response_withdrawm2k <- httr::POST(url, body = formData_withdrawm2k, encode = "form")
result_withdrawm2k <- httr::content(response_withdrawm2k)

result_withdrawm2k <- result_withdrawm2k %>% 
  filter(early_withdrawal_v04_complete == 2) %>% 
  select(record_id)

withdrawm2k <- result_withdrawm2k

# pull visit date data mcc1
#!/usr/bin/env Rscript

url <- "https://redcap.tacc.utexas.edu/api/"
m2kform_surg <- list("token"=tokenm2k,
                     content='report',
                     format='csv',
                     report_id='535',
                     csvDelimiter='',
                     rawOrLabel='raw',
                     rawOrLabelHeaders='raw',
                     exportCheckboxLabel='false',
                     returnFormat='csv'
)
m2kresponse_surg <- httr::POST(url, body = m2kform_surg, encode = "form")
m2kresult_surg <- httr::content(m2kresponse_surg)
print(m2kresult_surg)


# determine mcc1 days from today

m2kdays_from_sysdate <- m2kresult_surg %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,Sys.time(),units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,Sys.time(),units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,Sys.time(),units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "days_from_today") %>% 
  mutate(days_from_today = gsub("days","",days_from_today)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(days_from_today = round(as.numeric(days_from_today))) %>%
  mutate(last_seen = case_when(
    days_from_today >= -90 &  days_from_today  <= 0 ~ "0-90 days ago",
    days_from_today  >= -180 &  days_from_today  <= -91 ~ "91-180 days ago",
    days_from_today  >= 1 ~ "Future visit",
    TRUE ~ "more than 180 days ago"
  ))  %>% 
  mutate(last_seen = as.factor(last_seen))

##########REPORTS#######

data <- data1 %>% 
  filter(!record_id %in% withdrawm1$record_id) %>% 
  filter(!record_id %in% test_records) %>% 
  select(-sleepnighthourmindurhrs,-sleepnighthourmindurmins,-sleepnighthourmindur) 



# event <- c("baseline_visit_arm_1","6wks_postop_arm_1",	
#            "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")
# data <- data1 %>% 
#   filter(redcap_event_name %in% event)



#Read Data

frfunc  <- retype(data) 
#Setting Labels

label(frfunc$record_id)="Record ID"
label(frfunc$redcap_event_name)="Event Name"
label(frfunc$walk10initialpainscl)="Initial Pain Rating:"
label(frfunc$walk10initialpainscl1)="Initial Pain Rating: (double enfry)"
label(frfunc$walk10finalpainscl)="Final Pain Rating:"
label(frfunc$walk10finalpainscl1)="Final Pain Rating: (double enfry)"
label(frfunc$walk10time)="Time:"
label(frfunc$walk10time1)="Time: (double enfry)"
label(frfunc$walk10completeyn)="Test completed:"
label(frfunc$walk10incompletereason)="If no, reason why?"
label(frfunc$walk10assistyn)="Any assistance used (personal and/or device):"
label(frfunc$walk10assist_cane___1)=" (choice=Cane (all types))"
label(frfunc$walk10assist_crutch___1)=" (choice=Crutches (1 or 2, any gait pattern))"
label(frfunc$walk10assist_walkder___1)=" (choice=Walker (all types))"
label(frfunc$walk10assist_perssuppt___1)=" (choice=Personal assistance (any type of hands-on assistance or support during task, even if only briefly or for balance))"
label(frfunc$walk10assist_other___1)=" (choice=Other)"
label(frfunc$walk10comments)="Additional notes for 10m walk"
label(frfunc$tstsbpscreen)="Blood Pressure Screening:"
label(frfunc$tstsprepainscl)="Initial Pain Rating:"
label(frfunc$tstsprepainscl1)="Initial Pain Rating: (double enfry)"
label(frfunc$tstspostpainscl)="Final Pain Rating:"
label(frfunc$tstspostpainscl1)="Final Pain Rating: (double enfry)"
label(frfunc$tststime)="Time:"
label(frfunc$tststime1)="Time: (double enfry)"
label(frfunc$tstscompleteyn)="Test completed:"
label(frfunc$tstsnonreasonyn)="If no, reason why?"
label(frfunc$tstsnumbrepsyn)="# of reps completed"
label(frfunc$tstsassistyn)="Any assistance used (personal and/or chair):"
label(frfunc$tstsassist_1___1)=" (choice=push-off from arms of chair or use of assistive device)"
label(frfunc$tstsassist_2___1)=" (choice=personal assistance (any type of hands-on assistance or support during task, even if only briefly or for balance))"
label(frfunc$tstsaddnotes)="Additional notes for 5 Times Sit-to-Stand Test:"
label(frfunc$functional_testing_complete)="Complete?"
#Setting Units





#Setting Factors(will create new variable for factors)
frfunc$redcap_event_name.factor = factor(frfunc$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
frfunc$walk10initialpainscl.factor = factor(frfunc$walk10initialpainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$walk10initialpainscl1.factor = factor(frfunc$walk10initialpainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$walk10finalpainscl.factor = factor(frfunc$walk10finalpainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$walk10finalpainscl1.factor = factor(frfunc$walk10finalpainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$walk10completeyn.factor = factor(frfunc$walk10completeyn,levels=c("1","0"))
frfunc$walk10incompletereason.factor = factor(frfunc$walk10incompletereason,levels=c("1","2","3"))
frfunc$walk10assistyn.factor = factor(frfunc$walk10assistyn,levels=c("1","0"))
frfunc$walk10assist_cane___1.factor = factor(frfunc$walk10assist_cane___1,levels=c("0","1"))
frfunc$walk10assist_crutch___1.factor = factor(frfunc$walk10assist_crutch___1,levels=c("0","1"))
frfunc$walk10assist_walkder___1.factor = factor(frfunc$walk10assist_walkder___1,levels=c("0","1"))
frfunc$walk10assist_perssuppt___1.factor = factor(frfunc$walk10assist_perssuppt___1,levels=c("0","1"))
frfunc$walk10assist_other___1.factor = factor(frfunc$walk10assist_other___1,levels=c("0","1"))
frfunc$tstsbpscreen.factor = factor(frfunc$tstsbpscreen,levels=c("1","2"))
frfunc$tstsprepainscl.factor = factor(frfunc$tstsprepainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$tstsprepainscl1.factor = factor(frfunc$tstsprepainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$tstspostpainscl.factor = factor(frfunc$tstspostpainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$tstspostpainscl1.factor = factor(frfunc$tstspostpainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfunc$tstscompleteyn.factor = factor(frfunc$tstscompleteyn,levels=c("1","0"))
frfunc$tstsnonreasonyn.factor = factor(frfunc$tstsnonreasonyn,levels=c("0","1","2"))
frfunc$tstsnumbrepsyn.factor = factor(frfunc$tstsnumbrepsyn,levels=c("0","1","2","3","4"))
frfunc$tstsassistyn.factor = factor(frfunc$tstsassistyn,levels=c("1","0"))
frfunc$tstsassist_1___1.factor = factor(frfunc$tstsassist_1___1,levels=c("0","1"))
frfunc$tstsassist_2___1.factor = factor(frfunc$tstsassist_2___1,levels=c("0","1"))
frfunc$functional_testing_complete.factor = factor(frfunc$functional_testing_complete,levels=c("0","1","2"))

levels(frfunc$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(frfunc$walk10initialpainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$walk10initialpainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$walk10finalpainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$walk10finalpainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$walk10completeyn.factor)=c("Yes","No")
levels(frfunc$walk10incompletereason.factor)=c("Did not attempt","Initiated but unable to complete","Other")
levels(frfunc$walk10assistyn.factor)=c("Yes","No")
levels(frfunc$walk10assist_cane___1.factor)=c("Unchecked","Checked")
levels(frfunc$walk10assist_crutch___1.factor)=c("Unchecked","Checked")
levels(frfunc$walk10assist_walkder___1.factor)=c("Unchecked","Checked")
levels(frfunc$walk10assist_perssuppt___1.factor)=c("Unchecked","Checked")
levels(frfunc$walk10assist_other___1.factor)=c("Unchecked","Checked")
levels(frfunc$tstsbpscreen.factor)=c("Within study range (90/60 to 160/90 mmHg)","Out of study range (< 90/60 OR > 160/90 mmHg)")
levels(frfunc$tstsprepainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$tstsprepainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$tstspostpainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$tstspostpainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfunc$tstscompleteyn.factor)=c("Yes","No")
levels(frfunc$tstsnonreasonyn.factor)=c("Did not attempt: Participant declined or deemed unsafe","Initiated, but subject unable to complete (indicate # of reps completed below)","Other")
levels(frfunc$tstsnumbrepsyn.factor)=c("0","1","2","3","4")
levels(frfunc$tstsassistyn.factor)=c("Yes","No")
levels(frfunc$tstsassist_1___1.factor)=c("Unchecked","Checked")
levels(frfunc$tstsassist_2___1.factor)=c("Unchecked","Checked")
levels(frfunc$functional_testing_complete.factor)=c("Incomplete","Unverified","Complete")

#########################################################################################











table(frfunc$walk10completeyn, exclude = NULL)


#keep records for subjects who completed the test.
frdata3 <- frfunc %>% 
  filter(walk10completeyn == 1 & functional_testing_complete == 2)

table(frdata3$walk10completeyn, exclude = NULL)







#look for discrepancies in the first and the second initial pain rating 
frdata4 <- frdata3 %>% 
  mutate(init_pain_diff = walk10initialpainscl - walk10initialpainscl1) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

ferror1 <- frdata4 %>% 
  select(record_id,redcap_event_name,walk10initialpainscl,walk10initialpainscl1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10initialpainscl = case_when(is.na(walk10initialpainscl) ~ "missing",TRUE ~ as.character(walk10initialpainscl))) %>% 
  mutate(walk10initialpainscl1 = case_when(is.na(walk10initialpainscl1) ~ "missing",TRUE ~ as.character(walk10initialpainscl1) ))







#look for discrepancies between the first and the second final pain rating 
frdata5 <- frdata3 %>% 
  mutate(final_pain_diff = walk10finalpainscl - walk10finalpainscl1) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff))

ferror2 <- frdata5 %>% 
  select(record_id,redcap_event_name,walk10finalpainscl,walk10finalpainscl1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10finalpainscl = case_when(is.na(walk10finalpainscl) ~ "missing",TRUE ~ as.character(walk10finalpainscl))) %>% 
  mutate(walk10finalpainscl1 = case_when(is.na(walk10finalpainscl1) ~ "missing",TRUE ~ as.character(walk10finalpainscl1)))


ferror1_2 <- full_join(ferror1,ferror2,by = intersect(names(ferror1), names(ferror2)))





#look for discrepancies between the first and the second walk time 
frdata6 <- frdata3 %>% 
  retype() %>% 
  mutate(walk_time_diff = walk10time - walk10time1) %>% 
  filter(walk_time_diff != 0 | is.na(walk_time_diff))

ferror3 <- frdata6 %>% 
  select(record_id,redcap_event_name,walk10time,walk10time1)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10time = case_when(is.na(walk10time) ~ "missing",TRUE ~ as.character(walk10time))) %>% 
  mutate(walk10time1 = case_when(is.na(walk10time1) ~ "missing",TRUE ~ as.character(walk10time1)))



ferror1_2 <- ferror1_2 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferror3 <- ferror3 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferror1_2_3 <- full_join(ferror1_2,ferror3,by = intersect(names(ferror1_2), names(ferror3)))






# check if a reason for test not completed was marked off



frdata7 <- frfunc  %>% 
  filter(walk10completeyn == 0) %>%
  filter(is.na(walk10incompletereason))

ferror4 <- frdata7 %>% 
  select(record_id,redcap_event_name,walk10incompletereason,walk10completeyn.factor) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10incompletereason = case_when(is.na(walk10incompletereason) ~ "missing",TRUE ~ as.character(walk10incompletereason)))



ferror1_2_3 <- ferror1_2_3 %>% 
  as_tibble() %>% 
  mutate_all(as.character)


ferror4 <- ferror4  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferror1_2_3_4 <- full_join(ferror1_2_3,ferror4,by = intersect(names(ferror1_2_3), names(ferror4)))







#if walk was completed, check for records with missing values for any assistance 

ferror5 <- frdata3 %>% 
  filter(walk10completeyn == 1) %>% 
  filter(is.na(walk10assistyn)) %>% 
  select(record_id,redcap_event_name,walk10completeyn.factor,walk10assistyn)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10assistyn = case_when(is.na(walk10assistyn) ~ "missing",TRUE ~ as.character(walk10assistyn)))


ferror5 <- ferror5 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferror1_2_3_4_5 <- full_join(ferror1_2_3_4,ferror5,by = intersect(names(ferror1_2_3_4), names(ferror5)))





#if any assistance during walk test was checked off, check for records with unchecked type of assistance 

ferror6 <- frdata3 %>% 
  filter(walk10assistyn == 1) %>% 
  filter(walk10assist_cane___1 == 0 & walk10assist_crutch___1 == 0 & walk10assist_perssuppt___1 == 0 & walk10assist_other___1 == 0 & walk10assist_walkder___1 == 0) %>% 
  select(record_id,redcap_event_name,walk10assistyn.factor,walk10assist_cane___1.factor,walk10assist_crutch___1.factor,walk10assist_perssuppt___1.factor, walk10assist_other___1.factor,walk10assist_walkder___1.factor) 



ferror6 <- ferror6 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferror1_2_3_4_5_6 <- full_join(ferror1_2_3_4_5,ferror6,by = intersect(names(ferror1_2_3_4_5), names(ferror6)))






### 5 times sit to stand test#####




#Check for subjects who did not complete the test.
table(frfunc$tstscompleteyn, exclude = NULL)




#remove records with missing values for test completed.
frdata.sit <- frfunc %>% 
  drop_na(tstscompleteyn)




#Recheck if all records with missing frdata for completed tests were removed.
table(frdata.sit$tstscompleteyn, exclude = NULL)




#check for missing bp values if tsts was completed

ferror.bp <- frdata.sit %>% 
  filter(tstscompleteyn == 1 &  is.na(tstsbpscreen) ) %>% 
  select(record_id,redcap_event_name,tstsbpscreen)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


ferror.bp$tstsbpscreen <- ferror.bp$tstsbpscreen %>% replace_na("missing")




#keep records for subjects who completed the test.
frdata.sit1 <- frdata.sit %>% 
  filter(tstscompleteyn == 1 & functional_testing_complete == 2)





#look for discrepancies in the first and the second initial pain rating 
frdata.sit4 <- frdata.sit1 %>% 
  mutate(init_pain_diff.sit = tstsprepainscl - tstsprepainscl1) %>% 
  filter(init_pain_diff.sit != 0 | is.na(init_pain_diff.sit))

ferror1.sit <- frdata.sit4 %>% 
  select(record_id,redcap_event_name,tstsprepainscl,tstsprepainscl1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsprepainscl = case_when(is.na(tstsprepainscl) ~ "missing",TRUE ~ as.character(tstsprepainscl)))%>% 
  mutate(tstsprepainscl1 = case_when(is.na(tstsprepainscl1) ~ "missing",TRUE ~ as.character(tstsprepainscl1)))










#look for discrepancies between the first and the second final pain rating 
frdata.sit5 <- frdata.sit1 %>% 
  mutate(final_pain_diff.sit = tstspostpainscl - tstspostpainscl1) %>% 
  filter(final_pain_diff.sit != 0 | is.na(final_pain_diff.sit))

ferror2.sit <- frdata.sit5 %>% 
  select(record_id,redcap_event_name,tstspostpainscl,tstspostpainscl1)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstspostpainscl = case_when(is.na(tstspostpainscl) ~ "missing",TRUE ~ as.character(tstspostpainscl)))%>% 
  mutate(tstspostpainscl1 = case_when(is.na(tstspostpainscl1) ~ "missing",TRUE ~ as.character(tstspostpainscl1)))


ferrorsit1_2 <- full_join(ferror1.sit,ferror2.sit,by = intersect(names(ferror1.sit), names(ferror2.sit)))




#look for discrepancies between the first and the second activity  time 
frdata.sit6 <- frdata.sit1 %>% 
  retype() %>% 
  mutate(sit_time_diff = tststime - tststime1) %>% 
  filter(sit_time_diff != 0 | is.na(sit_time_diff))

ferror3.sit <- frdata.sit6 %>% 
  select(record_id,redcap_event_name,tststime,tststime1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tststime = case_when(is.na(tststime) ~ "missing",TRUE ~ as.character(tststime)))%>% 
  mutate(tststime1 = case_when(is.na(tststime1) ~ "missing",TRUE ~ as.character(tststime1)))



ferrorsit1_2_3 <- full_join(ferrorsit1_2,ferror3.sit,by = intersect(names(ferrorsit1_2), names(ferror3.sit)))




# check if a reason for test not completed was marked off


frdata.sit7 <- frdata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(is.na(tstsnonreasonyn))

ferror4.sit <- frdata.sit7 %>% 
  select(record_id,redcap_event_name,tstscompleteyn.factor,tstsnonreasonyn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnonreasonyn = case_when(is.na(tstsnonreasonyn) ~ "missing",TRUE ~ as.character(tstsnonreasonyn))) # recode NA to missing or leave as is



ferrorsit1_2_3 <- ferrorsit1_2_3 %>% 
  as_tibble() %>% 
  mutate_all(as.character)


ferror4.sit <- ferror4.sit %>%
  as_tibble() %>% 
  mutate_all(as.character)


ferrorsit1_2_3_4 <- full_join(ferrorsit1_2_3,ferror4.sit,by = intersect(names(ferrorsit1_2_3), names(ferror4.sit)))





#check if test was not completed but was Initiated, and the number of reps completed (n/5) were not specified)
frdata.sit8 <- frdata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(tstsnonreasonyn == 1) %>% 
  filter(is.na(tstsnumbrepsyn))

ferror5.sit <- frdata.sit8 %>% 
  select(record_id,redcap_event_name,tstscompleteyn.factor,tstsnonreasonyn.factor,tstsnumbrepsyn)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnumbrepsyn = case_when(is.na(tstsnumbrepsyn) ~ "missing",TRUE ~ as.character(tstsnumbrepsyn))) # recode NA to missing or leave as is

ferror1_2_3_4 <- ferror1_2_3_4 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferror5.sit <- ferror5.sit %>% 
  as_tibble() %>% 
  mutate_all(as.character)

###############################

ferrorsit1_2_3_4_5 <- full_join(ferrorsit1_2_3_4,ferror5.sit,by = intersect(names(ferrorsit1_2_3_4), names(ferror5.sit)))




# check for records with missing values for any assistance if test was completed

ferror6.sit <- frdata.sit1 %>% 
  filter(tstscompleteyn == 1) %>% 
  filter(is.na(tstsassistyn.factor)) %>% 
  select(record_id,redcap_event_name,tstscompleteyn.factor,tstsassistyn.factor)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsassistyn.factor = case_when(is.na(tstsassistyn.factor) ~ "missing",TRUE ~ as.character(tstsassistyn.factor))) # recode NA to missing or leave as is



ferror6.sit <- ferror6.sit %>% 
  as_tibble() %>% 
  mutate_all(as.character)

ferrorsit1_2_3_4_5_6 <- full_join(ferrorsit1_2_3_4_5,ferror6.sit,by = intersect(names(ferrorsit1_2_3_4_5), names(ferror6.sit)))




# check for records with 0 for type of assistance if walk any assistance was checked off

ferror7.sit <- frdata.sit1 %>% 
  filter(tstsassistyn == 1) %>% 
  filter(tstsassist_1___1 == 0 & tstsassist_2___1 == 0) %>% 
  select(record_id,redcap_event_name,tstsassistyn.factor,tstsassist_1___1.factor,tstsassist_2___1.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


ferrorsit1_2_3_4_5_6_7 <- full_join(ferrorsit1_2_3_4_5_6,ferror7.sit,by = intersect(names(ferrorsit1_2_3_4_5_6), names(ferror7.sit)))

ferrorsit1_2_3_4_5_6_7_bp <- full_join(ferrorsit1_2_3_4_5_6_7,ferror.bp,by = intersect(names(ferrorsit1_2_3_4_5_6_7), names(ferror.bp)))



#c0nvert record ids to as.character

#10min walk test ferrors
ferror1 <-  ferror1 %>% 
  as_tibble() %>% 
  mutate_all(as.character)
ferror2  <-  ferror2   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
ferror3  <-  ferror3   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
ferror4  <-  ferror4   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
ferror5  <-  ferror5   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
ferror6  <-  ferror6   %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#tsts test
ferror1.sit  <-  ferror1.sit   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
ferror2.sit  <-  ferror2.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
ferror3.sit  <-  ferror3.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
ferror4.sit  <-  ferror4.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
ferror5.sit  <-  ferror5.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
ferror6.sit  <-  ferror6.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
ferror7.sit  <-  ferror7.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
ferror.bp  <-  ferror.bp   %>% 
  as_tibble() %>% 
  mutate_all(as.character)


list.func <- full_join(ferror1,ferror2,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror3,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror4,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror5,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror6,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror1.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror2.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror3.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror4.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror5.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror6.sit,by=c("record_id","redcap_event_name"))%>% 
  full_join(.,ferror7.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,ferror.bp,by=c("record_id","redcap_event_name")) 






#fetch notes

frnotes.walk <- frfunc %>% 
  select(record_id,redcap_event_name,walk10comments,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

frnotes.tsts <- frfunc %>% 
  select(record_id,redcap_event_name,tstsaddnotes,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)













# create table for walk test

frwalk <- ferror1_2_3_4_5_6 %>% 
  select(c(record_id,redcap_event_name,walk10initialpainscl,walk10initialpainscl1,
           walk10finalpainscl,walk10finalpainscl1,walk10time,walk10time1,walk10completeyn.factor,
           walk10incompletereason,walk10assistyn.factor,walk10assist_cane___1.factor,walk10assist_crutch___1.factor,
           walk10assist_walkder___1.factor,walk10assist_perssuppt___1.factor,walk10assist_other___1.factor))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 








#create table for tsts test

frtsts <- ferrorsit1_2_3_4_5_6_7_bp %>% 
  select(c(record_id,redcap_event_name,tstsprepainscl,
           tstsprepainscl1,tstspostpainscl,tstspostpainscl1,tststime,tststime1  ,
           tstscompleteyn.factor, tstsnonreasonyn,tstsnumbrepsyn,tstsassistyn.factor,
           tstsassist_1___1.factor,tstsassist_2___1.factor,tstsbpscreen )) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 











#ensure each combination of ID and redcap event has one row with all values and is not duplicated
frwalk[frwalk== ""] <- NA
frwalk1 <- frwalk  %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes
#walk with notes

frwalk1_notes <- left_join(frwalk1,frnotes.walk,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)







#ensure each combination of ID and redcap event has one row with all values and is not duplicated
frtsts[frtsts== ""] <- NA
frtsts1 <- frtsts %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#tsts with notes
# tsts1[] <- lapply(tsts1, as.character)
# notes.tsts[] <- lapply(notes.tsts, as.character)

frtsts_notes <- left_join(frtsts1,frnotes.tsts,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#create final table

frfunc_table <- full_join(frwalk1_notes,frtsts_notes,by = intersect(names(frwalk1_notes), names(frtsts_notes))) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

#ensure each combination of ID and redcap event has one row with all values and is not duplicated

frfunc_table[frfunc_table== ""] <- NA
frfunc_table <-  frfunc_table %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  relocate(tstsaddnotes,.after = last_col()) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  left_join(.,m1days_from_sysdate, by=c("record_id","redcap_event_name"))




#####imaging report########

#Read Data
irimaging <-  data



#Setting Labels

label( irimaging$record_id)="Record ID"
label( irimaging$redcap_event_name)="Event Name"
label( irimaging$fmricuff_initials)="Investigator initials:"
label( irimaging$fmripatientname)="Verify Patient Name (as entered into scanner console):  Patient name: first name: followed by a 5-digit REDCap patient ID followed by < visit code>; last name: A2CPS Site code: NS for Northshore; UI for UIC; UC for U of Chicago; UM for U of Michigan Visit code: V1 for baseline visit; V3 for 3-month visit Example: NS10078V1 (first name) A2CPS (last name) "
label( irimaging$fmricuffleg)="Cuff applied to R/L leg:(hint: MCC1: contralateral to surgical knee)"
label( irimaging$fmricuffcontrarecal)="Re-calibration of pressure needed:"
label( irimaging$fmricuffcalfpressurerecal)="Pressure 2:"
label( irimaging$fmricuffcalfpressurerecal2)="Pressure 2: (double entry)"
label( irimaging$fmricufft1techrating)="Please enter technologists quality rating for the T1 scan: "
label( irimaging$fmricufft1repeated)="T1 scan repeated?"
label( irimaging$fmricufft1techrating2)="Please enter technologists quality rating for the 2nd T1 scan: "
label( irimaging$fmricuffrestpainss)="Surgical site pain"
label( irimaging$fmricuffrestpainss2)="Surgical site pain (double entry)"
label( irimaging$fmricuffrestpainovrall)="Body pain"
label( irimaging$fmricuffrestpainovrall2)="Body pain (double entry)"
label( irimaging$fmricuffcurrpainaftfirstscanss)="Surgical site pain"
label( irimaging$fmricuffcurrpainaftfirstscanss2)="Surgical site pain (double entry)"
label( irimaging$fmricuffcurrpainaftfirstscanovrall)="Body pain"
label( irimaging$fmricuffcurrpainaftfirstscanovrall2)="Body pain (double entry)"
label( irimaging$fmricuffcurrpainaftfirstscancp)="Cuff pain"
label( irimaging$fmricuffcurrpainaftfirstscancp2)="Cuff pain (double entry)"
label( irimaging$fmricuffpainbegin)="cuff pain (beginning)"
label( irimaging$fmricuffpainbegin2)="cuff pain (beginning) (double entry)"
label( irimaging$fmricuffpainmid)="cuff pain (middle)"
label( irimaging$fmricuffpainmid2)="cuff pain (middle) (double entry)"
label( irimaging$fmricuffpainend)="cuff pain (end)"
label( irimaging$fmricuffpainend2)="cuff pain (end) (double entry)"
label( irimaging$fmricuffpaincpbegin)="cuff pain (beginning)"
label( irimaging$fmricuffpaincpbegin2)="cuff pain (beginning) (double entry)"
label( irimaging$fmricuffpaincpmid)="cuff pain (middle)"
label( irimaging$fmricuffpaincpmid2)="cuff pain (middle) (double entry)"
label( irimaging$fmricuffpaincpend)="cuff pain (end)"
label( irimaging$fmricuffpaincpend2)="cuff pain (end) (double entry)"
label( irimaging$fmricuffpainrestscanbegin)="cuff pain (beginning)"
label( irimaging$fmricuffpainrestscanbegin2)="cuff pain (beginning) (double entry)"
label( irimaging$fmricuffpainrestscanmid)="cuff pain (middle)"
label( irimaging$fmricuffpainrestscanmid2)="cuff pain (middle) (double entry)"
label( irimaging$fmricuffpainrestscanend)="cuff pain (end)"
label( irimaging$fmricuffpainrestscanend2)="cuff pain (end) (double entry)"
label( irimaging$fmricuffpainaftlastscanss)="Surgical site pain"
label( irimaging$fmricuffpainaftlastscanss2)="Surgical site pain (double entry)"
label( irimaging$fmricuffpainaftlastscanany)="Body pain"
label( irimaging$fmricuffpainaftlastscanany2)="Body pain (double entry)"
label( irimaging$fmricuffcompletescl)="Test Completed:"
label( irimaging$fmricufft1yn)="T1"
label( irimaging$fmricuffdwiyn)="DWI"
label( irimaging$fmricuffrest1yn)="1rst Resting state"
label( irimaging$fmricuffipyn)="fMRI individualized pressure"
label( irimaging$fmricuffcpyn)="fMRI standard pressure"
label( irimaging$fmricuffrest2yn)="2nd Resting state"
label( irimaging$fmricuffdicuploaded)="Dicom files uploaded to TACC:"
label( irimaging$fmricuffdicupdate)="Upload date/time"
label( irimaging$fmricuffnotes)="Additional notes for  irimaging"
label( irimaging$imaging_mcc1_v09_complete)="Complete?"




#Setting Units


#Setting Factors(will create new variable for factors)
irimaging$redcap_event_name.factor = factor(   irimaging$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
irimaging$fmricuffleg.factor = factor(   irimaging$fmricuffleg,levels=c("1","2"))
irimaging$fmricuffcontrarecal.factor = factor(   irimaging$fmricuffcontrarecal,levels=c("1","0"))
irimaging$fmricufft1techrating.factor = factor(   irimaging$fmricufft1techrating,levels=c("3","2","1"))
irimaging$fmricufft1repeated.factor = factor(   irimaging$fmricufft1repeated,levels=c("1","0"))
irimaging$fmricufft1techrating2.factor = factor(   irimaging$fmricufft1techrating2,levels=c("3","2","1"))
irimaging$fmricuffrestpainss.factor = factor(   irimaging$fmricuffrestpainss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffrestpainss2.factor = factor(   irimaging$fmricuffrestpainss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffrestpainovrall.factor = factor(   irimaging$fmricuffrestpainovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffrestpainovrall2.factor = factor(   irimaging$fmricuffrestpainovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcurrpainaftfirstscanss.factor = factor(   irimaging$fmricuffcurrpainaftfirstscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcurrpainaftfirstscanss2.factor = factor(   irimaging$fmricuffcurrpainaftfirstscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcurrpainaftfirstscanovrall.factor = factor(   irimaging$fmricuffcurrpainaftfirstscanovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcurrpainaftfirstscanovrall2.factor = factor(   irimaging$fmricuffcurrpainaftfirstscanovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcurrpainaftfirstscancp.factor = factor(   irimaging$fmricuffcurrpainaftfirstscancp,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcurrpainaftfirstscancp2.factor = factor(   irimaging$fmricuffcurrpainaftfirstscancp2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainbegin.factor = factor(   irimaging$fmricuffpainbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainbegin2.factor = factor(   irimaging$fmricuffpainbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainmid.factor = factor(   irimaging$fmricuffpainmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainmid2.factor = factor(   irimaging$fmricuffpainmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainend.factor = factor(   irimaging$fmricuffpainend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainend2.factor = factor(   irimaging$fmricuffpainend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpaincpbegin.factor = factor(   irimaging$fmricuffpaincpbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpaincpbegin2.factor = factor(   irimaging$fmricuffpaincpbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpaincpmid.factor = factor(   irimaging$fmricuffpaincpmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpaincpmid2.factor = factor(   irimaging$fmricuffpaincpmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpaincpend.factor = factor(   irimaging$fmricuffpaincpend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpaincpend2.factor = factor(   irimaging$fmricuffpaincpend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainrestscanbegin.factor = factor(   irimaging$fmricuffpainrestscanbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainrestscanbegin2.factor = factor(   irimaging$fmricuffpainrestscanbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainrestscanmid.factor = factor(   irimaging$fmricuffpainrestscanmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainrestscanmid2.factor = factor(   irimaging$fmricuffpainrestscanmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainrestscanend.factor = factor(   irimaging$fmricuffpainrestscanend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainrestscanend2.factor = factor(   irimaging$fmricuffpainrestscanend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainaftlastscanss.factor = factor(   irimaging$fmricuffpainaftlastscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainaftlastscanss2.factor = factor(   irimaging$fmricuffpainaftlastscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainaftlastscanany.factor = factor(   irimaging$fmricuffpainaftlastscanany,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffpainaftlastscanany2.factor = factor(   irimaging$fmricuffpainaftlastscanany2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimaging$fmricuffcompletescl.factor = factor(   irimaging$fmricuffcompletescl,levels=c("1","2","0"))
irimaging$fmricufft1yn.factor = factor(   irimaging$fmricufft1yn,levels=c("1","0"))
irimaging$fmricuffdwiyn.factor = factor(   irimaging$fmricuffdwiyn,levels=c("1","0"))
irimaging$fmricuffrest1yn.factor = factor(   irimaging$fmricuffrest1yn,levels=c("1","0"))
irimaging$fmricuffipyn.factor = factor(   irimaging$fmricuffipyn,levels=c("1","0"))
irimaging$fmricuffcpyn.factor = factor(   irimaging$fmricuffcpyn,levels=c("1","0"))
irimaging$fmricuffrest2yn.factor = factor(   irimaging$fmricuffrest2yn,levels=c("1","0"))
irimaging$fmricuffdicuploaded.factor = factor(   irimaging$fmricuffdicuploaded,levels=c("1","0"))
irimaging$imaging_mcc1_v09_complete.factor = factor(irimaging$imaging_mcc1_v09_complete,levels=c("0","1","2"))

levels( irimaging$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels( irimaging$fmricuffleg.factor)=c("Right","Left")
levels( irimaging$fmricuffcontrarecal.factor)=c("Yes","No")
levels( irimaging$fmricufft1techrating.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels( irimaging$fmricufft1repeated.factor)=c("Yes","No")
levels( irimaging$fmricufft1techrating2.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels( irimaging$fmricuffrestpainss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffrestpainss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffrestpainovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffrestpainovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcurrpainaftfirstscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcurrpainaftfirstscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcurrpainaftfirstscanovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcurrpainaftfirstscanovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcurrpainaftfirstscancp.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcurrpainaftfirstscancp2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpaincpbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpaincpbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpaincpmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpaincpmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpaincpend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpaincpend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainrestscanbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainrestscanbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainrestscanmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainrestscanmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainrestscanend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainrestscanend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainaftlastscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainaftlastscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainaftlastscanany.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffpainaftlastscanany2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( irimaging$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
levels( irimaging$fmricufft1yn.factor)=c("Yes","No")
levels( irimaging$fmricuffdwiyn.factor)=c("Yes","No")
levels( irimaging$fmricuffrest1yn.factor)=c("Yes","No")
levels( irimaging$fmricuffipyn.factor)=c("Yes","No")
levels( irimaging$fmricuffcpyn.factor)=c("Yes","No")
levels( irimaging$fmricuffrest2yn.factor)=c("Yes","No")
levels( irimaging$fmricuffdicuploaded.factor)=c("Yes","No")
levels( irimaging$imaging_mcc1_v09_complete.factor)=c("Incomplete","Unverified","Complete")









#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

irdf.complete <- irimaging%>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc1_v09_complete == 2)







#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure




irerror1a <-irdf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffcpyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) & fmricuffcontrayn != 1) %>% 
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffleg.factor,fmricuffcpyn.factor,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("fMRI individualized pressure" = fmricuffipyn.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"Test Completed"= fmricuffcompletescl.factor, "cuff applied to R/L leg"=fmricuffleg.factor ))%>% 
  mutate("cuff applied to R/L leg"=replace_na("missing")) 


# if some tests were done, were the type of tests marked

irerror1b <-irdf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffcpyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffcpyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "missing")) %>% 
  rename("Test Completed"= fmricuffcompletescl.factor)


irerror1 <- full_join(irerror1a,irerror1b,by = intersect(names(irerror1a), names(irerror1b)))



# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

irerror2 <- irdf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffcontrarecal.factor,fmricuffleg.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal))) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2))) %>% 
  rename(c("Re-calibration of pressure needed" = fmricuffcontrarecal.factor, "Recaliberation pressure 1"= fmricuffcalfpressurerecal,"Recaliberation pressure 1:double entry"=fmricuffcalfpressurerecal2, "cuff applied to R/L leg"=fmricuffleg.factor,"Test Completed"=fmricuffcompletescl.factor))

# merge error1 and 2 



irerror1_2 <- full_join(irerror1,irerror2,by = intersect(names(irerror1), names(irerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

irerror3 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricuffcompletescl.factor,fmricufft1yn,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,
         fmricufft1repeated.factor,fmricufft1repeated,fmricufft1techrating2,fmricufft1techrating2.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "missing",TRUE ~ as.character(fmricufft1techrating))) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated== "1"  ~ "missing",TRUE ~ as.character(fmricufft1techrating2))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,fmricufft1repeated.factor,fmricufft1techrating2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"T1"=fmricufft1yn.factor,"Technologists quality rating for T1 scan"=fmricufft1techrating,"T1 scan repeated?"=fmricufft1repeated.factor,"Technologists quality rating for repeated T1 scan"=fmricufft1techrating2 ) %>% 
  select (c(record_id,redcap_event_name,"Test Completed","T1","Technologists quality rating for T1 scan","T1 scan repeated?","Technologists quality rating for repeated T1 scan"))



irerror1_2_3 <- full_join(irerror1_2,irerror3,by = intersect(names(irerror1_2), names(irerror3)))






#before first resting state

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

irerror4.1 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "missing",TRUE ~ as.character(fmricuffrestpainss))) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "missing",TRUE ~ as.character(fmricuffrestpainss2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainss,fmricuffrestpainss2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:surgical site pain"=fmricuffrestpainss,"Before 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffrestpainss2,"1st resting state"= fmricuffrest1yn.factor) 




# Check if first resting-state scan performed and there was a mismatch between entries overall body pain

irerror4.2 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | ( fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall))) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainovrall, fmricuffrestpainovrall2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:body pain"=fmricuffrestpainovrall,"Before 1st resting fMRI scan:body pain(double entry)"=fmricuffrestpainovrall2,"1st resting state"= fmricuffrest1yn.factor) 



irerror4 <- full_join(irerror4.1,irerror4.2,by=c("record_id","Test Completed","redcap_event_name","1st resting state"))


irerror1_2_3_4 <- full_join(irerror1_2_3,irerror4,by = intersect(names(irerror1_2_3), names(irerror4)))




# After first resting fMRI scan:

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

irerror5.1 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2,fmricuffrest1yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss))) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss2) )) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:surgical site pain"=fmricuffcurrpainaftfirstscanss,"After 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffcurrpainaftfirstscanss2,"1st resting state"= fmricuffrest1yn.factor) 

# Check  if first resting-state scan and there was mismatch between entries for overall body pain

irerror5.2 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall))) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:body pain"=fmricuffcurrpainaftfirstscanovrall,"After 1st resting fMRI scan:body pain(double entry)"=fmricuffcurrpainaftfirstscanovrall2,"1st resting state"= fmricuffrest1yn.factor) 



irerror5.a <- full_join(irerror5.1,irerror5.2,by = intersect(names(irerror5.1), names(irerror5.2)))


# Check if individualized and standard performed but baseline was missing after first resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
irerror5.bb <- irdf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffcpyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancp - fmricuffcurrpainaftfirstscancp2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscancp,fmricuffcurrpainaftfirstscancp2,fmricuffrest1yn.factor,fmricuffcpyn.factor,
         fmricuffipyn.factor) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancp = case_when(is.na(fmricuffcurrpainaftfirstscancp) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancp))) %>%
  mutate(fmricuffcurrpainaftfirstscancp2 = case_when(is.na(fmricuffcurrpainaftfirstscancp2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancp2))) %>%
  rename("Test Completed"=fmricuffcompletescl.factor,"1st resting state"= fmricuffrest1yn.factor,"After 1st resting fMRI scan:cuff pain"=fmricuffcurrpainaftfirstscancp,"After 1st resting fMRI scan:cuff pain(double entry)"=fmricuffcurrpainaftfirstscancp2,"fMRI individualized pressure" = fmricuffipyn.factor, "fMRI standard pressure"= fmricuffcpyn.factor)


irerror1_2_3_4_5a <- full_join(irerror1_2_3_4,irerror5.a,by=intersect(names(irerror1_2_3_4), names(irerror5.a)))


irerror1_2_3_4_5 <- full_join(irerror1_2_3_4_5a,irerror5.bb,by=intersect(names(irerror1_2_3_4_5a), names(irerror5.bb)))





# After first cuff fMRI scan

# check if first cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

irerror6.1 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainbegin, fmricuffpainbegin2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain beginning"=fmricuffpainbegin,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain beginning)"=fmricuffpainbegin2)


# check if first cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

irerror6.2 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainmid,fmricuffpainmid2,fmricuffipyn.factor) %>% mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "missing",TRUE ~ as.character(fmricuffpainmid))) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "missing",TRUE ~ as.character(fmricuffpainmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain mid"=fmricuffpainmid,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpainmid2)

# check if first cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

irerror6.3 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainend,fmricuffpainend2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "missing",TRUE ~ as.character(fmricuffpainend))) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "missing",TRUE ~ as.character(fmricuffpainend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain end"=fmricuffpainend,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpainend2)

#create final set



irerror6a <- full_join(irerror6.1,irerror6.2,by=intersect(names(irerror6.1), names(irerror6.2)))

irerror6 <- full_join(irerror6a,irerror6.3,by=intersect(names(irerror6a), names(irerror6.3)))

irerror1_2_3_4_5_6 <- full_join(irerror1_2_3_4_5,irerror6,by=intersect(names(irerror1_2_3_4_5), names(irerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

irerror7.1 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpbegin, fmricuffpaincpbegin2,fmricuffcpyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin))) %>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd cuff fMRI scan:cuff pain begin"=fmricuffpaincpbegin,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain begin)"=fmricuffpaincpbegin2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

irerror7.2 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpmid,fmricuffpaincpmid2,fmricuffcpyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid))) %>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd cuff fMRI scan:cuff pain mid"=fmricuffpaincpmid,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpaincpmid2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

irerror7.3 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpend,fmricuffpaincpend2,fmricuffcpyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "missing",TRUE ~ as.character(fmricuffpaincpend))) %>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "missing",TRUE ~ as.character(fmricuffpaincpend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd cuff fMRI scan:cuff pain end"=fmricuffpaincpend,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpaincpend2)

#create final set

irerror7a <- full_join(irerror7.1,irerror7.2,by=intersect(names(irerror7.1), names(irerror7.2))) 

irerror7 <- full_join(irerror7.3,irerror7a,by=intersect(names(irerror7.3), names(irerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
irerror8.1 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2,fmricuffcpyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin))) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd Resting state:cuff pain beginning"=fmricuffpainrestscanbegin,"After 2nd Resting state:cuff pain(double entry cuff pain beginning)"=fmricuffpainrestscanbegin2,"2nd Resting state" = fmricuffrest2yn.factor)


irerror8.2 <- irdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanmid,fmricuffpainrestscanmid2,fmricuffcpyn.factor,fmricuffrest2yn.factor) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid))) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd Resting state:cuff pain mid"=fmricuffpainrestscanmid,"After 2nd Resting state:cuff pain(double entry cuff pain mid)"=fmricuffpainrestscanmid2,"2nd Resting state" = fmricuffrest2yn.factor)


irerror8.3 <- irdf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanend,fmricuffpainrestscanend2,fmricuffcpyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend)))%>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd Resting state:cuff pain end"=fmricuffpainrestscanend,"After 2nd Resting state:cuff pain(double entry cuff pain end)"=fmricuffpainrestscanend2,"2nd Resting state" = fmricuffrest2yn.factor)

#create full irerror8


irerror8a1 <- full_join(irerror8.1,irerror8.2,by=intersect(names(irerror8.1), names(irerror8.2))) 

irerror8a <- full_join(irerror8.3,irerror8a1,by=intersect(names(irerror8.3), names(irerror8a1))) 

#merge 7 and 8a 

irerror7_8a <- full_join(irerror7,irerror8a,by=intersect(names(irerror7), names(irerror8a)))







#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
irerror8.4 <- irdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss)))%>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:surgical site pain"=fmricuffpainaftlastscanss,"After 2nd Resting state:surgical site pain(double entry)"=fmricuffpainaftlastscanss2,"2nd Resting state" = fmricuffrest2yn.factor)

#"Body pain (double entry)"

irerror8.5 <- irdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany)))%>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:body pain"=fmricuffpainaftlastscanany,"After 2nd Resting state:body pain(double entry)"=fmricuffpainaftlastscanany2,"2nd Resting state" = fmricuffrest2yn.factor)


irerror8b<- full_join(irerror8.4,irerror8.5,by=intersect(names(irerror8.4), names(irerror8.5)))



#merge 7_8a and 8b

irerror7_8a_8b <- full_join(irerror7_8a,irerror8b,by=intersect(names(irerror7_8a), names(irerror8b)))



#merge all

irerror1_2_3_4_5_6_7_8 <- full_join(irerror1_2_3_4_5_6,irerror7_8a_8b,by=intersect(names(irerror1_2_3_4_5_6), names(irerror7_8a_8b)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") 







#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

irerror9.1 <- irimaging %>% 
  filter((imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffdicuploaded.factor = case_when(is.na(fmricuffdicuploaded.factor) ~ "missing",TRUE ~ as.character(fmricuffdicuploaded.factor))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,imaging_mcc1_v09_complete.factor,fmricuffdicuploaded.factor)%>% 
  rename("complete?"=imaging_mcc1_v09_complete.factor,"Dicom files uploaded to TACC?"=fmricuffdicuploaded.factor,"Test Completed"=fmricuffcompletescl.factor)





#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
irerror9.2 <- irimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffcompletescl.factor = case_when(is.na(fmricuffcompletescl.factor) ~ "missing",TRUE ~ as.character(fmricuffcompletescl.factor))) %>% 
  select(record_id,redcap_event_name,imaging_mcc1_v09_complete.factor,fmricuffcompletescl.factor,fmricuffdicuploaded.factor) %>% 
  rename("complete?"=imaging_mcc1_v09_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"Dicom files uploaded to TACC"=fmricuffdicuploaded.factor)


#merge 9.1 and 9.2 

irerror9.a <- full_join(irerror9.1,irerror9.2,by=intersect(names(irerror9.1), names(irerror9.2))) 

# calculate visit date - mask field introduced date
m1result_surg_no_na <- m1result_surg %>% 
  add_column(mask_date = as.Date("2021-11-05")) %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,mask_date,units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,mask_date,units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,mask_date,units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "mask_date_diff") %>% 
  mutate(mask_date_diff = gsub("days","",mask_date_diff)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(mask_date_diff = as.numeric(mask_date_diff))

# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

irerror9.b <- irimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffcpyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "missing",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc1_v09_complete.factor,fmricuffcompletescl.factor,fmri_face_mask) %>% 
  rename("complete?"=imaging_mcc1_v09_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"face mask worn"= fmri_face_mask) %>% 
  left_join(.,m1result_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(-mask_date_diff)



irerror9 <- full_join(irerror9.a,irerror9.b,by=intersect(names(irerror9.a), names(irerror9.b))) 

#merge all plus error 9

irerror1_2_3_4_5_6_7_8_9 <- full_join(irerror1_2_3_4_5_6_7_8,irerror9,by=intersect(names(irerror1_2_3_4_5_6_7_8), names(irerror9)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") %>% 
  mutate_all(as.character)



#fetch notes wit dag
notes.imaging <- irimaging %>% 
  select(record_id,redcap_event_name,fmricuffnotes, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  rename("notes"=fmricuffnotes)










irerror1_2_3_4_5_6_7_8_shrink <- irerror1_2_3_4_5_6_7_8_9 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#now merge with notes

irerror1_2_3_4_5_6_7_8_notes <- left_join(irerror1_2_3_4_5_6_7_8_shrink,notes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  left_join(.,m1days_from_sysdate, by=c("record_id","redcap_event_name"))





# mcc1 QST



qdata<- data


#fetch imaging data to link with QST
trdata.image <-  data




#Setting Labels

label(qdata$record_id)="Record ID"
label(qdata$redcap_event_name)="Event Name"
label(qdata$pptcompleteyn)="Test completed"
label(qdata$pptpainlocation)="Location of greater knee pain(index site):"
label(qdata$pptremote1val)="Rep 1:"
label(qdata$pptremote1val1)="Rep 1: (double entry)"
label(qdata$pptremote2val)="Rep 2:"
label(qdata$pptremote2val1)="Rep 2: (double entry)"
label(qdata$pptremote3val)="Rep 3:"
label(qdata$pptremote3val1)="Rep 3:  (double entry)"
label(qdata$pptindex1val)="Rep 1:"
label(qdata$pptindex1val1)="Rep 1: (double entry)"
label(qdata$pptindex2val)="Rep 2:"
label(qdata$pptindex2val1)="Rep 2: (double entry)"
label(qdata$pptindex3val)="Rep 3:"
label(qdata$pptindex3val1)="Rep 3: (double entry)"
label(qdata$pptnotes)="Additional notes for baseline PPTs"
label(qdata$tscompleted)="Test completed"
label(qdata$tsrep1initialpainrem)="Initial Pain Rating:"
label(qdata$tsrep1initialpainrem_d)="Initial Pain Rating: (double entry)"
label(qdata$tsrep1finalpainrem)="Final Pain Rating:"
label(qdata$tsrep1finalpainrem_d)="Final Pain Rating: (double entry)"
label(qdata$tsrep2initialpainrem)="Initial Pain Rating:"
label(qdata$tsrep2initialpainrem_d)="Initial Pain Rating: (double entry)"
label(qdata$tsrep2finalpainrem)="Final Pain Rating:"
label(qdata$tsrep2finalpainrem_d)="Final Pain Rating: (double entry)"
label(qdata$tsinitialpainremsclr3)="Initial Pain Rating:"
label(qdata$tsinitialpainremscl1r3)="Initial Pain Rating: (double entry)"
label(qdata$tsfinalpainremsclr3)="Final Pain Rating:"
label(qdata$tsfinalpainremscl1r3)="Final Pain Rating: (double entry)"
label(qdata$tsfinalpainremafts15)="Remote After-sensations: 	15 sec "
label(qdata$tsfinalpainremafts30)="(single entry)	30 sec "
label(qdata$tsrep1initialpainindex)="Initial Pain Rating:"
label(qdata$tsrep1initialpainindex_d)="Initial Pain Rating: (double entry)"
label(qdata$tsrep1finalpainindex)="Final Pain Rating:"
label(qdata$tsrep1finalpainindex_d)="Final Pain Rating: (double entry)"
label(qdata$tsinitialpainindexsclr2)="Initial Pain Rating:"
label(qdata$tsinitialpainindexscl1r2)="Initial Pain Rating: (double entry)"
label(qdata$tsfinalpainindexsclr2)="Final Pain Rating:"
label(qdata$tsfinalpainindexscl1r2)="Final Pain Rating: (double entry)"
label(qdata$tsinitialpainindexsclr3)="Initial Pain Rating:"
label(qdata$tsinitialpainindexscl1r3)="Initial Pain Rating: (double entry)"
label(qdata$tsfinalpainindexsclr3)="Final Pain Rating:"
label(qdata$tsfinalpainindexscl1r3)="Final Pain Rating: (double entry)"
label(qdata$tsfinalpainindafts15)="Index After-sensations: 	15 sec "
label(qdata$tsfinalpainindafts30)="(single entry)	30 sec "
label(qdata$tsnotes)="Additional notes for Temporal Summation"
label(qdata$cpmcompleteyn)="Test Completed:"
label(qdata$cpmcoldwatertempc)="Confirm water temp 10 deg C (+/-1 deg): "
label(qdata$cpmcoldwaterpain30sscl)="Cold Water Pain Rating at 30 sec:"
label(qdata$cpmcoldwaterpain30sscl1)="Cold Water Pain Rating at 30 sec: (double entry)"
label(qdata$cpmcoldwaterpain60sscl)="Cold Water Pain Rating at 60 sec:"
label(qdata$cpmcoldwaterpain60sscl1)="Cold Water Pain Rating at 60 sec: (double entry)"
label(qdata$cpmbathrangeyn)="Water bath duration?"
label(qdata$cpmoutrangetime)="If outside of range, enter time (sec)"
label(qdata$cpmppt1val)="Rep 1:"
label(qdata$cpmppt1val1)="Rep 1: (double entry)"
label(qdata$cpmppt2val)="Rep 2:"
label(qdata$cpmppt2val1)="Rep 2: (double entry)"
label(qdata$cpmppt3val)="Rep 3:"
label(qdata$cpmppt3val1)="Rep 3: (double entry)"
label(qdata$cpmnotes)="Additional notes for Conditioned Pain Modulation "
label(qdata$fmricuffcontrayn)="Cuff pressure contraindicated:"
label(qdata$fmricuffcalfpressure)="Calf pressure, contralateral calf, Pressure 1: "
label(qdata$fmricuffcalfpressure2)="Calf pressure, contralateral calf, Pressure 1: (double entry) "
label(qdata$qst_mcc1_v03_complete)="Complete?"




#Setting Units


#Setting Factors(will create new variable for factors)
qdata$redcap_event_name.factor = factor(qdata$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
qdata$pptcompleteyn.factor = factor(qdata$pptcompleteyn,levels=c("1","2","3","0"))
qdata$pptpainlocation.factor = factor(qdata$pptpainlocation,levels=c("1","2","3"))
qdata$tscompleted.factor = factor(qdata$tscompleted,levels=c("1","2","3","0"))
qdata$tsrep1initialpainrem.factor = factor(qdata$tsrep1initialpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1initialpainrem_d.factor = factor(qdata$tsrep1initialpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1finalpainrem.factor = factor(qdata$tsrep1finalpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1finalpainrem_d.factor = factor(qdata$tsrep1finalpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep2initialpainrem.factor = factor(qdata$tsrep2initialpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep2initialpainrem_d.factor = factor(qdata$tsrep2initialpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep2finalpainrem.factor = factor(qdata$tsrep2finalpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep2finalpainrem_d.factor = factor(qdata$tsrep2finalpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsinitialpainremsclr3.factor = factor(qdata$tsinitialpainremsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsinitialpainremscl1r3.factor = factor(qdata$tsinitialpainremscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsfinalpainremsclr3.factor = factor(qdata$tsfinalpainremsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsfinalpainremscl1r3.factor = factor(qdata$tsfinalpainremscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1initialpainindex.factor = factor(qdata$tsrep1initialpainindex,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1initialpainindex_d.factor = factor(qdata$tsrep1initialpainindex_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1finalpainindex.factor = factor(qdata$tsrep1finalpainindex,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsrep1finalpainindex_d.factor = factor(qdata$tsrep1finalpainindex_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsinitialpainindexsclr2.factor = factor(qdata$tsinitialpainindexsclr2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsinitialpainindexscl1r2.factor = factor(qdata$tsinitialpainindexscl1r2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsfinalpainindexsclr2.factor = factor(qdata$tsfinalpainindexsclr2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsfinalpainindexscl1r2.factor = factor(qdata$tsfinalpainindexscl1r2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsinitialpainindexsclr3.factor = factor(qdata$tsinitialpainindexsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsinitialpainindexscl1r3.factor = factor(qdata$tsinitialpainindexscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsfinalpainindexsclr3.factor = factor(qdata$tsfinalpainindexsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$tsfinalpainindexscl1r3.factor = factor(qdata$tsfinalpainindexscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$cpmcompleteyn.factor = factor(qdata$cpmcompleteyn,levels=c("1","0"))
qdata$cpmcoldwatertempc.factor = factor(qdata$cpmcoldwatertempc,levels=c("1","0"))
qdata$cpmcoldwaterpain30sscl.factor = factor(qdata$cpmcoldwaterpain30sscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$cpmcoldwaterpain30sscl1.factor = factor(qdata$cpmcoldwaterpain30sscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$cpmcoldwaterpain60sscl.factor = factor(qdata$cpmcoldwaterpain60sscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$cpmcoldwaterpain60sscl1.factor = factor(qdata$cpmcoldwaterpain60sscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdata$cpmbathrangeyn.factor = factor(qdata$cpmbathrangeyn,levels=c("1","2"))
qdata$fmricuffcontrayn.factor = factor(qdata$fmricuffcontrayn,levels=c("1","0"))
qdata$qst_mcc1_v03_complete.factor = factor(qdata$qst_mcc1_v03_complete,levels=c("0","1","2"))

levels(qdata$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(qdata$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (knee)","no, neither site")
levels(qdata$pptpainlocation.factor)=c("medial","lateral","equal")
levels(qdata$tscompleted.factor)=c("yes, at least 1 repetition for both sites","only remote (shoulder)","only index (knee)","no, neither site")
levels(qdata$tsrep1initialpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1initialpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1finalpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1finalpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep2initialpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep2initialpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep2finalpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep2finalpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsinitialpainremsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsinitialpainremscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsfinalpainremsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsfinalpainremscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1initialpainindex.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1initialpainindex_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1finalpainindex.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsrep1finalpainindex_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsinitialpainindexsclr2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsinitialpainindexscl1r2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsfinalpainindexsclr2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsfinalpainindexscl1r2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsinitialpainindexsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsinitialpainindexscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsfinalpainindexsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$tsfinalpainindexscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$cpmcompleteyn.factor)=c("Yes","No")
levels(qdata$cpmcoldwatertempc.factor)=c("Yes","No")
levels(qdata$cpmcoldwaterpain30sscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$cpmcoldwaterpain30sscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$cpmcoldwaterpain60sscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$cpmcoldwaterpain60sscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdata$cpmbathrangeyn.factor)=c("Standard range (60sec +/- 5 sec)","Outside of range: < 55sec or > 65 sec")
levels(qdata$fmricuffcontrayn.factor)=c("Yes","No")
levels(qdata$qst_mcc1_v03_complete.factor)=c("Incomplete","Unverified","Complete")






# Ask hablar to guess most appropriate datatype
qdata <- retype(qdata)







#PPTs


#keep records with complete qst test and  ppt test.
qdata2  <- qdata  %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(pptcompleteyn ==2 |pptcompleteyn ==  1 | pptcompleteyn == 3)




#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):








#check location of index site entered if test completed (both sites =1 OR 3 = Index site (med/lat joint line) )

qerror1 <- qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  filter(is.na(pptpainlocation)) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptpainlocation.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"location of greater knee pain"= pptpainlocation.factor )) %>% 
  mutate("location of greater knee pain"=replace_na("missing")) 







#Remote site (contralateral deltoid):
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral deltoid:

#rep1
qerror2.1 <-  qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremote1val - pptremote1val1) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>%  
  as_tibble() %>%
  mutate_all(as.character) %>%  
  mutate(pptremote1val = case_when(is.na(pptremote1val) ~ "missing",TRUE ~ as.character(pptremote1val))) %>% 
  mutate(pptremote1val1 = case_when(is.na(pptremote1val1) ~ "missing",TRUE ~ as.character(pptremote1val1) )) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote1val,pptremote1val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremote1val,"ppt remote rep1(double entry)"= pptremote1val1 )) 

#rep2
qerror2.2 <-  qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremote2val - pptremote2val1) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote2val = case_when(is.na(pptremote2val) ~ "missing",TRUE ~ as.character(pptremote2val))) %>% 
  mutate(pptremote2val1 = case_when(is.na(pptremote2val1) ~ "missing",TRUE ~ as.character(pptremote2val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote2val,pptremote2val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep2"= pptremote2val,"ppt remote rep2(double entry)"= pptremote2val1 ))



#rep3

qerror2.3 <-  qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremote3val - pptremote3val1) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote3val = case_when(is.na(pptremote3val) ~ "missing",TRUE ~ as.character(pptremote3val))) %>% 
  mutate(pptremote3val1 = case_when(is.na(pptremote3val1) ~ "missing",TRUE ~ as.character(pptremote3val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote3val,pptremote3val1)%>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep3"= pptremote3val,"ppt remote rep3(double entry)"= pptremote3val1 ))

qerror2 <-  full_join(qerror2.1,qerror2.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,qerror2.3,by= c("record_id","redcap_event_name","PPT test completed?")) 




#merge error1 and 2


qerror1_2 <- full_join(qerror1,qerror2,by = intersect(names(qerror1), names(qerror2)))




#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site (med/lat joint line)::

#rep1
qerror3.1 <-   qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff1 = pptindex1val - pptindex1val1) %>% 
  filter(ppt_index_diff1 != 0 | is.na(ppt_index_diff1)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex1val = case_when(is.na(pptindex1val) ~ "missing",TRUE ~ as.character(pptindex1val))) %>% 
  mutate(pptindex1val1 = case_when(is.na(pptindex1val1) ~ "missing",TRUE ~ as.character(pptindex1val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex1val,pptindex1val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"= pptindex1val,"ppt index rep1(double entry)"= pptindex1val1 ))


#rep2
qerror3.2 <-  qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff2 = pptindex2val - pptindex2val1) %>% 
  filter(ppt_index_diff2 != 0 | is.na(ppt_index_diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex2val = case_when(is.na(pptindex2val) ~ "missing",TRUE ~ as.character(pptindex2val))) %>% 
  mutate(pptindex2val1 = case_when(is.na(pptindex2val1) ~ "missing",TRUE ~ as.character(pptindex2val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex2val,pptindex2val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep2"= pptindex2val,"ppt index rep2(double entry)"= pptindex2val1 ))


#rep3

qerror3.3 <-  qdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff3 = pptindex3val - pptindex3val1) %>% 
  filter(ppt_index_diff3 != 0 | is.na(ppt_index_diff3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex3val = case_when(is.na(pptindex3val) ~ "missing",TRUE ~ as.character(pptindex3val))) %>% 
  mutate(pptindex3val1 = case_when(is.na(pptindex3val1) ~ "missing",TRUE ~ as.character(pptindex3val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex3val,pptindex3val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep3"= pptindex3val,"ppt index rep3(double entry)"= pptindex3val1 ))

qerror3a <-  full_join(qerror3.1,qerror3.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,qerror3.3,by= c("record_id","redcap_event_name","PPT test completed?")) 






#merge error1,2 and 3a


qerror1_3 <- full_join(qerror1_2,qerror3a,by = intersect(names(qerror1_2), names(qerror3a)))



#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 



qerror3b.1 <- qdata %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindex1val) & !is.na(pptindex1val1))  | (!is.na(pptindex2val)  & !is.na(pptindex2val1)) | (!is.na(pptindex3val)  & !is.na(pptindex3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(as.character(.)))

qerror3b.2 <- qdata %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindex1val) & is.na(pptindex1val1))  | (is.na(pptindex2val)  & is.na(pptindex2val1)) | (is.na(pptindex3val)  & is.na(pptindex3val1))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

qerror3b.2 <-qerror3b.2 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



qerror3b.3 <- qdata %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremote1val) & !is.na(pptremote1val1))  | (!is.na(pptremote2val) & !is.na(pptremote2val1)) | (!is.na(pptremote3val)  & !is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(as.character(.)))


qerror3b.4 <- qdata %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremote1val) & is.na(pptremote1val1))  | (is.na(pptremote2val)  & is.na(pptremote2val1)) | (is.na(pptremote3val)  & is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote2)


qerror3b.4 <-qerror3b.4 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )






#merge error 3
###########
qerror3c <- full_join(qerror3b.1,qerror3b.2,by = intersect(names(qerror3b.1), names(qerror3b.2)))
qerror3d <- full_join(qerror3b.3,qerror3b.4,by = intersect(names(qerror3b.3), names(qerror3b.4)))

###########
qerror3b <- full_join(qerror3c,qerror3d,by = intersect(names(qerror3c), names(qerror3d))) %>% 
  select(c(-index1,-index2,-remote1,-remote2)) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"= pptindex1val,"ppt index rep1(double entry)"= pptindex1val1,"ppt index rep2"= pptindex2val,
           "ppt index rep2(double entry)"= pptindex2val1,"ppt index rep3"= pptindex3val,"ppt index rep3(double entry)"= pptindex3val1,"ppt remote rep1"= pptremote1val,
           "ppt remote rep1(double entry)"= pptremote1val1,"ppt remote rep2"= pptremote2val,"ppt remote rep2(double entry)"= pptremote2val1,"ppt remote rep3"= pptremote3val,"ppt remote rep3(double entry)"= pptremote3val1  ))  %>%
  as_tibble() %>% 
  mutate_all(as.character)









# 
# error3b[] <- lapply(error3b, as.character)
# error2_3[] <- lapply(error2_3, as.character)


qerror1_3_3b <- full_join(qerror1_3,qerror3b,by = intersect(names(qerror1_3), names(qerror3b)))








# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


qppt.biomarker <- qdata %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindex1val,pptindex2val,pptindex3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindex1val,pptindex2val,pptindex3val,pptcompleteyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


qppt.biomarker1 <- qdata %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote2val,pptremote3val,pptcompleteyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),~(case_when(is.na(.) ~ "missing",
                                               TRUE ~ as.character(.)
    ))
  )




qppt.all.biomarker <- full_join(qppt.biomarker,qppt.biomarker1,by=c("record_id","redcap_event_name","pptcompleteyn.factor")) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremote1val,"ppt remote rep2"= pptremote2val,"ppt remote rep3"= pptremote3val,"ppt index rep1"= pptindex1val,"ppt index rep2"= pptindex2val,"ppt index rep3"= pptindex3val ))





qerror2_3_3b_endpoint <- full_join(qerror1_3_3b,qppt.all.biomarker,by=c("record_id","redcap_event_name","PPT test completed?","ppt index rep1","ppt index rep2","ppt index rep3","ppt remote rep1","ppt remote rep2","ppt remote rep3"))








#ensure each combination of ID and redcap event has one row with all values and is not duplicated

qerror2_3_3b_endpoint [qerror2_3_3b_endpoint == ""] <- NA

qerror2_3_3b_endpoint1 <- qerror2_3_3b_endpoint %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#Temporal Summation:





#PPTs

# check for missingness in "ts test completed"




#Remove records with missing "ts test completed",# keep record with "tscompleted test completed"

tr.complete <- qdata %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(tscompleted ==2 |tscompleted ==  1 | tscompleted == 3)


#check if all ppt.completed now has completed records, where 0= niether site, 1= yes atleast 1 rep for both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):









#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
trerror4.1 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsrep1initialpainrem - tsrep1initialpainrem_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainrem = case_when(is.na(tsrep1initialpainrem) ~ "missing",TRUE ~ as.character(tsrep1initialpainrem))) %>% 
  mutate(tsrep1initialpainrem_d = case_when(is.na(tsrep1initialpainrem_d) ~ "missing",TRUE ~ as.character(tsrep1initialpainrem_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1initialpainrem_d,tscompleted) 


#rep1 final
trerror4.2 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsrep1finalpainrem - tsrep1finalpainrem_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainrem = case_when(is.na(tsrep1finalpainrem) ~ "missing",TRUE ~ as.character(tsrep1finalpainrem))) %>% 
  mutate(tsrep1finalpainrem_d = case_when(is.na(tsrep1finalpainrem_d) ~ "missing",TRUE ~ as.character(tsrep1finalpainrem_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1finalpainrem,tsrep1finalpainrem_d,tscompleted) 


#rep1 set 
trrep1.set <- full_join(trerror4.1,trerror4.2,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#rep2 initial

trerror4.3 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsrep2initialpainrem - tsrep2initialpainrem_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep2initialpainrem = case_when(is.na(tsrep2initialpainrem) ~ "missing",TRUE ~ as.character(tsrep2initialpainrem))) %>% 
  mutate(tsrep2initialpainrem_d = case_when(is.na(tsrep2initialpainrem_d) ~ "missing",TRUE ~ as.character(tsrep2initialpainrem_d) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep2initialpainrem,tsrep2initialpainrem_d,tscompleted)

#rep2 final
trerror4.4 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsrep2finalpainrem - tsrep2finalpainrem_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep2finalpainrem = case_when(is.na(tsrep2finalpainrem) ~ "missing",TRUE ~ as.character(tsrep2finalpainrem))) %>% 
  mutate(tsrep2finalpainrem_d = case_when(is.na(tsrep2finalpainrem_d) ~ "missing",TRUE ~ as.character(tsrep2finalpainrem_d) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep2finalpainrem,tsrep2finalpainrem_d,tscompleted) 

#rep2 set 
trrep2.set <- full_join(trerror4.3,trerror4.4,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


#rep3 initial

trerror4.5 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsinitialpainremsclr3 - tsinitialpainremscl1r3) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainremsclr3 = case_when(is.na(tsinitialpainremsclr3) ~ "missing",TRUE ~ as.character(tsinitialpainremsclr3))) %>% 
  mutate(tsinitialpainremscl1r3 = case_when(is.na(tsinitialpainremscl1r3) ~ "missing",TRUE ~ as.character(tsinitialpainremscl1r3) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsinitialpainremsclr3,tsinitialpainremscl1r3,tscompleted)

#rep3 final
trerror4.6 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsfinalpainremsclr3 - tsfinalpainremscl1r3) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremsclr3 = case_when(is.na(tsfinalpainremsclr3) ~ "missing",TRUE ~ as.character(tsfinalpainremsclr3))) %>% 
  mutate(tsfinalpainremscl1r3 = case_when(is.na(tsfinalpainremscl1r3) ~ "missing",TRUE ~ as.character(tsfinalpainremscl1r3) ))%>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremsclr3,tsfinalpainremscl1r3,tscompleted) 

#rep3 set 
trrep3.set <- full_join(trerror4.5,trerror4.6,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

tr_remote_all_reps1 <- full_join(trrep1.set,trrep2.set,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted")) %>% 
  full_join(.,trrep3.set,by= c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
tr1 <- tr_remote_all_reps1 %>% 
  mutate(trrep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep1initialpainrem))  & (is.na(tsrep1initialpainrem_d))  & (is.na(tsrep1finalpainrem)) & (is.na(tsrep1finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(trrep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep2initialpainrem))  & (is.na(tsrep2initialpainrem_d))  & (is.na(tsrep2finalpainrem)) & (is.na(tsrep2finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(trrep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsinitialpainremsclr3))  & (is.na(tsinitialpainremscl1r3))  & (is.na(tsfinalpainremsclr3)) & (is.na(tsfinalpainremscl1r3))~ 1,TRUE ~ 0))


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,"TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3 ))







#index site Index site (med/lat knee)

# check for missing or mismatch in pain ratings for  Index site (med/lat knee) in both site OR  Index site (med/lat knee):

#rep1 initial
trerror6.1 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsrep1initialpainindex - tsrep1initialpainindex_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainindex = case_when(is.na(tsrep1initialpainindex) ~ "missing",TRUE ~ as.character(tsrep1initialpainindex))) %>%
  mutate(tsrep1initialpainindex_d = case_when(is.na(tsrep1initialpainindex_d) ~ "missing",TRUE ~ as.character(tsrep1initialpainindex_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainindex,tsrep1initialpainindex_d,tscompleted)

#rep1 final 

trerror6.2 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsrep1finalpainindex - tsrep1finalpainindex_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainindex = case_when(is.na(tsrep1finalpainindex) ~ "missing",TRUE ~ as.character(tsrep1finalpainindex))) %>%
  mutate(tsrep1finalpainindex_d = case_when(is.na(tsrep1finalpainindex_d) ~ "missing",TRUE ~ as.character(tsrep1finalpainindex_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1finalpainindex,tsrep1finalpainindex_d,tscompleted)



#rep1 set 
trrep1.index.set <- full_join(trerror6.1,trerror6.2,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

#rep2 initial

trerror6.3 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsinitialpainindexsclr2 - tsinitialpainindexscl1r2) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr2 = case_when(is.na(tsinitialpainindexsclr2) ~ "missing",TRUE ~ as.character(tsinitialpainindexsclr2)))%>%
  mutate(tsinitialpainindexscl1r2 = case_when(is.na(tsinitialpainindexscl1r2) ~ "missing",TRUE ~ as.character(tsinitialpainindexscl1r2) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tscompleted)


#rep2 final
trerror6.4 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsfinalpainindexsclr2 - tsfinalpainindexscl1r2) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr2 = case_when(is.na(tsfinalpainindexsclr2) ~ "missing",TRUE ~ as.character(tsfinalpainindexsclr2)))%>%
  mutate(tsfinalpainindexscl1r2 = case_when(is.na(tsfinalpainindexscl1r2) ~ "missing",TRUE ~ as.character(tsfinalpainindexscl1r2) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tscompleted)


#rep2 set 
trrep2.index.set <- full_join(trerror6.3,trerror6.4,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))


#rep3 initial

trerror6.5 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsinitialpainindexsclr3 - tsinitialpainindexscl1r3) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr3 = case_when(is.na(tsinitialpainindexsclr3) ~ "missing",TRUE ~ as.character(tsinitialpainindexsclr3)))%>%
  mutate(tsinitialpainindexscl1r3 = case_when(is.na(tsinitialpainindexscl1r3) ~ "missing",TRUE ~ as.character(tsinitialpainindexscl1r3) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tscompleted) 

#rep3 final
trerror6.6 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsfinalpainindexsclr3 - tsfinalpainindexscl1r3) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr3 = case_when(is.na(tsfinalpainindexsclr3) ~ "missing",TRUE ~ as.character(tsfinalpainindexsclr3)))%>%
  mutate(tsfinalpainindexscl1r3 = case_when(is.na(tsfinalpainindexscl1r3) ~ "missing",TRUE ~ as.character(tsfinalpainindexscl1r3) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindexsclr3,tsfinalpainindexscl1r3,tscompleted) 

#rep3 set 
trrep3.index.set <- full_join(trerror6.5,trerror6.6,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
tr_index_all_reps1 <- full_join(trrep1.index.set,trrep2.index.set,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  full_join(.,trrep3.index.set,by= c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0




tr.index1 <- tr_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsrep1initialpainindex))  & (is.na(tsrep1initialpainindex_d))  & (is.na(tsrep1finalpainindex)) & (is.na(tsrep1finalpainindex_d))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


tr.index1 <- tr.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr2))  & (is.na(tsinitialpainindexscl1r2))  & (is.na(tsfinalpainindexsclr2)) & (is.na(tsfinalpainindexscl1r2))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


tr.index1 <- tr.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr3))  & (is.na(tsinitialpainindexscl1r3))  & (is.na(tsfinalpainindexsclr3)) & (is.na(tsfinalpainindexscl1r3))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS index rep3 final(double entry)"= tsfinalpainindexscl1r3))






#if one rep is complete with no mismatch then all.reps.rem == 1 else 0
tr1 <- tr1 %>% 
  mutate(all.reps.rem = case_when(trrep1 == 0  & trrep2==0  & trrep3==0  ~ 0,TRUE ~ 1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
tr.index1 <- tr.index1 %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == 0  & ind.rep2==0  & ind.rep3==0  ~ 0,TRUE ~ 1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
trrem.ind <- full_join(tr1,tr.index1,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  filter((tscompleted == 2 & all.reps.rem == 0)| (tscompleted == 3 & all.reps.ind == 0) | (tscompleted == 1 & all.reps.rem == 0 |all.reps.ind == 0 ) ) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

trrem_index_all_reps <- trrem.ind %>% 
  select(c(-tscompleted,-trrep1,-trrep2,-trrep3,-all.reps.rem,-all.reps.ind,-ind.rep1,-ind.rep2,-ind.rep3)) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,
           "TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,
           "TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,
           "TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,
           "TS index rep3 final(double entry)"= tsfinalpainindexscl1r3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,
           "TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,
           "TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,
           "TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,
           "TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)






# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

trerror5.1 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremafts15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 15sec"= tsfinalpainremafts15 )) %>% 
  mutate("TS remote after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
trerror5.2 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts30)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremafts30) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 30sec"= tsfinalpainremafts30 ))  %>% 
  mutate("TS remote after sensation 30sec"=replace_na("missing")) 

# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# error5.1[] <- lapply(error5.1, as.character)
# error5.2[] <- lapply(error5.2, as.character)


tr_remote_all_reps_sensations <- full_join(trrem_index_all_reps,trerror5.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,trerror5.2,by= c("record_id","redcap_event_name","TS test completed?")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# once TS  Index site (med/lat knee)is completed
# missing after sensation at 15 secs

trerror7.1 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindafts15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 15sec"= tsfinalpainindafts15 )) %>% 
  mutate("TS index after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
trerror7.2 <-  tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts30)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindafts30) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 30sec"= tsfinalpainindafts30 )) %>% 
  mutate("TS index after sensation 30sec"=replace_na("missing"))





# convert all char for merging
# Ts_remote_all_reps_sensations[] <- lapply(Ts_remote_all_reps_sensations, as.character)
# error7.1[] <- lapply(error7.1, as.character)
# error7.2[] <- lapply(error7.2, as.character)


#merge all
tr_index_remote_all_reps_sensation <- full_join(tr_remote_all_reps_sensations,trerror7.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,trerror7.2,by= c("record_id","redcap_event_name","TS test completed?")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

trerror7.3a <- tr.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsrep1initialpainindex) & !is.na(tsrep1initialpainindex_d))  | (!is.na(tsrep1finalpainindex)  & !is.na(tsrep1finalpainindex_d)) | (!is.na(tsinitialpainindexsclr2)  & !is.na(tsinitialpainindexscl1r2)) | (!is.na(tsfinalpainindexsclr2) & !is.na(tsfinalpainindexscl1r2))  | (!is.na(tsinitialpainindexsclr3)  & !is.na(tsinitialpainindexscl1r3)) | (!is.na(tsfinalpainindexsclr3)  & !is.na(tsfinalpainindexscl1r3))  ~ 1,TRUE ~ 0))  %>% 
  filter(ts.index1 == 1)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3) 



#OR b.if both sites was checked but pain ratings not filled out for the index site 

trerror7.3b <- tr.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsrep1initialpainindex) & is.na(tsrep1initialpainindex_d)  & is.na(tsrep1finalpainindex)  & is.na(tsrep1finalpainindex_d) & is.na(tsinitialpainindexsclr2)  & is.na(tsinitialpainindexscl1r2) & is.na(tsfinalpainindexsclr2) & is.na(tsfinalpainindexscl1r2)  & is.na(tsinitialpainindexsclr3)  & is.na(tsinitialpainindexscl1r3) & is.na(tsfinalpainindexsclr3)  & is.na(tsfinalpainindexscl1r3)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),~case_when(is.na(.) ~ "missing",
                                       TRUE ~ as.character(.)))







# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 


trerror7.4a <- tr.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsrep1initialpainrem) & !is.na(tsrep1initialpainrem_d))  | (!is.na(tsrep1finalpainrem)  & !is.na(tsrep1finalpainrem_d)) | (!is.na(tsrep2initialpainrem)  & !is.na(tsrep2initialpainrem_d)) | (!is.na(tsrep2finalpainrem) & !is.na(tsrep2finalpainrem_d))  | (!is.na(tsinitialpainremsclr3)  & !is.na(tsinitialpainremscl1r3)) | (!is.na(tsfinalpainremsclr3)  & !is.na(tsfinalpainremscl1r3))  ~ 1,TRUE ~ 0))  %>%
  filter(ts.remote1 == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3)


#OR b.if both sites was checked but pain ratings not filled out for the remote site

trerror7.4b <- tr.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsrep1initialpainrem) & is.na(tsrep1initialpainrem_d)  & is.na(tsrep1finalpainrem)  & is.na(tsrep1finalpainrem_d) & is.na(tsrep2initialpainrem)  & is.na(tsrep2initialpainrem_d) & is.na(tsrep2finalpainrem) & is.na(tsrep2finalpainrem_d)  & is.na(tsinitialpainremsclr3)  & is.na(tsinitialpainremscl1r3) & is.na(tsfinalpainremsclr3)  & is.na(tsfinalpainremscl1r3)  ~ 1,TRUE ~ 0)) %>% 
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )






#merge 7.3a,7.3b,7.4a,7.4b





trerror7.3a[] <- lapply(trerror7.3a, as.character)
trerror7.3b[] <- lapply(trerror7.3b, as.character)
trerror7.4a[] <- lapply(trerror7.4a, as.character)
trerror7.4b[] <- lapply(trerror7.4b, as.character)


trmerged7.3 <- full_join(trerror7.3a,trerror7.3b,by = intersect(names(trerror7.3a), names(trerror7.3b))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

trmerged7.4 <- full_join(trerror7.4a,trerror7.4b,by = intersect(names(trerror7.4a), names(trerror7.4b))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

trmerged7 <- full_join(trmerged7.3,trmerged7.4,by = intersect(names(trmerged7.3), names(trmerged7.4))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)






#rename merged7
trmerged7.1 <- trmerged7 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS index rep3 final(double entry)"= tsfinalpainindexscl1r3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,"TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3))  




# change  to as.character for merging
tr_index_remote_all_reps_sensation [] <- lapply(tr_index_remote_all_reps_sensation , as.character)
trmerged7.1[] <- lapply(trmerged7.1, as.character)




#merge Ts_index_remote_all_reps_sensation and merged7.1 

trmerge8 <- full_join(trmerged7.1,tr_index_remote_all_reps_sensation ,by = intersect(names(trmerged7.1), names(tr_index_remote_all_reps_sensation ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
trprim.outcome.index <- tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsrep1finalpainindex,tsrep1initialpainindex)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsrep1initialpainindex) %>% 
  mutate(max.rep2.index = pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2)) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsinitialpainindexsclr2) %>% 
  mutate(max.rep3.index = pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsinitialpainindexsclr3) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


trprim.outcome.remote <- tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsrep1initialpainrem,tsrep1finalpainrem)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsrep1initialpainrem) %>% 
  mutate(max.rep2.remote = pmax(tsrep2initialpainrem,tsrep2finalpainrem)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsrep2initialpainrem) %>% 
  mutate(max.rep3.remote = pmax(tsinitialpainremsclr3,tsfinalpainremsclr3)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsinitialpainremsclr3) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


tr_primary_outcome <-  full_join(trprim.outcome.index, trprim.outcome.remote ,by = intersect(names( trprim.outcome.remote), names(trprim.outcome.index ))) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 final"= tsfinalpainremsclr3))  






# # change  to as.character for merging
trmerge8 [] <- lapply(trmerge8 , as.character)
tr_primary_outcome[] <- lapply(tr_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

tr.all.prim.outcome <- full_join(trmerge8,tr_primary_outcome ,by = intersect(names(trmerge8), names(tr_primary_outcome))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
trsec.outcome.index <- tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsrep1finalpainindex,tsrep1initialpainindex))) %>% 
  mutate(init.rep1.index1 = 1+(tsrep1initialpainindex)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2))) %>% 
  mutate(init.rep2.index1 = 1+(tsinitialpainindexsclr2)) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3))) %>% 
  mutate(init.rep3.index1 = 1+(tsinitialpainindexsclr3)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
trsec.outcome.remote <- tr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsrep1initialpainrem,tsrep1finalpainrem))) %>% 
  mutate(init.rep1.remote1 = 1+(tsrep1initialpainrem)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsrep2initialpainrem,tsrep2finalpainrem))) %>% 
  mutate(init.rep2.remote1 = 1+(tsrep2initialpainrem)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsinitialpainremsclr3,tsfinalpainremsclr3))) %>% 
  mutate(init.rep3.remote1 = 1+(tsinitialpainremsclr3)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )

tr_sec_outcome <-  full_join(trsec.outcome.index, trsec.outcome.remote ,by = intersect(names(trsec.outcome.remote), names(trsec.outcome.index ))) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 final"= tsfinalpainremsclr3)) 









# change  to as.character for merging
tr_sec_outcome [] <- lapply(tr_sec_outcome , as.character)
tr.all.prim.outcome[] <- lapply(tr.all.prim.outcome, as.character)

#merge ts_sec_outcome  with ts.all.prim.outcome

tr.all.prim.sec.outcome <- full_join(tr_sec_outcome ,tr.all.prim.outcome ,by = intersect(names(tr_sec_outcome), names(tr.all.prim.outcome ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



tr.all.prim.sec.outcome <- tr.all.prim.sec.outcome %>%
  relocate("record_id","redcap_event_name","TS test completed?","TS index rep1 initial","TS index rep1 initial(double entry)","TS index rep1 final"
           ,"TS index rep1 final(double entry)","TS index rep2 initial",  "TS index rep2 initial(double entry)", "TS index rep2 final", "TS index rep2 final(double entry)","TS index rep3 initial","TS index rep3 initial(double entry)","TS index rep3 final", 
           "TS index rep3 final(double entry)" , "TS index after sensation 15sec","TS index after sensation 30sec","TS contralateral rep1 initial" , 
           "TS contralateral rep1 initial(double entry)", "TS contralateral rep1 final" ,"TS contralateral rep1 final(double entry)",
           "TS contralateral rep2 initial","TS contralateral rep2 initial(double entry)","TS contralateral rep2 final" ,   "TS contralateral rep2 final(double entry)" ,
           "TS contralateral rep3 initial", "TS contralateral rep3 initial(double entry)", "TS contralateral rep3 final" ,  "TS contralateral rep3 final(double entry)" ,"TS remote after sensation 15sec" ,
           "TS remote after sensation 30sec" ) %>% 
  as_tibble() %>% 
  mutate_all(as.character)






#ensure each combination of ID and redcap event has one row with all values and is not duplicated

tr.all.prim.sec.outcome [tr.all.prim.sec.outcome == ""] <- NA

tr.all.prim.sec.outcome <- tr.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#Conditioned Pain Modulation

#CPM



#Remove records with missing "cp test completed"

trdata1cp <- qdata %>% 
  filter(!is.na(cpmcompleteyn))



# keep record with "cpm test completed"

trcpm.complete <- trdata1cp %>% 
  filter(cpmcompleteyn != 0 & qst_mcc1_v03_complete == 2)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):







#water temp not checked

trcpm.error1 <- trcpm.complete %>% 
  filter(cpmcoldwatertempc != 1) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmcoldwatertempc) %>% 
  mutate(cpmcoldwatertempc = case_when(cpmcoldwatertempc != 1 ~ "missing",TRUE ~ as.character(cpmcoldwatertempc))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"confirm water temp"=cpmcoldwatertempc)




# missing or mismatch in cold water pain rating at 30 sec

trcpm.error2 <- trcpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30sscl - cpmcoldwaterpain30sscl1) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain30sscl = case_when(is.na(cpmcoldwaterpain30sscl) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30sscl)))%>%
  mutate(cpmcoldwaterpain30sscl1 = case_when(is.na(cpmcoldwaterpain30sscl1) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30sscl1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain30sscl,cpmcoldwaterpain30sscl1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 30 sec"=cpmcoldwaterpain30sscl,"Cold Water Pain Rating at 30 sec(double entry)"=cpmcoldwaterpain30sscl1)





# missing or mismatch in cold water pain rating at 60 sec
trcpm.error3 <- trcpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60sscl - cpmcoldwaterpain60sscl1) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain60sscl = case_when(is.na(cpmcoldwaterpain60sscl) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60sscl)))%>%
  mutate(cpmcoldwaterpain60sscl1 = case_when(is.na(cpmcoldwaterpain60sscl1) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60sscl1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain60sscl,cpmcoldwaterpain60sscl1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 60 sec"=cpmcoldwaterpain60sscl,"Cold Water Pain Rating at 60 sec(double entry)"=cpmcoldwaterpain60sscl1)





#merge error 2&3
trerrorcpm2_3 <- full_join(trcpm.error2,trcpm.error3,by = c("record_id","redcap_event_name","cpm test completed","water bath duration","if outside range: time")) %>%
  as_tibble() %>% 
  mutate_all(as.character)

##merge error 1 with 2&3
trerrorcpm1_2_3 <- full_join(trcpm.error1,trerrorcpm2_3,by = c("record_id","redcap_event_name","cpm test completed")) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#check for missing/mismatch in ppts

trcpm.error4.1 <- trcpm.complete %>% 
  mutate(diff_cpm1 = cpmppt1val - cpmppt1val1) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt1val = case_when(is.na(cpmppt1val) ~ "missing",TRUE ~ as.character(cpmppt1val)))%>%
  mutate(cpmppt1val1 = case_when(is.na(cpmppt1val1) ~ "missing",TRUE ~ as.character(cpmppt1val1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmppt1val,cpmppt1val1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmppt1val,"conditioned pain modulation PPT:rep1(double entry)"=cpmppt1val1)





#check for missing/mismatch in ppts

trcpm.error4.2 <- trcpm.complete %>% 
  mutate(diff_cpm2 = cpmppt2val - cpmppt2val1) %>% 
  filter(diff_cpm2!=0 | is.na(diff_cpm2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt2val = case_when(is.na(cpmppt2val) ~ "missing",TRUE ~ as.character(cpmppt2val)))%>%
  mutate(cpmppt2val1 = case_when(is.na(cpmppt2val1) ~ "missing",TRUE ~ as.character(cpmppt2val1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmppt2val,cpmppt2val1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep2"=cpmppt2val,"conditioned pain modulation PPT:rep2(double entry)"=cpmppt2val1)




#check for missing/mismatch in ppts

trcpm.error4.3 <- trcpm.complete %>% 
  mutate(diff_cpm3 = cpmppt3val - cpmppt3val1) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt3val = case_when(is.na(cpmppt3val) ~ "missing",TRUE ~ as.character(cpmppt3val)))%>%
  mutate(cpmppt3val1 = case_when(is.na(cpmppt3val1) ~ "missing",TRUE ~ as.character(cpmppt3val1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmppt3val,cpmppt3val1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep3"=cpmppt3val,"conditioned pain modulation PPT:rep3(double entry)"=cpmppt3val1)





#merge 4.1-.3

trcpm.error4 <- full_join(trcpm.error4.1,trcpm.error4.2,by = c("record_id","redcap_event_name","cpm test completed")) %>% 
  full_join(.,trcpm.error4.3,by= c("record_id","redcap_event_name","cpm test completed")) %>%
  as_tibble() %>% 
  mutate_all(as.character)



trcpm.final <- full_join(trcpm.error4,trerrorcpm1_2_3,by = c("record_id","redcap_event_name","cpm test completed")) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


trcmp.prim.outcome <- trcpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )










#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


trcmp.sec.outcome <- trcpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


trcmp.outcome <- full_join(trcmp.prim.outcome ,trcmp.sec.outcome ,by = intersect(names(trcmp.prim.outcome), names(trcmp.sec.outcome))) %>% rename("cpm test completed"=cpmcompleteyn.factor,"PPT test completed?" = pptcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmppt1val,"conditioned pain modulation PPT:rep2"=cpmppt2val,
                                                                                                                                                  "conditioned pain modulation PPT:rep3"=cpmppt3val,"ppt remote rep1"= pptremote1val,"ppt remote rep2"= pptremote2val,"ppt remote rep3"= pptremote3val) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#change  to as.character for merging
trcmp.outcome [] <- lapply(trcmp.outcome , as.character)
trcpm.final[] <- lapply(trcpm.final, as.character)

#merge all cmp errors

trall.cmp <-  full_join(trcmp.outcome ,trcpm.final ,by = intersect(names(trcmp.outcome), names(trcpm.final))) %>% 
  relocate("record_id", "redcap_event_name","cpm test completed","PPT test completed?","ppt remote rep1","ppt remote rep2",   
           "ppt remote rep3","conditioned pain modulation PPT:rep1", "conditioned pain modulation PPT:rep1(double entry)",             
           "conditioned pain modulation PPT:rep2","conditioned pain modulation PPT:rep2(double entry)","conditioned pain modulation PPT:rep3",      "conditioned pain modulation PPT:rep3(double entry)","confirm water temp","water bath duration","Cold Water Pain Rating at 30 sec","Cold Water Pain Rating at 30 sec(double entry)","Cold Water Pain Rating at 60 sec","Cold Water Pain Rating at 60 sec(double entry)") %>% 
  arrange(record_id) %>%
  as_tibble() %>% 
  mutate_all(as.character)








#ensure each combination of ID and redcap event has one row with all values and is not duplicated

#ensure each combination of ID and redcap event has one row with all values and is not duplicated

trall.cmp[trall.cmp== ""] <- NA

trall.cmp <- trall.cmp%>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#link with imaging data
label(trdata.image$fmricuffcompletescl)="Test Completed:"
label(trdata.image$fmricuffcontrarecal)="imaging_Re-calibration of pressure needed:"
label(trdata.image$fmricuffcalfpressurerecal)="imaging:Pressure 2:"
label(trdata.image$fmricuffcalfpressurerecal2)="imaging:Pressure 2: (double entry)"
label(trdata.image$fmricuffipyn)="imaging_fMRI individualized pressure"
trdata.image$fmricuffcontrarecal.factor = factor(trdata.image$fmricuffcontrarecal,levels=c("1","0"))
trdata.image$fmricuffcompletescl.factor = factor(trdata.image$fmricuffcompletescl,levels=c("1","2","0"))
trdata.image$fmricuffipyn.factor = factor(trdata.image$fmricuffipyn,levels=c("1","0"))

levels(trdata.image$fmricuffcontrarecal.factor)=c("Yes","No")


levels(trdata.image$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
levels(trdata.image$fmricuffipyn.factor)=c("Yes","No")


# select needed variables
trdata.image1 <- trdata.image %>% 
  filter(qst_mcc1_v03_complete == 2)  %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcontrarecal.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl,fmricuffipyn.factor,fmricuffcompletescl.factor)

trdata.qst <- qdata %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrayn,fmricuffcontrayn.factor,fmricuffcalfpressure,fmricuffcalfpressure2,qst_mcc1_v03_complete)



# change  to as.character for merging
trdata.image1 [] <- lapply(trdata.image1 , as.character)
trdata.qst[] <- lapply(trdata.qst, as.character)

#merge both
trqst.image <-  full_join(trdata.image1 ,trdata.qst ,by = intersect(names(trdata.image1), names(trdata.qst)))  %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging



trqst.image1 <- trqst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(fmricuffcalfpressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_event_name,redcap_data_access_group,fmricuffipyn.factor,fmricuffcompletescl.factor,fmricuffcontrayn.factor,
         fmricuffcontrarecal.factor,fmricuffcalfpressure,fmricuffcalfpressure2,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcontrayn.factor = case_when(is.na(fmricuffcontrayn.factor) ~ "missing",TRUE ~ as.character(fmricuffcontrayn.factor)))%>% 
  mutate(fmricuffcontrarecal.factor = case_when(is.na(fmricuffcontrarecal.factor) ~ "missing",TRUE ~ as.character(fmricuffcontrarecal.factor) )) %>% 
  mutate(fmricuffcalfpressure = case_when(is.na(fmricuffcalfpressure) ~ "missing",TRUE ~ as.character(fmricuffcalfpressure) )) %>% 
  mutate(fmricuffcalfpressure2 = case_when(is.na(fmricuffcalfpressure2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressure2) )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal) )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2) )) %>%
  rename ("qst cuff prssure C/I"=fmricuffcontrayn.factor,"image:Re-calibration of pressure needed:"=fmricuffcontrarecal.factor,"qst pressure1"=fmricuffcalfpressure,"qst pressure(double)"=fmricuffcalfpressure2,"imaging recal pressure"=fmricuffcalfpressurerecal,"imaging recal pressure(double)"=fmricuffcalfpressurerecal2, "imaging_fMRI individualized pressure"=fmricuffipyn.factor,"Test Completed:"=fmricuffcompletescl.factor) %>% 
  add_column(QST_test = "No_Recal_pressure")




#fetch notes and dag

trnotes.ppt <- qdata %>% 
  select(record_id,redcap_event_name,pptnotes,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

trnotes.ts <- qdata %>% 
  select(record_id,redcap_event_name,tsnotes,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

trnotes.cpm <- qdata %>% 
  select(record_id,redcap_event_name,cpmnotes,redcap_data_access_group)%>% 
  as_tibble() %>% 
  mutate_all(as.character)






#ppt with notes
# 

qerror2_3_3b_endpoint1[] <- lapply(qerror2_3_3b_endpoint1, as.character)
trnotes.ppt[] <- lapply(trnotes.ppt, as.character)

qerror2_3_3b_endpoint1_notes <- left_join(qerror2_3_3b_endpoint1,trnotes.ppt,by=c("record_id","redcap_event_name")) %>%
  add_column(QST_test = "PPT") %>%
  as_tibble() %>% 
  mutate_all(as.character)


#render table for ppt test

# error2_3_3b_endpoint1_notes %>%
#   
#   datatable(filter = 'top',class = 'cell-border stripe', options = list(
#     pageLength = 10, autoWidth = TRUE,extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))) %>%
#   formatStyle(columns = colnames(.), fontSize = '10%')







#TS with notes

tr.all.prim.sec.outcome[] <- lapply(tr.all.prim.sec.outcome, as.character)
trnotes.ts[] <- lapply(trnotes.ts, as.character)

tr.all.prim.sec.outcome_notes <- left_join(tr.all.prim.sec.outcome,trnotes.ts,by=c("record_id","redcap_event_name")) %>% 
  add_column(QST_test = "Temporal_Summation") %>%
  as_tibble() %>% 
  mutate_all(as.character)



#render table for ts test
# 
# 
# ts.all.prim.sec.outcome_notes  %>%
#   datatable(filter = 'top',class = 'cell-border stripe', options = list(
#     pageLength = 10, autoWidth = TRUE,extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))) %>%
#   formatStyle(columns = colnames(.), fontSize = '10%')











#cpm with notes

trall.cmp[] <- lapply(trall.cmp, as.character)
trnotes.cpm[] <- lapply(trnotes.cpm, as.character)

trall.cmp_notes <- left_join(trall.cmp,trnotes.cpm,by=c("record_id","redcap_event_name")) %>%
  add_column(QST_test = "Conditioned_Pain_Modulation") %>%
  as_tibble() %>% 
  mutate_all(as.character)

#render table for cpm test


# all.cmp_notes %>%
#   datatable(filter = 'top',class = 'cell-border stripe', options = list(
#     pageLength = 10, autoWidth = TRUE,extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))) %>%
#   formatStyle(columns = colnames(.), fontSize = '10%')









#create final qst table for the app 



trqst_table <- full_join(tr.all.prim.sec.outcome_notes,qerror2_3_3b_endpoint1_notes,by = intersect(names(tr.all.prim.sec.outcome_notes), names(qerror2_3_3b_endpoint1_notes
)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

trqst_table1 <- full_join(trqst_table,trall.cmp_notes,by = intersect(names(trqst_table), names(trall.cmp_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


tr_final_image <-  full_join(trqst_table1,trqst.image1,by = intersect(names(trqst_table1), names(trqst.image1))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)%>% 
  left_join(.,m1days_from_sysdate, by=c("record_id","redcap_event_name"))




# blood draw



#Read Data

brdata <- data 

label(brdata$record_id)="Record ID"
label(brdata$redcap_event_name)="Event Name"
label(brdata$bscp_sample_obtained___1)="7. Blood sample (choice=Not obtained)"
label(brdata$bscp_time_blood_draw)="Time completed blood draw: "
label(brdata$bscp_aliq_cnt)="Number of aliquots:"
label(brdata$bscp_time_centrifuge)="Time completed centrifuging: "
label(brdata$bscp_aliquot_freezer_time)="Time placed in freezer:"
label(brdata$bscp_deg_of_hemolysis)="Assess the degree of hemolysis of the plasma (Lavender tube) after centrifugation according to the laminated hemolysis color scale, and record the estimated hemoglobin value in g/L:"
label(brdata$bscp_lav1_not_obt___1)="Lavender #1: (choice=Not obtained)"
label(brdata$bscp_paxg_aliq_na___1)="PAXgene DNA tube: (choice=N/A)"
label(brdata$bscp_protocol_dev)="Did a protocol deviation occur:"
label(brdata$bscp_protocol_dev_reason)="Reason for protocol deviation:"
label(brdata$bscp_comments)="Comments"
#Setting Units









#Setting Factors(will create new variable for factors)
brdata$redcap_event_name.factor = factor(brdata$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
brdata$bscp_sample_obtained___1.factor = factor(brdata$bscp_sample_obtained___1,levels=c("0","1"))
brdata$bscp_aliq_cnt.factor = factor(brdata$bscp_aliq_cnt,levels=c("0","1","2","3","4","5","6","7","8"))
brdata$bscp_deg_of_hemolysis.factor = factor(brdata$bscp_deg_of_hemolysis,levels=c("0",".25",".5","1","2","4","8"))
brdata$bscp_lav1_not_obt___1.factor = factor(brdata$bscp_lav1_not_obt___1,levels=c("0","1"))
brdata$bscp_paxg_not_obt___1.factor = factor(brdata$bscp_paxg_not_obt___1,levels=c("0","1"))

brdata$bscp_paxg_aliq_na___1.factor = factor(brdata$bscp_paxg_aliq_na___1,levels=c("0","1"))
brdata$bscp_protocol_dev.factor = factor(brdata$bscp_protocol_dev,levels=c("1","0"))
brdata$bscp_protocol_dev_reason.factor = factor(brdata$bscp_protocol_dev_reason,levels=c("1","2","3"))

levels(brdata$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(brdata$bscp_sample_obtained___1.factor)=c("Unchecked","Checked")
levels(brdata$bscp_aliq_cnt.factor)=c("0","1","2","3","4","5","6","7","8")
levels(brdata$bscp_deg_of_hemolysis.factor)=c("0","0.25","0.5","1","2","4","8")
levels(brdata$bscp_lav1_not_obt___1.factor)=c("Unchecked","Checked")
levels(brdata$bscp_paxg_aliq_na___1.factor)=c("Unchecked","Checked")
levels(brdata$bscp_paxg_not_obt___1.factor)=c("Unchecked","Checked")
levels(brdata$bscp_protocol_dev.factor)=c("Yes","No")
levels(brdata$bscp_protocol_dev_reason.factor)=c("Unable to obtain blood sample -technical reason","Unable to obtain blood sample -patient related","Sample handling/processing error")







# inspect data

problems(brdata)

glimpse(brdata)

# retype brdata incase future brdata has problems

brdata <- retype(brdata)

# inspect data again to make sure retyping didnt make erroneous assumptions
glimpse(brdata)






# detailed protocol on pg.230 of MOP



# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)




brdata1 <- brdata %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1.factor == "Unchecked" & blood_sample_collection_and_processing_crf_complete == 2)






# format time
brdata1$bscp_time_blood_draw <- ymd_hms(brdata1$bscp_time_blood_draw)

brdata1$bscp_time_centrifuge <- ymd_hms(brdata1$bscp_time_centrifuge)

brdata1$bscp_aliquot_freezer_time <- ymd_hms(brdata1$bscp_aliquot_freezer_time)











#check if blood draw time < centri time < freezer time 
brdata2 <- brdata1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor) 



brflag5 <- brdata2 %>%
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) %>%
  as_tibble() %>% 
  mutate_all(as.character)











#missing info on hours since last drink

brflag6 <- brdata1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "missing",TRUE ~ as.character(bscp_hrs_since_water))) 






brflag1_6 <- full_join(brflag5,brflag6,by = intersect(names(brflag5), names(brflag6))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#missing info on hours since last food


brflag7 <- brdata1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "missing",TRUE ~ as.character(bscp_hrs_since_food))) 





brflag1_7 <- full_join(brflag1_6,brflag7,by = intersect(names(brflag1_6), names(brflag7))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

brflag8 <- brdata1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "missing",TRUE ~ as.character(bscp_hrs_since_cafstim)))


brflag1_8 <- full_join(brflag1_7,brflag8,by = intersect(names(brflag1_7), names(brflag8))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on amount of caff
brflag9 <- brdata1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "missing",TRUE ~ as.character(bscp_caff_cups_amt))) 


brflag1_9 <- full_join(brflag1_8,brflag9,by = intersect(names(brflag1_8), names(brflag9 ))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on any vacc
brflag10 <- brdata1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "missing",TRUE ~ as.character(bscp_any_vacc))) 

brflag1_10 <- full_join(brflag1_9,brflag10,by = intersect(names(brflag1_9), names(brflag10)))






# if level of hemolysis was not entered

brflag11 <- brdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



brflag1_11<- full_join(brflag1_10,brflag11,by = intersect(names(brflag1_10), names(brflag11))) %>%
  as_tibble() %>% 
  mutate_all(as.character)







# if centrifuge time entered but freezing time not entered

brflag14.1 <- brdata1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "missing",TRUE ~ as.character(bscp_aliquot_freezer_time))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_aliquot_freezer_time)






brflag14.1 [] <- lapply(brflag14.1 , as.character)
brflag1_11 [] <- lapply(brflag1_11 , as.character)



brflag1_14.1<- full_join(brflag1_11,brflag14.1,by = intersect(names(brflag1_11), names(brflag14.1))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time entered but degree of hemolysis  not entered

brflag14.2 <- brdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)




brflag1_14.1 [] <- lapply(brflag1_14.1 , as.character)
brflag14.2 [] <- lapply(brflag14.2 , as.character)



brflag1_14.2<- full_join(brflag1_14.1,brflag14.2,by = intersect(names(brflag1_14.1), names(brflag14.2))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time not entered but degree of hemolysis entered

brflag14.3 <- brdata1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "missing",TRUE ~ as.character(bscp_time_centrifuge))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)



brflag1_14.2 [] <- lapply(brflag1_14.2 , as.character)
brflag14.3 [] <- lapply(brflag14.3 , as.character)




brflag1_14<- full_join(brflag1_14.2,brflag14.3,by = intersect(names(brflag1_14.2), names(brflag14.3))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#rename columns
brflag1_14 <- brflag1_14 %>% 
  rename("Time completed blood draw:"= bscp_time_blood_draw,"Time completed centrifuging:"=bscp_time_centrifuge,
         "Time placed in freezer:"= bscp_aliquot_freezer_time,"Assess the degree of hemolysis of the plasma (Lavender tube)"= bscp_deg_of_hemolysis,
         "hours since water"=bscp_hrs_since_water,"hours since food"=bscp_hrs_since_food,"amount of caffeine"= bscp_caff_cups_amt,
         "Any vaccine in last two weeks"= bscp_any_vacc,"hours since caffiene"=bscp_hrs_since_cafstim) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

brflag1_14[] <- lapply(brflag1_14, as.character)

brflag1_14_shrink <- brflag1_14 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>%
  as_tibble() %>% 
  mutate_all(as.character)











brcomments <- brdata1  %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bscp_comments,bscp_sample_obtained___1.factor,bscp_lav1_not_obt___1.factor,bscp_paxg_aliq_na___1.factor,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor,bscp_samplekit_brcd)

brcomments[] <- lapply(brcomments, as.character)

brflag1_14_shrink[] <- lapply(brflag1_14_shrink, as.character)

brflag_comments <- left_join(brflag1_14_shrink,brcomments,by = intersect(names(brflag1_14_shrink), names(brcomments))) %>% 
  rename("Blood sample (choice=Not obtained)"= bscp_sample_obtained___1.factor,
         "Lavender #1: (choice=Not obtained)"= bscp_lav1_not_obt___1.factor,
         "PAXgene DNA tube: (choice=N/A)"= bscp_paxg_aliq_na___1.factor,
         "Did a protocol deviation occur:"= bscp_protocol_dev.factor,
         "Reason for protocol deviation:"= bscp_protocol_dev_reason.factor,
         "Comments"= bscp_comments,"sample kit barcode" = bscp_samplekit_brcd) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  left_join(.,m1days_from_sysdate, by=c("record_id","redcap_event_name")) 






frfunc_table <- frfunc_table %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group))

irerror1_2_3_4_5_6_7_8_notes<-irerror1_2_3_4_5_6_7_8_notes %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group))

tr_final_image <- tr_final_image %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group)) %>% 
  relocate(QST_test, .after = last_col()) %>% 
  mutate(QST_test=as.factor(QST_test))

brflag_comments<- brflag_comments %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group))







### surveys
# Ask hablar to guess most appropriate datatype
appdata.bpi <- retype(data)










#Check for subjects who did not complete the test.
table(appdata.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)




#remove records with missing values for test completed.
appdata.bpi2 <- appdata.bpi %>% 
  drop_na(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(appdata.bpi2$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)






#keep records for subjects who completed the test.
appdata.bpi3 <- appdata.bpi2 %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2)

#check
table(appdata.bpi3$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)





#if  average pain at a site was indicated but length of time was not indicated


error.bpi1 <- appdata.bpi3 %>%
  filter((!is.na(bpi_mbm_z1_rate) & bpi_mbm_z1_rate > 0 & is.na(bpi_mbm_z1_dur)) |(!is.na(bpi_mbm_z2_rate) & bpi_mbm_z2_rate > 0 & is.na(bpi_mbm_z2_dur)) |
           (!is.na(bpi_mbm_z3_rate) & bpi_mbm_z3_rate > 0 & is.na(bpi_mbm_z3_dur)) |(!is.na(bpi_mbm_z4_rate) & bpi_mbm_z4_rate > 0 & is.na(bpi_mbm_z4_dur)) |(!is.na(bpi_mbm_z5_rate) & bpi_mbm_z5_rate > 0 & is.na(bpi_mbm_z5_dur))|(!is.na(bpi_mbm_z6_rate) & bpi_mbm_z6_rate > 0 & is.na(bpi_mbm_z6_dur))|(!is.na(bpi_mbm_z7_rate) & bpi_mbm_z7_rate > 0 & is.na(bpi_mbm_z7_dur))|(!is.na(bpi_mbm_z8_rate) & bpi_mbm_z8_rate > 0 & is.na(bpi_mbm_z8_dur)) | (!is.na(bpi_mbm_z9_rate) & bpi_mbm_z9_rate > 0 & is.na(bpi_mbm_z9_dur))) %>% 
  select(record_id,redcap_event_name,bpi_mbm_z1_rate,bpi_mbm_z1_dur,bpi_mbm_z2_rate,bpi_mbm_z2_dur,bpi_mbm_z3_rate,bpi_mbm_z3_dur,bpi_mbm_z4_rate,bpi_mbm_z4_dur,bpi_mbm_z5_rate,
         bpi_mbm_z5_dur,bpi_mbm_z6_rate,bpi_mbm_z6_dur,bpi_mbm_z7_rate,bpi_mbm_z7_dur,bpi_mbm_z8_rate,bpi_mbm_z8_dur,bpi_mbm_z9_rate,bpi_mbm_z9_dur) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpi_mbm_z1 = case_when((is.na(bpi_mbm_z1_rate) & !is.na(bpi_mbm_z1_dur)) | (!is.na(bpi_mbm_z1_rate) & is.na(bpi_mbm_z1_dur))  ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z2 = case_when((is.na(bpi_mbm_z2_rate) & !is.na(bpi_mbm_z2_dur))| (!is.na(bpi_mbm_z2_rate) & is.na(bpi_mbm_z2_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z3 = case_when((is.na(bpi_mbm_z3_rate) & !is.na(bpi_mbm_z3_dur))| (!is.na(bpi_mbm_z3_rate) & is.na(bpi_mbm_z3_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z4 = case_when((is.na(bpi_mbm_z4_rate) & !is.na(bpi_mbm_z4_dur)) |(!is.na(bpi_mbm_z4_rate) & is.na(bpi_mbm_z4_dur))~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z5 = case_when((is.na(bpi_mbm_z5_rate) & !is.na(bpi_mbm_z5_dur))| (!is.na(bpi_mbm_z5_rate) & is.na(bpi_mbm_z5_dur))~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z6 = case_when((is.na(bpi_mbm_z6_rate) & !is.na(bpi_mbm_z6_dur))|(!is.na(bpi_mbm_z6_rate) & is.na(bpi_mbm_z6_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z7 = case_when((is.na(bpi_mbm_z7_rate) & !is.na(bpi_mbm_z7_dur))|(!is.na(bpi_mbm_z7_rate) & is.na(bpi_mbm_z7_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z8 = case_when((is.na(bpi_mbm_z8_rate) & !is.na(bpi_mbm_z8_dur))|(!is.na(bpi_mbm_z8_rate) & is.na(bpi_mbm_z8_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z9 = case_when((is.na(bpi_mbm_z9_rate) & !is.na(bpi_mbm_z9_dur)) |(!is.na(bpi_mbm_z9_rate) & is.na(bpi_mbm_z9_dur)) ~ "x",TRUE ~ "1")) %>% 
  select(record_id,redcap_event_name,bpi_mbm_z1,bpi_mbm_z2,bpi_mbm_z3,bpi_mbm_z4,bpi_mbm_z5,bpi_mbm_z6,bpi_mbm_z7,bpi_mbm_z8,bpi_mbm_z9)





# missing pain interference score
error.bpi2 <- appdata.bpi3 %>%
  select(record_id,redcap_event_name,bpipainintrfrscore) %>% 
  filter(is.na(bpipainintrfrscore)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpipainintrfrscore = case_when(is.na(bpipainintrfrscore) ~ "x"))

errorbpi1_2 <- full_join(error.bpi1,error.bpi2,by = intersect(names(error.bpi1), names(error.bpi2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols=3:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(bpi_complete = 0) %>% # added new step here
  as_tibble() %>% 
  mutate_all(as.character) 



glimpse(errorbpi1_2)



# recode 0,1 ie incomplete/unverified to 2
error.bpi3 <- appdata.bpi %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 0 |bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 1) %>% 
  mutate(bpi_complete = case_when(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 0 |bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete== 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,bpi_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character)


table(error.bpi3$bpi_complete)



#merge all
errorbpi1_3 <- full_join(errorbpi1_2,error.bpi3,by = intersect(names(errorbpi1_2), names(error.bpi3))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")

table(errorbpi1_3$bpi_complete)




# recode NAs to 8 in the original dataset, select DAG as well
data.bpi <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete = case_when(is.na(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) ~ "8", TRUE ~ as.character(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) 


table(data.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,exclude = NULL)





#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

errorbpi1_3[errorbpi1_3== ""] <- NA


errorbpi1_3 <- errorbpi1_3 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# bpi_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_bpi <- full_join(data.bpi,errorbpi1_3,by = intersect(names(data.bpi), names(errorbpi1_3))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpi_complete = case_when(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete  == "8" ~ "8", TRUE ~ as.character(bpi_complete))) %>% 
  replace(is.na(.), "1") %>% 
  select(-bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




table(full_bpi$bpi_complete,exclude = NULL) 





# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
dat.bpi <- full_bpi %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BPI") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "bpi_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "BPI") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.bpi = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


data_bpi <- dat.bpi %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(data_bpi$b.bpi) 
table(appdata.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,exclude = NULL) 






#Read Data

data.koos <- data
# data.koos <- list.files(path = here("data"),
#                pattern = "^A2CPSMainStudy-KOOS_DATA", 
#                full.names = T) %>% 
#     map_df(~read_csv(.))











# Ask hablar to guess most appropriate datatype
data.koos <- retype(data.koos)








names(data.koos)

#Check for subjects who did not complete the survey.
table(data.koos$knee_injury_osteoarthritis_outcome_score_koos12_complete, exclude = NULL)




#remove records with missing values for test completed.
data.koos2 <- data.koos %>% 
  drop_na(knee_injury_osteoarthritis_outcome_score_koos12_complete)






#Recheck if all records with missing data for completed tests were removed.
table(data.koos2$knee_injury_osteoarthritis_outcome_score_koos12_complete, exclude = NULL)






#keep records for subjects who completed the test, where 2 is complete and 0 is incomplete
data.koos3 <- data.koos2 %>% 
  filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 2)

#check
table(data.koos3$knee_injury_osteoarthritis_outcome_score_koos12_complete, exclude = NULL)





#if transformed scores were missing

#summary score
error.koos1 <- data.koos3 %>%
  filter(is.na(koossummaryscore)) %>% 
  select(record_id,redcap_event_name,koossummaryscore) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koossummaryscore = case_when((is.na(koossummaryscore))  ~ "x",TRUE ~ "1")) 

#pain score
error.koos2 <- data.koos3 %>%
  filter(is.na(koospainscoret)) %>% 
  select(record_id,redcap_event_name,koospainscoret) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koospainscoret = case_when((is.na(koospainscoret))  ~ "x",TRUE ~ "1")) 

# function score 
error.koos3 <- data.koos3 %>%
  filter(is.na(koosfunctionscoret)) %>% 
  select(record_id,redcap_event_name,koosfunctionscoret) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koosfunctionscoret = case_when((is.na(koosfunctionscoret))  ~ "x",TRUE ~ "1")) 


# qol score
error.koos4 <- data.koos3 %>%
  filter(is.na(koosqolscoret)) %>% 
  select(record_id,redcap_event_name,koosqolscoret) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koosqolscoret = case_when((is.na(koosqolscoret))  ~ "x",TRUE ~ "1")) 






# recode 0,1 ie incomplete/unverified to 2
error.koos5 <- data.koos %>% 
  filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 0 |knee_injury_osteoarthritis_outcome_score_koos12_complete == 1) %>% 
  mutate(koos12_complete = case_when(knee_injury_osteoarthritis_outcome_score_koos12_complete == 1 | knee_injury_osteoarthritis_outcome_score_koos12_complete == 0 ~ 2)) %>%    
  select(record_id,redcap_event_name,koos12_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 







error.koos1_2 <- full_join(error.koos1,error.koos2,by = intersect(names(error.koos1), names(error.koos2)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

error.koos1_3 <- full_join(error.koos1_2,error.koos3,by = intersect(names(error.koos1_2), names(error.koos3)))   %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

error.koos1_4 <- full_join(error.koos1_3,error.koos4,by = intersect(names(error.koos1_3), names(error.koos4))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols=3:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(koos12_complete = 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  

error.koos1_5 <- full_join(error.koos1_4,error.koos5,by = intersect(names(error.koos1_4), names(error.koos5)))%>% 
  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")





# recode NAs to 8 in the original dataset, select DAG as well

data.koos1 <-data.koos %>%
  as_tibble() %>%
  mutate_all(as.character)  %>% 
  mutate(knee_injury_osteoarthritis_outcome_score_koos12_complete = case_when(is.na(knee_injury_osteoarthritis_outcome_score_koos12_complete) ~ "8", TRUE ~ as.character(knee_injury_osteoarthritis_outcome_score_koos12_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






#ensure each combination of ID and redcap event has one row with all values and is not duplicated


error.koos1_5[error.koos1_5== ""] <- NA

error.koos1_5 <- error.koos1_5 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#recode koos12_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)

full_koos <- full_join(data.koos1,error.koos1_5,by = intersect(names(data.koos1), names(error.koos1_5))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koos12_complete = case_when(knee_injury_osteoarthritis_outcome_score_koos12_complete  == "8" ~ "8", TRUE ~ as.character(koos12_complete))) %>%  
  replace(is.na(.), "1") %>% 
  select(-knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


table(full_koos$koos12_complete,exclude = NULL)




dat.koos <- full_koos %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "koos") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "koos12_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "koos") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.koos = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


data_koos <- dat.koos %>%
  pivot_wider (names_from = dataset,values_from = error) 


table(data_koos$b.koos)

table(data$knee_injury_osteoarthritis_outcome_score_koos12_complete,exclude = NULL)








#ANXIETY



data.anxiety <- data 









#Check for subjects who did not complete the test.
table(data.anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)




#remove records with missing values for test completed.
data.anxiety2 <- data.anxiety %>% 
  drop_na(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(data.anxiety2$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)






#keep records for subjects who completed the test.
data.anxiety3 <- data.anxiety2 %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 2)

#check
table(data.anxiety3$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)






error.anxiety.1.1 <- data.anxiety3 %>% 
  select(record_id,redcap_event_name,starts_with("gad"),-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,-gad7difficulttowork) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("gad"), ~ifelse(!is.na(.x),"1","x"))) 

error.anxiety.1.2 <- data.anxiety3 %>% 
  select(record_id,redcap_event_name,starts_with("gad"),-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(gad2feelnervscl !="0"  | gad2notstopwryscl!="0" | gad7wrytoomchscl !="0" | gad7troubrelxscl !="0" | gad7rstlessscl !="0" | gad7easyannoyedscl !="0" | gad7feelafrdscl !="0") %>% 
  filter(is.na(gad7difficulttowork)) %>% 
  select(record_id,redcap_event_name,gad7difficulttowork) %>% 
  mutate(gad7difficulttowork = replace_na(gad7difficulttowork, "x"))

glimpse(error.anxiety.1.2)
error.anxiety1  <- full_join(error.anxiety.1.1 ,error.anxiety.1.2 ,by = intersect(names(error.anxiety.1.1 ), names(error.anxiety.1.2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


glimpse(data.anxiety3)


# recode 0,1 ie incomplete/unverified to 2

error.anxiety2 <- data.anxiety %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 0 |generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 1) %>% 
  mutate(anxiety_complete = case_when(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 0 |generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,anxiety_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#merge all
erroranxiety1_2 <- full_join(error.anxiety1,error.anxiety2,by = intersect(names(error.anxiety1), names(error.anxiety2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
data_anxiety <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete = case_when(is.na(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) ~ "8", TRUE ~      as.character(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) 


table(data_anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,exclude = NULL)





#ensure each combination of ID and redcap event has one row with all values and is not duplicated




erroranxiety1_2[erroranxiety1_2== ""] <- NA

erroranxiety1_2 <- erroranxiety1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(erroranxiety1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_anxiety <- full_join(data_anxiety,erroranxiety1_2,by = intersect(names(data_anxiety), names(erroranxiety1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(anxiety_complete = case_when(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete  == "8" ~ "8", TRUE ~ as.character(anxiety_complete))) %>% 
  filter(!is.na(anxiety_complete)) %>% # If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  replace(is.na(.), "1") %>% 
  select(-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))











dat.anxiety <- full_anxiety %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Anxiety") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "anxiety_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "Anxiety") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.anxiety = case_when(error == "clean" ~ 1,
                               error == 2 ~ 2,
                               error == 8 ~ 8,
                               TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data.anxiety_wide <- dat.anxiety %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(dat.anxiety$b.anxiety)


table(data.anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,exclude = NULL)



# depression


data.dep <- data









#Check for subjects who did not complete the test.
table(data.dep$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)




#remove records with missing values for test completed.
data.dep2 <- data.dep %>% 
  drop_na(patient_health_questionnaire_depression_scale_phq_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(data.dep2$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)






#keep records for subjects who completed the test.
data.dep3 <- data.dep2 %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete == 2)

#check
table(data.dep3$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)






error.dep1 <- data.dep3 %>% 
  select(record_id,redcap_event_name,starts_with("phq"),-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("phq"), ~ifelse(!is.na(.x),"1","x"))) 





error.dep2 <- data.dep %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete == 0 |patient_health_questionnaire_depression_scale_phq_complete == 1) %>% 
  mutate(dep_complete = case_when(patient_health_questionnaire_depression_scale_phq_complete == 0 |patient_health_questionnaire_depression_scale_phq_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,dep_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

table(error.dep2$dep_complete)



errordep1_2 <- full_join(error.dep1,error.dep2,by = intersect(names(error.dep1), names(error.dep2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
data_dep <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(patient_health_questionnaire_depression_scale_phq_complete = case_when(is.na(patient_health_questionnaire_depression_scale_phq_complete) ~ "8", TRUE ~ as.character(patient_health_questionnaire_depression_scale_phq_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,patient_health_questionnaire_depression_scale_phq_complete) 


table(data_dep$patient_health_questionnaire_depression_scale_phq_complete,exclude = NULL)



#ensure each combination of ID and redcap event has one row with all values and is not duplicated




errordep1_2[errordep1_2== ""] <- NA

errordep1_2 <- errordep1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_dep <- full_join(data_dep,errordep1_2,by = intersect(names(data_dep), names(errordep1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(dep_complete = case_when(patient_health_questionnaire_depression_scale_phq_complete  == "8" ~ "8", TRUE ~ as.character(dep_complete))) %>% 
  filter(!is.na(dep_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))






dat.dep <- full_dep %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Depression") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "dep_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "Depression") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.dep = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



data.dep_wide <- dat.dep %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(data.dep_wide$b.dep)

table(data$patient_health_questionnaire_depression_scale_phq_complete,exclude = NULL)


###############################


#Read Data

data.cat <- data






data.cat <- retype(data.cat)








names(data.cat)

#Check for subjects who did not complete the test.
table(data.cat$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)




#remove records with missing values for test completed.
data.cat2 <- data.cat %>% 
  drop_na(pain_catastrophizing_questionnaire_pcs6_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(data.cat2$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)






#keep records for subjects who completed the test.
data.cat3 <- data.cat2 %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete == 2)

#check
table(data.cat3$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)






error.cat1 <- data.cat3 %>% 
  select(record_id,redcap_event_name,-pain_catastrophizing_questionnaire_pcs6_complete,starts_with("pcq")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("pcq"), ~ifelse(!is.na(.x),"1","x"))) 







error.cat2 <- data.cat2 %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete == 0 |pain_catastrophizing_questionnaire_pcs6_complete == 1 ) %>% 
  mutate(cat_complete = case_when(pain_catastrophizing_questionnaire_pcs6_complete == 0 |pain_catastrophizing_questionnaire_pcs6_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,cat_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  

table(error.cat2$cat_complete)




errorcat1_2 <- full_join(error.cat1,error.cat2,by = intersect(names(error.cat1), names(error.cat2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")


table(errorcat1_2$cat_complete)




# recode NAs to 8 in the original dataset, select DAG as well

data.cat1 <-data.cat %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(pain_catastrophizing_questionnaire_pcs6_complete = case_when(is.na(pain_catastrophizing_questionnaire_pcs6_complete) ~ "8", TRUE ~ as.character(pain_catastrophizing_questionnaire_pcs6_complete))) %>%
  select(record_id,redcap_event_name,redcap_data_access_group,pain_catastrophizing_questionnaire_pcs6_complete)

table(data.cat1$pain_catastrophizing_questionnaire_pcs6_complete)




errorcat1_2[errorcat1_2== ""] <- NA

errorcat1_2 <- errorcat1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(errorcat1_2$cat_complete,exclude = NULL)




#recode koos12_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)


full_cat <- full_join(data.cat1,errorcat1_2,by = intersect(names(data.cat1), names(errorcat1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cat_complete = case_when(pain_catastrophizing_questionnaire_pcs6_complete  == "8" ~ "8", TRUE ~ as.character(cat_complete))) %>% 
  filter(!is.na(cat_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


table(full_cat$cat_complete,exclude = NULL)






dat.cat <- full_cat %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Catastrophizing") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "cat_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "Catastrophizing") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.cat = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



data.cat_wide <- dat.cat %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(data.cat_wide$b.cat)


table(data$pain_catastrophizing_questionnaire_pcs6_complete,exclude = NULL)




#Read Data

data.move <- data



#begin checks for uchicago
# data.anxiety <- data.anxiety %>%
#   filter(redcap_data.anxiety_access_group == "uchicago")


# Ask hablar to guess most appropriate datatype
data.move  <- retype(data.move)








names(data.move)

#Check for subjects who did not complete the test.
table(data.move$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)




#remove records with missing values for test completed.
data.move2 <- data.move %>% 
  drop_na(fearavoidance_beliefs_questionnaire_v03_fabq_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(data.move2$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)






#keep records for subjects who completed the test.
data.move3 <- data.move2 %>% 
  filter(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 2)

#check
table(data.move3$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)






error.move1 <- data.move3 %>% 
  select(record_id,redcap_event_name,-fearavoidance_beliefs_questionnaire_v03_fabq_complete,starts_with("fabq")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("fabq"), ~ifelse(!is.na(.x),"1","x"))) 






error.move2 <- data.move %>% 
  filter(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 0 |fearavoidance_beliefs_questionnaire_v03_fabq_complete == 1) %>% 
  mutate(FearMovement_complete = case_when(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 0 |fearavoidance_beliefs_questionnaire_v03_fabq_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,FearMovement_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  



errormove1_2 <- full_join(error.move1,error.move2,by = intersect(names(error.move1), names(error.move2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")




errormove1_2[errormove1_2== ""] <- NA

errormove1_2 <- errormove1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(errormove1_2$FearMovement_complete)





data.move1 <-data.move %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(fearavoidance_beliefs_questionnaire_v03_fabq_complete = case_when(is.na(fearavoidance_beliefs_questionnaire_v03_fabq_complete) ~ "8", TRUE ~ as.character(fearavoidance_beliefs_questionnaire_v03_fabq_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fearavoidance_beliefs_questionnaire_v03_fabq_complete) 


table(data.move1$fearavoidance_beliefs_questionnaire_v03_fabq_complete,exclude = NULL)




# bpi_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_move <- full_join(data.move1,errormove1_2,by = intersect(names(data.move1), names(errormove1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(FearMovement_complete = case_when(fearavoidance_beliefs_questionnaire_v03_fabq_complete  == "8" ~ "8", TRUE ~ as.character(FearMovement_complete))) %>% 
  filter(!is.na(FearMovement_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-fearavoidance_beliefs_questionnaire_v03_fabq_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))



table(full_move$FearMovement_complete,exclude = NULL) 





dat.move <- full_move  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "FearMovement") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "FearMovement_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "FearMovement") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.move = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data.move_wide <- dat.move %>%
  pivot_wider (names_from = dataset,values_from = error)


table(dat.move$b.move,exclude = NULL) 

table(data$fearavoidance_beliefs_questionnaire_v03_fabq_complete,exclude = NULL)







#Read Data

data.sleep1 <- data





# checking func access sites

data.sleep  <- retype(data.sleep1) %>% 
  select(record_id,redcap_event_name,starts_with("promis"))









names(data.sleep)

#Check for subjects who did not complete the test.
table(data.sleep$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)




#remove records with missing values for test completed.
data.sleep2 <- data.sleep %>% 
  drop_na(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(data.sleep2$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)






#keep records for subjects who completed the test.
data.sleep3 <- data.sleep2 %>% 
  filter(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 2)

#check
table(data.sleep3$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)






error.sleep1 <- data.sleep3 %>% 
  select(-promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,promissleepwasrefreshscl,promisproblemwithslpscl,promisdifficltfallaslpscl,promisslpwasrestlessscl,promistryhardgettoslpscl, promissleepqualityscl) %>% 
  mutate(across(starts_with("promis"), ~ifelse(!is.na(.x),"1","x"))) 






error.sleep2 <- data.sleep %>% 
  filter(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 0 |promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 1) %>% 
  mutate(sleep_complete = case_when(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 0 |promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,sleep_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



errorsleep1_2 <- full_join(error.sleep1,error.sleep2,by = intersect(names(error.sleep1), names(error.sleep2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
data_slp <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete = case_when(is.na(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) ~ "8", TRUE ~ as.character(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,promis_sf_v10_sleep_disturbance_6a_sleep_i_complete)


table(data_slp$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete,exclude = NULL)




errorsleep1_2[errorsleep1_2== ""] <- NA
errorsleep1_2 <- errorsleep1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_slp <- full_join(data_slp,errorsleep1_2,by = intersect(names(data_slp), names(errorsleep1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(sleep_complete = case_when(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete  == "8" ~ "8", TRUE ~ as.character(sleep_complete))) %>% 
  filter(!is.na(sleep_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))





table(full_slp$sleep_complete,exclude = NULL) 








dat.sleep <- full_slp %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset ="Promis_Sleep") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "sleep_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "Promis_Sleep") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.sleep = case_when(error == "clean" ~ 1,
                             error == 2 ~ 2,
                             error == 8 ~ 8,
                             TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))






data.sleep_wide <- dat.sleep %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(data.sleep_wide$b.sleep)

table(data$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete,exclude = NULL)




#Read Data

data.sleep_hours1 <-   data1 %>% 
  
  mutate(sleepnighthourmindurhrs = as.numeric(sleepnighthourmindurhrs)) %>% 
  mutate(sleepnighthourmindurmins= as.numeric(sleepnighthourmindurmins)) %>% 
  mutate(sleepnighthourmindur = as.numeric(sleepnighthourmindur)) 



data.sleep_hours <- data.sleep_hours1 %>% 
  filter(!record_id %in% withdrawm1 & !record_id %in% test_records) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur,painsleep_duration_sleep_ii_complete) 


# event <- c("baseline_visit_arm_1","6wks_postop_arm_1",	
#            "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")
# data.sleep_hours <- data.sleep_hours %>% 
#   filter(redcap_event_name %in% event)







names(data.sleep_hours)

#Check for subjects who did not complete the test.
table(data.sleep_hours$painsleep_duration_sleep_ii_complete, exclude = NULL)




#remove records with missing values for test completed.
data.sleep_hours2 <- data.sleep_hours %>% 
  drop_na(painsleep_duration_sleep_ii_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(data.sleep_hours2$painsleep_duration_sleep_ii_complete, exclude = NULL)






#keep records for subjects who completed the test.
data.sleep_hours3 <- data.sleep_hours2 %>% 
  filter(painsleep_duration_sleep_ii_complete == 2)

#check
table(data.sleep_hours3$painsleep_duration_sleep_ii_complete, exclude = NULL)






error.sleep_hours1 <- data.sleep_hours3 %>% 
  select(-painsleep_duration_sleep_ii_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(empty_1 = case_when(is.na(sleepnighthourmindurhrs) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_2 = case_when(is.na(sleepnighthourmindur) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_3 = case_when(is.na(sleepnighthourmindurmins) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_4= case_when(empty_1 == "x" & empty_2 == "x" & empty_3 == "x" ~ "x",TRUE ~ "1")) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,empty_4) %>% 
  rename("sleepnighthourmindur"= empty_4) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



error.sleep_hours2 <- data.sleep_hours %>% 
  filter(painsleep_duration_sleep_ii_complete ==0 |painsleep_duration_sleep_ii_complete == 1) %>% 
  mutate(sleep_hours_complete = case_when(painsleep_duration_sleep_ii_complete == 0 |painsleep_duration_sleep_ii_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,sleep_hours_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


dim(error.sleep_hours2)

errorsleep_hours1_2 <- full_join(error.sleep_hours1,error.sleep_hours2,by = intersect(names(error.sleep_hours1), names(error.sleep_hours2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
data.slp_hours <- data.sleep_hours %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(painsleep_duration_sleep_ii_complete = case_when(is.na(painsleep_duration_sleep_ii_complete) ~ "8", TRUE ~ as.character(painsleep_duration_sleep_ii_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,painsleep_duration_sleep_ii_complete) 



table(data.slp_hours$painsleep_duration_sleep_ii_complete,exclude = NULL)




errorsleep_hours1_2[errorsleep_hours1_2== ""] <- NA
errorsleep_hours1_2 <- errorsleep_hours1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_slp_hrs <- full_join( data.slp_hours,errorsleep_hours1_2,by = intersect(names(data.slp_hours), names(errorsleep_hours1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(sleep_hours_complete= case_when(painsleep_duration_sleep_ii_complete  == "8" ~ "8", TRUE ~ as.character(sleep_hours_complete))) %>% 
  filter(!is.na(sleep_hours_complete)) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-painsleep_duration_sleep_ii_complete)


full_slp_hrs  %>% 
  filter(is.na(redcap_data_access_group))







table(full_slp_hrs$sleep_hours_complete,exclude = NULL) 









dat.sleep_hours <- full_slp_hrs  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "sleep_hours") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "sleep_hours_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "sleep_hours") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.sleep_hours = case_when(error == "clean" ~ 1,
                                   error == 2 ~ 2,
                                   error == 8 ~ 8,
                                   TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



data.sleep_hours_wide <- dat.sleep_hours %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(data.sleep_hours_wide$b.sleep_hours)



table(data.sleep_hours$painsleep_duration_sleep_ii_complete,exclude = NULL)

########## Read Data cognition   ##########



# Ask hablar to guess most appropriate datatype
appdata.cog <- retype(data)







#Check for subjects who did not complete the test.
table(appdata.cog$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)




#remove records with missing values for test completed.
appdata.cog2 <- appdata.cog %>% 
  drop_na(multidimensional_inventory_of_subjective_cognitive_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(appdata.cog2$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)



#keep records for subjects who completed the test.
appdata.cog3 <- appdata.cog2 %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete== 2)

#check
table(appdata.cog3$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)



error.cog1 <- appdata.cog3 %>% 
  select(record_id,redcap_event_name,-multidimensional_inventory_of_subjective_cognitive_complete,starts_with("misc")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("misc"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

error.cog2 <- appdata.cog %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete == 0 | multidimensional_inventory_of_subjective_cognitive_complete == 1) %>% 
  mutate(cog_complete = case_when(multidimensional_inventory_of_subjective_cognitive_complete == 0 | multidimensional_inventory_of_subjective_cognitive_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,cog_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)

table(error.cog2$cog_complete)


#merge all
errorcog1_2 <- full_join(error.cog1,error.cog2,by = intersect(names(error.cog1), names(error.cog2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 


table(errorcog1_2$cog_complete, exclude = NULL)




# recode NAs to 8 in the original dataset, select DAG as well
appdata.cog <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(multidimensional_inventory_of_subjective_cognitive_complete = case_when(is.na(multidimensional_inventory_of_subjective_cognitive_complete) ~ "8", TRUE ~ as.character(multidimensional_inventory_of_subjective_cognitive_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,multidimensional_inventory_of_subjective_cognitive_complete) 


table(appdata.cog$multidimensional_inventory_of_subjective_cognitive_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated




errorcog1_2[errorcog1_2== ""] <- NA

errorcog1_2 <- errorcog1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_cog <- full_join(appdata.cog,errorcog1_2,by = intersect(names(appdata.cog), names(errorcog1_2))) %>% 
  mutate(cog_complete = case_when(multidimensional_inventory_of_subjective_cognitive_complete == "8" ~ "8", TRUE ~ as.character(cog_complete))) %>% 
  filter(!is.na(cog_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


dat.cog <- full_cog %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "cognition") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "cog_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "cognition") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.cog = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data.cog_wide <- dat.cog %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(dat.cog$b.cog,exclude = NULL)


table(data$multidimensional_inventory_of_subjective_cognitive_complete ,exclude = NULL)


########## Read Data Resilience   ##########



# Ask hablar to guess most appropriate datatype
appdata.res <- retype(data)







#Check for subjects who did not complete the test.
table(appdata.res$pain_resilience_scale_prs_complete, exclude = NULL)




#remove records with missing values for test completed.
appdata.res2 <- appdata.res %>% 
  drop_na(pain_resilience_scale_prs_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(appdata.res2$pain_resilience_scale_prs_complete, exclude = NULL)



#keep records for subjects who completed the test.
appdata.res3 <- appdata.res2 %>% 
  filter(pain_resilience_scale_prs_complete== 2)

#check
table(appdata.res3$pain_resilience_scale_prs_complete, exclude = NULL)


appdata.res3 <- appdata.res3 %>% 
  select(record_id,redcap_event_name,-pain_resilience_scale_prs_complete,starts_with("prs"))


names(appdata.res3)



error.res1 <- appdata.res3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("prs"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

error.res2 <- appdata.res %>% 
  filter(pain_resilience_scale_prs_complete == 0 | pain_resilience_scale_prs_complete == 1) %>% 
  mutate(res_complete = case_when(pain_resilience_scale_prs_complete == 0 | pain_resilience_scale_prs_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,res_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
errorres1_2 <- full_join(error.res1,error.res2,by = intersect(names(error.res1), names(error.res2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
appdata.res <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(pain_resilience_scale_prs_complete = case_when(is.na(pain_resilience_scale_prs_complete) ~ "8", TRUE ~ as.character(pain_resilience_scale_prs_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,pain_resilience_scale_prs_complete) 


table(appdata.res$pain_resilience_scale_prs_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated




errorres1_2[errorres1_2== ""] <- NA

errorres1_2 <- errorres1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(errorres1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_res <- full_join(appdata.res,errorres1_2,by = intersect(names(appdata.res), names(errorres1_2))) %>% 
  mutate(res_complete = case_when(pain_resilience_scale_prs_complete == "8" ~ "8", TRUE ~ as.character(res_complete))) %>% 
  filter(!is.na(res_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-pain_resilience_scale_prs_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




dat.res <- full_res %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "resilience") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "res_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "resilience") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.res = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data.res_wide <- dat.res %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(dat.res$b.res)


table(data$pain_resilience_scale_prs_complete ,exclude = NULL)



########## Read social  ##########



# Ask hablar to guess most appropriate datatype
appdata.social <- retype(data)







#Check for subjects who did not complete the test.
table(appdata.social$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)




#remove records with missing values for test completed.
appdata.social2 <- appdata.social %>% 
  drop_na(promis_sf_v20_emotional_support_6a_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(appdata.social2$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)



#keep records for subjects who completed the test.
appdata.social3 <- appdata.social2 %>% 
  filter(promis_sf_v20_emotional_support_6a_complete== 2)

#check
table(appdata.social3$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)


appdata.social3 <- appdata.social3 %>% 
  select(record_id,redcap_event_name,-promis_sf_v20_emotional_support_6a_complete,starts_with("ess"))




names(appdata.social3)



error.social1 <- appdata.social3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("ess"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

error.social2 <- appdata.social %>% 
  filter(promis_sf_v20_emotional_support_6a_complete == 0 | promis_sf_v20_emotional_support_6a_complete == 1) %>% 
  mutate(social_complete = case_when(promis_sf_v20_emotional_support_6a_complete == 0 | promis_sf_v20_emotional_support_6a_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,social_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
errorsocial1_2 <- full_join(error.social1,error.social2,by = intersect(names(error.social1), names(error.social2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
appdata.social <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(promis_sf_v20_emotional_support_6a_complete = case_when(is.na(promis_sf_v20_emotional_support_6a_complete) ~ "8", TRUE ~ as.character(promis_sf_v20_emotional_support_6a_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,promis_sf_v20_emotional_support_6a_complete) 


table(appdata.social$promis_sf_v20_emotional_support_6a_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

errorsocial1_2[errorsocial1_2== ""] <- NA

errorsocial1_2 <- errorsocial1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(errorsocial1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_social <- full_join(appdata.social,errorsocial1_2,by = intersect(names(appdata.social), names(errorsocial1_2))) %>% 
  mutate(social_complete = case_when(promis_sf_v20_emotional_support_6a_complete == "8" ~ "8", TRUE ~ as.character(social_complete))) %>% 
  filter(!is.na(social_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-promis_sf_v20_emotional_support_6a_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




dat.social <- full_social %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "social_support") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "social_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "social_support") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.social = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data.social_wide <- dat.social %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(dat.social$b.social)


table(data$promis_sf_v20_emotional_support_6a_complete ,exclude = NULL)


########## Read ace ##########



# Ask hablar to guess most appropriate datatype
appdata.ace <- retype(data)







#Check for subjects who did not complete the test.
table(appdata.ace$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)




#remove records with missing values for test completed.
appdata.ace2 <- appdata.ace %>% 
  drop_na(adverse_childhood_experience_questionnaire_ace_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(appdata.ace2$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)



#keep records for subjects who completed the test.
appdata.ace3 <- appdata.ace2 %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete== 2)

#check
table(appdata.ace3$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)


appdata.ace3 <- appdata.ace3 %>% 
  select(record_id,redcap_event_name,-adverse_childhood_experience_questionnaire_ace_complete,starts_with("ace"))

names(appdata.ace3)


names(appdata.ace3)



error.ace1 <- appdata.ace3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("ace"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

error.ace2 <- appdata.ace %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete == 0 | adverse_childhood_experience_questionnaire_ace_complete == 1) %>% 
  mutate(ace_complete = case_when(adverse_childhood_experience_questionnaire_ace_complete == 0 | adverse_childhood_experience_questionnaire_ace_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,ace_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
errorace1_2 <- full_join(error.ace1,error.ace2,by = intersect(names(error.ace1), names(error.ace2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
appdata.ace <-data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(adverse_childhood_experience_questionnaire_ace_complete = case_when(is.na(adverse_childhood_experience_questionnaire_ace_complete) ~ "8", TRUE ~ as.character(adverse_childhood_experience_questionnaire_ace_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,adverse_childhood_experience_questionnaire_ace_complete) 


table(appdata.ace$adverse_childhood_experience_questionnaire_ace_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

errorace1_2[errorace1_2== ""] <- NA

errorace1_2 <- errorace1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(errorace1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_ace <- full_join(appdata.ace,errorace1_2,by = intersect(names(appdata.ace), names(errorace1_2))) %>% 
  mutate(ace_complete = case_when(adverse_childhood_experience_questionnaire_ace_complete == "8" ~ "8", TRUE ~ as.character(ace_complete))) %>% 
  filter(!is.na(ace_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-adverse_childhood_experience_questionnaire_ace_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




dat.ace <- full_ace %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "ACE") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "ace_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "ACE") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.ace = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data.ace_wide <- dat.ace %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(dat.ace$b.ace)


table(data$adverse_childhood_experience_questionnaire_ace_complete ,exclude = NULL)



#mcc1 baseline (acute) trajectory

#read in data

data.tr.baseline <- m1_complete_result1 




#select completion vars only
# filter daily items that are complete

data.tr1.baseline <- data.tr.baseline %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,acute_phase_trajectory_items_v05_acute_daily_complete) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(acute_phase_trajectory_items_v05_acute_daily_complete == 2)






# count complete daily items per subject

data.tr.baseline.count <- data.tr1.baseline%>% 
  group_by(record_id) %>% 
  summarise(N=n())


# identify subjects who have >= 2 daily item for 6 month trajectory


baseline_pheno <- data.tr.baseline.count %>% 
  filter(N >= 5) %>% 
  select(record_id)


# select record ids and redcap_data_access_group , redcap_event_name from data to provide redcap data access group for the ids

baseline_traj_data <- data %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) 


# provide redcap data access group and event name to 

baseline_phenom1 <- inner_join(baseline_pheno,baseline_traj_data, by = "record_id") %>% 
  mutate(acute_traj = case_when(redcap_event_name == "baseline_visit_arm_1" ~ 1,TRUE ~ 7))

# isolate 6 month IDs
baseline_ids <- baseline_phenom1 %>% 
  select(record_id) %>% 
  distinct()

#creata a dataset with no 6 months IDs
baseline_traj_data1 <- baseline_traj_data %>% 
  filter(!record_id %in% baseline_ids$record_id) %>% 
  mutate(acute_traj = case_when(redcap_event_name == "baseline_visit_arm_1" ~ 8,TRUE ~ 7))

#combine both datasets to create a dataframe with ids that have 6 mo trajectory and ids with no 6 mo trajectory

baseline_traj_wide <- rbind(baseline_phenom1,baseline_traj_data1) %>% 
  mutate(b.base_traj = acute_traj) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

############################

#mcc1 6 mon trajectory

#read in data

data.tr <- m1_complete_result1 




#read in data

data.bpi <- retype(data) %>% 
  select(record_id,redcap_event_name,starts_with("bpi"))


#select completion vars only
# filter daily items that are complete

data.tr1 <- data.tr %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,daily_items_6_mo_v03_6month_daily_complete,traj6moavgkneepainscl) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(daily_items_6_mo_v03_6month_daily_complete == 2) %>% 
  ungroup()





# count complete daily items per subject

data.tr.count <- data.tr1%>% 
  group_by(record_id) %>% 
  summarise(N=n())


# identify subjects who have >= 2 daily item for 6 month trajectory


six_month_tr <- data.tr.count %>% 
  filter(N >= 1) %>% 
  select(record_id)




data.bpi1 <- data.bpi %>% 
  select(record_id,redcap_event_name,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,bpipainintrfrscore) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(!is.na(bpipainintrfrscore),redcap_event_name == "6mo_postop_arm_1" & bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2) %>% 
  ungroup() %>% 
  select(record_id)



#combine all id from bpi and tr to generate ids of patients with 6 months complete

six_mo_pheno <- rbind(data.bpi1,six_month_tr) %>% 
  distinct(record_id)

# select record ids and redcap_data_access_group , redcap_event_name from data to provide redcap data access group for the ids

traj_data <- data %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) 


# provide redcap data access group and event name to 

six_mo_phenom1 <- inner_join(six_mo_pheno,traj_data, by = c("record_id")) %>% 
  mutate(six_mo_traj = case_when(redcap_event_name == "6mo_postop_arm_1" ~ 1,TRUE ~ 7))

# isolate 6 month IDs
six_mo_ids <- six_mo_phenom1 %>% 
  select(record_id) %>% 
  distinct()

#creata a dataset with no 6 months IDs
traj_data1 <- traj_data %>% 
  filter(!record_id %in% six_mo_ids$record_id) %>% 
  mutate(six_mo_traj = case_when(redcap_event_name == "6mo_postop_arm_1" ~ 8,TRUE ~ 7))

#combine both datasets to create a dataframe with ids that have 6 mo trajectory and ids with no 6 mo trajectory

six.mo_wide <- rbind(six_mo_phenom1,traj_data1) %>% 
  mutate(b.traj = six_mo_traj) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#Read Data

fafunc <- data







fafunc <- retype(fafunc)#Recheck if all records with missing data for completed tests were removed.
table(fafunc$walk10completeyn, exclude = NULL)


#keep records for subjects who completed the test.
fadata3 <- fafunc %>% 
  filter(walk10completeyn == 1 & functional_testing_complete == 2)

table(fadata3$walk10completeyn, exclude = NULL)







#look for discrepancies in the first and the second initial pain rating 
fadata4 <- fadata3 %>% 
  mutate(init_pain_diff = walk10initialpainscl - walk10initialpainscl1) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

faerror1 <- fadata4 %>% 
  select(record_id,redcap_event_name,walk10initialpainscl,walk10initialpainscl1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10initialpainscl = case_when(is.na(walk10initialpainscl) ~ "x",TRUE ~ "x")) %>% 
  mutate(walk10initialpainscl1 = case_when(is.na(walk10initialpainscl1) ~ "x",TRUE ~ "x"))







#look for discrepancies between the first and the second final pain rating 
fadata5 <- fadata3 %>% 
  mutate(final_pain_diff = walk10finalpainscl - walk10finalpainscl1) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

faerror2 <- fadata5 %>% 
  select(record_id,redcap_event_name,walk10finalpainscl,walk10finalpainscl1) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10finalpainscl = case_when(is.na(walk10finalpainscl) ~ "x",TRUE ~ "x")) %>% 
  mutate(walk10finalpainscl1 = case_when(is.na(walk10finalpainscl1) ~ "x",TRUE ~ "x"))


faerror1_2 <- full_join(faerror1,faerror2,by = intersect(names(faerror1), names(faerror2)))





#look for discrepancies between the first and the second walk time 
fadata6 <- fadata3 %>% 
  mutate(walk_time_diff = walk10time - walk10time1) %>% 
  filter(walk_time_diff != 0 | is.na(walk_time_diff))

faerror3 <- fadata6 %>% 
  select(record_id,redcap_event_name,walk10time,walk10time1)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10time = case_when(is.na(walk10time) ~ "x",TRUE ~ "x")) %>% 
  mutate(walk10time1 = case_when(is.na(walk10time1) ~ "x",TRUE ~ "x"))

faerror1_2_3 <- full_join(faerror1_2,faerror3,by = intersect(names(faerror1_2), names(faerror3)))






# check if a reason for test not completed was marked off



fadata7 <- fafunc  %>% 
  filter(walk10completeyn == 0) %>%
  filter(is.na(walk10incompletereason))

faerror4 <- fadata7 %>% 
  select(record_id,redcap_event_name,walk10incompletereason) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10incompletereason = case_when(is.na(walk10incompletereason) ~ "x"))



faerror1_2_3_4 <- full_join(faerror1_2_3,faerror4,by = intersect(names(faerror1_2_3), names(faerror4)))







#if walk was completed, check for records with missing values for any assistance 

faerror5 <- fadata3 %>% 
  filter(walk10completeyn == 1) %>% 
  filter(is.na(walk10assistyn)) %>% 
  select(record_id,redcap_event_name,walk10assistyn)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10assistyn = case_when(is.na(walk10assistyn) ~ "x"))

faerror1_2_3_4_5 <- full_join(faerror1_2_3_4,faerror5,by = intersect(names(faerror1_2_3_4), names(faerror5)))





#if any assistance during walk test was checked off, check for records with unchecked type of assistance 

faerror6 <- fadata3 %>% 
  filter(walk10assistyn == 1) %>% 
  filter(walk10assist_cane___1 == 0 & walk10assist_crutch___1 == 0 & walk10assist_perssuppt___1 == 0 & walk10assist_other___1 == 0 & walk10assist_walkder___1 == 0) %>% 
  mutate(type_of_walk_assistance_not_checked = case_when(walk10assist_cane___1 == 0 & walk10assist_crutch___1 == 0 & walk10assist_perssuppt___1 == 0 & walk10assist_other___1 == 0 & walk10assist_walkder___1 == 0 ~ "x")) %>% 
  select(record_id,redcap_event_name,type_of_walk_assistance_not_checked) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

faerror1_2_3_4_5_6 <- full_join(faerror1_2_3_4_5,faerror6,by = intersect(names(faerror1_2_3_4_5), names(faerror6)))






### 5 times sit to stand test#####




#Check for subjects who did not complete the test.
table(fafunc$tstscompleteyn, exclude = NULL)




#remove records with missing values for test completed.
fadata.sit <- fafunc %>% 
  drop_na(tstscompleteyn)




#Recheck if all records with missing fadata for completed tests were removed.
table(fadata.sit$tstscompleteyn, exclude = NULL)




#check for missing bp values if tsts was completed

faerror.bp <- fadata.sit %>% 
  filter(tstscompleteyn == 1 &  is.na(tstsbpscreen) ) %>% 
  select(record_id,redcap_event_name,tstsbpscreen) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

faerror.bp$tstsbpscreen <- faerror.bp$tstsbpscreen %>% replace_na("x")




#keep records for subjects who completed the test.
fadata.sit1 <- fadata.sit %>% 
  filter(tstscompleteyn == 1 & functional_testing_complete == 2)





#look for discrepancies in the first and the second initial pain rating 
fadata.sit4 <- fadata.sit1 %>% 
  mutate(init_pain_diff.sit = tstsprepainscl - tstsprepainscl1) %>% 
  filter(init_pain_diff.sit != 0 | is.na(init_pain_diff.sit))

faerror1.sit <- fadata.sit4 %>% 
  select(record_id,redcap_event_name,tstsprepainscl,tstsprepainscl1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsprepainscl = case_when(is.na(tstsprepainscl) ~ "x",TRUE ~ "x")) %>% 
  mutate(tstsprepainscl1 = case_when(is.na(tstsprepainscl1) ~ "x",TRUE ~ "x"))










#look for discrepancies between the first and the second final pain rating 
fadata.sit5 <- fadata.sit1 %>% 
  mutate(final_pain_diff.sit = tstspostpainscl - tstspostpainscl1) %>% 
  filter(final_pain_diff.sit != 0 | is.na(final_pain_diff.sit))

faerror2.sit <- fadata.sit5 %>% 
  select(record_id,redcap_event_name,tstspostpainscl,tstspostpainscl1)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstspostpainscl = case_when(is.na(tstspostpainscl) ~ "x",TRUE ~ "x"))%>% 
  mutate(tstspostpainscl1 = case_when(is.na(tstspostpainscl1) ~ "x",TRUE ~ "x"))


faerrorsit1_2 <- full_join(faerror1.sit,faerror2.sit,by = intersect(names(faerror1.sit), names(faerror2.sit)))




#look for discrepancies between the first and the second activity  time 
fadata.sit6 <- fadata.sit1 %>% 
  mutate(sit_time_diff = tststime - tststime1) %>% 
  filter(sit_time_diff != 0 | is.na(sit_time_diff))

faerror3.sit <- fadata.sit6 %>% 
  select(record_id,redcap_event_name,tststime,tststime1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tststime = case_when(is.na(tststime) ~ "x",TRUE ~ "x"))%>% 
  mutate(tststime1 = case_when(is.na(tststime1) ~ "x",TRUE ~ "x"))


faerrorsit1_2_3 <- full_join(faerrorsit1_2,faerror3.sit,by = intersect(names(faerrorsit1_2), names(faerror3.sit)))




# check if a reason for test not completed was marked off


fadata.sit7 <- fadata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(is.na(tstsnonreasonyn))

faerror4.sit <- fadata.sit7 %>% 
  select(record_id,redcap_event_name,tstsnonreasonyn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnonreasonyn = case_when(is.na(tstsnonreasonyn) ~ "x")) # recode NA to missing or leave as is




faerrorsit1_2_3_4 <- full_join(faerrorsit1_2_3,faerror4.sit,by = intersect(names(faerrorsit1_2_3), names(faerror4.sit)))





#check if test was not completed but was Initiated, and the number of reps completed (n/5) were not specified)
fadata.sit8 <- fadata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(tstsnonreasonyn == 1) %>% 
  filter(is.na(tstsnumbrepsyn))

faerror5.sit <- fadata.sit8 %>% 
  select(record_id,redcap_event_name,tstsnumbrepsyn)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnumbrepsyn = case_when(is.na(tstsnumbrepsyn) ~ "x")) # recode NA to missing or leave as is

faerrorsit1_2_3_4_5 <- full_join(faerrorsit1_2_3_4,faerror5.sit,by = intersect(names(faerrorsit1_2_3_4), names(faerror5.sit)))




# check for records with missing values for any assistance if test was completed

faerror6.sit <- fadata.sit1 %>% 
  filter(tstscompleteyn == 1) %>% 
  filter(is.na(tstsassistyn)) %>% 
  select(record_id,redcap_event_name,tstsassistyn)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsassistyn = case_when(is.na(tstsassistyn) ~ "x",TRUE ~ "x")) # recode NA to missing or leave as is

faerrorsit1_2_3_4_5_6 <- full_join(faerrorsit1_2_3_4_5,faerror6.sit,by = intersect(names(faerrorsit1_2_3_4_5), names(faerror6.sit)))




# check for records with 0 for type of assistance if walk any assistance was checked off

faerror7.sit <- fadata.sit1 %>% 
  filter(tstsassistyn == 1) %>% 
  filter(tstsassist_1___1 == 0 & tstsassist_2___1 == 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(type_of_tsts_assistance_not_checked = case_when(tstsassist_1___1 == "0" & tstsassist_2___1 == "0"  ~ "x")) %>% 
  select(record_id,redcap_event_name,type_of_tsts_assistance_not_checked)

faerrorsit1_2_3_4_5_6_7 <- full_join(faerrorsit1_2_3_4_5_6,faerror7.sit,by = intersect(names(faerrorsit1_2_3_4_5_6), names(faerror7.sit)))

faerrorsit1_2_3_4_5_6_7_bp <- full_join(faerrorsit1_2_3_4_5_6_7,faerror.bp,by = intersect(names(faerrorsit1_2_3_4_5_6_7), names(faerror.bp)))


# c0nvert record ids to as.character
# 
# #10min walk test faerrors
# faerror1$record_id <- as.character(faerror1$record_id)
# faerror2$record_id <- as.character(faerror2$record_id)
# faerror3$record_id <- as.character(faerror3$record_id)
# faerror4$record_id <- as.character(faerror4$record_id)
# faerror5$record_id <- as.character(faerror5$record_id)
# faerror6$record_id <- as.character(faerror6$record_id)
# 
# #tsts test
# faerror1.sit$record_id <- as.character(faerror1.sit$record_id)
# faerror2.sit$record_id <- as.character(faerror2.sit$record_id)
# faerror3.sit$record_id <- as.character(faerror3.sit$record_id)
# faerror4.sit$record_id <- as.character(faerror4.sit$record_id)
# faerror5.sit$record_id <- as.character(faerror5.sit$record_id)
# faerror6.sit$record_id <- as.character(faerror6.sit$record_id)
# faerror7.sit$record_id <- as.character(faerror7.sit$record_id)
# faerror.bp$record_id <- as.character(faerror.bp$record_id)


list.func <- full_join(faerror1,faerror2,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror3,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror4,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror5,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror6,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror1.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror2.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror3.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror4.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror5.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror6.sit,by=c("record_id","redcap_event_name"))%>% 
  full_join(.,faerror7.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,faerror.bp,by=c("record_id","redcap_event_name")) 





#fetch notes, for app we dont need notes bit need DAG

fanotes.walk <- fafunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


fanotes.tsts <- fafunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)










# create table for walk test

fawalk <- faerror1_2_3_4_5_6 %>% 
  as_tibble() %>% 
  mutate_all(as.character)







#create table for tsts test

fatsts <- faerrorsit1_2_3_4_5_6_7_bp %>% 
  as_tibble() %>% 
  mutate_all(as.character)







#ensure each combination of ID and redcap event has one row with all values and is not duplicated


fawalk[fawalk== ""] <- NA
fawalk1 <- fawalk  %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)







# now add notes
#walk with notes

fawalk1_notes <- left_join(fawalk1,fanotes.walk,by=c("record_id","redcap_event_name"))







#ensure each combination of ID and redcap event has one row with all values and is not duplicated

fatsts[] <- lapply(fatsts, as.character)

fatsts[fatsts== ""] <- NA
fatsts1 <- fatsts %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





#tsts with notes
fatsts1[] <- lapply(fatsts1, as.character)
fanotes.tsts[] <- lapply(fanotes.tsts, as.character)

fatsts_notes <- left_join(fatsts1,fanotes.tsts,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





#create final table

fatsts_notes[] <- lapply(fatsts_notes, as.character)
fawalk1_notes[] <- lapply(fawalk1_notes, as.character)

fafunc_table <- full_join(fawalk1_notes,fatsts_notes,by = intersect(names(fawalk1_notes), names(fatsts_notes))) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

fafunc_table[fafunc_table== ""] <- NA
fafunc_table <-  fafunc_table %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)  %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(func_complete = 0) %>% # added new step here
  as_tibble() %>% 
  mutate_all(as.character)


# recode 0,1 ie incomplete/unverified to 2
func_all <- fafunc %>% 
  filter(functional_testing_complete == 0 |functional_testing_complete == 1) %>% 
  mutate(func_complete = case_when(functional_testing_complete == 0 |functional_testing_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,func_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




fafunc_table[] <- lapply(fafunc_table, as.character)
func_all[] <- lapply(func_all, as.character)

#merge all
error_func_all <- full_join(fafunc_table,func_all,by = intersect(names(fafunc_table), names(func_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 






# recode NAs to 8 in the original dataset, select DAG as well
data_func_all <- fafunc %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(functional_testing_complete = case_when(is.na(functional_testing_complete) ~ "8", TRUE ~ as.character(functional_testing_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,functional_testing_complete) 


table(data_func_all$functional_testing_complete,exclude = NULL)




#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

error_func_all[error_func_all== ""] <- NA


error_func_all <- error_func_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# func_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_func <- full_join(error_func_all,data_func_all,by = intersect(names(error_func_all), names(data_func_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(func_complete = case_when( functional_testing_complete == "8" ~ "8", TRUE ~ as.character(func_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-functional_testing_complete)




table(full_func$func_complete,exclude = NULL) 





# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
dat.func <- full_func %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Functional") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "func_complete") %>% 
  
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "Functional") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.func = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





data_func_wide <- dat.func %>%
  pivot_wider (names_from = dataset,values_from = error) 

table(data_func_wide$b.func) 
table(fafunc$functional_testing_complete, exclude = NULL)




#blood draw
#Read Data







#Read Data

#Read Data

#Read Data

badata_blood<- data







# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)



badata_blood1 <- badata_blood   %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1 == 0 & blood_sample_collection_and_processing_crf_complete == 2)






# format time
badata_blood1$bscp_time_blood_draw <- ymd_hms(badata_blood1$bscp_time_blood_draw)

badata_blood1$bscp_time_centrifuge <- ymd_hms(badata_blood1$bscp_time_centrifuge)

badata_blood1$bscp_aliquot_freezer_time <- ymd_hms(badata_blood1$bscp_aliquot_freezer_time)



#check if blood draw time < centri time < freezer time 
badata_blood2 <- badata_blood1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) 



baflagblood1 <- badata_blood2 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  mutate(blood_draw_time = case_when(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time ~ "x")) %>% 
  select(record_id,redcap_event_name,blood_draw_time) 




#missing info on hours since last drink

baflagblood6 <- badata_blood1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "x")) 




baflagblood1_6 <- full_join(baflagblood1,baflagblood6,by = intersect(names(baflagblood1), names(baflagblood6)))



#missing info on hours since last food


baflagblood7 <- badata_blood1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "x")) 







baflagblood1_7 <- full_join(baflagblood1_6,baflagblood7,by = intersect(names(baflagblood1_6), names(baflagblood7)))



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

baflagblood8 <- badata_blood1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "x"))


baflagblood1_8 <- full_join(baflagblood1_7,baflagblood8,by = intersect(names(baflagblood1_7), names(baflagblood8)))



#missing info on amount of caff
baflagblood9 <- badata_blood1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "x")) 


baflagblood1_9 <- full_join(baflagblood1_8,baflagblood9,by = intersect(names(baflagblood1_8), names(baflagblood9 )))





#missing info on any vacc
baflagblood10 <- badata_blood1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "x")) 

baflagblood1_10 <- full_join(baflagblood1_9,baflagblood10,by = intersect(names(baflagblood1_9), names(baflagblood10)))






# if level of hemolysis was not entered

baflagblood11 <- badata_blood1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



baflagblood1_11<- full_join(baflagblood1_10,baflagblood11,by = intersect(names(baflagblood1_10), names(baflagblood11)))





# if centrifuge time entered but freezing time not entered

baflagblood14.1 <- badata_blood1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_aliquot_freezer_time)





#baflagblood1_13$bscp_aliquot_freezer_time <- as.character(flag1_13$bscp_aliquot_freezer_time)



baflagblood1_14.1<- full_join(baflagblood1_11,baflagblood14.1,by = intersect(names(baflagblood1_11), names(baflagblood14.1))) 




# if centrifuge time entered but degree of hemolysis  not entered

baflagblood14.2 <- badata_blood1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)




baflagblood1_14.2<- full_join(baflagblood1_14.1,baflagblood14.2,by = intersect(names(baflagblood1_14.1), names(baflagblood14.2))) 




# if centrifuge time not entered but degree of hemolysis entered

baflagblood14.3 <- badata_blood1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge)







baflagblood1_14<- full_join(baflagblood1_14.2,baflagblood14.3,by = intersect(names(baflagblood1_14.2), names(baflagblood14.3))) 


#fetch notes with dag
ba.notes.blood <- badata_blood %>% 
  select(record_id,redcap_event_name, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




baflagblood_notes <- left_join(baflagblood1_14,ba.notes.blood,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) 



bablood_table<- baflagblood_notes %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name", "redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)   %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(bld_complete = 0) %>% # added new step here
  as_tibble() %>% 
  mutate_all(as.character)





# recode 0,1 ie incomplete/unverified to 2
bld_all <- badata_blood %>% 
  filter(blood_sample_collection_and_processing_crf_complete == 0 |blood_sample_collection_and_processing_crf_complete == 1) %>% 
  mutate(bld_complete = case_when(blood_sample_collection_and_processing_crf_complete == 0 |blood_sample_collection_and_processing_crf_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,bld_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



bablood_table[] <- lapply(bablood_table, as.character)
bld_all[] <- lapply(bld_all, as.character)




#merge all
error_bld_all <- full_join(bablood_table,bld_all,by = intersect(names(bablood_table), names(bld_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 




# recode NAs to 8 in the original dataset, select DAG as well
data_bld_all <- badata_blood %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(blood_sample_collection_and_processing_crf_complete= case_when(is.na(blood_sample_collection_and_processing_crf_complete) ~ "8", TRUE ~ as.character(blood_sample_collection_and_processing_crf_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,blood_sample_collection_and_processing_crf_complete) 


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

error_bld_all[error_bld_all== ""] <- NA


error_bld_all <- error_bld_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# imaging_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_bld <- full_join(error_bld_all,data_bld_all,by = intersect(names(error_bld_all), names(data_bld_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  %>% 
  mutate(bld_complete = case_when(blood_sample_collection_and_processing_crf_complete == "8" ~ "8", TRUE ~ as.character(bld_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-blood_sample_collection_and_processing_crf_complete)


dat.blood <- full_bld %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BloodDraw") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "bld_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "BloodDraw") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.blood = case_when(error == "clean" ~ 1,
                             error == 2 ~ 2,
                             error == 8 ~ 8,
                             TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))




data_blood_wide <- dat.blood %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(data_blood_wide$b.blood)



#imaging
#Read Data



#Read Data
iaimaging <-  data






#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

iadf.complete <- iaimaging%>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc1_v09_complete == 2)







#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure




iaerror1a <-iadf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffcpyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) &  fmricuffcontrayn != 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffleg) %>%  
  mutate(fmricuffleg=replace_na("x")) 



iaerror1b <-iadf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffcpyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffcpyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "x")) 


iaerror1 <- full_join(iaerror1a,iaerror1b,by = intersect(names(iaerror1a), names(iaerror1b)))





# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

iaerror2 <- iadf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,redcap_event_name,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "x",TRUE ~ "x")) 



# merge error1 and 2 



iaerror1_2 <- full_join(iaerror1,iaerror2,by = intersect(names(iaerror1), names(iaerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

iaerror3 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricufft1yn,fmricufft1techrating,fmricufft1repeated,fmricufft1repeated,fmricufft1techrating2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated==1  ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricufft1techrating,fmricufft1techrating2) 



iaerror1_2_3 <- full_join(iaerror1_2,iaerror3,by = intersect(names(iaerror1_2), names(iaerror3)))






#before fiast resting state

# Check if fiast resting-state scan performed and there was mismatch between entries for surgical site pain

iaerror4.1 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "x",TRUE ~ "X")) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,fmricuffrestpainss,fmricuffrestpainss2) 


# Check if fiast resting-state scan performed and there was a mismatch between entries overall body pain

iaerror4.2 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | ( fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,fmricuffrestpainovrall, fmricuffrestpainovrall2) 

iaerror4 <- full_join(iaerror4.1,iaerror4.2,by = intersect(names(iaerror4.1), names(iaerror4.2)))


iaerror1_2_3_4 <- full_join(iaerror1_2_3,iaerror4,by = intersect(names(iaerror1_2_3), names(iaerror4)))




# After fiast resting fMRI scan:

# Check if fiast resting-state scan performed and there was mismatch between entries for surgical site pain

iaerror5.1 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "x",TRUE ~ "x"))

# Check  if fiast resting-state scan and there was mismatch between entries for overall body pain

iaerror5.2 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "x",TRUE ~ "x"))


iaerror5.a <- full_join(iaerror5.1,iaerror5.2,by = intersect(names(iaerror5.1), names(iaerror5.2)))


# Check if individualized and standard performed but baseline was missing after fiast resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
iaerror5.bb <- iadf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffcpyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancp - fmricuffcurrpainaftfirstscancp2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscancp,fmricuffcurrpainaftfirstscancp2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancp = case_when(is.na(fmricuffcurrpainaftfirstscancp) ~ "x",TRUE ~ "x")) %>%
  mutate(fmricuffcurrpainaftfirstscancp2 = case_when(is.na(fmricuffcurrpainaftfirstscancp2) ~ "x",TRUE ~ "x"))

iaerror1_2_3_4_5a <- full_join(iaerror1_2_3_4,iaerror5.a,by=intersect(names(iaerror1_2_3_4), names(iaerror5.a)))


iaerror1_2_3_4_5 <- full_join(iaerror1_2_3_4_5a,iaerror5.bb,by=intersect(names(iaerror1_2_3_4_5a), names(iaerror5.bb)))





# After fiast cuff fMRI scan

# check if fiast cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

iaerror6.1 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainbegin, fmricuffpainbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~"x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "x",TRUE ~ "x"))
# check if fiast cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

iaerror6.2 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainmid,fmricuffpainmid2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "x",TRUE ~ "x")) 
# check if fiast cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

iaerror6.3 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainend,fmricuffpainend2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "x",TRUE ~ "x")) 
#create final set



iaerror6a <- full_join(iaerror6.1,iaerror6.2,by=intersect(names(iaerror6.1), names(iaerror6.2)))

iaerror6 <- full_join(iaerror6a,iaerror6.3,by=intersect(names(iaerror6a), names(iaerror6.3)))

iaerror1_2_3_4_5_6 <- full_join(iaerror1_2_3_4_5,iaerror6,by=intersect(names(iaerror1_2_3_4_5), names(iaerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

iaerror7.1 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpbegin, fmricuffpaincpbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "x",TRUE ~ "x")) 
# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

iaerror7.2 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpmid,fmricuffpaincpmid2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "x",TRUE ~ "x")) 
# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

iaerror7.3 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpend,fmricuffpaincpend2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "x",TRUE ~ "x"))
#create final set

iaerror7a <- full_join(iaerror7.1,iaerror7.2,by=intersect(names(iaerror7.1), names(iaerror7.2))) 

iaerror7 <- full_join(iaerror7.3,iaerror7a,by=intersect(names(iaerror7.3), names(iaerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
iaerror8.1 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "x",TRUE ~ "x"))


iaerror8.2 <- iadf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanmid,fmricuffpainrestscanmid2) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "x",TRUE ~ "x"))

iaerror8.3 <- iadf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanend,fmricuffpainrestscanend2) %>% 
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "x",TRUE ~ "x")) 

#create full iaerror8


iaerror8a1 <- full_join(iaerror8.1,iaerror8.2,by=intersect(names(iaerror8.1), names(iaerror8.2))) 

iaerror8a <- full_join(iaerror8.3,iaerror8a1,by=intersect(names(iaerror8.3), names(iaerror8a1))) 

#merge 7 and 8a 

iaerror7_8a <- full_join(iaerror7,iaerror8a,by=intersect(names(iaerror7), names(iaerror8a)))







#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
iaerror8.4 <- iadf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~"x",TRUE ~ "x"))
#"Body pain (double entry)"

iaerror8.5 <- iadf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "x",TRUE ~ "x"))  


iaerror8b<- full_join(iaerror8.4,iaerror8.5,by=intersect(names(iaerror8.4), names(iaerror8.5)))



#merge 7_8a and 8b

iaerror7_8a_8b <- full_join(iaerror7_8a,iaerror8b,by=intersect(names(iaerror7_8a), names(iaerror8b)))



#merge all

iaerror1_2_3_4_5_6_7_8 <- full_join(iaerror1_2_3_4_5_6,iaerror7_8a_8b,by=intersect(names(iaerror1_2_3_4_5_6), names(iaerror7_8a_8b)))






#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

iaerror9.1 <- iaimaging %>% 
  filter((imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffdicuploaded= case_when(is.na(fmricuffdicuploaded) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricuffdicuploaded)




#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
iaerror9.2 <- iaimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcompletescl = case_when(is.na(fmricuffcompletescl) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl) 
#merge 9.1 and 9.2 

iaerror9.a <- full_join(iaerror9.1,iaerror9.2,by=intersect(names(iaerror9.1), names(iaerror9.2))) 



# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

iaerror9.b <- iaimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffcpyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "x",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc1_v09_complete,fmricuffcompletescl,fmri_face_mask) %>% 
  left_join(.,m1result_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(record_id,redcap_event_name,fmri_face_mask) 



iaerror9 <- full_join(iaerror9.a,iaerror9.b,by=intersect(names(iaerror9.a), names(iaerror9.b))) 


#merge all plus error 9

iaerror1_2_3_4_5_6_7_8_9 <- full_join(iaerror1_2_3_4_5_6_7_8,iaerror9,by=intersect(names(iaerror1_2_3_4_5_6_7_8), names(iaerror9)))



#fetch notes wit dag
ianotes.imaging <- iaimaging %>% 
  select(record_id,redcap_event_name, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




iaerror1_2_3_4_5_6_7_8_notes <- left_join(iaerror1_2_3_4_5_6_7_8_9,ianotes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


names(iaimaging)
iaimage_table<- iaerror1_2_3_4_5_6_7_8_notes %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name", "redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)   %>% 
  replace(is.na(.), "1") %>% 
  
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(img_complete = 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(iaimage_table$img_complete)


# compare line by line with qst from here
# recode 0,1 ie incomplete/unverified to 2
img_all <- iaimaging %>% 
  filter(imaging_mcc1_v09_complete  == 0 |imaging_mcc1_v09_complete  == 1) %>% 
  mutate(img_complete = case_when(imaging_mcc1_v09_complete == 0 |imaging_mcc1_v09_complete == 1 ~ 2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,img_complete,redcap_data_access_group)



iaimage_table[] <- lapply(iaimage_table, as.character)
img_all[] <- lapply(img_all, as.character)

#merge all
error_img_all <- full_join(iaimage_table,img_all,by = intersect(names(iaimage_table), names(img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 



# recode NAs to 8 in the original dataset, select DAG as well
data_img_all <- iaimaging %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(imaging_mcc1_v09_complete= case_when(is.na(imaging_mcc1_v09_complete) ~ "8", TRUE ~ as.character(imaging_mcc1_v09_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,imaging_mcc1_v09_complete) 


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

error_img_all[error_img_all== ""] <- NA


error_img_all <- error_img_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# imaging_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_img <- full_join(error_img_all,data_img_all,by = intersect(names(error_img_all), names(data_img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(img_complete = case_when(imaging_mcc1_v09_complete == "8" ~ "8", TRUE ~ as.character(img_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-imaging_mcc1_v09_complete)










dat.image <- full_img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Imaging") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "img_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "Imaging") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(b.img = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


data_imaging_wide <- dat.image %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(data$imaging_mcc1_v09_complete)
table(data_imaging_wide$b.img)


### QST###



#fetch imaging data to link with QST
tadata.image <- data





# Ask hablar to guess most appropriate datatype
data.qst <- data






#explore variables

#pptcompleteyn

#Check for subjects who did not complete ppt.
table(data.qst$pptcompleteyn, exclude = NULL)

#Check for subjects who did not complete the test.
table(data.qst$qst_mcc1_v03_complete, exclude = NULL)




#PPTs


#keep records with complete qst test and  ppt test.
data.qst2 <-data.qst %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(pptcompleteyn ==2 |pptcompleteyn ==  1 | pptcompleteyn == 3)




#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):

tabyl(data.qst2,pptcompleteyn,show_na= TRUE)







#check location of index site entered if test completed (both sites =1 OR 3 = Index site (med/lat joint line) )

q2error1 <- data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  filter(is.na(pptpainlocation)) %>% 
  select(record_id,redcap_event_name,pptpainlocation) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptpainlocation = case_when(is.na(pptpainlocation) ~ "x"))






#Remote site (contralateral deltoid):
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral deltoid:

#rep1
q2error2.1 <-  data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremote1val - pptremote1val1) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote1val = case_when(is.na(pptremote1val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptremote1val1 = case_when(is.na(pptremote1val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote1val1) 

#rep2
q2error2.2 <-  data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremote2val - pptremote2val1) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote2val = case_when(is.na(pptremote2val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptremote2val1 = case_when(is.na(pptremote2val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptremote2val,pptremote2val1) 


#rep3

q2error2.3 <-  data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremote3val - pptremote3val1) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote3val = case_when(is.na(pptremote3val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptremote3val1 = case_when(is.na(pptremote3val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptremote3val,pptremote3val1)




q2error2a <-  full_join(q2error2.1,q2error2.2,by = intersect(names(q2error2.1), names(q2error2.2))) 

q2error2 <-  full_join(q2error2a,q2error2.3,by = intersect(names(q2error2a), names(q2error2.3))) 




#merge error1 and 2


q2error1_2 <- full_join(q2error1,q2error2,by = intersect(names(q2error1), names(q2error2)))






#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site (med/lat joint line)::

#rep1
q2error3.1 <-   data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff1 = pptindex1val - pptindex1val1) %>% 
  filter(ppt_index_diff1 != 0 | is.na(ppt_index_diff1)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex1val = case_when(is.na(pptindex1val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptindex1val1 = case_when(is.na(pptindex1val1) ~ "x",TRUE ~ "x")) %>%
  select(record_id,redcap_event_name,pptindex1val,pptindex1val1) 

#rep2
q2error3.2 <-   data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff2 = pptindex2val - pptindex2val1) %>% 
  filter(ppt_index_diff2 != 0 | is.na(ppt_index_diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex2val = case_when(is.na(pptindex2val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptindex2val1 = case_when(is.na(pptindex2val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptindex2val,pptindex2val1) 

#rep3

q2error3.3 <-   data.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff3 = pptindex3val - pptindex3val1) %>% 
  filter(ppt_index_diff3 != 0 | is.na(ppt_index_diff3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex3val = case_when(is.na(pptindex3val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptindex3val1 = case_when(is.na(pptindex3val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptindex3val,pptindex3val1) 


q2error3a1 <-  full_join(q2error3.1,q2error3.2,by = intersect(names(q2error3.1), names(q2error3.2))) 
q2error3a <-  full_join(q2error3a1,q2error3.3,by = intersect(names(q2error3a1), names(q2error3.3))) 






#merge error1,2 and 3a


q2error1_3 <- full_join(q2error1_2,q2error3a,by = intersect(names(q2error1_2), names(q2error3a))) 




#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 



q2error3b.1 <-  data.qst2 %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindex1val) & !is.na(pptindex1val1))  | (!is.na(pptindex2val)  & !is.na(pptindex2val1)) | (!is.na(pptindex3val)  & !is.na(pptindex3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(as.character(.)))

q2error3b.2 <-  data.qst2 %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindex1val) & is.na(pptindex1val1))  | (is.na(pptindex2val)  & is.na(pptindex2val1)) | (is.na(pptindex3val)  & is.na(pptindex3val1))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


q2error3b.2 <- q2error3b.2 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  ) 



q2error3b.3 <-  data.qst2 %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremote1val) & !is.na(pptremote1val1))  | (!is.na(pptremote2val)  & !is.na(pptremote2val1)) | (!is.na(pptremote3val)  & !is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(as.character(.))) 


q2error3b.4 <-  data.qst2 %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremote1val) & is.na(pptremote1val1))  | (is.na(pptremote2val)  & is.na(pptremote2val1)) | (is.na(pptremote3val)  & is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



q2error3b.4 <-q2error3b.4 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )





#merge error 3
###########
q2error3c <- full_join(q2error3b.1,q2error3b.2,by = intersect(names(q2error3b.1), names(q2error3b.2)))
q2error3d <- full_join(q2error3b.3,q2error3b.4,by = intersect(names(q2error3b.3), names(q2error3b.4)))

###########
q2error3b <- full_join(q2error3c,q2error3d,by = intersect(names(q2error3c), names(q2error3d))) %>% 
  select(c(-index1,-index2,-remote1,-remote2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols = 3:last_col(),
                .fns = ~ ifelse(!is.na(.x) == TRUE, "x", 1)))








# 
q2error1_3[] <- lapply(q2error1_3, as.character)
q2error3b[] <- lapply(q2error3b, as.character)


q2error1_3_3b <- full_join(q2error1_3,q2error3b,by = intersect(names(q2error1_3), names(q2error3b))) 








# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


q2ppt.biomarker <-  data.qst2 %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindex1val,pptindex2val,pptindex3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindex1val,pptindex2val,pptindex3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


q2ppt.biomarker1 <-  data.qst2 %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote2val,pptremote3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


q2ppt.all.biomarker <- full_join(q2ppt.biomarker,q2ppt.biomarker1,by=c("record_id","redcap_event_name"))


q2ppt.all.biomarker[] <- lapply(q2ppt.all.biomarker, as.character)
q2error1_3_3b[] <- lapply(q2error1_3_3b, as.character)

q2error2_3_3b_endpoint <- full_join(q2error1_3_3b,q2ppt.all.biomarker,by = intersect(names(q2error1_3_3b), names(q2ppt.all.biomarker))) 








#ensure each combination of ID and redcap event has one row with all values and is not duplicated

q2error2_3_3b_endpoint [q2error2_3_3b_endpoint == ""] <- NA

q2error2_3_3b_endpoint1 <- q2error2_3_3b_endpoint %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






#Temporal Summation:




#PPTs

# check for missingness in "ts test completed"



#Remove records with missing "ts test completed",# keep record with "tscompleted test completed"

ta.complete <- data.qst %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(tscompleted ==2 |tscompleted ==  1 | tscompleted == 3)










#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
taerror4.1 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsrep1initialpainrem - tsrep1initialpainrem_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainrem = case_when(is.na(tsrep1initialpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep1initialpainrem_d = case_when(is.na(tsrep1initialpainrem_d) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,tscompleted,tsrep1initialpainrem,tsrep1initialpainrem_d) 


#rep1 final
taerror4.2 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsrep1finalpainrem - tsrep1finalpainrem_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainrem = case_when(is.na(tsrep1finalpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep1finalpainrem_d = case_when(is.na(tsrep1finalpainrem_d) ~ "x",TRUE ~ "x")) %>%
  select(record_id,redcap_event_name,tscompleted,tsrep1finalpainrem,tsrep1finalpainrem_d) 


#rep1 set 
tarep1.set <- full_join(taerror4.1,taerror4.2,by = intersect(names(taerror4.1), names(taerror4.2))) 

#rep2 initial

taerror4.3 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsrep2initialpainrem - tsrep2initialpainrem_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(tsrep2initialpainrem = case_when(is.na(tsrep2initialpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep2initialpainrem_d = case_when(is.na(tsrep2initialpainrem_d) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,tscompleted,tsrep2initialpainrem,tsrep2initialpainrem_d)

#rep2 final
taerror4.4 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsrep2finalpainrem - tsrep2finalpainrem_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep2finalpainrem = case_when(is.na(tsrep2finalpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep2finalpainrem_d = case_when(is.na(tsrep2finalpainrem_d) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,tscompleted,tsrep2finalpainrem,tsrep2finalpainrem_d) 

#rep2 set 
tarep2.set <- full_join(taerror4.3,taerror4.4,by = intersect(names(taerror4.3),names(taerror4.4)))


#rep3 initial

taerror4.5 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsinitialpainremsclr3 - tsinitialpainremscl1r3) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainremsclr3 = case_when(is.na(tsinitialpainremsclr3) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsinitialpainremscl1r3 = case_when(is.na(tsinitialpainremscl1r3) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,tscompleted,tsinitialpainremsclr3,tsinitialpainremscl1r3)

#rep3 final
taerror4.6 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsfinalpainremsclr3 - tsfinalpainremscl1r3) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremsclr3 = case_when(is.na(tsfinalpainremsclr3) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsfinalpainremscl1r3 = case_when(is.na(tsfinalpainremscl1r3) ~ "x",TRUE ~ "x" ))%>% 
  select(record_id,redcap_event_name,tscompleted,tsfinalpainremsclr3,tsfinalpainremscl1r3) 

#rep3 set 
tarep3.set <- full_join(taerror4.5,taerror4.6,by = intersect(names(taerror4.5),names(taerror4.6)))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

ta_remote_all_reps1a <- full_join(tarep1.set,tarep2.set,by = intersect(names(tarep1.set),names(tarep2.set)))

ta_remote_all_reps1 <-full_join(ta_remote_all_reps1a,tarep3.set,by = intersect(names(ta_remote_all_reps1a),names(tarep3.set)))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
ta1 <- ta_remote_all_reps1 %>% 
  mutate(tarep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep1initialpainrem))  & (is.na(tsrep1initialpainrem_d))  & (is.na(tsrep1finalpainrem)) & (is.na(tsrep1finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(tarep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep2initialpainrem))  & (is.na(tsrep2initialpainrem_d))  & (is.na(tsrep2finalpainrem)) & (is.na(tsrep2finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(tarep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsinitialpainremsclr3))  & (is.na(tsinitialpainremscl1r3))  & (is.na(tsfinalpainremsclr3)) & (is.na(tsfinalpainremscl1r3))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,"TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3 ))







#index site Index site (med/lat knee)

# check for missing or mismatch in pain ratings for  Index site (med/lat knee) in both site OR  Index site (med/lat knee):

#rep1 initial
taerror6.1 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsrep1initialpainindex - tsrep1initialpainindex_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainindex = case_when(is.na(tsrep1initialpainindex) ~ "x",TRUE ~ "x")) %>%
  mutate(tsrep1initialpainindex_d = case_when(is.na(tsrep1initialpainindex_d) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsrep1initialpainindex,tsrep1initialpainindex_d,tscompleted)

#rep1 final 

taerror6.2 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsrep1finalpainindex - tsrep1finalpainindex_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainindex = case_when(is.na(tsrep1finalpainindex) ~ "x",TRUE ~ "x")) %>%
  mutate(tsrep1finalpainindex_d = case_when(is.na(tsrep1finalpainindex_d) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1finalpainindex_d,tscompleted)



#rep1 set 
tarep1.index.set <- full_join(taerror6.1,taerror6.2,by = intersect(names(taerror6.1),names(taerror6.2)))

#rep2 initial

taerror6.3 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsinitialpainindexsclr2 - tsinitialpainindexscl1r2) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr2 = case_when(is.na(tsinitialpainindexsclr2) ~ "x",TRUE ~ "x"))%>%
  mutate(tsinitialpainindexscl1r2 = case_when(is.na(tsinitialpainindexscl1r2) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tscompleted)


#rep2 final
taerror6.4 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsfinalpainindexsclr2 - tsfinalpainindexscl1r2) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr2 = case_when(is.na(tsfinalpainindexsclr2) ~ "x",TRUE ~ "x"))%>%
  mutate(tsfinalpainindexscl1r2 = case_when(is.na(tsfinalpainindexscl1r2) ~ "x",TRUE ~ "x"))%>%
  select(record_id,redcap_event_name,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tscompleted)


#rep2 set 
tarep2.index.set <- full_join(taerror6.3,taerror6.4,by = intersect(names(taerror6.3),names(taerror6.4)))


#rep3 initial

taerror6.5 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsinitialpainindexsclr3 - tsinitialpainindexscl1r3) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr3 = case_when(is.na(tsinitialpainindexsclr3) ~ "x",TRUE ~ "x"))%>%
  mutate(tsinitialpainindexscl1r3 = case_when(is.na(tsinitialpainindexscl1r3) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tscompleted) 

#rep3 final
taerror6.6 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsfinalpainindexsclr3 - tsfinalpainindexscl1r3) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr3 = case_when(is.na(tsfinalpainindexsclr3) ~ "x",TRUE ~ "x"))%>%
  mutate(tsfinalpainindexscl1r3 = case_when(is.na(tsfinalpainindexscl1r3) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,tsfinalpainindexsclr3,tsfinalpainindexscl1r3,tscompleted) 

#rep3 set 
tarep3.index.set <- full_join(taerror6.5,taerror6.6,by = intersect(names(taerror6.5),names(taerror6.6)))

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
ta_index_all_reps1s <- full_join(tarep1.index.set,tarep2.index.set,by = intersect(names(tarep1.index.set),names(tarep2.index.set)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


ta_index_all_reps1 <- full_join(ta_index_all_reps1s,tarep3.index.set,by = intersect(names(ta_index_all_reps1s),names(tarep3.index.set)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0




ta.index1 <- ta_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsrep1initialpainindex))  & (is.na(tsrep1initialpainindex_d))  & (is.na(tsrep1finalpainindex)) & (is.na(tsrep1finalpainindex_d))~ 1,TRUE ~ 0))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



ta.index1 <- ta.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr2))  & (is.na(tsinitialpainindexscl1r2))  & (is.na(tsfinalpainindexsclr2)) & (is.na(tsfinalpainindexscl1r2))~ 1,TRUE ~ 0))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



ta.index1 <- ta.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr3))  & (is.na(tsinitialpainindexscl1r3))  & (is.na(tsfinalpainindexsclr3)) & (is.na(tsfinalpainindexscl1r3))~ 1,TRUE ~ 0))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS index rep3 final(double entry)"= tsfinalpainindexscl1r3))





#if one rep is complete with no mismatch then all.reps.rem == 1 else 0
ta1 <- ta1 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(all.reps.rem = case_when(tarep1 == "0"  & tarep2== "0"  & tarep3== "0"  ~ "x",TRUE ~ "1"))

glimpse(ta1)

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
ta.index1 <- ta.index1 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == "0"  & ind.rep2=="0"  & ind.rep3== "0"  ~ "x",TRUE ~ "1"))
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
tarem.ind <- full_join(ta1,ta.index1,by = intersect(names(ta1),names(ta.index1)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter((tscompleted == "2" & all.reps.rem == "x")| (tscompleted == "3" & all.reps.ind == "x") | (tscompleted == "1" & all.reps.rem == 0 |all.reps.ind == "x" ) )

tarem_index_all_reps <- tarem.ind %>% 
  select(record_id,redcap_event_name,all.reps.rem,all.reps.ind)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("all_TS_remote_missing" = all.reps.rem,"all_TS_index_missing"= all.reps.ind)

glimpse(tarem.ind)





# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

taerror5.1 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts15)) %>% 
  select(record_id,redcap_event_name,tsfinalpainremafts15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremafts15=replace_na("x")) 


# missing after sensation at 30 secs
taerror5.2 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts30)) %>% 
  select(record_id,redcap_event_name,tsfinalpainremafts30)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremafts30=replace_na("x")) 

# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# error5.1[] <- lapply(error5.1, as.character)
# error5.2[] <- lapply(error5.2, as.character)


ta_remote_all_reps_sensations <- full_join(tarem_index_all_reps,taerror5.1,by = c("record_id","redcap_event_name")) %>% 
  full_join(.,taerror5.2,by= c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 









# once TS  Index site (med/lat knee)is completed
# missing after sensation at 15 secs

taerror7.1 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts15)) %>% 
  select(record_id,redcap_event_name,tsfinalpainindafts15)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindafts15=replace_na("x")) 


# missing after sensation at 30 secs
taerror7.2 <-  ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts30)) %>% 
  select(record_id,redcap_event_name,tsfinalpainindafts30) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindafts30=replace_na("x"))





# convert all char for merging
# Ts_remote_all_reps_sensations[] <- lapply(Ts_remote_all_reps_sensations, as.character)
# error7.1[] <- lapply(error7.1, as.character)
# error7.2[] <- lapply(error7.2, as.character)


#merge all
ta_index_remote_all_reps_sensation <- full_join(ta_remote_all_reps_sensations,taerror7.1,by = c("record_id","redcap_event_name")) %>% 
  full_join(.,taerror7.2,by= c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

taerror7.3a <- ta.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsrep1initialpainindex) & !is.na(tsrep1initialpainindex_d))  | (!is.na(tsrep1finalpainindex)  & !is.na(tsrep1finalpainindex_d)) | (!is.na(tsinitialpainindexsclr2)  & !is.na(tsinitialpainindexscl1r2)) | (!is.na(tsfinalpainindexsclr2) & !is.na(tsfinalpainindexscl1r2))  | (!is.na(tsinitialpainindexsclr3)  & !is.na(tsinitialpainindexscl1r3)) | (!is.na(tsfinalpainindexsclr3)  & !is.na(tsfinalpainindexscl1r3))  ~ "x",TRUE ~ "1"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(ts.index1 == "x")  %>% 
  select(record_id,redcap_event_name,ts.index1) %>% 
  rename("mismatch_bw_site_and_datafilled"=ts.index1)




#OR b.if both sites was checked but pain ratings not filled out for the index site 

taerror7.3b <- ta.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsrep1initialpainindex) & is.na(tsrep1initialpainindex_d)  & is.na(tsrep1finalpainindex)  & is.na(tsrep1finalpainindex_d) & is.na(tsinitialpainindexsclr2)  & is.na(tsinitialpainindexscl1r2) & is.na(tsfinalpainindexsclr2) & is.na(tsfinalpainindexscl1r2)  & is.na(tsinitialpainindexsclr3)  & is.na(tsinitialpainindexscl1r3) & is.na(tsfinalpainindexsclr3)  & is.na(tsfinalpainindexscl1r3)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )










# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 


taerror7.4a <- ta.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsrep1initialpainrem) & !is.na(tsrep1initialpainrem_d))  | (!is.na(tsrep1finalpainrem)  & !is.na(tsrep1finalpainrem_d)) | (!is.na(tsrep2initialpainrem)  & !is.na(tsrep2initialpainrem_d)) | (!is.na(tsrep2finalpainrem) & !is.na(tsrep2finalpainrem_d))  | (!is.na(tsinitialpainremsclr3)  & !is.na(tsinitialpainremscl1r3)) | (!is.na(tsfinalpainremsclr3)  & !is.na(tsfinalpainremscl1r3))  ~ "x",TRUE ~ "1"))  %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(ts.remote1 == "x") %>% 
  select(record_id,redcap_event_name,ts.remote1) %>% 
  rename("mismatch_bw_site_and_datafilled"=ts.remote1)


#OR b.if both sites was checked but pain ratings not filled out for the remote site


taerror7.4b <- ta.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsrep1initialpainrem) & is.na(tsrep1initialpainrem_d)  & is.na(tsrep1finalpainrem)  & is.na(tsrep1finalpainrem_d) & is.na(tsrep2initialpainrem)  & is.na(tsrep2initialpainrem_d) & is.na(tsrep2finalpainrem) & is.na(tsrep2finalpainrem_d)  & is.na(tsinitialpainremsclr3)  & is.na(tsinitialpainremscl1r3) & is.na(tsfinalpainremsclr3)  & is.na(tsfinalpainremscl1r3)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )






#merge 7.3a,7.3b,7.4a,7.4b





taerror7.3a[] <- lapply(taerror7.3a, as.character)
taerror7.3b[] <- lapply(taerror7.3b, as.character)
taerror7.4a[] <- lapply(taerror7.4a, as.character)
taerror7.4b[] <- lapply(taerror7.4b, as.character)


tamerged7.3 <- full_join(taerror7.3a,taerror7.3b,by = intersect(names(taerror7.3a), names(taerror7.3b)))
tamerged7.4 <- full_join(taerror7.4a,taerror7.4b,by = intersect(names(taerror7.4a), names(taerror7.4b)))

tamerged7 <- full_join(tamerged7.3,tamerged7.4,by = intersect(names(tamerged7.3), names(tamerged7.4)))






#rename merged7
tamerged7.1 <- tamerged7 




# change  to as.character for merging
ta_index_remote_all_reps_sensation [] <- lapply(ta_index_remote_all_reps_sensation , as.character)
tamerged7.1[] <- lapply(tamerged7.1, as.character)




#merge Ts_index_remote_all_reps_sensation and merged7.1 

tamerge8 <- full_join(tamerged7.1,ta_index_remote_all_reps_sensation ,by = intersect(names(tamerged7.1), names(ta_index_remote_all_reps_sensation ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
taprim.outcome.index <- ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsrep1finalpainindex,tsrep1initialpainindex)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsrep1initialpainindex) %>% 
  mutate(max.rep2.index = pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2)) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsinitialpainindexsclr2) %>% 
  mutate(max.rep3.index = pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsinitialpainindexsclr3) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


taprim.outcome.remote <- ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsrep1initialpainrem,tsrep1finalpainrem)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsrep1initialpainrem) %>% 
  mutate(max.rep2.remote = pmax(tsrep2initialpainrem,tsrep2finalpainrem)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsrep2initialpainrem) %>% 
  mutate(max.rep3.remote = pmax(tsinitialpainremsclr3,tsfinalpainremsclr3)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsinitialpainremsclr3) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


ta_primary_outcome <-  full_join(taprim.outcome.index, taprim.outcome.remote ,by = intersect(names( taprim.outcome.remote), names(taprim.outcome.index )))





# # change  to as.character for merging
tamerge8 [] <- lapply(tamerge8 , as.character)
ta_primary_outcome[] <- lapply(ta_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

ta.all.prim.outcome <- full_join(tamerge8,ta_primary_outcome ,by = intersect(names(tamerge8), names(ta_primary_outcome)))





# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
tasec.outcome.index <- ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsrep1finalpainindex,tsrep1initialpainindex))) %>% 
  mutate(init.rep1.index1 = 1+(tsrep1initialpainindex)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2))) %>% 
  mutate(init.rep2.index1 = 1+(tsinitialpainindexsclr2)) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3))) %>% 
  mutate(init.rep3.index1 = 1+(tsinitialpainindexsclr3)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
tasec.outcome.remote <- ta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsrep1initialpainrem,tsrep1finalpainrem))) %>% 
  mutate(init.rep1.remote1 = 1+(tsrep1initialpainrem)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsrep2initialpainrem,tsrep2finalpainrem))) %>% 
  mutate(init.rep2.remote1 = 1+(tsrep2initialpainrem)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsinitialpainremsclr3,tsfinalpainremsclr3))) %>% 
  mutate(init.rep3.remote1 = 1+(tsinitialpainremsclr3)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )

ta_sec_outcome <-  full_join(tasec.outcome.index, tasec.outcome.remote ,by = intersect(names( tasec.outcome.remote), names(tasec.outcome.index )))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# change  to as.character for merging
ta_sec_outcome [] <- lapply(ta_sec_outcome , as.character)
ta.all.prim.outcome[] <- lapply(ta.all.prim.outcome, as.character)

#merge ts_sec_outcome  with ts.all.prim.outcome

ta.all.prim.sec.outcome <- full_join(ta_sec_outcome ,ta.all.prim.outcome ,by = intersect(names(ta_sec_outcome), names(ta.all.prim.outcome )))



ta.all.prim.sec.outcome <- ta.all.prim.sec.outcome  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#ensure each combination of ID and redcap event has one row with all values and is not duplicated
ta.all.prim.sec.outcome[ta.all.prim.sec.outcome== ""] <- NA


ta.all.prim.sec.outcome <- ta.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#CPM

#


#Remove records with missing "cp test completed"

tadata1cp <- data.qst %>% 
  filter(!is.na(cpmcompleteyn))

#recheck if NAs removed

tabyl(tadata1cp,cpmcompleteyn,show_na= TRUE)

# keep record with "cpm test completed"

tacpm.complete <- tadata1cp %>% 
  filter(cpmcompleteyn != 0 & qst_mcc1_v03_complete == 2)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):

tabyl(tacpm.complete,cpmcompleteyn,show_na= TRUE)






#water temp not checked

tacpm.error1 <- tacpm.complete %>% 
  filter(cpmcoldwatertempc != 1) %>% 
  select(record_id,redcap_event_name,cpmcoldwatertempc) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwatertempc = case_when(cpmcoldwatertempc != 1 ~ "x",TRUE ~ "x"))





# missing or mismatch in cold water pain rating at 30 sec

tacpm.error2 <- tacpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30sscl - cpmcoldwaterpain30sscl1) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain30sscl = case_when(is.na(cpmcoldwaterpain30sscl) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmcoldwaterpain30sscl1 = case_when(is.na(cpmcoldwaterpain30sscl1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmcoldwaterpain30sscl,cpmcoldwaterpain30sscl1) 




# missing or mismatch in cold water pain rating at 60 sec
tacpm.error3 <- tacpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60sscl - cpmcoldwaterpain60sscl1) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain60sscl = case_when(is.na(cpmcoldwaterpain60sscl) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmcoldwaterpain60sscl1 = case_when(is.na(cpmcoldwaterpain60sscl1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmcoldwaterpain60sscl,cpmcoldwaterpain60sscl1) 




#merge error 2&3

ta_sec_outcome <-  full_join(tasec.outcome.index, tasec.outcome.remote ,by = intersect(names( tasec.outcome.remote), names(tasec.outcome.index )))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


taerrorcpm2_3 <- full_join(tacpm.error2,tacpm.error3,by = intersect(names(tacpm.error2), names(tacpm.error3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


##merge error 1 with 2&3
taerrorcpm1_2_3 <- full_join(tacpm.error1,taerrorcpm2_3,by = intersect(names(tacpm.error1), names(taerrorcpm2_3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






#check for missing/mismatch in ppts

tacpm.error4.1 <- tacpm.complete %>% 
  mutate(diff_cpm1 = cpmppt1val - cpmppt1val1) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt1val = case_when(is.na(cpmppt1val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmppt1val1 = case_when(is.na(cpmppt1val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmppt1val,cpmppt1val1) 




#check for missing/mismatch in ppts

tacpm.error4.2 <- tacpm.complete %>% 
  mutate(diff_cpm2 = cpmppt2val - cpmppt2val1) %>% 
  filter(diff_cpm2!=0 | is.na(diff_cpm2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt2val = case_when(is.na(cpmppt2val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmppt2val1 = case_when(is.na(cpmppt2val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmppt2val,cpmppt2val1) 



#check for missing/mismatch in ppts

tacpm.error4.3 <- tacpm.complete %>% 
  mutate(diff_cpm3 = cpmppt3val - cpmppt3val1) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt3val = case_when(is.na(cpmppt3val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmppt3val1 = case_when(is.na(cpmppt3val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmppt3val,cpmppt3val1) 




#merge 4.1-.3

#merge error 2&3

taerror4a <-  full_join(tacpm.error4.1,tacpm.error4.2 ,by = intersect(names( tacpm.error4.1), names(tacpm.error4.2)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


tacpm.error4 <- full_join(taerror4a,tacpm.error4.3,by = intersect(names(taerror4a), names(tacpm.error4.3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





tacpm.final <- full_join(tacpm.error4,taerrorcpm1_2_3,by = intersect(names(tacpm.error4), names(taerrorcpm1_2_3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


tacmp.prim.outcome <- tacpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn,pptcompleteyn,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )










#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


tacmp.sec.outcome <- tacpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn,pptcompleteyn,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


tacmp.outcome <- full_join(tacmp.prim.outcome ,tacmp.sec.outcome ,by = intersect(names(tacmp.prim.outcome), names(tacmp.sec.outcome)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#change  to as.character for merging
tacmp.outcome [] <- lapply(tacmp.outcome , as.character)
tacpm.final[] <- lapply(tacpm.final, as.character)

#merge all cmp errors

taall.cmp <-  full_join(tacmp.outcome ,tacpm.final ,by = intersect(names(tacmp.outcome), names(tacpm.final)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






#ensure each combination of ID and redcap event has one row with all values and is not duplicated

#ensure each combination of ID and redcap event has one row with all values and is not duplicated

taall.cmp[taall.cmp== ""] <- NA

taall.cmp <- taall.cmp%>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#link with imaging data
# label(tadata.image$fmricuffcompletescl)="Test Completed:"
# label(tadata.image$fmricuffcontrarecal)="imaging_Re-calibration of pressure needed:"
# label(tadata.image$fmricuffcalfpressurerecal)="imaging:Pressure 2:"
# label(tadata.image$fmricuffcalfpressurerecal2)="imaging:Pressure 2: (double entry)"
# label(tadata.image$fmricuffipyn)="imaging_fMRI individualized pressure"
# tadata.image$fmricuffcontrarecal.factor = factor(tadata.image$fmricuffcontrarecal,levels=c("1","0"))
# tadata.image$fmricuffcompletescl.factor = factor(tadata.image$fmricuffcompletescl,levels=c("1","2","0"))
# tadata.image$fmricuffipyn.factor = factor(tadata.image$fmricuffipyn,levels=c("1","0"))
# 
# levels(tadata.image$fmricuffcontrarecal.factor)=c("Yes","No")
# 
# 
# levels(tadata.image$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
# levels(tadata.image$fmricuffipyn.factor)=c("Yes","No")
# 


# select needed variables
tadata.image1 <- tadata.image %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcontrarecal,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl,fmricuffipyn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

tadata.qst <- data.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrayn,fmricuffcalfpressure,fmricuffcalfpressure2,qst_mcc1_v03_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




# change  to as.character for merging
tadata.image1 [] <- lapply(tadata.image1 , as.character)
tadata.qst[] <- lapply(tadata.qst, as.character)

#merge both
taqst.image <-  full_join(tadata.image1 ,tadata.qst ,by = intersect(names(tadata.image1), names(tadata.qst))) %>% 
  filter(qst_mcc1_v03_complete == 2)



#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging



taqst.image1 <- taqst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(fmricuffcalfpressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_event_name,redcap_data_access_group,fmricuffipyn,fmricuffcompletescl,fmricuffcontrayn,fmricuffcontrarecal,fmricuffcalfpressure,fmricuffcalfpressure2,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcontrayn = case_when(is.na(fmricuffcontrayn) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffcontrarecal = case_when(is.na(fmricuffcontrarecal) ~ "x",TRUE ~"x" )) %>% 
  mutate(fmricuffcalfpressure = case_when(is.na(fmricuffcalfpressure) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcalfpressure2 = case_when(is.na(fmricuffcalfpressure2) ~ "x",TRUE ~ "x" )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "x",TRUE ~ "x" )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "x",TRUE ~ "x" )) 



#fetch notes

tanotes.ppt <- data.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


tanotes.ts <- data.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


tanotes.cpm <- data.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





##### Data entries from REDCap were checked for errors and the the following IDs and their respective events were flagged:


#ppt with notes
# 
q2error2_3_3b_endpoint1[] <- lapply(q2error2_3_3b_endpoint1, as.character)
tanotes.ppt[] <- lapply(tanotes.ppt, as.character)

q2error2_3_3b_endpoint1_notes <- left_join(q2error2_3_3b_endpoint1,tanotes.ppt,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#TS with notes

ta.all.prim.sec.outcome[] <- lapply(ta.all.prim.sec.outcome, as.character)
tanotes.ts[] <- lapply(tanotes.ts, as.character)


ta.all.prim.sec.outcome_notes <- left_join(ta.all.prim.sec.outcome,tanotes.ts,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#cpm with notes

taall.cmp[] <- lapply(taall.cmp, as.character)
tanotes.cpm[] <- lapply(tanotes.cpm, as.character)


taall.cmp_notes <- left_join(taall.cmp,tanotes.cpm,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






##### **After linking QST data with Imaging data**
#####  The records enlisted below were flagged when checking for one or more than one of the following errors:





taqst_table <- full_join(ta.all.prim.sec.outcome_notes,q2error2_3_3b_endpoint1_notes,by = intersect(names(ta.all.prim.sec.outcome_notes), names(q2error2_3_3b_endpoint1_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


taqst_table1 <- full_join(taqst_table,taall.cmp_notes,by = intersect(names(taqst_table), names(taall.cmp_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



ta_final_image <-  full_join(taqst_table1,taqst.image1,by = intersect(names(taqst_table1), names(taqst.image1))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






ta_final_image [ta_final_image == ""] <- NA


ta_img_table <- ta_final_image %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(qst_complete = 0)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



names(ta_img_table)
# recode 0,1 ie incomplete/unverified to 2
ta.img_all <- data.qst %>% 
  filter(qst_mcc1_v03_complete == 0 |qst_mcc1_v03_complete == 1) %>% 
  mutate(qst_complete = case_when(qst_mcc1_v03_complete == 0 |qst_mcc1_v03_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,qst_complete,redcap_data_access_group)




ta_img_table[] <- lapply(ta_img_table, as.character)
ta.img_all[] <- lapply(ta.img_all, as.character)

#merge all
error_ta_img_all <- full_join(ta_img_table,ta.img_all,by = intersect(names(ta_img_table), names(ta.img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  relocate(qst_complete, .after = redcap_data_access_group)


table(ta.img_all$qst_complete)
table(error_ta_img_all$qst_complete,exclude = FALSE)







# recode NAs to 8 in the original dataset, select DAG as well
data_ta.img_all <- data.qst %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(qst_mcc1_v03_complete = case_when(is.na(qst_mcc1_v03_complete) ~ "8", TRUE ~ as.character(qst_mcc1_v03_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,qst_mcc1_v03_complete) 


table(data_ta.img_all$qst_mcc1_v03_complete,exclude = NULL)




#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

error_ta_img_all[error_ta_img_all== ""] <- NA


error_ta_img_all <- error_ta_img_all%>%
  pivot_longer(cols = 5:last_col(),
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>%
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>%
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group","qst_complete"),
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 







# qst_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
full_ta.img <- full_join(error_ta_img_all,data_ta.img_all,by = intersect(names(error_ta_img_all), names(data_ta.img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(qst_complete = case_when(qst_mcc1_v03_complete == "8" ~ "8", TRUE ~ as.character(qst_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-qst_mcc1_v03_complete) %>% 
  relocate(qst_complete,.after=redcap_data_access_group)

table(error_ta_img_all$qst_complete)

table(full_ta.img$qst_complete,exclude = NULL) 


table(data.qst$qst_mcc1_v03_complete,exclude=NULL)



# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
dat.qst <- full_ta.img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "QST") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "qst_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "QST") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>% #
  mutate(b.qst = case_when(error == "clean" ~ 1,
                           error == 2 ~ 2,
                           error == 8 ~ 8,
                           TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



dat1 <- dat.qst %>% 
  filter(b.qst == 0) %>% 
  select(record_id,redcap_event_name)



data_qst_wide <- dat.qst %>%
  pivot_wider (names_from = dataset,values_from = error) 

table(data_qst_wide$b.qst) 
table(data$qst_mcc1_v03_complete,exclude = NULL)







data_wide1 <- full_join(data_bpi,data_koos,by = intersect(names(data_bpi), names(data_koos))) 

data_wide2 <- full_join(data_wide1,data.anxiety_wide,by = intersect(names(data_wide1), names(data.anxiety_wide))) 


data_wide3 <- full_join(data_wide2,data.dep_wide,by = intersect(names(data_wide2), names(data.dep_wide))) 

data_wide4 <- full_join(data_wide3,data.cat_wide,by = intersect(names(data_wide3), names(data.cat_wide)))



data_wide5 <- full_join(data_wide4,data.move_wide,by = intersect(names(data_wide4), names(data.move_wide))) 
data_wide6 <- full_join(data_wide5,data.sleep_wide,by = intersect(names(data_wide5), names(data.sleep_wide))) 

data_wide7 <- full_join(data_wide6,data.sleep_hours_wide,by = intersect(names(data_wide6), names(data.sleep_hours_wide))) 

data_wide8 <- full_join(data_wide7,data_func_wide,by = intersect(names(data_wide7), names(data_func_wide))) 

data_wide9 <- full_join(data_wide8,data_blood_wide,by = intersect(names(data_wide8), names(data_blood_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood, .after = BloodDraw)



data_wide10 <- full_join(data_wide9,data_imaging_wide,by = intersect(names(data_wide9), names(data_imaging_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img, .after = Imaging)

data_wide11 <- full_join(data_wide10,data_qst_wide,by = intersect(names(data_wide10), names(data_qst_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,b.qst, .after = QST)

data_wide12 <- full_join(data_wide11,data.cog_wide,by = intersect(names(data_wide11), names(data.cog_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,b.qst,b.cog, .after = cognition)

data_wide13 <- full_join(data_wide12,data.res_wide,by = intersect(names(data_wide12), names(data.res_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,b.qst,b.cog,b.res, .after = resilience)

data_wide14 <- full_join(data_wide13,data.social_wide,by = intersect(names(data_wide13), names(data.social_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,b.qst,b.cog,b.res,b.social, .after = social_support)


data_wide15 <- full_join(data_wide14,data.ace_wide,by = intersect(names(data_wide14), names(data.ace_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,
           b.qst,b.cog,b.res,b.social,b.ace,
           .after = ACE)

data_wide16 <- full_join(data_wide15,six.mo_wide,by = intersect(names(data_wide15), names(six.mo_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,
           b.qst,b.cog,b.res,b.social,b.ace,b.traj,
           .after = six_mo_traj)


data_wide17 <- full_join(data_wide16,baseline_traj_wide,by = intersect(names(data_wide16), names(baseline_traj_wide))) %>% 
  relocate(b.bpi,b.koos,b.anxiety,b.dep,b.cat,b.move,b.sleep,b.sleep_hours,b.func,b.blood,b.img,
           b.qst,b.cog,b.res,b.social,b.ace,b.traj,b.base_traj,
           .after = acute_traj)


baseline_traj_wide
#recode data for visit not scheduled from 8 to 7 where 7 is NOT APPLICABLE
data_wide17 <- data_wide17 %>% 
  mutate(b.base_traj = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ as.numeric(b.base_traj) )) %>% #ghis step was already done, repeating here and reformatting to as.numeric to keep data format consistent
  mutate(b.traj = case_when(redcap_event_name != "6mo_postop_arm_1" ~ 7,TRUE ~ as.numeric(b.traj) )) %>% #ghis step was already done, repeating here and reformatting to as.numeric to keep data format consistent
  mutate(b.ace = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ b.ace )) %>% 
  mutate(b.social = case_when(redcap_event_name == "6mo_postop_arm_1" & b.social==8 | redcap_event_name == "12mo_postop_arm_1"  & b.social==8   ~ 7,TRUE ~ b.social )) %>% 
  mutate(b.res = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ b.res )) %>% 
  mutate(b.cog = case_when( redcap_event_name == "12mo_postop_arm_1"  & b.cog==8   ~ 7,TRUE ~ b.cog )) %>% 
  mutate(b.koos = case_when( redcap_event_name == "6wks_postop_arm_1" & b.koos==8 | redcap_event_name == "12mo_postop_arm_1" & b.koos== 8  ~ 7,TRUE ~ b.koos )) %>% 
  mutate(b.anxiety = case_when(redcap_event_name == "12mo_postop_arm_1" & b.anxiety==8   ~ 7,TRUE ~ b.anxiety )) %>% 
  mutate(b.dep = case_when(redcap_event_name == "12mo_postop_arm_1"  & b.dep==8   ~ 7,TRUE ~ b.dep )) %>% 
  mutate(b.bpi=case_when(redcap_event_name == "12mo_postop_arm_1"  & b.bpi==8   ~ 7,TRUE ~ b.bpi )) %>% 
  mutate(b.img = case_when(redcap_event_name == "12mo_postop_arm_1" &  b.img == 8|redcap_event_name == "6mo_postop_arm_1" & b.img == 8|redcap_event_name == "6wks_postop_arm_1" & b.img == 8 ~ 7,TRUE ~ b.img )) %>% 
  mutate(b.cat = case_when(redcap_event_name == "12mo_postop_arm_1" & b.cat == 8|redcap_event_name == "6mo_postop_arm_1" & b.cat == 8 ~ 7,TRUE ~ b.cat )) %>% 
  mutate(b.move = case_when(redcap_event_name == "12mo_postop_arm_1" & b.move == 8|redcap_event_name == "6mo_postop_arm_1" & b.move == 8 ~ 7,TRUE ~ b.move )) %>% 
  mutate(b.sleep = case_when(redcap_event_name == "12mo_postop_arm_1" & b.sleep == 8 ~ 7,TRUE ~ b.sleep ))%>% 
  mutate(b.sleep_hours = case_when(redcap_event_name == "12mo_postop_arm_1" & b.sleep_hours == 8 ~ 7,TRUE ~ b.sleep_hours )) %>% 
  mutate(b.func = case_when(redcap_event_name == "12mo_postop_arm_1" & b.func == 8|redcap_event_name == "6mo_postop_arm_1" & b.func == 8|redcap_event_name == "6wks_postop_arm_1" & b.func == 8 ~ 7,TRUE ~ b.func )) %>% 
  mutate(b.blood = case_when(redcap_event_name == "12mo_postop_arm_1" & b.blood==8|redcap_event_name == "6mo_postop_arm_1" & b.blood == 8 ~ 7,TRUE ~ b.blood )) %>% 
  mutate(b.qst = case_when(redcap_event_name == "12mo_postop_arm_1" & b.qst==8|redcap_event_name == "6mo_postop_arm_1" & b.qst == 8|redcap_event_name == "6wks_postop_arm_1" & b.qst == 8 ~ 7,TRUE ~ b.qst ))






ds_tbl_1 <- data_wide17 %>% 
  select(-BPI,-koos,-Anxiety,-Depression,-Promis_Sleep,-sleep_hours,-Functional,-BloodDraw,-Imaging, -Catastrophizing,
         -Functional,-FearMovement, -QST,-cognition,-resilience,-social_support,-ACE,-six_mo_traj,-acute_traj) %>% 
  rename("BPI" =b.bpi,"koos"=b.koos,"Anxiety"=b.anxiety,"Depression"=b.dep,"Catastrophizing"=b.cat,
         "FearMovement"=b.move,"Promis_Sleep"=b.sleep,"sleep_hours"=b.sleep_hours, "Functional"=b.func,
         "BloodDraw"=b.blood ,"Imaging"=b.img,"QST"= b.qst,"cognition"=b.cog,"resilience"=b.res,"social_support"=b.social,
         "ACE"=b.ace,"six_mo_traj"=b.traj,"acute_traj"=b.base_traj) %>% 
  pivot_longer(cols = BPI : last_col(), 
               names_to = "var",
               values_to = "data_type") %>% 
  mutate(across(everything(), as.factor)) %>% 
  mutate(data_type = factor(data_type, 
                            levels = c(0,1,2,7,8), 
                            labels = c("datacomplete_with_errors", 
                                       "datacomplete_with_no_errors", 
                                       "dataincomplete", 
                                       "dataNot_applicable", 
                                       "datanot_available")))




#pivot wider and recode NA as 9 if no visit yet and 7 if f not applicable, where 1 = complete,0 = complete with errors,2 = incomplete, 7= Not applicable, 8= Not avaialable

data_explore <- data_wide17

table(data_wide17$redcap_event_name,exclude = NULL)

data_explore1 <-  data_explore%>% 
  select(-BPI,-koos,-Anxiety,-Depression,-Promis_Sleep,-sleep_hours,-Functional,-BloodDraw,-Imaging,
         -Catastrophizing, -Functional,-FearMovement,-QST,-cognition,-resilience,-social_support,-ACE,-six_mo_traj,-acute_traj) %>% 
  pivot_wider(names_from = redcap_event_name , values_from = c(b.bpi,b.koos,b.dep,b.anxiety,b.cat,b.move,b.sleep,
                                                               b.sleep_hours,b.func,b.blood,b.img,b.qst,
                                                               b.cog,b.res,b.social,b.ace,b.traj,b.base_traj)) %>% 
  replace_na(list(b.bpi_baseline_visit_arm_1 = 9,b.bpi_6wks_postop_arm_1=9,b.bpi_3mo_postop_arm_1=9,b.bpi_6mo_postop_arm_1=9,b.bpi_12mo_postop_arm_1=7,
                  b.koos_baseline_visit_arm_1 = 9,b.koos_3_days_preop_arm_1=7,b.koos_6wks_postop_arm_1=7,b.koos_3mo_postop_arm_1=9,b.koos_6mo_postop_arm_1=9,b.koos_12mo_postop_arm_1=7,
                  b.anxiety_baseline_visit_arm_1 = 9,b.anxiety_3_days_preop_arm_1=7,b.anxiety_6wks_postop_arm_1=9,b.anxiety_3mo_postop_arm_1=9,b.anxiety_6mo_postop_arm_1=9,b.anxiety_12mo_postop_arm_1=7,
                  b.dep_baseline_visit_arm_1 = 9,b.dep_3_days_preop_arm_1=7,b.dep_6wks_postop_arm_1=9,b.dep_3mo_postop_arm_1=9,b.dep_6mo_postop_arm_1=9,b.dep_12mo_postop_arm_1=7,
                  b.cat_baseline_visit_arm_1 = 9,b.cat_3_days_preop_arm_1=7,b.cat_6wks_postop_arm_1=9,b.cat_3mo_postop_arm_1=9,b.cat_6mo_postop_arm_1=7,b.cat_12mo_postop_arm_1=7,
                  b.move_baseline_visit_arm_1 = 9,b.move_3_days_preop_arm_1=7,b.move_6wks_postop_arm_1=9,b.move_3mo_postop_arm_1=9,b.move_6mo_postop_arm_1=7,b.move_12mo_postop_arm_1=7,
                  b.sleep_baseline_visit_arm_1 = 9,b.sleep_3_days_preop_arm_1=7,b.sleep_6wks_postop_arm_1=9,b.sleep_3mo_postop_arm_1=9,b.sleep_6mo_postop_arm_1=9,b.sleep_12mo_postop_arm_1=7,
                  b.sleep_hours_baseline_visit_arm_1 = 9,b.sleep_hours_3_days_preop_arm_1=7,b.sleep_hours_6wks_postop_arm_1=9,b.sleep_hours_3mo_postop_arm_1=9,b.sleep_hours_6mo_postop_arm_1=9,b.sleep_hours_12mo_postop_arm_1=7,
                  b.func_baseline_visit_arm_1 = 9,b.func_3_days_preop_arm_1=7,b.func_6wks_postop_arm_1=7,b.func_3mo_postop_arm_1=9,b.func_6mo_postop_arm_1=7,b.func_12mo_postop_arm_1=7,
                  b.img_baseline_visit_arm_1 = 9,b.img_3_days_preop_arm_1=7,b.img_6wks_postop_arm_1=7,b.img_3mo_postop_arm_1=9,b.img_6mo_postop_arm_1=7,b.img_12mo_postop_arm_1=7,
                  b.qst_baseline_visit_arm_1 = 9,b.qst_3_days_preop_arm_1=7,b.qst_6wks_postop_arm_1=7,b.qst_3mo_postop_arm_1=9,b.qst_6mo_postop_arm_1=7,b.qst_12mo_postop_arm_1=7,
                  b.blood_baseline_visit_arm_1 = 9,b.blood_3_days_preop_arm_1=7,b.blood_6wks_postop_arm_1=9,b.blood_3mo_postop_arm_1=9,b.blood_6mo_postop_arm_1=7,b.blood_12mo_postop_arm_1=7,
                  b.cog_baseline_visit_arm_1 = 9,b.cog_3_days_preop_arm_1=7,b.cog_6wks_postop_arm_1=9,b.cog_3mo_postop_arm_1=9,b.cog_6mo_postop_arm_1=9,b.cog_12mo_postop_arm_1=7,
                  b.social_baseline_visit_arm_1 = 9,b.social_3_days_preop_arm_1=7,b.social_6wks_postop_arm_1=9,b.social_3mo_postop_arm_1=9,b.social_6mo_postop_arm_1=7,b.social_12mo_postop_arm_1=7,
                  b.res_baseline_visit_arm_1 = 9,b.res_3_days_preop_arm_1=7,b.res_6wks_postop_arm_1=7,b.res_3mo_postop_arm_1=7,b.res_6mo_postop_arm_1=7,b.res_12mo_postop_arm_1=7,
                  b.ace_baseline_visit_arm_1 = 9,b.ace_3_days_preop_arm_1=7,b.ace_6wks_postop_arm_1=7,b.ace_3mo_postop_arm_1=7,b.ace_6mo_postop_arm_1=7,b.ace_12mo_postop_arm_1=7,
                  b.traj_baseline_visit_arm_1 = 7,b.traj_3_days_preop_arm_1=7,b.traj_6wks_postop_arm_1=7,b.traj_3mo_postop_arm_1=7,b.traj_6mo_postop_arm_1=9,b.traj_12mo_postop_arm_1=7,
                  b.base_traj_baseline_visit_arm_1 = 9,b.base_traj_3_days_preop_arm_1=7,b.base_traj_6wks_postop_arm_1=7,b.base_traj_3mo_postop_arm_1=7,b.base_traj_6mo_postop_arm_1=7,b.base_traj_12mo_postop_arm_1=7))


#filter complete records

data_complete<- data_explore1 %>%
  filter(b.bpi_baseline_visit_arm_1 == 1&b.bpi_6wks_postop_arm_1==1 &b.bpi_3mo_postop_arm_1==1 &b.bpi_6mo_postop_arm_1==1 &b.bpi_12mo_postop_arm_1==7 &
           b.koos_baseline_visit_arm_1 == 1 &b.koos_6wks_postop_arm_1==7 &b.koos_3mo_postop_arm_1==1 &b.koos_6mo_postop_arm_1==1 &b.koos_12mo_postop_arm_1==7 &
           b.anxiety_baseline_visit_arm_1 == 1  &b.anxiety_6wks_postop_arm_1==1 &b.anxiety_3mo_postop_arm_1==1 &b.anxiety_6mo_postop_arm_1==1 &b.anxiety_12mo_postop_arm_1==7 &
           b.dep_baseline_visit_arm_1 == 1  &b.dep_6wks_postop_arm_1==1 &b.dep_3mo_postop_arm_1==1 &b.dep_6mo_postop_arm_1==1 &b.dep_12mo_postop_arm_1==7 &
           b.cat_baseline_visit_arm_1 == 1  &b.cat_6wks_postop_arm_1==1 &b.cat_3mo_postop_arm_1==1 &b.cat_6mo_postop_arm_1==7 &b.cat_12mo_postop_arm_1==7 &
           b.move_baseline_visit_arm_1 == 1  &b.move_6wks_postop_arm_1==1 &b.move_3mo_postop_arm_1==1 &b.move_6mo_postop_arm_1==7 &b.move_12mo_postop_arm_1==7 &
           b.sleep_baseline_visit_arm_1 == 1  &b.sleep_6wks_postop_arm_1==1 &b.sleep_3mo_postop_arm_1==1 &b.sleep_6mo_postop_arm_1==1 &b.sleep_12mo_postop_arm_1==7 &
           b.sleep_hours_baseline_visit_arm_1 == 1  &b.sleep_hours_6wks_postop_arm_1==1 &b.sleep_hours_3mo_postop_arm_1==1 &b.sleep_hours_6mo_postop_arm_1==1 &b.sleep_hours_12mo_postop_arm_1==7 &
           b.func_baseline_visit_arm_1 == 1  &b.func_6wks_postop_arm_1==7 &b.func_3mo_postop_arm_1==1 &b.func_6mo_postop_arm_1==7 &b.func_12mo_postop_arm_1==7 &
           b.img_baseline_visit_arm_1 == 1  &b.img_6wks_postop_arm_1==7 &b.img_3mo_postop_arm_1==1 &b.img_6mo_postop_arm_1==7 &b.img_12mo_postop_arm_1==7 &
           b.qst_baseline_visit_arm_1 == 1  &b.qst_6wks_postop_arm_1==7 &b.qst_3mo_postop_arm_1==1 &b.qst_6mo_postop_arm_1==7 &b.qst_12mo_postop_arm_1==7 &
           b.blood_baseline_visit_arm_1 == 1  &b.blood_6wks_postop_arm_1==1 &b.blood_3mo_postop_arm_1==1 &b.blood_6mo_postop_arm_1==7 &b.blood_12mo_postop_arm_1==7&
           b.cog_baseline_visit_arm_1 == 1&b.cog_6wks_postop_arm_1==1&b.cog_3mo_postop_arm_1==1&b.cog_6mo_postop_arm_1==1&b.cog_12mo_postop_arm_1==7&
           b.social_baseline_visit_arm_1 == 1&b.social_6wks_postop_arm_1==1&b.social_3mo_postop_arm_1==1&b.social_6mo_postop_arm_1==7&b.social_12mo_postop_arm_1==7&
           b.res_baseline_visit_arm_1 == 1&b.res_6wks_postop_arm_1==7&b.res_3mo_postop_arm_1==7&b.res_6mo_postop_arm_1==7&b.res_12mo_postop_arm_1==7&
           b.ace_baseline_visit_arm_1 == 1&b.ace_6wks_postop_arm_1==7&b.ace_3mo_postop_arm_1==7&b.ace_6mo_postop_arm_1==7&b.ace_12mo_postop_arm_1==7&
           b.traj_baseline_visit_arm_1 == 7&b.traj_6wks_postop_arm_1==7&b.traj_3mo_postop_arm_1==7&b.traj_6mo_postop_arm_1==1&b.traj_12mo_postop_arm_1==7 &
           b.base_traj_baseline_visit_arm_1 == 1 & b.base_traj_6wks_postop_arm_1==7 & b.base_traj_3mo_postop_arm_1==7&
           b.base_traj_6mo_postop_arm_1==7&b.base_traj_12mo_postop_arm_1==7)


#same code as above with complete records and records with errors as well
data_complete_errors <- data_explore1 %>% 
  filter(
    (b.bpi_baseline_visit_arm_1 == 1 |b.bpi_baseline_visit_arm_1 == 0) &(b.bpi_6wks_postop_arm_1==1 | b.bpi_6wks_postop_arm_1==0) &(b.bpi_3mo_postop_arm_1==1 | b.bpi_3mo_postop_arm_1==0) &
      (b.bpi_6mo_postop_arm_1==1 | b.bpi_6mo_postop_arm_1==0) &b.bpi_12mo_postop_arm_1==7 &
      (b.koos_baseline_visit_arm_1 == 1 | b.koos_baseline_visit_arm_1 == 0)  &b.koos_6wks_postop_arm_1==7 & (b.koos_3mo_postop_arm_1==1|b.koos_3mo_postop_arm_1==0) & 
      (b.koos_6mo_postop_arm_1==1 | b.koos_6mo_postop_arm_1== 0) &b.koos_12mo_postop_arm_1==7 &
      (b.anxiety_baseline_visit_arm_1 == 1 | b.anxiety_baseline_visit_arm_1 == 0)  & (b.anxiety_6wks_postop_arm_1==1|b.anxiety_6wks_postop_arm_1==0) &(b.anxiety_3mo_postop_arm_1==1|
                                                                                                                                                         b.anxiety_3mo_postop_arm_1==0) & (b.anxiety_6mo_postop_arm_1==1|b.anxiety_6mo_postop_arm_1==0) &b.anxiety_12mo_postop_arm_1==7 &
      (b.dep_baseline_visit_arm_1 == 1|b.dep_baseline_visit_arm_1 == 0)  &(b.dep_6wks_postop_arm_1==1|b.dep_6wks_postop_arm_1==0) &(b.dep_3mo_postop_arm_1==1|b.dep_3mo_postop_arm_1==0)
    & (b.dep_6mo_postop_arm_1==1|b.dep_6mo_postop_arm_1==0) &b.dep_12mo_postop_arm_1==7 &
      (b.cat_baseline_visit_arm_1 == 1|b.cat_baseline_visit_arm_1 == 0)  & (b.cat_6wks_postop_arm_1==1|b.cat_6wks_postop_arm_1==0) & (b.cat_3mo_postop_arm_1==1|b.cat_3mo_postop_arm_1==0)
    &b.cat_6mo_postop_arm_1==7 &b.cat_12mo_postop_arm_1==7 &
      (b.move_baseline_visit_arm_1 == 1| b.move_baseline_visit_arm_1 == 0)  & (b.move_6wks_postop_arm_1==1|b.move_6wks_postop_arm_1==0) &(b.move_3mo_postop_arm_1==1|b.move_3mo_postop_arm_1==0)
    &b.move_6mo_postop_arm_1==7 &b.move_12mo_postop_arm_1==7 &
      (b.sleep_baseline_visit_arm_1 == 1|b.sleep_baseline_visit_arm_1 == 0)  &(b.sleep_6wks_postop_arm_1==1|b.sleep_6wks_postop_arm_1==0) &(b.sleep_3mo_postop_arm_1==1|b.sleep_3mo_postop_arm_1==0)
    & (b.sleep_6mo_postop_arm_1==1|b.sleep_6mo_postop_arm_1==0) &b.sleep_12mo_postop_arm_1==7 &
      (b.sleep_hours_baseline_visit_arm_1 == 1|b.sleep_hours_baseline_visit_arm_1 == 0)  &(b.sleep_hours_6wks_postop_arm_1==1|b.sleep_hours_6wks_postop_arm_1==0) &(b.sleep_hours_3mo_postop_arm_1==1|
                                                                                                                                                                      b.sleep_hours_3mo_postop_arm_1==0) & (b.sleep_hours_6mo_postop_arm_1==1|b.sleep_hours_6mo_postop_arm_1==0) &b.sleep_hours_12mo_postop_arm_1==7 &
      (b.func_baseline_visit_arm_1 == 1|b.func_baseline_visit_arm_1 == 0)  &b.func_6wks_postop_arm_1==7 &(b.func_3mo_postop_arm_1==1|b.func_3mo_postop_arm_1==0) &b.func_6mo_postop_arm_1==7 &b.func_12mo_postop_arm_1==7 &
      (b.img_baseline_visit_arm_1 == 1|b.img_baseline_visit_arm_1 == 0)  &b.img_6wks_postop_arm_1==7 &(b.img_3mo_postop_arm_1==1|b.img_3mo_postop_arm_1==0) &b.img_6mo_postop_arm_1==7 &b.img_12mo_postop_arm_1==7 &
      (b.blood_baseline_visit_arm_1 == 1|b.blood_baseline_visit_arm_1 == 0) &(b.blood_6wks_postop_arm_1==1|b.blood_6wks_postop_arm_1==0) & (b.blood_3mo_postop_arm_1==1|b.blood_3mo_postop_arm_1==0)
    & b.blood_6mo_postop_arm_1==7 &b.blood_12mo_postop_arm_1==7 &
      (b.qst_baseline_visit_arm_1 == 1|b.qst_baseline_visit_arm_1 == 0)  &b.qst_6wks_postop_arm_1==7 
    & (b.qst_3mo_postop_arm_1==1|b.qst_3mo_postop_arm_1==0)  &b.qst_12mo_postop_arm_1==7 &
      (b.cog_baseline_visit_arm_1 == 1|b.cog_baseline_visit_arm_1 == 0)  &(b.cog_6wks_postop_arm_1==1|b.cog_6wks_postop_arm_1==0) &(b.cog_3mo_postop_arm_1==1|b.cog_3mo_postop_arm_1==0)
    & (b.cog_6mo_postop_arm_1==1|b.cog_6mo_postop_arm_1==0) &b.cog_12mo_postop_arm_1==7 &
      (b.social_baseline_visit_arm_1 == 1|b.social_baseline_visit_arm_1 == 0)  &(b.social_6wks_postop_arm_1==1|b.social_6wks_postop_arm_1==0) &(b.social_3mo_postop_arm_1==1|b.social_3mo_postop_arm_1==0)
    & b.social_6mo_postop_arm_1== 7 &b.social_12mo_postop_arm_1==7 &
      (b.res_baseline_visit_arm_1 == 1|b.res_baseline_visit_arm_1 == 0)  & b.res_6wks_postop_arm_1==7 & b.res_3mo_postop_arm_1==7 & 
      b.res_6mo_postop_arm_1==7 & b.res_12mo_postop_arm_1==7 &
      (b.ace_baseline_visit_arm_1 == 1|b.ace_baseline_visit_arm_1 == 0)  & b.ace_6wks_postop_arm_1==7 & b.ace_3mo_postop_arm_1==7 & 
      b.ace_6mo_postop_arm_1==7 & b.ace_12mo_postop_arm_1==7 &
      b.traj_baseline_visit_arm_1 == 7&b.traj_6wks_postop_arm_1==7&b.traj_3mo_postop_arm_1==7&b.traj_6mo_postop_arm_1==1&b.traj_12mo_postop_arm_1==7 &
      b.base_traj_baseline_visit_arm_1 == 1 & b.base_traj_6wks_postop_arm_1==7 & b.base_traj_3mo_postop_arm_1==7&
      b.base_traj_6mo_postop_arm_1==7&b.base_traj_12mo_postop_arm_1==7)





#idenitify IDs with complete data

data_complet1 <- data_complete %>% 
  select(record_id,redcap_data_access_group)


#merge ids with data_explore, create error free dataset

comp_tbl <- right_join(data_explore,data_complet1,by = c("record_id","redcap_data_access_group")) %>% 
  add_column(status = "error free streak")


#idenitify IDs in  with errors

data_errrorcomplet1 <- data_complete_errors %>% 
  select(record_id,redcap_data_access_group)


#merge ids with data_explore to create a dataset of ids with errors and id with no errors

comp_error_tbl1 <- right_join(data_explore,data_errrorcomplet1,by = c("record_id","redcap_data_access_group"))

#isolate records with errors by anti join 

comp_error_tbl <- anti_join(comp_error_tbl1,comp_tbl,by = c("record_id","redcap_data_access_group"))  %>% 
  add_column(status = "streak with errors")


# combine comp_erro_tbl and comp_tbl


temp_table <- rbind(comp_tbl,comp_error_tbl)


#extract ids not in temp_table and then add  to temp table vertically

other_tbl <- anti_join(data_explore,temp_table,by = c("record_id","redcap_data_access_group"))  %>% 
  add_column(status = "incomplete streak")



# for datatable
new_tbl <- rbind(temp_table,other_tbl) %>% 
  mutate(across(everything(), as.factor))





# create a dataset for complete records to download for the user

# reformat both datasets for merging

data_original <- data
data_original[] <- lapply(data_original, as.character)
comp_tbl[] <- lapply(comp_tbl, as.character)


comp_dta_tbl <- inner_join(data_original,comp_tbl,by = intersect(names(data_original), names(comp_tbl)))




# create a dataset of IDs with complete baseline biomarker data plus 6 months outcome

data_biomarker <-  data_explore1 %>% 
  
  filter(b.bpi_baseline_visit_arm_1 == 1 &
           b.koos_baseline_visit_arm_1 == 1  &
           b.anxiety_baseline_visit_arm_1 == 1 &
           b.dep_baseline_visit_arm_1 == 1  &
           b.cat_baseline_visit_arm_1 == 1  &
           b.move_baseline_visit_arm_1 == 1  &
           b.sleep_baseline_visit_arm_1 == 1  &
           b.sleep_hours_baseline_visit_arm_1 == 1  &
           b.func_baseline_visit_arm_1 == 1  &
           b.img_baseline_visit_arm_1 == 1  &
           b.qst_baseline_visit_arm_1 == 1  &
           b.blood_baseline_visit_arm_1 == 1  &
           b.cog_baseline_visit_arm_1 == 1&
           b.social_baseline_visit_arm_1 == 1&
           b.res_baseline_visit_arm_1 == 1&
           b.ace_baseline_visit_arm_1 == 1 &
           b.traj_baseline_visit_arm_1 == 7&b.traj_6wks_postop_arm_1==7&b.traj_3mo_postop_arm_1==7&b.traj_6mo_postop_arm_1==1&b.traj_12mo_postop_arm_1==7&
           b.base_traj_baseline_visit_arm_1 == 1 & b.base_traj_6wks_postop_arm_1==7 & b.base_traj_3mo_postop_arm_1==7&
           b.base_traj_6mo_postop_arm_1==7&b.base_traj_12mo_postop_arm_1==7) %>% 
  select(record_id,redcap_data_access_group) 


#merge ids with data_explore, create error free dataset with error free baseline surverys and error free 6 months outcome

comp_tbl_biomarker <- right_join(data_explore,data_biomarker,by = c("record_id","redcap_data_access_group")) %>% 
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  mutate(six_mo_traj = ifelse(six_mo_traj == 7, 1,7)) %>% 
  mutate(b.traj = ifelse(b.traj == 7, 1,7)) %>% 
  add_column(status = "complete without errors") %>% 
  select(-redcap_event_name) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  mutate(status = as.factor(status))




# create a dataset of IDs with complete or with error baseline biomarker data plus 6 months outcome

data_biomarker_errors <-  data_explore1 %>% 
  filter((b.bpi_baseline_visit_arm_1 == 1 |b.bpi_baseline_visit_arm_1 == 0) &
           (b.koos_baseline_visit_arm_1 == 1 | b.koos_baseline_visit_arm_1 == 0)  &
           (b.anxiety_baseline_visit_arm_1 == 1 | b.anxiety_baseline_visit_arm_1 == 0)   &
           (b.dep_baseline_visit_arm_1 == 1|b.dep_baseline_visit_arm_1 == 0) &
           (b.cat_baseline_visit_arm_1 == 1|b.cat_baseline_visit_arm_1 == 0)  & 
           (b.move_baseline_visit_arm_1 == 1| b.move_baseline_visit_arm_1 == 0)  &
           (b.sleep_baseline_visit_arm_1 == 1|b.sleep_baseline_visit_arm_1 == 0)  &
           (b.sleep_hours_baseline_visit_arm_1 == 1|b.sleep_hours_baseline_visit_arm_1 == 0)  &
           (b.func_baseline_visit_arm_1 == 1|b.func_baseline_visit_arm_1 == 0)  &
           (b.img_baseline_visit_arm_1 == 1|b.img_baseline_visit_arm_1 == 0) & 
           (b.blood_baseline_visit_arm_1 == 1|b.blood_baseline_visit_arm_1 == 0) &
           (b.qst_baseline_visit_arm_1 == 1|b.qst_baseline_visit_arm_1 == 0)  & 
           (b.social_baseline_visit_arm_1 == 1|b.social_baseline_visit_arm_1 == 0) &
           (b.cog_baseline_visit_arm_1 == 1|b.cog_baseline_visit_arm_1 == 0)  & 
           (b.res_baseline_visit_arm_1 == 1|b.res_baseline_visit_arm_1 == 0)  & 
           (b.ace_baseline_visit_arm_1 == 1|b.ace_baseline_visit_arm_1 == 0) & 
           (b.traj_baseline_visit_arm_1 == 7&b.traj_6wks_postop_arm_1==7&b.traj_3mo_postop_arm_1==7&b.traj_6mo_postop_arm_1==1&b.traj_12mo_postop_arm_1==7)&
           (b.base_traj_baseline_visit_arm_1 == 1 & b.base_traj_6wks_postop_arm_1==7 & b.base_traj_3mo_postop_arm_1==7&
              b.base_traj_6mo_postop_arm_1==7&b.base_traj_12mo_postop_arm_1==7)) %>% 
  select(record_id,redcap_data_access_group) 


#merge ids with data_explore, create error free dataset with error free baseline surverys and error free 6 months outcome

comp_tbl_biomarker_errors <- right_join(data_explore,data_biomarker_errors,by = c("record_id","redcap_data_access_group")) %>% 
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  mutate(six_mo_traj = ifelse(six_mo_traj == 7, 1,7)) %>% 
  mutate(b.traj = ifelse(b.traj == 7, 1,7)) %>% 
  add_column(status = "complete with and without errors") %>% 
  select(-redcap_event_name)

# creat a final table of data with baseline biomarker + 6 m traj with and without errors


all_tbl_biomarker <- rbind(comp_tbl_biomarker,comp_tbl_biomarker_errors)

# create a table for upset plots with either date with or without error 1/0 and baseline and 6 months data


# create a dataset of IDs with complete or with error baseline biomarker data plus 6 months outcome for upset plots

m1_biomarker_upset <-  data_explore1 %>% 
  filter((b.bpi_baseline_visit_arm_1 == 1 |b.bpi_baseline_visit_arm_1 == 0) &
           (b.koos_baseline_visit_arm_1 == 1 | b.koos_baseline_visit_arm_1 == 0)  &
           (b.anxiety_baseline_visit_arm_1 == 1 | b.anxiety_baseline_visit_arm_1 == 0)   &
           (b.dep_baseline_visit_arm_1 == 1|b.dep_baseline_visit_arm_1 == 0) &
           (b.cat_baseline_visit_arm_1 == 1|b.cat_baseline_visit_arm_1 == 0)  & 
           (b.move_baseline_visit_arm_1 == 1| b.move_baseline_visit_arm_1 == 0)  &
           (b.sleep_baseline_visit_arm_1 == 1|b.sleep_baseline_visit_arm_1 == 0)  &
           (b.sleep_hours_baseline_visit_arm_1 == 1|b.sleep_hours_baseline_visit_arm_1 == 0)  &
           (b.func_baseline_visit_arm_1 == 1|b.func_baseline_visit_arm_1 == 0)  &
           (b.img_baseline_visit_arm_1 == 1|b.img_baseline_visit_arm_1 == 0) & 
           (b.blood_baseline_visit_arm_1 == 1|b.blood_baseline_visit_arm_1 == 0) &
           (b.qst_baseline_visit_arm_1 == 1|b.qst_baseline_visit_arm_1 == 0)  & 
           (b.social_baseline_visit_arm_1 == 1|b.social_baseline_visit_arm_1 == 0) &
           (b.cog_baseline_visit_arm_1 == 1|b.cog_baseline_visit_arm_1 == 0)  & 
           (b.res_baseline_visit_arm_1 == 1|b.res_baseline_visit_arm_1 == 0)  & 
           (b.ace_baseline_visit_arm_1 == 1|b.ace_baseline_visit_arm_1 == 0)) %>% 
  select(record_id,redcap_data_access_group,ends_with("baseline_visit_arm_1"),b.traj_6mo_postop_arm_1,-b.traj_baseline_visit_arm_1) %>% 
  mutate_at(vars(-c(1:2)), ~ifelse(. != 1, 0, .)) %>% 
  rename("BPI"="b.bpi_baseline_visit_arm_1","KOOS"="b.koos_baseline_visit_arm_1","Depression"="b.dep_baseline_visit_arm_1" ,"Anxiety"= "b.anxiety_baseline_visit_arm_1" ,"Catastophizing"="b.cat_baseline_visit_arm_1",       
         "FearMovement"="b.move_baseline_visit_arm_1" ,"Sleep"= "b.sleep_baseline_visit_arm_1" , "Sleep_hours"="b.sleep_hours_baseline_visit_arm_1","Funtional"="b.func_baseline_visit_arm_1","Blood_Draw"="b.blood_baseline_visit_arm_1",      
         "Imaging"="b.img_baseline_visit_arm_1"  ,"QST"= "b.qst_baseline_visit_arm_1"  ,"Cognition" ="b.cog_baseline_visit_arm_1" ,"Resilience"="b.res_baseline_visit_arm_1" ,"Social_Support" ="b.social_baseline_visit_arm_1" ,   
         "ACE"="b.ace_baseline_visit_arm_1"  , "Baseline_Traj" ="b.base_traj_baseline_visit_arm_1","6_months_Traj"="b.traj_6mo_postop_arm_1")



# data wrangling for upset plots
# create an m1 days from sysdate dataframe, with <= 35 days from baseline visit only
m1days_from_sysdate_35baseline <- m1days_from_sysdate %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" & days_from_today >= -35) %>% 
  filter(!record_id %in% result_withdraw)

#create an appendix dataframe for upset plot <= 35days
m1_biomarker_35upset_df <-m1_biomarker_upset%>% 
  right_join(.,m1days_from_sysdate_35baseline, by= "record_id") %>% 
  select(-"6_months_Traj",-last_seen) %>%
  add_column(cohort = "MCC1_TKA") %>% 
  as.data.frame() 

#create a dataframe for upset plot, <= 35 days

m1_biomarker_35upsetplot <- m1_biomarker_upset %>% 
  right_join(.,m1days_from_sysdate_35baseline, by= "record_id") %>% 
  select(-"6_months_Traj",-record_id,-redcap_event_name,- redcap_data_access_group,-days_from_today,-last_seen)

m1_biomarker_35upsetplot<-m1_biomarker_35upsetplot%>%
  filter(rowSums(is.na(m1_biomarker_35upsetplot)) != ncol(m1_biomarker_35upsetplot)) %>% 
  as.data.frame()

# create an m1 days from sysdate dataframe, with ~7 months from baseline visit only
m1days_from_sysdate_7mobaseline <- m1days_from_sysdate %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" & days_from_today <= -220) %>% 
  filter(!record_id %in% result_withdraw)

#create an appendix dataframe for upset plot ~ 7 months from baseline visit
m1_biomarker_7moupset_df <-m1_biomarker_upset%>% 
  right_join(.,m1days_from_sysdate_7mobaseline, by= "record_id") %>% 
  select(-last_seen) %>%
  add_column(cohort = "MCC1_TKA") %>% 
  as.data.frame()

#create a dataframe for upset plot,  ~ 7 months from baseline

m1_biomarker_7moupsetplot <- m1_biomarker_upset %>% 
  right_join(.,m1days_from_sysdate_7mobaseline, by= "record_id") %>% 
  select(-record_id,-redcap_event_name,- redcap_data_access_group,-days_from_today,-last_seen)

m1_biomarker_7moupsetplot<- m1_biomarker_7moupsetplot %>%
  filter(rowSums(is.na(m1_biomarker_7moupsetplot)) != ncol(m1_biomarker_7moupsetplot)) %>% 
  as.data.frame()




##################################
######***MCC2**###################
#################################

#common surveys for mcc1 and mcc2 and forms
# 
# bpi
# promis sleep 
# sleep duration
# GAD
# PHQ
# catastrophizing
# fear avoidance
# resilience
# promis emo support
# promis instrumental support
# misci
# ace
# taps1
# taps2
# opioid use baseline
# opioid use acute
# opioid use longterm
# opioid s/e
# opioid pain control
# opioid misuse
# rapa
# gen sensory sensitivity
# BFI-2-s
# Patient Demographics Full Part 2 v0.3 (Demographics II)
# Patient Demographics Baseline v0.3 (Demographics I)
# Other Pain Treatments v3 (Other Treatments)
# Patient Global Impression of Change 
# Symptom Severity Index v1.0 (SSI)
# Pain Detect Questionnaire (PD-Q)
# PROMIS SF v1.2 - Physical Function 8b for TKA
# Expectation Items v1.2
# Acute Phase Trajectory items v0.5 
# Current Medications
# Imaging Items v0.1
# all onsite visits differ

## DIFFERENT
# Other Medical Surgical Treatments II v0.5
# Postconsent Study Plan MCC2 v0.2
# Knee Injury Osteoarthritis Outcome Score (KOOS-12) for TKA
# Danish Thoracic Surgery Questionnaire v0.2 for thoracic
# Deep Breathing and Coughing v1.0 for thoracic
# Acute Phase Trajectory items v0.1 (6-month Daily) for thoracic
# Daily items 6 mo v0.3 (6-Month Daily) for TKA
# 12-Month Remote Follow-up v2.0 (12-Month Follow-up) different for TKA and thoracic
# onsite visits:
# functional
# QST
# imaging
# blood draw 


#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/







##########REPORTS#######

mcc2data1 <- mcc2data1 %>% 
  filter(!record_id %in% withdrawm2 & !record_id %in% test_records)


# 
# event <- c("baseline_visit_arm_1","6wks_postop_arm_1",	
#            "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")


mcc2data <- mcc2data1


#functional

#Read m2frfunc

m2frfunc <- retype(mcc2data) 


#Setting Labels

label(m2frfunc$record_id)="Record ID"
label(m2frfunc$redcap_event_name)="Event Name"
label(m2frfunc$ftdbcdeepbrthinitscl)="1a. Initial Pain Rating: "
label(m2frfunc$ftdbcdeepbrthinitscl2)="1b. Initial Pain Rating: (double entry)"
label(m2frfunc$ftdbcdeepbrthfinalscl)="2a. Final Pain Rating: "
label(m2frfunc$ftdbcdeepbrthfinalscl2)="2b. Final Pain Rating: (double entry)"
label(m2frfunc$ftdbccoughfinalscl)="3a. Final Pain Rating:"
label(m2frfunc$ftdbccoughfinalscl2)="3b. Final Pain Rating: (double entry)"
label(m2frfunc$ftdbctestcmpltyn)="Test completed:"
label(m2frfunc$ftdbctestcmpltno)="If no, choose one of the following"
label(m2frfunc$ftdbcaddlnotes)="Additional notes"
label(m2frfunc$functional_testing_mcc2_v01_complete)="Complete?"
#Setting Units


#Setting Factors(will create new variable for factors)
m2frfunc$redcap_event_name.factor = factor(m2frfunc$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","6mo_postop_day_8_arm_1","6mo_postop_day_9_arm_1","6mo_postop_day_10_arm_1","6mo_postop_day_11_arm_1","6mo_postop_day_12_arm_1","6mo_postop_day_13_arm_1","6mo_postop_day_14_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m2frfunc$ftdbcdeepbrthinitscl.factor = factor(m2frfunc$ftdbcdeepbrthinitscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2frfunc$ftdbcdeepbrthinitscl2.factor = factor(m2frfunc$ftdbcdeepbrthinitscl2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2frfunc$ftdbcdeepbrthfinalscl.factor = factor(m2frfunc$ftdbcdeepbrthfinalscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2frfunc$ftdbcdeepbrthfinalscl2.factor = factor(m2frfunc$ftdbcdeepbrthfinalscl2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2frfunc$ftdbccoughfinalscl.factor = factor(m2frfunc$ftdbccoughfinalscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2frfunc$ftdbccoughfinalscl2.factor = factor(m2frfunc$ftdbccoughfinalscl2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2frfunc$ftdbctestcmpltyn.factor = factor(m2frfunc$ftdbctestcmpltyn,levels=c("1","0"))
m2frfunc$ftdbctestcmpltno.factor = factor(m2frfunc$ftdbctestcmpltno,levels=c("1","2","3"))
m2frfunc$functional_testing_mcc2_v01_complete.factor = factor(m2frfunc$functional_testing_mcc2_v01_complete,levels=c("0","1","2"))

levels(m2frfunc$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","6-Mo Post-Op Day 8","6-Mo Post-Op Day 9","6-Mo Post-Op Day 10","6-Mo Post-Op Day 11","6-Mo Post-Op Day 12","6-Mo Post-Op Day 13","6-Mo Post-Op Day 14","12-Mo Post-Op","Event Reporting")
levels(m2frfunc$ftdbcdeepbrthinitscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2frfunc$ftdbcdeepbrthinitscl2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2frfunc$ftdbcdeepbrthfinalscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2frfunc$ftdbcdeepbrthfinalscl2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2frfunc$ftdbccoughfinalscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2frfunc$ftdbccoughfinalscl2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2frfunc$ftdbctestcmpltyn.factor)=c("Yes","No")
levels(m2frfunc$ftdbctestcmpltno.factor)=c("Did not attempt either deep breathing or coughing tasks","Did not complete deep breathing portion only","Did not complete coughing portion only")
levels(m2frfunc$functional_testing_mcc2_v01_complete.factor)=c("Incomplete","Unverified","Complete")





#Check for subjects who did not complete the test.
table(m2frfunc$ftdbctestcmpltyn.factor,m2frfunc$ftdbctestcmpltyn, exclude = NULL)




#remove records with missing values for test completed.
m2frfunc2 <- m2frfunc %>% 
  drop_na(ftdbctestcmpltyn)


#Recheck if all records with missing m2frfunc for completed tests were removed.
table(m2frfunc2$ftdbctestcmpltyn, exclude = NULL)






#keep records for subjects who completed the test.
m2frfunc3 <- m2frfunc2 %>% 
  filter(ftdbctestcmpltyn == 1)



#look for discrepancies in the initial pain rating 
m2frfunc4 <- m2frfunc3 %>% 
  mutate(init_pain_diff = ftdbcdeepbrthinitscl - ftdbcdeepbrthinitscl2) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

m2frerror1 <- m2frfunc4 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbcdeepbrthinitscl,ftdbcdeepbrthinitscl2)%>% 
  mutate(ftdbcdeepbrthinitscl = case_when(is.na(ftdbcdeepbrthinitscl) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthinitscl))) %>% 
  mutate(ftdbcdeepbrthinitscl2 = case_when(is.na(ftdbcdeepbrthinitscl2) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthinitscl2) )) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#look for discrepancies between the first and the second final pain rating 
m2frfunc5 <- m2frfunc3 %>% 
  mutate(final_pain_diff = ftdbcdeepbrthfinalscl - ftdbcdeepbrthfinalscl2 ) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff))

m2frerror2 <- m2frfunc5 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbcdeepbrthfinalscl,ftdbcdeepbrthfinalscl2) %>% 
  mutate(ftdbcdeepbrthfinalscl = case_when(is.na(ftdbcdeepbrthfinalscl) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthfinalscl))) %>% 
  mutate(ftdbcdeepbrthfinalscl2 = case_when(is.na(ftdbcdeepbrthfinalscl2) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthfinalscl2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2frerror1_2 <- full_join(m2frerror1,m2frerror2,by = intersect(names(m2frerror1), names(m2frerror2)))





#look for discrepancies between the first and the second cough pain 
m2frfunc6 <- m2frfunc3 %>% 
  mutate(cough_diff = ftdbccoughfinalscl - ftdbccoughfinalscl2) %>% 
  filter(cough_diff != 0 | is.na(cough_diff))

m2frerror3 <- m2frfunc6 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbccoughfinalscl,ftdbccoughfinalscl2)%>%
  mutate(ftdbccoughfinalscl = case_when(is.na(ftdbccoughfinalscl) ~ "missing",TRUE ~ as.character(ftdbccoughfinalscl))) %>% 
  mutate(ftdbccoughfinalscl2 = case_when(is.na(ftdbccoughfinalscl2) ~ "missing",TRUE ~ as.character(ftdbccoughfinalscl2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2frerror1_2_3 <- full_join(m2frerror1_2,m2frerror3,by = intersect(names(m2frerror1_2), names(m2frerror3)))




# if test not completed was the reason checked off, use m2frfunc2 (with completed records) 

m2frerror4 <- m2frfunc2 %>% 
  filter(ftdbctestcmpltyn == 0) %>% 
  filter(is.na(ftdbctestcmpltno)) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbctestcmpltyn.factor,ftdbctestcmpltno) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(ftdbctestcmpltno = case_when(is.na(ftdbctestcmpltno) ~ "missing",TRUE ~ as.character(ftdbctestcmpltno))) # recode NA to missing or leave as is



names(m2frfunc)

m2frerror1_2_3_4 <- full_join(m2frerror1_2_3,m2frerror4,by = intersect(names(m2frerror1_2_3), names(m2frerror4)))



#if test complete is not NA then was the  functional_testing_mcc2_v01_complete.factor complete?

m2frerror5 <- m2frfunc %>% 
  filter(!is.na(ftdbctestcmpltyn)) %>% 
  filter(is.na(functional_testing_mcc2_v01_complete))%>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbctestcmpltyn.factor,functional_testing_mcc2_v01_complete.factor)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2frerror1_5 <- full_join(m2frerror1_2_3_4,m2frerror5,by = intersect(names(m2frerror1_2_3_4), names(m2frerror5)))



# rename variables

m2frerror1_5 <-m2frerror1_5 %>%
  rename("1a. Initial Pain Rating: "=ftdbcdeepbrthinitscl,
         "1b. Initial Pain Rating: (double entry)"=ftdbcdeepbrthinitscl2,
         "2a. Final Pain Rating: "=ftdbcdeepbrthfinalscl,
         "2b. Final Pain Rating: (double entry)"=ftdbcdeepbrthfinalscl2,
         "3a. Final Pain Rating:"=ftdbccoughfinalscl,
         "3b. Final Pain Rating: (double entry)"=ftdbccoughfinalscl2,
         "Test completed:"=ftdbctestcmpltyn.factor,
         "If no, choose one of the following"=ftdbctestcmpltno,
         "Complete?"=functional_testing_mcc2_v01_complete.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(m2frerror1_5)






#fetch notes

notes.cough <- m2frfunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbcaddlnotes) %>% 
  rename("notes"=ftdbcaddlnotes ) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



##### m2frfunc entries from REDCap were checked for m2frerrors and the the following IDs and their respective events were flagged:


##### **Deep Breathing and Coughing**
#####  The records enlisted below were flagged when checking for one or more of the following m2frerrors:



# * Discrepancies between the first and the second initial pain ratings 
# * Discrepancies between the first and the second final pain ratings
# * Discrepancies between the first and the second cough pain
# * If test not completed was the reason checked off
# * If test was completed then was the  functional_testing_mcc2_v01_complete.factor complete?
#   
#   
# 
#   





#ensure each combination of ID and redcap event has one row with all values and is not duplicated

cough1 <- m2frerror1_5  %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)








# now add notes


cough1_notes <- left_join(cough1,notes.cough,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group))%>% 
  left_join(.,m2days_from_sysdate, by=c("record_id","redcap_event_name"))



# MCC2 Imaging

#Read Data
irimagingm2 <- retype(mcc2data)




label(irimagingm2$record_id)="Record ID"
label(irimagingm2$redcap_event_name)="Event Name"
label(irimagingm2$fmricuff_initials)="Investigator initials:"
label(irimagingm2$fmripatientname)="Verify Patient Name (as entered into scanner console):  Patient name: first name: followed by a 5-digit REDCap patient ID; last name: A2CPS Site code: UM for U of MichiganWS for Wayne StateSH for Spectrum Health Visit code: V1 for baseline visitV3 for 3-month visit Example: UM10078V1 (first name) A2CPS (last name) "
label(irimagingm2$fmri_magnet_name)="fMRI Magnet Name:"
label(irimagingm2$fmricuffleg)="Cuff applied to R/L leg: (hint: MCC2: non-dominant leg)"
label(irimagingm2$fmricuffcontrarecal)="Re-calibration of pressure needed:"
label(irimagingm2$fmricuffcalfpressurerecal)="Calf pressure, contralateral calf, Pressure 2: "
label(irimagingm2$fmricuffcalfpressurerecal2)="Calf pressure, contralateral calf, Pressure 2: (double entry) "
label(irimagingm2$fmricufft1techrating)="Please enter technologists quality rating for the T1 scan: "
label(irimagingm2$fmricufft1repeated)="T1 scan repeated?"
label(irimagingm2$fmricufft1techrating2)="Please enter technologists quality rating for the 2nd T1 scan: "
label(irimagingm2$fmricuffrestpainss)="Surgical site pain"
label(irimagingm2$fmricuffrestpainss2)="Surgical site pain (double entry)"
label(irimagingm2$fmricuffrestpainovrall)="Body pain"
label(irimagingm2$fmricuffrestpainovrall2)="Body pain (double entry)"
label(irimagingm2$fmricuffcurrpainaftfirstscanss)="Surgical site"
label(irimagingm2$fmricuffcurrpainaftfirstscanss2)="Surgical site (double entry)"
label(irimagingm2$fmricuffcurrpainaftfirstscanovrall)="Body pain"
label(irimagingm2$fmricuffcurrpainaftfirstscanovrall2)="Body pain (double entry)"
label(irimagingm2$fmricuffcurrpainaftfirstscancuff)="Cuff pain"
label(irimagingm2$fmricuffcurrpainaftfirstscancuff2)="Cuff (double entry)"
label(irimagingm2$fmricuffpainbegin)="cuff pain beginning"
label(irimagingm2$fmricuffpainbegin2)="cuff pain beginning (double entry)"
label(irimagingm2$fmricuffpainmid)="cuff pain middle"
label(irimagingm2$fmricuffpainmid2)="cuff pain middle (double entry)"
label(irimagingm2$fmricuffpainend)="cuff pain end"
label(irimagingm2$fmricuffpainend2)="cuff pain end (double entry)"
label(irimagingm2$fmricuffpaincpbegin)="cuff pain beginning"
label(irimagingm2$fmricuffpaincpbegin2)="cuff pain beginning (double entry)"
label(irimagingm2$fmricuffpaincpmid)="cuff pain middle"
label(irimagingm2$fmricuffpaincpmid2)="cuff pain middle (double entry)"
label(irimagingm2$fmricuffpaincpend)="cuff pain end"
label(irimagingm2$fmricuffpaincpend2)="cuff pain end (double entry)"
label(irimagingm2$fmricuffpainrestscanbegin)="cuff pain beginning"
label(irimagingm2$fmricuffpainrestscanbegin2)="cuff pain beginning (double entry)"
label(irimagingm2$fmricuffpainrestscanmid)="cuff pain middle"
label(irimagingm2$fmricuffpainrestscanmid2)="cuff pain middle (double entry)"
label(irimagingm2$fmricuffpainrestscanend)="cuff pain end"
label(irimagingm2$fmricuffpainrestscanend2)="cuff pain end (double entry)"
label(irimagingm2$fmricuffpainaftlastscanss)="Surgical site pain"
label(irimagingm2$fmricuffpainaftlastscanss2)="Surgical site pain (double entry)"
label(irimagingm2$fmricuffpainaftlastscanany)="Body pain"
label(irimagingm2$fmricuffpainaftlastscanany2)="Body pain (double entry)"
label(irimagingm2$fmricuffcompletescl)="Test Completed:"
label(irimagingm2$fmricufft1yn)="T1"
label(irimagingm2$fmricuffdwiyn)="DWI"
label(irimagingm2$fmricuffrest1yn)="1rst Resting state"
label(irimagingm2$fmricuffipyn)="fMRI individualized pressure"
label(irimagingm2$fmricuffspyn)="fMRI standard pressure"
label(irimagingm2$fmricuffrest2yn)="2nd Resting state"
label(irimagingm2$fmricuffdicuploaded)="Dicom files uploaded to TACC:"
label(irimagingm2$fmricuffdicupdate)="Upload date/time"
label(irimagingm2$fmricuffnotes)="Additional notes for imaging"
label(irimagingm2$imaging_mcc2_v01_complete)="Complete?"
#Setting Units


#Setting Factors(will create new variable for factors)
irimagingm2$redcap_event_name.factor = factor(irimagingm2$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","6mo_postop_day_8_arm_1","6mo_postop_day_9_arm_1","6mo_postop_day_10_arm_1","6mo_postop_day_11_arm_1","6mo_postop_day_12_arm_1","6mo_postop_day_13_arm_1","6mo_postop_day_14_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
irimagingm2$fmri_magnet_name.factor = factor(irimagingm2$fmri_magnet_name,levels=c("1","2"))
irimagingm2$fmricuffleg.factor = factor(irimagingm2$fmricuffleg,levels=c("1","2"))
irimagingm2$fmricuffcontrarecal.factor = factor(irimagingm2$fmricuffcontrarecal,levels=c("1","0"))
irimagingm2$fmricufft1techrating.factor = factor(irimagingm2$fmricufft1techrating,levels=c("3","2","1"))
irimagingm2$fmricufft1repeated.factor = factor(irimagingm2$fmricufft1repeated,levels=c("1","0"))
irimagingm2$fmricufft1techrating2.factor = factor(irimagingm2$fmricufft1techrating2,levels=c("3","2","1"))
irimagingm2$fmricuffrestpainss.factor = factor(irimagingm2$fmricuffrestpainss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffrestpainss2.factor = factor(irimagingm2$fmricuffrestpainss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffrestpainovrall.factor = factor(irimagingm2$fmricuffrestpainovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffrestpainovrall2.factor = factor(irimagingm2$fmricuffrestpainovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcurrpainaftfirstscanss.factor = factor(irimagingm2$fmricuffcurrpainaftfirstscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcurrpainaftfirstscanss2.factor = factor(irimagingm2$fmricuffcurrpainaftfirstscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcurrpainaftfirstscanovrall.factor = factor(irimagingm2$fmricuffcurrpainaftfirstscanovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcurrpainaftfirstscanovrall2.factor = factor(irimagingm2$fmricuffcurrpainaftfirstscanovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcurrpainaftfirstscancuff.factor = factor(irimagingm2$fmricuffcurrpainaftfirstscancuff,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcurrpainaftfirstscancuff2.factor = factor(irimagingm2$fmricuffcurrpainaftfirstscancuff2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainbegin.factor = factor(irimagingm2$fmricuffpainbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainbegin2.factor = factor(irimagingm2$fmricuffpainbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainmid.factor = factor(irimagingm2$fmricuffpainmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainmid2.factor = factor(irimagingm2$fmricuffpainmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainend.factor = factor(irimagingm2$fmricuffpainend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainend2.factor = factor(irimagingm2$fmricuffpainend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpaincpbegin.factor = factor(irimagingm2$fmricuffpaincpbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpaincpbegin2.factor = factor(irimagingm2$fmricuffpaincpbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpaincpmid.factor = factor(irimagingm2$fmricuffpaincpmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpaincpmid2.factor = factor(irimagingm2$fmricuffpaincpmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpaincpend.factor = factor(irimagingm2$fmricuffpaincpend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpaincpend2.factor = factor(irimagingm2$fmricuffpaincpend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainrestscanbegin.factor = factor(irimagingm2$fmricuffpainrestscanbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainrestscanbegin2.factor = factor(irimagingm2$fmricuffpainrestscanbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainrestscanmid.factor = factor(irimagingm2$fmricuffpainrestscanmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainrestscanmid2.factor = factor(irimagingm2$fmricuffpainrestscanmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainrestscanend.factor = factor(irimagingm2$fmricuffpainrestscanend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainrestscanend2.factor = factor(irimagingm2$fmricuffpainrestscanend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainaftlastscanss.factor = factor(irimagingm2$fmricuffpainaftlastscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainaftlastscanss2.factor = factor(irimagingm2$fmricuffpainaftlastscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainaftlastscanany.factor = factor(irimagingm2$fmricuffpainaftlastscanany,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffpainaftlastscanany2.factor = factor(irimagingm2$fmricuffpainaftlastscanany2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
irimagingm2$fmricuffcompletescl.factor = factor(irimagingm2$fmricuffcompletescl,levels=c("1","2","0"))
irimagingm2$fmricufft1yn.factor = factor(irimagingm2$fmricufft1yn,levels=c("1","0"))
irimagingm2$fmricuffdwiyn.factor = factor(irimagingm2$fmricuffdwiyn,levels=c("1","0"))
irimagingm2$fmricuffrest1yn.factor = factor(irimagingm2$fmricuffrest1yn,levels=c("1","0"))
irimagingm2$fmricuffipyn.factor = factor(irimagingm2$fmricuffipyn,levels=c("1","0"))
irimagingm2$fmricuffspyn.factor = factor(irimagingm2$fmricuffspyn,levels=c("1","0"))
irimagingm2$fmricuffrest2yn.factor = factor(irimagingm2$fmricuffrest2yn,levels=c("1","0"))
irimagingm2$fmricuffdicuploaded.factor = factor(irimagingm2$fmricuffdicuploaded,levels=c("1","0"))
irimagingm2$imaging_mcc2_v01_complete.factor = factor(irimagingm2$imaging_mcc2_v01_complete,levels=c("0","1","2"))



levels(irimagingm2$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","6-Mo Post-Op Day 8","6-Mo Post-Op Day 9","6-Mo Post-Op Day 10","6-Mo Post-Op Day 11","6-Mo Post-Op Day 12","6-Mo Post-Op Day 13","6-Mo Post-Op Day 14","12-Mo Post-Op","Event Reporting")
levels(irimagingm2$fmri_magnet_name.factor)=c("Explorer MRI (BIRB)","Discovery MRI (Modular Unit)")
levels(irimagingm2$fmricuffleg.factor)=c("Right","Left")
levels(irimagingm2$fmricuffcontrarecal.factor)=c("Yes","No")
levels(irimagingm2$fmricufft1techrating.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels(irimagingm2$fmricufft1repeated.factor)=c("Yes","No")
levels(irimagingm2$fmricufft1techrating2.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels(irimagingm2$fmricuffrestpainss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffrestpainss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffrestpainovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffrestpainovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcurrpainaftfirstscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcurrpainaftfirstscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcurrpainaftfirstscanovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcurrpainaftfirstscanovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcurrpainaftfirstscancuff.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcurrpainaftfirstscancuff2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpaincpbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpaincpbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpaincpmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpaincpmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpaincpend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpaincpend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainrestscanbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainrestscanbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainrestscanmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainrestscanmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainrestscanend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainrestscanend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainaftlastscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainaftlastscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainaftlastscanany.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffpainaftlastscanany2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(irimagingm2$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
levels(irimagingm2$fmricufft1yn.factor)=c("Yes","No")
levels(irimagingm2$fmricuffdwiyn.factor)=c("Yes","No")
levels(irimagingm2$fmricuffrest1yn.factor)=c("Yes","No")
levels(irimagingm2$fmricuffipyn.factor)=c("Yes","No")
levels(irimagingm2$fmricuffspyn.factor)=c("Yes","No")
levels(irimagingm2$fmricuffrest2yn.factor)=c("Yes","No")
levels(irimagingm2$fmricuffdicuploaded.factor)=c("Yes","No")
levels(irimagingm2$imaging_mcc2_v01_complete.factor)=c("Incomplete","Unverified","Complete")









#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

m2irdf.complete <- irimagingm2 %>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc2_v01_complete == 2)






#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, 
#Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure


m2irerror1a <- m2irdf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffspyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) & (cuffpfmricontrainddomyn != 1 | cuffpfmricontraindyn !=1)) %>% 
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffleg.factor,fmricuffspyn.factor,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("fMRI individualized pressure" = fmricuffipyn.factor,"fMRI standard pressure"= fmricuffspyn.factor,"Test Completed"= fmricuffcompletescl.factor, "cuff applied to R/L leg"=fmricuffleg.factor ))%>% 
  mutate("cuff applied to R/L leg"=replace_na("missing")) 


# . For the UM site only, there are two scanners that could be used, and based on study protocol subjects 
#returning for "V3" scans should have them done on the same scanner as at "V1", check for same scanner within a subject

m2irerror1b <- m2irdf.complete %>%
  filter(redcap_data_access_group == "university_of_mich") %>% 
  select(record_id,redcap_event_name,fmri_magnet_name) %>% 
  group_by(record_id) %>%
  mutate(dummy = as.integer(n_distinct(fmri_magnet_name) == 1)) %>% 
  filter(dummy == 0) %>% 
  select(-dummy) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  add_column(fmri_name_mismatch = "yes") %>% 
  select(-fmri_magnet_name) %>% 
  distinct(record_id, .keep_all = TRUE)


m2irerror1c <-m2irdf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffspyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffspyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "missing"))  %>% 
  rename("Test Completed"= fmricuffcompletescl.factor)


m2irerror1.1 <- full_join(m2irerror1a,m2irerror1b,by = intersect(names(m2irerror1a), names(m2irerror1b)))

m2irerror1 <- full_join(m2irerror1.1,m2irerror1c,by = intersect(names(m2irerror1.1), names(m2irerror1c)))


# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

m2irerror2 <- m2irdf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffcontrarecal.factor,fmricuffleg.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal))) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2))) %>% 
  rename(c("Re-calibration of pressure needed" = fmricuffcontrarecal.factor, "Recaliberation pressure 1"= fmricuffcalfpressurerecal,"Recaliberation pressure 1:double entry"=fmricuffcalfpressurerecal2, "cuff applied to R/L leg"=fmricuffleg.factor,"Test Completed"=fmricuffcompletescl.factor))

# merge error1 and 2 



m2irerror1_2 <- full_join(m2irerror1,m2irerror2,by = intersect(names(m2irerror1), names(m2irerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

m2irerror3 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricuffcompletescl.factor,fmricufft1yn,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,
         fmricufft1repeated.factor,fmricufft1repeated,fmricufft1techrating2,fmricufft1techrating2.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "missing",TRUE ~ as.character(fmricufft1techrating))) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated== "1"  ~ "missing",TRUE ~ as.character(fmricufft1techrating2))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,fmricufft1repeated.factor,fmricufft1techrating2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"T1"=fmricufft1yn.factor,"Technologists quality rating for T1 scan"=fmricufft1techrating,"T1 scan repeated?"=fmricufft1repeated.factor,"Technologists quality rating for repeated T1 scan"=fmricufft1techrating2 ) %>% 
  select (c(record_id,redcap_event_name,"Test Completed","T1","Technologists quality rating for T1 scan","T1 scan repeated?","Technologists quality rating for repeated T1 scan"))



m2irerror1_2_3 <- full_join(m2irerror1_2,m2irerror3,by = intersect(names(m2irerror1_2), names(m2irerror3)))






#before first resting state

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

m2irerror4.1 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "missing",TRUE ~ as.character(fmricuffrestpainss))) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "missing",TRUE ~ as.character(fmricuffrestpainss2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainss,fmricuffrestpainss2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:surgical site pain"=fmricuffrestpainss,"Before 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffrestpainss2,"1st resting state"= fmricuffrest1yn.factor) 




# Check if first resting-state scan performed and there was a mismatch between entries overall body pain

m2irerror4.2 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall))) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainovrall, fmricuffrestpainovrall2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:body pain"=fmricuffrestpainovrall,"Before 1st resting fMRI scan:body pain(double entry)"=fmricuffrestpainovrall2,"1st resting state"= fmricuffrest1yn.factor) 



m2irerror4 <- full_join(m2irerror4.1,m2irerror4.2,by=c("record_id","Test Completed","redcap_event_name","1st resting state"))


m2irerror1_2_3_4 <- full_join(m2irerror1_2_3,m2irerror4,by = intersect(names(m2irerror1_2_3), names(m2irerror4)))




# After first resting fMRI scan:

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

m2irerror5.1 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2,fmricuffrest1yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss))) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss2) )) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:surgical site pain"=fmricuffcurrpainaftfirstscanss,"After 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffcurrpainaftfirstscanss2,"1st resting state"= fmricuffrest1yn.factor) 

# Check  if first resting-state scan and there was mismatch between entries for overall body pain

m2irerror5.2 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall))) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:body pain"=fmricuffcurrpainaftfirstscanovrall,"After 1st resting fMRI scan:body pain(double entry)"=fmricuffcurrpainaftfirstscanovrall2,"1st resting state"= fmricuffrest1yn.factor) 



m2irerror5.a <- full_join(m2irerror5.1,m2irerror5.2,by = intersect(names(m2irerror5.1), names(m2irerror5.2)))


# Check if individualized and standard performed but baseline was missing after first resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
m2irerror5.bb <- m2irdf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffspyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancuff - fmricuffcurrpainaftfirstscancuff2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscancuff,fmricuffcurrpainaftfirstscancuff2,fmricuffrest1yn.factor,fmricuffspyn.factor,
         fmricuffipyn.factor) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancuff = case_when(is.na(fmricuffcurrpainaftfirstscancuff) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancuff))) %>%
  mutate(fmricuffcurrpainaftfirstscancuff2 = case_when(is.na(fmricuffcurrpainaftfirstscancuff2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancuff2))) %>%
  rename("Test Completed"=fmricuffcompletescl.factor,"1st resting state"= fmricuffrest1yn.factor,"After 1st resting fMRI scan:cuff pain"=fmricuffcurrpainaftfirstscancuff,
         "After 1st resting fMRI scan:cuff pain(double entry)"=fmricuffcurrpainaftfirstscancuff2,"fMRI individualized pressure" = fmricuffipyn.factor, "fMRI standard pressure"= fmricuffspyn.factor)


m2irerror1_2_3_4_5a <- full_join(m2irerror1_2_3_4,m2irerror5.a,by=intersect(names(m2irerror1_2_3_4), names(m2irerror5.a)))


m2irerror1_2_3_4_5 <- full_join(m2irerror1_2_3_4_5a,m2irerror5.bb,by=intersect(names(m2irerror1_2_3_4_5a), names(m2irerror5.bb)))





# After first cuff fMRI scan

# check if first cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

m2irerror6.1 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainbegin, fmricuffpainbegin2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain beginning"=fmricuffpainbegin,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain beginning)"=fmricuffpainbegin2)


# check if first cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

m2irerror6.2 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainmid,fmricuffpainmid2,fmricuffipyn.factor) %>% mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "missing",TRUE ~ as.character(fmricuffpainmid))) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "missing",TRUE ~ as.character(fmricuffpainmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain mid"=fmricuffpainmid,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpainmid2)

# check if first cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

m2irerror6.3 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainend,fmricuffpainend2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "missing",TRUE ~ as.character(fmricuffpainend))) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "missing",TRUE ~ as.character(fmricuffpainend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain end"=fmricuffpainend,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpainend2)

#create final set



m2irerror6a <- full_join(m2irerror6.1,m2irerror6.2,by=intersect(names(m2irerror6.1), names(m2irerror6.2)))

m2irerror6 <- full_join(m2irerror6a,m2irerror6.3,by=intersect(names(m2irerror6a), names(m2irerror6.3)))

m2irerror1_2_3_4_5_6 <- full_join(m2irerror1_2_3_4_5,m2irerror6,by=intersect(names(m2irerror1_2_3_4_5), names(m2irerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

m2irerror7.1 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpbegin, fmricuffpaincpbegin2,fmricuffspyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin))) %>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd cuff fMRI scan:cuff pain begin"=fmricuffpaincpbegin,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain begin)"=fmricuffpaincpbegin2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

m2irerror7.2 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpmid,fmricuffpaincpmid2,fmricuffspyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid))) %>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd cuff fMRI scan:cuff pain mid"=fmricuffpaincpmid,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpaincpmid2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

m2irerror7.3 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpend,fmricuffpaincpend2,fmricuffspyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "missing",TRUE ~ as.character(fmricuffpaincpend))) %>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "missing",TRUE ~ as.character(fmricuffpaincpend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd cuff fMRI scan:cuff pain end"=fmricuffpaincpend,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpaincpend2)

#create final set

m2irerror7a <- full_join(m2irerror7.1,m2irerror7.2,by=intersect(names(m2irerror7.1), names(m2irerror7.2))) 

m2irerror7 <- full_join(m2irerror7.3,m2irerror7a,by=intersect(names(m2irerror7.3), names(m2irerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
m2irerror8.1 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2,fmricuffspyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin))) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd Resting state:cuff pain beginning"=fmricuffpainrestscanbegin,"After 2nd Resting state:cuff pain(double entry cuff pain beginning)"=fmricuffpainrestscanbegin2,"2nd Resting state" = fmricuffrest2yn.factor)


m2irerror8.2 <- m2irdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanmid,fmricuffpainrestscanmid2,fmricuffspyn.factor,fmricuffrest2yn.factor) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid))) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd Resting state:cuff pain mid"=fmricuffpainrestscanmid,"After 2nd Resting state:cuff pain(double entry cuff pain mid)"=fmricuffpainrestscanmid2,"2nd Resting state" = fmricuffrest2yn.factor)


m2irerror8.3 <- m2irdf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanend,fmricuffpainrestscanend2,fmricuffspyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend)))%>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd Resting state:cuff pain end"=fmricuffpainrestscanend,"After 2nd Resting state:cuff pain(double entry cuff pain end)"=fmricuffpainrestscanend2,"2nd Resting state" = fmricuffrest2yn.factor)

#create full irerror8


m2irerror8a1 <- full_join(m2irerror8.1,m2irerror8.2,by=intersect(names(m2irerror8.1), names(m2irerror8.2))) 

m2irerror8a <- full_join(m2irerror8.3,m2irerror8a1,by=intersect(names(m2irerror8.3), names(m2irerror8a1))) 

#merge 7 and 8a 

m2irerror7_8a <- full_join(m2irerror7,m2irerror8a,by=intersect(names(m2irerror7), names(m2irerror8a)))







#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
m2irerror8.4 <- m2irdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss)))%>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:surgical site pain"=fmricuffpainaftlastscanss,"After 2nd Resting state:surgical site pain(double entry)"=fmricuffpainaftlastscanss2,"2nd Resting state" = fmricuffrest2yn.factor)

#"Body pain (double entry)"

m2irerror8.5 <- m2irdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany)))%>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:body pain"=fmricuffpainaftlastscanany,"After 2nd Resting state:body pain(double entry)"=fmricuffpainaftlastscanany2,"2nd Resting state" = fmricuffrest2yn.factor)


m2irerror8b<- full_join(m2irerror8.4,m2irerror8.5,by=intersect(names(m2irerror8.4), names(m2irerror8.5)))



#merge 7_8a and 8b

m2irerror7_8a_8b <- full_join(m2irerror7_8a,m2irerror8b,by=intersect(names(m2irerror7_8a), names(m2irerror8b)))



#merge all

m2irerror1_2_3_4_5_6_7_8 <- full_join(m2irerror1_2_3_4_5_6,m2irerror7_8a_8b,by=intersect(names(m2irerror1_2_3_4_5_6), names(m2irerror7_8a_8b)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") 







#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

m2irerror9.1 <- irimagingm2 %>% 
  filter((imaging_mcc2_v01_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc2_v01_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffdicuploaded.factor = case_when(is.na(fmricuffdicuploaded.factor) ~ "missing",TRUE ~ as.character(fmricuffdicuploaded.factor))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,imaging_mcc2_v01_complete.factor,fmricuffdicuploaded.factor)%>% 
  rename("complete?"=imaging_mcc2_v01_complete.factor,"Dicom files uploaded to TACC?"=fmricuffdicuploaded.factor,"Test Completed"=fmricuffcompletescl.factor)





#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
m2irerror9.2 <- irimagingm2 %>% 
  filter(imaging_mcc2_v01_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffcompletescl.factor = case_when(is.na(fmricuffcompletescl.factor) ~ "missing",TRUE ~ as.character(fmricuffcompletescl.factor))) %>% 
  select(record_id,redcap_event_name,imaging_mcc2_v01_complete.factor,fmricuffcompletescl.factor,fmricuffdicuploaded.factor) %>% 
  rename("complete?"=imaging_mcc2_v01_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"Dicom files uploaded to TACC"=fmricuffdicuploaded.factor)


#merge 9.1 and 9.2 

m2irerror9.a <- full_join(m2irerror9.1,m2irerror9.2,by=intersect(names(m2irerror9.1), names(m2irerror9.2))) 


# calculate visit date - mask field introduced date
m2result_surg_no_na <- m2result_surg %>% 
  add_column(mask_date = as.Date("2021-11-05")) %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,mask_date,units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,mask_date,units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,mask_date,units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "mask_date_diff") %>% 
  mutate(mask_date_diff = gsub("days","",mask_date_diff)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(mask_date_diff = as.numeric(mask_date_diff))

# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

m2irerror9.b <- irimagingm2 %>% 
  filter(imaging_mcc2_v01_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffspyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "missing",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc2_v01_complete.factor,fmricuffcompletescl.factor,fmri_face_mask) %>% 
  rename("complete?"=imaging_mcc2_v01_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"face mask worn"= fmri_face_mask) %>% 
  left_join(.,m2result_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(-mask_date_diff)



m2irerror9 <- full_join(m2irerror9.a,m2irerror9.b,by=intersect(names(m2irerror9.a), names(m2irerror9.b))) 

#merge all plus error 9

m2irerror1_2_3_4_5_6_7_8_9 <- full_join(m2irerror1_2_3_4_5_6_7_8,m2irerror9,by=intersect(names(m2irerror1_2_3_4_5_6_7_8), names(m2irerror9)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") %>% 
  mutate_all(as.character)



#fetch notes wit dag
m2notes.imaging <- irimagingm2 %>% 
  select(record_id,redcap_event_name,fmricuffnotes, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  rename("notes"=fmricuffnotes) %>% 
  as_tibble() 










m2irerror1_2_3_4_5_6_7_8_shrink <- m2irerror1_2_3_4_5_6_7_8_9 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#now merge with notes

m2irerror1_2_3_4_5_6_7_8_notes <- left_join(m2irerror1_2_3_4_5_6_7_8_shrink,m2notes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  left_join(.,m2days_from_sysdate, by=c("record_id","redcap_event_name"))



glimpse(m2irerror1_2_3_4_5_6_7_8_notes)






# mcc2 blood draw



#Read Data

m2brdata <- retype(mcc2data)

label(m2brdata$record_id)="Record ID"
label(m2brdata$redcap_event_name)="Event Name"
label(m2brdata$bscp_sample_obtained___1)="7. Blood sample (choice=Not obtained)"
label(m2brdata$bscp_time_blood_draw)="Time completed blood draw: "
label(m2brdata$bscp_aliq_cnt)="Number of aliquots:"
label(m2brdata$bscp_time_centrifuge)="Time completed centrifuging: "
label(m2brdata$bscp_aliquot_freezer_time)="Time placed in freezer:"
label(m2brdata$bscp_deg_of_hemolysis)="Assess the degree of hemolysis of the plasma (Lavender tube) after centrifugation according to the laminated hemolysis color scale, and record the estimated hemoglobin value in g/L:"
label(m2brdata$bscp_lav1_not_obt___1)="Lavender #1: (choice=Not obtained)"
label(m2brdata$bscp_paxg_aliq_na___1)="PAXgene DNA tube: (choice=N/A)"
label(m2brdata$bscp_protocol_dev)="Did a protocol deviation occur:"
label(m2brdata$bscp_protocol_dev_reason)="Reason for protocol deviation:"
label(m2brdata$bscp_comments)="Comments"
#Setting Units









#Setting Factors(will create new variable for factors)
m2brdata$redcap_event_name.factor = factor(m2brdata$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m2brdata$bscp_sample_obtained___1.factor = factor(m2brdata$bscp_sample_obtained___1,levels=c("0","1"))
m2brdata$bscp_aliq_cnt.factor = factor(m2brdata$bscp_aliq_cnt,levels=c("0","1","2","3","4","5","6","7","8"))
m2brdata$bscp_deg_of_hemolysis.factor = factor(m2brdata$bscp_deg_of_hemolysis,levels=c("0",".25",".5","1","2","4","8"))
m2brdata$bscp_lav1_not_obt___1.factor = factor(m2brdata$bscp_lav1_not_obt___1,levels=c("0","1"))
m2brdata$bscp_paxg_not_obt___1.factor = factor(m2brdata$bscp_paxg_not_obt___1,levels=c("0","1"))

m2brdata$bscp_paxg_aliq_na___1.factor = factor(m2brdata$bscp_paxg_aliq_na___1,levels=c("0","1"))
m2brdata$bscp_protocol_dev.factor = factor(m2brdata$bscp_protocol_dev,levels=c("1","0"))
m2brdata$bscp_protocol_dev_reason.factor = factor(m2brdata$bscp_protocol_dev_reason,levels=c("1","2","3"))

levels(m2brdata$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(m2brdata$bscp_sample_obtained___1.factor)=c("Unchecked","Checked")
levels(m2brdata$bscp_aliq_cnt.factor)=c("0","1","2","3","4","5","6","7","8")
levels(m2brdata$bscp_deg_of_hemolysis.factor)=c("0","0.25","0.5","1","2","4","8")
levels(m2brdata$bscp_lav1_not_obt___1.factor)=c("Unchecked","Checked")
levels(m2brdata$bscp_paxg_aliq_na___1.factor)=c("Unchecked","Checked")
levels(m2brdata$bscp_paxg_not_obt___1.factor)=c("Unchecked","Checked")
levels(m2brdata$bscp_protocol_dev.factor)=c("Yes","No")
levels(m2brdata$bscp_protocol_dev_reason.factor)=c("Unable to obtain blood sample -technical reason","Unable to obtain blood sample -patient related","Sample handling/processing error")







# inspect data

problems(m2brdata)

glimpse(m2brdata)

# retype m2brdata incase future m2brdata has problems

m2brdata <- retype(m2brdata)

# inspect data again to make sure retyping didnt make erroneous assumptions
glimpse(m2brdata)






# detailed protocol on pg.230 of MOP



# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)




m2brdata1 <- m2brdata %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1.factor == "Unchecked" & blood_sample_collection_and_processing_crf_complete == 2)






# format time
m2brdata1$bscp_time_blood_draw <- ymd_hms(m2brdata1$bscp_time_blood_draw)

m2brdata1$bscp_time_centrifuge <- ymd_hms(m2brdata1$bscp_time_centrifuge)

m2brdata1$bscp_aliquot_freezer_time <- ymd_hms(m2brdata1$bscp_aliquot_freezer_time)











#check if blood draw time < centri time < freezer time 
m2brdata2 <- m2brdata1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor) 



m2brflag5 <- m2brdata2 %>%
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) %>%
  as_tibble() %>% 
  mutate_all(as.character)











#missing info on hours since last drink

m2brflag6 <- m2brdata1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "missing",TRUE ~ as.character(bscp_hrs_since_water))) 






m2brflag1_6 <- full_join(m2brflag5,m2brflag6,by = intersect(names(m2brflag5), names(m2brflag6))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#missing info on hours since last food


m2brflag7 <- m2brdata1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "missing",TRUE ~ as.character(bscp_hrs_since_food))) 





m2brflag1_7 <- full_join(m2brflag1_6,m2brflag7,by = intersect(names(m2brflag1_6), names(m2brflag7))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

m2brflag8 <- m2brdata1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "missing",TRUE ~ as.character(bscp_hrs_since_cafstim)))


m2brflag1_8 <- full_join(m2brflag1_7,m2brflag8,by = intersect(names(m2brflag1_7), names(m2brflag8))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on amount of caff
m2brflag9 <- m2brdata1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "missing",TRUE ~ as.character(bscp_caff_cups_amt))) 


m2brflag1_9 <- full_join(m2brflag1_8,m2brflag9,by = intersect(names(m2brflag1_8), names(m2brflag9 ))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on any vacc
m2brflag10 <- m2brdata1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "missing",TRUE ~ as.character(bscp_any_vacc))) 

m2brflag1_10 <- full_join(m2brflag1_9,m2brflag10,by = intersect(names(m2brflag1_9), names(m2brflag10)))






# if level of hemolysis was not entered

m2brflag11 <- m2brdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



m2brflag1_11<- full_join(m2brflag1_10,m2brflag11,by = intersect(names(m2brflag1_10), names(m2brflag11))) %>%
  as_tibble() %>% 
  mutate_all(as.character)







# if centrifuge time entered but freezing time not entered

m2brflag14.1 <- m2brdata1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "missing",TRUE ~ as.character(bscp_aliquot_freezer_time))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_aliquot_freezer_time)






m2brflag14.1 [] <- lapply(m2brflag14.1 , as.character)
m2brflag1_11 [] <- lapply(m2brflag1_11 , as.character)



m2brflag1_14.1<- full_join(m2brflag1_11,m2brflag14.1,by = intersect(names(m2brflag1_11), names(m2brflag14.1))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time entered but degree of hemolysis  not entered

m2brflag14.2 <- m2brdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)




m2brflag1_14.1 [] <- lapply(m2brflag1_14.1 , as.character)
m2brflag14.2 [] <- lapply(m2brflag14.2 , as.character)



m2brflag1_14.2<- full_join(m2brflag1_14.1,m2brflag14.2,by = intersect(names(m2brflag1_14.1), names(m2brflag14.2))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time not entered but degree of hemolysis entered

m2brflag14.3 <- m2brdata1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "missing",TRUE ~ as.character(bscp_time_centrifuge))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)



m2brflag1_14.2 [] <- lapply(m2brflag1_14.2 , as.character)
m2brflag14.3 [] <- lapply(m2brflag14.3 , as.character)




m2brflag1_14<- full_join(m2brflag1_14.2,m2brflag14.3,by = intersect(names(m2brflag1_14.2), names(m2brflag14.3))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#rename columns
m2brflag1_14 <- m2brflag1_14 %>% 
  rename("Time completed blood draw:"= bscp_time_blood_draw,"Time completed centrifuging:"=bscp_time_centrifuge,
         "Time placed in freezer:"= bscp_aliquot_freezer_time,"Assess the degree of hemolysis of the plasma (Lavender tube)"= bscp_deg_of_hemolysis,
         "hours since water"=bscp_hrs_since_water,"hours since food"=bscp_hrs_since_food,"amount of caffeine"= bscp_caff_cups_amt,
         "Any vaccine in last two weeks"= bscp_any_vacc,"hours since caffiene"=bscp_hrs_since_cafstim) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2brflag1_14[] <- lapply(m2brflag1_14, as.character)

m2brflag1_14_shrink <- m2brflag1_14 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>%
  as_tibble() %>% 
  mutate_all(as.character)











m2brcomments <- m2brdata1  %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bscp_comments,bscp_sample_obtained___1.factor,bscp_lav1_not_obt___1.factor,bscp_paxg_aliq_na___1.factor,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor,bscp_samplekit_brcd)

m2brcomments[] <- lapply(m2brcomments, as.character)

m2brflag1_14_shrink[] <- lapply(m2brflag1_14_shrink, as.character)

m2brflag_comments <- left_join(m2brflag1_14_shrink,m2brcomments,by = intersect(names(m2brflag1_14_shrink), names(m2brcomments))) %>% 
  rename("Blood sample (choice=Not obtained)"= bscp_sample_obtained___1.factor,
         "Lavender #1: (choice=Not obtained)"= bscp_lav1_not_obt___1.factor,
         "PAXgene DNA tube: (choice=N/A)"= bscp_paxg_aliq_na___1.factor,
         "Did a protocol deviation occur:"= bscp_protocol_dev.factor,
         "Reason for protocol deviation:"= bscp_protocol_dev_reason.factor,
         "Comments"= bscp_comments,"sample kit barcode" = bscp_samplekit_brcd) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  left_join(.,m2days_from_sysdate, by=c("record_id","redcap_event_name")) 



# mcc2 QST





qdatam2 <- retype(mcc2data)







#Setting Labels

label(qdatam2$record_id)="Record ID"
label(qdatam2$redcap_event_name)="Event Name"
label(qdatam2$redcap_data_access_group)="qdatam2 Access Group"
label(qdatam2$pmachgchestpainyn)="1. New chest pain since surgery?"
label(qdatam2$pmapainregion)="2. General region of pain"
label(qdatam2$pmahighestloc)="3. Highest pain location"
label(qdatam2$pmalowestloc)="4. Lowest pain location"
label(qdatam2$pmamostpain)="5. Most painful region:"
label(qdatam2$pptremoter1val)="Rep 1:"
label(qdatam2$pptremoter1val_d)="Rep 1: (double entry)"
label(qdatam2$pptremoter2val)="Rep 2:"
label(qdatam2$pptremoter2val_d)="Rep 2: (double entry)"
label(qdatam2$pptremoter3val)="Rep 3:"
label(qdatam2$pptremoter3val_d)="Rep 3: (double entry)"
label(qdatam2$dmacontr1pain)="Rep 1:"
label(qdatam2$dmacontr1pain_d)="Rep 1: (double entry)"
label(qdatam2$dmacontr2pain)="Rep 2:"
label(qdatam2$dmacontr2pain_d)="Rep 2: (double entry)"
label(qdatam2$dmacontr3pain)="Rep 3:"
label(qdatam2$dmacontr3pain_d)="Rep 3: (double entry)"
label(qdatam2$dmacontr4pain)="Rep 4:"
label(qdatam2$dmacontr4pain_d)="Rep 4: (double entry)"
label(qdatam2$dmacontr5pain)="Rep 5:"
label(qdatam2$dmacontr5pain_d)="Rep 5: (double entry)"
label(qdatam2$dmaindxr1pain)="Rep 1:"
label(qdatam2$dmaindxr1pain_d)="Rep 1: (double entry)"
label(qdatam2$dmaindxr2pain)="Rep 2:"
label(qdatam2$dmaindxr2pain_d)="Rep 2: (double entry)"
label(qdatam2$dmaindxr3pain)="Rep 3:"
label(qdatam2$dmaindxr3pain_d)="Rep 3: (double entry)"
label(qdatam2$dmaindxr4pain)="Rep 4:"
label(qdatam2$dmaindxr4pain_d)="Rep 4: (double entry)"
label(qdatam2$dmaindxr5pain)="Rep 5:"
label(qdatam2$dmaindxr5pain_d)="Rep 5: (double entry)"
label(qdatam2$dmasenscompare)="11. Sensation comparison standardized site"
label(qdatam2$dmaptcontr1pain)="12. Rep 1:"
label(qdatam2$dmaptcontr1pain_d)="12. Rep 1: (double entry)"
label(qdatam2$dmaptcontr2pain)="13. Rep 2:"
label(qdatam2$dmaptcontr2pain_d)="13. Rep 2: (double entry)"
label(qdatam2$dmaptcontr3pain)="14. Rep 3:"
label(qdatam2$dmaptcontr3pain_d)="14. Rep 3: (double entry)"
label(qdatam2$dmaptcontr4pain)="15. Rep 4:"
label(qdatam2$dmaptcontr4pain_d)="15. Rep 4: (double entry)"
label(qdatam2$dmaptcontr5pain)="16. Rep 5:"
label(qdatam2$dmaptcontr5pain_d)="16. Rep 5: (double entry)"
label(qdatam2$dmaptindxr1pain)="17. Rep 1:"
label(qdatam2$dmaptindxr1pain_d)="17. Rep 1: (double entry)"
label(qdatam2$dmaptindxr2pain)="18. Rep 2:"
label(qdatam2$dmaptindxr2pain_d)="18. Rep 2: (double entry)"
label(qdatam2$dmaptindxr3pain)="19. Rep 3:"
label(qdatam2$dmaptindxr3pain_d)="19. Rep 3: (double entry)"
label(qdatam2$dmaptindxr4pain)="20. Rep 4:"
label(qdatam2$dmaptindxr4pain_d)="20. Rep 4: (double entry)"
label(qdatam2$dmaptindxr5pain)="21. Rep 5:"
label(qdatam2$dmaptindxr5pain_d)="21. Rep 5: (double entry)"
label(qdatam2$dmaptspecsite_3m)="22. Patient-Specific site assessed? (3-Month)"
label(qdatam2$dmaptsenscompare)="23. Sensation comparison patient-specific site:"
label(qdatam2$dmatestcompyn)="24A. DMA Test(s) completed"
label(qdatam2$dmatestcompyn_3m)="24B. DMA Test(s) completed"
label(qdatam2$dmatestcompwhich___1)="25. Choose all completed sites: (Baseline) (choice=1. Standardized control site (contralateral))"
label(qdatam2$dmatestcompwhich___2)="25. Choose all completed sites: (Baseline) (choice=2. Standardized index site (surgical))"
label(qdatam2$dmatestcompwhich_3m___1)="25. Choose all completed sites: (3-Month) (choice=1. Standardized control site (contralateral))"
label(qdatam2$dmatestcompwhich_3m___2)="25. Choose all completed sites: (3-Month) (choice=2. Standardized index site (surgical))"
label(qdatam2$dmatestcompwhich_3m___3)="25. Choose all completed sites: (3-Month) (choice=3. Patient specific control site (contralateral))"
label(qdatam2$dmatestcompwhich_3m___4)="25. Choose all completed sites: (3-Month) (choice=4. Patient specific index site (surgical))"
label(qdatam2$dmanotes)="26. Additional notes for DMA"
label(qdatam2$pptindxr1val)="1. Rep 1:"
label(qdatam2$pptindxr1val_d)="1. Rep 1: (double entry)"
label(qdatam2$pptindxr2val)="2. Rep 2:"
label(qdatam2$pptindxr2val_d)="2. Rep 2: (double entry)"
label(qdatam2$pptindxr3val)="3. Rep 3:"
label(qdatam2$pptindxr3val_d)="3. Rep 3: (double entry)"
label(qdatam2$pptcompleteyn)="4. Test completed?"
label(qdatam2$pptnotes)="Additional notes for baseline PPTs"
label(qdatam2$tsremoter1initial)="1. Initial Pain Rating:"
label(qdatam2$tsremoter1initial_d)="1. Initial Pain Rating: (double entry)"
label(qdatam2$tsremoter1final)="2. Final Pain Rating:"
label(qdatam2$tsremoter1final_d)="2. Final Pain Rating: (double entry)"
label(qdatam2$tsremoter2initial)="3. Initial Pain Rating:"
label(qdatam2$tsremoter2initial_d)="3. Initial Pain Rating: (double entry)"
label(qdatam2$tsremoter2final)="4. Final Pain Rating:"
label(qdatam2$tsremoter2final_d)="4. Final Pain Rating: (double entry)"
label(qdatam2$tsremoter3initial)="5. Initial Pain Rating:"
label(qdatam2$tsremoter3initial_d)="5. Initial Pain Rating: (double entry)"
label(qdatam2$tsremoter3final)="6. Final Pain Rating:"
label(qdatam2$tsremoter3final_d)="6. Final Pain Rating: (double entry)"
label(qdatam2$tsremoteafter15)="7. 15 sec"
label(qdatam2$tsfinalpainremafts31)="8. 30 sec"
label(qdatam2$tsindxr1initial)="9. Initial Pain Rating:"
label(qdatam2$tsindxr1initial_d)="9. Initial Pain Rating: (double entry)"
label(qdatam2$tsindxr1final)="10. Final Pain Rating:"
label(qdatam2$tsindxr1final_d)="10. Final Pain Rating: (double entry)"
label(qdatam2$tsindxr2initial)="11. Initial Pain Rating:"
label(qdatam2$tsindxr2initial_d)="11. Initial Pain Rating: (double entry)"
label(qdatam2$tsindxr2final)="12. Final Pain Rating:"
label(qdatam2$tsindxr2final_d)="12. Final Pain Rating: (double entry)"
label(qdatam2$tsindxr3initial)="13. Initial Pain Rating:"
label(qdatam2$tsindxr3initial_d)="13. Initial Pain Rating: (double entry)"
label(qdatam2$tsindxr3final)="14. Final Pain Rating:"
label(qdatam2$tsindxr3final_d)="14. Final Pain Rating: (double entry)"
label(qdatam2$tsindxafter15)="15. 15 sec"
label(qdatam2$tsindxafter30)="16. 30 sec"
label(qdatam2$tscompleted)="17. Test completed?"
label(qdatam2$tsnotes)="18. Additional notes for Temporal Summation"
label(qdatam2$cpmcoldwatertemp)="1. Confirm water temp 10 deg C (+/-1 deg): "
label(qdatam2$cpmcoldwaterpain30)="2. Cold Water Pain Rating at 30 sec:"
label(qdatam2$cpmcoldwaterpain30_d)="2. Cold Water Pain Rating at 30 sec: (double entry)"
label(qdatam2$cpmcoldwaterpain60)="3. Cold Water Pain Rating at 60 sec:"
label(qdatam2$cpmcoldwaterpain60_d)="3. Cold Water Pain Rating at 60 sec: (double entry)"
label(qdatam2$cpmbathrangeyn)="4. Water bath duration?"
label(qdatam2$cpmoutrangetime)="If outside of range, enter time (sec)"
label(qdatam2$cpmpptremr1val)="5. Rep 1:"
label(qdatam2$cpmpptremr1val_d)="5. Rep 1: (double entry)"
label(qdatam2$cpmpptremr2val)="6. Rep 2:"
label(qdatam2$cpmpptremr2val_d)="6. Rep 2: (double entry)"
label(qdatam2$cpmpptremr3val)="7. Rep 3:"
label(qdatam2$cpmpptremr3val_d)="7. Rep 3: (double entry)"
label(qdatam2$cpmcompleteyn)="Test Completed:"
label(qdatam2$cpmnotes)="Additional notes for Conditioned Pain Modulation "
label(qdatam2$cuffpfmricontraindyn)="1. Cuff pressure contraindicated:"
label(qdatam2$cuffpfmrinondomleg)="2. Which leg is non-dominant?"
label(qdatam2$cuffpfmripressure)="3. Calf of non-dominant leg pressure: "
label(qdatam2$cuffpfmripressure_d)="3. Calf of non-dominant leg pressure 1: (double entry) "
label(qdatam2$qst_mcc1_v03_complete)="Complete?"
#Setting Units


#Setting Factors(will create new variable for factors)
qdatam2$redcap_event_name.factor = factor(qdatam2$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","6mo_postop_day_8_arm_1","6mo_postop_day_9_arm_1","6mo_postop_day_10_arm_1","6mo_postop_day_11_arm_1","6mo_postop_day_12_arm_1","6mo_postop_day_13_arm_1","6mo_postop_day_14_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
qdatam2$redcap_data_access_group.factor = factor(qdatam2$redcap_data_access_group,levels=c("university_of_mich"))
qdatam2$pmachgchestpainyn.factor = factor(qdatam2$pmachgchestpainyn,levels=c("1","0"))
qdatam2$pmapainregion.factor = factor(qdatam2$pmapainregion,levels=c("1","2","3"))
qdatam2$pmahighestloc.factor = factor(qdatam2$pmahighestloc,levels=c("1","2","3","4","5","6","7","8","9","10","11","12","13"))
qdatam2$pmalowestloc.factor = factor(qdatam2$pmalowestloc,levels=c("1","2","3","4","5","6","7","8","9","10","11","12","13"))
qdatam2$pmamostpain.factor = factor(qdatam2$pmamostpain,levels=c("1","2","3"))
qdatam2$dmacontr1pain.factor = factor(qdatam2$dmacontr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr1pain_d.factor = factor(qdatam2$dmacontr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr2pain.factor = factor(qdatam2$dmacontr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr2pain_d.factor = factor(qdatam2$dmacontr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr3pain.factor = factor(qdatam2$dmacontr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr3pain_d.factor = factor(qdatam2$dmacontr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr4pain.factor = factor(qdatam2$dmacontr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr4pain_d.factor = factor(qdatam2$dmacontr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr5pain.factor = factor(qdatam2$dmacontr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmacontr5pain_d.factor = factor(qdatam2$dmacontr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr1pain.factor = factor(qdatam2$dmaindxr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr1pain_d.factor = factor(qdatam2$dmaindxr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr2pain.factor = factor(qdatam2$dmaindxr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr2pain_d.factor = factor(qdatam2$dmaindxr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr3pain.factor = factor(qdatam2$dmaindxr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr3pain_d.factor = factor(qdatam2$dmaindxr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr4pain.factor = factor(qdatam2$dmaindxr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr4pain_d.factor = factor(qdatam2$dmaindxr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr5pain.factor = factor(qdatam2$dmaindxr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaindxr5pain_d.factor = factor(qdatam2$dmaindxr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmasenscompare.factor = factor(qdatam2$dmasenscompare,levels=c("1","2","3"))
qdatam2$dmaptcontr1pain.factor = factor(qdatam2$dmaptcontr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr1pain_d.factor = factor(qdatam2$dmaptcontr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr2pain.factor = factor(qdatam2$dmaptcontr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr2pain_d.factor = factor(qdatam2$dmaptcontr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr3pain.factor = factor(qdatam2$dmaptcontr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr3pain_d.factor = factor(qdatam2$dmaptcontr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr4pain.factor = factor(qdatam2$dmaptcontr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr4pain_d.factor = factor(qdatam2$dmaptcontr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr5pain.factor = factor(qdatam2$dmaptcontr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptcontr5pain_d.factor = factor(qdatam2$dmaptcontr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr1pain.factor = factor(qdatam2$dmaptindxr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr1pain_d.factor = factor(qdatam2$dmaptindxr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr2pain.factor = factor(qdatam2$dmaptindxr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr2pain_d.factor = factor(qdatam2$dmaptindxr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr3pain.factor = factor(qdatam2$dmaptindxr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr3pain_d.factor = factor(qdatam2$dmaptindxr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr4pain.factor = factor(qdatam2$dmaptindxr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr4pain_d.factor = factor(qdatam2$dmaptindxr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr5pain.factor = factor(qdatam2$dmaptindxr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptindxr5pain_d.factor = factor(qdatam2$dmaptindxr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam2$dmaptspecsite_3m.factor = factor(qdatam2$dmaptspecsite_3m,levels=c("1","2","3"))
qdatam2$dmaptsenscompare.factor = factor(qdatam2$dmaptsenscompare,levels=c("1","2","3"))
qdatam2$dmatestcompyn.factor = factor(qdatam2$dmatestcompyn,levels=c("1","2","0"))
qdatam2$dmatestcompyn_3m.factor = factor(qdatam2$dmatestcompyn_3m,levels=c("1","2","0"))
qdatam2$dmatestcompwhich___1.factor = factor(qdatam2$dmatestcompwhich___1,levels=c("0","1"))
qdatam2$dmatestcompwhich___2.factor = factor(qdatam2$dmatestcompwhich___2,levels=c("0","1"))
qdatam2$dmatestcompwhich_3m___1.factor = factor(qdatam2$dmatestcompwhich_3m___1,levels=c("0","1"))
qdatam2$dmatestcompwhich_3m___2.factor = factor(qdatam2$dmatestcompwhich_3m___2,levels=c("0","1"))
qdatam2$dmatestcompwhich_3m___3.factor = factor(qdatam2$dmatestcompwhich_3m___3,levels=c("0","1"))
qdatam2$dmatestcompwhich_3m___4.factor = factor(qdatam2$dmatestcompwhich_3m___4,levels=c("0","1"))
qdatam2$pptcompleteyn.factor = factor(qdatam2$pptcompleteyn,levels=c("1","2","3","0"))
qdatam2$tsremoter1initial.factor = factor(qdatam2$tsremoter1initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter1initial_d.factor = factor(qdatam2$tsremoter1initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter1final.factor = factor(qdatam2$tsremoter1final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter1final_d.factor = factor(qdatam2$tsremoter1final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter2initial.factor = factor(qdatam2$tsremoter2initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter2initial_d.factor = factor(qdatam2$tsremoter2initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter2final.factor = factor(qdatam2$tsremoter2final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter2final_d.factor = factor(qdatam2$tsremoter2final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter3initial.factor = factor(qdatam2$tsremoter3initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter3initial_d.factor = factor(qdatam2$tsremoter3initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter3final.factor = factor(qdatam2$tsremoter3final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoter3final_d.factor = factor(qdatam2$tsremoter3final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsremoteafter15.factor = factor(qdatam2$tsremoteafter15,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsfinalpainremafts31.factor = factor(qdatam2$tsfinalpainremafts31,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr1initial.factor = factor(qdatam2$tsindxr1initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr1initial_d.factor = factor(qdatam2$tsindxr1initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr1final.factor = factor(qdatam2$tsindxr1final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr1final_d.factor = factor(qdatam2$tsindxr1final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr2initial.factor = factor(qdatam2$tsindxr2initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr2initial_d.factor = factor(qdatam2$tsindxr2initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr2final.factor = factor(qdatam2$tsindxr2final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr2final_d.factor = factor(qdatam2$tsindxr2final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr3initial.factor = factor(qdatam2$tsindxr3initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr3initial_d.factor = factor(qdatam2$tsindxr3initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr3final.factor = factor(qdatam2$tsindxr3final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxr3final_d.factor = factor(qdatam2$tsindxr3final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxafter15.factor = factor(qdatam2$tsindxafter15,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tsindxafter30.factor = factor(qdatam2$tsindxafter30,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$tscompleted.factor = factor(qdatam2$tscompleted,levels=c("1","2","3","0"))
qdatam2$cpmcoldwatertemp.factor = factor(qdatam2$cpmcoldwatertemp,levels=c("1","0"))
qdatam2$cpmcoldwaterpain30.factor = factor(qdatam2$cpmcoldwaterpain30,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$cpmcoldwaterpain30_d.factor = factor(qdatam2$cpmcoldwaterpain30_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$cpmcoldwaterpain60.factor = factor(qdatam2$cpmcoldwaterpain60,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$cpmcoldwaterpain60_d.factor = factor(qdatam2$cpmcoldwaterpain60_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam2$cpmbathrangeyn.factor = factor(qdatam2$cpmbathrangeyn,levels=c("1","2"))
qdatam2$cpmcompleteyn.factor = factor(qdatam2$cpmcompleteyn,levels=c("1","0"))
qdatam2$cuffpfmricontraindyn.factor = factor(qdatam2$cuffpfmricontraindyn,levels=c("1","0"))
qdatam2$cuffpfmrinondomleg.factor = factor(qdatam2$cuffpfmrinondomleg,levels=c("1","2"))
qdatam2$qst_mcc1_v03_complete.factor = factor(qdatam2$qst_mcc1_v03_complete,levels=c("0","1","2"))

levels(qdatam2$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","6-Mo Post-Op Day 8","6-Mo Post-Op Day 9","6-Mo Post-Op Day 10","6-Mo Post-Op Day 11","6-Mo Post-Op Day 12","6-Mo Post-Op Day 13","6-Mo Post-Op Day 14","12-Mo Post-Op","Event Reporting")
levels(qdatam2$redcap_data_access_group.factor)=c("University of Michigan")
levels(qdatam2$pmachgchestpainyn.factor)=c("Yes","No")
levels(qdatam2$pmapainregion.factor)=c("Anterior chest","Axillary/lateral","Posterior chest")
levels(qdatam2$pmahighestloc.factor)=c("T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12","Above or below thoracic levels")
levels(qdatam2$pmalowestloc.factor)=c("T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12","Above or below thoracic levels")
levels(qdatam2$pmamostpain.factor)=c("At the scar","Immediately around the scar (< = 4 cm)","Distant from the scar (> 4 cm)")
levels(qdatam2$dmacontr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmacontr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaindxr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmasenscompare.factor)=c("Equal on both sides","Stronger on the surgery side","Stronger on contralateral side")
levels(qdatam2$dmaptcontr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptcontr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptindxr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam2$dmaptspecsite_3m.factor)=c("1. No, Pain site or < 4 cm from standardized site","2. Yes, tested pt-specific site","3. Yes, tested 2 cm below most anterior scar")
levels(qdatam2$dmaptsenscompare.factor)=c("1. Equal on both sides","2. Stronger on surgery side","3. Stronger on contralateral side")
levels(qdatam2$dmatestcompyn.factor)=c("Yes, all sites","Yes, but only some sites","None")
levels(qdatam2$dmatestcompyn_3m.factor)=c("Yes, all 4 sites","Yes, but only some sites","None")
levels(qdatam2$dmatestcompwhich___1.factor)=c("Unchecked","Checked")
levels(qdatam2$dmatestcompwhich___2.factor)=c("Unchecked","Checked")
levels(qdatam2$dmatestcompwhich_3m___1.factor)=c("Unchecked","Checked")
levels(qdatam2$dmatestcompwhich_3m___2.factor)=c("Unchecked","Checked")
levels(qdatam2$dmatestcompwhich_3m___3.factor)=c("Unchecked","Checked")
levels(qdatam2$dmatestcompwhich_3m___4.factor)=c("Unchecked","Checked")
levels(qdatam2$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (chest)","no, neither site")
levels(qdatam2$tsremoter1initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter1initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter1final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter1final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter2initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter2initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter2final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter2final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter3initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter3initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter3final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoter3final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsremoteafter15.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsfinalpainremafts31.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr1initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr1initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr1final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr1final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr2initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr2initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr2final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr2final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr3initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr3initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr3final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxr3final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxafter15.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tsindxafter30.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$tscompleted.factor)=c("yes, at least 1 repetition for both sites","only remote (shoulder)","only index (chest)","no, neither site")
levels(qdatam2$cpmcoldwatertemp.factor)=c("Yes","No")
levels(qdatam2$cpmcoldwaterpain30.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$cpmcoldwaterpain30_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$cpmcoldwaterpain60.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$cpmcoldwaterpain60_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam2$cpmbathrangeyn.factor)=c("Standard range (60sec +/- 5 sec)","Outside of range: < 55sec or > 65 sec")
levels(qdatam2$cpmcompleteyn.factor)=c("Yes","No")
levels(qdatam2$cuffpfmricontraindyn.factor)=c("Yes","No")
levels(qdatam2$cuffpfmrinondomleg.factor)=c("Right","Left")
levels(qdatam2$qst_mcc1_v03_complete.factor)=c("Incomplete","Unverified","Complete")





# DMA

#Remove records with missing "DMA test completed"

m2qdata1 <- qdatam2 %>% 
  filter(!is.na(dmatestcompyn))

#recheck if NAs removed

tabyl(m2qdata1,dmatestcompyn,dmatestcompyn.factor,show_na= TRUE)

# keep record with "test completed"

m2dma.complete <- m2qdata1 %>% 
  filter(dmatestcompyn != 0)

#check if all dma.completed now has completed records

m2dma.complete %>% 
  tabyl(dmatestcompyn.factor,dmatestcompyn,show_na= TRUE)


# filter only DMA baseline

m2dma.baseline <- m2dma.complete %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" )


# IF both or either one location for DMA standardized  performed but DMA complete was missing

m2error0 <-  m2dma.baseline  %>% 
  filter(is.na(dmatestcompyn)) %>%
  filter(!is.na(dmacontr1pain &  dmacontr1pain_d & dmacontr2pain & dmacontr2pain_d & dmacontr3pain & dmacontr3pain_d & 
                  dmacontr4pain & dmacontr4pain_d &dmacontr5pain  & dmacontr5pain_d | dmaindxr1pain & dmaindxr1pain_d &
                  dmaindxr2pain & dmaindxr2pain_d  &  dmaindxr3pain   &  dmaindxr3pain_d   &     dmaindxr4pain & dmaindxr4pain_d  & 
                  dmaindxr5pain & dmaindxr5pain_d     &   dmasenscompare))  %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1.factor,dmatestcompwhich___2.factor,dmatestcompyn.factor) %>% 
  mutate(dmatestcompyn.factor = case_when(is.na(dmatestcompyn.factor) ~ "missing",TRUE ~ as.character(dmatestcompyn.factor)))


# check if all sites checked and dmawhich1 or dmawchich2 both checked

m2error1 <- m2dma.baseline %>% 
  filter (dmatestcompyn == 1 & (dmatestcompwhich___1 == 1 |dmatestcompwhich___2 == 1)) %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1.factor,dmatestcompwhich___2.factor,dmatestcompyn.factor) 

m2error0_1 <-  full_join(m2error0,m2error1,by = intersect(names(m2error0),names(m2error1)))


# check if some sites checked and dmawhich1 or dmawchich2 both unchecked

m2error2 <- m2dma.baseline %>% 
  filter (dmatestcompyn == 2 & (dmatestcompwhich___1 == 0 & dmatestcompwhich___2 == 0)) %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1.factor,dmatestcompwhich___2.factor,dmatestcompyn.factor)

m2error0_2 <-  full_join(m2error0_1,m2error2,by = intersect(names(m2error0_1),names(m2error2)))


#check if all sites or some sites checked  and no  mismatch or missing pain data for standardized contralateral site
#rep1
m2error2.1 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff1 = dmacontr1pain - dmacontr1pain_d) %>% 
  filter(dma_stand_cont_diff1 != 0 | is.na(dma_stand_cont_diff1)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr1pain,dmacontr1pain_d) %>% 
  mutate(dmacontr1pain = case_when(is.na(dmacontr1pain) ~ "missing",TRUE ~ as.character(dmacontr1pain))) %>% 
  mutate(dmacontr1pain_d= case_when(is.na(dmacontr1pain_d) ~ "missing",TRUE ~ as.character(dmacontr1pain_d) )) 

#rep2
m2error2.2 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff2 = dmacontr2pain - dmacontr2pain_d) %>% 
  filter(dma_stand_cont_diff2 != 0 | is.na(dma_stand_cont_diff2)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr2pain,dmacontr2pain_d) %>% 
  mutate(dmacontr2pain = case_when(is.na(dmacontr2pain) ~ "missing",TRUE ~ as.character(dmacontr2pain))) %>% 
  mutate(dmacontr2pain_d= case_when(is.na(dmacontr2pain_d) ~ "missing",TRUE ~ as.character(dmacontr2pain_d) )) 



#rep3

m2error2.3 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff3 = dmacontr3pain - dmacontr3pain_d) %>% 
  filter(dma_stand_cont_diff3 != 0 | is.na(dma_stand_cont_diff3)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr3pain,dmacontr3pain_d) %>% 
  mutate(dmacontr3pain = case_when(is.na(dmacontr3pain) ~ "missing",TRUE ~ as.character(dmacontr3pain))) %>% 
  mutate(dmacontr3pain_d= case_when(is.na(dmacontr3pain_d) ~ "missing",TRUE ~ as.character(dmacontr3pain_d) )) 


#rep4

m2error2.4 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff4 = dmacontr4pain - dmacontr4pain_d) %>% 
  filter(dma_stand_cont_diff4 != 0 | is.na(dma_stand_cont_diff4)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr4pain,dmacontr4pain_d) %>% 
  mutate(dmacontr4pain = case_when(is.na(dmacontr4pain) ~ "missing",TRUE ~ as.character(dmacontr4pain))) %>% 
  mutate(dmacontr4pain_d= case_when(is.na(dmacontr4pain_d) ~ "missing",TRUE ~ as.character(dmacontr4pain_d) )) 


#rep5

m2error2.5 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff5 = dmacontr5pain - dmacontr5pain_d) %>% 
  filter(dma_stand_cont_diff5 != 0 | is.na(dma_stand_cont_diff5)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr5pain,dmacontr5pain_d) %>% 
  mutate(dmacontr5pain = case_when(is.na(dmacontr5pain) ~ "missing",TRUE ~ as.character(dmacontr5pain))) %>% 
  mutate(dmacontr5pain_d= case_when(is.na(dmacontr5pain_d) ~ "missing",TRUE ~ as.character(dmacontr5pain_d))) 

m2dma_stan_contr1 <-  full_join(m2error2.1,m2error2.2,by = intersect(names(m2error2.1),names(m2error2.2)))

m2dma_stan_contr2 <- full_join(m2dma_stan_contr1,m2error2.3,by = intersect(names(m2error2.3),names(m2dma_stan_contr1)))


m2dma_stan_contr3 <- full_join(m2dma_stan_contr2,m2error2.4,by = intersect(names(m2error2.4),names(m2dma_stan_contr2)))

m2dma_stan_contr <- full_join(m2dma_stan_contr3,m2error2.5,by = intersect(names(m2error2.5),names(m2dma_stan_contr3)))


m2error_0_2_dma_stand_cont <- full_join(m2error0_2,m2dma_stan_contr,by = intersect(names(m2error0_2),names(m2dma_stan_contr)))


#check if all sites or some sites checked  and no  mismatch or missing pain data for standardized index 
#rep1
m2error3.1 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff1 = dmaindxr1pain - dmaindxr1pain_d) %>% 
  filter(dma_stand_ind_diff1 != 0 | is.na(dma_stand_ind_diff1)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr1pain,dmaindxr1pain_d) %>% 
  mutate(dmaindxr1pain = case_when(is.na(dmaindxr1pain) ~ "missing",TRUE ~ as.character(dmaindxr1pain))) %>% 
  mutate(dmaindxr1pain_d= case_when(is.na(dmaindxr1pain_d) ~ "missing",TRUE ~ as.character(dmaindxr1pain_d) )) 

#rep2
m2error3.2 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff2 = dmaindxr2pain - dmaindxr2pain_d) %>% 
  filter(dma_stand_ind_diff2 != 0 | is.na(dma_stand_ind_diff2)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr2pain,dmaindxr2pain_d) %>% 
  mutate(dmaindxr2pain = case_when(is.na(dmaindxr2pain) ~ "missing",TRUE ~ as.character(dmaindxr2pain))) %>% 
  mutate(dmaindxr2pain_d= case_when(is.na(dmaindxr2pain_d) ~ "missing",TRUE ~ as.character(dmaindxr2pain_d) )) 




#rep3

m2error3.3 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff3 = dmaindxr3pain - dmaindxr3pain_d) %>% 
  filter(dma_stand_ind_diff3 != 0 | is.na(dma_stand_ind_diff3)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr3pain,dmaindxr3pain_d) %>% 
  mutate(dmaindxr3pain = case_when(is.na(dmaindxr3pain) ~ "missing",TRUE ~ as.character(dmaindxr3pain))) %>% 
  mutate(dmaindxr3pain_d= case_when(is.na(dmaindxr3pain_d) ~ "missing",TRUE ~ as.character(dmaindxr3pain_d) )) 


#rep4

m2error3.4 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff4 = dmaindxr4pain - dmaindxr4pain_d) %>% 
  filter(dma_stand_ind_diff4 != 0 | is.na(dma_stand_ind_diff4)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr4pain,dmaindxr4pain_d) %>% 
  mutate(dmaindxr4pain = case_when(is.na(dmaindxr4pain) ~ "missing",TRUE ~ as.character(dmaindxr4pain))) %>% 
  mutate(dmaindxr4pain_d= case_when(is.na(dmaindxr4pain_d) ~ "missing",TRUE ~ as.character(dmaindxr4pain_d) )) 


#rep5
m2error3.5 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff5 = dmaindxr5pain - dmaindxr5pain_d) %>% 
  filter(dma_stand_ind_diff5 != 0 | is.na(dma_stand_ind_diff5)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr5pain,dmaindxr5pain_d) %>% 
  mutate(dmaindxr5pain = case_when(is.na(dmaindxr5pain) ~ "missing",TRUE ~ as.character(dmaindxr5pain))) %>% 
  mutate(dmaindxr5pain_d= case_when(is.na(dmaindxr5pain_d) ~ "missing",TRUE ~ as.character(dmaindxr5pain_d) )) 


m2dma_stan_ind1 <-  full_join(m2error3.1,m2error3.2,by = intersect(names(m2error3.1),names(m2error3.2)))

m2dma_stan_ind2 <- full_join(m2dma_stan_ind1,m2error3.3,by = intersect(names(m2error3.3),names(m2dma_stan_ind1)))


m2dma_stan_ind3 <- full_join(m2dma_stan_ind2,m2error3.4,by = intersect(names(m2error3.4),names(m2dma_stan_ind2)))

m2dma_stan_ind <- full_join(m2dma_stan_ind3,m2error3.5,by = intersect(names(m2error3.5),names(m2dma_stan_ind3)))


m2error_0_2_dma_stand_cont_ind <- full_join(m2error_0_2_dma_stand_cont,m2dma_stan_ind,by = intersect(names(m2error_0_2_dma_stand_cont),names(m2dma_stan_ind)))


#check if standardized site comparison was entered if both sites were tested

m2error6 <-  m2dma.baseline %>% 
  filter(dmatestcompyn == 1 & is.na(dmasenscompare)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmasenscompare.factor) %>% 
  mutate(dmasenscompare.factor = case_when(is.na(dmasenscompare.factor) ~ "missing",TRUE ~ as.character(dmasenscompare.factor)))

m2error_0_2_dma_stand_cont_ind_6 <- full_join(m2error6,m2error_0_2_dma_stand_cont_ind,by = intersect(names(m2error6),names(m2error_0_2_dma_stand_cont_ind)))


#DMA at 3 months
#filter only 3 months records


m2dma.3mon <- qdatam2  %>%
  filter(redcap_event_name == "3mo_postop_arm_1" )

m2check1 <- m2dma.3mon  %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1,dmatestcompwhich_3m___1.factor,dmatestcompwhich_3m___2,dmatestcompwhich___2.factor,dmatestcompwhich_3m___3,dmatestcompwhich_3m___3.factor,dmatestcompwhich_3m___4,dmatestcompwhich_3m___4.factor)


# IF DMA standardized and patient specific performed but DMA complete was missing

m2error.3mon_1 <- m2dma.3mon %>%
  filter(!is.na(dmacontr1pain |  dmacontr1pain_d | dmacontr2pain| dmacontr2pain_d | dmacontr3pain | dmacontr3pain_d|dmacontr4pain | dmacontr4pain_d |dmacontr5pain 
                | dmacontr5pain_d | dmaindxr1pain | dmaindxr1pain_d |dmaindxr2pain | dmaindxr2pain_d  |  dmaindxr3pain   |
                  dmaindxr3pain_d   |     dmaindxr4pain | dmaindxr4pain_d    |    dmaindxr5pain | dmaindxr5pain_d     |   dmasenscompare   |
                  dmaptcontr1pain |  dmaptcontr1pain_d      |     dmaptcontr2pain     |   dmaptcontr2pain_d  |    dmaptcontr3pain   |     dmaptcontr3pain_d   |
                  dmaptcontr4pain|  dmaptcontr4pain_d      |     dmaptcontr5pain    |    dmaptcontr5pain_d  |    dmaptindxr1pain      |  dmaptindxr1pain_d    |
                  dmaptindxr2pain|  dmaptindxr2pain_d     |   dmaptindxr3pain     |   dmaptindxr3pain_d  |    dmaptindxr4pain  |      dmaptindxr4pain_d   |
                  dmaptindxr5pain |  dmaptindxr5pain_d)) %>% 
  filter(is.na(dmatestcompyn_3m))  %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor) %>%
  mutate(dmatestcompyn_3m.factor = case_when(is.na(dmatestcompyn_3m.factor) ~ "missing",TRUE ~ as.character(dmatestcompyn_3m.factor)))


# check if all sites checked and dmawhich1 and dmawchich2 both checked as well

m2error3mon_2 <- m2dma.3mon %>%
  filter (dmatestcompyn_3m == 1 & (dmatestcompwhich_3m___2 == 1 | dmatestcompwhich_3m___1 == 1 | dmatestcompwhich_3m___3 == 1 |dmatestcompwhich_3m___4 == 1)) %>%
  select(record_id,redcap_event_name, dmatestcompwhich_3m___1 ,dmatestcompwhich_3m___2, dmatestcompwhich_3m___3,dmatestcompwhich_3m___4,dmatestcompyn_3m.factor)


m2error3mon1_2 <- full_join(m2error.3mon_1,m2error3mon_2,by = intersect(names(m2error.3mon_1),names(m2error3mon_2)))


#Remove records with missing "DMA test completed"

m2dma.3mon1 <- m2dma.3mon %>% 
  filter(!is.na(dmatestcompyn_3m))


#New chest pain since surgery?"
m2error3mon_3 <- m2dma.3mon1 %>%
  filter(is.na(pmachgchestpainyn)) %>%
  select(record_id,redcap_event_name,pmachgchestpainyn.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor)))



m2error3mon1_3 <- full_join(m2error3mon1_2,m2error3mon_3,by = intersect(names(m2error3mon1_2),names(m2error3mon_3)))

#  If there is new chest pain AND if General region of pain is NA"
m2error3mon_4 <- m2dma.3mon1 %>%
  filter(pmachgchestpainyn==1 & is.na(pmapainregion)) %>%
  select(record_id,redcap_event_name,pmapainregion.factor,pmachgchestpainyn.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor)))


m2error3mon1_4 <- full_join(m2error3mon1_3,m2error3mon_4,by = intersect(names(m2error3mon1_3),names(m2error3mon_4)))

#3. Highest pain location",#  If there is new chest pain and highest pain location is NA"
m2error3mon_5<- m2dma.3mon1 %>% 
  filter(pmachgchestpainyn==1 & !is.na(pmapainregion) & is.na(pmahighestloc)) %>% 
  select(record_id,redcap_event_name,pmapainregion.factor,pmachgchestpainyn.factor,pmahighestloc.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor))) %>% 
  mutate(pmahighestloc.factor= case_when(is.na(pmahighestloc.factor) ~ "missing",TRUE ~ as.character(pmahighestloc.factor)))


m2error3mon1_5 <- full_join(m2error3mon1_4,m2error3mon_5,by = intersect(names(m2error3mon1_4),names(m2error3mon_5)))


#4. Lowest pain location", If there is new chest pain and lowest pain location is NA"
m2error3mon_6 <- m2dma.3mon1 %>% 
  filter(pmachgchestpainyn==1 & is.na(pmalowestloc)) %>% 
  select(record_id,redcap_event_name,pmapainregion.factor,pmachgchestpainyn.factor,pmalowestloc.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor))) %>% 
  mutate(pmalowestloc.factor= case_when(is.na(pmalowestloc.factor) ~ "missing",TRUE ~ as.character(pmalowestloc.factor)))

m2error3mon1_6 <- full_join(m2error3mon1_5,m2error3mon_6,by = intersect(names(m2error3mon1_5),names(m2error3mon_6)))


# # 5. Most painful region:"If there is new chest pain and most painful region is NA"
m2error3mon_7 <- m2dma.3mon1 %>%
  filter(pmachgchestpainyn==1 & is.na(pmamostpain)) %>%
  select(record_id,redcap_event_name,pmachgchestpainyn.factor,pmapainregion.factor,pmamostpain.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor))) %>% 
  mutate(pmamostpain.factor= case_when(is.na(pmamostpain.factor) ~ "missing",TRUE ~ as.character(pmamostpain.factor)))


m2error3mon1_7 <- full_join(m2error3mon1_6,m2error3mon_7,by = intersect(names(m2error3mon1_6),names(m2error3mon_7)))

# # post surgery specific procedures (refer pg 144 MOP veersion 3)


#check if all sites checked  and no  mismatch or missing pain data for standardized contralateral site
#rep1
m2error3mon_8 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff1 = dmacontr1pain - dmacontr1pain_d) %>%
  filter(dma3_stand_cont_diff1 != 0 | is.na(dma3_stand_cont_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr1pain,dmacontr1pain_d) %>%
  mutate(dmacontr1pain = case_when(is.na(dmacontr1pain) ~ "missing",TRUE ~ as.character(dmacontr1pain))) %>%
  mutate(dmacontr1pain_d= case_when(is.na(dmacontr1pain_d) ~ "missing",TRUE ~ as.character(dmacontr1pain_d) ))
#merge
m2error3mon1_8 <- full_join(m2error3mon1_7,m2error3mon_8,by = intersect(names(m2error3mon1_7),names(m2error3mon_8)))


#rep2
m2error3mon_9 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff2 = dmacontr2pain - dmacontr2pain_d) %>%
  filter(dma3_stand_cont_diff2 != 0 | is.na(dma3_stand_cont_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr2pain,dmacontr2pain_d) %>%
  mutate(dmacontr2pain = case_when(is.na(dmacontr2pain) ~ "missing",TRUE ~ as.character(dmacontr2pain))) %>%
  mutate(dmacontr2pain_d= case_when(is.na(dmacontr2pain_d) ~ "missing",TRUE ~ as.character(dmacontr2pain_d) ))
# 
#merge
m2error3mon1_9 <- full_join(m2error3mon1_8,m2error3mon_9,by = intersect(names(m2error3mon1_8),names(m2error3mon_9)))
#rep3

m2error3mon_10 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 )) %>% 
  mutate(dma3_stand_cont_diff3 = dmacontr3pain - dmacontr3pain_d) %>%
  filter(dma3_stand_cont_diff3 != 0 | is.na(dma3_stand_cont_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr3pain,dmacontr3pain_d) %>%
  mutate(dmacontr3pain = case_when(is.na(dmacontr3pain) ~ "missing",TRUE ~ as.character(dmacontr3pain))) %>%
  mutate(dmacontr3pain_d= case_when(is.na(dmacontr3pain_d) ~ "missing",TRUE ~ as.character(dmacontr3pain_d) ))

m2error3mon1_10 <- full_join(m2error3mon1_9,m2error3mon_10,by = intersect(names(m2error3mon1_9),names(m2error3mon_10)))


#rep4

m2error3mon_11 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff4 = dmacontr4pain - dmacontr4pain_d) %>%
  filter(dma3_stand_cont_diff4 != 0 | is.na(dma3_stand_cont_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr4pain,dmacontr4pain_d) %>%
  mutate(dmacontr4pain = case_when(is.na(dmacontr4pain) ~ "missing",TRUE ~ as.character(dmacontr4pain))) %>%
  mutate(dmacontr4pain_d= case_when(is.na(dmacontr4pain_d) ~ "missing",TRUE ~ as.character(dmacontr4pain_d) ))

m2error3mon1_11 <- full_join(m2error3mon1_10,m2error3mon_11,by = intersect(names(m2error3mon1_10),names(m2error3mon_11)))


#rep5

m2error3mon_12 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff5 = dmacontr5pain - dmacontr5pain_d) %>%
  filter(dma3_stand_cont_diff5 != 0 | is.na(dma3_stand_cont_diff5)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr5pain,dmacontr5pain_d) %>%
  mutate(dmacontr5pain = case_when(is.na(dmacontr5pain) ~ "missing",TRUE ~ as.character(dmacontr5pain))) %>%
  mutate(dmacontr5pain_d= case_when(is.na(dmacontr5pain_d) ~ "missing",TRUE ~ as.character(dmacontr5pain_d) ))
# 
#   
m2error3mon1_12 <- full_join(m2error3mon1_11,m2error3mon_12,by = intersect(names(m2error3mon1_11),names(m2error3mon_12))) 
# 

# #check if all sites checked  and no  mismatch or missing pain data for standardized index site
# #rep1
m2error3mon_13 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>% 
  mutate(dma3_stand_ind_diff1 = dmaindxr1pain - dmaindxr1pain_d) %>%
  filter(dma3_stand_ind_diff1 != 0 | is.na(dma3_stand_ind_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr1pain,dmaindxr1pain_d) %>%
  mutate(dmaindxr1pain = case_when(is.na(dmaindxr1pain) ~ "missing",TRUE ~ as.character(dmaindxr1pain))) %>%
  mutate(dmaindxr1pain_d= case_when(is.na(dmaindxr1pain_d) ~ "missing",TRUE ~ as.character(dmaindxr1pain_d) ))

m2error3mon1_13 <- full_join(m2error3mon1_12,m2error3mon_13,by = intersect(names(m2error3mon1_12),names(m2error3mon_13))) 
# 
# #rep2
m2error3mon_14 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff2 = dmaindxr2pain - dmaindxr2pain_d) %>%
  filter(dma3_stand_ind_diff2 != 0 | is.na(dma3_stand_ind_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr2pain,dmaindxr2pain_d) %>%
  mutate(dmaindxr2pain = case_when(is.na(dmaindxr2pain) ~ "missing",TRUE ~ as.character(dmaindxr2pain))) %>%
  mutate(dmaindxr2pain_d= case_when(is.na(dmaindxr2pain_d) ~ "missing",TRUE ~ as.character(dmaindxr2pain_d) ))

m2error3mon1_14 <- full_join(m2error3mon1_13,m2error3mon_14,by = intersect(names(m2error3mon1_13),names(m2error3mon_14))) 
# #rep3
# 
m2error3mon_15 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff3 = dmaindxr3pain - dmaindxr3pain_d) %>%
  filter(dma3_stand_ind_diff3 != 0 | is.na(dma3_stand_ind_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr3pain,dmaindxr3pain_d) %>%
  mutate(dmaindxr3pain = case_when(is.na(dmaindxr3pain) ~ "missing",TRUE ~ as.character(dmaindxr3pain))) %>%
  mutate(dmaindxr3pain_d= case_when(is.na(dmaindxr3pain_d) ~ "missing",TRUE ~ as.character(dmaindxr3pain_d) ))

m2error3mon1_15 <- full_join(m2error3mon1_14,m2error3mon_15,by = intersect(names(m2error3mon1_14),names(m2error3mon_15))) 


# #rep4
# 
m2error3mon_16 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff4 = dmaindxr4pain - dmaindxr4pain_d) %>%
  filter(dma3_stand_ind_diff4 != 0 | is.na(dma3_stand_ind_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr4pain,dmaindxr4pain_d) %>%
  mutate(dmaindxr4pain = case_when(is.na(dmaindxr4pain) ~ "missing",TRUE ~ as.character(dmaindxr4pain))) %>%
  mutate(dmaindxr4pain_d= case_when(is.na(dmaindxr4pain_d) ~ "missing",TRUE ~ as.character(dmaindxr4pain_d) ))

m2error3mon1_16 <- full_join(m2error3mon1_15,m2error3mon_16,by = intersect(names(m2error3mon1_15),names(m2error3mon_16))) 


# #rep5
m2error3mon_17 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1))%>%
  mutate(dma3_stand_ind_diff5 = dmaindxr5pain - dmaindxr5pain_d) %>%
  filter(dma3_stand_ind_diff5 != 0 | is.na(dma3_stand_ind_diff5)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr5pain,dmaindxr5pain_d) %>%
  mutate(dmaindxr5pain = case_when(is.na(dmaindxr5pain) ~ "missing",TRUE ~ as.character(dmaindxr5pain))) %>%
  mutate(dmaindxr5pain_d= case_when(is.na(dmaindxr5pain_d) ~ "missing",TRUE ~ as.character(dmaindxr5pain_d) ))

m2error3mon1_17 <- full_join(m2error3mon1_16,m2error3mon_17,by = intersect(names(m2error3mon1_16),names(m2error3mon_17))) 

# #check if standardized site comparison was entered if both sites were tested
# 
m2error3mon_28 <-  m2dma.3mon1 %>% 
  filter(dmatestcompyn_3m == 1 |(dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 ==  1) & (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>% 
  filter (is.na(dmasenscompare)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmatestcompwhich_3m___2.factor,dmasenscompare.factor) %>% 
  mutate(dmasenscompare.factor = case_when(is.na(dmasenscompare.factor) ~ "missing",TRUE ~ as.character(dmasenscompare.factor)))

m2error3mon1_28 <- full_join(m2error3mon1_17,m2error3mon_28,by = intersect(names(m2error3mon1_17),names(m2error3mon_28))) 

# #begin checks for 3 month DMA pt specific site


# #check if all or some sites checked  and no  mismatch or missing pain data for pt contralateral site
# #rep1
m2error3mon_29 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff1 = dmaptcontr1pain - dmaptcontr1pain_d) %>%
  filter(dma3pt_stand_cont_diff1 != 0 | is.na(dma3pt_stand_cont_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr1pain,dmaptcontr1pain_d) %>%
  mutate(dmaptcontr1pain = case_when(is.na(dmaptcontr1pain) ~ "missing",TRUE ~ as.character(dmaptcontr1pain))) %>%
  mutate(dmaptcontr1pain_d= case_when(is.na(dmaptcontr1pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr1pain_d) ))

m2error3mon1_29 <- full_join(m2error3mon1_28,m2error3mon_29,by = intersect(names(m2error3mon1_28),names(m2error3mon_29))) 

# #rep2
m2error3mon_30 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff2 = dmaptcontr2pain - dmaptcontr2pain_d) %>%
  filter(dma3pt_stand_cont_diff2 != 0 | is.na(dma3pt_stand_cont_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr2pain,dmaptcontr2pain_d) %>%
  mutate(dmaptcontr2pain = case_when(is.na(dmaptcontr2pain) ~ "missing",TRUE ~ as.character(dmaptcontr2pain))) %>%
  mutate(dmaptcontr2pain_d= case_when(is.na(dmaptcontr2pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr2pain_d) ))

m2error3mon1_30 <- full_join(m2error3mon1_29,m2error3mon_30,by = intersect(names(m2error3mon1_29),names(m2error3mon_30)))  
# 
# #rep3
# 
m2error3mon_31 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff3 = dmaptcontr3pain - dmaptcontr3pain_d) %>%
  filter(dma3pt_stand_cont_diff3 != 0 | is.na(dma3pt_stand_cont_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr3pain,dmaptcontr3pain_d) %>%
  mutate(dmaptcontr3pain = case_when(is.na(dmaptcontr3pain) ~ "missing",TRUE ~ as.character(dmaptcontr3pain))) %>%
  mutate(dmaptcontr3pain_d= case_when(is.na(dmaptcontr3pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr3pain_d) ))

m2error3mon1_31 <- full_join(m2error3mon1_30,m2error3mon_31,by = intersect(names(m2error3mon1_30),names(m2error3mon_31)))  

# #rep4
# 
m2error3mon_32 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff4 = dmaptcontr4pain - dmaptcontr4pain_d) %>%
  filter(dma3pt_stand_cont_diff4 != 0 | is.na(dma3pt_stand_cont_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr4pain,dmaptcontr4pain_d) %>%
  mutate(dmaptcontr4pain = case_when(is.na(dmaptcontr4pain) ~ "missing",TRUE ~ as.character(dmaptcontr4pain))) %>%
  mutate(dmaptcontr4pain_d= case_when(is.na(dmaptcontr4pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr4pain_d) ))
# 
m2error3mon1_32 <- full_join(m2error3mon1_31,m2error3mon_32,by = intersect(names(m2error3mon1_31),names(m2error3mon_32))) 
# #rep5
# 
m2error3mon_33 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1)) %>%
  mutate(dma3pt_stand_cont_diff5 = dmaptcontr5pain - dmaptcontr5pain_d) %>%
  filter(dma3pt_stand_cont_diff5 != 0 | is.na(dma3pt_stand_cont_diff5)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr5pain,dmaptcontr5pain_d) %>%
  mutate(dmaptcontr5pain = case_when(is.na(dmaptcontr5pain) ~ "missing",TRUE ~ as.character(dmaptcontr5pain))) %>%
  mutate(dmaptcontr5pain_d= case_when(is.na(dmaptcontr5pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr5pain_d) ))

m2error3mon1_33 <- full_join(m2error3mon1_32,m2error3mon_33,by = intersect(names(m2error3mon1_32),names(m2error3mon_33)))  
#   
# 
# 

# #check if all sites checked or some sites checked  and no  mismatch or missing pain data for pt index site
# #rep1
m2error3mon_34 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff1 = dmaptindxr1pain - dmaptindxr1pain_d) %>%
  filter(dma3pt_stand_ind_diff1 != 0 | is.na(dma3pt_stand_ind_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr1pain,dmaptindxr1pain_d) %>%
  mutate(dmaptindxr1pain = case_when(is.na(dmaptindxr1pain) ~ "missing",TRUE ~ as.character(dmaptindxr1pain))) %>%
  mutate(dmaptindxr1pain_d= case_when(is.na(dmaptindxr1pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr1pain_d) ))


m2error3mon1_34 <- full_join(m2error3mon1_33,m2error3mon_34,by = intersect(names(m2error3mon1_33),names(m2error3mon_34)))  

# #rep2
m2error3mon_35 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff2 = dmaptindxr2pain - dmaptindxr2pain_d) %>%
  filter(dma3pt_stand_ind_diff2 != 0 | is.na(dma3pt_stand_ind_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr2pain,dmaptindxr2pain_d) %>%
  mutate(dmaptindxr2pain = case_when(is.na(dmaptindxr2pain) ~ "missing",TRUE ~ as.character(dmaptindxr2pain))) %>%
  mutate(dmaptindxr2pain_d= case_when(is.na(dmaptindxr2pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr2pain_d) ))

m2error3mon1_35 <- full_join(m2error3mon1_34,m2error3mon_35,by = intersect(names(m2error3mon1_34),names(m2error3mon_35)))   
# 
# 
# #rep3
# 
m2error3mon_36 <-  m2dma.3mon1 %>% 
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff3 = dmaptindxr3pain - dmaptindxr3pain_d) %>%
  filter(dma3pt_stand_ind_diff3 != 0 | is.na(dma3pt_stand_ind_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr3pain,dmaptindxr3pain_d) %>%
  mutate(dmaptindxr3pain = case_when(is.na(dmaptindxr3pain) ~ "missing",TRUE ~ as.character(dmaptindxr3pain))) %>%
  mutate(dmaptindxr3pain_d= case_when(is.na(dmaptindxr3pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr3pain_d) ))

m2error3mon1_36 <- full_join(m2error3mon1_35,m2error3mon_36,by = intersect(names(m2error3mon1_35),names(m2error3mon_36)))   
# 
# #rep4
# 
m2error3mon_37 <-  m2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff4 = dmaptindxr4pain - dmaptindxr4pain_d) %>%
  filter(dma3pt_stand_ind_diff4 != 0 | is.na(dma3pt_stand_ind_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr4pain,dmaptindxr4pain_d) %>%
  mutate(dmaptindxr4pain = case_when(is.na(dmaptindxr4pain) ~ "missing",TRUE ~ as.character(dmaptindxr4pain))) %>%
  mutate(dmaptindxr4pain_d= case_when(is.na(dmaptindxr4pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr4pain_d) ))
# 
m2error3mon1_37 <- full_join(m2error3mon1_36,m2error3mon_37,by = intersect(names(m2error3mon1_36),names(m2error3mon_37)))    
# #rep5
# 
m2error3mon_38 <-  m2dma.3mon1 %>%  
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff5 = dmaptindxr5pain - dmaptindxr5pain_d) %>% 
  filter(dma3pt_stand_ind_diff5 != 0 | is.na(dma3pt_stand_ind_diff5)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr5pain,dmaptindxr5pain_d) %>%  
  mutate(dmaptindxr5pain = case_when(is.na(dmaptindxr5pain) ~ "missing",TRUE ~ as.character(dmaptindxr5pain))) %>%  
  mutate(dmaptindxr5pain_d= case_when(is.na(dmaptindxr5pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr5pain_d) ))  

m2error3mon1_38 <- full_join(m2error3mon1_37,m2error3mon_38,by = intersect(names(m2error3mon1_37),names(m2error3mon_38)))  


#check if pt specific site comparison was entered if both sites were tested or patient specific sites were assessed 
m2error3mon_49 <-  m2dma.3mon1 %>%  
  filter(dmatestcompyn_3m != 0 & dmaptspecsite_3m != 1) %>% 
  filter(is.na(dmaptsenscompare.factor)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmaptsenscompare.factor,dmaptspecsite_3m.factor) %>%
  mutate(dmaptsenscompare.factor = case_when(is.na(dmaptsenscompare.factor) ~ "missing",TRUE ~ as.character(dmaptsenscompare.factor))) 

m2error3mon1_49 <- full_join(m2error3mon1_38,m2error3mon_49,by = intersect(names(m2error3mon1_38),names(m2error3mon_49)))   


#check if pt specific site assessed  was entered if pt specific sites were tested  
m2error3mon_50 <-  m2dma.3mon1 %>%  
  filter(dmatestcompyn_3m == 1 |(dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1) & (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>% 
  filter(is.na(dmaptspecsite_3m)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmatestcompwhich_3m___4.factor,dmaptsenscompare.factor,dmaptspecsite_3m.factor) %>%
  mutate(dmaptspecsite_3m.factor = case_when(is.na(dmaptspecsite_3m.factor) ~ "missing",TRUE ~ as.character(dmaptspecsite_3m.factor))) 

m2error3mon1_50 <- full_join(m2error3mon1_49,m2error3mon_50,by = intersect(names(m2error3mon1_49),names(m2error3mon_50)))  



#merge 3 month and baseline errors

m2dma_baseline_3mon <- full_join(m2error3mon1_50 ,m2error_0_2_dma_stand_cont_ind_6,by = intersect(names(m2error3mon1_50 ),names(m2error_0_2_dma_stand_cont_ind_6)))



#rename DMA variables

m2dma_baseline_3mon1 <- m2dma_baseline_3mon %>%
  rename("1. New chest pain since surgery?"= pmachgchestpainyn.factor,
         "General region of pain"=pmapainregion.factor,
         "Highest pain location"= pmahighestloc.factor,
         "Lowest pain location"=pmalowestloc.factor,
         "Most painful region:"=pmamostpain.factor,
         "Rep 1:standardized contralateral"=dmacontr1pain,
         "Rep 1:standardized contralateral (double entry)"= dmacontr1pain_d,
         "Rep 2:standardized contralateral"=dmacontr2pain,
         "Rep 2:standardized contralateral (double entry)"=dmacontr2pain_d,
         "Rep 3:standardized contralateral"=dmacontr3pain,
         "Rep 3: standardized contralateral(double entry)"=dmacontr3pain_d,
         "Rep 4:standardized contralateral"=dmacontr4pain,
         "Rep 4:standardized contralateral (double entry)"=dmacontr4pain_d,
         "Rep 5:standardized contralateral"=dmacontr5pain,
         "Rep 5:standardized contralateral (double entry)"=dmacontr5pain_d,
         "Rep 1:standardized index"=dmaindxr1pain,
         "Rep 1:standardized index (double entry)"=dmaindxr1pain_d,
         "Rep 2:standardized index"=dmaindxr2pain,
         "Rep 2:standardized index (double entry)"=dmaindxr2pain_d,
         "Rep 3:standardized index"=dmaindxr3pain,
         "Rep 3: standardized index(double entry)"=dmaindxr3pain_d,
         "Rep 4:standardized index"=dmaindxr4pain,
         "Rep 4:standardized index (double entry)"=dmaindxr4pain_d,
         "Rep 5:standardized index"=dmaindxr5pain,
         "Rep 5: standardized index(double entry)"=dmaindxr5pain_d,
         "Sensation comparison standardized site"=dmasenscompare.factor,
         "Rep 1:Patient specific contralateral"=dmaptcontr1pain,
         "Rep 1: Patient specific contralateral(double entry)"=dmaptcontr1pain_d,
         "Rep 2:Patient specific contralateral"=dmaptcontr2pain,
         " Rep 2:Patient specific contralateral (double entry)"=dmaptcontr2pain_d,
         " Rep 3:Patient specific contralateral"=dmaptcontr3pain,
         " Rep 3:Patient specific contralateral (double entry)"=dmaptcontr3pain_d,
         " Rep 4:Patient specific contralateral"=dmaptcontr4pain,
         "Rep 4:Patient specific contralateral (double entry)"=dmaptcontr4pain_d,
         "Rep 5:Patient specific contralateral"=dmaptcontr5pain,
         "Rep 5:Patient specific contralateral (double entry)"=dmaptcontr5pain_d,
         "Rep 1:Patient specific index"=dmaptindxr1pain,
         "Rep 1:Patient specific index (double entry)"=dmaptindxr1pain_d,
         "Rep 2:Patient specific index"=dmaptindxr2pain,
         "Rep 2:Patient specific index (double entry)"=dmaptindxr2pain_d,
         "Rep 3:Patient specific index"=dmaptindxr3pain,
         "Rep 3:Patient specific index (double entry)"=dmaptindxr3pain_d,
         "Rep 4:Patient specific index"=dmaptindxr4pain,
         "Rep 4:Patient specific index (double entry)"=dmaptindxr4pain_d,
         "Rep 5:Patient specific index"=dmaptindxr5pain,
         "Rep 5:Patient specific index (double entry)"=dmaptindxr5pain_d,
         "Patient-Specific site assessed? (3-Month)"=dmaptspecsite_3m.factor,
         "Sensation comparison patient-specific site:"=dmaptsenscompare.factor,
         "DMA Test(s) completed"=dmatestcompyn.factor,
         "3 month DMA Test(s) completed"=dmatestcompyn_3m.factor,
         "Choose all completed sites: (Baseline) (choice=1. Standardized control site (contralateral))" =dmatestcompwhich___1.factor,
         "Choose all completed sites: (Baseline) (choice=2. Standardized index site (surgical))"=dmatestcompwhich___2.factor,
         "Choose all completed sites: (3-Month) (choice=1. Standardized control site (contralateral))"=dmatestcompwhich_3m___1.factor,
         "Choose all completed sites: (3-Month) (choice=2. Standardized index site (surgical))"=dmatestcompwhich_3m___2.factor,
         "Choose all completed sites: (3-Month) (choice=3. Patient specific control site (contralateral))"=dmatestcompwhich_3m___3.factor,
         "Choose all completed sites: (3-Month) (choice=4. Patient specific index site (surgical))"=dmatestcompwhich_3m___4.factor)







m2dma_baseline_3mon1 <- m2dma_baseline_3mon1 %>% 
  as_tibble() %>% 
  mutate_all(as.character)






#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2dma_baseline_3mon1[m2dma_baseline_3mon1 == ""] <- NA

m2dma_baseline_3mon1 <- m2dma_baseline_3mon1 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m2dma_notes <- qdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,dmanotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# now add notes


dma_shrink_notes  <- left_join(m2dma_baseline_3mon1,m2dma_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )



#PPTs


# Explore variables and check for missingness in "ppt test completed"

tabyl(qdatam2,pptcompleteyn,pptcompleteyn.factor,show_na= TRUE)


#Remove records with missing "ppt test completed"

m2data.ppt <- qdatam2 %>% 
  filter(!is.na(pptcompleteyn))

#recheck if NAs removed

tabyl(m2data.ppt,pptcompleteyn.factor,pptcompleteyn,show_na= TRUE)

# keep record with "ppt test completed"

m2ppt.complete <- m2data.ppt %>% 
  filter(pptcompleteyn != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site(chest):
#data$pptcompleteyn.factor = factor(data$pptcompleteyn,levels=c("1","2","3","0"))
#levels(data$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (chest)","no, neither site")

tabyl(m2ppt.complete,pptcompleteyn.factor,pptcompleteyn,show_na= TRUE)


#Remote site:
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral:

#rep1
m2errorppt2.1 <-  m2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremoter1val - pptremoter1val_d) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>% 
  mutate(pptremoter1val = case_when(is.na(pptremoter1val) ~ "missing",TRUE ~ as.character(pptremoter1val))) %>% 
  mutate(pptremoter1val_d = case_when(is.na(pptremoter1val_d) ~ "missing",TRUE ~ as.character(pptremoter1val_d) )) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter1val,pptremoter1val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremoter1val,"ppt remote rep1(double entry)"= pptremoter1val_d )) 


#rep2
m2errorppt2.2 <-  m2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremoter2val - pptremoter2val_d) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2)) %>% 
  mutate(pptremoter2val = case_when(is.na(pptremoter2val) ~ "missing",TRUE ~ as.character(pptremoter2val))) %>% 
  mutate(pptremoter2val_d = case_when(is.na(pptremoter2val_d) ~ "missing",TRUE ~ as.character(pptremoter2val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter2val,pptremoter2val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep2"= pptremoter2val,"ppt remote rep2(double entry)"= pptremoter2val_d ))



#rep3

m2errorppt2.3 <-  m2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremoter3val - pptremoter3val_d) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>% 
  mutate(pptremoter3val = case_when(is.na(pptremoter3val) ~ "missing",TRUE ~ as.character(pptremoter3val))) %>% 
  mutate(pptremoter3val_d = case_when(is.na(pptremoter3val_d) ~ "missing",TRUE ~ as.character(pptremoter3val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter3val,pptremoter3val_d)%>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep3"= pptremoter3val,"ppt remote rep3(double entry)"= pptremoter3val_d ))

m2errorppt2 <-  full_join(m2errorppt2.1,m2errorppt2.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,m2errorppt2.3,by= c("record_id","redcap_event_name","PPT test completed?")) 


#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site::

#rep1
m2errorppt3.1 <-  m2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff1 = pptindxr1val - pptindxr1val_d) %>% 
  filter(ppt_indexr_diff1 != 0 | is.na(ppt_indexr_diff1)) %>%
  mutate(pptindxr1val = case_when(is.na(pptindxr1val) ~ "missing",TRUE ~ as.character(pptindxr1val))) %>% 
  mutate(pptindxr1val_d = case_when(is.na(pptindxr1val_d) ~ "missing",TRUE ~ as.character(pptindxr1val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr1val,pptindxr1val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"= pptindxr1val,"ppt index rep1(double entry)"= pptindxr1val_d ))


#rep2
m2errorppt3.2 <-  m2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff2 = pptindxr2val - pptindxr2val_d) %>% 
  filter(ppt_indexr_diff2 != 0 | is.na(ppt_indexr_diff2)) %>% 
  mutate(pptindxr2val = case_when(is.na(pptindxr2val) ~ "missing",TRUE ~ as.character(pptindxr2val))) %>% 
  mutate(pptindxr2val_d = case_when(is.na(pptindxr2val_d) ~ "missing",TRUE ~ as.character(pptindxr2val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr2val,pptindxr2val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep2"= pptindxr2val,"ppt index rep2(double entry)"= pptindxr2val_d ))


#rep3

m2errorppt3.3 <-  m2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff3 = pptindxr3val - pptindxr3val_d) %>% 
  filter(ppt_indexr_diff3 != 0 | is.na(ppt_indexr_diff3)) %>% 
  mutate(pptindxr3val = case_when(is.na(pptindxr3val) ~ "missing",TRUE ~ as.character(pptindxr3val))) %>% 
  mutate(pptindxr3val_d = case_when(is.na(pptindxr3val_d) ~ "missing",TRUE ~ as.character(pptindxr3val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr3val,pptindxr3val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep3"= pptindxr3val,"ppt index rep3(double entry)"= pptindxr3val_d ))

m2errorppt3a <-  full_join(m2errorppt3.1,m2errorppt3.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,m2errorppt3.3,by= c("record_id","redcap_event_name","PPT test completed?")) 

#merge errorppt2 and 3a


m2errorppt2_3 <- full_join(m2errorppt2,m2errorppt3a,by = intersect(names(m2errorppt2), names(m2errorppt3a)))


#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 



m2errorppt3b.1 <- m2ppt.complete %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindxr1val) & !is.na(pptindxr1val_d))  | (!is.na(pptindxr2val)  & !is.na(pptindxr2val_d)) | (!is.na(pptindxr3val)  & !is.na(pptindxr3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr1val,pptindxr1val_d,pptindxr2val,pptindxr2val_d,pptindxr3val,pptindxr3val_d,index1) %>% 
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(as.character(.)))

m2errorppt3b.2 <- m2ppt.complete %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindxr1val) & is.na(pptindxr1val_d))  | (is.na(pptindxr2val)  & is.na(pptindxr2val_d)) | (is.na(pptindxr3val)  & is.na(pptindxr3val_d))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr1val,pptindxr1val_d,pptindxr2val,pptindxr2val_d,pptindxr3val,pptindxr3val_d,index2)

m2errorppt3b.2 <- m2errorppt3b.2 %>%
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



m2errorppt3b.3 <- m2ppt.complete %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremoter1val) & !is.na(pptremoter1val_d))  | (!is.na(pptremoter2val)  & !is.na(pptremoter2val_d)) | (!is.na(pptremoter3val)  & !is.na(pptremoter3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter1val,pptremoter1val_d,pptremoter2val,pptremoter2val_d,pptremoter3val,pptremoter3val_d,remote1) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(as.character(.)))

m2errorppt3b.4 <- m2ppt.complete %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremoter1val) & is.na(pptremoter1val_d))  | (is.na(pptremoter2val)  & is.na(pptremoter2val_d)) | (is.na(pptremoter3val)  & is.na(pptremoter3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter1val,pptremoter1val_d,pptremoter2val,pptremoter2val_d,pptremoter3val,pptremoter3val_d,remote2)


m2errorppt3b.4 <- m2errorppt3b.4 %>%
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



#merge errorppt 3
###########
m2errorppt3c <- full_join(m2errorppt3b.1,m2errorppt3b.2,by = intersect(names(m2errorppt3b.1), names(m2errorppt3b.2)))
m2errorppt3d <- full_join(m2errorppt3b.3,m2errorppt3b.4,by = intersect(names(m2errorppt3b.3), names(m2errorppt3b.4)))
# 
# ###########
m2errorppt3b <- full_join(m2errorppt3c,m2errorppt3d,by = intersect(names(m2errorppt3c), names(m2errorppt3d))) %>%
  select(c(-index1,-index2,-remote1,-remote2)) 


m2errorppt3b<- m2errorppt3b%>%
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"=pptindxr1val,"ppt index rep1(double entry)"= pptindxr1val_d,"ppt index rep2"= pptindxr2val,"ppt index rep2(double entry)"= pptindxr2val_d,"ppt index rep3"= pptindxr3val,"ppt index rep3(double entry)"= pptindxr3val_d,"ppt remote rep1"= pptremoter1val,"ppt remote rep1(double entry)"= pptremoter1val_d,"ppt remote rep2"= pptremoter2val,"ppt remote rep2(double entry)"= pptremoter2val_d,"ppt remote rep3"= pptremoter3val,"ppt remote rep3(double entry)"= pptremoter3val_d  ))


# 
# errorppt3b[] <- lapply(errorppt3b, as.character)
# errorppt2_3[] <- lapply(errorppt2_3, as.character)


m2errorppt2_3_3b <- full_join(m2errorppt2_3,m2errorppt3b,by = intersect(names(m2errorppt2_3), names(m2errorppt3b)))

# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


m2ppt.biomarker <- m2ppt.complete %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindxr1val,pptindxr2val,pptindxr3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindxr1val,pptindxr2val,pptindxr3val,pptcompleteyn.factor) %>% 
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


m2ppt.biomarker1 <- m2ppt.complete %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremoter1val,pptremoter2val,pptremoter3val,pptcompleteyn.factor) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2ppt.all.biomarker <- full_join(m2ppt.biomarker,m2ppt.biomarker1,by=c("record_id","redcap_event_name","pptcompleteyn.factor")) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremoter1val,"ppt remote rep2"= pptremoter2val,"ppt remote rep3"= pptremoter3val,"ppt index rep1"= pptindxr1val,"ppt index rep2"= pptindxr2val,"ppt index rep3"= pptindxr3val ))






m2all.ppt <- full_join(m2errorppt2_3_3b,m2ppt.all.biomarker,by = intersect(names(m2errorppt2_3_3b ), names(m2ppt.all.biomarker)))


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2all.ppt[m2all.ppt == ""] <- NA

m2all.ppt <- m2all.ppt %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m2ppt_notes <- qdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,pptnotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes


m2ppt_shrink_notes  <- left_join(m2all.ppt,m2ppt_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )


# MCC2 Temporal summation
#explore variables



#PPTs

# check for missingness in "ts test completed"

tabyl(qdatam2,tscompleted.factor,tscompleted,show_na= TRUE)


#Remove records with missing "ts test completed"

m2data.ts <- qdatam2 %>% 
  filter(!is.na(tscompleted))

#recheck if NAs removed

tabyl(m2data.ts,tscompleted,tscompleted.factor,show_na= TRUE)

# keep record with "tscompleted test completed"

m2ts.complete <- m2data.ts %>% 
  filter(tscompleted != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= yes atleast 1 rep for both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):


tabyl(m2ts.complete,tscompleted,tscompleted.factor,show_na= TRUE)

#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
m2errorppt4.1 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsremoter1initial - tsremoter1initial_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1)) %>% 
  mutate(tsremoter1initial = case_when(is.na(tsremoter1initial) ~ "missing",TRUE ~ as.character(tsremoter1initial))) %>% 
  mutate(tsremoter1initial_d = case_when(is.na(tsremoter1initial_d) ~ "missing",TRUE ~ as.character(tsremoter1initial_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1initial_d,tscompleted) 


#rep1 final
m2errorppt4.2 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsremoter1final - tsremoter1final_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  mutate(tsremoter1final = case_when(is.na(tsremoter1final) ~ "missing",TRUE ~ as.character(tsremoter1final))) %>% 
  mutate(tsremoter1final_d = case_when(is.na(tsremoter1final_d) ~ "missing",TRUE ~ as.character(tsremoter1final_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1final,tsremoter1final_d,tscompleted) 


#rep1 set 
m2rep1.set <- full_join(m2errorppt4.1,m2errorppt4.2,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#rep2 initial

m2errorppt4.3 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsremoter2initial - tsremoter2initial_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  mutate(tsremoter2initial = case_when(is.na(tsremoter2initial) ~ "missing",TRUE ~ as.character(tsremoter2initial))) %>% 
  mutate(tsremoter2initial_d = case_when(is.na(tsremoter2initial_d) ~ "missing",TRUE ~ as.character(tsremoter2initial_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter2initial,tsremoter2initial_d,tscompleted) 

#rep2 final
m2errorppt4.4 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsremoter2final - tsremoter2final_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  mutate(tsremoter2final = case_when(is.na(tsremoter2final) ~ "missing",TRUE ~ as.character(tsremoter2final))) %>% 
  mutate(tsremoter2final_d = case_when(is.na(tsremoter2final_d) ~ "missing",TRUE ~ as.character(tsremoter2final_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter2final,tsremoter2final_d,tscompleted) 

#rep2 set 

m2rep2.set <- full_join(m2errorppt4.3,m2errorppt4.4,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


#rep3 initial

m2errorppt4.5 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsremoter3initial - tsremoter3initial_d) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>% 
  mutate(tsremoter3initial = case_when(is.na(tsremoter3initial) ~ "missing",TRUE ~ as.character(tsremoter3initial))) %>% 
  mutate(tsremoter3initial_d = case_when(is.na(tsremoter3initial_d) ~ "missing",TRUE ~ as.character(tsremoter3initial_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter3initial,tsremoter3initial_d,tscompleted) 

#rep3 final
m2errorppt4.6 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsremoter3final - tsremoter3final_d) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3)) %>% 
  mutate(tsremoter3final = case_when(is.na(tsremoter3final) ~ "missing",TRUE ~ as.character(tsremoter3final))) %>% 
  mutate(tsremoter3final_d = case_when(is.na(tsremoter3final_d) ~ "missing",TRUE ~ as.character(tsremoter3final_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter3final,tsremoter3final_d,tscompleted) 

#rep3 set 
m2rep3.set <- full_join(m2errorppt4.5,m2errorppt4.6,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

m2Ts_remote_all_reps1 <- full_join(m2rep1.set,m2rep2.set,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted")) %>% 
  full_join(.,m2rep3.set,by= c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
m2ts1 <- m2Ts_remote_all_reps1 %>% 
  mutate(rep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter1initial))  & (is.na(tsremoter1initial_d))  & (is.na(tsremoter1final)) & (is.na(tsremoter1final_d))~ 1,TRUE ~ 0)) %>% 
  mutate(rep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter2initial))  & (is.na(tsremoter2initial_d))  & (is.na(tsremoter2final)) & (is.na(tsremoter2final_d))~ 1,TRUE ~ 0)) %>% 
  mutate(rep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter3initial))  & (is.na(tsremoter3initial_d))  & (is.na(tsremoter3final)) & (is.na(tsremoter3final_d))~ 1,TRUE ~ 0))


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d ))

#index site Index site 

# check for missing or mismatch in pain ratings for  Index site in both site OR  Index site 

#rep1 initial
m2errorppt6.1 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsindxr1initial - tsindxr1initial_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  mutate(tsindxr1initial = case_when(is.na(tsindxr1initial) ~ "missing",TRUE ~ as.character(tsindxr1initial))) %>%
  mutate(tsindxr1initial_d = case_when(is.na(tsindxr1initial_d) ~ "missing",TRUE ~ as.character(tsindxr1initial_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1initial,tsindxr1initial_d,tscompleted)

#rep1 final 

m2errorppt6.2 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsindxr1final - tsindxr1final_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  mutate(tsindxr1final = case_when(is.na(tsindxr1final) ~ "missing",TRUE ~ as.character(tsindxr1final))) %>%
  mutate(tsindxr1final_d = case_when(is.na(tsindxr1final_d) ~ "missing",TRUE ~ as.character(tsindxr1final_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1final,tsindxr1final_d,tscompleted)



#rep1 set 
m2rep1.index.set <- full_join(m2errorppt6.1,m2errorppt6.2,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

#rep2 initial

m2errorppt6.3 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsindxr2initial - tsindxr2initial_d) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>% 
  mutate(tsindxr2initial = case_when(is.na(tsindxr2initial) ~ "missing",TRUE ~ as.character(tsindxr2initial)))%>%
  mutate(tsindxr2initial_d = case_when(is.na(tsindxr2initial_d) ~ "missing",TRUE ~ as.character(tsindxr2initial_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr2initial,tsindxr2initial_d,tscompleted)


#rep2 final
m2errorppt6.4 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsindxr2final - tsindxr2final_d) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  mutate(tsindxr2final = case_when(is.na(tsindxr2final) ~ "missing",TRUE ~ as.character(tsindxr2final)))%>%
  mutate(tsindxr2final_d = case_when(is.na(tsindxr2final_d) ~ "missing",TRUE ~ as.character(tsindxr2final_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr2final,tsindxr2final_d,tscompleted)


#rep2 set 
m2rep2.index.set <- full_join(m2errorppt6.3,m2errorppt6.4,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))


#rep3 initial

m2errorppt6.5 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsindxr3initial - tsindxr3initial_d) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>% 
  mutate(tsindxr3initial = case_when(is.na(tsindxr3initial) ~ "missing",TRUE ~ as.character(tsindxr3initial)))%>%
  mutate(tsindxr3initial_d = case_when(is.na(tsindxr3initial_d) ~ "missing",TRUE ~ as.character(tsindxr3initial_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr3initial,tsindxr3initial_d,tscompleted) 

#rep3 final
m2errorppt6.6 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsindxr3final - tsindxr3final_d) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  mutate(tsindxr3final = case_when(is.na(tsindxr3final) ~ "missing",TRUE ~ as.character(tsindxr3final)))%>%
  mutate(tsindxr3final_d = case_when(is.na(tsindxr3final_d) ~ "missing",TRUE ~ as.character(tsindxr3final_d) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr3final,tsindxr3final_d,tscompleted) 

#rep3 set 
m2rep3.index.set <- full_join(m2errorppt6.5,m2errorppt6.6,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
m2Ts_index_all_reps1 <- full_join(m2rep1.index.set,m2rep2.index.set,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  full_join(.,m2rep3.index.set,by= c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0

m2ts.index1 <- m2Ts_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr1initial))  & (is.na(tsindxr1initial_d))  & (is.na(tsindxr1final)) & (is.na(tsindxr1final_d))~ 1,TRUE ~ 0)) 


m2ts.index1 <- m2ts.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr2initial))  & (is.na(tsindxr2initial_d))  & (is.na(tsindxr2final)) & (is.na(tsindxr2final_d))~ 1,TRUE ~ 0))


m2ts.index1 <- m2ts.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr3initial))  & (is.na(tsindxr3initial_d))  & (is.na(tsindxr3final)) & (is.na(tsindxr3final_d))~ 1,TRUE ~ 0))


# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d))



m2ts1 <- m2ts1 %>% 
  mutate(all.reps.rem = case_when(rep1 == 0  & rep2==0  & rep3==0  ~ 0,TRUE ~ 1))

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
m2ts.index1 <- m2ts.index1 %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == 0  & ind.rep2==0  & ind.rep3==0  ~ 0,TRUE ~ 1))
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
m2rem.ind <- full_join(m2ts1,m2ts.index1,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  filter((tscompleted == 2 & all.reps.rem == 0)| (tscompleted == 3 & all.reps.ind == 0) | (tscompleted == 1 & all.reps.rem == 0 |all.reps.ind == 0 ))


m2rem_index_all_reps <- m2rem.ind %>% 
  select(c(-tscompleted,-rep1,-rep2,-rep3,-all.reps.rem,-all.reps.ind,-ind.rep1,-ind.rep2,-ind.rep3)) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d))

# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

m2errorppt5.1 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsremoteafter15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoteafter15) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 15sec"= tsremoteafter15 )) %>% 
  mutate("TS remote after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
m2errorppt5.2 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts31)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremafts31) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 30sec"= tsfinalpainremafts31 ))  %>% 
  mutate("TS remote after sensation 30sec"=replace_na("missing")) 

# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# errorppt5.1[] <- lapply(errorppt5.1, as.character)
# errorppt5.2[] <- lapply(errorppt5.2, as.character)


m2Ts_remote_all_reps_sensations <- full_join(m2rem_index_all_reps,m2errorppt5.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,m2errorppt5.2,by= c("record_id","redcap_event_name","TS test completed?"))


# once TS  Index site is completed
# missing after sensation at 15 secs

m2errorppt7.1 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsindxafter15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxafter15)%>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 15sec"= tsindxafter15 )) %>% 
  mutate("TS index after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
m2errorppt7.2 <-  m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsindxafter30)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxafter30) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 30sec"= tsindxafter30 )) %>% 
  mutate("TS index after sensation 30sec"=replace_na("missing"))

# convert all char for merging
# Ts_remote_all_reps_sensations[] <- lapply(Ts_remote_all_reps_sensations, as.character)
# errorppt7.1[] <- lapply(errorppt7.1, as.character)
# errorppt7.2[] <- lapply(errorppt7.2, as.character)


#merge all
m2Ts_index_remote_all_reps_sensation <- full_join(m2Ts_remote_all_reps_sensations,m2errorppt7.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,m2errorppt7.2,by= c("record_id","redcap_event_name","TS test completed?"))


# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

m2errorppt7.3a <- m2ts.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsindxr1initial) & !is.na(tsindxr1initial_d))  | (!is.na(tsindxr1final)  & !is.na(tsindxr1final_d)) | (!is.na(tsindxr2initial )  & !is.na(tsindxr2initial_d)) | (!is.na(tsindxr2final) & !is.na(tsindxr2final_d))  | (!is.na(tsindxr3initial)  & !is.na(tsindxr3initial_d)) | (!is.na(tsindxr3final)  & !is.na(tsindxr3final_d))  ~ 1,TRUE ~ 0))  %>% 
  filter(ts.index1 == 1)  %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d) 
#OR b.if both sites was checked but pain ratings not filled out for the index site 


m2errorppt7.3b <- m2ts.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsindxr1initial) & is.na(tsindxr1initial_d)  & is.na(tsindxr1final)  & is.na(tsindxr1final_d) & is.na(tsindxr2initial )  & is.na(tsindxr2initial_d) & is.na(tsindxr2final) & is.na(tsindxr2final_d)  & is.na(tsindxr3initial)  & is.na(tsindxr3initial_d) & is.na(tsindxr3final)  & is.na(tsindxr3final_d)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )

# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 



m2errorppt7.4a <- m2ts.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsremoter1initial) & !is.na(tsremoter1initial_d))  | (!is.na(tsremoter1final)  & !is.na(tsremoter1final_d)) | (!is.na(tsremoter2initial)  & !is.na(tsremoter2initial_d)) | (!is.na(tsremoter2final) & !is.na(tsremoter2final_d))  | (!is.na(tsremoter3initial)  & !is.na(tsremoter3initial_d)) | (!is.na(tsremoter3final)  & !is.na(tsremoter3final_d))  ~ 1,TRUE ~ 0))  %>%
  filter(ts.remote1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d)


#OR b.if both sites was checked but pain ratings not filled out for the remote site


m2errorppt7.4b <- m2ts.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsremoter1initial) & is.na(tsremoter1initial_d)  & is.na(tsremoter1final)  & is.na(tsremoter1final_d) & is.na(tsremoter2initial)  & is.na(tsremoter2initial_d) & is.na(tsremoter2final) & is.na(tsremoter2final_d)  & is.na(tsremoter3initial)  & is.na(tsremoter3initial_d) & is.na(tsremoter3final)  & is.na(tsremoter3final_d)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d)%>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


#merge 7.3a,7.3b,7.4a,7.4b





m2errorppt7.3a[] <- lapply(m2errorppt7.3a, as.character)
m2errorppt7.3b[] <- lapply(m2errorppt7.3b, as.character)
m2errorppt7.4a[] <- lapply(m2errorppt7.4a, as.character)
m2errorppt7.4b[] <- lapply(m2errorppt7.4b, as.character)


m2merged7.3 <- full_join(m2errorppt7.3a,m2errorppt7.3b,by = intersect(names(m2errorppt7.3a), names(m2errorppt7.3b)))
m2merged7.4 <- full_join(m2errorppt7.4a,m2errorppt7.4b,by = intersect(names(m2errorppt7.4a), names(m2errorppt7.4b)))

m2merged7 <- full_join(m2merged7.3,m2merged7.4,by = intersect(names(m2merged7.3), names(m2merged7.4)))


#rename merged7
m2merged7.1 <- m2merged7 %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d))  

# change  to as.character for merging
m2Ts_index_remote_all_reps_sensation [] <- lapply(m2Ts_index_remote_all_reps_sensation , as.character)
m2merged7.1[] <- lapply(m2merged7.1, as.character)




#merge Ts_index_remote_all_reps_sensation and merged7.1 

m2merge8 <- full_join(m2merged7.1,m2Ts_index_remote_all_reps_sensation ,by = intersect(names(m2merged7.1), names(m2Ts_index_remote_all_reps_sensation )))


# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
m2prim.outcome.index <- m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsindxr1final,tsindxr1initial)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsindxr1initial) %>% 
  mutate(max.rep2.index = pmax(tsindxr2final,tsindxr2initial )) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsindxr2initial ) %>% 
  mutate(max.rep3.index = pmax(tsindxr3final,tsindxr3initial)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsindxr3initial) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsindxr1final,tsindxr1initial,tsindxr2final,tsindxr2initial ,tsindxr3final,tsindxr3initial)%>%
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2prim.outcome.remote <- m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsremoter1initial,tsremoter1final)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsremoter1initial) %>% 
  mutate(max.rep2.remote = pmax(tsremoter2initial,tsremoter2final)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsremoter2initial) %>% 
  mutate(max.rep3.remote = pmax(tsremoter3initial,tsremoter3final)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsremoter3initial) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1final,tsremoter2initial,tsremoter2final,tsremoter3initial,tsremoter3final)%>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2ts_primary_outcome <-  full_join(m2prim.outcome.index, m2prim.outcome.remote ,by = intersect(names( m2prim.outcome.remote), names(m2prim.outcome.index ))) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 final"= tsindxr1final,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 final"= tsindxr2final,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 final"= tsindxr3final,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 final"= tsremoter3final))  


# # change  to as.character for merging
m2merge8 [] <- lapply(m2merge8 , as.character)
m2ts_primary_outcome[] <- lapply(m2ts_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

m2ts.all.prim.outcome <- full_join(m2merge8,m2ts_primary_outcome ,by = intersect(names(m2merge8), names(m2ts_primary_outcome)))


# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m2sec.outcome.index <- m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsindxr1final,tsindxr1initial))) %>% 
  mutate(init.rep1.index1 = 1+(tsindxr1initial)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsindxr2final,tsindxr2initial ))) %>% 
  mutate(init.rep2.index1 = 1+(tsindxr2initial )) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsindxr3final,tsindxr3initial))) %>% 
  mutate(init.rep3.index1 = 1+(tsindxr3initial)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1final,tsindxr1initial,tsindxr2final,tsindxr2initial ,tsindxr3final,tsindxr3initial) %>%
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m2sec.outcome.remote <- m2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsremoter1initial,tsremoter1final))) %>% 
  mutate(init.rep1.remote1 = 1+(tsremoter1initial)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsremoter2initial,tsremoter2final))) %>% 
  mutate(init.rep2.remote1 = 1+(tsremoter2initial)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsremoter3initial,tsremoter3final))) %>% 
  mutate(init.rep3.remote1 = 1+(tsremoter3initial)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1final,tsremoter2initial,tsremoter2final,tsremoter3initial,tsremoter3final) %>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )

m2ts_sec_outcome <-  full_join(m2sec.outcome.index, m2sec.outcome.remote ,by = intersect(names( m2sec.outcome.remote), names(m2sec.outcome.index ))) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 final"= tsindxr1final,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 final"= tsindxr2final,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 final"= tsindxr3final,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 final"= tsremoter3final)) 



# change  to as.character for merging
m2ts_sec_outcome [] <- lapply(m2ts_sec_outcome , as.character)
m2ts.all.prim.outcome[] <- lapply(m2ts.all.prim.outcome, as.character)

#merge ts_sec_outcome  with ts.all.prim.outcome

m2ts.all.prim.sec.outcome <- full_join(m2ts_sec_outcome ,m2ts.all.prim.outcome ,by = intersect(names(m2ts_sec_outcome), names(m2ts.all.prim.outcome )))



m2ts.all.prim.sec.outcome <- m2ts.all.prim.sec.outcome %>%
  relocate("record_id","redcap_event_name","TS test completed?","TS index rep1 initial","TS index rep1 initial(double entry)","TS index rep1 final"
           ,"TS index rep1 final(double entry)","TS index rep2 initial",  "TS index rep2 initial(double entry)", "TS index rep2 final", "TS index rep2 final(double entry)","TS index rep3 initial","TS index rep3 initial(double entry)","TS index rep3 final", 
           "TS index rep3 final(double entry)" , "TS index after sensation 15sec","TS index after sensation 30sec","TS contralateral rep1 initial" , 
           "TS contralateral rep1 initial(double entry)", "TS contralateral rep1 final" ,"TS contralateral rep1 final(double entry)","TS contralateral rep2 initial","TS contralateral rep2 initial(double entry)","TS contralateral rep2 final" ,   "TS contralateral rep2 final(double entry)" ,"TS contralateral rep3 initial", "TS contralateral rep3 initial(double entry)", "TS contralateral rep3 final" ,  "TS contralateral rep3 final(double entry)" ,"TS remote after sensation 15sec" ,   "TS remote after sensation 30sec" )



m2ts.all.prim.sec.outcome[m2ts.all.prim.sec.outcome == ""] <- NA

m2all.ts <- m2ts.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m2ts_notes <- qdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,tsnotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes

m2ts_shrink_notes  <- left_join(m2all.ts,m2ts_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )




# mcc2 Conditioned Pain Modulation


# check for missingness in "cp test completed"

tabyl(qdatam2,cpmcompleteyn,cpmcompleteyn.factor,show_na= TRUE)


#Remove records with missing "cp test completed"

m2data1cp <- qdatam2 %>% 
  filter(!is.na(cpmcompleteyn))

#recheck if NAs removed

tabyl(m2data1cp,cpmcompleteyn,cpmcompleteyn.factor,show_na= TRUE)

# keep record with "cpm test completed"

m2cpm.complete <- m2data1cp %>% 
  filter(cpmcompleteyn != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):


tabyl(m2cpm.complete,cpmcompleteyn.factor,cpmcompleteyn,show_na= TRUE)


#water temp not checked

m2cpm.error1 <- m2cpm.complete %>% 
  filter(cpmcoldwatertemp != 1) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmcoldwatertemp) %>% 
  mutate(cpmcoldwatertemp = case_when(cpmcoldwatertemp != 1 ~ "missing",TRUE ~ as.character(cpmcoldwatertemp))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"confirm water temp"=cpmcoldwatertemp)

# missing or mismatch in cold water pain rating at 30 sec

m2cpm.error2 <- m2cpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30 - cpmcoldwaterpain30_d) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  mutate(cpmcoldwaterpain30 = case_when(is.na(cpmcoldwaterpain30) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30)))%>%
  mutate(cpmcoldwaterpain30_d = case_when(is.na(cpmcoldwaterpain30_d) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain30,cpmcoldwaterpain30_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 30 sec"=cpmcoldwaterpain30,"Cold Water Pain Rating at 30 sec(double entry)"=cpmcoldwaterpain30_d)



# missing or mismatch in cold water pain rating at 60 sec
m2cpm.error3 <- m2cpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60 - cpmcoldwaterpain60_d) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>% 
  mutate(cpmcoldwaterpain60 = case_when(is.na(cpmcoldwaterpain60) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60)))%>%
  mutate(cpmcoldwaterpain60_d = case_when(is.na(cpmcoldwaterpain60_d) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60_d))) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain60,cpmcoldwaterpain60_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 60 sec"=cpmcoldwaterpain60,"Cold Water Pain Rating at 60 sec(double entry)"=cpmcoldwaterpain60_d)


#merge error 2&3
m2errorcpm2_3 <- full_join(m2cpm.error2,m2cpm.error3,by = c("record_id","redcap_event_name","cpm test completed","water bath duration","if outside range: time")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

##merge error 1 with 2&3
m2errorcpm1_2_3 <- full_join(m2cpm.error1,m2errorcpm2_3,by = c("record_id","redcap_event_name","cpm test completed")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#check for missing/mismatch in ppts

m2cpm.error4.1 <- m2cpm.complete %>% 
  mutate(diff_cpm1 = cpmpptremr1val - cpmpptremr1val_d) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>% 
  mutate(cpmpptremr1val = case_when(is.na(cpmpptremr1val) ~ "missing",TRUE ~ as.character(cpmpptremr1val)))%>%
  mutate(cpmpptremr1val_d = case_when(is.na(cpmpptremr1val_d) ~ "missing",TRUE ~ as.character(cpmpptremr1val_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmpptremr1val,cpmpptremr1val_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmpptremr1val,"conditioned pain modulation PPT:rep1(double entry)"=cpmpptremr1val_d)

#check for missing/mismatch in ppts

m2cpm.error4.2 <- m2cpm.complete %>% 
  mutate(diff_cpm2 = cpmpptremr2val - cpmpptremr2val_d) %>% 
  filter(diff_cpm2!=0 | is.na(diff_cpm2)) %>% 
  mutate(cpmpptremr2val = case_when(is.na(cpmpptremr2val) ~ "missing",TRUE ~ as.character(cpmpptremr2val)))%>%
  mutate(cpmpptremr2val_d = case_when(is.na(cpmpptremr2val_d) ~ "missing",TRUE ~ as.character(cpmpptremr2val_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmpptremr2val,cpmpptremr2val_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep2"=cpmpptremr2val,"conditioned pain modulation PPT:rep2(double entry)"=cpmpptremr2val_d)


#check for missing/mismatch in ppts

m2cpm.error4.3 <- m2cpm.complete %>% 
  mutate(diff_cpm3 = cpmpptremr3val - cpmpptremr3val_d) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>% 
  mutate(cpmpptremr3val = case_when(is.na(cpmpptremr3val) ~ "missing",TRUE ~ as.character(cpmpptremr3val)))%>%
  mutate(cpmpptremr3val_d = case_when(is.na(cpmpptremr3val_d) ~ "missing",TRUE ~ as.character(cpmpptremr3val_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmpptremr3val,cpmpptremr3val_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep3"=cpmpptremr3val,"conditioned pain modulation PPT:rep3(double entry)"=cpmpptremr3val_d)


#merge 4.1-.3

m2cpm.error4 <- full_join(m2cpm.error4.1,m2cpm.error4.2,by = c("record_id","redcap_event_name","cpm test completed")) %>% 
  full_join(.,m2cpm.error4.3,by= c("record_id","redcap_event_name","cpm test completed")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2cpm.final <- full_join(m2cpm.error4,m2errorcpm1_2_3,by = c("record_id","redcap_event_name","cpm test completed"))




# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


m2cmp.prim.outcome <- m2cpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmpptremr1val,cpmpptremr2val,cpmpptremr3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremoter1val,pptremoter2val,pptremoter3val,cpmpptremr1val,cpmpptremr2val,cpmpptremr3val) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


m2cmp.sec.outcome <- m2cpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmpptremr1val,cpmpptremr2val,cpmpptremr3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremoter1val,pptremoter2val,pptremoter3val,cpmpptremr1val,cpmpptremr2val,cpmpptremr3val) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2cmp.outcome <- full_join(m2cmp.prim.outcome ,m2cmp.sec.outcome ,by = intersect(names(m2cmp.prim.outcome), names(m2cmp.sec.outcome))) %>%
  rename("cpm test completed"=cpmcompleteyn.factor,"PPT test completed?" = pptcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmpptremr1val,"conditioned pain modulation PPT:rep2"=cpmpptremr2val,
         "conditioned pain modulation PPT:rep3"=cpmpptremr3val,"ppt remote rep1"= pptremoter1val,"ppt remote rep2"= pptremoter2val,"ppt remote rep3"= pptremoter3val) 


#change  to as.character for merging
m2cmp.outcome [] <- lapply(m2cmp.outcome , as.character)
m2cpm.final[] <- lapply(m2cpm.final, as.character)

#merge all cmp errors

m2all.cmp <-  full_join(m2cmp.outcome ,m2cpm.final ,by = intersect(names(m2cmp.outcome), names(m2cpm.final))) %>% 
  relocate("record_id", "redcap_event_name","cpm test completed","PPT test completed?","ppt remote rep1","ppt remote rep2",   
           "ppt remote rep3","conditioned pain modulation PPT:rep1", "conditioned pain modulation PPT:rep1(double entry)",             
           "conditioned pain modulation PPT:rep2","conditioned pain modulation PPT:rep2(double entry)","conditioned pain modulation PPT:rep3",      "conditioned pain modulation PPT:rep3(double entry)","confirm water temp","water bath duration","Cold Water Pain Rating at 30 sec","Cold Water Pain Rating at 30 sec(double entry)","Cold Water Pain Rating at 60 sec","Cold Water Pain Rating at 60 sec(double entry)") %>% 
  arrange(record_id)




m2all.cmp[m2all.cmp == ""] <- NA

m2all.cmp <- m2all.cmp %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m2cmp_notes <- qdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,cpmnotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes

m2cpm_shrink_notes  <- left_join(m2all.cmp,m2cmp_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )





#link with imaging data

m2qst.img <- irimagingm2 



# select needed variables
m2data.image1 <- m2qst.img %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcontrarecal.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl,fmricuffipyn.factor,fmricuffcompletescl.factor)


m2data.qst <-  qdatam2 %>%
  select(record_id,redcap_event_name,redcap_data_access_group,cuffpfmricontraindyn.factor,cuffpfmricontrainddomyn,cuffpfmripressure,cuffpfmripressure_d,qst_mcc1_v03_complete)



# change  to as.character for merging
m2data.image1 [] <- lapply(m2data.image1 , as.character)
m2data.qst[] <- lapply(m2data.qst, as.character)

#merge both
m2qst.image <-  full_join(m2data.image1 ,m2data.qst ,by = intersect(names(m2data.image1), names(m2data.qst)))



#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging



m2qst.image1 <- m2qst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(cuffpfmripressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_data_access_group,redcap_event_name,fmricuffipyn.factor,fmricuffcompletescl.factor,cuffpfmricontraindyn.factor,cuffpfmricontrainddomyn,fmricuffcontrarecal.factor,cuffpfmripressure,cuffpfmripressure_d,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  mutate(cuffpfmricontraindyn.factor = case_when(is.na(cuffpfmricontraindyn.factor) ~ "missing",TRUE ~ as.character(cuffpfmricontraindyn.factor)))%>% 
  mutate(cuffpfmricontrainddomyn = case_when(is.na(cuffpfmricontrainddomyn) ~ "missing",TRUE ~ as.character(cuffpfmricontrainddomyn)))%>% 
  mutate(fmricuffcontrarecal.factor = case_when(is.na(fmricuffcontrarecal.factor) ~ "missing",TRUE ~ as.character(fmricuffcontrarecal.factor) )) %>% 
  mutate(cuffpfmripressure = case_when(is.na(cuffpfmripressure) ~ "missing",TRUE ~ as.character(cuffpfmripressure) )) %>% 
  mutate(cuffpfmripressure_d = case_when(is.na(cuffpfmripressure_d) ~ "missing",TRUE ~ as.character(cuffpfmripressure_d) )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal) )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2) )) %>%
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  rename ("qst cuff prssure C/I"=cuffpfmricontraindyn.factor,"image:Re-calibration of pressure needed:"=fmricuffcontrarecal.factor,"qst pressure1"=cuffpfmripressure,"qst pressure(double)"=cuffpfmripressure_d,"imaging recal pressure"=fmricuffcalfpressurerecal,"imaging recal pressure(double)"=fmricuffcalfpressurerecal2, "imaging_fMRI individualized pressure"=fmricuffipyn.factor,"Test Completed:"=fmricuffcompletescl.factor)


#create final mcc2 qst table for the app 

dma_shrink_notes1 <- dma_shrink_notes %>% 
  add_column(QST_test = "Dynamic_mechanical_allodynia")

m2ppt_shrink_notes1 <- m2ppt_shrink_notes %>% 
  add_column(QST_test = "MCC2_PPT") 

m2ts_shrink_notes1 <- m2ts_shrink_notes %>% 
  add_column(QST_test = "MCC2_Temporal_Summation") 

m2qst.image2 <- m2qst.image1 %>%   
  add_column(QST_test = "MCC2_No_Recal_pressure")

m2cpm_shrink_notes1 <- m2cpm_shrink_notes %>% 
  add_column(QST_test = "MCC2_Conditioned_Pain_Modulation")






m2trqst_table <- full_join(dma_shrink_notes1,m2ppt_shrink_notes1,by = intersect(names(dma_shrink_notes1), names(m2ppt_shrink_notes1
)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2trqst_table1 <- full_join(m2trqst_table,m2ts_shrink_notes1,by = intersect(names(m2trqst_table), names(m2ts_shrink_notes1)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2trqst_table2 <- full_join(m2trqst_table1,m2cpm_shrink_notes1,by = intersect(names(m2trqst_table1), names(m2cpm_shrink_notes1)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2tr_final_image <-  full_join(m2trqst_table2,m2qst.image2,by = intersect(names(m2trqst_table2), names(m2qst.image2))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group)) %>% 
  relocate(QST_test, .after = last_col()) %>% 
  mutate(QST_test=as.factor(QST_test)) %>% 
  left_join(.,m2days_from_sysdate, by=c("record_id","redcap_event_name"))


### surveys
# Ask hablar to guess most appropriate datatype
m2appdata.bpi <- retype(mcc2data)










#Check for subjects who did not complete the test.
table(m2appdata.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)




#remove records with missing values for test completed.
m2appdata.bpi2 <- m2appdata.bpi %>% 
  drop_na(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2appdata.bpi2$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2appdata.bpi3 <- m2appdata.bpi2 %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2)

#check
table(m2appdata.bpi3$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)





#if  average pain at a site was indicated but length of time was not indicated


m2error.bpi1 <- m2appdata.bpi3 %>%
  filter((!is.na(bpi_mbm_z1_rate) & bpi_mbm_z1_rate > 0 & is.na(bpi_mbm_z1_dur)) |(!is.na(bpi_mbm_z2_rate) & bpi_mbm_z2_rate > 0 & is.na(bpi_mbm_z2_dur)) |(!is.na(bpi_mbm_z3_rate) & bpi_mbm_z3_rate > 0 & is.na(bpi_mbm_z3_dur)) |(!is.na(bpi_mbm_z4_rate) & bpi_mbm_z4_rate > 0 & is.na(bpi_mbm_z4_dur)) |(!is.na(bpi_mbm_z5_rate) & bpi_mbm_z5_rate > 0 & is.na(bpi_mbm_z5_dur))|(!is.na(bpi_mbm_z6_rate) & bpi_mbm_z6_rate > 0 & is.na(bpi_mbm_z6_dur))|(!is.na(bpi_mbm_z7_rate) & bpi_mbm_z7_rate > 0 & is.na(bpi_mbm_z7_dur))|(!is.na(bpi_mbm_z8_rate) & bpi_mbm_z8_rate > 0 & is.na(bpi_mbm_z8_dur)) | (!is.na(bpi_mbm_z9_rate) & bpi_mbm_z9_rate > 0 & is.na(bpi_mbm_z9_dur))) %>% 
  select(record_id,redcap_event_name,bpi_mbm_z1_rate,bpi_mbm_z1_dur,bpi_mbm_z2_rate,bpi_mbm_z2_dur,bpi_mbm_z3_rate,bpi_mbm_z3_dur,bpi_mbm_z4_rate,bpi_mbm_z4_dur,bpi_mbm_z5_rate,bpi_mbm_z5_dur,bpi_mbm_z6_rate,bpi_mbm_z6_dur,bpi_mbm_z7_rate,bpi_mbm_z7_dur,bpi_mbm_z8_rate,bpi_mbm_z8_dur,bpi_mbm_z9_rate,bpi_mbm_z9_dur) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpi_mbm_z1 = case_when((is.na(bpi_mbm_z1_rate) & !is.na(bpi_mbm_z1_dur)) | (!is.na(bpi_mbm_z1_rate) & is.na(bpi_mbm_z1_dur))  ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z2 = case_when((is.na(bpi_mbm_z2_rate) & !is.na(bpi_mbm_z2_dur))| (!is.na(bpi_mbm_z2_rate) & is.na(bpi_mbm_z2_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z3 = case_when((is.na(bpi_mbm_z3_rate) & !is.na(bpi_mbm_z3_dur))| (!is.na(bpi_mbm_z3_rate) & is.na(bpi_mbm_z3_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z4 = case_when((is.na(bpi_mbm_z4_rate) & !is.na(bpi_mbm_z4_dur)) |(!is.na(bpi_mbm_z4_rate) & is.na(bpi_mbm_z4_dur))~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z5 = case_when((is.na(bpi_mbm_z5_rate) & !is.na(bpi_mbm_z5_dur))| (!is.na(bpi_mbm_z5_rate) & is.na(bpi_mbm_z5_dur))~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z6 = case_when((is.na(bpi_mbm_z6_rate) & !is.na(bpi_mbm_z6_dur))|(!is.na(bpi_mbm_z6_rate) & is.na(bpi_mbm_z6_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z7 = case_when((is.na(bpi_mbm_z7_rate) & !is.na(bpi_mbm_z7_dur))|(!is.na(bpi_mbm_z7_rate) & is.na(bpi_mbm_z7_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z8 = case_when((is.na(bpi_mbm_z8_rate) & !is.na(bpi_mbm_z8_dur))|(!is.na(bpi_mbm_z8_rate) & is.na(bpi_mbm_z8_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z9 = case_when((is.na(bpi_mbm_z9_rate) & !is.na(bpi_mbm_z9_dur)) |(!is.na(bpi_mbm_z9_rate) & is.na(bpi_mbm_z9_dur)) ~ "x",TRUE ~ "1")) %>% 
  select(record_id,redcap_event_name,bpi_mbm_z1,bpi_mbm_z2,bpi_mbm_z3,bpi_mbm_z4,bpi_mbm_z5,bpi_mbm_z6,bpi_mbm_z7,bpi_mbm_z8,bpi_mbm_z9)





# missing pain interference score
m2error.bpi2 <- m2appdata.bpi3 %>%
  select(record_id,redcap_event_name,bpipainintrfrscore) %>% 
  filter(is.na(bpipainintrfrscore)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpipainintrfrscore = case_when(is.na(bpipainintrfrscore) ~ "x"))

m2errorbpi1_2 <- full_join(m2error.bpi1,m2error.bpi2,by = intersect(names(m2error.bpi1), names(m2error.bpi2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols=3:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2bpi_complete = 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# recode 0,1 ie incomplete/unverified to 2
m2error.bpi3 <- m2appdata.bpi %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 0 |bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 1) %>% 
  mutate(m2bpi_complete = case_when(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 0 |bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete== 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2bpi_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)







#merge all
m2errorbpi1_3 <- full_join(m2errorbpi1_2,m2error.bpi3,by = intersect(names(m2errorbpi1_2), names(m2error.bpi3))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")




# recode NAs to 8 in the original dataset, select DAG as well
m2data.bpi <-mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete = case_when(is.na(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) ~ "8", TRUE ~ as.character(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) 


table(m2data.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,exclude = NULL)





#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2errorbpi1_3[m2errorbpi1_3== ""] <- NA


m2errorbpi1_3 <- m2errorbpi1_3 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# bpi_complete to account for records with missing completion data, where 1 is complete and complete plus m2errors, 2 is incomplete/unverified and 8 is NA)
m2full_bpi <- full_join(m2data.bpi,m2errorbpi1_3,by = intersect(names(m2data.bpi), names(m2errorbpi1_3))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2bpi_complete = case_when(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete  == "8" ~ "8", TRUE ~ as.character(m2bpi_complete))) %>% 
  replace(is.na(.), "1") %>% 
  select(-bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




table(m2full_bpi$m2bpi_complete,exclude = NULL) 





# create a dataset where 0=m2errors,1=clean,2=incomplete/unverified and 8 = NA
m2dat.bpi <- m2full_bpi %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 BPI") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2bpi_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 BPI") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.bpi = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


m2data_bpi <- m2dat.bpi %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2data_bpi$mb.bpi) 
table(mcc2data$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,exclude = NULL) 




#Read Data for GAD


m2data.anxiety <- mcc2data




#Check for subjects who did not complete the test.
table(m2data.anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)




#remove records with missing values for test completed.
m2data.anxiety2 <- m2data.anxiety %>% 
  drop_na(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete)






#Recheck if all records with missing m2data.anxiety for completed tests were removed.
table(m2data.anxiety2$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2data.anxiety3 <- m2data.anxiety2 %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 2)

#check
table(m2data.anxiety3$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)






merror.anxiety.1.1 <- m2data.anxiety3 %>% 
  select(record_id,redcap_event_name,starts_with("gad"),-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,-gad7difficulttowork) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("gad"), ~ifelse(!is.na(.x),"1","x"))) 

merror.anxiety.1.2 <- m2data.anxiety3 %>% 
  select(record_id,redcap_event_name,starts_with("gad"),-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  filter(gad2feelnervscl !=0  | gad2notstopwryscl!=0 | gad7wrytoomchscl !=0 | gad7troubrelxscl !=0 | gad7rstlessscl !=0 | gad7easyannoyedscl !=0 | gad7feelafrdscl !=0) %>% 
  filter(is.na(gad7difficulttowork)) %>% 
  select(record_id,redcap_event_name,gad7difficulttowork) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(gad7difficulttowork = replace_na(gad7difficulttowork, "x"))

merror.anxiety1  <- full_join(merror.anxiety.1.1 ,merror.anxiety.1.2 ,by = intersect(names(merror.anxiety.1.1 ), names(merror.anxiety.1.2))) 




# recode 0,1 ie incomplete/unverified to 2

merror.anxiety2 <- m2data.anxiety %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 0 |generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 1) %>% 
  mutate(m2anxiety_complete = case_when(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 0 |generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2anxiety_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





#merge all
merroranxiety1_2 <- full_join(merror.anxiety1,merror.anxiety2,by = intersect(names(merror.anxiety1), names(merror.anxiety2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original m2dataset, select DAG as well
m2data_anxiety <-mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete = case_when(is.na(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) ~ "8",
                                                                                 TRUE ~  as.character(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) 


table(m2data_anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,exclude = NULL)





#ensure each combination of ID and redcap event has one row with all values and is not duplicated




merroranxiety1_2[merroranxiety1_2== ""] <- NA

merroranxiety1_2 <- merroranxiety1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


names(merroranxiety1_2)



# anxiety_complete to account for records with missing completion m2data, where 1 is complete and complete plus merrors, 2 is incomplete/unverified and 8 is NA)
m2full_anxiety <- full_join(m2data_anxiety,merroranxiety1_2,by = intersect(names(m2data_anxiety), names(merroranxiety1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2anxiety_complete = case_when(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete  == "8" ~ "8", TRUE ~ as.character(m2anxiety_complete))) %>% 
  filter(!is.na(m2anxiety_complete)) %>% # If merrors are checked across using the entire m2data such as merror.anxiety1, then filtering at this step is important to avoid duplicates
  replace(is.na(.), "1") %>% 
  select(-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))











m2dat.anxiety <- m2full_anxiety %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 Anxiety") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2anxiety_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 Anxiety") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.anxiety = case_when(error == "clean" ~ 1,
                                error == 2 ~ 2,
                                error == 8 ~ 8,
                                TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data.anxiety_wide <- m2dat.anxiety %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2dat.anxiety$mb.anxiety)


table(mcc2data$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,exclude = NULL)




#depression

m2data.dep <- mcc2data









#Check for subjects who did not complete the test.
table(m2data.dep$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)




#remove records with missing values for test completed.
m2data.dep2 <- m2data.dep %>% 
  drop_na(patient_health_questionnaire_depression_scale_phq_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2data.dep2$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2data.dep3 <- m2data.dep2 %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete == 2)

#check
table(m2data.dep3$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)






m2error.dep1 <- m2data.dep3 %>% 
  select(record_id,redcap_event_name,starts_with("phq"),-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("phq"), ~ifelse(!is.na(.x),"1","x"))) 





m2error.dep2 <- m2data.dep %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete == 0 |patient_health_questionnaire_depression_scale_phq_complete == 1) %>% 
  mutate(m2dep_complete = case_when(patient_health_questionnaire_depression_scale_phq_complete == 0 |patient_health_questionnaire_depression_scale_phq_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2dep_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

table(m2error.dep2$m2dep_complete)



m2errordep1_2 <- full_join(m2error.dep1,m2error.dep2,by = intersect(names(m2error.dep1), names(m2error.dep2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
m2data_dep <- mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(patient_health_questionnaire_depression_scale_phq_complete = case_when(is.na(patient_health_questionnaire_depression_scale_phq_complete) ~ "8", TRUE ~ as.character(patient_health_questionnaire_depression_scale_phq_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,patient_health_questionnaire_depression_scale_phq_complete) 


table(m2data_dep$patient_health_questionnaire_depression_scale_phq_complete,exclude = NULL)



#ensure each combination of ID and redcap event has one row with all values and is not duplicated




m2errordep1_2[m2errordep1_2== ""] <- NA

m2errordep1_2 <- m2errordep1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_dep <- full_join(m2data_dep,m2errordep1_2,by = intersect(names(m2data_dep), names(m2errordep1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2dep_complete = case_when(patient_health_questionnaire_depression_scale_phq_complete  == "8" ~ "8", TRUE ~ as.character(m2dep_complete))) %>% 
  filter(!is.na(m2dep_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))






m2dat.dep <- m2full_dep %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 Depression") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2dep_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 Depression") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.dep = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2data.dep_wide <- m2dat.dep %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(m2data.dep_wide$mb.dep)

table(mcc2data$patient_health_questionnaire_depression_scale_phq_complete,exclude = NULL)




#Read Data

m2data.cat <- mcc2data






m2data.cat <- retype(m2data.cat)




names(m2data.cat)

#Check for subjects who did not complete the test.
table(m2data.cat$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)




#remove records with missing values for test completed.
m2data.cat2 <- m2data.cat %>% 
  drop_na(pain_catastrophizing_questionnaire_pcs6_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2data.cat2$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2data.cat3 <- m2data.cat2 %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete == 2)

#check
table(m2data.cat3$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)






m2error.cat1 <- m2data.cat3 %>% 
  select(record_id,redcap_event_name,-pain_catastrophizing_questionnaire_pcs6_complete,starts_with("pcq")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("pcq"), ~ifelse(!is.na(.x),"1","x"))) 







m2error.cat2 <- m2data.cat2 %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete == 0 |pain_catastrophizing_questionnaire_pcs6_complete == 1 ) %>% 
  mutate(m2cat_complete = case_when(pain_catastrophizing_questionnaire_pcs6_complete == 0 |pain_catastrophizing_questionnaire_pcs6_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2cat_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

table(m2error.cat2$m2cat_complete)




m2errorcat1_2 <- full_join(m2error.cat1,m2error.cat2,by = intersect(names(m2error.cat1), names(m2error.cat2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")


table(m2errorcat1_2$m2cat_complete)




# recode NAs to 8 in the original dataset, select DAG as well

m2data.cat1 <-m2data.cat %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(pain_catastrophizing_questionnaire_pcs6_complete = case_when(is.na(pain_catastrophizing_questionnaire_pcs6_complete) ~ "8", TRUE ~ as.character(pain_catastrophizing_questionnaire_pcs6_complete))) %>%
  select(record_id,redcap_event_name,redcap_data_access_group,pain_catastrophizing_questionnaire_pcs6_complete)

table(m2data.cat1$pain_catastrophizing_questionnaire_pcs6_complete)




m2errorcat1_2[m2errorcat1_2== ""] <- NA

m2errorcat1_2 <- m2errorcat1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

table(m2errorcat1_2$m2cat_complete,exclude = NULL)




#recode koos12_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)


m2full_cat <- full_join(m2data.cat1,m2errorcat1_2,by = intersect(names(m2data.cat1), names(m2errorcat1_2))) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2cat_complete = case_when(pain_catastrophizing_questionnaire_pcs6_complete  == "8" ~ "8", TRUE ~ as.character(m2cat_complete))) %>% 
  filter(!is.na(m2cat_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


table(m2full_cat$m2cat_complete,exclude = NULL)






m2dat.cat <- m2full_cat %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 Catastrophizing") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2cat_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 Catastrophizing") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.cat = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2data.cat_wide <- m2dat.cat %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2data.cat_wide$mb.cat)


table(mcc2data$pain_catastrophizing_questionnaire_pcs6_complete,exclude = NULL)




#Read Data

m2data.move <- mcc2data



#begin checks for uchicago
# data.anxiety <- data.anxiety %>%
#   filter(redcap_data.anxiety_access_group == "uchicago")


# Ask hablar to guess most appropriate datatype
m2data.move  <- retype(m2data.move)









#Check for subjects who did not complete the test.
table(m2data.move$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)




#remove records with missing values for test completed.
m2data.move2 <- m2data.move %>% 
  drop_na(fearavoidance_beliefs_questionnaire_v03_fabq_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2data.move2$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2data.move3 <- m2data.move2 %>% 
  filter(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 2)

#check
table(m2data.move3$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)






m2error.move1 <- m2data.move3 %>% 
  select(record_id,redcap_event_name,-fearavoidance_beliefs_questionnaire_v03_fabq_complete,starts_with("fabq")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("fabq"), ~ifelse(!is.na(.x),"1","x"))) 






m2error.move2 <- m2data.move %>% 
  filter(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 0 |fearavoidance_beliefs_questionnaire_v03_fabq_complete == 1) %>% 
  mutate(m2FearMovement_complete = case_when(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 0 |fearavoidance_beliefs_questionnaire_v03_fabq_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2FearMovement_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2errormove1_2 <- full_join(m2error.move1,m2error.move2,by = intersect(names(m2error.move1), names(m2error.move2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")




m2errormove1_2[m2errormove1_2== ""] <- NA

m2errormove1_2 <- m2errormove1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


table(m2errormove1_2$m2FearMovement_complete)





m2data.move1 <- m2data.move %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(fearavoidance_beliefs_questionnaire_v03_fabq_complete = case_when(is.na(fearavoidance_beliefs_questionnaire_v03_fabq_complete) ~ "8", TRUE ~ as.character(fearavoidance_beliefs_questionnaire_v03_fabq_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fearavoidance_beliefs_questionnaire_v03_fabq_complete) 


table(m2data.move1$fearavoidance_beliefs_questionnaire_v03_fabq_complete,exclude = NULL)




# bpi_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_move <- full_join(m2data.move1,m2errormove1_2,by = intersect(names(m2data.move1), names(m2errormove1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2FearMovement_complete = case_when(fearavoidance_beliefs_questionnaire_v03_fabq_complete  == "8" ~ "8", TRUE ~ as.character(m2FearMovement_complete))) %>% 
  filter(!is.na(m2FearMovement_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-fearavoidance_beliefs_questionnaire_v03_fabq_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))



table(m2full_move$m2FearMovement_complete,exclude = NULL) 





m2dat.move <- m2full_move  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 FearMovement") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2FearMovement_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 FearMovement") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.move = case_when(error == "clean" ~ 1,
                             error == 2 ~ 2,
                             error == 8 ~ 8,
                             TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data.move_wide <- m2dat.move %>%
  pivot_wider (names_from = dataset,values_from = error)


table(m2dat.move$mb.move,exclude = NULL) 

table(mcc2data$fearavoidance_beliefs_questionnaire_v03_fabq_complete,exclude = NULL)







#Read Data

m2data.sleep1 <- mcc2data






# checking func access sites

m2data.sleep  <- retype(m2data.sleep1) %>% 
  select(record_id,redcap_event_name,starts_with("promis"))








names(m2data.sleep)

#Check for subjects who did not complete the test.
table(m2data.sleep$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)




#remove records with missing values for test completed.
m2data.sleep2 <- m2data.sleep %>% 
  drop_na(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2data.sleep2$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2data.sleep3 <- m2data.sleep2 %>% 
  filter(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 2)

#check
table(m2data.sleep3$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)






m2error.sleep1 <- m2data.sleep3 %>% 
  select(-promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) %>%
  select(record_id,redcap_event_name,promissleepwasrefreshscl,promisproblemwithslpscl,promisdifficltfallaslpscl,promisslpwasrestlessscl,promistryhardgettoslpscl, promissleepqualityscl) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("promis"), ~ifelse(!is.na(.x),"1","x"))) 






m2error.sleep2 <- m2data.sleep %>% 
  filter(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 0 |promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 1) %>% 
  mutate(m2sleep_complete = case_when(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 0 |promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2sleep_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2errorsleep1_2 <- full_join(m2error.sleep1,m2error.sleep2,by = intersect(names(m2error.sleep1), names(m2error.sleep2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
m2data_slp <-mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete = case_when(is.na(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) ~ "8", TRUE ~ as.character(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,promis_sf_v10_sleep_disturbance_6a_sleep_i_complete)


table(m2data_slp$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete,exclude = NULL)




m2errorsleep1_2[m2errorsleep1_2== ""] <- NA
m2errorsleep1_2 <- m2errorsleep1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_slp <- full_join(m2data_slp,m2errorsleep1_2,by = intersect(names(m2data_slp), names(m2errorsleep1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2sleep_complete = case_when(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete  == "8" ~ "8", TRUE ~ as.character(m2sleep_complete))) %>% 
  filter(!is.na(m2sleep_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))





table(m2full_slp$m2sleep_complete,exclude = NULL) 








m2dat.sleep <- m2full_slp %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset ="mcc2 Promis_Sleep") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2sleep_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 Promis_Sleep") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.sleep = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))






m2data.sleep_wide <- m2dat.sleep %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(m2data.sleep_wide$mb.sleep)

table(mcc2data$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete,exclude = NULL)




#Read Data

m2data.sleep_hours1 <-  mcc2data

m2data.sleep_hours  <- retype(m2data.sleep_hours1) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur,painsleep_duration_sleep_ii_complete) 








names(m2data.sleep_hours)

#Check for subjects who did not complete the test.
table(m2data.sleep_hours$painsleep_duration_sleep_ii_complete, exclude = NULL)




#remove records with missing values for test completed.
m2data.sleep_hours2 <- m2data.sleep_hours %>% 
  drop_na(painsleep_duration_sleep_ii_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2data.sleep_hours2$painsleep_duration_sleep_ii_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2data.sleep_hours3 <- m2data.sleep_hours2 %>% 
  filter(painsleep_duration_sleep_ii_complete == 2)

#check
table(m2data.sleep_hours3$painsleep_duration_sleep_ii_complete, exclude = NULL)






m2error.sleep_hours1 <- m2data.sleep_hours3 %>% 
  select(-painsleep_duration_sleep_ii_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(empty_1 = case_when(is.na(sleepnighthourmindurhrs) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_2 = case_when(is.na(sleepnighthourmindur) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_3 = case_when(is.na(sleepnighthourmindurmins) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_4= case_when(empty_1 == "x" & empty_2 == "x" & empty_3 == "x" ~ "x",TRUE ~ "1")) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,empty_4) %>% 
  rename("sleepnighthourmindur"= empty_4) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2error.sleep_hours2 <- m2data.sleep_hours %>% 
  filter(painsleep_duration_sleep_ii_complete ==0 |painsleep_duration_sleep_ii_complete == 1) %>% 
  mutate(m2sleep_hours_complete = case_when(painsleep_duration_sleep_ii_complete == 0 |painsleep_duration_sleep_ii_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,m2sleep_hours_complete)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2errorsleep_hours1_2 <- full_join(m2error.sleep_hours1,m2error.sleep_hours2,by = intersect(names(m2error.sleep_hours1), names(m2error.sleep_hours2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
m2data.slp_hours <- mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(painsleep_duration_sleep_ii_complete = case_when(is.na(painsleep_duration_sleep_ii_complete) ~ "8", TRUE ~ as.character(painsleep_duration_sleep_ii_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,painsleep_duration_sleep_ii_complete) 


table(m2data.slp_hours$painsleep_duration_sleep_ii_complete,exclude = NULL)




m2errorsleep_hours1_2[m2errorsleep_hours1_2== ""] <- NA
m2errorsleep_hours1_2 <- m2errorsleep_hours1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_slp_hrs <- full_join(m2data.slp_hours,m2errorsleep_hours1_2,by = intersect(names(m2data.slp_hours), names(m2errorsleep_hours1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2sleep_hours_complete= case_when(painsleep_duration_sleep_ii_complete  == "8" ~ "8", TRUE ~ as.character(m2sleep_hours_complete))) %>% 
  filter(!is.na(m2sleep_hours_complete)) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-painsleep_duration_sleep_ii_complete)










table(m2full_slp_hrs$m2sleep_hours_complete,exclude = NULL) 









m2dat.sleep_hours <- m2full_slp_hrs  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 sleep_hours") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2sleep_hours_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 sleep_hours") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.sleep_hours = case_when(error == "clean" ~ 1,
                                    error == 2 ~ 2,
                                    error == 8 ~ 8,
                                    TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2data.sleep_hours_wide <- m2dat.sleep_hours %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2data.sleep_hours_wide$mb.sleep_hours)



table(mcc2data$painsleep_duration_sleep_ii_complete,exclude = NULL)



########## Read Data cognition   ##########

# Ask hablar to guess most appropriate datatype
m2appdata.cog <- retype(mcc2data)







#Check for subjects who did not complete the test.
table(m2appdata.cog$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)




#remove records with missing values for test completed.
m2appdata.cog2 <- m2appdata.cog %>% 
  drop_na(multidimensional_inventory_of_subjective_cognitive_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2appdata.cog2$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2appdata.cog3 <- m2appdata.cog2 %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete== 2)

#check
table(m2appdata.cog3$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)


m2appdata.cog3 <- m2appdata.cog3 %>% 
  select(record_id,redcap_event_name,-multidimensional_inventory_of_subjective_cognitive_complete,starts_with("misc"))


names(m2appdata.cog3)



m2error.cog1 <- m2appdata.cog3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("misc"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2error.cog2 <- m2appdata.cog %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete == 0 | multidimensional_inventory_of_subjective_cognitive_complete == 1) %>% 
  mutate(m2cog_complete = case_when(multidimensional_inventory_of_subjective_cognitive_complete == 0 | multidimensional_inventory_of_subjective_cognitive_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2cog_complete)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
m2errorcog1_2 <- full_join(m2error.cog1,m2error.cog2,by = intersect(names(m2error.cog1), names(m2error.cog2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2appdata.cog <-mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(multidimensional_inventory_of_subjective_cognitive_complete = case_when(is.na(multidimensional_inventory_of_subjective_cognitive_complete) ~ "8", TRUE ~ as.character(multidimensional_inventory_of_subjective_cognitive_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,multidimensional_inventory_of_subjective_cognitive_complete) 


table(m2appdata.cog$multidimensional_inventory_of_subjective_cognitive_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated




m2errorcog1_2[m2errorcog1_2== ""] <- NA

m2errorcog1_2 <- m2errorcog1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(m2errorcog1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_cog <- full_join(m2appdata.cog,m2errorcog1_2,by = intersect(names(m2appdata.cog), names(m2errorcog1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2cog_complete = case_when(multidimensional_inventory_of_subjective_cognitive_complete == "8" ~ "8", TRUE ~ as.character(m2cog_complete))) %>% 
  filter(!is.na(m2cog_complete)) %>% # If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  replace(is.na(.), "1") %>% 
  select(-multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2dat.cog <- m2full_cog %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 cognition") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2cog_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 cognition") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.cog = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data.cog_wide <- m2dat.cog %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2dat.cog$mb.cog)


table(m2appdata.cog$multidimensional_inventory_of_subjective_cognitive_complete ,exclude = NULL)


########## Read Data Resilience   ##########



# Ask hablar to guess most appropriate datatype
m2appdata.res <- retype(mcc2data)







#Check for subjects who did not complete the test.
table(m2appdata.res$pain_resilience_scale_prs_complete, exclude = NULL)




#remove records with missing values for test completed.
m2appdata.res2 <- m2appdata.res %>% 
  drop_na(pain_resilience_scale_prs_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2appdata.res2$pain_resilience_scale_prs_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2appdata.res3 <- m2appdata.res2 %>% 
  filter(pain_resilience_scale_prs_complete== 2)

#check
table(m2appdata.res3$pain_resilience_scale_prs_complete, exclude = NULL)


m2appdata.res3 <- m2appdata.res3 %>% 
  select(record_id,redcap_event_name,-pain_resilience_scale_prs_complete,starts_with("prs"))


names(m2appdata.res3)



m2error.res1 <- m2appdata.res3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("prs"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2error.res2 <- m2appdata.res %>% 
  filter(pain_resilience_scale_prs_complete == 0 | pain_resilience_scale_prs_complete == 1) %>% 
  mutate(m2res_complete = case_when(pain_resilience_scale_prs_complete == 0 | pain_resilience_scale_prs_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2res_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)


table(m2error.res2$m2res_complete)

#merge all
m2errorres1_2 <- full_join(m2error.res1,m2error.res2,by = intersect(names(m2error.res1), names(m2error.res2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2appdata.res <- mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(pain_resilience_scale_prs_complete = case_when(is.na(pain_resilience_scale_prs_complete) ~ "8", TRUE ~ as.character(pain_resilience_scale_prs_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,pain_resilience_scale_prs_complete) 


table(m2appdata.res$pain_resilience_scale_prs_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated




m2errorres1_2[m2errorres1_2== ""] <- NA

m2errorres1_2 <- m2errorres1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(m2errorres1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_res <- full_join(m2appdata.res,m2errorres1_2,by = intersect(names(m2appdata.res), names(m2errorres1_2))) %>% 
  mutate(m2res_complete = case_when(pain_resilience_scale_prs_complete == "8" ~ "8", TRUE ~ as.character(m2res_complete))) %>% 
  filter(!is.na(m2res_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-pain_resilience_scale_prs_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2dat.res <- m2full_res %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 resilience") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2res_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 resilience") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.res = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data.res_wide <- m2dat.res %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2dat.res$mb.res)


table(m2appdata.res$pain_resilience_scale_prs_complete ,exclude = NULL)



########## Read social  ##########



# Ask hablar to guess most appropriate datatype
m2appdata.social <- retype(mcc2data)



#Check for subjects who did not complete the test.
table(m2appdata.social$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)


#remove records with missing values for test completed.
m2appdata.social2 <- m2appdata.social %>% 
  drop_na(promis_sf_v20_emotional_support_6a_complete)


#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2appdata.social2$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2appdata.social3 <- m2appdata.social2 %>% 
  filter(promis_sf_v20_emotional_support_6a_complete== 2)

#check
table(m2appdata.social3$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)


m2appdata.social3 <- m2appdata.social3 %>% 
  select(record_id,redcap_event_name,-promis_sf_v20_emotional_support_6a_complete,starts_with("ess"))




names(m2appdata.social3)



m2error.social1 <- m2appdata.social3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("ess"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2error.social2 <- m2appdata.social %>% 
  filter(promis_sf_v20_emotional_support_6a_complete == 0 | promis_sf_v20_emotional_support_6a_complete == 1) %>% 
  mutate(m2social_complete = case_when(promis_sf_v20_emotional_support_6a_complete == 0 | promis_sf_v20_emotional_support_6a_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2social_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
m2errorsocial1_2 <- full_join(m2error.social1,m2error.social2,by = intersect(names(m2error.social1), names(m2error.social2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2appdata.social <- mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(promis_sf_v20_emotional_support_6a_complete = case_when(is.na(promis_sf_v20_emotional_support_6a_complete) ~ "8", TRUE ~ as.character(promis_sf_v20_emotional_support_6a_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,promis_sf_v20_emotional_support_6a_complete) 


table(m2appdata.social$promis_sf_v20_emotional_support_6a_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2errorsocial1_2[m2errorsocial1_2== ""] <- NA

m2errorsocial1_2 <- m2errorsocial1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(m2errorsocial1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_social <- full_join(m2appdata.social,m2errorsocial1_2,by = intersect(names(m2appdata.social), names(m2errorsocial1_2))) %>% 
  mutate(m2social_complete = case_when(promis_sf_v20_emotional_support_6a_complete == "8" ~ "8", TRUE ~ as.character(m2social_complete))) %>% 
  filter(!is.na(m2social_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-promis_sf_v20_emotional_support_6a_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2dat.social <- m2full_social %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 social_support") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2social_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 social_support") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.social = case_when(error == "clean" ~ 1,
                               error == 2 ~ 2,
                               error == 8 ~ 8,
                               TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data.social_wide <- m2dat.social %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2dat.social$mb.social)


table(m2appdata.social$promis_sf_v20_emotional_support_6a_complete ,exclude = NULL)


########## Read ace ##########



# Ask hablar to guess most appropriate datatype
m2appdata.ace <- retype(mcc2data)



#Check for subjects who did not complete the test.
table(m2appdata.ace$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)




#remove records with missing values for test completed.
m2appdata.ace2 <- m2appdata.ace %>% 
  drop_na(adverse_childhood_experience_questionnaire_ace_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2appdata.ace2$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2appdata.ace3 <- m2appdata.ace2 %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete== 2)

#check
table(m2appdata.ace3$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)


m2appdata.ace3 <- m2appdata.ace3 %>% 
  select(record_id,redcap_event_name,-adverse_childhood_experience_questionnaire_ace_complete,starts_with("ace"))

names(m2appdata.ace3)


names(m2appdata.ace3)



m2error.ace1 <- m2appdata.ace3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("ace"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2error.ace2 <- m2appdata.ace %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete == 0 | adverse_childhood_experience_questionnaire_ace_complete == 1) %>% 
  mutate(m2ace_complete = case_when(adverse_childhood_experience_questionnaire_ace_complete == 0 | adverse_childhood_experience_questionnaire_ace_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2ace_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
m2errorace1_2 <- full_join(m2error.ace1,m2error.ace2,by = intersect(names(m2error.ace1), names(m2error.ace2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2appdata.ace <-mcc2data %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(adverse_childhood_experience_questionnaire_ace_complete = case_when(is.na(adverse_childhood_experience_questionnaire_ace_complete) ~ "8", TRUE ~ as.character(adverse_childhood_experience_questionnaire_ace_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,adverse_childhood_experience_questionnaire_ace_complete) 


table(m2appdata.ace$adverse_childhood_experience_questionnaire_ace_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2errorace1_2[m2errorace1_2== ""] <- NA

m2errorace1_2 <- m2errorace1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(m2errorace1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_ace <- full_join(m2appdata.ace,m2errorace1_2,by = intersect(names(m2appdata.ace), names(m2errorace1_2))) %>% 
  mutate(m2ace_complete = case_when(adverse_childhood_experience_questionnaire_ace_complete == "8" ~ "8", TRUE ~ as.character(m2ace_complete))) %>% 
  filter(!is.na(m2ace_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-adverse_childhood_experience_questionnaire_ace_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2dat.ace <- m2full_ace %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2 ACE") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2ace_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2 ACE") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.ace = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data.ace_wide <- m2dat.ace %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2dat.ace$mb.ace)


table(mcc2data$adverse_childhood_experience_questionnaire_ace_complete ,exclude = NULL)


#mcc2 baseline (acute) trajectory

#read in data

m2data.tr.baseline <- m2_complete_result1 




#select completion vars only
# filter daily items that are complete

m2data.tr1.baseline <- m2data.tr.baseline %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,acute_phase_trajectory_items_v05_acute_daily_complete) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(acute_phase_trajectory_items_v05_acute_daily_complete == 2)






# count complete daily items per subject

m2data.tr.baseline.count <- m2data.tr1.baseline%>% 
  group_by(record_id) %>% 
  summarise(N=n())


# identify subjects who have >= 2 daily item for 6 month trajectory


m2baseline_pheno <- m2data.tr.baseline.count %>% 
  filter(N >= 5) %>% 
  select(record_id)


# select record ids and redcap_data_access_group , redcap_event_name from data to provide redcap data access group for the ids

m2baseline_traj_data <- mcc2data %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) 


# provide redcap data access group and event name to 

m2baseline_phenom1 <- inner_join(m2baseline_pheno,m2baseline_traj_data, by = "record_id") %>% 
  mutate(mcc2_acute_traj = case_when(redcap_event_name == "baseline_visit_arm_1" ~ 1,TRUE ~ 7))

# isolate 6 month IDs
m2baseline_ids <- m2baseline_phenom1 %>% 
  select(record_id) %>% 
  distinct()

#creata a dataset with no 6 months IDs
m2baseline_traj_data1 <- m2baseline_traj_data %>% 
  filter(!record_id %in% m2baseline_ids$record_id) %>% 
  mutate(mcc2_acute_traj = case_when(redcap_event_name == "baseline_visit_arm_1" ~ 8,TRUE ~ 7))

#combine both datasets to create a dataframe with ids that have 6 mo trajectory and ids with no 6 mo trajectory

m2baseline_traj_wide <- rbind(m2baseline_phenom1,m2baseline_traj_data1) %>% 
  mutate(mb.base_traj = mcc2_acute_traj) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

############################

#mcc2 6 mon trajectory

#read in data

m2data.tr <- m2_complete_result1 




#read in data

m2datatr.bpi <- retype(mcc2data) %>% 
  select(record_id,redcap_event_name,starts_with("bpi"))


#select completion vars only
# filter daily items that are complete

m2data.tr1 <- m2data.tr %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,acute_phase_trajectory_items_v01_6month_daily_complete,traj24worstpainscl) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(acute_phase_trajectory_items_v01_6month_daily_complete== 2) %>% 
  ungroup()







# count complete daily items per subject

m2data.tr.count <- m2data.tr1%>% 
  group_by(record_id) %>% 
  summarise(N=n())


# identify subjects who have >= 2 daily item for 6 month trajectory


m2six_month_tr <- m2data.tr.count %>% 
  filter(N >= 1) %>% 
  select(record_id)






m2datatr.bpi1 <- m2datatr.bpi %>% 
  select(record_id,redcap_event_name,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,bpipainintrfrscore) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(!is.na(bpipainintrfrscore),redcap_event_name == "6mo_postop_arm_1" & bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2) %>% 
  ungroup() %>% 
  select(record_id)




#combine all id from bpi and tr to generate ids of patients with 6 months complete

m2six_mo_pheno <- rbind(m2datatr.bpi1,m2six_month_tr) %>% 
  distinct(record_id)
# select record ids and redcap_data_access_group , redcap_event_name from data to provide redcap data access group for the ids

m2traj_data <- mcc2data %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) 


# provide redcap data access group and event name to 

m2six_mo_phenom1 <- inner_join(m2six_mo_pheno,m2traj_data, by = "record_id") %>% 
  mutate(mcc2_six_mo_traj = case_when(redcap_event_name == "6mo_postop_arm_1" ~ 1,TRUE ~ 7))

# isolate 6 month IDs
m2six_mo_ids <- m2six_mo_phenom1 %>% 
  select(record_id) %>% 
  distinct()

#creata a dataset with no 6 months IDs
m2traj_data1 <- m2traj_data %>% 
  filter(!record_id %in% m2six_mo_ids$record_id) %>% 
  mutate(mcc2_six_mo_traj = case_when(redcap_event_name == "6mo_postop_arm_1" ~ 8,TRUE ~ 7))

#combine both datasets to create a dataframe with ids that have 6 mo trajectory and ids with no 6 mo trajectory

m2six.mo_wide <- rbind(m2six_mo_phenom1,m2traj_data1) %>% 
  mutate(mb.traj = mcc2_six_mo_traj) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

# read mcc2 func data for the app


#functional

#Read m2frfunc

m2fafunc <- retype(mcc2data) 



#remove records with missing values for test completed.
m2fafunc2 <- m2fafunc %>% 
  drop_na(ftdbctestcmpltyn)


#Recheck if all records with missing m2frfunc for completed tests were removed.
table(m2fafunc2$ftdbctestcmpltyn, exclude = NULL)






#keep records for subjects who completed the test.
m2fafunc3 <- m2fafunc2 %>% 
  filter(ftdbctestcmpltyn == 1)



#look for discrepancies in the initial pain rating 
m2fafunc4 <- m2fafunc3 %>% 
  mutate(init_pain_diff = ftdbcdeepbrthinitscl - ftdbcdeepbrthinitscl2) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

m2faerror1 <- m2fafunc4 %>% 
  select(record_id,redcap_event_name,ftdbcdeepbrthinitscl,ftdbcdeepbrthinitscl2)%>% 
  mutate(ftdbcdeepbrthinitscl = case_when(is.na(ftdbcdeepbrthinitscl) ~ "x",TRUE ~ as.character(ftdbcdeepbrthinitscl))) %>% 
  mutate(ftdbcdeepbrthinitscl2 = case_when(is.na(ftdbcdeepbrthinitscl2) ~ "x",TRUE ~ as.character(ftdbcdeepbrthinitscl2) )) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#look for discrepancies between the first and the second final pain rating 
m2fafunc5 <- m2fafunc3 %>% 
  mutate(final_pain_diff = ftdbcdeepbrthfinalscl - ftdbcdeepbrthfinalscl2 ) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff))

m2faerror2 <- m2fafunc5 %>% 
  select(record_id,redcap_event_name,ftdbcdeepbrthfinalscl,ftdbcdeepbrthfinalscl2) %>% 
  mutate(ftdbcdeepbrthfinalscl = case_when(is.na(ftdbcdeepbrthfinalscl) ~ "x",TRUE ~ as.character(ftdbcdeepbrthfinalscl))) %>% 
  mutate(ftdbcdeepbrthfinalscl2 = case_when(is.na(ftdbcdeepbrthfinalscl2) ~ "x",TRUE ~ as.character(ftdbcdeepbrthfinalscl2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2faerror1_2 <- full_join(m2faerror1,m2faerror2,by = intersect(names(m2faerror1), names(m2faerror2)))





#look for discrepancies between the first and the second cough pain 
m2fafunc6 <- m2fafunc3 %>% 
  mutate(cough_diff = ftdbccoughfinalscl - ftdbccoughfinalscl2) %>% 
  filter(cough_diff != 0 | is.na(cough_diff))

m2faerror3 <- m2fafunc6 %>% 
  select(record_id,redcap_event_name,ftdbccoughfinalscl,ftdbccoughfinalscl2)%>%
  mutate(ftdbccoughfinalscl = case_when(is.na(ftdbccoughfinalscl) ~ "x",TRUE ~ as.character(ftdbccoughfinalscl))) %>% 
  mutate(ftdbccoughfinalscl2 = case_when(is.na(ftdbccoughfinalscl2) ~ "x",TRUE ~ as.character(ftdbccoughfinalscl2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2faerror1_2_3 <- full_join(m2faerror1_2,m2faerror3,by = intersect(names(m2faerror1_2), names(m2faerror3)))




# if test not completed was the reason checked off, use m2fafunc2 (with completed records) 

m2faerror4 <- m2fafunc2 %>% 
  filter(ftdbctestcmpltyn == 0) %>% 
  filter(is.na(ftdbctestcmpltno)) %>% 
  select(record_id,redcap_event_name,ftdbctestcmpltno) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(ftdbctestcmpltno = case_when(is.na(ftdbctestcmpltno) ~ "x",TRUE ~ as.character(ftdbctestcmpltno))) # recode NA to missing or leave as is



names(m2fafunc)

m2faerror1_2_3_4 <- full_join(m2faerror1_2_3,m2faerror4,by = intersect(names(m2faerror1_2_3), names(m2faerror4)))



#if test complete is not NA then was the  functional_testing_mcc2_v01_complete.factor complete?

m2faerror5 <- m2fafunc %>% 
  filter(!is.na(ftdbctestcmpltyn)) %>% 
  filter(is.na(functional_testing_mcc2_v01_complete))%>% 
  select(record_id,redcap_event_name,ftdbctestcmpltyn,functional_testing_mcc2_v01_complete)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(functional_testing_mcc2_v01_complete = case_when(is.na(functional_testing_mcc2_v01_complete) ~ "x"))



m2faerror1_5 <- full_join(m2faerror1_2_3_4,m2faerror5,by = intersect(names(m2faerror1_2_3_4), names(m2faerror5)))





# select DAG

m2fafunc.dag <- m2fafunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# now dag to func

m2fafunc_table <- left_join(m2faerror1_5,m2fafunc.dag,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) 



#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2fafunc_table[m2fafunc_table== ""] <- NA
m2fafunc_table <-  m2fafunc_table %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)  %>% 
  replace(is.na(.), "1") %>% 
  add_column(m2func_complete = 0) %>% # added new step here, do this step first since the below statement does not work, columns are less than 4 which happens in case there are no flags
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

# recode 0,1 ie incomplete/unverified to 2
m2func_all <- m2fafunc %>% 
  filter(functional_testing_mcc2_v01_complete == 0 |functional_testing_mcc2_v01_complete == 1) %>% 
  mutate(m2func_complete = case_when(functional_testing_mcc2_v01_complete == 0 |functional_testing_mcc2_v01_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2func_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2fafunc_table[] <- lapply(m2fafunc_table, as.character)
m2func_all[] <- lapply(m2func_all, as.character)

#merge all
m2error_func_all <- full_join(m2fafunc_table,m2func_all,by = intersect(names(m2fafunc_table), names(m2func_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 

# recode NAs to 8 in the original dataset, select DAG as well
m2data_func_all <- m2fafunc %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(functional_testing_mcc2_v01_complete = case_when(is.na(functional_testing_mcc2_v01_complete) ~ "8", TRUE ~ as.character(functional_testing_mcc2_v01_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,functional_testing_mcc2_v01_complete) 


table(m2data_func_all$functional_testing_mcc2_v01_complete,exclude = NULL)



#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2error_func_all[m2error_func_all== ""] <- NA


m2error_func_all <- m2error_func_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# func_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_func <- full_join(m2error_func_all,m2data_func_all,by = intersect(names(m2error_func_all), names(m2data_func_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2func_complete = case_when( functional_testing_mcc2_v01_complete == "8" ~ "8", TRUE ~ as.character(m2func_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-functional_testing_mcc2_v01_complete)




table(m2full_func$m2func_complete,exclude = NULL) 


# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
m2dat.func <- m2full_func %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2_Functional") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2func_complete") %>% 
  
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2_Functional") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.func = case_when(error == "clean" ~ 1,
                             error == 2 ~ 2,
                             error == 8 ~ 8,
                             TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2data_func_wide <- m2dat.func %>%
  pivot_wider (names_from = dataset,values_from = error) 

table(m2data_func_wide$mb.func) 
table(m2fafunc$functional_testing_mcc2_v01_complete, exclude = NULL)


#Read Data

m2badata_blood<- m2brdata







# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)



m2badata_blood1 <- m2badata_blood   %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1 == 0 & blood_sample_collection_and_processing_crf_complete == 2)






# format time
m2badata_blood1$bscp_time_blood_draw <- ymd_hms(m2badata_blood1$bscp_time_blood_draw)

m2badata_blood1$bscp_time_centrifuge <- ymd_hms(m2badata_blood1$bscp_time_centrifuge)

m2badata_blood1$bscp_aliquot_freezer_time <- ymd_hms(m2badata_blood1$bscp_aliquot_freezer_time)



#check if blood draw time < centri time < freezer time 
m2badata_blood2 <- m2badata_blood1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) 



m2baflagblood1 <- m2badata_blood2 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  mutate(blood_draw_time = case_when(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time ~ "x")) %>% 
  select(record_id,redcap_event_name,blood_draw_time) 




#missing info on hours since last drink

m2baflagblood6 <- m2badata_blood1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "x")) 




m2baflagblood1_6 <- full_join(m2baflagblood1,m2baflagblood6,by = intersect(names(m2baflagblood1), names(m2baflagblood6)))



#missing info on hours since last food


m2baflagblood7 <- m2badata_blood1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "x")) 







m2baflagblood1_7 <- full_join(m2baflagblood1_6,m2baflagblood7,by = intersect(names(m2baflagblood1_6), names(m2baflagblood7)))



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

m2baflagblood8 <- m2badata_blood1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "x"))


m2baflagblood1_8 <- full_join(m2baflagblood1_7,m2baflagblood8,by = intersect(names(m2baflagblood1_7), names(m2baflagblood8)))



#missing info on amount of caff
m2baflagblood9 <- m2badata_blood1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "x")) 


m2baflagblood1_9 <- full_join(m2baflagblood1_8,m2baflagblood9,by = intersect(names(m2baflagblood1_8), names(m2baflagblood9 )))

#missing info on any vacc
m2baflagblood10 <- m2badata_blood1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "x")) 

m2baflagblood1_10 <- full_join(m2baflagblood1_9,m2baflagblood10,by = intersect(names(m2baflagblood1_9), names(m2baflagblood10)))


# if level of hemolysis was not entered

m2baflagblood11 <- m2badata_blood1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



m2baflagblood1_11<- full_join(m2baflagblood1_10,m2baflagblood11,by = intersect(names(m2baflagblood1_10), names(m2baflagblood11)))


# if centrifuge time entered but freezing time not entered

m2baflagblood14.1 <- m2badata_blood1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_aliquot_freezer_time)





#m2baflagblood1_13$bscp_aliquot_freezer_time <- as.character(flag1_13$bscp_aliquot_freezer_time)



m2baflagblood1_14.1<- full_join(m2baflagblood1_11,m2baflagblood14.1,by = intersect(names(m2baflagblood1_11), names(m2baflagblood14.1))) 




# if centrifuge time entered but degree of hemolysis  not entered

m2baflagblood14.2 <- m2badata_blood1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)




m2baflagblood1_14.2<- full_join(m2baflagblood1_14.1,m2baflagblood14.2,by = intersect(names(m2baflagblood1_14.1), names(m2baflagblood14.2))) 




# if centrifuge time not entered but degree of hemolysis entered

m2baflagblood14.3 <- m2badata_blood1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge)







m2baflagblood1_14<- full_join(m2baflagblood1_14.2,m2baflagblood14.3,by = intersect(names(m2baflagblood1_14.2), names(m2baflagblood14.3))) 


#fetch notes with dag
m2ba.notes.blood <- m2badata_blood %>% 
  select(record_id,redcap_event_name, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2baflagblood_notes <- left_join(m2baflagblood1_14,m2ba.notes.blood,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) 



m2bablood_table<- m2baflagblood_notes %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name", "redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)   %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  add_column(m2bld_complete = 0) %>% # added new step here, do this step first since the below statement does not work, columns are less than 4 which happens in case there are no flags
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# recode 0,1 ie incomplete/unverified to 2
m2bld_all <- m2badata_blood %>% 
  filter(blood_sample_collection_and_processing_crf_complete == 0 |blood_sample_collection_and_processing_crf_complete == 1) %>% 
  mutate(m2bld_complete = case_when(blood_sample_collection_and_processing_crf_complete == 0 |blood_sample_collection_and_processing_crf_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2bld_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2bablood_table[] <- lapply(m2bablood_table, as.character)
m2bld_all[] <- lapply(m2bld_all, as.character)




#merge all
m2error_bld_all <- full_join(m2bablood_table,m2bld_all,by = intersect(names(m2bablood_table), names(m2bld_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 




# recode NAs to 8 in the original dataset, select DAG as well
m2data_bld_all <- m2badata_blood %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(blood_sample_collection_and_processing_crf_complete= case_when(is.na(blood_sample_collection_and_processing_crf_complete) ~ "8", TRUE ~ as.character(blood_sample_collection_and_processing_crf_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,blood_sample_collection_and_processing_crf_complete) 


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2error_bld_all[m2error_bld_all== ""] <- NA


m2error_bld_all <- m2error_bld_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# imaging_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_bld <- full_join(m2error_bld_all,m2data_bld_all,by = intersect(names(m2error_bld_all), names(m2data_bld_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  %>% 
  mutate(m2bld_complete = case_when(blood_sample_collection_and_processing_crf_complete == "8" ~ "8", TRUE ~ as.character(m2bld_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-blood_sample_collection_and_processing_crf_complete)


m2dat.blood <- m2full_bld %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2_BloodDraw") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "bld_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2_BloodDraw") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.blood = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))




m2data_blood_wide <- m2dat.blood %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2data_blood_wide$mb.blood)
table(mcc2data$blood_sample_collection_and_processing_crf_complete,exclude = FALSE)


#imaging
#Read Data



#Read Data
m2iaimaging <-  irimagingm2






#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

m2iadf.complete <- m2iaimaging%>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc2_v01_complete == 2)







#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure




m2iaerror1a <-m2iadf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffspyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) & (cuffpfmricontrainddomyn != 1 | cuffpfmricontraindyn !=1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffleg) %>%  
  mutate(fmricuffleg=replace_na("x")) 



# . For the UM site only, there are two scanners that could be used, and based on study protocol subjects 
#returning for "V3" scans should have them done on the same scanner as at "V1", check for same scanner within a subject

m2iaerror1b  <- m2irdf.complete %>%
  filter(redcap_data_access_group == "university_of_mich") %>% 
  select(record_id,redcap_event_name,fmri_magnet_name) %>% 
  group_by(record_id) %>%
  mutate(dummy = as.integer(n_distinct(fmri_magnet_name) == 1)) %>% 
  filter(dummy == 0) %>% 
  select(-dummy) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(fmri_name_mismatch = fmri_magnet_name) %>% 
  mutate(fmri_name_mismatch = "x") %>% 
  distinct(record_id, .keep_all = TRUE)



m2iaerror1c <-m2irdf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffspyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffspyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "x"))


m2iaerror1.1 <- full_join(m2iaerror1a,m2iaerror1b,by = intersect(names(m2iaerror1a), names(m2iaerror1b)))

m2iaerror1 <- full_join(m2iaerror1.1,m2iaerror1c,by = intersect(names(m2iaerror1.1), names(m2iaerror1c)))


# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

m2iaerror2 <- m2iadf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,redcap_event_name,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "x",TRUE ~ "x")) 



# merge error1 and 2 



m2iaerror1_2 <- full_join(m2iaerror1,m2iaerror2,by = intersect(names(m2iaerror1), names(m2iaerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

m2iaerror3 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricufft1yn,fmricufft1techrating,fmricufft1repeated,fmricufft1repeated,fmricufft1techrating2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated==1  ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricufft1techrating,fmricufft1techrating2) 



m2iaerror1_2_3 <- full_join(m2iaerror1_2,m2iaerror3,by = intersect(names(m2iaerror1_2), names(m2iaerror3)))






#before fiast resting state

# Check if fiast resting-state scan performed and there was mismatch between entries for surgical site pain

m2iaerror4.1 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "x",TRUE ~ "X")) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,fmricuffrestpainss,fmricuffrestpainss2) 


# Check if fiast resting-state scan performed and there was a mismatch between entries overall body pain

m2iaerror4.2 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | ( fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,fmricuffrestpainovrall, fmricuffrestpainovrall2) 

m2iaerror4 <- full_join(m2iaerror4.1,m2iaerror4.2,by = intersect(names(m2iaerror4.1), names(m2iaerror4.2)))


m2iaerror1_2_3_4 <- full_join(m2iaerror1_2_3,m2iaerror4,by = intersect(names(m2iaerror1_2_3), names(m2iaerror4)))




# After fiast resting fMRI scan:

# Check if fiast resting-state scan performed and there was mismatch between entries for surgical site pain

m2iaerror5.1 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "x",TRUE ~ "x"))

# Check  if fiast resting-state scan and there was mismatch between entries for overall body pain

m2iaerror5.2 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "x",TRUE ~ "x"))



m2iaerror5.a <- full_join(m2iaerror5.1,m2iaerror5.2,by = intersect(names(m2iaerror5.1), names(m2iaerror5.2)))


# Check if individualized and standard performed but baseline was missing after fiast resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
m2iaerror5.bb <- m2iadf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffspyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancuff - fmricuffcurrpainaftfirstscancuff2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscancuff,fmricuffcurrpainaftfirstscancuff2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancuff = case_when(is.na(fmricuffcurrpainaftfirstscancuff) ~ "x",TRUE ~ "x")) %>%
  mutate(fmricuffcurrpainaftfirstscancuff2 = case_when(is.na(fmricuffcurrpainaftfirstscancuff2) ~ "x",TRUE ~ "x"))

m2iaerror1_2_3_4_5a <- full_join(m2iaerror1_2_3_4,m2iaerror5.a,by=intersect(names(m2iaerror1_2_3_4), names(m2iaerror5.a)))


m2iaerror1_2_3_4_5 <- full_join(m2iaerror1_2_3_4_5a,m2iaerror5.bb,by=intersect(names(m2iaerror1_2_3_4_5a), names(m2iaerror5.bb)))





# After fiast cuff fMRI scan

# check if fiast cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

m2iaerror6.1 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainbegin, fmricuffpainbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~"x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "x",TRUE ~ "x"))
# check if fiast cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

m2iaerror6.2 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainmid,fmricuffpainmid2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "x",TRUE ~ "x")) 
# check if fiast cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

m2iaerror6.3 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainend,fmricuffpainend2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "x",TRUE ~ "x")) 
#create final set



m2iaerror6a <- full_join(m2iaerror6.1,m2iaerror6.2,by=intersect(names(m2iaerror6.1), names(m2iaerror6.2)))

m2iaerror6 <- full_join(m2iaerror6a,m2iaerror6.3,by=intersect(names(m2iaerror6a), names(m2iaerror6.3)))

m2iaerror1_2_3_4_5_6 <- full_join(m2iaerror1_2_3_4_5,m2iaerror6,by=intersect(names(m2iaerror1_2_3_4_5), names(m2iaerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

m2iaerror7.1 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpbegin, fmricuffpaincpbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "x",TRUE ~ "x")) 
# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

m2iaerror7.2 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpmid,fmricuffpaincpmid2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "x",TRUE ~ "x")) 
# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

m2iaerror7.3 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpend,fmricuffpaincpend2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "x",TRUE ~ "x"))
#create final set

m2iaerror7a <- full_join(m2iaerror7.1,m2iaerror7.2,by=intersect(names(m2iaerror7.1), names(m2iaerror7.2))) 

m2iaerror7 <- full_join(m2iaerror7.3,m2iaerror7a,by=intersect(names(m2iaerror7.3), names(m2iaerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
m2iaerror8.1 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "x",TRUE ~ "x"))


m2iaerror8.2 <- m2iadf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanmid,fmricuffpainrestscanmid2) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "x",TRUE ~ "x"))

m2iaerror8.3 <- m2iadf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanend,fmricuffpainrestscanend2) %>% 
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "x",TRUE ~ "x")) 

#create full iaerror8


m2iaerror8a1 <- full_join(m2iaerror8.1,m2iaerror8.2,by=intersect(names(m2iaerror8.1), names(m2iaerror8.2))) 

m2iaerror8a <- full_join(m2iaerror8.3,m2iaerror8a1,by=intersect(names(m2iaerror8.3), names(m2iaerror8a1))) 

#merge 7 and 8a 

m2iaerror7_8a <- full_join(m2iaerror7,m2iaerror8a,by=intersect(names(m2iaerror7), names(m2iaerror8a)))



#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
m2iaerror8.4 <- m2iadf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~"x",TRUE ~ "x"))
#"Body pain (double entry)"

m2iaerror8.5 <- m2iadf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "x",TRUE ~ "x"))  


m2iaerror8b<- full_join(m2iaerror8.4,m2iaerror8.5,by=intersect(names(m2iaerror8.4), names(m2iaerror8.5)))



#merge 7_8a and 8b

m2iaerror7_8a_8b <- full_join(m2iaerror7_8a,m2iaerror8b,by=intersect(names(m2iaerror7_8a), names(m2iaerror8b)))



#merge all

m2iaerror1_2_3_4_5_6_7_8 <- full_join(m2iaerror1_2_3_4_5_6,m2iaerror7_8a_8b,by=intersect(names(m2iaerror1_2_3_4_5_6), names(m2iaerror7_8a_8b)))


#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

m2iaerror9.1 <- m2iaimaging %>% 
  filter((imaging_mcc2_v01_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc2_v01_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffdicuploaded= case_when(is.na(fmricuffdicuploaded) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricuffdicuploaded)


#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
m2iaerror9.2 <- m2iaimaging %>% 
  filter(imaging_mcc2_v01_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcompletescl = case_when(is.na(fmricuffcompletescl) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl) 
#merge 9.1 and 9.2 

m2iaerror9.a <- full_join(m2iaerror9.1,m2iaerror9.2,by=intersect(names(m2iaerror9.1), names(m2iaerror9.2))) 


# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

m2iaerror9.b <- m2iaimaging %>% 
  filter(imaging_mcc2_v01_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffspyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "x",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc2_v01_complete,fmricuffcompletescl,fmri_face_mask) %>% 
  left_join(.,m2result_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(record_id,redcap_event_name,fmri_face_mask) 



m2iaerror9 <- full_join(m2iaerror9.a,m2iaerror9.b,by=intersect(names(m2iaerror9.a), names(m2iaerror9.b))) 


#merge all plus error 9

m2iaerror1_2_3_4_5_6_7_8_9 <- full_join(m2iaerror1_2_3_4_5_6_7_8,m2iaerror9,by=intersect(names(m2iaerror1_2_3_4_5_6_7_8), names(m2iaerror9)))



#fetch notes wit dag
m2ianotes.imaging <- m2iaimaging %>% 
  select(record_id,redcap_event_name, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




m2iaerror1_2_3_4_5_6_7_8_notes <- left_join(m2iaerror1_2_3_4_5_6_7_8_9,m2ianotes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


names(iaimaging)

m2iaimage_table<- m2iaerror1_2_3_4_5_6_7_8_notes %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name", "redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)   %>% 
  replace(is.na(.), "1") %>% 
  add_column(m2img_complete = 0) %>% # added new step here, do this step first since the below statement does not work, columns are less than 4 which happens in case there are no flags
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(m2iaimage_table$m2img_complete)


# compare line by line with qst from here
# recode 0,1 ie incomplete/unverified to 2
m2img_all <- m2iaimaging %>% 
  filter(imaging_mcc2_v01_complete  == 0 |imaging_mcc2_v01_complete  == 1) %>% 
  mutate(m2img_complete = case_when(imaging_mcc2_v01_complete == 0 |imaging_mcc2_v01_complete == 1 ~ 2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,m2img_complete,redcap_data_access_group)



m2iaimage_table[] <- lapply(m2iaimage_table, as.character)
m2img_all[] <- lapply(m2img_all, as.character)

#merge all
m2error_img_all <- full_join(m2iaimage_table,m2img_all,by = intersect(names(m2iaimage_table), names(m2img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 



# recode NAs to 8 in the original dataset, select DAG as well
m2data_img_all <- m2iaimaging %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(imaging_mcc2_v01_complete = case_when(is.na(imaging_mcc2_v01_complete) ~ "8", TRUE ~ as.character(imaging_mcc2_v01_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,imaging_mcc2_v01_complete) 


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2error_img_all[m2error_img_all== ""] <- NA


m2error_img_all <- m2error_img_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# imaging_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2full_img <- full_join(m2error_img_all,m2data_img_all,by = intersect(names(m2error_img_all), names(m2data_img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2img_complete = case_when(imaging_mcc2_v01_complete == "8" ~ "8", TRUE ~ as.character(m2img_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-imaging_mcc2_v01_complete)










m2dat.image <- m2full_img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mcc2_Imaging") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2img_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2_Imaging") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(mb.img = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


m2data_imaging_wide <- m2dat.image %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(mcc2data$imaging_mcc2_v01_complete,exclude = FALSE)
table(m2data_imaging_wide$mb.img)

# mcc2 DMA

appqdatam2 <- qdatam2
#Remove records with missing "DMA test completed"

appm2qdata1 <- appqdatam2 %>% 
  filter(!is.na(dmatestcompyn))



# keep record with "test completed"

appm2dma.complete <- appm2qdata1 %>% 
  filter(dmatestcompyn != 0)


# filter only DMA baseline

appm2dma.baseline <- appm2dma.complete %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" )


# IF both or either one location for DMA standardized  performed but DMA complete was missing

appm2error0 <-  appm2dma.baseline  %>% 
  filter(is.na(dmatestcompyn)) %>%
  filter(!is.na(dmacontr1pain &  dmacontr1pain_d & dmacontr2pain & dmacontr2pain_d & dmacontr3pain & dmacontr3pain_d & 
                  dmacontr4pain & dmacontr4pain_d &dmacontr5pain  & dmacontr5pain_d | dmaindxr1pain & dmaindxr1pain_d &
                  dmaindxr2pain & dmaindxr2pain_d  &  dmaindxr3pain   &  dmaindxr3pain_d   &     dmaindxr4pain & dmaindxr4pain_d  & 
                  dmaindxr5pain & dmaindxr5pain_d     &   dmasenscompare))  %>% 
  select(record_id,redcap_event_name,dmatestcompyn) %>% 
  mutate(dmatestcompyn = case_when(is.na(dmatestcompyn) ~ "x",TRUE ~ as.character(dmatestcompyn)))


# check if all sites checked and dmawhich1 or dmawchich2 both checked

appm2error1 <- appm2dma.baseline %>% 
  filter (dmatestcompyn == 1 & (dmatestcompwhich___1 == 1 |dmatestcompwhich___2 == 1)) %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1,dmatestcompwhich___2) %>% 
  mutate(dmatestcompwhich___1 = case_when(dmatestcompwhich___1 == 1 ~ "x",TRUE ~ as.character(dmatestcompwhich___1)))%>% 
  mutate(dmatestcompwhich___2 = case_when(dmatestcompwhich___2 == 1 ~ "x",TRUE ~ as.character(dmatestcompwhich___2)))



appm2error0_1 <-  full_join(appm2error0,appm2error1,by = intersect(names(appm2error0),names(appm2error1)))



# check if some sites checked and dmawhich1 or dmawchich2 both unchecked

appm2error2 <- appm2dma.baseline %>% 
  filter (dmatestcompyn == 2 & (dmatestcompwhich___1 == 0 & dmatestcompwhich___2 == 0)) %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1,dmatestcompwhich___2) %>% 
  mutate(dmatestcompwhich___1 = case_when(dmatestcompwhich___1 == 0 ~ "x",TRUE ~ as.character(dmatestcompwhich___1)))%>% 
  mutate(dmatestcompwhich___2 = case_when(dmatestcompwhich___2 == 0 ~ "x",TRUE ~ as.character(dmatestcompwhich___2)))

appm2error0_2 <-  full_join(appm2error0_1,appm2error2,by = intersect(names(appm2error0_1),names(appm2error2)))


#check if all sites or some sites checked  and no  mismatch or missing pain data for standardized contralateral site
#rep1
appm2error2.1 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff1 = dmacontr1pain - dmacontr1pain_d) %>% 
  filter(dma_stand_cont_diff1 != 0 | is.na(dma_stand_cont_diff1)) %>% 
  select(record_id,redcap_event_name,dma_stand_cont_diff1) %>% 
  mutate(dma_stand_cont_diff1 = case_when(dma_stand_cont_diff1 != 0 ~ "x",TRUE ~ as.character(dma_stand_cont_diff1)))%>% 
  mutate(dma_stand_cont_diff1 = case_when(is.na(dma_stand_cont_diff1) ~ "x",TRUE ~ as.character(dma_stand_cont_diff1)))

#rep2
appm2error2.2 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff2 = dmacontr2pain - dmacontr2pain_d) %>% 
  filter(dma_stand_cont_diff2 != 0 | is.na(dma_stand_cont_diff2))  %>% 
  select(record_id,redcap_event_name,dma_stand_cont_diff2) %>% 
  mutate(dma_stand_cont_diff2 = case_when(dma_stand_cont_diff2 != 0 ~ "x",TRUE ~ as.character(dma_stand_cont_diff2)))%>% 
  mutate(dma_stand_cont_diff2 = case_when(is.na(dma_stand_cont_diff2) ~ "x",TRUE ~ as.character(dma_stand_cont_diff2)))




#rep3

appm2error2.3 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff3 = dmacontr3pain - dmacontr3pain_d) %>% 
  filter(dma_stand_cont_diff3 != 0 | is.na(dma_stand_cont_diff3))  %>% 
  select(record_id,redcap_event_name,dma_stand_cont_diff3) %>% 
  mutate(dma_stand_cont_diff3 = case_when(dma_stand_cont_diff3 != 0 ~ "x",TRUE ~ as.character(dma_stand_cont_diff3)))%>% 
  mutate(dma_stand_cont_diff3 = case_when(is.na(dma_stand_cont_diff3) ~ "x",TRUE ~ as.character(dma_stand_cont_diff3)))


#rep4

appm2error2.4 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff4 = dmacontr4pain - dmacontr4pain_d) %>% 
  filter(dma_stand_cont_diff4 != 0 | is.na(dma_stand_cont_diff4)) %>% 
  select(record_id,redcap_event_name,dma_stand_cont_diff4) %>% 
  mutate(dma_stand_cont_diff4 = case_when(dma_stand_cont_diff4 != 0 ~ "x",TRUE ~ as.character(dma_stand_cont_diff4)))%>% 
  mutate(dma_stand_cont_diff4 = case_when(is.na(dma_stand_cont_diff4) ~ "x",TRUE ~ as.character(dma_stand_cont_diff4)))



#rep5

appm2error2.5 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff5 = dmacontr5pain - dmacontr5pain_d) %>% 
  filter(dma_stand_cont_diff5 != 0 | is.na(dma_stand_cont_diff5)) %>% 
  select(record_id,redcap_event_name,dma_stand_cont_diff5) %>% 
  mutate(dma_stand_cont_diff5 = case_when(dma_stand_cont_diff5 != 0 ~ "x",TRUE ~ as.character(dma_stand_cont_diff5)))%>% 
  mutate(dma_stand_cont_diff5 = case_when(is.na(dma_stand_cont_diff5) ~ "x",TRUE ~ as.character(dma_stand_cont_diff5)))


appm2dma_stan_contr1 <-  full_join(appm2error2.1,appm2error2.2,by = intersect(names(appm2error2.1),names(appm2error2.2)))

appm2dma_stan_contr2 <- full_join(appm2dma_stan_contr1,appm2error2.3,by = intersect(names(appm2error2.3),names(appm2dma_stan_contr1)))


appm2dma_stan_contr3 <- full_join(appm2dma_stan_contr2,appm2error2.4,by = intersect(names(appm2error2.4),names(appm2dma_stan_contr2)))

appm2dma_stan_contr <- full_join(appm2dma_stan_contr3,appm2error2.5,by = intersect(names(appm2error2.5),names(appm2dma_stan_contr3)))


appm2error_0_2_dma_stand_cont <- full_join(appm2error0_2,appm2dma_stan_contr,by = intersect(names(appm2error0_2),names(appm2dma_stan_contr)))


#check if all sites or some sites checked  and no  mismatch or missing pain data for standardized index 
#rep1
appm2error3.1 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff1 = dmaindxr1pain - dmaindxr1pain_d) %>% 
  filter(dma_stand_ind_diff1 != 0 | is.na(dma_stand_ind_diff1)) %>% 
  select(record_id,redcap_event_name,dma_stand_ind_diff1) %>% 
  mutate(dma_stand_ind_diff1 = case_when(dma_stand_ind_diff1 != 0 ~ "x",TRUE ~ as.character(dma_stand_ind_diff1)))%>% 
  mutate(dma_stand_ind_diff1 = case_when(is.na(dma_stand_ind_diff1) ~ "x",TRUE ~ as.character(dma_stand_ind_diff1)))

#rep2
appm2error3.2 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff2 = dmaindxr2pain - dmaindxr2pain_d) %>% 
  filter(dma_stand_ind_diff2 != 0 | is.na(dma_stand_ind_diff2)) %>% 
  select(record_id,redcap_event_name,dma_stand_ind_diff2) %>% 
  mutate(dma_stand_ind_diff2 = case_when(dma_stand_ind_diff2 != 0 ~ "x",TRUE ~ as.character(dma_stand_ind_diff2)))%>% 
  mutate(dma_stand_ind_diff2 = case_when(is.na(dma_stand_ind_diff2) ~ "x",TRUE ~ as.character(dma_stand_ind_diff2)))




#rep3

appm2error3.3 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff3 = dmaindxr3pain - dmaindxr3pain_d) %>% 
  filter(dma_stand_ind_diff3 != 0 | is.na(dma_stand_ind_diff3)) %>% 
  select(record_id,redcap_event_name,dma_stand_ind_diff3) %>% 
  mutate(dma_stand_ind_diff3 = case_when(dma_stand_ind_diff3 != 0 ~ "x",TRUE ~ as.character(dma_stand_ind_diff3)))%>% 
  mutate(dma_stand_ind_diff3 = case_when(is.na(dma_stand_ind_diff3) ~ "x",TRUE ~ as.character(dma_stand_ind_diff3)))

#rep4

appm2error3.4 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff4 = dmaindxr4pain - dmaindxr4pain_d) %>% 
  filter(dma_stand_ind_diff4 != 0 | is.na(dma_stand_ind_diff4))  %>% 
  select(record_id,redcap_event_name,dma_stand_ind_diff4) %>% 
  mutate(dma_stand_ind_diff4 = case_when(dma_stand_ind_diff4 != 0 ~ "x",TRUE ~ as.character(dma_stand_ind_diff4)))%>% 
  mutate(dma_stand_ind_diff4 = case_when(is.na(dma_stand_ind_diff4) ~ "x",TRUE ~ as.character(dma_stand_ind_diff4)))

#rep5
appm2error3.5 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff5 = dmaindxr5pain - dmaindxr5pain_d) %>% 
  filter(dma_stand_ind_diff5 != 0 | is.na(dma_stand_ind_diff5))  %>% 
  select(record_id,redcap_event_name,dma_stand_ind_diff5) %>% 
  mutate(dma_stand_ind_diff5 = case_when(dma_stand_ind_diff5 != 0 ~ "x",TRUE ~ as.character(dma_stand_ind_diff5)))%>% 
  mutate(dma_stand_ind_diff5 = case_when(is.na(dma_stand_ind_diff5) ~ "x",TRUE ~ as.character(dma_stand_ind_diff5)))


appm2dma_stan_ind1 <-  full_join(appm2error3.1,appm2error3.2,by = intersect(names(appm2error3.1),names(appm2error3.2)))

appm2dma_stan_ind2 <- full_join(appm2dma_stan_ind1,appm2error3.3,by = intersect(names(appm2error3.3),names(appm2dma_stan_ind1)))


appm2dma_stan_ind3 <- full_join(appm2dma_stan_ind2,appm2error3.4,by = intersect(names(appm2error3.4),names(appm2dma_stan_ind2)))

appm2dma_stan_ind <- full_join(appm2dma_stan_ind3,appm2error3.5,by = intersect(names(appm2error3.5),names(appm2dma_stan_ind3)))


appm2error_0_2_dma_stand_cont_ind <- full_join(appm2error_0_2_dma_stand_cont,appm2dma_stan_ind,by = intersect(names(appm2error_0_2_dma_stand_cont),names(appm2dma_stan_ind)))


#check if standardized site comparison was entered if both sites were tested

appm2error6 <-  appm2dma.baseline %>% 
  filter(dmatestcompyn == 1 & is.na(dmasenscompare)) %>% 
  select(record_id,redcap_event_name,dmasenscompare) %>% 
  mutate(dmasenscompare = case_when(is.na(dmasenscompare) ~ "x",TRUE ~ as.character(dmasenscompare)))

appm2error_0_2_dma_stand_cont_ind_6 <- full_join(appm2error6,appm2error_0_2_dma_stand_cont_ind,by = intersect(names(appm2error6),names(appm2error_0_2_dma_stand_cont_ind)))


#DMA at 3 months
#filter only 3 months records


appm2dma.3mon <- appqdatam2  %>%
  filter(redcap_event_name == "3mo_postop_arm_1" )

# m2check1 <- m2dma.3mon  %>%
#   select(record_id,redcap_event_name,dmatestcompyn_3m,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1,dmatestcompwhich_3m___1.factor,dmatestcompwhich_3m___2,dmatestcompwhich___2.factor,dmatestcompwhich_3m___3,dmatestcompwhich_3m___3.factor,dmatestcompwhich_3m___4,dmatestcompwhich_3m___4.factor)
# 

# IF DMA standardized and patient specific performed but DMA complete was missing

appm2error.3mon_1 <- appm2dma.3mon %>%
  filter(!is.na(dmacontr1pain |  dmacontr1pain_d | dmacontr2pain| dmacontr2pain_d | dmacontr3pain | dmacontr3pain_d|dmacontr4pain | dmacontr4pain_d |dmacontr5pain 
                | dmacontr5pain_d | dmaindxr1pain | dmaindxr1pain_d |dmaindxr2pain | dmaindxr2pain_d  |  dmaindxr3pain   |
                  dmaindxr3pain_d   |     dmaindxr4pain | dmaindxr4pain_d    |    dmaindxr5pain | dmaindxr5pain_d     |   dmasenscompare   |
                  dmaptcontr1pain |  dmaptcontr1pain_d   |  dmaptcontr2pain     |   dmaptcontr2pain_d  |    dmaptcontr3pain   |     dmaptcontr3pain_d   |
                  dmaptcontr4pain|  dmaptcontr4pain_d   |   dmaptcontr5pain    |    dmaptcontr5pain_d  |    dmaptindxr1pain      |  dmaptindxr1pain_d    |
                  dmaptindxr2pain|  dmaptindxr2pain_d   |   dmaptindxr3pain     |   dmaptindxr3pain_d  |    dmaptindxr4pain  |      dmaptindxr4pain_d   |
                  dmaptindxr5pain |  dmaptindxr5pain_d)) %>% 
  filter(is.na(dmatestcompyn_3m))  %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m) %>%
  mutate(dmatestcompyn_3m = case_when(is.na(dmatestcompyn_3m) ~ "x",TRUE ~ as.character(dmatestcompyn_3m)))


# check if all sites checked and dmawhich1 and dmawchich2 both checked as well

appm2error3mon_2 <- appm2dma.3mon %>%
  filter (dmatestcompyn_3m == 1 & (dmatestcompwhich_3m___2 == 1 | dmatestcompwhich_3m___1 == 1 | dmatestcompwhich_3m___3 == 1 |dmatestcompwhich_3m___4 == 1)) %>%
  select(record_id,redcap_event_name, dmatestcompwhich_3m___1 ,dmatestcompwhich_3m___2, dmatestcompwhich_3m___3,dmatestcompwhich_3m___4) %>% 
  mutate(dmatestcompwhich_3m___2 = case_when(dmatestcompwhich_3m___2 == 1 ~ "x",TRUE ~ as.character(dmatestcompwhich_3m___2))) %>% 
  mutate(dmatestcompwhich_3m___1 = case_when(dmatestcompwhich_3m___1 == 1 ~ "x",TRUE ~ as.character(dmatestcompwhich_3m___1))) %>% 
  mutate(dmatestcompwhich_3m___3 = case_when(dmatestcompwhich_3m___3 == 1 ~ "x",TRUE ~ as.character(dmatestcompwhich_3m___3))) %>% 
  mutate(dmatestcompwhich_3m___4 = case_when(dmatestcompwhich_3m___4 == 1 ~ "x",TRUE ~ as.character(dmatestcompwhich_3m___4)))

appm2error3mon1_2 <- full_join(appm2error.3mon_1,appm2error3mon_2,by = intersect(names(appm2error.3mon_1),names(appm2error3mon_2)))



#Remove records with missing "DMA test completed"

appm2dma.3mon1 <- appm2dma.3mon %>% 
  filter(!is.na(dmatestcompyn_3m))


#New chest pain since surgery?"
appm2error3mon_3 <- appm2dma.3mon1 %>%
  filter(is.na(pmachgchestpainyn)) %>%
  select(record_id,redcap_event_name,pmachgchestpainyn) %>% 
  mutate(pmachgchestpainyn = case_when(is.na(pmachgchestpainyn) ~ "x",TRUE ~ as.character(pmachgchestpainyn)))



appm2error3mon1_3 <- full_join(appm2error3mon1_2,appm2error3mon_3,by = intersect(names(appm2error3mon1_2),names(appm2error3mon_3)))

#  If there is new chest pain AND if General region of pain is NA"
appm2error3mon_4 <- appm2dma.3mon1 %>%
  filter(pmachgchestpainyn==1 & is.na(pmapainregion)) %>%
  select(record_id,redcap_event_name,pmapainregion) %>% 
  mutate(pmapainregion = case_when(is.na(pmapainregion) ~ "x",TRUE ~ as.character(pmapainregion)))


appm2error3mon1_4 <- full_join(appm2error3mon1_3,appm2error3mon_4,by = intersect(names(appm2error3mon1_3),names(appm2error3mon_4)))

#3. Highest pain location",#  If there is new chest pain and highest pain location is NA"
appm2error3mon_5<- appm2dma.3mon1 %>% 
  filter(pmachgchestpainyn==1 & !is.na(pmapainregion) & is.na(pmahighestloc)) %>% 
  select(record_id,redcap_event_name,pmahighestloc,pmapainregion) %>% 
  mutate(pmapainregion= case_when(is.na(pmapainregion) ~ "x",TRUE ~ as.character(pmapainregion))) %>% 
  mutate(pmahighestloc= case_when(is.na(pmahighestloc) ~ "x",TRUE ~ as.character(pmahighestloc)))


appm2error3mon1_5 <- full_join(appm2error3mon1_4,appm2error3mon_5,by = intersect(names(appm2error3mon1_4),names(appm2error3mon_5)))


#4. Lowest pain location", If there is new chest pain and lowest pain location is NA"
appm2error3mon_6 <- appm2dma.3mon1 %>% 
  filter(pmachgchestpainyn==1 & is.na(pmalowestloc)) %>% 
  select(record_id,redcap_event_name,pmapainregion,pmalowestloc) %>% 
  mutate(pmapainregion= case_when(is.na(pmapainregion) ~ "x",TRUE ~ as.character(pmapainregion))) %>% 
  mutate(pmalowestloc= case_when(is.na(pmalowestloc) ~ "x",TRUE ~ as.character(pmalowestloc)))

appm2error3mon1_6 <- full_join(appm2error3mon1_5,appm2error3mon_6,by = intersect(names(appm2error3mon1_5),names(appm2error3mon_6)))


# # 5. Most painful region:"If there is new chest pain and most painful region is NA"
appm2error3mon_7 <- appm2dma.3mon1 %>%
  filter(pmachgchestpainyn==1 & is.na(pmamostpain)) %>%
  select(record_id,redcap_event_name,pmamostpain) %>% 
  mutate(pmamostpain = case_when(is.na(pmamostpain) ~ "x",TRUE ~ as.character(pmamostpain)))


appm2error3mon1_7 <- full_join(appm2error3mon1_6,appm2error3mon_7,by = intersect(names(appm2error3mon1_6),names(appm2error3mon_7)))

# # post surgery specific procedures (refer pg 144 MOP veersion 3)


#check if all sites checked  and no  mismatch or missing pain data for standardized contralateral site
#rep1
appm2error3mon_8 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff1 = dmacontr1pain - dmacontr1pain_d) %>%
  filter(dma3_stand_cont_diff1 != 0 | is.na(dma3_stand_cont_diff1)) %>%
  select(record_id,redcap_event_name,dma3_stand_cont_diff1) %>%
  mutate(dma3_stand_cont_diff1 = case_when(is.na(dma3_stand_cont_diff1) ~ "x",TRUE ~ as.character(dma3_stand_cont_diff1))) 
#merge
appm2error3mon1_8 <- full_join(appm2error3mon1_7,appm2error3mon_8,by = intersect(names(appm2error3mon1_7),names(appm2error3mon_8)))


#rep2
appm2error3mon_9 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff2 = dmacontr2pain - dmacontr2pain_d) %>%
  filter(dma3_stand_cont_diff2 != 0 | is.na(dma3_stand_cont_diff2)) %>%
  select(record_id,redcap_event_name,dma3_stand_cont_diff2) %>%
  mutate(dma3_stand_cont_diff2 = case_when(is.na(dma3_stand_cont_diff2) ~ "x",TRUE ~ as.character(dma3_stand_cont_diff2)))

#merge
appm2error3mon1_9 <- full_join(appm2error3mon1_8,appm2error3mon_9,by = intersect(names(appm2error3mon1_8),names(appm2error3mon_9)))
#rep3

appm2error3mon_10 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 )) %>% 
  mutate(dma3_stand_cont_diff3 = dmacontr3pain - dmacontr3pain_d) %>%
  filter(dma3_stand_cont_diff3 != 0 | is.na(dma3_stand_cont_diff3)) %>%
  select(record_id,redcap_event_name,dma3_stand_cont_diff3) %>%
  mutate(dma3_stand_cont_diff3 = case_when(is.na(dma3_stand_cont_diff3) ~ "x",TRUE ~ as.character(dma3_stand_cont_diff3))) 

appm2error3mon1_10 <- full_join(appm2error3mon1_9,appm2error3mon_10,by = intersect(names(appm2error3mon1_9),names(appm2error3mon_10)))


#rep4

appm2error3mon_11 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff4 = dmacontr4pain - dmacontr4pain_d) %>%
  filter(dma3_stand_cont_diff4 != 0 | is.na(dma3_stand_cont_diff4)) %>%
  select(record_id,redcap_event_name,dma3_stand_cont_diff4) %>%
  mutate(dma3_stand_cont_diff4 = case_when(is.na(dma3_stand_cont_diff4) ~ "x",TRUE ~ as.character(dma3_stand_cont_diff4)))

appm2error3mon1_11 <- full_join(appm2error3mon1_10,appm2error3mon_11,by = intersect(names(appm2error3mon1_10),names(appm2error3mon_11)))


#rep5

appm2error3mon_12 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff5 = dmacontr5pain - dmacontr5pain_d) %>%
  filter(dma3_stand_cont_diff5 != 0 | is.na(dma3_stand_cont_diff5)) %>%
  select(record_id,redcap_event_name,dma3_stand_cont_diff5) %>%
  mutate(dma3_stand_cont_diff5 = case_when(is.na(dma3_stand_cont_diff5) ~ "x",TRUE ~ as.character(dma3_stand_cont_diff5))) 
# 
#   
appm2error3mon1_12 <- full_join(appm2error3mon1_11,appm2error3mon_12,by = intersect(names(appm2error3mon1_11),names(appm2error3mon_12))) 
# 

# #check if all sites checked  and no  mismatch or missing pain data for standardized index site
# #rep1
appm2error3mon_13 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>% 
  mutate(dma3_stand_ind_diff1 = dmaindxr1pain - dmaindxr1pain_d) %>%
  filter(dma3_stand_ind_diff1 != 0 | is.na(dma3_stand_ind_diff1)) %>%
  select(record_id,redcap_event_name,dma3_stand_ind_diff1) %>%
  mutate(dma3_stand_ind_diff1 = case_when(is.na(dma3_stand_ind_diff1) ~ "x",TRUE ~ as.character(dma3_stand_ind_diff1))) 

appm2error3mon1_13 <- full_join(appm2error3mon1_12,appm2error3mon_13,by = intersect(names(appm2error3mon1_12),names(appm2error3mon_13))) 
# 
# #rep2
appm2error3mon_14 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff2 = dmaindxr2pain - dmaindxr2pain_d) %>%
  filter(dma3_stand_ind_diff2 != 0 | is.na(dma3_stand_ind_diff2)) %>%
  select(record_id,redcap_event_name,dma3_stand_ind_diff2) %>%
  mutate(dma3_stand_ind_diff2 = case_when(is.na(dma3_stand_ind_diff2) ~ "x",TRUE ~ as.character(dma3_stand_ind_diff2))) 

appm2error3mon1_14 <- full_join(appm2error3mon1_13,appm2error3mon_14,by = intersect(names(appm2error3mon1_13),names(appm2error3mon_14))) 
# #rep3
# 
appm2error3mon_15 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff3 = dmaindxr3pain - dmaindxr3pain_d) %>%
  filter(dma3_stand_ind_diff3 != 0 | is.na(dma3_stand_ind_diff3)) %>%
  select(record_id,redcap_event_name,dma3_stand_ind_diff3) %>%
  mutate(dma3_stand_ind_diff3 = case_when(is.na(dma3_stand_ind_diff3) ~ "x",TRUE ~ as.character(dma3_stand_ind_diff3)))

appm2error3mon1_15 <- full_join(appm2error3mon1_14,appm2error3mon_15,by = intersect(names(appm2error3mon1_14),names(appm2error3mon_15))) 


# #rep4
# 
appm2error3mon_16 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff4 = dmaindxr4pain - dmaindxr4pain_d) %>%
  filter(dma3_stand_ind_diff4 != 0 | is.na(dma3_stand_ind_diff4)) %>%
  select(record_id,redcap_event_name,dma3_stand_ind_diff4) %>%
  mutate(dma3_stand_ind_diff4 = case_when(is.na(dma3_stand_ind_diff4) ~ "x",TRUE ~ as.character(dma3_stand_ind_diff4))) 

appm2error3mon1_16 <- full_join(appm2error3mon1_15,appm2error3mon_16,by = intersect(names(appm2error3mon1_15),names(appm2error3mon_16))) 


# #rep5
appm2error3mon_17 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1))%>%
  mutate(dma3_stand_ind_diff5 = dmaindxr5pain - dmaindxr5pain_d) %>%
  filter(dma3_stand_ind_diff5 != 0 | is.na(dma3_stand_ind_diff5)) %>%
  select(record_id,redcap_event_name,dma3_stand_ind_diff5) %>%
  mutate(dma3_stand_ind_diff5 = case_when(is.na(dma3_stand_ind_diff5) ~ "x",TRUE ~ as.character(dma3_stand_ind_diff5))) 

appm2error3mon1_17 <- full_join(appm2error3mon1_16,appm2error3mon_17,by = intersect(names(appm2error3mon1_16),names(appm2error3mon_17))) 

# #check if standardized site comparison was entered if both sites were tested
# 
appm2error3mon_28 <-  appm2dma.3mon1 %>% 
  filter(dmatestcompyn_3m == 1 |(dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 ==  1) & (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>% 
  filter (is.na(dmasenscompare)) %>% 
  select(record_id,redcap_event_name,dmasenscompare) %>% 
  mutate(dmasenscompare = case_when(is.na(dmasenscompare) ~ "x",TRUE ~ as.character(dmasenscompare)))

appm2error3mon1_28 <- full_join(appm2error3mon1_17,appm2error3mon_28,by = intersect(names(appm2error3mon1_17),names(appm2error3mon_28))) 

# #begin checks for 3 month DMA pt specific site


# #check if all or some sites checked  and no  mismatch or missing pain data for pt contralateral site
# #rep1
appm2error3mon_29 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff1 = dmaptcontr1pain - dmaptcontr1pain_d) %>%
  filter(dma3pt_stand_cont_diff1 != 0 | is.na(dma3pt_stand_cont_diff1)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_cont_diff1) %>%
  mutate(dma3pt_stand_cont_diff1 = case_when(is.na(dma3pt_stand_cont_diff1) ~ "x",TRUE ~ as.character(dma3pt_stand_cont_diff1)))


appm2error3mon1_29 <- full_join(appm2error3mon1_28,appm2error3mon_29,by = intersect(names(appm2error3mon1_28),names(appm2error3mon_29))) 

# #rep2
appm2error3mon_30 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff2 = dmaptcontr2pain - dmaptcontr2pain_d) %>%
  filter(dma3pt_stand_cont_diff2 != 0 | is.na(dma3pt_stand_cont_diff2)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_cont_diff2) %>%
  mutate(dma3pt_stand_cont_diff2 = case_when(is.na(dma3pt_stand_cont_diff2) ~ "x",TRUE ~ as.character(dma3pt_stand_cont_diff2)))


appm2error3mon1_30 <- full_join(appm2error3mon1_29,appm2error3mon_30,by = intersect(names(appm2error3mon1_29),names(appm2error3mon_30)))  
# 
# #rep3
# 
appm2error3mon_31 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff3 = dmaptcontr3pain - dmaptcontr3pain_d) %>%
  filter(dma3pt_stand_cont_diff3 != 0 | is.na(dma3pt_stand_cont_diff3)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_cont_diff3) %>%
  mutate(dma3pt_stand_cont_diff3 = case_when(is.na(dma3pt_stand_cont_diff3) ~ "x",TRUE ~ as.character(dma3pt_stand_cont_diff3))) 

appm2error3mon1_31 <- full_join(appm2error3mon1_30,appm2error3mon_31,by = intersect(names(appm2error3mon1_30),names(appm2error3mon_31)))  

# #rep4
# 
appm2error3mon_32 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff4 = dmaptcontr4pain - dmaptcontr4pain_d) %>%
  filter(dma3pt_stand_cont_diff4 != 0 | is.na(dma3pt_stand_cont_diff4)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_cont_diff4) %>%
  mutate(dma3pt_stand_cont_diff4 = case_when(is.na(dma3pt_stand_cont_diff4) ~ "x",TRUE ~ as.character(dma3pt_stand_cont_diff4))) 

# 
appm2error3mon1_32 <- full_join(appm2error3mon1_31,appm2error3mon_32,by = intersect(names(appm2error3mon1_31),names(appm2error3mon_32))) 
# #rep5
# 
appm2error3mon_33 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1)) %>%
  mutate(dma3pt_stand_cont_diff5 = dmaptcontr5pain - dmaptcontr5pain_d) %>%
  filter(dma3pt_stand_cont_diff5 != 0 | is.na(dma3pt_stand_cont_diff5)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_cont_diff5) %>%
  mutate(dma3pt_stand_cont_diff5 = case_when(is.na(dma3pt_stand_cont_diff5) ~ "x",TRUE ~ as.character(dma3pt_stand_cont_diff5)))


appm2error3mon1_33 <- full_join(appm2error3mon1_32,appm2error3mon_33,by = intersect(names(appm2error3mon1_32),names(appm2error3mon_33)))  
#   
# 
# 

# #check if all sites checked or some sites checked  and no  mismatch or missing pain data for pt index site
# #rep1
appm2error3mon_34 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff1 = dmaptindxr1pain - dmaptindxr1pain_d) %>%
  filter(dma3pt_stand_ind_diff1 != 0 | is.na(dma3pt_stand_ind_diff1)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_ind_diff1) %>%
  mutate(dma3pt_stand_ind_diff1 = case_when(is.na(dma3pt_stand_ind_diff1) ~ "x",TRUE ~ as.character(dma3pt_stand_ind_diff1)))



appm2error3mon1_34 <- full_join(appm2error3mon1_33,appm2error3mon_34,by = intersect(names(appm2error3mon1_33),names(appm2error3mon_34)))  

# #rep2
appm2error3mon_35 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff2 = dmaptindxr2pain - dmaptindxr2pain_d) %>%
  filter(dma3pt_stand_ind_diff2 != 0 | is.na(dma3pt_stand_ind_diff2)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_ind_diff2) %>%
  mutate(dma3pt_stand_ind_diff2 = case_when(is.na(dma3pt_stand_ind_diff2) ~ "x",TRUE ~ as.character(dma3pt_stand_ind_diff2)))


appm2error3mon1_35 <- full_join(appm2error3mon1_34,appm2error3mon_35,by = intersect(names(appm2error3mon1_34),names(appm2error3mon_35)))   
# 
# 
# #rep3
# 
appm2error3mon_36 <-  appm2dma.3mon1 %>% 
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff3 = dmaptindxr3pain - dmaptindxr3pain_d) %>%
  filter(dma3pt_stand_ind_diff3 != 0 | is.na(dma3pt_stand_ind_diff3)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_ind_diff3) %>%
  mutate(dma3pt_stand_ind_diff3 = case_when(is.na(dma3pt_stand_ind_diff3) ~ "x",TRUE ~ as.character(dma3pt_stand_ind_diff3))) 

appm2error3mon1_36 <- full_join(appm2error3mon1_35,appm2error3mon_36,by = intersect(names(appm2error3mon1_35),names(appm2error3mon_36)))   
# 
# #rep4
# 
appm2error3mon_37 <-  appm2dma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff4 = dmaptindxr4pain - dmaptindxr4pain_d) %>%
  filter(dma3pt_stand_ind_diff4 != 0 | is.na(dma3pt_stand_ind_diff4)) %>%
  select(record_id,redcap_event_name,dma3pt_stand_ind_diff4) %>%
  mutate(dma3pt_stand_ind_diff4 = case_when(is.na(dma3pt_stand_ind_diff4) ~ "x",TRUE ~ as.character(dma3pt_stand_ind_diff4)))

# 
appm2error3mon1_37 <- full_join(appm2error3mon1_36,appm2error3mon_37,by = intersect(names(appm2error3mon1_36),names(appm2error3mon_37)))    
# #rep5
# 
appm2error3mon_38 <-  appm2dma.3mon1 %>%  
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff5 = dmaptindxr5pain - dmaptindxr5pain_d) %>% 
  filter(dma3pt_stand_ind_diff5 != 0 | is.na(dma3pt_stand_ind_diff5)) %>% 
  select(record_id,redcap_event_name,dma3pt_stand_ind_diff5) %>%  
  mutate(dma3pt_stand_ind_diff5 = case_when(is.na(dma3pt_stand_ind_diff5) ~ "x",TRUE ~ as.character(dma3pt_stand_ind_diff5)))  


appm2error3mon1_38 <- full_join(appm2error3mon1_37,appm2error3mon_38,by = intersect(names(appm2error3mon1_37),names(appm2error3mon_38)))  


#check if pt specific site comparison was entered if both sites were tested or patient specific sites were assessed 
appm2error3mon_49 <-  appm2dma.3mon1 %>%  
  filter(dmatestcompyn_3m != 0 & dmaptspecsite_3m != 1) %>% 
  filter(is.na(dmaptsenscompare)) %>% 
  select(record_id,redcap_event_name,dmaptsenscompare) %>%
  mutate(dmaptsenscompare = case_when(is.na(dmaptsenscompare) ~ "x",TRUE ~ as.character(dmaptsenscompare))) 

appm2error3mon1_49 <- full_join(appm2error3mon1_38,appm2error3mon_49,by = intersect(names(appm2error3mon1_38),names(appm2error3mon_49)))   


#check if pt specific site assessed  was entered if pt specific sites were tested  
appm2error3mon_50 <-  appm2dma.3mon1 %>%  
  filter(dmatestcompyn_3m == 1 |(dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1) & (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>% 
  filter(is.na(dmaptspecsite_3m)) %>% 
  select(record_id,redcap_event_name,dmaptspecsite_3m) %>%
  mutate(dmaptspecsite_3m = case_when(is.na(dmaptspecsite_3m) ~ "x",TRUE ~ as.character(dmaptspecsite_3m))) 

appm2error3mon1_50 <- full_join(appm2error3mon1_49,appm2error3mon_50,by = intersect(names(appm2error3mon1_49),names(appm2error3mon_50)))  



#merge 3 month and baseline errors

appm2dma_baseline_3mon1 <- full_join(appm2error3mon1_50 ,appm2error_0_2_dma_stand_cont_ind_6,by = intersect(names(appm2error3mon1_50 ),names(appm2error_0_2_dma_stand_cont_ind_6)))









appm2dma_baseline_3mon1 <- appm2dma_baseline_3mon1 %>% 
  as_tibble() %>% 
  mutate_all(as.character)






#ensure each combination of ID and redcap event has one row with all values and is not duplicated

appm2dma_baseline_3mon1[appm2dma_baseline_3mon1 == ""] <- NA

appm2dma_baseline_3mon1 <- appm2dma_baseline_3mon1 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch DAG

appm2dma_notes <- appqdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# now add notes


appdma_shrink_notes  <- left_join(appm2dma_baseline_3mon1,appm2dma_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )



#PPTs


# Explore variables and check for missingness in "ppt test completed"



#Remove records with missing "ppt test completed"

appm2data.ppt <- appqdatam2 %>% 
  filter(!is.na(pptcompleteyn))

#recheck if NAs removed


# keep record with "ppt test completed"

appm2ppt.complete <- appm2data.ppt %>% 
  filter(qst_mcc1_v03_complete == 2) %>% 
  filter(pptcompleteyn != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site(chest):
#data$pptcompleteyn.factor = factor(data$pptcompleteyn,levels=c("1","2","3","0"))
#levels(data$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (chest)","no, neither site")


#Remote site:
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral:

#rep1
appm2errorppt2.1 <-  appm2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremoter1val - pptremoter1val_d) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>% 
  mutate(pptremoter1val = case_when(is.na(pptremoter1val) ~ "x",TRUE ~ as.character(pptremoter1val))) %>% 
  mutate(pptremoter1val_d = case_when(is.na(pptremoter1val_d) ~ "x",TRUE ~ as.character(pptremoter1val_d) )) %>% 
  select(record_id,redcap_event_name,pptremoter1val,pptremoter1val_d) 

#rep2
appm2errorppt2.2 <-  appm2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremoter2val - pptremoter2val_d) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2)) %>% 
  mutate(pptremoter2val = case_when(is.na(pptremoter2val) ~ "x",TRUE ~ as.character(pptremoter2val))) %>% 
  mutate(pptremoter2val_d = case_when(is.na(pptremoter2val_d) ~ "x",TRUE ~ as.character(pptremoter2val_d) )) %>%
  select(record_id,redcap_event_name,pptremoter2val,pptremoter2val_d)  



#rep3

appm2errorppt2.3 <-  appm2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremoter3val - pptremoter3val_d) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>% 
  mutate(pptremoter3val = case_when(is.na(pptremoter3val) ~ "x",TRUE ~ as.character(pptremoter3val))) %>% 
  mutate(pptremoter3val_d = case_when(is.na(pptremoter3val_d) ~ "x",TRUE ~ as.character(pptremoter3val_d) )) %>%
  select(record_id,redcap_event_name,pptremoter3val,pptremoter3val_d)

appm2errorppt2 <-  full_join(appm2errorppt2.1,appm2errorppt2.2,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,appm2errorppt2.3,by= c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site::

#rep1
appm2errorppt3.1 <-  appm2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff1 = pptindxr1val - pptindxr1val_d) %>% 
  filter(ppt_indexr_diff1 != 0 | is.na(ppt_indexr_diff1)) %>%
  mutate(pptindxr1val = case_when(is.na(pptindxr1val) ~ "x",TRUE ~ as.character(pptindxr1val))) %>% 
  mutate(pptindxr1val_d = case_when(is.na(pptindxr1val_d) ~ "x",TRUE ~ as.character(pptindxr1val_d) )) %>%
  select(record_id,redcap_event_name,pptindxr1val,pptindxr1val_d)


#rep2
appm2errorppt3.2 <-  appm2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff2 = pptindxr2val - pptindxr2val_d) %>% 
  filter(ppt_indexr_diff2 != 0 | is.na(ppt_indexr_diff2)) %>% 
  mutate(pptindxr2val = case_when(is.na(pptindxr2val) ~ "x",TRUE ~ as.character(pptindxr2val))) %>% 
  mutate(pptindxr2val_d = case_when(is.na(pptindxr2val_d) ~ "x",TRUE ~ as.character(pptindxr2val_d) )) %>%
  select(record_id,redcap_event_name,pptindxr2val,pptindxr2val_d) 

#rep3

appm2errorppt3.3 <-  appm2ppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff3 = pptindxr3val - pptindxr3val_d) %>% 
  filter(ppt_indexr_diff3 != 0 | is.na(ppt_indexr_diff3)) %>% 
  mutate(pptindxr3val = case_when(is.na(pptindxr3val) ~ "x",TRUE ~ as.character(pptindxr3val))) %>% 
  mutate(pptindxr3val_d = case_when(is.na(pptindxr3val_d) ~ "x",TRUE ~ as.character(pptindxr3val_d) )) %>%
  select(record_id,redcap_event_name,pptindxr3val,pptindxr3val_d) 

appm2errorppt3a <-  full_join(appm2errorppt3.1,appm2errorppt3.2,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,appm2errorppt3.3,by= c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#merge errorppt2 and 3a


appm2errorppt2_3 <- full_join(appm2errorppt2,appm2errorppt3a,by = intersect(names(appm2errorppt2), names(appm2errorppt3a)))


#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 




appm2errorppt3b.1 <- appm2ppt.complete %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindxr1val) & !is.na(pptindxr1val_d))  | (!is.na(pptindxr2val)  & !is.na(pptindxr2val_d)) | (!is.na(pptindxr3val)  & !is.na(pptindxr3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptindxr1val,pptindxr1val_d,pptindxr2val,pptindxr2val_d,pptindxr3val,pptindxr3val_d,index1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(as.character(.)))

appm2errorppt3b.2 <- appm2ppt.complete %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindxr1val) & is.na(pptindxr1val_d))  | (is.na(pptindxr2val)  & is.na(pptindxr2val_d)) | (is.na(pptindxr3val)  & is.na(pptindxr3val_d))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,index2,pptindxr1val,pptindxr1val_d,pptindxr2val,pptindxr2val_d,pptindxr3val,pptindxr3val_d)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

appm2errorppt3b.2 <- appm2errorppt3b.2 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  ) 

appm2errorppt3b.3 <- appm2ppt.complete %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremoter1val) & !is.na(pptremoter1val_d))  | (!is.na(pptremoter2val)  & !is.na(pptremoter2val_d)) | (!is.na(pptremoter3val)  & !is.na(pptremoter3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,remote1,pptremoter1val,pptremoter1val_d,pptremoter2val,pptremoter2val_d,pptremoter3val,pptremoter3val_d) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(as.character(.))) 

appm2errorppt3b.4 <- appm2ppt.complete %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremoter1val) & is.na(pptremoter1val_d))  | (is.na(pptremoter2val)  & is.na(pptremoter2val_d)) | (is.na(pptremoter3val)  & is.na(pptremoter3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  select(record_id,redcap_event_name,remote2,pptremoter1val,pptremoter1val_d,pptremoter2val,pptremoter2val_d,pptremoter3val,pptremoter3val_d) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

appm2errorppt3b.4 <- appm2errorppt3b.4 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  ) 

#merge errorppt 3
###########
appm2errorppt3c <- full_join(appm2errorppt3b.1,appm2errorppt3b.2,by = intersect(names(appm2errorppt3b.1), names(appm2errorppt3b.2)))
appm2errorppt3d <- full_join(appm2errorppt3b.3,appm2errorppt3b.4,by = intersect(names(appm2errorppt3b.3), names(appm2errorppt3b.4)))
# 
# ###########
appm2errorppt3b <- full_join(appm2errorppt3c,appm2errorppt3d,by = intersect(names(appm2errorppt3c), names(appm2errorppt3d)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# 
# errorppt3b[] <- lapply(errorppt3b, as.character)
# errorppt2_3[] <- lapply(errorppt2_3, as.character)


appm2errorppt2_3_3b <- full_join(appm2errorppt2_3,appm2errorppt3b,by = intersect(names(appm2errorppt2_3), names(appm2errorppt3b)))

# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


appm2ppt.biomarker <- appm2ppt.complete %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindxr1val,pptindxr2val,pptindxr3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindxr1val,pptindxr2val,pptindxr3val) %>% 
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


appm2ppt.biomarker1 <- appm2ppt.complete %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremoter1val,pptremoter2val,pptremoter3val) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


appm2ppt.all.biomarker <- full_join(appm2ppt.biomarker,appm2ppt.biomarker1,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)






appm2all.ppt <- full_join(appm2errorppt2_3_3b,appm2ppt.all.biomarker,by = intersect(names(appm2errorppt2_3_3b ), names(appm2ppt.all.biomarker)))


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

appm2all.ppt[appm2all.ppt == ""] <- NA

appm2all.ppt <- appm2all.ppt %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch dag

appm2ppt_notes <- appqdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes


appm2ppt_shrink_notes  <- left_join(appm2all.ppt,appm2ppt_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )





# MCC2 Temporal summation
#explore variables



#PPTs



#Remove records with missing "ts test completed"

appm2data.ts <- appqdatam2 %>% 
  filter(!is.na(tscompleted))


# keep record with "tscompleted test completed"

appm2ts.complete <- appm2data.ts %>% 
  filter(tscompleted != 0)



#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
appm2errorppt4.1 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsremoter1initial - tsremoter1initial_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1)) %>% 
  mutate(tsremoter1initial = case_when(is.na(tsremoter1initial) ~ "missing",TRUE ~ as.character(tsremoter1initial))) %>% 
  mutate(tsremoter1initial_d = case_when(is.na(tsremoter1initial_d) ~ "missing",TRUE ~ as.character(tsremoter1initial_d) )) %>%
  select(record_id,redcap_event_name,tsremoter1initial,tsremoter1initial_d,tscompleted) 


#rep1 final
appm2errorppt4.2 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsremoter1final - tsremoter1final_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  mutate(tsremoter1final = case_when(is.na(tsremoter1final) ~ "missing",TRUE ~ as.character(tsremoter1final))) %>% 
  mutate(tsremoter1final_d = case_when(is.na(tsremoter1final_d) ~ "missing",TRUE ~ as.character(tsremoter1final_d) )) %>%
  select(record_id,redcap_event_name,tsremoter1final,tsremoter1final_d,tscompleted) 


#rep1 set 
appm2rep1.set <- full_join(appm2errorppt4.1,appm2errorppt4.2,by = c("record_id","redcap_event_name","tscompleted"))

#rep2 initial

appm2errorppt4.3 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsremoter2initial - tsremoter2initial_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  mutate(tsremoter2initial = case_when(is.na(tsremoter2initial) ~ "missing",TRUE ~ as.character(tsremoter2initial))) %>% 
  mutate(tsremoter2initial_d = case_when(is.na(tsremoter2initial_d) ~ "missing",TRUE ~ as.character(tsremoter2initial_d) )) %>%
  select(record_id,redcap_event_name,tsremoter2initial,tsremoter2initial_d,tscompleted) 

#rep2 final
appm2errorppt4.4 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsremoter2final - tsremoter2final_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  mutate(tsremoter2final = case_when(is.na(tsremoter2final) ~ "missing",TRUE ~ as.character(tsremoter2final))) %>% 
  mutate(tsremoter2final_d = case_when(is.na(tsremoter2final_d) ~ "missing",TRUE ~ as.character(tsremoter2final_d) )) %>%
  select(record_id,redcap_event_name,tsremoter2final,tsremoter2final_d,tscompleted) 

#rep2 set 

appm2rep2.set <- full_join(appm2errorppt4.3,appm2errorppt4.4,by = c("record_id","redcap_event_name","tscompleted"))


#rep3 initial

appm2errorppt4.5 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsremoter3initial - tsremoter3initial_d) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>% 
  mutate(tsremoter3initial = case_when(is.na(tsremoter3initial) ~ "missing",TRUE ~ as.character(tsremoter3initial))) %>% 
  mutate(tsremoter3initial_d = case_when(is.na(tsremoter3initial_d) ~ "missing",TRUE ~ as.character(tsremoter3initial_d) )) %>%
  select(record_id,redcap_event_name,tsremoter3initial,tsremoter3initial_d,tscompleted) 

#rep3 final
appm2errorppt4.6 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsremoter3final - tsremoter3final_d) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3)) %>% 
  mutate(tsremoter3final = case_when(is.na(tsremoter3final) ~ "missing",TRUE ~ as.character(tsremoter3final))) %>% 
  mutate(tsremoter3final_d = case_when(is.na(tsremoter3final_d) ~ "missing",TRUE ~ as.character(tsremoter3final_d) )) %>%
  select(record_id,redcap_event_name,tsremoter3final,tsremoter3final_d,tscompleted) 

#rep3 set 
appm2rep3.set <- full_join(appm2errorppt4.5,appm2errorppt4.6,by = c("record_id","redcap_event_name","tscompleted"))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

appm2Ts_remote_all_reps1 <- full_join(appm2rep1.set,appm2rep2.set,by = c("record_id","redcap_event_name","tscompleted")) %>% 
  full_join(.,appm2rep3.set,by= c("record_id","redcap_event_name","tscompleted"))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
appm2ts1 <- appm2Ts_remote_all_reps1 %>% 
  mutate(rep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter1initial))  & (is.na(tsremoter1initial_d))  & (is.na(tsremoter1final)) & (is.na(tsremoter1final_d))~ 1,TRUE ~ 0)) %>% 
  mutate(rep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter2initial))  & (is.na(tsremoter2initial_d))  & (is.na(tsremoter2final)) & (is.na(tsremoter2final_d))~ 1,TRUE ~ 0)) %>% 
  mutate(rep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter3initial))  & (is.na(tsremoter3initial_d))  & (is.na(tsremoter3final)) & (is.na(tsremoter3final_d))~ 1,TRUE ~ 0))


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d ))

#index site Index site 

# check for missing or mismatch in pain ratings for  Index site in both site OR  Index site 

#rep1 initial
appm2errorppt6.1 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsindxr1initial - tsindxr1initial_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  mutate(tsindxr1initial = case_when(is.na(tsindxr1initial) ~ "missing",TRUE ~ as.character(tsindxr1initial))) %>%
  mutate(tsindxr1initial_d = case_when(is.na(tsindxr1initial_d) ~ "missing",TRUE ~ as.character(tsindxr1initial_d) ))%>%
  select(record_id,redcap_event_name,tsindxr1initial,tsindxr1initial_d,tscompleted)

#rep1 final 

appm2errorppt6.2 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsindxr1final - tsindxr1final_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  mutate(tsindxr1final = case_when(is.na(tsindxr1final) ~ "missing",TRUE ~ as.character(tsindxr1final))) %>%
  mutate(tsindxr1final_d = case_when(is.na(tsindxr1final_d) ~ "missing",TRUE ~ as.character(tsindxr1final_d) ))%>%
  select(record_id,redcap_event_name,tsindxr1final,tsindxr1final_d,tscompleted)



#rep1 set 
appm2rep1.index.set <- full_join(appm2errorppt6.1,appm2errorppt6.2,by = c("record_id","redcap_event_name","tscompleted"))

#rep2 initial

appm2errorppt6.3 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsindxr2initial - tsindxr2initial_d) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>% 
  mutate(tsindxr2initial = case_when(is.na(tsindxr2initial) ~ "missing",TRUE ~ as.character(tsindxr2initial)))%>%
  mutate(tsindxr2initial_d = case_when(is.na(tsindxr2initial_d) ~ "missing",TRUE ~ as.character(tsindxr2initial_d) ))%>%
  select(record_id,redcap_event_name,tsindxr2initial,tsindxr2initial_d,tscompleted)


#rep2 final
appm2errorppt6.4 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsindxr2final - tsindxr2final_d) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  mutate(tsindxr2final = case_when(is.na(tsindxr2final) ~ "missing",TRUE ~ as.character(tsindxr2final)))%>%
  mutate(tsindxr2final_d = case_when(is.na(tsindxr2final_d) ~ "missing",TRUE ~ as.character(tsindxr2final_d) ))%>%
  select(record_id,redcap_event_name,tsindxr2final,tsindxr2final_d,tscompleted)


#rep2 set 
appm2rep2.index.set <- full_join(appm2errorppt6.3,appm2errorppt6.4,by = c("record_id","redcap_event_name","tscompleted"))


#rep3 initial

appm2errorppt6.5 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsindxr3initial - tsindxr3initial_d) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>% 
  mutate(tsindxr3initial = case_when(is.na(tsindxr3initial) ~ "missing",TRUE ~ as.character(tsindxr3initial)))%>%
  mutate(tsindxr3initial_d = case_when(is.na(tsindxr3initial_d) ~ "missing",TRUE ~ as.character(tsindxr3initial_d) ))%>%
  select(record_id,redcap_event_name,tsindxr3initial,tsindxr3initial_d,tscompleted) 

#rep3 final
appm2errorppt6.6 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsindxr3final - tsindxr3final_d) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  mutate(tsindxr3final = case_when(is.na(tsindxr3final) ~ "missing",TRUE ~ as.character(tsindxr3final)))%>%
  mutate(tsindxr3final_d = case_when(is.na(tsindxr3final_d) ~ "missing",TRUE ~ as.character(tsindxr3final_d) )) %>% 
  select(record_id,redcap_event_name,tsindxr3final,tsindxr3final_d,tscompleted) 

#rep3 set 
appm2rep3.index.set <- full_join(appm2errorppt6.5,appm2errorppt6.6,by = c("record_id","redcap_event_name","tscompleted"))

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
appm2Ts_index_all_reps1 <- full_join(appm2rep1.index.set,appm2rep2.index.set,by = c("record_id","redcap_event_name","tscompleted")) %>% 
  full_join(.,appm2rep3.index.set,by= c("record_id","redcap_event_name","tscompleted"))

##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0

appm2ts.index1 <- appm2Ts_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr1initial))  & (is.na(tsindxr1initial_d))  & (is.na(tsindxr1final)) & (is.na(tsindxr1final_d))~ 1,TRUE ~ 0)) 


appm2ts.index1 <- appm2ts.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr2initial))  & (is.na(tsindxr2initial_d))  & (is.na(tsindxr2final)) & (is.na(tsindxr2final_d))~ 1,TRUE ~ 0))


appm2ts.index1 <- appm2ts.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr3initial))  & (is.na(tsindxr3initial_d))  & (is.na(tsindxr3final)) & (is.na(tsindxr3final_d))~ 1,TRUE ~ 0))


# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d))



appm2ts1 <- appm2ts1 %>% 
  mutate(all.reps.rem = case_when(rep1 == 0  & rep2==0  & rep3==0  ~ 0,TRUE ~ 1))

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
appm2ts.index1 <- appm2ts.index1 %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == 0  & ind.rep2==0  & ind.rep3==0  ~ 0,TRUE ~ 1))
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
appm2rem.ind <- full_join(appm2ts1,appm2ts.index1,by = c("record_id","redcap_event_name","tscompleted")) %>% 
  filter((tscompleted == 2 & all.reps.rem == 0)| (tscompleted == 3 & all.reps.ind == 0) | (tscompleted == 1 & all.reps.rem == 0 |all.reps.ind == 0 ))


appm2rem_index_all_reps <- appm2rem.ind %>% 
  select(record_id,redcap_event_name,all.reps.rem,all.reps.ind)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("all_TS_remote_missing" = all.reps.rem,"all_TS_index_missing"= all.reps.ind)

# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

appm2errorppt5.1 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsremoteafter15)) %>% 
  select(record_id,redcap_event_name,tsremoteafter15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsremoteafter15=replace_na("x")) 


# missing after sensation at 30 secs
appm2errorppt5.2 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts31)) %>% 
  select(record_id,redcap_event_name,tsfinalpainremafts31)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremafts31=replace_na("x")) 
# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# errorppt5.1[] <- lapply(errorppt5.1, as.character)
# errorppt5.2[] <- lapply(errorppt5.2, as.character)


appm2Ts_remote_all_reps_sensations <- full_join(appm2rem_index_all_reps,appm2errorppt5.1,by = c("record_id","redcap_event_name")) %>% 
  full_join(.,appm2errorppt5.2,by= c("record_id","redcap_event_name"))


# once TS  Index site is completed
# missing after sensation at 15 secs

appm2errorppt7.1 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsindxafter15)) %>% 
  select(record_id,redcap_event_name,tsindxafter15)%>% 
  mutate(tsindxafter15=replace_na("x")) 


# missing after sensation at 30 secs
appm2errorppt7.2 <-  appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsindxafter30)) %>% 
  select(record_id,redcap_event_name,tsindxafter30) %>% 
  mutate(tsindxafter30=replace_na("x"))

# convert all char for merging
appm2Ts_remote_all_reps_sensations[] <- lapply(appm2Ts_remote_all_reps_sensations, as.character)
appm2errorppt7.1[] <- lapply(appm2errorppt7.1, as.character)
appm2errorppt7.2[] <- lapply(appm2errorppt7.2, as.character)


#merge all
appm2Ts_index_remote_all_reps_sensation <- full_join(appm2Ts_remote_all_reps_sensations,appm2errorppt7.1,by = c("record_id","redcap_event_name")) %>% 
  full_join(.,appm2errorppt7.2,by= c("record_id","redcap_event_name"))


# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

appm2errorppt7.3a <- appm2ts.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsindxr1initial) & !is.na(tsindxr1initial_d))  | (!is.na(tsindxr1final)  & !is.na(tsindxr1final_d)) | (!is.na(tsindxr2initial )  & !is.na(tsindxr2initial_d)) | (!is.na(tsindxr2final) & !is.na(tsindxr2final_d))  | (!is.na(tsindxr3initial)  & !is.na(tsindxr3initial_d)) | (!is.na(tsindxr3final)  & !is.na(tsindxr3final_d))  ~ "x",TRUE ~ "0"))  %>% 
  filter(ts.index1 == "x")   %>% 
  select(record_id,redcap_event_name,ts.index1) %>% 
  rename("mismatch_bw_site_and_datafilled"=ts.index1)

#OR b.if both sites was checked but pain ratings not filled out for the index site 


appm2errorppt7.3b <- appm2ts.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsindxr1initial) & is.na(tsindxr1initial_d)  & is.na(tsindxr1final)  & is.na(tsindxr1final_d) & is.na(tsindxr2initial )  & is.na(tsindxr2initial_d) & is.na(tsindxr2final) & is.na(tsindxr2final_d)  & is.na(tsindxr3initial)  & is.na(tsindxr3initial_d) & is.na(tsindxr3final)  & is.na(tsindxr3final_d)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )

# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 



appm2errorppt7.4a <- appm2ts.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsremoter1initial) & !is.na(tsremoter1initial_d))  | (!is.na(tsremoter1final)  & !is.na(tsremoter1final_d)) | (!is.na(tsremoter2initial)  & !is.na(tsremoter2initial_d)) | (!is.na(tsremoter2final) & !is.na(tsremoter2final_d))  | (!is.na(tsremoter3initial)  & !is.na(tsremoter3initial_d)) | (!is.na(tsremoter3final)  & !is.na(tsremoter3final_d))  ~ "x",TRUE ~ "0"))  %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(ts.remote1 == "x") %>% 
  select(record_id,redcap_event_name,ts.remote1) %>% 
  rename("mismatch_bw_site_and_datafilled"=ts.remote1)
#OR b.if both sites was checked but pain ratings not filled out for the remote site


appm2errorppt7.4b <- appm2ts.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsremoter1initial) & is.na(tsremoter1initial_d)  & is.na(tsremoter1final)  & is.na(tsremoter1final_d) & is.na(tsremoter2initial)  & is.na(tsremoter2initial_d) & is.na(tsremoter2final) & is.na(tsremoter2final_d)  & is.na(tsremoter3initial)  & is.na(tsremoter3initial_d) & is.na(tsremoter3final)  & is.na(tsremoter3final_d)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d)%>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


#merge 7.3a,7.3b,7.4a,7.4b





appm2errorppt7.3a[] <- lapply(appm2errorppt7.3a, as.character)
appm2errorppt7.3b[] <- lapply(appm2errorppt7.3b, as.character)
appm2errorppt7.4a[] <- lapply(appm2errorppt7.4a, as.character)
appm2errorppt7.4b[] <- lapply(appm2errorppt7.4b, as.character)


appm2merged7.3 <- full_join(appm2errorppt7.3a,appm2errorppt7.3b,by = intersect(names(appm2errorppt7.3a), names(appm2errorppt7.3b)))
appm2merged7.4 <- full_join(appm2errorppt7.4a,appm2errorppt7.4b,by = intersect(names(appm2errorppt7.4a), names(appm2errorppt7.4b)))

appm2merged7 <- full_join(appm2merged7.3,appm2merged7.4,by = intersect(names(appm2merged7.3), names(appm2merged7.4)))


#rename merged7
appm2merged7.1 <- appm2merged7 
# change  to as.character for merging
appm2Ts_index_remote_all_reps_sensation [] <- lapply(appm2Ts_index_remote_all_reps_sensation , as.character)
appm2merged7.1[] <- lapply(appm2merged7.1, as.character)




#merge Ts_index_remote_all_reps_sensation and merged7.1 

appm2merge8 <- full_join(appm2merged7.1,appm2Ts_index_remote_all_reps_sensation ,by = intersect(names(appm2merged7.1), names(appm2Ts_index_remote_all_reps_sensation )))


# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
appm2prim.outcome.index <- appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsindxr1final,tsindxr1initial)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsindxr1initial) %>% 
  mutate(max.rep2.index = pmax(tsindxr2final,tsindxr2initial )) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsindxr2initial ) %>% 
  mutate(max.rep3.index = pmax(tsindxr3final,tsindxr3initial)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsindxr3initial) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsindxr1final,tsindxr1initial,tsindxr2final,tsindxr2initial ,tsindxr3final,tsindxr3initial)%>%
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


appm2prim.outcome.remote <- appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsremoter1initial,tsremoter1final)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsremoter1initial) %>% 
  mutate(max.rep2.remote = pmax(tsremoter2initial,tsremoter2final)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsremoter2initial) %>% 
  mutate(max.rep3.remote = pmax(tsremoter3initial,tsremoter3final)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsremoter3initial) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tsremoter1initial,tsremoter1final,tsremoter2initial,tsremoter2final,tsremoter3initial,tsremoter3final)%>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


appm2ts_primary_outcome <-  full_join(appm2prim.outcome.index, appm2prim.outcome.remote ,by = intersect(names( appm2prim.outcome.remote), names(appm2prim.outcome.index ))) 

# # change  to as.character for merging
appm2merge8 [] <- lapply(appm2merge8 , as.character)
appm2ts_primary_outcome[] <- lapply(appm2ts_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

appm2ts.all.prim.outcome <- full_join(appm2merge8,appm2ts_primary_outcome ,by = intersect(names(appm2merge8), names(appm2ts_primary_outcome)))


# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
appm2sec.outcome.index <- appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsindxr1final,tsindxr1initial))) %>% 
  mutate(init.rep1.index1 = 1+(tsindxr1initial)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsindxr2final,tsindxr2initial ))) %>% 
  mutate(init.rep2.index1 = 1+(tsindxr2initial )) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsindxr3final,tsindxr3initial))) %>% 
  mutate(init.rep3.index1 = 1+(tsindxr3initial)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tsindxr1final,tsindxr1initial,tsindxr2final,tsindxr2initial ,tsindxr3final,tsindxr3initial) %>%
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
appm2sec.outcome.remote <- appm2ts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsremoter1initial,tsremoter1final))) %>% 
  mutate(init.rep1.remote1 = 1+(tsremoter1initial)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsremoter2initial,tsremoter2final))) %>% 
  mutate(init.rep2.remote1 = 1+(tsremoter2initial)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsremoter3initial,tsremoter3final))) %>% 
  mutate(init.rep3.remote1 = 1+(tsremoter3initial)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tsremoter1initial,tsremoter1final,tsremoter2initial,tsremoter2final,tsremoter3initial,tsremoter3final) %>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )

appm2ts_sec_outcome <-  full_join(appm2sec.outcome.index, appm2sec.outcome.remote ,by = intersect(names( appm2sec.outcome.remote), names(appm2sec.outcome.index ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# change  to as.character for merging
appm2ts_sec_outcome [] <- lapply(appm2ts_sec_outcome , as.character)
appm2ts.all.prim.outcome[] <- lapply(appm2ts.all.prim.outcome, as.character)

#merge ts_sec_outcome  with ts.all.prim.outcome

appm2ts.all.prim.sec.outcome <- full_join(appm2ts_sec_outcome ,appm2ts.all.prim.outcome ,by = intersect(names(appm2ts_sec_outcome), names(appm2ts.all.prim.outcome )))



appm2ts.all.prim.sec.outcome <- appm2ts.all.prim.sec.outcome  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

appm2ts.all.prim.sec.outcome[appm2ts.all.prim.sec.outcome == ""] <- NA

appm2all.ts <- appm2ts.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch dag

appm2ts_notes <- appqdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes

appm2ts_shrink_notes  <- left_join(appm2all.ts,appm2ts_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )




# mcc2 Conditioned Pain Modulation





#Remove records with missing "cp test completed"

appm2data1cp <- appqdatam2 %>% 
  filter(!is.na(cpmcompleteyn))


# keep record with "cpm test completed"

appm2cpm.complete <- appm2data1cp %>% 
  filter(cpmcompleteyn != 0)




#water temp not checked

appm2cpm.error1 <- appm2cpm.complete %>% 
  filter(cpmcoldwatertemp != 1) %>% 
  select(record_id,redcap_event_name,cpmcoldwatertemp) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwatertemp = case_when(cpmcoldwatertemp != 1 ~ "x",TRUE ~ "x"))

# missing or mismatch in cold water pain rating at 30 sec

appm2cpm.error2 <- appm2cpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30 - cpmcoldwaterpain30_d) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  mutate(cpmcoldwaterpain30 = case_when(is.na(cpmcoldwaterpain30) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmcoldwaterpain30_d = case_when(is.na(cpmcoldwaterpain30_d) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmcoldwaterpain30,cpmcoldwaterpain30_d) 

# missing or mismatch in cold water pain rating at 60 sec
appm2cpm.error3 <- appm2cpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60 - cpmcoldwaterpain60_d) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>% 
  mutate(cpmcoldwaterpain60 = case_when(is.na(cpmcoldwaterpain60) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmcoldwaterpain60_d = case_when(is.na(cpmcoldwaterpain60_d) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,cpmcoldwaterpain60,cpmcoldwaterpain60_d)

#merge error 2&3
appm2errorcpm2_3 <- full_join(appm2cpm.error2,appm2cpm.error3,by = c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

##merge error 1 with 2&3
appm2errorcpm1_2_3 <- full_join(appm2cpm.error1,appm2errorcpm2_3,by = c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#check for missing/mismatch in ppts

appm2cpm.error4.1 <- appm2cpm.complete %>% 
  mutate(diff_cpm1 = cpmpptremr1val - cpmpptremr1val_d) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>% 
  mutate(cpmpptremr1val = case_when(is.na(cpmpptremr1val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmpptremr1val_d = case_when(is.na(cpmpptremr1val_d) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,cpmpptremr1val,cpmpptremr1val_d) 

#check for missing/mismatch in ppts

appm2cpm.error4.2 <- appm2cpm.complete %>% 
  mutate(diff_cpm2 = cpmpptremr2val - cpmpptremr2val_d) %>% 
  filter(diff_cpm2!=0 | is.na(diff_cpm2)) %>% 
  mutate(cpmpptremr2val = case_when(is.na(cpmpptremr2val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmpptremr2val_d = case_when(is.na(cpmpptremr2val_d) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,cpmpptremr2val,cpmpptremr2val_d) 

#check for missing/mismatch in ppts

appm2cpm.error4.3 <- appm2cpm.complete %>% 
  mutate(diff_cpm3 = cpmpptremr3val - cpmpptremr3val_d) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>% 
  mutate(cpmpptremr3val = case_when(is.na(cpmpptremr3val) ~ "x",TRUE ~ "x")) %>%
  mutate(cpmpptremr3val_d = case_when(is.na(cpmpptremr3val_d) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,cpmpptremr3val,cpmpptremr3val_d) 

#merge 4.1-.3

appm2cpm.error4 <- full_join(appm2cpm.error4.1,appm2cpm.error4.2,by = c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


appm2cpm.final <- full_join(appm2cpm.error4,appm2errorcpm1_2_3,by = c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


appm2cmp.prim.outcome <- appm2cpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmpptremr1val,cpmpptremr2val,cpmpptremr3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn,pptcompleteyn,pptremoter1val,pptremoter2val,pptremoter3val,cpmpptremr1val,cpmpptremr2val,cpmpptremr3val) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


appm2cmp.sec.outcome <- appm2cpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmpptremr1val,cpmpptremr2val,cpmpptremr3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn,pptcompleteyn,pptremoter1val,pptremoter2val,pptremoter3val,cpmpptremr1val,cpmpptremr2val,cpmpptremr3val) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


appm2cmp.outcome <- full_join(appm2cmp.prim.outcome ,appm2cmp.sec.outcome ,by = intersect(names(appm2cmp.prim.outcome), names(appm2cmp.sec.outcome))) 


#change  to as.character for merging
appm2cmp.outcome [] <- lapply(appm2cmp.outcome , as.character)
appm2cpm.final[] <- lapply(appm2cpm.final, as.character)

#merge all cmp errors

appm2all.cmp <-  full_join(appm2cmp.outcome ,appm2cpm.final ,by = intersect(names(appm2cmp.outcome), names(appm2cpm.final))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




appm2all.cmp[appm2all.cmp == ""] <- NA

appm2all.cmp <- appm2all.cmp %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch dag

appm2cmp_notes <- appqdatam2 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes

appm2cpm_shrink_notes  <- left_join(appm2all.cmp,appm2cmp_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )





#link with imaging data

appm2qst.img <- irimagingm2 



# select needed variables
appm2data.image1 <- appm2qst.img %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl)


appm2data.qst <-  appqdatam2 %>%
  select(record_id,redcap_event_name,redcap_data_access_group,cuffpfmricontraindyn,cuffpfmricontrainddomyn,cuffpfmripressure,cuffpfmripressure_d,qst_mcc1_v03_complete)



# change  to as.character for merging
appm2data.image1 [] <- lapply(appm2data.image1 , as.character)
appm2data.qst[] <- lapply(appm2data.qst, as.character)

#merge both
appm2qst.image <-  full_join(appm2data.image1 ,appm2data.qst ,by = intersect(names(appm2data.image1), names(appm2data.qst)))



#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging



appm2qst.image1 <- appm2qst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(cuffpfmripressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_data_access_group,redcap_event_name,fmricuffipyn,fmricuffcompletescl,cuffpfmricontraindyn,cuffpfmricontrainddomyn,fmricuffcontrarecal,cuffpfmripressure,cuffpfmripressure_d,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  mutate(cuffpfmricontraindyn = case_when(is.na(cuffpfmricontraindyn) ~ "x",TRUE ~ as.character(cuffpfmricontraindyn)))%>% 
  mutate(cuffpfmricontrainddomyn = case_when(is.na(cuffpfmricontrainddomyn) ~ "x",TRUE ~ as.character(cuffpfmricontrainddomyn)))%>% 
  mutate(fmricuffcontrarecal = case_when(is.na(fmricuffcontrarecal) ~ "x",TRUE ~ as.character(fmricuffcontrarecal) )) %>% 
  mutate(cuffpfmripressure = case_when(is.na(cuffpfmripressure) ~ "x",TRUE ~ as.character(cuffpfmripressure) )) %>% 
  mutate(cuffpfmripressure_d = case_when(is.na(cuffpfmripressure_d) ~ "x",TRUE ~ as.character(cuffpfmripressure_d) )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "x",TRUE ~ as.character(fmricuffcalfpressurerecal) )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "x",TRUE ~ as.character(fmricuffcalfpressurerecal2) )) %>%
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) 




appm2trqst_table <- full_join(appdma_shrink_notes,appm2ppt_shrink_notes,by = intersect(names(appdma_shrink_notes), names(appm2ppt_shrink_notes
)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

appm2trqst_table1 <- full_join(appm2trqst_table,appm2ts_shrink_notes,by = intersect(names(appm2trqst_table), names(appm2ts_shrink_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

appm2trqst_table2 <- full_join(appm2trqst_table1,appm2cpm_shrink_notes,by = intersect(names(appm2trqst_table1), names(appm2cpm_shrink_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


appm2tr_final_image <-  full_join(appm2trqst_table2,appm2qst.image1,by = intersect(names(appm2trqst_table2), names(appm2qst.image1))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



appm2tr_final_image [appm2tr_final_image == ""] <- NA


appm2tr_img_table <- appm2tr_final_image %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2qst_complete = 0)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




# recode 0,1 ie incomplete/unverified to 2
appm2ta.img_all <- appqdatam2 %>% 
  filter(qst_mcc1_v03_complete == 0 |qst_mcc1_v03_complete == 1) %>% 
  mutate(m2qst_complete = case_when(qst_mcc1_v03_complete == 0 |qst_mcc1_v03_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2qst_complete,redcap_data_access_group)




appm2tr_img_table[] <- lapply(appm2tr_img_table, as.character)
appm2ta.img_all[] <- lapply(appm2ta.img_all, as.character)

#merge all
appm2error_ta_img_all <- full_join(appm2tr_img_table,appm2ta.img_all,by = intersect(names(appm2tr_img_table), names(appm2ta.img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  relocate(m2qst_complete, .after = redcap_data_access_group)

# table(appqdatam2$qst_mcc1_v03_complete)
# table(appm2ta.img_all$m2qst_complete)
# table(appm2error_ta_img_all$m2qst_complete,exclude = FALSE)
# 






# recode NAs to 8 in the original dataset, select DAG as well
appm2data_ta.img_all <- appqdatam2 %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(qst_mcc1_v03_complete = case_when(is.na(qst_mcc1_v03_complete) ~ "8", TRUE ~ as.character(qst_mcc1_v03_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,qst_mcc1_v03_complete) 


table(appm2data_ta.img_all$qst_mcc1_v03_complete,exclude = NULL)




#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

appm2error_ta_img_all[appm2error_ta_img_all== ""] <- NA


appm2error_ta_img_all <- appm2error_ta_img_all%>%
  pivot_longer(cols = 5:last_col(),
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>%
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>%
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group","m2qst_complete"),
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


table(appm2error_ta_img_all$m2qst_complete,exclude = NULL)




# qst_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
appm2full_ta.img <- full_join(appm2error_ta_img_all,appm2data_ta.img_all,by = intersect(names(appm2error_ta_img_all), names(appm2data_ta.img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2qst_complete = case_when(qst_mcc1_v03_complete == "8" ~ "8", TRUE ~ as.character(m2qst_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-qst_mcc1_v03_complete) %>% 
  relocate(m2qst_complete,.after=redcap_data_access_group)





# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
appm2dat.qst <- appm2full_ta.img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "mmc2_QST") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2qst_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "mcc2_QST") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>% #
  mutate(mb.qst = case_when(error == "clean" ~ 1,
                            error == 2 ~ 2,
                            error == 8 ~ 8,
                            TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))




appm2data_qst_wide <- appm2dat.qst %>%
  pivot_wider (names_from = dataset,values_from = error) 

table(appm2data_qst_wide$mb.qst) 
table(appqdatam2$qst_mcc1_v03_complete,exclude = NULL)



########## mcc1 thoracic REPORTS#######

datam1t <- datam1t_1 %>% 
  filter(!record_id %in% withdrawm1t$record_id) %>% 
  filter(!record_id %in% test_records) %>% 
  select(-sleepnighthourmindurhrs,-sleepnighthourmindurmins,-sleepnighthourmindur) 
#functional


#Read m2frfunc

m1tfrfunc <- retype(datam1t) 


#Setting Labels

label(m1tfrfunc$record_id)="Record ID"
label(m1tfrfunc$redcap_event_name)="Event Name"
label(m1tfrfunc$ftdbcdeepbrthinitscl)="1a. Initial Pain Rating: "
label(m1tfrfunc$ftdbcdeepbrthinitscl2)="1b. Initial Pain Rating: (double entry)"
label(m1tfrfunc$ftdbcdeepbrthfinalscl)="2a. Final Pain Rating: "
label(m1tfrfunc$ftdbcdeepbrthfinalscl2)="2b. Final Pain Rating: (double entry)"
label(m1tfrfunc$ftdbccoughfinalscl)="3a. Final Pain Rating:"
label(m1tfrfunc$ftdbccoughfinalscl2)="3b. Final Pain Rating: (double entry)"
label(m1tfrfunc$ftdbctestcmpltyn)="Test completed:"
label(m1tfrfunc$ftdbctestcmpltno)="If no, choose one of the following"
label(m1tfrfunc$ftdbcaddlnotes)="Additional notes"
label(m1tfrfunc$functional_testing_mcc2_v01_complete)="Complete?"
#Setting Units


#Setting Factors(will create new variable for factors)
m1tfrfunc$redcap_event_name.factor = factor(m1tfrfunc$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","6mo_postop_day_8_arm_1","6mo_postop_day_9_arm_1","6mo_postop_day_10_arm_1","6mo_postop_day_11_arm_1","6mo_postop_day_12_arm_1","6mo_postop_day_13_arm_1","6mo_postop_day_14_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m1tfrfunc$ftdbcdeepbrthinitscl.factor = factor(m1tfrfunc$ftdbcdeepbrthinitscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m1tfrfunc$ftdbcdeepbrthinitscl2.factor = factor(m1tfrfunc$ftdbcdeepbrthinitscl2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m1tfrfunc$ftdbcdeepbrthfinalscl.factor = factor(m1tfrfunc$ftdbcdeepbrthfinalscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m1tfrfunc$ftdbcdeepbrthfinalscl2.factor = factor(m1tfrfunc$ftdbcdeepbrthfinalscl2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m1tfrfunc$ftdbccoughfinalscl.factor = factor(m1tfrfunc$ftdbccoughfinalscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m1tfrfunc$ftdbccoughfinalscl2.factor = factor(m1tfrfunc$ftdbccoughfinalscl2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m1tfrfunc$ftdbctestcmpltyn.factor = factor(m1tfrfunc$ftdbctestcmpltyn,levels=c("1","0"))
m1tfrfunc$ftdbctestcmpltno.factor = factor(m1tfrfunc$ftdbctestcmpltno,levels=c("1","2","3"))
m1tfrfunc$functional_testing_mcc2_v01_complete.factor = factor(m1tfrfunc$functional_testing_mcc2_v01_complete,levels=c("0","1","2"))

levels(m1tfrfunc$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","6-Mo Post-Op Day 8","6-Mo Post-Op Day 9","6-Mo Post-Op Day 10","6-Mo Post-Op Day 11","6-Mo Post-Op Day 12","6-Mo Post-Op Day 13","6-Mo Post-Op Day 14","12-Mo Post-Op","Event Reporting")
levels(m1tfrfunc$ftdbcdeepbrthinitscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m1tfrfunc$ftdbcdeepbrthinitscl2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m1tfrfunc$ftdbcdeepbrthfinalscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m1tfrfunc$ftdbcdeepbrthfinalscl2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m1tfrfunc$ftdbccoughfinalscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m1tfrfunc$ftdbccoughfinalscl2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m1tfrfunc$ftdbctestcmpltyn.factor)=c("Yes","No")
levels(m1tfrfunc$ftdbctestcmpltno.factor)=c("Did not attempt either deep breathing or coughing tasks","Did not complete deep breathing portion only","Did not complete coughing portion only")
levels(m1tfrfunc$functional_testing_mcc2_v01_complete.factor)=c("Incomplete","Unverified","Complete")





#Check for subjects who did not complete the test.
table(m1tfrfunc$ftdbctestcmpltyn.factor,m1tfrfunc$ftdbctestcmpltyn, exclude = NULL)




#remove records with missing values for test completed.
m1tfrfunc2 <- m1tfrfunc %>% 
  drop_na(ftdbctestcmpltyn)


#Recheck if all records with missing m1tfrfunc for completed tests were removed.
table(m1tfrfunc2$ftdbctestcmpltyn, exclude = NULL)






#keep records for subjects who completed the test.
m1tfrfunc3 <- m1tfrfunc2 %>% 
  filter(ftdbctestcmpltyn == 1)



#look for discrepancies in the initial pain rating 
m1tfrfunc4 <- m1tfrfunc3 %>% 
  mutate(init_pain_diff = ftdbcdeepbrthinitscl - ftdbcdeepbrthinitscl2) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

m1tfrerror1 <- m1tfrfunc4 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbcdeepbrthinitscl,ftdbcdeepbrthinitscl2)%>% 
  mutate(ftdbcdeepbrthinitscl = case_when(is.na(ftdbcdeepbrthinitscl) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthinitscl))) %>% 
  mutate(ftdbcdeepbrthinitscl2 = case_when(is.na(ftdbcdeepbrthinitscl2) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthinitscl2) )) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#look for discrepancies between the first and the second final pain rating 
m1tfrfunc5 <- m1tfrfunc3 %>% 
  mutate(final_pain_diff = ftdbcdeepbrthfinalscl - ftdbcdeepbrthfinalscl2 ) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff))

m1tfrerror2 <- m1tfrfunc5 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbcdeepbrthfinalscl,ftdbcdeepbrthfinalscl2) %>% 
  mutate(ftdbcdeepbrthfinalscl = case_when(is.na(ftdbcdeepbrthfinalscl) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthfinalscl))) %>% 
  mutate(ftdbcdeepbrthfinalscl2 = case_when(is.na(ftdbcdeepbrthfinalscl2) ~ "missing",TRUE ~ as.character(ftdbcdeepbrthfinalscl2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m1tfrerror1_2 <- full_join(m1tfrerror1,m1tfrerror2,by = intersect(names(m1tfrerror1), names(m1tfrerror2)))





#look for discrepancies between the first and the second cough pain 
m1tfrfunc6 <- m1tfrfunc3 %>% 
  mutate(cough_diff = ftdbccoughfinalscl - ftdbccoughfinalscl2) %>% 
  filter(cough_diff != 0 | is.na(cough_diff))

m1tfrerror3 <- m1tfrfunc6 %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbccoughfinalscl,ftdbccoughfinalscl2)%>%
  mutate(ftdbccoughfinalscl = case_when(is.na(ftdbccoughfinalscl) ~ "missing",TRUE ~ as.character(ftdbccoughfinalscl))) %>% 
  mutate(ftdbccoughfinalscl2 = case_when(is.na(ftdbccoughfinalscl2) ~ "missing",TRUE ~ as.character(ftdbccoughfinalscl2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m1tfrerror1_2_3 <- full_join(m1tfrerror1_2,m1tfrerror3,by = intersect(names(m1tfrerror1_2), names(m1tfrerror3)))




# if test not completed was the reason checked off, use m1tfrfunc2 (with completed records) 

m1tfrerror4 <- m1tfrfunc2 %>% 
  filter(ftdbctestcmpltyn == 0) %>% 
  filter(is.na(ftdbctestcmpltno)) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbctestcmpltyn.factor,ftdbctestcmpltno) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(ftdbctestcmpltno = case_when(is.na(ftdbctestcmpltno) ~ "missing",TRUE ~ as.character(ftdbctestcmpltno))) # recode NA to missing or leave as is





m1tfrerror1_2_3_4 <- full_join(m1tfrerror1_2_3,m1tfrerror4,by = intersect(names(m1tfrerror1_2_3), names(m1tfrerror4)))



#if test complete is not NA then was the  functional_testing_mcc2_v01_complete.factor complete?

m1tfrerror5 <- m1tfrfunc %>% 
  filter(!is.na(ftdbctestcmpltyn)) %>% 
  filter(is.na(functional_testing_mcc2_v01_complete))%>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbctestcmpltyn.factor,functional_testing_mcc2_v01_complete.factor)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m1tfrerror1_5 <- full_join(m1tfrerror1_2_3_4,m1tfrerror5,by = intersect(names(m1tfrerror1_2_3_4), names(m1tfrerror5)))



# rename variables

m1tfrerror1_5 <-m1tfrerror1_5 %>%
  rename("1a. Initial Pain Rating: "=ftdbcdeepbrthinitscl,
         "1b. Initial Pain Rating: (double entry)"=ftdbcdeepbrthinitscl2,
         "2a. Final Pain Rating: "=ftdbcdeepbrthfinalscl,
         "2b. Final Pain Rating: (double entry)"=ftdbcdeepbrthfinalscl2,
         "3a. Final Pain Rating:"=ftdbccoughfinalscl,
         "3b. Final Pain Rating: (double entry)"=ftdbccoughfinalscl2,
         "Test completed:"=ftdbctestcmpltyn.factor,
         "If no, choose one of the following"=ftdbctestcmpltno,
         "Complete?"=functional_testing_mcc2_v01_complete.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#fetch notes

m1tnotes.cough <- m1tfrfunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,ftdbcaddlnotes) %>% 
  rename("notes"=ftdbcaddlnotes ) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



##### m2frfunc entries from REDCap were checked for m2frerrors and the the following IDs and their respective events were flagged:


##### **Deep Breathing and Coughing**
#####  The records enlisted below were flagged when checking for one or more of the following m2frerrors:



# * Discrepancies between the first and the second initial pain ratings 
# * Discrepancies between the first and the second final pain ratings
# * Discrepancies between the first and the second cough pain
# * If test not completed was the reason checked off
# * If test was completed then was the  functional_testing_mcc2_v01_complete.factor complete?
#   
#   
# 
#   





#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m1tcough1 <- m1tfrerror1_5  %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)








# now add notes


m1tcough1_notes <- left_join(m1tcough1,m1tnotes.cough,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group))%>% 
  left_join(.,m1tdays_from_sysdate, by=c("record_id","redcap_event_name"))



# MCC1 thoracic Imaging

#Read Data
m1tirimaging <- retype(datam1t)



label(m1tirimaging$record_id)="Record ID"
label(m1tirimaging$redcap_event_name)="Event Name"
label(m1tirimaging$fmricuff_initials)="Investigator initials:"
label(m1tirimaging$fmripatientname)="Verify Patient Name (as entered into scanner console):  Patient name: first name: followed by a 5-digit REDCap patient ID; last name: A2CPS Site code: UM for U of MichiganWS for Wayne StateSH for Spectrum Health Visit code: V1 for baseline visitV3 for 3-month visit Example: UM10078V1 (first name) A2CPS (last name) "
label(m1tirimaging$fmricuffleg)="Cuff applied to R/L leg: (hint: MCC2: non-dominant leg)"
label(m1tirimaging$fmricuffcontrarecal)="Re-calibration of pressure needed:"
label(m1tirimaging$fmricuffcalfpressurerecal)="Calf pressure, contralateral calf, Pressure 2: "
label(m1tirimaging$fmricuffcalfpressurerecal2)="Calf pressure, contralateral calf, Pressure 2: (double entry) "
label(m1tirimaging$fmricufft1techrating)="Please enter technologists quality rating for the T1 scan: "
label(m1tirimaging$fmricufft1repeated)="T1 scan repeated?"
label(m1tirimaging$fmricufft1techrating2)="Please enter technologists quality rating for the 2nd T1 scan: "
label(m1tirimaging$fmricuffrestpainss)="Surgical site pain"
label(m1tirimaging$fmricuffrestpainss2)="Surgical site pain (double entry)"
label(m1tirimaging$fmricuffrestpainovrall)="Body pain"
label(m1tirimaging$fmricuffrestpainovrall2)="Body pain (double entry)"
label(m1tirimaging$fmricuffcurrpainaftfirstscanss)="Surgical site"
label(m1tirimaging$fmricuffcurrpainaftfirstscanss2)="Surgical site (double entry)"
label(m1tirimaging$fmricuffcurrpainaftfirstscanovrall)="Body pain"
label(m1tirimaging$fmricuffcurrpainaftfirstscanovrall2)="Body pain (double entry)"
label(m1tirimaging$fmricuffcurrpainaftfirstscancuff)="Cuff pain"
label(m1tirimaging$fmricuffcurrpainaftfirstscancuff2)="Cuff (double entry)"
label(m1tirimaging$fmricuffpainbegin)="cuff pain beginning"
label(m1tirimaging$fmricuffpainbegin2)="cuff pain beginning (double entry)"
label(m1tirimaging$fmricuffpainmid)="cuff pain middle"
label(m1tirimaging$fmricuffpainmid2)="cuff pain middle (double entry)"
label(m1tirimaging$fmricuffpainend)="cuff pain end"
label(m1tirimaging$fmricuffpainend2)="cuff pain end (double entry)"
label(m1tirimaging$fmricuffpaincpbegin)="cuff pain beginning"
label(m1tirimaging$fmricuffpaincpbegin2)="cuff pain beginning (double entry)"
label(m1tirimaging$fmricuffpaincpmid)="cuff pain middle"
label(m1tirimaging$fmricuffpaincpmid2)="cuff pain middle (double entry)"
label(m1tirimaging$fmricuffpaincpend)="cuff pain end"
label(m1tirimaging$fmricuffpaincpend2)="cuff pain end (double entry)"
label(m1tirimaging$fmricuffpainrestscanbegin)="cuff pain beginning"
label(m1tirimaging$fmricuffpainrestscanbegin2)="cuff pain beginning (double entry)"
label(m1tirimaging$fmricuffpainrestscanmid)="cuff pain middle"
label(m1tirimaging$fmricuffpainrestscanmid2)="cuff pain middle (double entry)"
label(m1tirimaging$fmricuffpainrestscanend)="cuff pain end"
label(m1tirimaging$fmricuffpainrestscanend2)="cuff pain end (double entry)"
label(m1tirimaging$fmricuffpainaftlastscanss)="Surgical site pain"
label(m1tirimaging$fmricuffpainaftlastscanss2)="Surgical site pain (double entry)"
label(m1tirimaging$fmricuffpainaftlastscanany)="Body pain"
label(m1tirimaging$fmricuffpainaftlastscanany2)="Body pain (double entry)"
label(m1tirimaging$fmricuffcompletescl)="Test Completed:"
label(m1tirimaging$fmricufft1yn)="T1"
label(m1tirimaging$fmricuffdwiyn)="DWI"
label(m1tirimaging$fmricuffrest1yn)="1rst Resting state"
label(m1tirimaging$fmricuffipyn)="fMRI individualized pressure"
label(m1tirimaging$fmricuffspyn)="fMRI standard pressure"
label(m1tirimaging$fmricuffrest2yn)="2nd Resting state"
label(m1tirimaging$fmricuffdicuploaded)="Dicom files uploaded to TACC:"
label(m1tirimaging$fmricuffdicupdate)="Upload date/time"
label(m1tirimaging$fmricuffnotes)="Additional notes for imaging"
label(m1tirimaging$imaging_mcc2_v01_complete)="Complete?"
#Setting Units


#Setting Factors(will create new variable for factors)
m1tirimaging$redcap_event_name.factor = factor(m1tirimaging$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","6mo_postop_day_8_arm_1","6mo_postop_day_9_arm_1","6mo_postop_day_10_arm_1","6mo_postop_day_11_arm_1","6mo_postop_day_12_arm_1","6mo_postop_day_13_arm_1","6mo_postop_day_14_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m1tirimaging$fmricuffleg.factor = factor(m1tirimaging$fmricuffleg,levels=c("1","2"))
m1tirimaging$fmricuffcontrarecal.factor = factor(m1tirimaging$fmricuffcontrarecal,levels=c("1","0"))
m1tirimaging$fmricufft1techrating.factor = factor(m1tirimaging$fmricufft1techrating,levels=c("3","2","1"))
m1tirimaging$fmricufft1repeated.factor = factor(m1tirimaging$fmricufft1repeated,levels=c("1","0"))
m1tirimaging$fmricufft1techrating2.factor = factor(m1tirimaging$fmricufft1techrating2,levels=c("3","2","1"))
m1tirimaging$fmricuffrestpainss.factor = factor(m1tirimaging$fmricuffrestpainss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffrestpainss2.factor = factor(m1tirimaging$fmricuffrestpainss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffrestpainovrall.factor = factor(m1tirimaging$fmricuffrestpainovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffrestpainovrall2.factor = factor(m1tirimaging$fmricuffrestpainovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcurrpainaftfirstscanss.factor = factor(m1tirimaging$fmricuffcurrpainaftfirstscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcurrpainaftfirstscanss2.factor = factor(m1tirimaging$fmricuffcurrpainaftfirstscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcurrpainaftfirstscanovrall.factor = factor(m1tirimaging$fmricuffcurrpainaftfirstscanovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcurrpainaftfirstscanovrall2.factor = factor(m1tirimaging$fmricuffcurrpainaftfirstscanovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcurrpainaftfirstscancuff.factor = factor(m1tirimaging$fmricuffcurrpainaftfirstscancuff,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcurrpainaftfirstscancuff2.factor = factor(m1tirimaging$fmricuffcurrpainaftfirstscancuff2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainbegin.factor = factor(m1tirimaging$fmricuffpainbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainbegin2.factor = factor(m1tirimaging$fmricuffpainbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainmid.factor = factor(m1tirimaging$fmricuffpainmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainmid2.factor = factor(m1tirimaging$fmricuffpainmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainend.factor = factor(m1tirimaging$fmricuffpainend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainend2.factor = factor(m1tirimaging$fmricuffpainend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpaincpbegin.factor = factor(m1tirimaging$fmricuffpaincpbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpaincpbegin2.factor = factor(m1tirimaging$fmricuffpaincpbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpaincpmid.factor = factor(m1tirimaging$fmricuffpaincpmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpaincpmid2.factor = factor(m1tirimaging$fmricuffpaincpmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpaincpend.factor = factor(m1tirimaging$fmricuffpaincpend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpaincpend2.factor = factor(m1tirimaging$fmricuffpaincpend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainrestscanbegin.factor = factor(m1tirimaging$fmricuffpainrestscanbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainrestscanbegin2.factor = factor(m1tirimaging$fmricuffpainrestscanbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainrestscanmid.factor = factor(m1tirimaging$fmricuffpainrestscanmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainrestscanmid2.factor = factor(m1tirimaging$fmricuffpainrestscanmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainrestscanend.factor = factor(m1tirimaging$fmricuffpainrestscanend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainrestscanend2.factor = factor(m1tirimaging$fmricuffpainrestscanend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainaftlastscanss.factor = factor(m1tirimaging$fmricuffpainaftlastscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainaftlastscanss2.factor = factor(m1tirimaging$fmricuffpainaftlastscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainaftlastscanany.factor = factor(m1tirimaging$fmricuffpainaftlastscanany,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffpainaftlastscanany2.factor = factor(m1tirimaging$fmricuffpainaftlastscanany2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m1tirimaging$fmricuffcompletescl.factor = factor(m1tirimaging$fmricuffcompletescl,levels=c("1","2","0"))
m1tirimaging$fmricufft1yn.factor = factor(m1tirimaging$fmricufft1yn,levels=c("1","0"))
m1tirimaging$fmricuffdwiyn.factor = factor(m1tirimaging$fmricuffdwiyn,levels=c("1","0"))
m1tirimaging$fmricuffrest1yn.factor = factor(m1tirimaging$fmricuffrest1yn,levels=c("1","0"))
m1tirimaging$fmricuffipyn.factor = factor(m1tirimaging$fmricuffipyn,levels=c("1","0"))
m1tirimaging$fmricuffspyn.factor = factor(m1tirimaging$fmricuffspyn,levels=c("1","0"))
m1tirimaging$fmricuffrest2yn.factor = factor(m1tirimaging$fmricuffrest2yn,levels=c("1","0"))
m1tirimaging$fmricuffdicuploaded.factor = factor(m1tirimaging$fmricuffdicuploaded,levels=c("1","0"))
m1tirimaging$imaging_mcc2_v01_complete.factor = factor(m1tirimaging$imaging_mcc2_v01_complete,levels=c("0","1","2"))



levels(m1tirimaging$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","6-Mo Post-Op Day 8","6-Mo Post-Op Day 9","6-Mo Post-Op Day 10","6-Mo Post-Op Day 11","6-Mo Post-Op Day 12","6-Mo Post-Op Day 13","6-Mo Post-Op Day 14","12-Mo Post-Op","Event Reporting")
levels(m1tirimaging$fmricuffleg.factor)=c("Right","Left")
levels(m1tirimaging$fmricuffcontrarecal.factor)=c("Yes","No")
levels(m1tirimaging$fmricufft1techrating.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels(m1tirimaging$fmricufft1repeated.factor)=c("Yes","No")
levels(m1tirimaging$fmricufft1techrating2.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels(m1tirimaging$fmricuffrestpainss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffrestpainss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffrestpainovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffrestpainovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcurrpainaftfirstscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcurrpainaftfirstscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcurrpainaftfirstscanovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcurrpainaftfirstscanovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcurrpainaftfirstscancuff.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcurrpainaftfirstscancuff2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpaincpbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpaincpbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpaincpmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpaincpmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpaincpend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpaincpend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainrestscanbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainrestscanbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainrestscanmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainrestscanmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainrestscanend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainrestscanend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainaftlastscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainaftlastscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainaftlastscanany.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffpainaftlastscanany2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(m1tirimaging$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
levels(m1tirimaging$fmricufft1yn.factor)=c("Yes","No")
levels(m1tirimaging$fmricuffdwiyn.factor)=c("Yes","No")
levels(m1tirimaging$fmricuffrest1yn.factor)=c("Yes","No")
levels(m1tirimaging$fmricuffipyn.factor)=c("Yes","No")
levels(m1tirimaging$fmricuffspyn.factor)=c("Yes","No")
levels(m1tirimaging$fmricuffrest2yn.factor)=c("Yes","No")
levels(m1tirimaging$fmricuffdicuploaded.factor)=c("Yes","No")
levels(m1tirimaging$imaging_mcc2_v01_complete.factor)=c("Incomplete","Unverified","Complete")









#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

m1tirdf.complete <- m1tirimaging %>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc2_v01_complete == 2)






#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, 
#Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure


m1tirerror1a <- m1tirdf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffspyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) & (cuffpfmricontrainddomyn != 1 | cuffpfmricontraindyn !=1)) %>% 
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffleg.factor,fmricuffspyn.factor,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("fMRI individualized pressure" = fmricuffipyn.factor,"fMRI standard pressure"= fmricuffspyn.factor,"Test Completed"= fmricuffcompletescl.factor, "cuff applied to R/L leg"=fmricuffleg.factor ))%>% 
  mutate("cuff applied to R/L leg"=replace_na("missing")) 


# . For the UM site only, there are two scanners that could be used, and based on study protocol subjects 
#returning for "V3" scans should have them done on the same scanner as at "V1", check for same scanner within a subject




m1tirerror1b <-m1tirdf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffspyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffspyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "missing"))  %>% 
  rename("Test Completed"= fmricuffcompletescl.factor)


m1tirerror1 <- full_join(m1tirerror1a,m1tirerror1b,by = intersect(names(m1tirerror1a), names(m1tirerror1b)))



# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

m1tirerror2 <- m1tirdf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffcontrarecal.factor,fmricuffleg.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal))) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2))) %>% 
  rename(c("Re-calibration of pressure needed" = fmricuffcontrarecal.factor, "Recaliberation pressure 1"= fmricuffcalfpressurerecal,"Recaliberation pressure 1:double entry"=fmricuffcalfpressurerecal2, "cuff applied to R/L leg"=fmricuffleg.factor,"Test Completed"=fmricuffcompletescl.factor))

# merge error1 and 2 



m1tirerror1_2 <- full_join(m1tirerror1,m1tirerror2,by = intersect(names(m1tirerror1), names(m1tirerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

m1tirerror3 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricuffcompletescl.factor,fmricufft1yn,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,
         fmricufft1repeated.factor,fmricufft1repeated,fmricufft1techrating2,fmricufft1techrating2.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "missing",TRUE ~ as.character(fmricufft1techrating))) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated== "1"  ~ "missing",TRUE ~ as.character(fmricufft1techrating2))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,fmricufft1repeated.factor,fmricufft1techrating2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"T1"=fmricufft1yn.factor,"Technologists quality rating for T1 scan"=fmricufft1techrating,"T1 scan repeated?"=fmricufft1repeated.factor,"Technologists quality rating for repeated T1 scan"=fmricufft1techrating2 ) %>% 
  select (c(record_id,redcap_event_name,"Test Completed","T1","Technologists quality rating for T1 scan","T1 scan repeated?","Technologists quality rating for repeated T1 scan"))



m1tirerror1_2_3 <- full_join(m1tirerror1_2,m1tirerror3,by = intersect(names(m1tirerror1_2), names(m1tirerror3)))






#before first resting state

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

m1tirerror4.1 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "missing",TRUE ~ as.character(fmricuffrestpainss))) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "missing",TRUE ~ as.character(fmricuffrestpainss2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainss,fmricuffrestpainss2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:surgical site pain"=fmricuffrestpainss,"Before 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffrestpainss2,"1st resting state"= fmricuffrest1yn.factor) 




# Check if first resting-state scan performed and there was a mismatch between entries overall body pain

m1tirerror4.2 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall))) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainovrall, fmricuffrestpainovrall2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:body pain"=fmricuffrestpainovrall,"Before 1st resting fMRI scan:body pain(double entry)"=fmricuffrestpainovrall2,"1st resting state"= fmricuffrest1yn.factor) 



m1tirerror4 <- full_join(m1tirerror4.1,m1tirerror4.2,by=c("record_id","Test Completed","redcap_event_name","1st resting state"))


m1tirerror1_2_3_4 <- full_join(m1tirerror1_2_3,m1tirerror4,by = intersect(names(m1tirerror1_2_3), names(m1tirerror4)))




# After first resting fMRI scan:

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

m1tirerror5.1 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2,fmricuffrest1yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss))) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss2) )) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:surgical site pain"=fmricuffcurrpainaftfirstscanss,"After 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffcurrpainaftfirstscanss2,"1st resting state"= fmricuffrest1yn.factor) 

# Check  if first resting-state scan and there was mismatch between entries for overall body pain

m1tirerror5.2 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall))) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:body pain"=fmricuffcurrpainaftfirstscanovrall,"After 1st resting fMRI scan:body pain(double entry)"=fmricuffcurrpainaftfirstscanovrall2,"1st resting state"= fmricuffrest1yn.factor) 



m1tirerror5.a <- full_join(m1tirerror5.1,m1tirerror5.2,by = intersect(names(m1tirerror5.1), names(m1tirerror5.2)))


# Check if individualized and standard performed but baseline was missing after first resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
m1tirerror5.bb <- m1tirdf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffspyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancuff - fmricuffcurrpainaftfirstscancuff2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscancuff,fmricuffcurrpainaftfirstscancuff2,fmricuffrest1yn.factor,fmricuffspyn.factor,
         fmricuffipyn.factor) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancuff = case_when(is.na(fmricuffcurrpainaftfirstscancuff) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancuff))) %>%
  mutate(fmricuffcurrpainaftfirstscancuff2 = case_when(is.na(fmricuffcurrpainaftfirstscancuff2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancuff2))) %>%
  rename("Test Completed"=fmricuffcompletescl.factor,"1st resting state"= fmricuffrest1yn.factor,"After 1st resting fMRI scan:cuff pain"=fmricuffcurrpainaftfirstscancuff,
         "After 1st resting fMRI scan:cuff pain(double entry)"=fmricuffcurrpainaftfirstscancuff2,"fMRI individualized pressure" = fmricuffipyn.factor, "fMRI standard pressure"= fmricuffspyn.factor)


m1tirerror1_2_3_4_5a <- full_join(m1tirerror1_2_3_4,m1tirerror5.a,by=intersect(names(m1tirerror1_2_3_4), names(m1tirerror5.a)))


m1tirerror1_2_3_4_5 <- full_join(m1tirerror1_2_3_4_5a,m1tirerror5.bb,by=intersect(names(m1tirerror1_2_3_4_5a), names(m1tirerror5.bb)))





# After first cuff fMRI scan

# check if first cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

m1tirerror6.1 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainbegin, fmricuffpainbegin2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain beginning"=fmricuffpainbegin,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain beginning)"=fmricuffpainbegin2)


# check if first cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

m1tirerror6.2 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainmid,fmricuffpainmid2,fmricuffipyn.factor) %>% mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "missing",TRUE ~ as.character(fmricuffpainmid))) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "missing",TRUE ~ as.character(fmricuffpainmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain mid"=fmricuffpainmid,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpainmid2)

# check if first cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

m1tirerror6.3 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainend,fmricuffpainend2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "missing",TRUE ~ as.character(fmricuffpainend))) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "missing",TRUE ~ as.character(fmricuffpainend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain end"=fmricuffpainend,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpainend2)

#create final set



m1tirerror6a <- full_join(m1tirerror6.1,m1tirerror6.2,by=intersect(names(m1tirerror6.1), names(m1tirerror6.2)))

m1tirerror6 <- full_join(m1tirerror6a,m1tirerror6.3,by=intersect(names(m1tirerror6a), names(m1tirerror6.3)))

m1tirerror1_2_3_4_5_6 <- full_join(m1tirerror1_2_3_4_5,m1tirerror6,by=intersect(names(m1tirerror1_2_3_4_5), names(m1tirerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

m1tirerror7.1 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpbegin, fmricuffpaincpbegin2,fmricuffspyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin))) %>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd cuff fMRI scan:cuff pain begin"=fmricuffpaincpbegin,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain begin)"=fmricuffpaincpbegin2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

m1tirerror7.2 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpmid,fmricuffpaincpmid2,fmricuffspyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid))) %>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd cuff fMRI scan:cuff pain mid"=fmricuffpaincpmid,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpaincpmid2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

m1tirerror7.3 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffspyn) & fmricuffspyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpend,fmricuffpaincpend2,fmricuffspyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "missing",TRUE ~ as.character(fmricuffpaincpend))) %>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "missing",TRUE ~ as.character(fmricuffpaincpend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd cuff fMRI scan:cuff pain end"=fmricuffpaincpend,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpaincpend2)

#create final set

m1tirerror7a <- full_join(m1tirerror7.1,m1tirerror7.2,by=intersect(names(m1tirerror7.1), names(m1tirerror7.2))) 

m1tirerror7 <- full_join(m1tirerror7.3,m1tirerror7a,by=intersect(names(m1tirerror7.3), names(m1tirerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
m1tirerror8.1 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2,fmricuffspyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin))) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd Resting state:cuff pain beginning"=fmricuffpainrestscanbegin,"After 2nd Resting state:cuff pain(double entry cuff pain beginning)"=fmricuffpainrestscanbegin2,"2nd Resting state" = fmricuffrest2yn.factor)


m1tirerror8.2 <- m1tirdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanmid,fmricuffpainrestscanmid2,fmricuffspyn.factor,fmricuffrest2yn.factor) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid))) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd Resting state:cuff pain mid"=fmricuffpainrestscanmid,"After 2nd Resting state:cuff pain(double entry cuff pain mid)"=fmricuffpainrestscanmid2,"2nd Resting state" = fmricuffrest2yn.factor)


m1tirerror8.3 <- m1tirdf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffspyn) & fmricuffspyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanend,fmricuffpainrestscanend2,fmricuffspyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend)))%>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffspyn.factor,"After 2nd Resting state:cuff pain end"=fmricuffpainrestscanend,"After 2nd Resting state:cuff pain(double entry cuff pain end)"=fmricuffpainrestscanend2,"2nd Resting state" = fmricuffrest2yn.factor)

#create full irerror8


m1tirerror8a1 <- full_join(m1tirerror8.1,m1tirerror8.2,by=intersect(names(m1tirerror8.1), names(m1tirerror8.2))) 

m1tirerror8a <- full_join(m1tirerror8.3,m1tirerror8a1,by=intersect(names(m1tirerror8.3), names(m1tirerror8a1))) 

#merge 7 and 8a 

m1tirerror7_8a <- full_join(m1tirerror7,m1tirerror8a,by=intersect(names(m1tirerror7), names(m1tirerror8a)))


#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
m1tirerror8.4 <- m1tirdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss)))%>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:surgical site pain"=fmricuffpainaftlastscanss,"After 2nd Resting state:surgical site pain(double entry)"=fmricuffpainaftlastscanss2,"2nd Resting state" = fmricuffrest2yn.factor)

#"Body pain (double entry)"

m1tirerror8.5 <- m1tirdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany)))%>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:body pain"=fmricuffpainaftlastscanany,"After 2nd Resting state:body pain(double entry)"=fmricuffpainaftlastscanany2,"2nd Resting state" = fmricuffrest2yn.factor)


m1tirerror8b<- full_join(m1tirerror8.4,m1tirerror8.5,by=intersect(names(m1tirerror8.4), names(m1tirerror8.5)))



#merge 7_8a and 8b

m1tirerror7_8a_8b <- full_join(m1tirerror7_8a,m1tirerror8b,by=intersect(names(m1tirerror7_8a), names(m1tirerror8b)))



#merge all

m1tirerror1_2_3_4_5_6_7_8 <- full_join(m1tirerror1_2_3_4_5_6,m1tirerror7_8a_8b,by=intersect(names(m1tirerror1_2_3_4_5_6), names(m1tirerror7_8a_8b)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") 







#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

m1tirerror9.1 <- m1tirimaging %>% 
  filter((imaging_mcc2_v01_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc2_v01_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffdicuploaded.factor = case_when(is.na(fmricuffdicuploaded.factor) ~ "missing",TRUE ~ as.character(fmricuffdicuploaded.factor))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,imaging_mcc2_v01_complete.factor,fmricuffdicuploaded.factor)%>% 
  rename("complete?"=imaging_mcc2_v01_complete.factor,"Dicom files uploaded to TACC?"=fmricuffdicuploaded.factor,"Test Completed"=fmricuffcompletescl.factor)





#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
m1tirerror9.2 <- m1tirimaging %>% 
  filter(imaging_mcc2_v01_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffcompletescl.factor = case_when(is.na(fmricuffcompletescl.factor) ~ "missing",TRUE ~ as.character(fmricuffcompletescl.factor))) %>% 
  select(record_id,redcap_event_name,imaging_mcc2_v01_complete.factor,fmricuffcompletescl.factor,fmricuffdicuploaded.factor) %>% 
  rename("complete?"=imaging_mcc2_v01_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"Dicom files uploaded to TACC"=fmricuffdicuploaded.factor)


#merge 9.1 and 9.2 

m1tirerror9.a <- full_join(m1tirerror9.1,m1tirerror9.2,by=intersect(names(m1tirerror9.1), names(m1tirerror9.2))) 


# calculate visit date - mask field introduced date
m1tresult_surg_no_na <- m1tresult_surg %>% 
  add_column(mask_date = as.Date("2021-11-05")) %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,mask_date,units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,mask_date,units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,mask_date,units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "mask_date_diff") %>% 
  mutate(mask_date_diff = gsub("days","",mask_date_diff)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(mask_date_diff = as.numeric(mask_date_diff))

# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

m1tirerror9.b <- m1tirimaging %>% 
  filter(imaging_mcc2_v01_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffspyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "missing",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc2_v01_complete.factor,fmricuffcompletescl.factor,fmri_face_mask) %>% 
  rename("complete?"=imaging_mcc2_v01_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"face mask worn"= fmri_face_mask) %>% 
  left_join(.,m1tresult_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(-mask_date_diff)



m1tirerror9 <- full_join(m1tirerror9.a,m1tirerror9.b,by=intersect(names(m1tirerror9.a), names(m1tirerror9.b))) 

#merge all plus error 9

m1tirerror1_2_3_4_5_6_7_8_9 <- full_join(m1tirerror1_2_3_4_5_6_7_8,m1tirerror9,by=intersect(names(m1tirerror1_2_3_4_5_6_7_8), names(m1tirerror9)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") %>% 
  mutate_all(as.character)



#fetch notes wit dag
m1tnotes.imaging <- m1tirimaging %>% 
  select(record_id,redcap_event_name,fmricuffnotes, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  rename("notes"=fmricuffnotes) %>% 
  as_tibble() 










m1tirerror1_2_3_4_5_6_7_8_shrink <- m1tirerror1_2_3_4_5_6_7_8_9 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#now merge with notes

m1tirerror1_2_3_4_5_6_7_8_notes <- left_join(m1tirerror1_2_3_4_5_6_7_8_shrink,m1tnotes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  left_join(.,m1tdays_from_sysdate, by=c("record_id","redcap_event_name"))










# mcc1 thoracic blood draw



#Read Data

m1tbrdata <- retype(datam1t)

label(m1tbrdata$record_id)="Record ID"
label(m1tbrdata$redcap_event_name)="Event Name"
label(m1tbrdata$bscp_sample_obtained___1)="7. Blood sample (choice=Not obtained)"
label(m1tbrdata$bscp_time_blood_draw)="Time completed blood draw: "
label(m1tbrdata$bscp_aliq_cnt)="Number of aliquots:"
label(m1tbrdata$bscp_time_centrifuge)="Time completed centrifuging: "
label(m1tbrdata$bscp_aliquot_freezer_time)="Time placed in freezer:"
label(m1tbrdata$bscp_deg_of_hemolysis)="Assess the degree of hemolysis of the plasma (Lavender tube) after centrifugation according to the laminated hemolysis color scale, and record the estimated hemoglobin value in g/L:"
label(m1tbrdata$bscp_lav1_not_obt___1)="Lavender #1: (choice=Not obtained)"
label(m1tbrdata$bscp_paxg_aliq_na___1)="PAXgene DNA tube: (choice=N/A)"
label(m1tbrdata$bscp_protocol_dev)="Did a protocol deviation occur:"
label(m1tbrdata$bscp_protocol_dev_reason)="Reason for protocol deviation:"
label(m1tbrdata$bscp_comments)="Comments"
#Setting Units









#Setting Factors(will create new variable for factors)
m1tbrdata$redcap_event_name.factor = factor(m1tbrdata$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m1tbrdata$bscp_sample_obtained___1.factor = factor(m1tbrdata$bscp_sample_obtained___1,levels=c("0","1"))
m1tbrdata$bscp_aliq_cnt.factor = factor(m1tbrdata$bscp_aliq_cnt,levels=c("0","1","2","3","4","5","6","7","8"))
m1tbrdata$bscp_deg_of_hemolysis.factor = factor(m1tbrdata$bscp_deg_of_hemolysis,levels=c("0",".25",".5","1","2","4","8"))
m1tbrdata$bscp_lav1_not_obt___1.factor = factor(m1tbrdata$bscp_lav1_not_obt___1,levels=c("0","1"))
m1tbrdata$bscp_paxg_not_obt___1.factor = factor(m1tbrdata$bscp_paxg_not_obt___1,levels=c("0","1"))

m1tbrdata$bscp_paxg_aliq_na___1.factor = factor(m1tbrdata$bscp_paxg_aliq_na___1,levels=c("0","1"))
m1tbrdata$bscp_protocol_dev.factor = factor(m1tbrdata$bscp_protocol_dev,levels=c("1","0"))
m1tbrdata$bscp_protocol_dev_reason.factor = factor(m1tbrdata$bscp_protocol_dev_reason,levels=c("1","2","3"))

levels(m1tbrdata$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(m1tbrdata$bscp_sample_obtained___1.factor)=c("Unchecked","Checked")
levels(m1tbrdata$bscp_aliq_cnt.factor)=c("0","1","2","3","4","5","6","7","8")
levels(m1tbrdata$bscp_deg_of_hemolysis.factor)=c("0","0.25","0.5","1","2","4","8")
levels(m1tbrdata$bscp_lav1_not_obt___1.factor)=c("Unchecked","Checked")
levels(m1tbrdata$bscp_paxg_aliq_na___1.factor)=c("Unchecked","Checked")
levels(m1tbrdata$bscp_paxg_not_obt___1.factor)=c("Unchecked","Checked")
levels(m1tbrdata$bscp_protocol_dev.factor)=c("Yes","No")
levels(m1tbrdata$bscp_protocol_dev_reason.factor)=c("Unable to obtain blood sample -technical reason","Unable to obtain blood sample -patient related","Sample handling/processing error")







# inspect data

problems(m1tbrdata)

glimpse(m1tbrdata)

# retype m1tbrdata incase future m1tbrdata has problems

m1tbrdata <- retype(m1tbrdata)

# inspect data again to make sure retyping didnt make erroneous assumptions
glimpse(m1tbrdata)






# detailed protocol on pg.230 of MOP



# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)




m1tbrdata1 <- m1tbrdata %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1.factor == "Unchecked" & blood_sample_collection_and_processing_crf_complete == 2)






# format time
m1tbrdata1$bscp_time_blood_draw <- ymd_hms(m1tbrdata1$bscp_time_blood_draw)

m1tbrdata1$bscp_time_centrifuge <- ymd_hms(m1tbrdata1$bscp_time_centrifuge)

m1tbrdata1$bscp_aliquot_freezer_time <- ymd_hms(m1tbrdata1$bscp_aliquot_freezer_time)











#check if blood draw time < centri time < freezer time 
m1tbrdata2 <- m1tbrdata1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor) 



m1tbrflag5 <- m1tbrdata2 %>%
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) %>%
  as_tibble() %>% 
  mutate_all(as.character)











#missing info on hours since last drink

m1tbrflag6 <- m1tbrdata1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "missing",TRUE ~ as.character(bscp_hrs_since_water))) 






m1tbrflag1_6 <- full_join(m1tbrflag5,m1tbrflag6,by = intersect(names(m1tbrflag5), names(m1tbrflag6))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#missing info on hours since last food


m1tbrflag7 <- m1tbrdata1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "missing",TRUE ~ as.character(bscp_hrs_since_food))) 





m1tbrflag1_7 <- full_join(m1tbrflag1_6,m1tbrflag7,by = intersect(names(m1tbrflag1_6), names(m1tbrflag7))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

m1tbrflag8 <- m1tbrdata1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "missing",TRUE ~ as.character(bscp_hrs_since_cafstim)))


m1tbrflag1_8 <- full_join(m1tbrflag1_7,m1tbrflag8,by = intersect(names(m1tbrflag1_7), names(m1tbrflag8))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on amount of caff
m1tbrflag9 <- m1tbrdata1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "missing",TRUE ~ as.character(bscp_caff_cups_amt))) 


m1tbrflag1_9 <- full_join(m1tbrflag1_8,m1tbrflag9,by = intersect(names(m1tbrflag1_8), names(m1tbrflag9 ))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on any vacc
m1tbrflag10 <- m1tbrdata1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "missing",TRUE ~ as.character(bscp_any_vacc))) 

m1tbrflag1_10 <- full_join(m1tbrflag1_9,m1tbrflag10,by = intersect(names(m1tbrflag1_9), names(m1tbrflag10)))






# if level of hemolysis was not entered

m1tbrflag11 <- m1tbrdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



m1tbrflag1_11<- full_join(m1tbrflag1_10,m1tbrflag11,by = intersect(names(m1tbrflag1_10), names(m1tbrflag11))) %>%
  as_tibble() %>% 
  mutate_all(as.character)







# if centrifuge time entered but freezing time not entered

m1tbrflag14.1 <- m1tbrdata1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "missing",TRUE ~ as.character(bscp_aliquot_freezer_time))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_aliquot_freezer_time)






m1tbrflag14.1 [] <- lapply(m1tbrflag14.1 , as.character)
m1tbrflag1_11 [] <- lapply(m1tbrflag1_11 , as.character)



m1tbrflag1_14.1<- full_join(m1tbrflag1_11,m1tbrflag14.1,by = intersect(names(m1tbrflag1_11), names(m1tbrflag14.1))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time entered but degree of hemolysis  not entered

m1tbrflag14.2 <- m1tbrdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)




m1tbrflag1_14.1 [] <- lapply(m1tbrflag1_14.1 , as.character)
m1tbrflag14.2 [] <- lapply(m1tbrflag14.2 , as.character)



m1tbrflag1_14.2<- full_join(m1tbrflag1_14.1,m1tbrflag14.2,by = intersect(names(m1tbrflag1_14.1), names(m1tbrflag14.2))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time not entered but degree of hemolysis entered

m1tbrflag14.3 <- m1tbrdata1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "missing",TRUE ~ as.character(bscp_time_centrifuge))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)



m1tbrflag1_14.2 [] <- lapply(m1tbrflag1_14.2 , as.character)
m1tbrflag14.3 [] <- lapply(m1tbrflag14.3 , as.character)




m1tbrflag1_14<- full_join(m1tbrflag1_14.2,m1tbrflag14.3,by = intersect(names(m1tbrflag1_14.2), names(m1tbrflag14.3))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#rename columns
m1tbrflag1_14 <- m1tbrflag1_14 %>% 
  rename("Time completed blood draw:"= bscp_time_blood_draw,"Time completed centrifuging:"=bscp_time_centrifuge,
         "Time placed in freezer:"= bscp_aliquot_freezer_time,"Assess the degree of hemolysis of the plasma (Lavender tube)"= bscp_deg_of_hemolysis,
         "hours since water"=bscp_hrs_since_water,"hours since food"=bscp_hrs_since_food,"amount of caffeine"= bscp_caff_cups_amt,
         "Any vaccine in last two weeks"= bscp_any_vacc,"hours since caffiene"=bscp_hrs_since_cafstim) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m1tbrflag1_14[] <- lapply(m1tbrflag1_14, as.character)

m1tbrflag1_14_shrink <- m1tbrflag1_14 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>%
  as_tibble() %>% 
  mutate_all(as.character)











m1tbrcomments <- m1tbrdata1  %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bscp_comments,bscp_sample_obtained___1.factor,bscp_lav1_not_obt___1.factor,bscp_paxg_aliq_na___1.factor,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor,bscp_samplekit_brcd)

m1tbrcomments[] <- lapply(m1tbrcomments, as.character)

m1tbrflag1_14_shrink[] <- lapply(m1tbrflag1_14_shrink, as.character)

m1tbrflag_comments <- left_join(m1tbrflag1_14_shrink,m1tbrcomments,by = intersect(names(m1tbrflag1_14_shrink), names(m1tbrcomments))) %>% 
  rename("Blood sample (choice=Not obtained)"= bscp_sample_obtained___1.factor,
         "Lavender #1: (choice=Not obtained)"= bscp_lav1_not_obt___1.factor,
         "PAXgene DNA tube: (choice=N/A)"= bscp_paxg_aliq_na___1.factor,
         "Did a protocol deviation occur:"= bscp_protocol_dev.factor,
         "Reason for protocol deviation:"= bscp_protocol_dev_reason.factor,
         "Comments"= bscp_comments,"sample kit barcode" = bscp_samplekit_brcd) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  left_join(.,m1tdays_from_sysdate, by=c("record_id","redcap_event_name")) 



# mcc1 thoraci QST





qdatam1t <-  retype(datam1t)







#Setting Labels

label(qdatam1t$record_id)="Record ID"
label(qdatam1t$redcap_event_name)="Event Name"
label(qdatam1t$redcap_data_access_group)="qdatam1t Access Group"
label(qdatam1t$pmachgchestpainyn)="1. New chest pain since surgery?"
label(qdatam1t$pmapainregion)="2. General region of pain"
label(qdatam1t$pmahighestloc)="3. Highest pain location"
label(qdatam1t$pmalowestloc)="4. Lowest pain location"
label(qdatam1t$pmamostpain)="5. Most painful region:"
label(qdatam1t$pptremoter1val)="Rep 1:"
label(qdatam1t$pptremoter1val_d)="Rep 1: (double entry)"
label(qdatam1t$pptremoter2val)="Rep 2:"
label(qdatam1t$pptremoter2val_d)="Rep 2: (double entry)"
label(qdatam1t$pptremoter3val)="Rep 3:"
label(qdatam1t$pptremoter3val_d)="Rep 3: (double entry)"
label(qdatam1t$dmacontr1pain)="Rep 1:"
label(qdatam1t$dmacontr1pain_d)="Rep 1: (double entry)"
label(qdatam1t$dmacontr2pain)="Rep 2:"
label(qdatam1t$dmacontr2pain_d)="Rep 2: (double entry)"
label(qdatam1t$dmacontr3pain)="Rep 3:"
label(qdatam1t$dmacontr3pain_d)="Rep 3: (double entry)"
label(qdatam1t$dmacontr4pain)="Rep 4:"
label(qdatam1t$dmacontr4pain_d)="Rep 4: (double entry)"
label(qdatam1t$dmacontr5pain)="Rep 5:"
label(qdatam1t$dmacontr5pain_d)="Rep 5: (double entry)"
label(qdatam1t$dmaindxr1pain)="Rep 1:"
label(qdatam1t$dmaindxr1pain_d)="Rep 1: (double entry)"
label(qdatam1t$dmaindxr2pain)="Rep 2:"
label(qdatam1t$dmaindxr2pain_d)="Rep 2: (double entry)"
label(qdatam1t$dmaindxr3pain)="Rep 3:"
label(qdatam1t$dmaindxr3pain_d)="Rep 3: (double entry)"
label(qdatam1t$dmaindxr4pain)="Rep 4:"
label(qdatam1t$dmaindxr4pain_d)="Rep 4: (double entry)"
label(qdatam1t$dmaindxr5pain)="Rep 5:"
label(qdatam1t$dmaindxr5pain_d)="Rep 5: (double entry)"
label(qdatam1t$dmasenscompare)="11. Sensation comparison standardized site"
label(qdatam1t$dmaptcontr1pain)="12. Rep 1:"
label(qdatam1t$dmaptcontr1pain_d)="12. Rep 1: (double entry)"
label(qdatam1t$dmaptcontr2pain)="13. Rep 2:"
label(qdatam1t$dmaptcontr2pain_d)="13. Rep 2: (double entry)"
label(qdatam1t$dmaptcontr3pain)="14. Rep 3:"
label(qdatam1t$dmaptcontr3pain_d)="14. Rep 3: (double entry)"
label(qdatam1t$dmaptcontr4pain)="15. Rep 4:"
label(qdatam1t$dmaptcontr4pain_d)="15. Rep 4: (double entry)"
label(qdatam1t$dmaptcontr5pain)="16. Rep 5:"
label(qdatam1t$dmaptcontr5pain_d)="16. Rep 5: (double entry)"
label(qdatam1t$dmaptindxr1pain)="17. Rep 1:"
label(qdatam1t$dmaptindxr1pain_d)="17. Rep 1: (double entry)"
label(qdatam1t$dmaptindxr2pain)="18. Rep 2:"
label(qdatam1t$dmaptindxr2pain_d)="18. Rep 2: (double entry)"
label(qdatam1t$dmaptindxr3pain)="19. Rep 3:"
label(qdatam1t$dmaptindxr3pain_d)="19. Rep 3: (double entry)"
label(qdatam1t$dmaptindxr4pain)="20. Rep 4:"
label(qdatam1t$dmaptindxr4pain_d)="20. Rep 4: (double entry)"
label(qdatam1t$dmaptindxr5pain)="21. Rep 5:"
label(qdatam1t$dmaptindxr5pain_d)="21. Rep 5: (double entry)"
label(qdatam1t$dmaptspecsite_3m)="22. Patient-Specific site assessed? (3-Month)"
label(qdatam1t$dmaptsenscompare)="23. Sensation comparison patient-specific site:"
label(qdatam1t$dmatestcompyn)="24A. DMA Test(s) completed"
label(qdatam1t$dmatestcompyn_3m)="24B. DMA Test(s) completed"
label(qdatam1t$dmatestcompwhich___1)="25. Choose all completed sites: (Baseline) (choice=1. Standardized control site (contralateral))"
label(qdatam1t$dmatestcompwhich___2)="25. Choose all completed sites: (Baseline) (choice=2. Standardized index site (surgical))"
label(qdatam1t$dmatestcompwhich_3m___1)="25. Choose all completed sites: (3-Month) (choice=1. Standardized control site (contralateral))"
label(qdatam1t$dmatestcompwhich_3m___2)="25. Choose all completed sites: (3-Month) (choice=2. Standardized index site (surgical))"
label(qdatam1t$dmatestcompwhich_3m___3)="25. Choose all completed sites: (3-Month) (choice=3. Patient specific control site (contralateral))"
label(qdatam1t$dmatestcompwhich_3m___4)="25. Choose all completed sites: (3-Month) (choice=4. Patient specific index site (surgical))"
label(qdatam1t$dmanotes)="26. Additional notes for DMA"
label(qdatam1t$pptindxr1val)="1. Rep 1:"
label(qdatam1t$pptindxr1val_d)="1. Rep 1: (double entry)"
label(qdatam1t$pptindxr2val)="2. Rep 2:"
label(qdatam1t$pptindxr2val_d)="2. Rep 2: (double entry)"
label(qdatam1t$pptindxr3val)="3. Rep 3:"
label(qdatam1t$pptindxr3val_d)="3. Rep 3: (double entry)"
label(qdatam1t$pptcompleteyn)="4. Test completed?"
label(qdatam1t$pptnotes)="Additional notes for baseline PPTs"
label(qdatam1t$tsremoter1initial)="1. Initial Pain Rating:"
label(qdatam1t$tsremoter1initial_d)="1. Initial Pain Rating: (double entry)"
label(qdatam1t$tsremoter1final)="2. Final Pain Rating:"
label(qdatam1t$tsremoter1final_d)="2. Final Pain Rating: (double entry)"
label(qdatam1t$tsremoter2initial)="3. Initial Pain Rating:"
label(qdatam1t$tsremoter2initial_d)="3. Initial Pain Rating: (double entry)"
label(qdatam1t$tsremoter2final)="4. Final Pain Rating:"
label(qdatam1t$tsremoter2final_d)="4. Final Pain Rating: (double entry)"
label(qdatam1t$tsremoter3initial)="5. Initial Pain Rating:"
label(qdatam1t$tsremoter3initial_d)="5. Initial Pain Rating: (double entry)"
label(qdatam1t$tsremoter3final)="6. Final Pain Rating:"
label(qdatam1t$tsremoter3final_d)="6. Final Pain Rating: (double entry)"
label(qdatam1t$tsremoteafter15)="7. 15 sec"
label(qdatam1t$tsfinalpainremafts31)="8. 30 sec"
label(qdatam1t$tsindxr1initial)="9. Initial Pain Rating:"
label(qdatam1t$tsindxr1initial_d)="9. Initial Pain Rating: (double entry)"
label(qdatam1t$tsindxr1final)="10. Final Pain Rating:"
label(qdatam1t$tsindxr1final_d)="10. Final Pain Rating: (double entry)"
label(qdatam1t$tsindxr2initial)="11. Initial Pain Rating:"
label(qdatam1t$tsindxr2initial_d)="11. Initial Pain Rating: (double entry)"
label(qdatam1t$tsindxr2final)="12. Final Pain Rating:"
label(qdatam1t$tsindxr2final_d)="12. Final Pain Rating: (double entry)"
label(qdatam1t$tsindxr3initial)="13. Initial Pain Rating:"
label(qdatam1t$tsindxr3initial_d)="13. Initial Pain Rating: (double entry)"
label(qdatam1t$tsindxr3final)="14. Final Pain Rating:"
label(qdatam1t$tsindxr3final_d)="14. Final Pain Rating: (double entry)"
label(qdatam1t$tsindxafter15)="15. 15 sec"
label(qdatam1t$tsindxafter30)="16. 30 sec"
label(qdatam1t$tscompleted)="17. Test completed?"
label(qdatam1t$tsnotes)="18. Additional notes for Temporal Summation"
label(qdatam1t$cpmcoldwatertemp)="1. Confirm water temp 10 deg C (+/-1 deg): "
label(qdatam1t$cpmcoldwaterpain30)="2. Cold Water Pain Rating at 30 sec:"
label(qdatam1t$cpmcoldwaterpain30_d)="2. Cold Water Pain Rating at 30 sec: (double entry)"
label(qdatam1t$cpmcoldwaterpain60)="3. Cold Water Pain Rating at 60 sec:"
label(qdatam1t$cpmcoldwaterpain60_d)="3. Cold Water Pain Rating at 60 sec: (double entry)"
label(qdatam1t$cpmbathrangeyn)="4. Water bath duration?"
label(qdatam1t$cpmoutrangetime)="If outside of range, enter time (sec)"
label(qdatam1t$cpmpptremr1val)="5. Rep 1:"
label(qdatam1t$cpmpptremr1val_d)="5. Rep 1: (double entry)"
label(qdatam1t$cpmpptremr2val)="6. Rep 2:"
label(qdatam1t$cpmpptremr2val_d)="6. Rep 2: (double entry)"
label(qdatam1t$cpmpptremr3val)="7. Rep 3:"
label(qdatam1t$cpmpptremr3val_d)="7. Rep 3: (double entry)"
label(qdatam1t$cpmcompleteyn)="Test Completed:"
label(qdatam1t$cpmnotes)="Additional notes for Conditioned Pain Modulation "
label(qdatam1t$cuffpfmricontraindyn)="1. Cuff pressure contraindicated:"
label(qdatam1t$cuffpfmrinondomleg)="2. Which leg is non-dominant?"
label(qdatam1t$cuffpfmripressure)="3. Calf of non-dominant leg pressure: "
label(qdatam1t$cuffpfmripressure_d)="3. Calf of non-dominant leg pressure 1: (double entry) "
label(qdatam1t$qst_mcc1_v03_complete)="Complete?"
#Setting Units


#Setting Factors(will create new variable for factors)
qdatam1t$redcap_event_name.factor = factor(qdatam1t$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","6mo_postop_day_8_arm_1","6mo_postop_day_9_arm_1","6mo_postop_day_10_arm_1","6mo_postop_day_11_arm_1","6mo_postop_day_12_arm_1","6mo_postop_day_13_arm_1","6mo_postop_day_14_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
qdatam1t$redcap_data_access_group.factor = factor(qdatam1t$redcap_data_access_group,levels=c("university_of_mich"))
qdatam1t$pmachgchestpainyn.factor = factor(qdatam1t$pmachgchestpainyn,levels=c("1","0"))
qdatam1t$pmapainregion.factor = factor(qdatam1t$pmapainregion,levels=c("1","2","3"))
qdatam1t$pmahighestloc.factor = factor(qdatam1t$pmahighestloc,levels=c("1","2","3","4","5","6","7","8","9","10","11","12","13"))
qdatam1t$pmalowestloc.factor = factor(qdatam1t$pmalowestloc,levels=c("1","2","3","4","5","6","7","8","9","10","11","12","13"))
qdatam1t$pmamostpain.factor = factor(qdatam1t$pmamostpain,levels=c("1","2","3"))
qdatam1t$dmacontr1pain.factor = factor(qdatam1t$dmacontr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr1pain_d.factor = factor(qdatam1t$dmacontr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr2pain.factor = factor(qdatam1t$dmacontr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr2pain_d.factor = factor(qdatam1t$dmacontr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr3pain.factor = factor(qdatam1t$dmacontr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr3pain_d.factor = factor(qdatam1t$dmacontr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr4pain.factor = factor(qdatam1t$dmacontr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr4pain_d.factor = factor(qdatam1t$dmacontr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr5pain.factor = factor(qdatam1t$dmacontr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmacontr5pain_d.factor = factor(qdatam1t$dmacontr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr1pain.factor = factor(qdatam1t$dmaindxr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr1pain_d.factor = factor(qdatam1t$dmaindxr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr2pain.factor = factor(qdatam1t$dmaindxr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr2pain_d.factor = factor(qdatam1t$dmaindxr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr3pain.factor = factor(qdatam1t$dmaindxr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr3pain_d.factor = factor(qdatam1t$dmaindxr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr4pain.factor = factor(qdatam1t$dmaindxr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr4pain_d.factor = factor(qdatam1t$dmaindxr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr5pain.factor = factor(qdatam1t$dmaindxr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaindxr5pain_d.factor = factor(qdatam1t$dmaindxr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmasenscompare.factor = factor(qdatam1t$dmasenscompare,levels=c("1","2","3"))
qdatam1t$dmaptcontr1pain.factor = factor(qdatam1t$dmaptcontr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr1pain_d.factor = factor(qdatam1t$dmaptcontr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr2pain.factor = factor(qdatam1t$dmaptcontr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr2pain_d.factor = factor(qdatam1t$dmaptcontr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr3pain.factor = factor(qdatam1t$dmaptcontr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr3pain_d.factor = factor(qdatam1t$dmaptcontr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr4pain.factor = factor(qdatam1t$dmaptcontr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr4pain_d.factor = factor(qdatam1t$dmaptcontr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr5pain.factor = factor(qdatam1t$dmaptcontr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptcontr5pain_d.factor = factor(qdatam1t$dmaptcontr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr1pain.factor = factor(qdatam1t$dmaptindxr1pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr1pain_d.factor = factor(qdatam1t$dmaptindxr1pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr2pain.factor = factor(qdatam1t$dmaptindxr2pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr2pain_d.factor = factor(qdatam1t$dmaptindxr2pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr3pain.factor = factor(qdatam1t$dmaptindxr3pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr3pain_d.factor = factor(qdatam1t$dmaptindxr3pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr4pain.factor = factor(qdatam1t$dmaptindxr4pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr4pain_d.factor = factor(qdatam1t$dmaptindxr4pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr5pain.factor = factor(qdatam1t$dmaptindxr5pain,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptindxr5pain_d.factor = factor(qdatam1t$dmaptindxr5pain_d,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
qdatam1t$dmaptspecsite_3m.factor = factor(qdatam1t$dmaptspecsite_3m,levels=c("1","2","3"))
qdatam1t$dmaptsenscompare.factor = factor(qdatam1t$dmaptsenscompare,levels=c("1","2","3"))
qdatam1t$dmatestcompyn.factor = factor(qdatam1t$dmatestcompyn,levels=c("1","2","0"))
qdatam1t$dmatestcompyn_3m.factor = factor(qdatam1t$dmatestcompyn_3m,levels=c("1","2","0"))
qdatam1t$dmatestcompwhich___1.factor = factor(qdatam1t$dmatestcompwhich___1,levels=c("0","1"))
qdatam1t$dmatestcompwhich___2.factor = factor(qdatam1t$dmatestcompwhich___2,levels=c("0","1"))
qdatam1t$dmatestcompwhich_3m___1.factor = factor(qdatam1t$dmatestcompwhich_3m___1,levels=c("0","1"))
qdatam1t$dmatestcompwhich_3m___2.factor = factor(qdatam1t$dmatestcompwhich_3m___2,levels=c("0","1"))
qdatam1t$dmatestcompwhich_3m___3.factor = factor(qdatam1t$dmatestcompwhich_3m___3,levels=c("0","1"))
qdatam1t$dmatestcompwhich_3m___4.factor = factor(qdatam1t$dmatestcompwhich_3m___4,levels=c("0","1"))
qdatam1t$pptcompleteyn.factor = factor(qdatam1t$pptcompleteyn,levels=c("1","2","3","0"))
qdatam1t$tsremoter1initial.factor = factor(qdatam1t$tsremoter1initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter1initial_d.factor = factor(qdatam1t$tsremoter1initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter1final.factor = factor(qdatam1t$tsremoter1final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter1final_d.factor = factor(qdatam1t$tsremoter1final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter2initial.factor = factor(qdatam1t$tsremoter2initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter2initial_d.factor = factor(qdatam1t$tsremoter2initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter2final.factor = factor(qdatam1t$tsremoter2final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter2final_d.factor = factor(qdatam1t$tsremoter2final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter3initial.factor = factor(qdatam1t$tsremoter3initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter3initial_d.factor = factor(qdatam1t$tsremoter3initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter3final.factor = factor(qdatam1t$tsremoter3final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoter3final_d.factor = factor(qdatam1t$tsremoter3final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsremoteafter15.factor = factor(qdatam1t$tsremoteafter15,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsfinalpainremafts31.factor = factor(qdatam1t$tsfinalpainremafts31,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr1initial.factor = factor(qdatam1t$tsindxr1initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr1initial_d.factor = factor(qdatam1t$tsindxr1initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr1final.factor = factor(qdatam1t$tsindxr1final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr1final_d.factor = factor(qdatam1t$tsindxr1final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr2initial.factor = factor(qdatam1t$tsindxr2initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr2initial_d.factor = factor(qdatam1t$tsindxr2initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr2final.factor = factor(qdatam1t$tsindxr2final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr2final_d.factor = factor(qdatam1t$tsindxr2final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr3initial.factor = factor(qdatam1t$tsindxr3initial,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr3initial_d.factor = factor(qdatam1t$tsindxr3initial_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr3final.factor = factor(qdatam1t$tsindxr3final,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxr3final_d.factor = factor(qdatam1t$tsindxr3final_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxafter15.factor = factor(qdatam1t$tsindxafter15,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tsindxafter30.factor = factor(qdatam1t$tsindxafter30,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$tscompleted.factor = factor(qdatam1t$tscompleted,levels=c("1","2","3","0"))
qdatam1t$cpmcoldwatertemp.factor = factor(qdatam1t$cpmcoldwatertemp,levels=c("1","0"))
qdatam1t$cpmcoldwaterpain30.factor = factor(qdatam1t$cpmcoldwaterpain30,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$cpmcoldwaterpain30_d.factor = factor(qdatam1t$cpmcoldwaterpain30_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$cpmcoldwaterpain60.factor = factor(qdatam1t$cpmcoldwaterpain60,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$cpmcoldwaterpain60_d.factor = factor(qdatam1t$cpmcoldwaterpain60_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
qdatam1t$cpmbathrangeyn.factor = factor(qdatam1t$cpmbathrangeyn,levels=c("1","2"))
qdatam1t$cpmcompleteyn.factor = factor(qdatam1t$cpmcompleteyn,levels=c("1","0"))
qdatam1t$cuffpfmricontraindyn.factor = factor(qdatam1t$cuffpfmricontraindyn,levels=c("1","0"))
qdatam1t$cuffpfmrinondomleg.factor = factor(qdatam1t$cuffpfmrinondomleg,levels=c("1","2"))
qdatam1t$qst_mcc1_v03_complete.factor = factor(qdatam1t$qst_mcc1_v03_complete,levels=c("0","1","2"))

levels(qdatam1t$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","6-Mo Post-Op Day 8","6-Mo Post-Op Day 9","6-Mo Post-Op Day 10","6-Mo Post-Op Day 11","6-Mo Post-Op Day 12","6-Mo Post-Op Day 13","6-Mo Post-Op Day 14","12-Mo Post-Op","Event Reporting")
levels(qdatam1t$redcap_data_access_group.factor)=c("University of Michigan")
levels(qdatam1t$pmachgchestpainyn.factor)=c("Yes","No")
levels(qdatam1t$pmapainregion.factor)=c("Anterior chest","Axillary/lateral","Posterior chest")
levels(qdatam1t$pmahighestloc.factor)=c("T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12","Above or below thoracic levels")
levels(qdatam1t$pmalowestloc.factor)=c("T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12","Above or below thoracic levels")
levels(qdatam1t$pmamostpain.factor)=c("At the scar","Immediately around the scar (< = 4 cm)","Distant from the scar (> 4 cm)")
levels(qdatam1t$dmacontr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmacontr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaindxr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmasenscompare.factor)=c("Equal on both sides","Stronger on the surgery side","Stronger on contralateral side")
levels(qdatam1t$dmaptcontr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptcontr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr1pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr1pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr2pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr2pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr3pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr3pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr4pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr4pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr5pain.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptindxr5pain_d.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels(qdatam1t$dmaptspecsite_3m.factor)=c("1. No, Pain site or < 4 cm from standardized site","2. Yes, tested pt-specific site","3. Yes, tested 2 cm below most anterior scar")
levels(qdatam1t$dmaptsenscompare.factor)=c("1. Equal on both sides","2. Stronger on surgery side","3. Stronger on contralateral side")
levels(qdatam1t$dmatestcompyn.factor)=c("Yes, all sites","Yes, but only some sites","None")
levels(qdatam1t$dmatestcompyn_3m.factor)=c("Yes, all 4 sites","Yes, but only some sites","None")
levels(qdatam1t$dmatestcompwhich___1.factor)=c("Unchecked","Checked")
levels(qdatam1t$dmatestcompwhich___2.factor)=c("Unchecked","Checked")
levels(qdatam1t$dmatestcompwhich_3m___1.factor)=c("Unchecked","Checked")
levels(qdatam1t$dmatestcompwhich_3m___2.factor)=c("Unchecked","Checked")
levels(qdatam1t$dmatestcompwhich_3m___3.factor)=c("Unchecked","Checked")
levels(qdatam1t$dmatestcompwhich_3m___4.factor)=c("Unchecked","Checked")
levels(qdatam1t$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (chest)","no, neither site")
levels(qdatam1t$tsremoter1initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter1initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter1final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter1final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter2initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter2initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter2final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter2final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter3initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter3initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter3final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoter3final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsremoteafter15.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsfinalpainremafts31.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr1initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr1initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr1final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr1final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr2initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr2initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr2final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr2final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr3initial.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr3initial_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr3final.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxr3final_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxafter15.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tsindxafter30.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$tscompleted.factor)=c("yes, at least 1 repetition for both sites","only remote (shoulder)","only index (chest)","no, neither site")
levels(qdatam1t$cpmcoldwatertemp.factor)=c("Yes","No")
levels(qdatam1t$cpmcoldwaterpain30.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$cpmcoldwaterpain30_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$cpmcoldwaterpain60.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$cpmcoldwaterpain60_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(qdatam1t$cpmbathrangeyn.factor)=c("Standard range (60sec +/- 5 sec)","Outside of range: < 55sec or > 65 sec")
levels(qdatam1t$cpmcompleteyn.factor)=c("Yes","No")
levels(qdatam1t$cuffpfmricontraindyn.factor)=c("Yes","No")
levels(qdatam1t$cuffpfmrinondomleg.factor)=c("Right","Left")
levels(qdatam1t$qst_mcc1_v03_complete.factor)=c("Incomplete","Unverified","Complete")





# DMA

#Remove records with missing "DMA test completed"

m1tqdata1 <- qdatam1t %>% 
  filter(!is.na(dmatestcompyn))

#recheck if NAs removed

tabyl(m1tqdata1,dmatestcompyn,dmatestcompyn.factor,show_na= TRUE)

# keep record with "test completed"

m1tdma.complete <- m1tqdata1 %>% 
  filter(dmatestcompyn != 0)

#check if all dma.completed now has completed records

m1tdma.complete %>% 
  tabyl(dmatestcompyn.factor,dmatestcompyn,show_na= TRUE)


# filter only DMA baseline

m1tdma.baseline <- m1tdma.complete %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" )


# IF both or either one location for DMA standardized  performed but DMA complete was missing

m1terror0 <-  m1tdma.baseline  %>% 
  filter(is.na(dmatestcompyn)) %>%
  filter(!is.na(dmacontr1pain &  dmacontr1pain_d & dmacontr2pain & dmacontr2pain_d & dmacontr3pain & dmacontr3pain_d & 
                  dmacontr4pain & dmacontr4pain_d &dmacontr5pain  & dmacontr5pain_d | dmaindxr1pain & dmaindxr1pain_d &
                  dmaindxr2pain & dmaindxr2pain_d  &  dmaindxr3pain   &  dmaindxr3pain_d   &     dmaindxr4pain & dmaindxr4pain_d  & 
                  dmaindxr5pain & dmaindxr5pain_d     &   dmasenscompare))  %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1.factor,dmatestcompwhich___2.factor,dmatestcompyn.factor) %>% 
  mutate(dmatestcompyn.factor = case_when(is.na(dmatestcompyn.factor) ~ "missing",TRUE ~ as.character(dmatestcompyn.factor)))


# check if all sites checked and dmawhich1 or dmawchich2 both checked

m1terror1 <- m1tdma.baseline %>% 
  filter (dmatestcompyn == 1 & (dmatestcompwhich___1 == 1 |dmatestcompwhich___2 == 1)) %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1.factor,dmatestcompwhich___2.factor,dmatestcompyn.factor) 

m1terror0_1 <-  full_join(m1terror0,m1terror1,by = intersect(names(m1terror0),names(m1terror1)))


# check if some sites checked and dmawhich1 or dmawchich2 both unchecked

m1terror2 <- m1tdma.baseline %>% 
  filter (dmatestcompyn == 2 & (dmatestcompwhich___1 == 0 & dmatestcompwhich___2 == 0)) %>% 
  select(record_id,redcap_event_name,dmatestcompwhich___1.factor,dmatestcompwhich___2.factor,dmatestcompyn.factor)

m1terror0_2 <-  full_join(m1terror0_1,m1terror2,by = intersect(names(m1terror0_1),names(m1terror2)))


#check if all sites or some sites checked  and no  mismatch or missing pain data for standardized contralateral site
#rep1
m1terror2.1 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff1 = dmacontr1pain - dmacontr1pain_d) %>% 
  filter(dma_stand_cont_diff1 != 0 | is.na(dma_stand_cont_diff1)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr1pain,dmacontr1pain_d) %>% 
  mutate(dmacontr1pain = case_when(is.na(dmacontr1pain) ~ "missing",TRUE ~ as.character(dmacontr1pain))) %>% 
  mutate(dmacontr1pain_d= case_when(is.na(dmacontr1pain_d) ~ "missing",TRUE ~ as.character(dmacontr1pain_d) )) 

#rep2
m1terror2.2 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff2 = dmacontr2pain - dmacontr2pain_d) %>% 
  filter(dma_stand_cont_diff2 != 0 | is.na(dma_stand_cont_diff2)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr2pain,dmacontr2pain_d) %>% 
  mutate(dmacontr2pain = case_when(is.na(dmacontr2pain) ~ "missing",TRUE ~ as.character(dmacontr2pain))) %>% 
  mutate(dmacontr2pain_d= case_when(is.na(dmacontr2pain_d) ~ "missing",TRUE ~ as.character(dmacontr2pain_d) )) 



#rep3

m1terror2.3 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff3 = dmacontr3pain - dmacontr3pain_d) %>% 
  filter(dma_stand_cont_diff3 != 0 | is.na(dma_stand_cont_diff3)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr3pain,dmacontr3pain_d) %>% 
  mutate(dmacontr3pain = case_when(is.na(dmacontr3pain) ~ "missing",TRUE ~ as.character(dmacontr3pain))) %>% 
  mutate(dmacontr3pain_d= case_when(is.na(dmacontr3pain_d) ~ "missing",TRUE ~ as.character(dmacontr3pain_d) )) 


#rep4

m1terror2.4 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff4 = dmacontr4pain - dmacontr4pain_d) %>% 
  filter(dma_stand_cont_diff4 != 0 | is.na(dma_stand_cont_diff4)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr4pain,dmacontr4pain_d) %>% 
  mutate(dmacontr4pain = case_when(is.na(dmacontr4pain) ~ "missing",TRUE ~ as.character(dmacontr4pain))) %>% 
  mutate(dmacontr4pain_d= case_when(is.na(dmacontr4pain_d) ~ "missing",TRUE ~ as.character(dmacontr4pain_d) )) 


#rep5

m1terror2.5 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1|( dmatestcompyn == 2 & dmatestcompwhich___1 == 1 ))%>% 
  mutate(dma_stand_cont_diff5 = dmacontr5pain - dmacontr5pain_d) %>% 
  filter(dma_stand_cont_diff5 != 0 | is.na(dma_stand_cont_diff5)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmacontr5pain,dmacontr5pain_d) %>% 
  mutate(dmacontr5pain = case_when(is.na(dmacontr5pain) ~ "missing",TRUE ~ as.character(dmacontr5pain))) %>% 
  mutate(dmacontr5pain_d= case_when(is.na(dmacontr5pain_d) ~ "missing",TRUE ~ as.character(dmacontr5pain_d))) 

m1tdma_stan_contr1 <-  full_join(m1terror2.1,m1terror2.2,by = intersect(names(m1terror2.1),names(m1terror2.2)))

m1tdma_stan_contr2 <- full_join(m1tdma_stan_contr1,m1terror2.3,by = intersect(names(m1terror2.3),names(m1tdma_stan_contr1)))


m1tdma_stan_contr3 <- full_join(m1tdma_stan_contr2,m1terror2.4,by = intersect(names(m1terror2.4),names(m1tdma_stan_contr2)))

m1tdma_stan_contr <- full_join(m1tdma_stan_contr3,m1terror2.5,by = intersect(names(m1terror2.5),names(m1tdma_stan_contr3)))


m1terror_0_2_dma_stand_cont <- full_join(m1terror0_2,m1tdma_stan_contr,by = intersect(names(m1terror0_2),names(m1tdma_stan_contr)))


#check if all sites or some sites checked  and no  mismatch or missing pain data for standardized index 
#rep1
m1terror3.1 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff1 = dmaindxr1pain - dmaindxr1pain_d) %>% 
  filter(dma_stand_ind_diff1 != 0 | is.na(dma_stand_ind_diff1)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr1pain,dmaindxr1pain_d) %>% 
  mutate(dmaindxr1pain = case_when(is.na(dmaindxr1pain) ~ "missing",TRUE ~ as.character(dmaindxr1pain))) %>% 
  mutate(dmaindxr1pain_d= case_when(is.na(dmaindxr1pain_d) ~ "missing",TRUE ~ as.character(dmaindxr1pain_d) )) 

#rep2
m1terror3.2 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff2 = dmaindxr2pain - dmaindxr2pain_d) %>% 
  filter(dma_stand_ind_diff2 != 0 | is.na(dma_stand_ind_diff2)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr2pain,dmaindxr2pain_d) %>% 
  mutate(dmaindxr2pain = case_when(is.na(dmaindxr2pain) ~ "missing",TRUE ~ as.character(dmaindxr2pain))) %>% 
  mutate(dmaindxr2pain_d= case_when(is.na(dmaindxr2pain_d) ~ "missing",TRUE ~ as.character(dmaindxr2pain_d) )) 




#rep3

m1terror3.3 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff3 = dmaindxr3pain - dmaindxr3pain_d) %>% 
  filter(dma_stand_ind_diff3 != 0 | is.na(dma_stand_ind_diff3)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr3pain,dmaindxr3pain_d) %>% 
  mutate(dmaindxr3pain = case_when(is.na(dmaindxr3pain) ~ "missing",TRUE ~ as.character(dmaindxr3pain))) %>% 
  mutate(dmaindxr3pain_d= case_when(is.na(dmaindxr3pain_d) ~ "missing",TRUE ~ as.character(dmaindxr3pain_d) )) 


#rep4

m1terror3.4 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff4 = dmaindxr4pain - dmaindxr4pain_d) %>% 
  filter(dma_stand_ind_diff4 != 0 | is.na(dma_stand_ind_diff4)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr4pain,dmaindxr4pain_d) %>% 
  mutate(dmaindxr4pain = case_when(is.na(dmaindxr4pain) ~ "missing",TRUE ~ as.character(dmaindxr4pain))) %>% 
  mutate(dmaindxr4pain_d= case_when(is.na(dmaindxr4pain_d) ~ "missing",TRUE ~ as.character(dmaindxr4pain_d) )) 


#rep5
m1terror3.5 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1 | (dmatestcompyn == 2 & dmatestcompwhich___2 == 1))%>% 
  mutate(dma_stand_ind_diff5 = dmaindxr5pain - dmaindxr5pain_d) %>% 
  filter(dma_stand_ind_diff5 != 0 | is.na(dma_stand_ind_diff5)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmaindxr5pain,dmaindxr5pain_d) %>% 
  mutate(dmaindxr5pain = case_when(is.na(dmaindxr5pain) ~ "missing",TRUE ~ as.character(dmaindxr5pain))) %>% 
  mutate(dmaindxr5pain_d= case_when(is.na(dmaindxr5pain_d) ~ "missing",TRUE ~ as.character(dmaindxr5pain_d) )) 


m1tdma_stan_ind1 <-  full_join(m1terror3.1,m1terror3.2,by = intersect(names(m1terror3.1),names(m1terror3.2)))

m1tdma_stan_ind2 <- full_join(m1tdma_stan_ind1,m1terror3.3,by = intersect(names(m1terror3.3),names(m1tdma_stan_ind1)))


m1tdma_stan_ind3 <- full_join(m1tdma_stan_ind2,m1terror3.4,by = intersect(names(m1terror3.4),names(m1tdma_stan_ind2)))

m1tdma_stan_ind <- full_join(m1tdma_stan_ind3,m1terror3.5,by = intersect(names(m1terror3.5),names(m1tdma_stan_ind3)))


m1terror_0_2_dma_stand_cont_ind <- full_join(m1terror_0_2_dma_stand_cont,m1tdma_stan_ind,by = intersect(names(m1terror_0_2_dma_stand_cont),names(m1tdma_stan_ind)))


#check if standardized site comparison was entered if both sites were tested

m1terror6 <-  m1tdma.baseline %>% 
  filter(dmatestcompyn == 1 & is.na(dmasenscompare)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn.factor,dmasenscompare.factor) %>% 
  mutate(dmasenscompare.factor = case_when(is.na(dmasenscompare.factor) ~ "missing",TRUE ~ as.character(dmasenscompare.factor)))

m1terror_0_2_dma_stand_cont_ind_6 <- full_join(m1terror6,m1terror_0_2_dma_stand_cont_ind,by = intersect(names(m1terror6),names(m1terror_0_2_dma_stand_cont_ind)))


#DMA at 3 months
#filter only 3 months records


m1tdma.3mon <- qdatam1t  %>%
  filter(redcap_event_name == "3mo_postop_arm_1" )

m1tcheck1 <- m1tdma.3mon  %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1,dmatestcompwhich_3m___1.factor,dmatestcompwhich_3m___2,dmatestcompwhich___2.factor,dmatestcompwhich_3m___3,dmatestcompwhich_3m___3.factor,dmatestcompwhich_3m___4,dmatestcompwhich_3m___4.factor)


# IF DMA standardized and patient specific performed but DMA complete was missing

m1terror.3mon_1 <- m1tdma.3mon %>%
  filter(!is.na(dmacontr1pain |  dmacontr1pain_d | dmacontr2pain| dmacontr2pain_d | dmacontr3pain | dmacontr3pain_d|dmacontr4pain | dmacontr4pain_d |dmacontr5pain 
                | dmacontr5pain_d | dmaindxr1pain | dmaindxr1pain_d |dmaindxr2pain | dmaindxr2pain_d  |  dmaindxr3pain   |
                  dmaindxr3pain_d   |     dmaindxr4pain | dmaindxr4pain_d    |    dmaindxr5pain | dmaindxr5pain_d     |   dmasenscompare   |
                  dmaptcontr1pain |  dmaptcontr1pain_d      |     dmaptcontr2pain     |   dmaptcontr2pain_d  |    dmaptcontr3pain   |     dmaptcontr3pain_d   |
                  dmaptcontr4pain|  dmaptcontr4pain_d      |     dmaptcontr5pain    |    dmaptcontr5pain_d  |    dmaptindxr1pain      |  dmaptindxr1pain_d    |
                  dmaptindxr2pain|  dmaptindxr2pain_d     |   dmaptindxr3pain     |   dmaptindxr3pain_d  |    dmaptindxr4pain  |      dmaptindxr4pain_d   |
                  dmaptindxr5pain |  dmaptindxr5pain_d)) %>% 
  filter(is.na(dmatestcompyn_3m))  %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor) %>%
  mutate(dmatestcompyn_3m.factor = case_when(is.na(dmatestcompyn_3m.factor) ~ "missing",TRUE ~ as.character(dmatestcompyn_3m.factor)))


# check if all sites checked and dmawhich1 and dmawchich2 both checked as well

m1terror3mon_2 <- m1tdma.3mon %>%
  filter (dmatestcompyn_3m == 1 & (dmatestcompwhich_3m___2 == 1 | dmatestcompwhich_3m___1 == 1 | dmatestcompwhich_3m___3 == 1 |dmatestcompwhich_3m___4 == 1)) %>%
  select(record_id,redcap_event_name, dmatestcompwhich_3m___1 ,dmatestcompwhich_3m___2, dmatestcompwhich_3m___3,dmatestcompwhich_3m___4,dmatestcompyn_3m.factor)


m1terror3mon1_2 <- full_join(m1terror.3mon_1,m1terror3mon_2,by = intersect(names(m1terror.3mon_1),names(m1terror3mon_2)))


#Remove records with missing "DMA test completed"

m1tdma.3mon1 <- m1tdma.3mon %>% 
  filter(!is.na(dmatestcompyn_3m))


#New chest pain since surgery?"
m1terror3mon_3 <- m1tdma.3mon1 %>%
  filter(is.na(pmachgchestpainyn)) %>%
  select(record_id,redcap_event_name,pmachgchestpainyn.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor)))



m1terror3mon1_3 <- full_join(m1terror3mon1_2,m1terror3mon_3,by = intersect(names(m1terror3mon1_2),names(m1terror3mon_3)))

#  If there is new chest pain AND if General region of pain is NA"
m1terror3mon_4 <- m1tdma.3mon1 %>%
  filter(pmachgchestpainyn==1 & is.na(pmapainregion)) %>%
  select(record_id,redcap_event_name,pmapainregion.factor,pmachgchestpainyn.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor)))


m1terror3mon1_4 <- full_join(m1terror3mon1_3,m1terror3mon_4,by = intersect(names(m1terror3mon1_3),names(m1terror3mon_4)))

#3. Highest pain location",#  If there is new chest pain and highest pain location is NA"
m1terror3mon_5<- m1tdma.3mon1 %>% 
  filter(pmachgchestpainyn==1 & !is.na(pmapainregion) & is.na(pmahighestloc)) %>% 
  select(record_id,redcap_event_name,pmapainregion.factor,pmachgchestpainyn.factor,pmahighestloc.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor))) %>% 
  mutate(pmahighestloc.factor= case_when(is.na(pmahighestloc.factor) ~ "missing",TRUE ~ as.character(pmahighestloc.factor)))


m1terror3mon1_5 <- full_join(m1terror3mon1_4,m1terror3mon_5,by = intersect(names(m1terror3mon1_4),names(m1terror3mon_5)))


#4. Lowest pain location", If there is new chest pain and lowest pain location is NA"
m1terror3mon_6 <- m1tdma.3mon1 %>% 
  filter(pmachgchestpainyn==1 & is.na(pmalowestloc)) %>% 
  select(record_id,redcap_event_name,pmapainregion.factor,pmachgchestpainyn.factor,pmalowestloc.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor))) %>% 
  mutate(pmalowestloc.factor= case_when(is.na(pmalowestloc.factor) ~ "missing",TRUE ~ as.character(pmalowestloc.factor)))

m1terror3mon1_6 <- full_join(m1terror3mon1_5,m1terror3mon_6,by = intersect(names(m1terror3mon1_5),names(m1terror3mon_6)))


# # 5. Most painful region:"If there is new chest pain and most painful region is NA"
m1terror3mon_7 <- m1tdma.3mon1 %>%
  filter(pmachgchestpainyn==1 & is.na(pmamostpain)) %>%
  select(record_id,redcap_event_name,pmachgchestpainyn.factor,pmapainregion.factor,pmamostpain.factor) %>% 
  mutate(pmachgchestpainyn.factor= case_when(is.na(pmachgchestpainyn.factor) ~ "missing",TRUE ~ as.character(pmachgchestpainyn.factor))) %>% 
  mutate(pmapainregion.factor= case_when(is.na(pmapainregion.factor) ~ "missing",TRUE ~ as.character(pmapainregion.factor))) %>% 
  mutate(pmamostpain.factor= case_when(is.na(pmamostpain.factor) ~ "missing",TRUE ~ as.character(pmamostpain.factor)))


m1terror3mon1_7 <- full_join(m1terror3mon1_6,m1terror3mon_7,by = intersect(names(m1terror3mon1_6),names(m1terror3mon_7)))

# # post surgery specific procedures (refer pg 144 MOP veersion 3)


#check if all sites checked  and no  mismatch or missing pain data for standardized contralateral site
#rep1
m1terror3mon_8 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff1 = dmacontr1pain - dmacontr1pain_d) %>%
  filter(dma3_stand_cont_diff1 != 0 | is.na(dma3_stand_cont_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr1pain,dmacontr1pain_d) %>%
  mutate(dmacontr1pain = case_when(is.na(dmacontr1pain) ~ "missing",TRUE ~ as.character(dmacontr1pain))) %>%
  mutate(dmacontr1pain_d= case_when(is.na(dmacontr1pain_d) ~ "missing",TRUE ~ as.character(dmacontr1pain_d) ))
#merge
m1terror3mon1_8 <- full_join(m1terror3mon1_7,m1terror3mon_8,by = intersect(names(m1terror3mon1_7),names(m1terror3mon_8)))


#rep2
m1terror3mon_9 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff2 = dmacontr2pain - dmacontr2pain_d) %>%
  filter(dma3_stand_cont_diff2 != 0 | is.na(dma3_stand_cont_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr2pain,dmacontr2pain_d) %>%
  mutate(dmacontr2pain = case_when(is.na(dmacontr2pain) ~ "missing",TRUE ~ as.character(dmacontr2pain))) %>%
  mutate(dmacontr2pain_d= case_when(is.na(dmacontr2pain_d) ~ "missing",TRUE ~ as.character(dmacontr2pain_d) ))
# 
#merge
m1terror3mon1_9 <- full_join(m1terror3mon1_8,m1terror3mon_9,by = intersect(names(m1terror3mon1_8),names(m1terror3mon_9)))
#rep3

m1terror3mon_10 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 )) %>% 
  mutate(dma3_stand_cont_diff3 = dmacontr3pain - dmacontr3pain_d) %>%
  filter(dma3_stand_cont_diff3 != 0 | is.na(dma3_stand_cont_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr3pain,dmacontr3pain_d) %>%
  mutate(dmacontr3pain = case_when(is.na(dmacontr3pain) ~ "missing",TRUE ~ as.character(dmacontr3pain))) %>%
  mutate(dmacontr3pain_d= case_when(is.na(dmacontr3pain_d) ~ "missing",TRUE ~ as.character(dmacontr3pain_d) ))

m1terror3mon1_10 <- full_join(m1terror3mon1_9,m1terror3mon_10,by = intersect(names(m1terror3mon1_9),names(m1terror3mon_10)))


#rep4

m1terror3mon_11 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff4 = dmacontr4pain - dmacontr4pain_d) %>%
  filter(dma3_stand_cont_diff4 != 0 | is.na(dma3_stand_cont_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr4pain,dmacontr4pain_d) %>%
  mutate(dmacontr4pain = case_when(is.na(dmacontr4pain) ~ "missing",TRUE ~ as.character(dmacontr4pain))) %>%
  mutate(dmacontr4pain_d= case_when(is.na(dmacontr4pain_d) ~ "missing",TRUE ~ as.character(dmacontr4pain_d) ))

m1terror3mon1_11 <- full_join(m1terror3mon1_10,m1terror3mon_11,by = intersect(names(m1terror3mon1_10),names(m1terror3mon_11)))


#rep5

m1terror3mon_12 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 == 1 ))%>%
  mutate(dma3_stand_cont_diff5 = dmacontr5pain - dmacontr5pain_d) %>%
  filter(dma3_stand_cont_diff5 != 0 | is.na(dma3_stand_cont_diff5)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmacontr5pain,dmacontr5pain_d) %>%
  mutate(dmacontr5pain = case_when(is.na(dmacontr5pain) ~ "missing",TRUE ~ as.character(dmacontr5pain))) %>%
  mutate(dmacontr5pain_d= case_when(is.na(dmacontr5pain_d) ~ "missing",TRUE ~ as.character(dmacontr5pain_d) ))
# 
#   
m1terror3mon1_12 <- full_join(m1terror3mon1_11,m1terror3mon_12,by = intersect(names(m1terror3mon1_11),names(m1terror3mon_12))) 
# 

# #check if all sites checked  and no  mismatch or missing pain data for standardized index site
# #rep1
m1terror3mon_13 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>% 
  mutate(dma3_stand_ind_diff1 = dmaindxr1pain - dmaindxr1pain_d) %>%
  filter(dma3_stand_ind_diff1 != 0 | is.na(dma3_stand_ind_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr1pain,dmaindxr1pain_d) %>%
  mutate(dmaindxr1pain = case_when(is.na(dmaindxr1pain) ~ "missing",TRUE ~ as.character(dmaindxr1pain))) %>%
  mutate(dmaindxr1pain_d= case_when(is.na(dmaindxr1pain_d) ~ "missing",TRUE ~ as.character(dmaindxr1pain_d) ))

m1terror3mon1_13 <- full_join(m1terror3mon1_12,m1terror3mon_13,by = intersect(names(m1terror3mon1_12),names(m1terror3mon_13))) 
# 
# #rep2
m1terror3mon_14 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff2 = dmaindxr2pain - dmaindxr2pain_d) %>%
  filter(dma3_stand_ind_diff2 != 0 | is.na(dma3_stand_ind_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr2pain,dmaindxr2pain_d) %>%
  mutate(dmaindxr2pain = case_when(is.na(dmaindxr2pain) ~ "missing",TRUE ~ as.character(dmaindxr2pain))) %>%
  mutate(dmaindxr2pain_d= case_when(is.na(dmaindxr2pain_d) ~ "missing",TRUE ~ as.character(dmaindxr2pain_d) ))

m1terror3mon1_14 <- full_join(m1terror3mon1_13,m1terror3mon_14,by = intersect(names(m1terror3mon1_13),names(m1terror3mon_14))) 
# #rep3
# 
m1terror3mon_15 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff3 = dmaindxr3pain - dmaindxr3pain_d) %>%
  filter(dma3_stand_ind_diff3 != 0 | is.na(dma3_stand_ind_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr3pain,dmaindxr3pain_d) %>%
  mutate(dmaindxr3pain = case_when(is.na(dmaindxr3pain) ~ "missing",TRUE ~ as.character(dmaindxr3pain))) %>%
  mutate(dmaindxr3pain_d= case_when(is.na(dmaindxr3pain_d) ~ "missing",TRUE ~ as.character(dmaindxr3pain_d) ))

m1terror3mon1_15 <- full_join(m1terror3mon1_14,m1terror3mon_15,by = intersect(names(m1terror3mon1_14),names(m1terror3mon_15))) 


# #rep4
# 
m1terror3mon_16 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>%
  mutate(dma3_stand_ind_diff4 = dmaindxr4pain - dmaindxr4pain_d) %>%
  filter(dma3_stand_ind_diff4 != 0 | is.na(dma3_stand_ind_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr4pain,dmaindxr4pain_d) %>%
  mutate(dmaindxr4pain = case_when(is.na(dmaindxr4pain) ~ "missing",TRUE ~ as.character(dmaindxr4pain))) %>%
  mutate(dmaindxr4pain_d= case_when(is.na(dmaindxr4pain_d) ~ "missing",TRUE ~ as.character(dmaindxr4pain_d) ))

m1terror3mon1_16 <- full_join(m1terror3mon1_15,m1terror3mon_16,by = intersect(names(m1terror3mon1_15),names(m1terror3mon_16))) 


# #rep5
m1terror3mon_17 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1))%>%
  mutate(dma3_stand_ind_diff5 = dmaindxr5pain - dmaindxr5pain_d) %>%
  filter(dma3_stand_ind_diff5 != 0 | is.na(dma3_stand_ind_diff5)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___2.factor,dmaindxr5pain,dmaindxr5pain_d) %>%
  mutate(dmaindxr5pain = case_when(is.na(dmaindxr5pain) ~ "missing",TRUE ~ as.character(dmaindxr5pain))) %>%
  mutate(dmaindxr5pain_d= case_when(is.na(dmaindxr5pain_d) ~ "missing",TRUE ~ as.character(dmaindxr5pain_d) ))

m1terror3mon1_17 <- full_join(m1terror3mon1_16,m1terror3mon_17,by = intersect(names(m1terror3mon1_16),names(m1terror3mon_17))) 

# #check if standardized site comparison was entered if both sites were tested
# 
m1terror3mon_28 <-  m1tdma.3mon1 %>% 
  filter(dmatestcompyn_3m == 1 |(dmatestcompyn_3m == 2 & dmatestcompwhich_3m___1 ==  1) & (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___2 ==  1)) %>% 
  filter (is.na(dmasenscompare)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___1.factor,dmatestcompwhich_3m___2.factor,dmasenscompare.factor) %>% 
  mutate(dmasenscompare.factor = case_when(is.na(dmasenscompare.factor) ~ "missing",TRUE ~ as.character(dmasenscompare.factor)))

m1terror3mon1_28 <- full_join(m1terror3mon1_17,m1terror3mon_28,by = intersect(names(m1terror3mon1_17),names(m1terror3mon_28))) 

# #begin checks for 3 month DMA pt specific site


# #check if all or some sites checked  and no  mismatch or missing pain data for pt contralateral site
# #rep1
m1terror3mon_29 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff1 = dmaptcontr1pain - dmaptcontr1pain_d) %>%
  filter(dma3pt_stand_cont_diff1 != 0 | is.na(dma3pt_stand_cont_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr1pain,dmaptcontr1pain_d) %>%
  mutate(dmaptcontr1pain = case_when(is.na(dmaptcontr1pain) ~ "missing",TRUE ~ as.character(dmaptcontr1pain))) %>%
  mutate(dmaptcontr1pain_d= case_when(is.na(dmaptcontr1pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr1pain_d) ))

m1terror3mon1_29 <- full_join(m1terror3mon1_28,m1terror3mon_29,by = intersect(names(m1terror3mon1_28),names(m1terror3mon_29))) 

# #rep2
m1terror3mon_30 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff2 = dmaptcontr2pain - dmaptcontr2pain_d) %>%
  filter(dma3pt_stand_cont_diff2 != 0 | is.na(dma3pt_stand_cont_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr2pain,dmaptcontr2pain_d) %>%
  mutate(dmaptcontr2pain = case_when(is.na(dmaptcontr2pain) ~ "missing",TRUE ~ as.character(dmaptcontr2pain))) %>%
  mutate(dmaptcontr2pain_d= case_when(is.na(dmaptcontr2pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr2pain_d) ))

m1terror3mon1_30 <- full_join(m1terror3mon1_29,m1terror3mon_30,by = intersect(names(m1terror3mon1_29),names(m1terror3mon_30)))  
# 
# #rep3
# 
m1terror3mon_31 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff3 = dmaptcontr3pain - dmaptcontr3pain_d) %>%
  filter(dma3pt_stand_cont_diff3 != 0 | is.na(dma3pt_stand_cont_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr3pain,dmaptcontr3pain_d) %>%
  mutate(dmaptcontr3pain = case_when(is.na(dmaptcontr3pain) ~ "missing",TRUE ~ as.character(dmaptcontr3pain))) %>%
  mutate(dmaptcontr3pain_d= case_when(is.na(dmaptcontr3pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr3pain_d) ))

m1terror3mon1_31 <- full_join(m1terror3mon1_30,m1terror3mon_31,by = intersect(names(m1terror3mon1_30),names(m1terror3mon_31)))  

# #rep4
# 
m1terror3mon_32 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1))%>%
  mutate(dma3pt_stand_cont_diff4 = dmaptcontr4pain - dmaptcontr4pain_d) %>%
  filter(dma3pt_stand_cont_diff4 != 0 | is.na(dma3pt_stand_cont_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr4pain,dmaptcontr4pain_d) %>%
  mutate(dmaptcontr4pain = case_when(is.na(dmaptcontr4pain) ~ "missing",TRUE ~ as.character(dmaptcontr4pain))) %>%
  mutate(dmaptcontr4pain_d= case_when(is.na(dmaptcontr4pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr4pain_d) ))
# 
m1terror3mon1_32 <- full_join(m1terror3mon1_31,m1terror3mon_32,by = intersect(names(m1terror3mon1_31),names(m1terror3mon_32))) 
# #rep5
# 
m1terror3mon_33 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1)) %>%
  mutate(dma3pt_stand_cont_diff5 = dmaptcontr5pain - dmaptcontr5pain_d) %>%
  filter(dma3pt_stand_cont_diff5 != 0 | is.na(dma3pt_stand_cont_diff5)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmaptcontr5pain,dmaptcontr5pain_d) %>%
  mutate(dmaptcontr5pain = case_when(is.na(dmaptcontr5pain) ~ "missing",TRUE ~ as.character(dmaptcontr5pain))) %>%
  mutate(dmaptcontr5pain_d= case_when(is.na(dmaptcontr5pain_d) ~ "missing",TRUE ~ as.character(dmaptcontr5pain_d) ))

m1terror3mon1_33 <- full_join(m1terror3mon1_32,m1terror3mon_33,by = intersect(names(m1terror3mon1_32),names(m1terror3mon_33)))  
#   
# 
# 

# #check if all sites checked or some sites checked  and no  mismatch or missing pain data for pt index site
# #rep1
m1terror3mon_34 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff1 = dmaptindxr1pain - dmaptindxr1pain_d) %>%
  filter(dma3pt_stand_ind_diff1 != 0 | is.na(dma3pt_stand_ind_diff1)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr1pain,dmaptindxr1pain_d) %>%
  mutate(dmaptindxr1pain = case_when(is.na(dmaptindxr1pain) ~ "missing",TRUE ~ as.character(dmaptindxr1pain))) %>%
  mutate(dmaptindxr1pain_d= case_when(is.na(dmaptindxr1pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr1pain_d) ))


m1terror3mon1_34 <- full_join(m1terror3mon1_33,m1terror3mon_34,by = intersect(names(m1terror3mon1_33),names(m1terror3mon_34)))  

# #rep2
m1terror3mon_35 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff2 = dmaptindxr2pain - dmaptindxr2pain_d) %>%
  filter(dma3pt_stand_ind_diff2 != 0 | is.na(dma3pt_stand_ind_diff2)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr2pain,dmaptindxr2pain_d) %>%
  mutate(dmaptindxr2pain = case_when(is.na(dmaptindxr2pain) ~ "missing",TRUE ~ as.character(dmaptindxr2pain))) %>%
  mutate(dmaptindxr2pain_d= case_when(is.na(dmaptindxr2pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr2pain_d) ))

m1terror3mon1_35 <- full_join(m1terror3mon1_34,m1terror3mon_35,by = intersect(names(m1terror3mon1_34),names(m1terror3mon_35)))   
# 
# 
# #rep3
# 
m1terror3mon_36 <-  m1tdma.3mon1 %>% 
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff3 = dmaptindxr3pain - dmaptindxr3pain_d) %>%
  filter(dma3pt_stand_ind_diff3 != 0 | is.na(dma3pt_stand_ind_diff3)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr3pain,dmaptindxr3pain_d) %>%
  mutate(dmaptindxr3pain = case_when(is.na(dmaptindxr3pain) ~ "missing",TRUE ~ as.character(dmaptindxr3pain))) %>%
  mutate(dmaptindxr3pain_d= case_when(is.na(dmaptindxr3pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr3pain_d) ))

m1terror3mon1_36 <- full_join(m1terror3mon1_35,m1terror3mon_36,by = intersect(names(m1terror3mon1_35),names(m1terror3mon_36)))   
# 
# #rep4
# 
m1terror3mon_37 <-  m1tdma.3mon1 %>%
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff4 = dmaptindxr4pain - dmaptindxr4pain_d) %>%
  filter(dma3pt_stand_ind_diff4 != 0 | is.na(dma3pt_stand_ind_diff4)) %>%
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr4pain,dmaptindxr4pain_d) %>%
  mutate(dmaptindxr4pain = case_when(is.na(dmaptindxr4pain) ~ "missing",TRUE ~ as.character(dmaptindxr4pain))) %>%
  mutate(dmaptindxr4pain_d= case_when(is.na(dmaptindxr4pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr4pain_d) ))
# 
m1terror3mon1_37 <- full_join(m1terror3mon1_36,m1terror3mon_37,by = intersect(names(m1terror3mon1_36),names(m1terror3mon_37)))    
# #rep5
# 
m1terror3mon_38 <-  m1tdma.3mon1 %>%  
  filter(dmatestcompyn_3m == 1 | (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>%
  mutate(dma3pt_stand_ind_diff5 = dmaptindxr5pain - dmaptindxr5pain_d) %>% 
  filter(dma3pt_stand_ind_diff5 != 0 | is.na(dma3pt_stand_ind_diff5)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___4.factor,dmaptindxr5pain,dmaptindxr5pain_d) %>%  
  mutate(dmaptindxr5pain = case_when(is.na(dmaptindxr5pain) ~ "missing",TRUE ~ as.character(dmaptindxr5pain))) %>%  
  mutate(dmaptindxr5pain_d= case_when(is.na(dmaptindxr5pain_d) ~ "missing",TRUE ~ as.character(dmaptindxr5pain_d) ))  

m1terror3mon1_38 <- full_join(m1terror3mon1_37,m1terror3mon_38,by = intersect(names(m1terror3mon1_37),names(m1terror3mon_38)))  


#check if pt specific site comparison was entered if both sites were tested or patient specific sites were assessed 
m1terror3mon_49 <-  m1tdma.3mon1 %>%  
  filter(dmatestcompyn_3m != 0 & dmaptspecsite_3m != 1) %>% 
  filter(is.na(dmaptsenscompare.factor)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmaptsenscompare.factor,dmaptspecsite_3m.factor) %>%
  mutate(dmaptsenscompare.factor = case_when(is.na(dmaptsenscompare.factor) ~ "missing",TRUE ~ as.character(dmaptsenscompare.factor))) 

m1terror3mon1_49 <- full_join(m1terror3mon1_38,m1terror3mon_49,by = intersect(names(m1terror3mon1_38),names(m1terror3mon_49)))   


#check if pt specific site assessed  was entered if pt specific sites were tested  
m1terror3mon_50 <-  m1tdma.3mon1 %>%  
  filter(dmatestcompyn_3m == 1 |(dmatestcompyn_3m == 2 & dmatestcompwhich_3m___3 ==  1) & (dmatestcompyn_3m == 2 & dmatestcompwhich_3m___4 ==  1)) %>% 
  filter(is.na(dmaptspecsite_3m)) %>% 
  select(record_id,redcap_event_name,dmatestcompyn_3m.factor,dmatestcompwhich_3m___3.factor,dmatestcompwhich_3m___4.factor,dmaptsenscompare.factor,dmaptspecsite_3m.factor) %>%
  mutate(dmaptspecsite_3m.factor = case_when(is.na(dmaptspecsite_3m.factor) ~ "missing",TRUE ~ as.character(dmaptspecsite_3m.factor))) 

m1terror3mon1_50 <- full_join(m1terror3mon1_49,m1terror3mon_50,by = intersect(names(m1terror3mon1_49),names(m1terror3mon_50)))  



#merge 3 month and baseline errors

m1tdma_baseline_3mon <- full_join(m1terror3mon1_50 ,m1terror_0_2_dma_stand_cont_ind_6,by = intersect(names(m1terror3mon1_50 ),names(m1terror_0_2_dma_stand_cont_ind_6)))



#rename DMA variables

m1tdma_baseline_3mon1 <- m1tdma_baseline_3mon %>%
  rename("1. New chest pain since surgery?"= pmachgchestpainyn.factor,
         "General region of pain"=pmapainregion.factor,
         "Highest pain location"= pmahighestloc.factor,
         "Lowest pain location"=pmalowestloc.factor,
         "Most painful region:"=pmamostpain.factor,
         "Rep 1:standardized contralateral"=dmacontr1pain,
         "Rep 1:standardized contralateral (double entry)"= dmacontr1pain_d,
         "Rep 2:standardized contralateral"=dmacontr2pain,
         "Rep 2:standardized contralateral (double entry)"=dmacontr2pain_d,
         "Rep 3:standardized contralateral"=dmacontr3pain,
         "Rep 3: standardized contralateral(double entry)"=dmacontr3pain_d,
         "Rep 4:standardized contralateral"=dmacontr4pain,
         "Rep 4:standardized contralateral (double entry)"=dmacontr4pain_d,
         "Rep 5:standardized contralateral"=dmacontr5pain,
         "Rep 5:standardized contralateral (double entry)"=dmacontr5pain_d,
         "Rep 1:standardized index"=dmaindxr1pain,
         "Rep 1:standardized index (double entry)"=dmaindxr1pain_d,
         "Rep 2:standardized index"=dmaindxr2pain,
         "Rep 2:standardized index (double entry)"=dmaindxr2pain_d,
         "Rep 3:standardized index"=dmaindxr3pain,
         "Rep 3: standardized index(double entry)"=dmaindxr3pain_d,
         "Rep 4:standardized index"=dmaindxr4pain,
         "Rep 4:standardized index (double entry)"=dmaindxr4pain_d,
         "Rep 5:standardized index"=dmaindxr5pain,
         "Rep 5: standardized index(double entry)"=dmaindxr5pain_d,
         "Sensation comparison standardized site"=dmasenscompare.factor,
         "Rep 1:Patient specific contralateral"=dmaptcontr1pain,
         "Rep 1: Patient specific contralateral(double entry)"=dmaptcontr1pain_d,
         "Rep 2:Patient specific contralateral"=dmaptcontr2pain,
         " Rep 2:Patient specific contralateral (double entry)"=dmaptcontr2pain_d,
         " Rep 3:Patient specific contralateral"=dmaptcontr3pain,
         " Rep 3:Patient specific contralateral (double entry)"=dmaptcontr3pain_d,
         " Rep 4:Patient specific contralateral"=dmaptcontr4pain,
         "Rep 4:Patient specific contralateral (double entry)"=dmaptcontr4pain_d,
         "Rep 5:Patient specific contralateral"=dmaptcontr5pain,
         "Rep 5:Patient specific contralateral (double entry)"=dmaptcontr5pain_d,
         "Rep 1:Patient specific index"=dmaptindxr1pain,
         "Rep 1:Patient specific index (double entry)"=dmaptindxr1pain_d,
         "Rep 2:Patient specific index"=dmaptindxr2pain,
         "Rep 2:Patient specific index (double entry)"=dmaptindxr2pain_d,
         "Rep 3:Patient specific index"=dmaptindxr3pain,
         "Rep 3:Patient specific index (double entry)"=dmaptindxr3pain_d,
         "Rep 4:Patient specific index"=dmaptindxr4pain,
         "Rep 4:Patient specific index (double entry)"=dmaptindxr4pain_d,
         "Rep 5:Patient specific index"=dmaptindxr5pain,
         "Rep 5:Patient specific index (double entry)"=dmaptindxr5pain_d,
         "Patient-Specific site assessed? (3-Month)"=dmaptspecsite_3m.factor,
         "Sensation comparison patient-specific site:"=dmaptsenscompare.factor,
         "DMA Test(s) completed"=dmatestcompyn.factor,
         "3 month DMA Test(s) completed"=dmatestcompyn_3m.factor,
         "Choose all completed sites: (Baseline) (choice=1. Standardized control site (contralateral))" =dmatestcompwhich___1.factor,
         "Choose all completed sites: (Baseline) (choice=2. Standardized index site (surgical))"=dmatestcompwhich___2.factor,
         "Choose all completed sites: (3-Month) (choice=1. Standardized control site (contralateral))"=dmatestcompwhich_3m___1.factor,
         "Choose all completed sites: (3-Month) (choice=2. Standardized index site (surgical))"=dmatestcompwhich_3m___2.factor,
         "Choose all completed sites: (3-Month) (choice=3. Patient specific control site (contralateral))"=dmatestcompwhich_3m___3.factor,
         "Choose all completed sites: (3-Month) (choice=4. Patient specific index site (surgical))"=dmatestcompwhich_3m___4.factor)







m1tdma_baseline_3mon1 <- m1tdma_baseline_3mon1 %>% 
  as_tibble() %>% 
  mutate_all(as.character)






#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m1tdma_baseline_3mon1[m1tdma_baseline_3mon1 == ""] <- NA

m1tdma_baseline_3mon1 <- m1tdma_baseline_3mon1 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m1tdma_notes <- qdatam1t %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,dmanotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# now add notes


m1tdma_shrink_notes  <- left_join(m1tdma_baseline_3mon1,m1tdma_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )



#PPTs


# Explore variables and check for missingness in "ppt test completed"

tabyl(qdatam1t,pptcompleteyn,pptcompleteyn.factor,show_na= TRUE)


#Remove records with missing "ppt test completed"

m1tdata.ppt <- qdatam1t %>% 
  filter(!is.na(pptcompleteyn))

#recheck if NAs removed

tabyl(m1tdata.ppt,pptcompleteyn.factor,pptcompleteyn,show_na= TRUE)

# keep record with "ppt test completed"

m1tppt.complete <- m1tdata.ppt %>% 
  filter(pptcompleteyn != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site(chest):
#data$pptcompleteyn.factor = factor(data$pptcompleteyn,levels=c("1","2","3","0"))
#levels(data$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (chest)","no, neither site")

tabyl(m1tppt.complete,pptcompleteyn.factor,pptcompleteyn,show_na= TRUE)


#Remote site:
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral:

#rep1
m1terrorppt2.1 <-  m1tppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremoter1val - pptremoter1val_d) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>% 
  mutate(pptremoter1val = case_when(is.na(pptremoter1val) ~ "missing",TRUE ~ as.character(pptremoter1val))) %>% 
  mutate(pptremoter1val_d = case_when(is.na(pptremoter1val_d) ~ "missing",TRUE ~ as.character(pptremoter1val_d) )) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter1val,pptremoter1val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremoter1val,"ppt remote rep1(double entry)"= pptremoter1val_d )) 


#rep2
m1terrorppt2.2 <-  m1tppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremoter2val - pptremoter2val_d) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2)) %>% 
  mutate(pptremoter2val = case_when(is.na(pptremoter2val) ~ "missing",TRUE ~ as.character(pptremoter2val))) %>% 
  mutate(pptremoter2val_d = case_when(is.na(pptremoter2val_d) ~ "missing",TRUE ~ as.character(pptremoter2val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter2val,pptremoter2val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep2"= pptremoter2val,"ppt remote rep2(double entry)"= pptremoter2val_d ))



#rep3

m1terrorppt2.3 <-  m1tppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremoter3val - pptremoter3val_d) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>% 
  mutate(pptremoter3val = case_when(is.na(pptremoter3val) ~ "missing",TRUE ~ as.character(pptremoter3val))) %>% 
  mutate(pptremoter3val_d = case_when(is.na(pptremoter3val_d) ~ "missing",TRUE ~ as.character(pptremoter3val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter3val,pptremoter3val_d)%>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep3"= pptremoter3val,"ppt remote rep3(double entry)"= pptremoter3val_d ))

m1terrorppt2 <-  full_join(m1terrorppt2.1,m1terrorppt2.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,m1terrorppt2.3,by= c("record_id","redcap_event_name","PPT test completed?")) 


#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site::

#rep1
m1terrorppt3.1 <-  m1tppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff1 = pptindxr1val - pptindxr1val_d) %>% 
  filter(ppt_indexr_diff1 != 0 | is.na(ppt_indexr_diff1)) %>%
  mutate(pptindxr1val = case_when(is.na(pptindxr1val) ~ "missing",TRUE ~ as.character(pptindxr1val))) %>% 
  mutate(pptindxr1val_d = case_when(is.na(pptindxr1val_d) ~ "missing",TRUE ~ as.character(pptindxr1val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr1val,pptindxr1val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"= pptindxr1val,"ppt index rep1(double entry)"= pptindxr1val_d ))


#rep2
m1terrorppt3.2 <-  m1tppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff2 = pptindxr2val - pptindxr2val_d) %>% 
  filter(ppt_indexr_diff2 != 0 | is.na(ppt_indexr_diff2)) %>% 
  mutate(pptindxr2val = case_when(is.na(pptindxr2val) ~ "missing",TRUE ~ as.character(pptindxr2val))) %>% 
  mutate(pptindxr2val_d = case_when(is.na(pptindxr2val_d) ~ "missing",TRUE ~ as.character(pptindxr2val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr2val,pptindxr2val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep2"= pptindxr2val,"ppt index rep2(double entry)"= pptindxr2val_d ))


#rep3

m1terrorppt3.3 <-  m1tppt.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_indexr_diff3 = pptindxr3val - pptindxr3val_d) %>% 
  filter(ppt_indexr_diff3 != 0 | is.na(ppt_indexr_diff3)) %>% 
  mutate(pptindxr3val = case_when(is.na(pptindxr3val) ~ "missing",TRUE ~ as.character(pptindxr3val))) %>% 
  mutate(pptindxr3val_d = case_when(is.na(pptindxr3val_d) ~ "missing",TRUE ~ as.character(pptindxr3val_d) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr3val,pptindxr3val_d) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep3"= pptindxr3val,"ppt index rep3(double entry)"= pptindxr3val_d ))

m1terrorppt3a <-  full_join(m1terrorppt3.1,m1terrorppt3.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,m1terrorppt3.3,by= c("record_id","redcap_event_name","PPT test completed?")) 

#merge errorppt2 and 3a


m1terrorppt2_3 <- full_join(m1terrorppt2,m1terrorppt3a,by = intersect(names(m1terrorppt2), names(m1terrorppt3a)))


#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 



m1terrorppt3b.1 <- m1tppt.complete %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindxr1val) & !is.na(pptindxr1val_d))  | (!is.na(pptindxr2val)  & !is.na(pptindxr2val_d)) | (!is.na(pptindxr3val)  & !is.na(pptindxr3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr1val,pptindxr1val_d,pptindxr2val,pptindxr2val_d,pptindxr3val,pptindxr3val_d,index1) %>% 
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(as.character(.)))

m1terrorppt3b.2 <- m1tppt.complete %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindxr1val) & is.na(pptindxr1val_d))  | (is.na(pptindxr2val)  & is.na(pptindxr2val_d)) | (is.na(pptindxr3val)  & is.na(pptindxr3val_d))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindxr1val,pptindxr1val_d,pptindxr2val,pptindxr2val_d,pptindxr3val,pptindxr3val_d,index2)

m1terrorppt3b.2 <- m1terrorppt3b.2 %>%
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



m1terrorppt3b.3 <- m1tppt.complete %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremoter1val) & !is.na(pptremoter1val_d))  | (!is.na(pptremoter2val)  & !is.na(pptremoter2val_d)) | (!is.na(pptremoter3val)  & !is.na(pptremoter3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter1val,pptremoter1val_d,pptremoter2val,pptremoter2val_d,pptremoter3val,pptremoter3val_d,remote1) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(as.character(.)))

m1terrorppt3b.4 <- m1tppt.complete %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremoter1val) & is.na(pptremoter1val_d))  | (is.na(pptremoter2val)  & is.na(pptremoter2val_d)) | (is.na(pptremoter3val)  & is.na(pptremoter3val_d))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremoter1val,pptremoter1val_d,pptremoter2val,pptremoter2val_d,pptremoter3val,pptremoter3val_d,remote2)


m1terrorppt3b.4 <- m1terrorppt3b.4 %>%
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



#merge errorppt 3
###########
m1terrorppt3c <- full_join(m1terrorppt3b.1,m1terrorppt3b.2,by = intersect(names(m1terrorppt3b.1), names(m1terrorppt3b.2)))
m1terrorppt3d <- full_join(m1terrorppt3b.3,m1terrorppt3b.4,by = intersect(names(m1terrorppt3b.3), names(m1terrorppt3b.4)))
# 
# ###########
m1terrorppt3b <- full_join(m1terrorppt3c,m1terrorppt3d,by = intersect(names(m1terrorppt3c), names(m1terrorppt3d))) %>%
  select(c(-index1,-index2,-remote1,-remote2)) 


m1terrorppt3b<- m1terrorppt3b%>%
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"=pptindxr1val,"ppt index rep1(double entry)"= pptindxr1val_d,"ppt index rep2"= pptindxr2val,"ppt index rep2(double entry)"= pptindxr2val_d,"ppt index rep3"= pptindxr3val,"ppt index rep3(double entry)"= pptindxr3val_d,"ppt remote rep1"= pptremoter1val,"ppt remote rep1(double entry)"= pptremoter1val_d,"ppt remote rep2"= pptremoter2val,"ppt remote rep2(double entry)"= pptremoter2val_d,"ppt remote rep3"= pptremoter3val,"ppt remote rep3(double entry)"= pptremoter3val_d  ))


# 
# errorppt3b[] <- lapply(errorppt3b, as.character)
# errorppt2_3[] <- lapply(errorppt2_3, as.character)


m1terrorppt2_3_3b <- full_join(m1terrorppt2_3,m1terrorppt3b,by = intersect(names(m1terrorppt2_3), names(m1terrorppt3b)))

# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


m1tppt.biomarker <- m1tppt.complete %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindxr1val,pptindxr2val,pptindxr3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindxr1val,pptindxr2val,pptindxr3val,pptcompleteyn.factor) %>% 
  mutate_at(
    vars(starts_with("pptindxr")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


m1tppt.biomarker1 <- m1tppt.complete %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremoter1val,pptremoter2val,pptremoter3val,pptcompleteyn.factor) %>% 
  mutate_at(
    vars(starts_with("pptremoter")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m1tppt.all.biomarker <- full_join(m1tppt.biomarker,m1tppt.biomarker1,by=c("record_id","redcap_event_name","pptcompleteyn.factor")) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremoter1val,"ppt remote rep2"= pptremoter2val,"ppt remote rep3"= pptremoter3val,"ppt index rep1"= pptindxr1val,"ppt index rep2"= pptindxr2val,"ppt index rep3"= pptindxr3val ))






m1tall.ppt <- full_join(m1terrorppt2_3_3b,m1tppt.all.biomarker,by = intersect(names(m1terrorppt2_3_3b ), names(m1tppt.all.biomarker)))


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m1tall.ppt[m1tall.ppt == ""] <- NA

m1tall.ppt <- m1tall.ppt %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m1tppt_notes <- qdatam1t %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,pptnotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes


m1tppt_shrink_notes  <- left_join(m1tall.ppt,m1tppt_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )


# MCC2 Temporal summation
#explore variables



#PPTs

# check for missingness in "ts test completed"

tabyl(qdatam1t,tscompleted.factor,tscompleted,show_na= TRUE)


#Remove records with missing "ts test completed"

m1tdata.ts <- qdatam1t %>% 
  filter(!is.na(tscompleted))

#recheck if NAs removed

tabyl(m1tdata.ts,tscompleted,tscompleted.factor,show_na= TRUE)

# keep record with "tscompleted test completed"

m1tts.complete <- m1tdata.ts %>% 
  filter(tscompleted != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= yes atleast 1 rep for both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):


tabyl(m1tts.complete,tscompleted,tscompleted.factor,show_na= TRUE)

#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
m1terrorppt4.1 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsremoter1initial - tsremoter1initial_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1)) %>% 
  mutate(tsremoter1initial = case_when(is.na(tsremoter1initial) ~ "missing",TRUE ~ as.character(tsremoter1initial))) %>% 
  mutate(tsremoter1initial_d = case_when(is.na(tsremoter1initial_d) ~ "missing",TRUE ~ as.character(tsremoter1initial_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1initial_d,tscompleted) 


#rep1 final
m1terrorppt4.2 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsremoter1final - tsremoter1final_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  mutate(tsremoter1final = case_when(is.na(tsremoter1final) ~ "missing",TRUE ~ as.character(tsremoter1final))) %>% 
  mutate(tsremoter1final_d = case_when(is.na(tsremoter1final_d) ~ "missing",TRUE ~ as.character(tsremoter1final_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1final,tsremoter1final_d,tscompleted) 


#rep1 set 
m1trep1.set <- full_join(m1terrorppt4.1,m1terrorppt4.2,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#rep2 initial

m1terrorppt4.3 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsremoter2initial - tsremoter2initial_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  mutate(tsremoter2initial = case_when(is.na(tsremoter2initial) ~ "missing",TRUE ~ as.character(tsremoter2initial))) %>% 
  mutate(tsremoter2initial_d = case_when(is.na(tsremoter2initial_d) ~ "missing",TRUE ~ as.character(tsremoter2initial_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter2initial,tsremoter2initial_d,tscompleted) 

#rep2 final
m1terrorppt4.4 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsremoter2final - tsremoter2final_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  mutate(tsremoter2final = case_when(is.na(tsremoter2final) ~ "missing",TRUE ~ as.character(tsremoter2final))) %>% 
  mutate(tsremoter2final_d = case_when(is.na(tsremoter2final_d) ~ "missing",TRUE ~ as.character(tsremoter2final_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter2final,tsremoter2final_d,tscompleted) 

#rep2 set 

m1trep2.set <- full_join(m1terrorppt4.3,m1terrorppt4.4,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


#rep3 initial

m1terrorppt4.5 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsremoter3initial - tsremoter3initial_d) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>% 
  mutate(tsremoter3initial = case_when(is.na(tsremoter3initial) ~ "missing",TRUE ~ as.character(tsremoter3initial))) %>% 
  mutate(tsremoter3initial_d = case_when(is.na(tsremoter3initial_d) ~ "missing",TRUE ~ as.character(tsremoter3initial_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter3initial,tsremoter3initial_d,tscompleted) 

#rep3 final
m1terrorppt4.6 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsremoter3final - tsremoter3final_d) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3)) %>% 
  mutate(tsremoter3final = case_when(is.na(tsremoter3final) ~ "missing",TRUE ~ as.character(tsremoter3final))) %>% 
  mutate(tsremoter3final_d = case_when(is.na(tsremoter3final_d) ~ "missing",TRUE ~ as.character(tsremoter3final_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter3final,tsremoter3final_d,tscompleted) 

#rep3 set 
m1trep3.set <- full_join(m1terrorppt4.5,m1terrorppt4.6,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

m1tTs_remote_all_reps1 <- full_join(m1trep1.set,m1trep2.set,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted")) %>% 
  full_join(.,m1trep3.set,by= c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
m1tts1 <- m1tTs_remote_all_reps1 %>% 
  mutate(rep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter1initial))  & (is.na(tsremoter1initial_d))  & (is.na(tsremoter1final)) & (is.na(tsremoter1final_d))~ 1,TRUE ~ 0)) %>% 
  mutate(rep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter2initial))  & (is.na(tsremoter2initial_d))  & (is.na(tsremoter2final)) & (is.na(tsremoter2final_d))~ 1,TRUE ~ 0)) %>% 
  mutate(rep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsremoter3initial))  & (is.na(tsremoter3initial_d))  & (is.na(tsremoter3final)) & (is.na(tsremoter3final_d))~ 1,TRUE ~ 0))


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d ))

#index site Index site 

# check for missing or mismatch in pain ratings for  Index site in both site OR  Index site 

#rep1 initial
m1terrorppt6.1 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsindxr1initial - tsindxr1initial_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  mutate(tsindxr1initial = case_when(is.na(tsindxr1initial) ~ "missing",TRUE ~ as.character(tsindxr1initial))) %>%
  mutate(tsindxr1initial_d = case_when(is.na(tsindxr1initial_d) ~ "missing",TRUE ~ as.character(tsindxr1initial_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1initial,tsindxr1initial_d,tscompleted)

#rep1 final 

m1terrorppt6.2 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsindxr1final - tsindxr1final_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  mutate(tsindxr1final = case_when(is.na(tsindxr1final) ~ "missing",TRUE ~ as.character(tsindxr1final))) %>%
  mutate(tsindxr1final_d = case_when(is.na(tsindxr1final_d) ~ "missing",TRUE ~ as.character(tsindxr1final_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1final,tsindxr1final_d,tscompleted)



#rep1 set 
m1trep1.index.set <- full_join(m1terrorppt6.1,m1terrorppt6.2,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

#rep2 initial

m1terrorppt6.3 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsindxr2initial - tsindxr2initial_d) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>% 
  mutate(tsindxr2initial = case_when(is.na(tsindxr2initial) ~ "missing",TRUE ~ as.character(tsindxr2initial)))%>%
  mutate(tsindxr2initial_d = case_when(is.na(tsindxr2initial_d) ~ "missing",TRUE ~ as.character(tsindxr2initial_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr2initial,tsindxr2initial_d,tscompleted)


#rep2 final
m1terrorppt6.4 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsindxr2final - tsindxr2final_d) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  mutate(tsindxr2final = case_when(is.na(tsindxr2final) ~ "missing",TRUE ~ as.character(tsindxr2final)))%>%
  mutate(tsindxr2final_d = case_when(is.na(tsindxr2final_d) ~ "missing",TRUE ~ as.character(tsindxr2final_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr2final,tsindxr2final_d,tscompleted)


#rep2 set 
m1trep2.index.set <- full_join(m1terrorppt6.3,m1terrorppt6.4,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))


#rep3 initial

m1terrorppt6.5 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsindxr3initial - tsindxr3initial_d) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>% 
  mutate(tsindxr3initial = case_when(is.na(tsindxr3initial) ~ "missing",TRUE ~ as.character(tsindxr3initial)))%>%
  mutate(tsindxr3initial_d = case_when(is.na(tsindxr3initial_d) ~ "missing",TRUE ~ as.character(tsindxr3initial_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr3initial,tsindxr3initial_d,tscompleted) 

#rep3 final
m1terrorppt6.6 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsindxr3final - tsindxr3final_d) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  mutate(tsindxr3final = case_when(is.na(tsindxr3final) ~ "missing",TRUE ~ as.character(tsindxr3final)))%>%
  mutate(tsindxr3final_d = case_when(is.na(tsindxr3final_d) ~ "missing",TRUE ~ as.character(tsindxr3final_d) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr3final,tsindxr3final_d,tscompleted) 

#rep3 set 
m1trep3.index.set <- full_join(m1terrorppt6.5,m1terrorppt6.6,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
m1tTs_index_all_reps1 <- full_join(m1trep1.index.set,m1trep2.index.set,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  full_join(.,m1trep3.index.set,by= c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0

m1tts.index1 <- m1tTs_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr1initial))  & (is.na(tsindxr1initial_d))  & (is.na(tsindxr1final)) & (is.na(tsindxr1final_d))~ 1,TRUE ~ 0)) 


m1tts.index1 <- m1tts.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr2initial))  & (is.na(tsindxr2initial_d))  & (is.na(tsindxr2final)) & (is.na(tsindxr2final_d))~ 1,TRUE ~ 0))


m1tts.index1 <- m1tts.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsindxr3initial))  & (is.na(tsindxr3initial_d))  & (is.na(tsindxr3final)) & (is.na(tsindxr3final_d))~ 1,TRUE ~ 0))


# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d))



m1tts1 <- m1tts1 %>% 
  mutate(all.reps.rem = case_when(rep1 == 0  & rep2==0  & rep3==0  ~ 0,TRUE ~ 1))

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
m1tts.index1 <- m1tts.index1 %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == 0  & ind.rep2==0  & ind.rep3==0  ~ 0,TRUE ~ 1))
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
m1trem.ind <- full_join(m1tts1,m1tts.index1,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  filter((tscompleted == 2 & all.reps.rem == 0)| (tscompleted == 3 & all.reps.ind == 0) | (tscompleted == 1 & all.reps.rem == 0 |all.reps.ind == 0 ))


m1trem_index_all_reps <- m1trem.ind %>% 
  select(c(-tscompleted,-rep1,-rep2,-rep3,-all.reps.rem,-all.reps.ind,-ind.rep1,-ind.rep2,-ind.rep3)) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d))

# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

m1terrorppt5.1 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsremoteafter15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoteafter15) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 15sec"= tsremoteafter15 )) %>% 
  mutate("TS remote after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
m1terrorppt5.2 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts31)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremafts31) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 30sec"= tsfinalpainremafts31 ))  %>% 
  mutate("TS remote after sensation 30sec"=replace_na("missing")) 

# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# errorppt5.1[] <- lapply(errorppt5.1, as.character)
# errorppt5.2[] <- lapply(errorppt5.2, as.character)


m1tTs_remote_all_reps_sensations <- full_join(m1trem_index_all_reps,m1terrorppt5.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,m1terrorppt5.2,by= c("record_id","redcap_event_name","TS test completed?"))


# once TS  Index site is completed
# missing after sensation at 15 secs

m1terrorppt7.1 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsindxafter15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxafter15)%>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 15sec"= tsindxafter15 )) %>% 
  mutate("TS index after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
m1terrorppt7.2 <-  m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsindxafter30)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxafter30) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 30sec"= tsindxafter30 )) %>% 
  mutate("TS index after sensation 30sec"=replace_na("missing"))

# convert all char for merging
# Ts_remote_all_reps_sensations[] <- lapply(Ts_remote_all_reps_sensations, as.character)
# errorppt7.1[] <- lapply(errorppt7.1, as.character)
# errorppt7.2[] <- lapply(errorppt7.2, as.character)


#merge all
m1tTs_index_remote_all_reps_sensation <- full_join(m1tTs_remote_all_reps_sensations,m1terrorppt7.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,m1terrorppt7.2,by= c("record_id","redcap_event_name","TS test completed?"))


# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

m1terrorppt7.3a <- m1tts.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsindxr1initial) & !is.na(tsindxr1initial_d))  | (!is.na(tsindxr1final)  & !is.na(tsindxr1final_d)) | (!is.na(tsindxr2initial )  & !is.na(tsindxr2initial_d)) | (!is.na(tsindxr2final) & !is.na(tsindxr2final_d))  | (!is.na(tsindxr3initial)  & !is.na(tsindxr3initial_d)) | (!is.na(tsindxr3final)  & !is.na(tsindxr3final_d))  ~ 1,TRUE ~ 0))  %>% 
  filter(ts.index1 == 1)  %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d) 
#OR b.if both sites was checked but pain ratings not filled out for the index site 


m1terrorppt7.3b <- m1tts.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsindxr1initial) & is.na(tsindxr1initial_d)  & is.na(tsindxr1final)  & is.na(tsindxr1final_d) & is.na(tsindxr2initial )  & is.na(tsindxr2initial_d) & is.na(tsindxr2final) & is.na(tsindxr2final_d)  & is.na(tsindxr3initial)  & is.na(tsindxr3initial_d) & is.na(tsindxr3final)  & is.na(tsindxr3final_d)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )

# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 



m1terrorppt7.4a <- m1tts.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsremoter1initial) & !is.na(tsremoter1initial_d))  | (!is.na(tsremoter1final)  & !is.na(tsremoter1final_d)) | (!is.na(tsremoter2initial)  & !is.na(tsremoter2initial_d)) | (!is.na(tsremoter2final) & !is.na(tsremoter2final_d))  | (!is.na(tsremoter3initial)  & !is.na(tsremoter3initial_d)) | (!is.na(tsremoter3final)  & !is.na(tsremoter3final_d))  ~ 1,TRUE ~ 0))  %>%
  filter(ts.remote1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d,tsindxr1initial,tsindxr1initial_d,tsindxr1final,tsindxr1final_d,tsindxr2initial ,tsindxr2initial_d,tsindxr2final,tsindxr2final_d,tsindxr3initial,tsindxr3initial_d,tsindxr3final,tsindxr3final_d)


#OR b.if both sites was checked but pain ratings not filled out for the remote site


m1terrorppt7.4b <- m1tts.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsremoter1initial) & is.na(tsremoter1initial_d)  & is.na(tsremoter1final)  & is.na(tsremoter1final_d) & is.na(tsremoter2initial)  & is.na(tsremoter2initial_d) & is.na(tsremoter2final) & is.na(tsremoter2final_d)  & is.na(tsremoter3initial)  & is.na(tsremoter3initial_d) & is.na(tsremoter3final)  & is.na(tsremoter3final_d)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1initial_d,tsremoter1final,tsremoter1final_d,tsremoter2initial,tsremoter2initial_d,tsremoter2final,tsremoter2final_d,tsremoter3initial,tsremoter3initial_d,tsremoter3final,tsremoter3final_d)%>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


#merge 7.3a,7.3b,7.4a,7.4b





m1terrorppt7.3a[] <- lapply(m1terrorppt7.3a, as.character)
m1terrorppt7.3b[] <- lapply(m1terrorppt7.3b, as.character)
m1terrorppt7.4a[] <- lapply(m1terrorppt7.4a, as.character)
m1terrorppt7.4b[] <- lapply(m1terrorppt7.4b, as.character)


m1tmerged7.3 <- full_join(m1terrorppt7.3a,m1terrorppt7.3b,by = intersect(names(m1terrorppt7.3a), names(m1terrorppt7.3b)))
m1tmerged7.4 <- full_join(m1terrorppt7.4a,m1terrorppt7.4b,by = intersect(names(m1terrorppt7.4a), names(m1terrorppt7.4b)))

m1tmerged7 <- full_join(m1tmerged7.3,m1tmerged7.4,by = intersect(names(m1tmerged7.3), names(m1tmerged7.4)))


#rename merged7
m1tmerged7.1 <- m1tmerged7 %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 initial(double entry)"= tsindxr1initial_d,"TS index rep1 final"= tsindxr1final,"TS index rep1 final(double entry)"= tsindxr1final_d,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 initial(double entry)"= tsindxr2initial_d ,"TS index rep2 final"= tsindxr2final,"TS index rep2 final(double entry)"= tsindxr2final_d,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 initial(double entry)"= tsindxr3initial_d,"TS index rep3 final"= tsindxr3final,"TS index rep3 final(double entry)"= tsindxr3final_d,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 initial(double entry)"= tsremoter1initial_d,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep1 final(double entry)"= tsremoter1final_d,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 initial(double entry)"= tsremoter2initial_d,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep2 final(double entry)"= tsremoter2final_d ,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 initial(double entry)"= tsremoter3initial_d,"TS contralateral rep3 final"= tsremoter3final,"TS contralateral rep3 final(double entry)"= tsremoter3final_d))  

# change  to as.character for merging
m1tTs_index_remote_all_reps_sensation [] <- lapply(m1tTs_index_remote_all_reps_sensation , as.character)
m1tmerged7.1[] <- lapply(m1tmerged7.1, as.character)




#merge Ts_index_remote_all_reps_sensation and merged7.1 

m1tmerge8 <- full_join(m1tmerged7.1,m1tTs_index_remote_all_reps_sensation ,by = intersect(names(m1tmerged7.1), names(m1tTs_index_remote_all_reps_sensation )))


# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
m1tprim.outcome.index <- m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsindxr1final,tsindxr1initial)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsindxr1initial) %>% 
  mutate(max.rep2.index = pmax(tsindxr2final,tsindxr2initial )) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsindxr2initial ) %>% 
  mutate(max.rep3.index = pmax(tsindxr3final,tsindxr3initial)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsindxr3initial) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsindxr1final,tsindxr1initial,tsindxr2final,tsindxr2initial ,tsindxr3final,tsindxr3initial)%>%
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m1tprim.outcome.remote <- m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsremoter1initial,tsremoter1final)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsremoter1initial) %>% 
  mutate(max.rep2.remote = pmax(tsremoter2initial,tsremoter2final)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsremoter2initial) %>% 
  mutate(max.rep3.remote = pmax(tsremoter3initial,tsremoter3final)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsremoter3initial) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1final,tsremoter2initial,tsremoter2final,tsremoter3initial,tsremoter3final)%>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m1tts_primary_outcome <-  full_join(m1tprim.outcome.index, m1tprim.outcome.remote ,by = intersect(names( m1tprim.outcome.remote), names(m1tprim.outcome.index ))) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 final"= tsindxr1final,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 final"= tsindxr2final,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 final"= tsindxr3final,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 final"= tsremoter3final))  


# # change  to as.character for merging
m1tmerge8 [] <- lapply(m1tmerge8 , as.character)
m1tts_primary_outcome[] <- lapply(m1tts_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

m1tts.all.prim.outcome <- full_join(m1tmerge8,m1tts_primary_outcome ,by = intersect(names(m1tmerge8), names(m1tts_primary_outcome)))


# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m1tsec.outcome.index <- m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsindxr1final,tsindxr1initial))) %>% 
  mutate(init.rep1.index1 = 1+(tsindxr1initial)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsindxr2final,tsindxr2initial ))) %>% 
  mutate(init.rep2.index1 = 1+(tsindxr2initial )) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsindxr3final,tsindxr3initial))) %>% 
  mutate(init.rep3.index1 = 1+(tsindxr3initial)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsindxr1final,tsindxr1initial,tsindxr2final,tsindxr2initial ,tsindxr3final,tsindxr3initial) %>%
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m1tsec.outcome.remote <- m1tts.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsremoter1initial,tsremoter1final))) %>% 
  mutate(init.rep1.remote1 = 1+(tsremoter1initial)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsremoter2initial,tsremoter2final))) %>% 
  mutate(init.rep2.remote1 = 1+(tsremoter2initial)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsremoter3initial,tsremoter3final))) %>% 
  mutate(init.rep3.remote1 = 1+(tsremoter3initial)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsremoter1initial,tsremoter1final,tsremoter2initial,tsremoter2final,tsremoter3initial,tsremoter3final) %>%
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )

m1tts_sec_outcome <-  full_join(m1tsec.outcome.index, m1tsec.outcome.remote ,by = intersect(names( m1tsec.outcome.remote), names(m1tsec.outcome.index ))) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsindxr1initial,"TS index rep1 final"= tsindxr1final,"TS index rep2 initial"= tsindxr2initial ,"TS index rep2 final"= tsindxr2final,"TS index rep3 initial"= tsindxr3initial,"TS index rep3 final"= tsindxr3final,"TS contralateral rep1 initial"= tsremoter1initial,"TS contralateral rep1 final"= tsremoter1final,"TS contralateral rep2 initial"= tsremoter2initial,"TS contralateral rep2 final"= tsremoter2final,"TS contralateral rep3 initial"= tsremoter3initial,"TS contralateral rep3 final"= tsremoter3final)) 



# change  to as.character for merging
m1tts_sec_outcome [] <- lapply(m1tts_sec_outcome , as.character)
m1tts.all.prim.outcome[] <- lapply(m1tts.all.prim.outcome, as.character)

#merge ts_sec_outcome  with ts.all.prim.outcome

m1tts.all.prim.sec.outcome <- full_join(m1tts_sec_outcome ,m1tts.all.prim.outcome ,by = intersect(names(m1tts_sec_outcome), names(m1tts.all.prim.outcome )))



m1tts.all.prim.sec.outcome <- m1tts.all.prim.sec.outcome %>%
  relocate("record_id","redcap_event_name","TS test completed?","TS index rep1 initial","TS index rep1 initial(double entry)","TS index rep1 final"
           ,"TS index rep1 final(double entry)","TS index rep2 initial",  "TS index rep2 initial(double entry)", "TS index rep2 final", "TS index rep2 final(double entry)","TS index rep3 initial","TS index rep3 initial(double entry)","TS index rep3 final", 
           "TS index rep3 final(double entry)" , "TS index after sensation 15sec","TS index after sensation 30sec","TS contralateral rep1 initial" , 
           "TS contralateral rep1 initial(double entry)", "TS contralateral rep1 final" ,"TS contralateral rep1 final(double entry)","TS contralateral rep2 initial","TS contralateral rep2 initial(double entry)","TS contralateral rep2 final" ,   "TS contralateral rep2 final(double entry)" ,"TS contralateral rep3 initial", "TS contralateral rep3 initial(double entry)", "TS contralateral rep3 final" ,  "TS contralateral rep3 final(double entry)" ,"TS remote after sensation 15sec" ,   "TS remote after sensation 30sec" )



m1tts.all.prim.sec.outcome[m1tts.all.prim.sec.outcome == ""] <- NA

m1tall.ts <- m1tts.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m1tts_notes <- qdatam1t %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,tsnotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes

m1tts_shrink_notes  <- left_join(m1tall.ts,m1tts_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )




# mcc2 Conditioned Pain Modulation


# check for missingness in "cp test completed"

tabyl(qdatam1t,cpmcompleteyn,cpmcompleteyn.factor,show_na= TRUE)


#Remove records with missing "cp test completed"

m1tdata1cp <- qdatam1t %>% 
  filter(!is.na(cpmcompleteyn))

#recheck if NAs removed

tabyl(m1tdata1cp,cpmcompleteyn,cpmcompleteyn.factor,show_na= TRUE)

# keep record with "cpm test completed"

m1tcpm.complete <- m1tdata1cp %>% 
  filter(cpmcompleteyn != 0)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):


tabyl(m1tcpm.complete,cpmcompleteyn.factor,cpmcompleteyn,show_na= TRUE)


#water temp not checked

m1tcpm.error1 <- m1tcpm.complete %>% 
  filter(cpmcoldwatertemp != 1) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmcoldwatertemp) %>% 
  mutate(cpmcoldwatertemp = case_when(cpmcoldwatertemp != 1 ~ "missing",TRUE ~ as.character(cpmcoldwatertemp))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"confirm water temp"=cpmcoldwatertemp)

# missing or mismatch in cold water pain rating at 30 sec

m1tcpm.error2 <- m1tcpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30 - cpmcoldwaterpain30_d) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  mutate(cpmcoldwaterpain30 = case_when(is.na(cpmcoldwaterpain30) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30)))%>%
  mutate(cpmcoldwaterpain30_d = case_when(is.na(cpmcoldwaterpain30_d) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain30,cpmcoldwaterpain30_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 30 sec"=cpmcoldwaterpain30,"Cold Water Pain Rating at 30 sec(double entry)"=cpmcoldwaterpain30_d)



# missing or mismatch in cold water pain rating at 60 sec
m1tcpm.error3 <- m1tcpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60 - cpmcoldwaterpain60_d) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>% 
  mutate(cpmcoldwaterpain60 = case_when(is.na(cpmcoldwaterpain60) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60)))%>%
  mutate(cpmcoldwaterpain60_d = case_when(is.na(cpmcoldwaterpain60_d) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60_d))) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain60,cpmcoldwaterpain60_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 60 sec"=cpmcoldwaterpain60,"Cold Water Pain Rating at 60 sec(double entry)"=cpmcoldwaterpain60_d)


#merge error 2&3
m1terrorcpm1t_3 <- full_join(m1tcpm.error2,m1tcpm.error3,by = c("record_id","redcap_event_name","cpm test completed","water bath duration","if outside range: time")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

##merge error 1 with 2&3
m1terrorcpm1_2_3 <- full_join(m1tcpm.error1,m1terrorcpm1t_3,by = c("record_id","redcap_event_name","cpm test completed")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#check for missing/mismatch in ppts

m1tcpm.error4.1 <- m1tcpm.complete %>% 
  mutate(diff_cpm1 = cpmpptremr1val - cpmpptremr1val_d) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>% 
  mutate(cpmpptremr1val = case_when(is.na(cpmpptremr1val) ~ "missing",TRUE ~ as.character(cpmpptremr1val)))%>%
  mutate(cpmpptremr1val_d = case_when(is.na(cpmpptremr1val_d) ~ "missing",TRUE ~ as.character(cpmpptremr1val_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmpptremr1val,cpmpptremr1val_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmpptremr1val,"conditioned pain modulation PPT:rep1(double entry)"=cpmpptremr1val_d)

#check for missing/mismatch in ppts

m1tcpm.error4.2 <- m1tcpm.complete %>% 
  mutate(diff_cpm1t = cpmpptremr2val - cpmpptremr2val_d) %>% 
  filter(diff_cpm1t!=0 | is.na(diff_cpm1t)) %>% 
  mutate(cpmpptremr2val = case_when(is.na(cpmpptremr2val) ~ "missing",TRUE ~ as.character(cpmpptremr2val)))%>%
  mutate(cpmpptremr2val_d = case_when(is.na(cpmpptremr2val_d) ~ "missing",TRUE ~ as.character(cpmpptremr2val_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmpptremr2val,cpmpptremr2val_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep2"=cpmpptremr2val,"conditioned pain modulation PPT:rep2(double entry)"=cpmpptremr2val_d)


#check for missing/mismatch in ppts

m1tcpm.error4.3 <- m1tcpm.complete %>% 
  mutate(diff_cpm3 = cpmpptremr3val - cpmpptremr3val_d) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>% 
  mutate(cpmpptremr3val = case_when(is.na(cpmpptremr3val) ~ "missing",TRUE ~ as.character(cpmpptremr3val)))%>%
  mutate(cpmpptremr3val_d = case_when(is.na(cpmpptremr3val_d) ~ "missing",TRUE ~ as.character(cpmpptremr3val_d) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmpptremr3val,cpmpptremr3val_d) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep3"=cpmpptremr3val,"conditioned pain modulation PPT:rep3(double entry)"=cpmpptremr3val_d)


#merge 4.1-.3

m1tcpm.error4 <- full_join(m1tcpm.error4.1,m1tcpm.error4.2,by = c("record_id","redcap_event_name","cpm test completed")) %>% 
  full_join(.,m1tcpm.error4.3,by= c("record_id","redcap_event_name","cpm test completed")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m1tcpm.final <- full_join(m1tcpm.error4,m1terrorcpm1_2_3,by = c("record_id","redcap_event_name","cpm test completed"))




# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


m1tcmp.prim.outcome <- m1tcpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmpptremr1val,cpmpptremr2val,cpmpptremr3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremoter1val,pptremoter2val,pptremoter3val,cpmpptremr1val,cpmpptremr2val,cpmpptremr3val) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


m1tcmp.sec.outcome <- m1tcpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremoter1val,pptremoter2val,pptremoter3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmpptremr1val,cpmpptremr2val,cpmpptremr3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremoter1val,pptremoter2val,pptremoter3val,cpmpptremr1val,cpmpptremr2val,cpmpptremr3val) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m1tcmp.outcome <- full_join(m1tcmp.prim.outcome ,m1tcmp.sec.outcome ,by = intersect(names(m1tcmp.prim.outcome), names(m1tcmp.sec.outcome))) %>%
  rename("cpm test completed"=cpmcompleteyn.factor,"PPT test completed?" = pptcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmpptremr1val,"conditioned pain modulation PPT:rep2"=cpmpptremr2val,
         "conditioned pain modulation PPT:rep3"=cpmpptremr3val,"ppt remote rep1"= pptremoter1val,"ppt remote rep2"= pptremoter2val,"ppt remote rep3"= pptremoter3val) 


#change  to as.character for merging
m1tcmp.outcome [] <- lapply(m1tcmp.outcome , as.character)
m1tcpm.final[] <- lapply(m1tcpm.final, as.character)

#merge all cmp errors

m1tall.cmp <-  full_join(m1tcmp.outcome ,m1tcpm.final ,by = intersect(names(m1tcmp.outcome), names(m1tcpm.final))) %>% 
  relocate("record_id", "redcap_event_name","cpm test completed","PPT test completed?","ppt remote rep1","ppt remote rep2",   
           "ppt remote rep3","conditioned pain modulation PPT:rep1", "conditioned pain modulation PPT:rep1(double entry)",             
           "conditioned pain modulation PPT:rep2","conditioned pain modulation PPT:rep2(double entry)","conditioned pain modulation PPT:rep3",      "conditioned pain modulation PPT:rep3(double entry)","confirm water temp","water bath duration","Cold Water Pain Rating at 30 sec","Cold Water Pain Rating at 30 sec(double entry)","Cold Water Pain Rating at 60 sec","Cold Water Pain Rating at 60 sec(double entry)") %>% 
  arrange(record_id)




m1tall.cmp[m1tall.cmp == ""] <- NA

m1tall.cmp <- m1tall.cmp %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#fetch notes

m1tcmp_notes <- qdatam1t %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,cpmnotes) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes

m1tcpm_shrink_notes  <- left_join(m1tall.cmp,m1tcmp_notes,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  relocate(redcap_data_access_group,.after = redcap_event_name )





#link with imaging data

m1tqst.img <- m1tirimaging



# select needed variables
m1tdata.image1 <- m1tqst.img %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcontrarecal.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl,fmricuffipyn.factor,fmricuffcompletescl.factor)


m1tdata.qst <-  qdatam1t %>%
  select(record_id,redcap_event_name,redcap_data_access_group,cuffpfmricontraindyn.factor,cuffpfmricontrainddomyn,cuffpfmripressure,cuffpfmripressure_d,qst_mcc1_v03_complete)



# change  to as.character for merging
m1tdata.image1 [] <- lapply(m1tdata.image1 , as.character)
m1tdata.qst[] <- lapply(m1tdata.qst, as.character)

#merge both
m1tqst.image <-  full_join(m1tdata.image1 ,m1tdata.qst ,by = intersect(names(m1tdata.image1), names(m1tdata.qst)))



#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging



m1tqst.image1 <- m1tqst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(cuffpfmripressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_data_access_group,redcap_event_name,fmricuffipyn.factor,fmricuffcompletescl.factor,cuffpfmricontraindyn.factor,cuffpfmricontrainddomyn,fmricuffcontrarecal.factor,cuffpfmripressure,cuffpfmripressure_d,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  mutate(cuffpfmricontraindyn.factor = case_when(is.na(cuffpfmricontraindyn.factor) ~ "missing",TRUE ~ as.character(cuffpfmricontraindyn.factor)))%>% 
  mutate(cuffpfmricontrainddomyn = case_when(is.na(cuffpfmricontrainddomyn) ~ "missing",TRUE ~ as.character(cuffpfmricontrainddomyn)))%>% 
  mutate(fmricuffcontrarecal.factor = case_when(is.na(fmricuffcontrarecal.factor) ~ "missing",TRUE ~ as.character(fmricuffcontrarecal.factor) )) %>% 
  mutate(cuffpfmripressure = case_when(is.na(cuffpfmripressure) ~ "missing",TRUE ~ as.character(cuffpfmripressure) )) %>% 
  mutate(cuffpfmripressure_d = case_when(is.na(cuffpfmripressure_d) ~ "missing",TRUE ~ as.character(cuffpfmripressure_d) )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal) )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2) )) %>%
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  rename ("qst cuff prssure C/I"=cuffpfmricontraindyn.factor,"image:Re-calibration of pressure needed:"=fmricuffcontrarecal.factor,"qst pressure1"=cuffpfmripressure,"qst pressure(double)"=cuffpfmripressure_d,"imaging recal pressure"=fmricuffcalfpressurerecal,"imaging recal pressure(double)"=fmricuffcalfpressurerecal2, "imaging_fMRI individualized pressure"=fmricuffipyn.factor,"Test Completed:"=fmricuffcompletescl.factor)


#create final mcc2 qst table for the app 

m1tdma_shrink_notes1 <- m1tdma_shrink_notes %>% 
  add_column(QST_test = "MCC1_Dynamic_mechanical_allodynia")

m1tppt_shrink_notes1 <- m1tppt_shrink_notes %>% 
  add_column(QST_test = "MCC1_PPT") 

m1tts_shrink_notes1 <- m1tts_shrink_notes %>% 
  add_column(QST_test = "MCC1_Temporal_Summation") 

m1tqst.image2 <- m1tqst.image1 %>%   
  add_column(QST_test = "MCC1_No_Recal_pressure")

m1tcpm_shrink_notes1 <- m1tcpm_shrink_notes %>% 
  add_column(QST_test = "MCC1_Conditioned_Pain_Modulation")






m1ttrqst_table <- full_join(m1tdma_shrink_notes1,m1tppt_shrink_notes1,by = intersect(names(m1tdma_shrink_notes1), names(m1tppt_shrink_notes1
)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m1ttrqst_table1 <- full_join(m1ttrqst_table,m1tts_shrink_notes1,by = intersect(names(m1ttrqst_table), names(m1tts_shrink_notes1)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m1ttrqst_table2 <- full_join(m1ttrqst_table1,m1tcpm_shrink_notes1,by = intersect(names(m1ttrqst_table1), names(m1tcpm_shrink_notes1)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m1ttr_final_image <-  full_join(m1ttrqst_table2,m1tqst.image2,by = intersect(names(m1ttrqst_table2), names(m1tqst.image2))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group)) %>% 
  relocate(QST_test, .after = last_col()) %>% 
  mutate(QST_test=as.factor(QST_test)) %>% 
  left_join(.,m1tdays_from_sysdate, by=c("record_id","redcap_event_name"))



########## mcc2 knee REPORTS#######

datam2k <- datam2k1 %>% 
  filter(!record_id %in% withdrawm2k$record_id) %>% 
  filter(!record_id %in% test_records) %>% 
  select(-sleepnighthourmindurhrs,-sleepnighthourmindurmins,-sleepnighthourmindur) 



# event <- c("baseline_visit_arm_1","6wks_postop_arm_1",	
#            "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")
# data <- data1 %>% 
#   filter(redcap_event_name %in% event)



#Read Data mcc2 knee functional

frfuncm2k  <- retype(datam2k) 
#Setting Labels

label(frfuncm2k$record_id)="Record ID"
label(frfuncm2k$redcap_event_name)="Event Name"
label(frfuncm2k$walk10initialpainscl)="Initial Pain Rating:"
label(frfuncm2k$walk10initialpainscl1)="Initial Pain Rating: (double enfry)"
label(frfuncm2k$walk10finalpainscl)="Final Pain Rating:"
label(frfuncm2k$walk10finalpainscl1)="Final Pain Rating: (double enfry)"
label(frfuncm2k$walk10time)="Time:"
label(frfuncm2k$walk10time1)="Time: (double enfry)"
label(frfuncm2k$walk10completeyn)="Test completed:"
label(frfuncm2k$walk10incompletereason)="If no, reason why?"
label(frfuncm2k$walk10assistyn)="Any assistance used (personal and/or device):"
label(frfuncm2k$walk10assist_cane___1)=" (choice=Cane (all types))"
label(frfuncm2k$walk10assist_crutch___1)=" (choice=Crutches (1 or 2, any gait pattern))"
label(frfuncm2k$walk10assist_walkder___1)=" (choice=Walker (all types))"
label(frfuncm2k$walk10assist_perssuppt___1)=" (choice=Personal assistance (any type of hands-on assistance or support during task, even if only briefly or for balance))"
label(frfuncm2k$walk10assist_other___1)=" (choice=Other)"
label(frfuncm2k$walk10comments)="Additional notes for 10m walk"
label(frfuncm2k$tstsbpscreen)="Blood Pressure Screening:"
label(frfuncm2k$tstsprepainscl)="Initial Pain Rating:"
label(frfuncm2k$tstsprepainscl1)="Initial Pain Rating: (double enfry)"
label(frfuncm2k$tstspostpainscl)="Final Pain Rating:"
label(frfuncm2k$tstspostpainscl1)="Final Pain Rating: (double enfry)"
label(frfuncm2k$tststime)="Time:"
label(frfuncm2k$tststime1)="Time: (double enfry)"
label(frfuncm2k$tstscompleteyn)="Test completed:"
label(frfuncm2k$tstsnonreasonyn)="If no, reason why?"
label(frfuncm2k$tstsnumbrepsyn)="# of reps completed"
label(frfuncm2k$tstsassistyn)="Any assistance used (personal and/or chair):"
label(frfuncm2k$tstsassist_1___1)=" (choice=push-off from arms of chair or use of assistive device)"
label(frfuncm2k$tstsassist_2___1)=" (choice=personal assistance (any type of hands-on assistance or support during task, even if only briefly or for balance))"
label(frfuncm2k$tstsaddnotes)="Additional notes for 5 Times Sit-to-Stand Test:"
label(frfuncm2k$functional_testing_complete)="Complete?"
#Setting Units





#Setting Factors(will create new variable for factors)
frfuncm2k$redcap_event_name.factor = factor(frfuncm2k$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
frfuncm2k$walk10initialpainscl.factor = factor(frfuncm2k$walk10initialpainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$walk10initialpainscl1.factor = factor(frfuncm2k$walk10initialpainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$walk10finalpainscl.factor = factor(frfuncm2k$walk10finalpainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$walk10finalpainscl1.factor = factor(frfuncm2k$walk10finalpainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$walk10completeyn.factor = factor(frfuncm2k$walk10completeyn,levels=c("1","0"))
frfuncm2k$walk10incompletereason.factor = factor(frfuncm2k$walk10incompletereason,levels=c("1","2","3"))
frfuncm2k$walk10assistyn.factor = factor(frfuncm2k$walk10assistyn,levels=c("1","0"))
frfuncm2k$walk10assist_cane___1.factor = factor(frfuncm2k$walk10assist_cane___1,levels=c("0","1"))
frfuncm2k$walk10assist_crutch___1.factor = factor(frfuncm2k$walk10assist_crutch___1,levels=c("0","1"))
frfuncm2k$walk10assist_walkder___1.factor = factor(frfuncm2k$walk10assist_walkder___1,levels=c("0","1"))
frfuncm2k$walk10assist_perssuppt___1.factor = factor(frfuncm2k$walk10assist_perssuppt___1,levels=c("0","1"))
frfuncm2k$walk10assist_other___1.factor = factor(frfuncm2k$walk10assist_other___1,levels=c("0","1"))
frfuncm2k$tstsbpscreen.factor = factor(frfuncm2k$tstsbpscreen,levels=c("1","2"))
frfuncm2k$tstsprepainscl.factor = factor(frfuncm2k$tstsprepainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$tstsprepainscl1.factor = factor(frfuncm2k$tstsprepainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$tstspostpainscl.factor = factor(frfuncm2k$tstspostpainscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$tstspostpainscl1.factor = factor(frfuncm2k$tstspostpainscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
frfuncm2k$tstscompleteyn.factor = factor(frfuncm2k$tstscompleteyn,levels=c("1","0"))
frfuncm2k$tstsnonreasonyn.factor = factor(frfuncm2k$tstsnonreasonyn,levels=c("0","1","2"))
frfuncm2k$tstsnumbrepsyn.factor = factor(frfuncm2k$tstsnumbrepsyn,levels=c("0","1","2","3","4"))
frfuncm2k$tstsassistyn.factor = factor(frfuncm2k$tstsassistyn,levels=c("1","0"))
frfuncm2k$tstsassist_1___1.factor = factor(frfuncm2k$tstsassist_1___1,levels=c("0","1"))
frfuncm2k$tstsassist_2___1.factor = factor(frfuncm2k$tstsassist_2___1,levels=c("0","1"))
frfuncm2k$functional_testing_complete.factor = factor(frfuncm2k$functional_testing_complete,levels=c("0","1","2"))

levels(frfuncm2k$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(frfuncm2k$walk10initialpainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$walk10initialpainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$walk10finalpainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$walk10finalpainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$walk10completeyn.factor)=c("Yes","No")
levels(frfuncm2k$walk10incompletereason.factor)=c("Did not attempt","Initiated but unable to complete","Other")
levels(frfuncm2k$walk10assistyn.factor)=c("Yes","No")
levels(frfuncm2k$walk10assist_cane___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$walk10assist_crutch___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$walk10assist_walkder___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$walk10assist_perssuppt___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$walk10assist_other___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$tstsbpscreen.factor)=c("Within study range (90/60 to 160/90 mmHg)","Out of study range (< 90/60 OR > 160/90 mmHg)")
levels(frfuncm2k$tstsprepainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$tstsprepainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$tstspostpainscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$tstspostpainscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(frfuncm2k$tstscompleteyn.factor)=c("Yes","No")
levels(frfuncm2k$tstsnonreasonyn.factor)=c("Did not attempt: Participant declined or deemed unsafe","Initiated, but subject unable to complete (indicate # of reps completed below)","Other")
levels(frfuncm2k$tstsnumbrepsyn.factor)=c("0","1","2","3","4")
levels(frfuncm2k$tstsassistyn.factor)=c("Yes","No")
levels(frfuncm2k$tstsassist_1___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$tstsassist_2___1.factor)=c("Unchecked","Checked")
levels(frfuncm2k$functional_testing_complete.factor)=c("Incomplete","Unverified","Complete")

#########################################################################################











table(frfuncm2k$walk10completeyn, exclude = NULL)


#keep records for subjects who completed the test.
m2kfrdata3 <- frfuncm2k %>% 
  filter(walk10completeyn == 1 & functional_testing_complete == 2)

table(m2kfrdata3$walk10completeyn, exclude = NULL)






#look for discrepancies in the first and the second initial pain rating 
m2kfrdata4 <- m2kfrdata3 %>% 
  mutate(init_pain_diff = walk10initialpainscl - walk10initialpainscl1) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

m2kferror1 <- m2kfrdata4 %>% 
  select(record_id,redcap_event_name,walk10initialpainscl,walk10initialpainscl1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10initialpainscl = case_when(is.na(walk10initialpainscl) ~ "missing",TRUE ~ as.character(walk10initialpainscl))) %>% 
  mutate(walk10initialpainscl1 = case_when(is.na(walk10initialpainscl1) ~ "missing",TRUE ~ as.character(walk10initialpainscl1) ))







#look for discrepancies between the first and the second final pain rating 
m2kfrdata5 <- m2kfrdata3 %>% 
  mutate(final_pain_diff = walk10finalpainscl - walk10finalpainscl1) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff))

m2kferror2 <- m2kfrdata5 %>% 
  select(record_id,redcap_event_name,walk10finalpainscl,walk10finalpainscl1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10finalpainscl = case_when(is.na(walk10finalpainscl) ~ "missing",TRUE ~ as.character(walk10finalpainscl))) %>% 
  mutate(walk10finalpainscl1 = case_when(is.na(walk10finalpainscl1) ~ "missing",TRUE ~ as.character(walk10finalpainscl1)))


m2kferror1_2 <- full_join(m2kferror1,m2kferror2,by = intersect(names(m2kferror1), names(m2kferror2)))





#look for discrepancies between the first and the second walk time 
m2kfrdata6 <- m2kfrdata3 %>% 
  retype() %>% 
  mutate(walk_time_diff = walk10time - walk10time1) %>% 
  filter(walk_time_diff != 0 | is.na(walk_time_diff))

m2kferror3 <- m2kfrdata6 %>% 
  select(record_id,redcap_event_name,walk10time,walk10time1)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10time = case_when(is.na(walk10time) ~ "missing",TRUE ~ as.character(walk10time))) %>% 
  mutate(walk10time1 = case_when(is.na(walk10time1) ~ "missing",TRUE ~ as.character(walk10time1)))



m2kferror1_2 <- m2kferror1_2 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferror3 <- m2kferror3 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferror1_2_3 <- full_join(m2kferror1_2,m2kferror3,by = intersect(names(m2kferror1_2), names(m2kferror3)))






# check if a reason for test not completed was marked off



m2kfrdata7 <- frfuncm2k  %>% 
  filter(walk10completeyn == 0) %>%
  filter(is.na(walk10incompletereason))

m2kferror4 <- m2kfrdata7 %>% 
  select(record_id,redcap_event_name,walk10incompletereason,walk10completeyn.factor) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10incompletereason = case_when(is.na(walk10incompletereason) ~ "missing",TRUE ~ as.character(walk10incompletereason)))



m2kferror1_2_3 <- m2kferror1_2_3 %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2kferror4 <- m2kferror4  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferror1_2_3_4 <- full_join(m2kferror1_2_3,m2kferror4,by = intersect(names(m2kferror1_2_3), names(m2kferror4)))







#if walk was completed, check for records with missing values for any assistance 

m2kferror5 <- m2kfrdata3 %>% 
  filter(walk10completeyn == 1) %>% 
  filter(is.na(walk10assistyn)) %>% 
  select(record_id,redcap_event_name,walk10completeyn.factor,walk10assistyn)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10assistyn = case_when(is.na(walk10assistyn) ~ "missing",TRUE ~ as.character(walk10assistyn)))


m2kferror5 <- m2kferror5 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferror1_2_3_4_5 <- full_join(m2kferror1_2_3_4,m2kferror5,by = intersect(names(m2kferror1_2_3_4), names(m2kferror5)))





#if any assistance during walk test was checked off, check for records with unchecked type of assistance 

m2kferror6 <- m2kfrdata3 %>% 
  filter(walk10assistyn == 1) %>% 
  filter(walk10assist_cane___1 == 0 & walk10assist_crutch___1 == 0 & walk10assist_perssuppt___1 == 0 & walk10assist_other___1 == 0 & walk10assist_walkder___1 == 0) %>% 
  select(record_id,redcap_event_name,walk10assistyn.factor,walk10assist_cane___1.factor,walk10assist_crutch___1.factor,walk10assist_perssuppt___1.factor, walk10assist_other___1.factor,walk10assist_walkder___1.factor) 



m2kferror6 <- m2kferror6 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferror1_2_3_4_5_6 <- full_join(m2kferror1_2_3_4_5,m2kferror6,by = intersect(names(m2kferror1_2_3_4_5), names(m2kferror6)))






### 5 times sit to stand test#####




#Check for subjects who did not complete the test.
table(frfuncm2k$tstscompleteyn, exclude = NULL)




#remove records with missing values for test completed.
m2kfrdata.sit <- frfuncm2k %>% 
  drop_na(tstscompleteyn)




#Recheck if all records with missing frdata for completed tests were removed.
table(m2kfrdata.sit$tstscompleteyn, exclude = NULL)




#check for missing bp values if tsts was completed

m2kferror.bp <- m2kfrdata.sit %>% 
  filter(tstscompleteyn == 1 &  is.na(tstsbpscreen) ) %>% 
  select(record_id,redcap_event_name,tstsbpscreen)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2kferror.bp$tstsbpscreen <- m2kferror.bp$tstsbpscreen %>% replace_na("missing")




#keep records for subjects who completed the test.
m2kfrdata.sit1 <- m2kfrdata.sit %>% 
  filter(tstscompleteyn == 1 & functional_testing_complete == 2)





#look for discrepancies in the first and the second initial pain rating 
m2kfrdata.sit4 <- m2kfrdata.sit1 %>% 
  mutate(init_pain_diff.sit = tstsprepainscl - tstsprepainscl1) %>% 
  filter(init_pain_diff.sit != 0 | is.na(init_pain_diff.sit))

m2kferror1.sit <- m2kfrdata.sit4 %>% 
  select(record_id,redcap_event_name,tstsprepainscl,tstsprepainscl1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsprepainscl = case_when(is.na(tstsprepainscl) ~ "missing",TRUE ~ as.character(tstsprepainscl)))%>% 
  mutate(tstsprepainscl1 = case_when(is.na(tstsprepainscl1) ~ "missing",TRUE ~ as.character(tstsprepainscl1)))



#look for discrepancies between the first and the second final pain rating 
m2kfrdata.sit5 <- m2kfrdata.sit1 %>% 
  mutate(final_pain_diff.sit = tstspostpainscl - tstspostpainscl1) %>% 
  filter(final_pain_diff.sit != 0 | is.na(final_pain_diff.sit))

m2kferror2.sit <- m2kfrdata.sit5 %>% 
  select(record_id,redcap_event_name,tstspostpainscl,tstspostpainscl1)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstspostpainscl = case_when(is.na(tstspostpainscl) ~ "missing",TRUE ~ as.character(tstspostpainscl)))%>% 
  mutate(tstspostpainscl1 = case_when(is.na(tstspostpainscl1) ~ "missing",TRUE ~ as.character(tstspostpainscl1)))


m2kferrorsit1_2 <- full_join(m2kferror1.sit,m2kferror2.sit,by = intersect(names(m2kferror1.sit), names(m2kferror2.sit)))




#look for discrepancies between the first and the second activity  time 
m2kfrdata.sit6 <- m2kfrdata.sit1 %>% 
  retype() %>% 
  mutate(sit_time_diff = tststime - tststime1) %>% 
  filter(sit_time_diff != 0 | is.na(sit_time_diff))

m2kferror3.sit <- m2kfrdata.sit6 %>% 
  select(record_id,redcap_event_name,tststime,tststime1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tststime = case_when(is.na(tststime) ~ "missing",TRUE ~ as.character(tststime)))%>% 
  mutate(tststime1 = case_when(is.na(tststime1) ~ "missing",TRUE ~ as.character(tststime1)))



m2kferrorsit1_2_3 <- full_join(m2kferrorsit1_2,m2kferror3.sit,by = intersect(names(m2kferrorsit1_2), names(m2kferror3.sit)))




# check if a reason for test not completed was marked off


m2kfrdata.sit7 <- m2kfrdata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(is.na(tstsnonreasonyn))

m2kferror4.sit <- m2kfrdata.sit7 %>% 
  select(record_id,redcap_event_name,tstscompleteyn.factor,tstsnonreasonyn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnonreasonyn = case_when(is.na(tstsnonreasonyn) ~ "missing",TRUE ~ as.character(tstsnonreasonyn))) # recode NA to missing or leave as is



m2kferrorsit1_2_3 <- m2kferrorsit1_2_3 %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2kferror4.sit <- m2kferror4.sit %>%
  as_tibble() %>% 
  mutate_all(as.character)


m2kferrorsit1_2_3_4 <- full_join(m2kferrorsit1_2_3,m2kferror4.sit,by = intersect(names(m2kferrorsit1_2_3), names(m2kferror4.sit)))





#check if test was not completed but was Initiated, and the number of reps completed (n/5) were not specified)
m2kfrdata.sit8 <- m2kfrdata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(tstsnonreasonyn == 1) %>% 
  filter(is.na(tstsnumbrepsyn))

m2kferror5.sit <- m2kfrdata.sit8 %>% 
  select(record_id,redcap_event_name,tstscompleteyn.factor,tstsnonreasonyn.factor,tstsnumbrepsyn)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnumbrepsyn = case_when(is.na(tstsnumbrepsyn) ~ "missing",TRUE ~ as.character(tstsnumbrepsyn))) # recode NA to missing or leave as is

m2kferror1_2_3_4 <- m2kferror1_2_3_4 %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferror5.sit <- m2kferror5.sit %>% 
  as_tibble() %>% 
  mutate_all(as.character)

###############################

m2kferrorsit1_2_3_4_5 <- full_join(m2kferrorsit1_2_3_4,m2kferror5.sit,by = intersect(names(m2kferrorsit1_2_3_4), names(m2kferror5.sit)))




# check for records with missing values for any assistance if test was completed

m2kferror6.sit <- m2kfrdata.sit1 %>% 
  filter(tstscompleteyn == 1) %>% 
  filter(is.na(tstsassistyn.factor)) %>% 
  select(record_id,redcap_event_name,tstscompleteyn.factor,tstsassistyn.factor)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsassistyn.factor = case_when(is.na(tstsassistyn.factor) ~ "missing",TRUE ~ as.character(tstsassistyn.factor))) # recode NA to missing or leave as is



m2kferror6.sit <- m2kferror6.sit %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kferrorsit1_2_3_4_5_6 <- full_join(m2kferrorsit1_2_3_4_5,m2kferror6.sit,by = intersect(names(m2kferrorsit1_2_3_4_5), names(m2kferror6.sit)))




# check for records with 0 for type of assistance if walk any assistance was checked off

m2kferror7.sit <- m2kfrdata.sit1 %>% 
  filter(tstsassistyn == 1) %>% 
  filter(tstsassist_1___1 == 0 & tstsassist_2___1 == 0) %>% 
  select(record_id,redcap_event_name,tstsassistyn.factor,tstsassist_1___1.factor,tstsassist_2___1.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2kferrorsit1_2_3_4_5_6_7 <- full_join(m2kferrorsit1_2_3_4_5_6,m2kferror7.sit,by = intersect(names(m2kferrorsit1_2_3_4_5_6), names(m2kferror7.sit)))

m2kferrorsit1_2_3_4_5_6_7_bp <- full_join(m2kferrorsit1_2_3_4_5_6_7,m2kferror.bp,by = intersect(names(m2kferrorsit1_2_3_4_5_6_7), names(m2kferror.bp)))



#c0nvert record ids to as.character

#10min walk test ferrors
m2kferror1 <-  m2kferror1 %>% 
  as_tibble() %>% 
  mutate_all(as.character)
m2kferror2  <-  m2kferror2   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
m2kferror3  <-  m2kferror3   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
m2kferror4  <-  m2kferror4   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
m2kferror5  <-  m2kferror5   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
m2kferror6  <-  m2kferror6   %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#tsts test
m2kferror1.sit  <-  m2kferror1.sit   %>% 
  as_tibble() %>% 
  mutate_all(as.character)
m2kferror2.sit  <-  m2kferror2.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
m2kferror3.sit  <-  m2kferror3.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
m2kferror4.sit  <-  m2kferror4.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
m2kferror5.sit  <-  m2kferror5.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
m2kferror6.sit  <-  m2kferror6.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
m2kferror7.sit  <-  m2kferror7.sit  %>% 
  as_tibble() %>% 
  mutate_all(as.character)  
m2kferror.bp  <-  m2kferror.bp   %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2klist.func <- full_join(m2kferror1,m2kferror2,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror3,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror4,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror5,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror6,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror1.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror2.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror3.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror4.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror5.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror6.sit,by=c("record_id","redcap_event_name"))%>% 
  full_join(.,m2kferror7.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kferror.bp,by=c("record_id","redcap_event_name")) 






#fetch notes

m2kfrnotes.walk <- frfuncm2k %>% 
  select(record_id,redcap_event_name,walk10comments,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kfrnotes.tsts <- frfuncm2k %>% 
  select(record_id,redcap_event_name,tstsaddnotes,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# create table for walk test

m2kfrwalk <- m2kferror1_2_3_4_5_6 %>% 
  select(c(record_id,redcap_event_name,walk10initialpainscl,walk10initialpainscl1,
           walk10finalpainscl,walk10finalpainscl1,walk10time,walk10time1,walk10completeyn.factor,
           walk10incompletereason,walk10assistyn.factor,walk10assist_cane___1.factor,walk10assist_crutch___1.factor,
           walk10assist_walkder___1.factor,walk10assist_perssuppt___1.factor,walk10assist_other___1.factor))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#create table for tsts test

m2kfrtsts <- m2kferrorsit1_2_3_4_5_6_7_bp %>% 
  select(c(record_id,redcap_event_name,tstsprepainscl,
           tstsprepainscl1,tstspostpainscl,tstspostpainscl1,tststime,tststime1  ,
           tstscompleteyn.factor, tstsnonreasonyn,tstsnumbrepsyn,tstsassistyn.factor,
           tstsassist_1___1.factor,tstsassist_2___1.factor,tstsbpscreen )) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#ensure each combination of ID and redcap event has one row with all values and is not duplicated
m2kfrwalk[m2kfrwalk== ""] <- NA
m2kfrwalk1 <- m2kfrwalk  %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# now add notes
#walk with notes

m2kfrwalk1_notes <- left_join(m2kfrwalk1,m2kfrnotes.walk,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated
m2kfrtsts[m2kfrtsts== ""] <- NA
m2kfrtsts1 <- m2kfrtsts %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#tsts with notes
# tsts1[] <- lapply(tsts1, as.character)
# notes.tsts[] <- lapply(notes.tsts, as.character)

m2kfrtsts_notes <- left_join(m2kfrtsts1,m2kfrnotes.tsts,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#create final table

m2kfrfunc_table <- full_join(m2kfrwalk1_notes,m2kfrtsts_notes,by = intersect(names(m2kfrwalk1_notes), names(m2kfrtsts_notes))) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kfrfunc_table[m2kfrfunc_table== ""] <- NA
m2kfrfunc_table <-  m2kfrfunc_table %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  relocate(tstsaddnotes,.after = last_col()) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  left_join(.,m2kdays_from_sysdate, by=c("record_id","redcap_event_name"))


#########################
##### mcc2 knee  imaging ########
#########################

#####imaging report########

#Read Data
m2kirimaging <-  datam2k


#Setting Labels


label( m2kirimaging$record_id)="Record ID"
label( m2kirimaging$redcap_event_name)="Event Name"
label( m2kirimaging$fmricuff_initials)="Investigator initials:"
label( m2kirimaging$fmripatientname)="Verify Patient Name (as entered into scanner console):  Patient name: first name: followed by a 5-digit REDCap patient ID followed by < visit code>; last name: A2CPS Site code: NS for Northshore; UI for UIC; UC for U of Chicago; UM for U of Michigan Visit code: V1 for baseline visit; V3 for 3-month visit Example: NS10078V1 (first name) A2CPS (last name) "
label( m2kirimaging$fmricuffleg)="Cuff applied to R/L leg:(hint: MCC1: contralateral to surgical knee)"
label( m2kirimaging$fmricuffcontrarecal)="Re-calibration of pressure needed:"
label( m2kirimaging$fmricuffcalfpressurerecal)="Pressure 2:"
label( m2kirimaging$fmricuffcalfpressurerecal2)="Pressure 2: (double entry)"
label( m2kirimaging$fmricufft1techrating)="Please enter technologists quality rating for the T1 scan: "
label( m2kirimaging$fmricufft1repeated)="T1 scan repeated?"
label( m2kirimaging$fmricufft1techrating2)="Please enter technologists quality rating for the 2nd T1 scan: "
label( m2kirimaging$fmricuffrestpainss)="Surgical site pain"
label( m2kirimaging$fmricuffrestpainss2)="Surgical site pain (double entry)"
label( m2kirimaging$fmricuffrestpainovrall)="Body pain"
label( m2kirimaging$fmricuffrestpainovrall2)="Body pain (double entry)"
label( m2kirimaging$fmricuffcurrpainaftfirstscanss)="Surgical site pain"
label( m2kirimaging$fmricuffcurrpainaftfirstscanss2)="Surgical site pain (double entry)"
label( m2kirimaging$fmricuffcurrpainaftfirstscanovrall)="Body pain"
label( m2kirimaging$fmricuffcurrpainaftfirstscanovrall2)="Body pain (double entry)"
label( m2kirimaging$fmricuffcurrpainaftfirstscancp)="Cuff pain"
label( m2kirimaging$fmricuffcurrpainaftfirstscancp2)="Cuff pain (double entry)"
label( m2kirimaging$fmricuffpainbegin)="cuff pain (beginning)"
label( m2kirimaging$fmricuffpainbegin2)="cuff pain (beginning) (double entry)"
label( m2kirimaging$fmricuffpainmid)="cuff pain (middle)"
label( m2kirimaging$fmricuffpainmid2)="cuff pain (middle) (double entry)"
label( m2kirimaging$fmricuffpainend)="cuff pain (end)"
label( m2kirimaging$fmricuffpainend2)="cuff pain (end) (double entry)"
label( m2kirimaging$fmricuffpaincpbegin)="cuff pain (beginning)"
label( m2kirimaging$fmricuffpaincpbegin2)="cuff pain (beginning) (double entry)"
label( m2kirimaging$fmricuffpaincpmid)="cuff pain (middle)"
label( m2kirimaging$fmricuffpaincpmid2)="cuff pain (middle) (double entry)"
label( m2kirimaging$fmricuffpaincpend)="cuff pain (end)"
label( m2kirimaging$fmricuffpaincpend2)="cuff pain (end) (double entry)"
label( m2kirimaging$fmricuffpainrestscanbegin)="cuff pain (beginning)"
label( m2kirimaging$fmricuffpainrestscanbegin2)="cuff pain (beginning) (double entry)"
label( m2kirimaging$fmricuffpainrestscanmid)="cuff pain (middle)"
label( m2kirimaging$fmricuffpainrestscanmid2)="cuff pain (middle) (double entry)"
label( m2kirimaging$fmricuffpainrestscanend)="cuff pain (end)"
label( m2kirimaging$fmricuffpainrestscanend2)="cuff pain (end) (double entry)"
label( m2kirimaging$fmricuffpainaftlastscanss)="Surgical site pain"
label( m2kirimaging$fmricuffpainaftlastscanss2)="Surgical site pain (double entry)"
label( m2kirimaging$fmricuffpainaftlastscanany)="Body pain"
label( m2kirimaging$fmricuffpainaftlastscanany2)="Body pain (double entry)"
label( m2kirimaging$fmricuffcompletescl)="Test Completed:"
label( m2kirimaging$fmricufft1yn)="T1"
label( m2kirimaging$fmricuffdwiyn)="DWI"
label( m2kirimaging$fmricuffrest1yn)="1rst Resting state"
label( m2kirimaging$fmricuffipyn)="fMRI individualized pressure"
label( m2kirimaging$fmricuffcpyn)="fMRI standard pressure"
label( m2kirimaging$fmricuffrest2yn)="2nd Resting state"
label( m2kirimaging$fmricuffdicuploaded)="Dicom files uploaded to TACC:"
label( m2kirimaging$fmricuffdicupdate)="Upload date/time"
label( m2kirimaging$fmricuffnotes)="Additional notes for  m2kirimaging"
label( m2kirimaging$imaging_mcc1_v09_complete)="Complete?"




#Setting Units


#Setting Factors(will create new variable for factors)
m2kirimaging$redcap_event_name.factor = factor(   m2kirimaging$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m2kirimaging$fmricuffleg.factor = factor(   m2kirimaging$fmricuffleg,levels=c("1","2"))
m2kirimaging$fmricuffcontrarecal.factor = factor(   m2kirimaging$fmricuffcontrarecal,levels=c("1","0"))
m2kirimaging$fmricufft1techrating.factor = factor(   m2kirimaging$fmricufft1techrating,levels=c("3","2","1"))
m2kirimaging$fmricufft1repeated.factor = factor(   m2kirimaging$fmricufft1repeated,levels=c("1","0"))
m2kirimaging$fmricufft1techrating2.factor = factor(   m2kirimaging$fmricufft1techrating2,levels=c("3","2","1"))
m2kirimaging$fmricuffrestpainss.factor = factor(   m2kirimaging$fmricuffrestpainss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffrestpainss2.factor = factor(   m2kirimaging$fmricuffrestpainss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffrestpainovrall.factor = factor(   m2kirimaging$fmricuffrestpainovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffrestpainovrall2.factor = factor(   m2kirimaging$fmricuffrestpainovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcurrpainaftfirstscanss.factor = factor(   m2kirimaging$fmricuffcurrpainaftfirstscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcurrpainaftfirstscanss2.factor = factor(   m2kirimaging$fmricuffcurrpainaftfirstscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcurrpainaftfirstscanovrall.factor = factor(   m2kirimaging$fmricuffcurrpainaftfirstscanovrall,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcurrpainaftfirstscanovrall2.factor = factor(   m2kirimaging$fmricuffcurrpainaftfirstscanovrall2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcurrpainaftfirstscancp.factor = factor(   m2kirimaging$fmricuffcurrpainaftfirstscancp,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcurrpainaftfirstscancp2.factor = factor(   m2kirimaging$fmricuffcurrpainaftfirstscancp2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainbegin.factor = factor(   m2kirimaging$fmricuffpainbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainbegin2.factor = factor(   m2kirimaging$fmricuffpainbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainmid.factor = factor(   m2kirimaging$fmricuffpainmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainmid2.factor = factor(   m2kirimaging$fmricuffpainmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainend.factor = factor(   m2kirimaging$fmricuffpainend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainend2.factor = factor(   m2kirimaging$fmricuffpainend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpaincpbegin.factor = factor(   m2kirimaging$fmricuffpaincpbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpaincpbegin2.factor = factor(   m2kirimaging$fmricuffpaincpbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpaincpmid.factor = factor(   m2kirimaging$fmricuffpaincpmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpaincpmid2.factor = factor(   m2kirimaging$fmricuffpaincpmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpaincpend.factor = factor(   m2kirimaging$fmricuffpaincpend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpaincpend2.factor = factor(   m2kirimaging$fmricuffpaincpend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainrestscanbegin.factor = factor(   m2kirimaging$fmricuffpainrestscanbegin,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainrestscanbegin2.factor = factor(   m2kirimaging$fmricuffpainrestscanbegin2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainrestscanmid.factor = factor(   m2kirimaging$fmricuffpainrestscanmid,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainrestscanmid2.factor = factor(   m2kirimaging$fmricuffpainrestscanmid2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainrestscanend.factor = factor(   m2kirimaging$fmricuffpainrestscanend,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainrestscanend2.factor = factor(   m2kirimaging$fmricuffpainrestscanend2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainaftlastscanss.factor = factor(   m2kirimaging$fmricuffpainaftlastscanss,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainaftlastscanss2.factor = factor(   m2kirimaging$fmricuffpainaftlastscanss2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainaftlastscanany.factor = factor(   m2kirimaging$fmricuffpainaftlastscanany,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffpainaftlastscanany2.factor = factor(   m2kirimaging$fmricuffpainaftlastscanany2,levels=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0"))
m2kirimaging$fmricuffcompletescl.factor = factor(   m2kirimaging$fmricuffcompletescl,levels=c("1","2","0"))
m2kirimaging$fmricufft1yn.factor = factor(   m2kirimaging$fmricufft1yn,levels=c("1","0"))
m2kirimaging$fmricuffdwiyn.factor = factor(   m2kirimaging$fmricuffdwiyn,levels=c("1","0"))
m2kirimaging$fmricuffrest1yn.factor = factor(   m2kirimaging$fmricuffrest1yn,levels=c("1","0"))
m2kirimaging$fmricuffipyn.factor = factor(   m2kirimaging$fmricuffipyn,levels=c("1","0"))
m2kirimaging$fmricuffcpyn.factor = factor(   m2kirimaging$fmricuffcpyn,levels=c("1","0"))
m2kirimaging$fmricuffrest2yn.factor = factor(   m2kirimaging$fmricuffrest2yn,levels=c("1","0"))
m2kirimaging$fmricuffdicuploaded.factor = factor(   m2kirimaging$fmricuffdicuploaded,levels=c("1","0"))
m2kirimaging$imaging_mcc1_v09_complete.factor = factor(m2kirimaging$imaging_mcc1_v09_complete,levels=c("0","1","2"))

levels( m2kirimaging$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels( m2kirimaging$fmricuffleg.factor)=c("Right","Left")
levels( m2kirimaging$fmricuffcontrarecal.factor)=c("Yes","No")
levels( m2kirimaging$fmricufft1techrating.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels( m2kirimaging$fmricufft1repeated.factor)=c("Yes","No")
levels( m2kirimaging$fmricufft1techrating2.factor)=c("Green - good, Class 3","Yellow - borderline, Class 2","Red - unusable, Class 1")
levels( m2kirimaging$fmricuffrestpainss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffrestpainss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffrestpainovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffrestpainovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcurrpainaftfirstscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcurrpainaftfirstscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcurrpainaftfirstscanovrall.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcurrpainaftfirstscanovrall2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcurrpainaftfirstscancp.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcurrpainaftfirstscancp2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpaincpbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpaincpbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpaincpmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpaincpmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpaincpend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpaincpend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainrestscanbegin.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainrestscanbegin2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainrestscanmid.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainrestscanmid2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainrestscanend.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainrestscanend2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainaftlastscanss.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainaftlastscanss2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainaftlastscanany.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffpainaftlastscanany2.factor)=c("0.0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10.0")
levels( m2kirimaging$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
levels( m2kirimaging$fmricufft1yn.factor)=c("Yes","No")
levels( m2kirimaging$fmricuffdwiyn.factor)=c("Yes","No")
levels( m2kirimaging$fmricuffrest1yn.factor)=c("Yes","No")
levels( m2kirimaging$fmricuffipyn.factor)=c("Yes","No")
levels( m2kirimaging$fmricuffcpyn.factor)=c("Yes","No")
levels( m2kirimaging$fmricuffrest2yn.factor)=c("Yes","No")
levels( m2kirimaging$fmricuffdicuploaded.factor)=c("Yes","No")
levels( m2kirimaging$imaging_mcc1_v09_complete.factor)=c("Incomplete","Unverified","Complete")









#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

m2kirdf.complete <- m2kirimaging%>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc1_v09_complete == 2)







#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure




m2kirerror1a <-m2kirdf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffcpyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) & fmricuffcontrayn != 1) %>% 
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffleg.factor,fmricuffcpyn.factor,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("fMRI individualized pressure" = fmricuffipyn.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"Test Completed"= fmricuffcompletescl.factor, "cuff applied to R/L leg"=fmricuffleg.factor ))%>% 
  mutate("cuff applied to R/L leg"=replace_na("missing")) 



# . For the UM site only, there are two scanners that could be used, and based on study protocol subjects 
#returning for "V3" scans should have them done on the same scanner as at "V1", check for same scanner within a subject

m2kirerror1b <- m2kirdf.complete %>%
  filter(redcap_data_access_group == "university_of_mich") %>% 
  select(record_id,redcap_event_name,fmri_magnet_name) %>% 
  group_by(record_id) %>%
  mutate(dummy = as.integer(n_distinct(fmri_magnet_name) == 1)) %>% 
  filter(dummy == 0) %>% 
  select(-dummy) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(fmri_name_mismatch = fmri_magnet_name) %>% 
  distinct(record_id, .keep_all = TRUE)


m2kirerror1.1 <- full_join(m2kirerror1a,m2kirerror1b,by = intersect(names(m2kirerror1a), names(m2kirerror1b)))


m2kirerror1c <-m2kirdf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffcpyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffcpyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "missing")) %>% 
  rename("Test Completed"= fmricuffcompletescl.factor)


m2kirerror1 <- full_join(m2kirerror1.1,m2kirerror1c,by = intersect(names(m2kirerror1.1), names(m2kirerror1c)))




# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

m2kirerror2 <- m2kirdf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,fmricuffcompletescl.factor,redcap_event_name,fmricuffcontrarecal.factor,fmricuffleg.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal))) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2))) %>% 
  rename(c("Re-calibration of pressure needed" = fmricuffcontrarecal.factor, "Recaliberation pressure 1"= fmricuffcalfpressurerecal,"Recaliberation pressure 1:double entry"=fmricuffcalfpressurerecal2, "cuff applied to R/L leg"=fmricuffleg.factor,"Test Completed"=fmricuffcompletescl.factor))

# merge error1 and 2 



m2kirerror1_2 <- full_join(m2kirerror1,m2kirerror2,by = intersect(names(m2kirerror1), names(m2kirerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

m2kirerror3 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricuffcompletescl.factor,fmricufft1yn,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,
         fmricufft1repeated.factor,fmricufft1repeated,fmricufft1techrating2,fmricufft1techrating2.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "missing",TRUE ~ as.character(fmricufft1techrating))) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated== "1"  ~ "missing",TRUE ~ as.character(fmricufft1techrating2))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricufft1yn.factor,fmricufft1techrating.factor,fmricufft1techrating,fmricufft1repeated.factor,fmricufft1techrating2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"T1"=fmricufft1yn.factor,"Technologists quality rating for T1 scan"=fmricufft1techrating,"T1 scan repeated?"=fmricufft1repeated.factor,"Technologists quality rating for repeated T1 scan"=fmricufft1techrating2 ) %>% 
  select (c(record_id,redcap_event_name,"Test Completed","T1","Technologists quality rating for T1 scan","T1 scan repeated?","Technologists quality rating for repeated T1 scan"))



m2kirerror1_2_3 <- full_join(m2kirerror1_2,m2kirerror3,by = intersect(names(m2kirerror1_2), names(m2kirerror3)))






#before first resting state

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

m2kirerror4.1 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "missing",TRUE ~ as.character(fmricuffrestpainss))) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "missing",TRUE ~ as.character(fmricuffrestpainss2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainss,fmricuffrestpainss2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:surgical site pain"=fmricuffrestpainss,"Before 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffrestpainss2,"1st resting state"= fmricuffrest1yn.factor) 




# Check if first resting-state scan performed and there was a mismatch between entries overall body pain

m2kirerror4.2 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | ( fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall))) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "missing",TRUE ~ as.character(fmricuffrestpainovrall2) )) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffrestpainovrall, fmricuffrestpainovrall2) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"Before 1st resting fMRI scan:body pain"=fmricuffrestpainovrall,"Before 1st resting fMRI scan:body pain(double entry)"=fmricuffrestpainovrall2,"1st resting state"= fmricuffrest1yn.factor) 



m2kirerror4 <- full_join(m2kirerror4.1,m2kirerror4.2,by=c("record_id","Test Completed","redcap_event_name","1st resting state"))


m2kirerror1_2_3_4 <- full_join(m2kirerror1_2_3,m2kirerror4,by = intersect(names(m2kirerror1_2_3), names(m2kirerror4)))




# After first resting fMRI scan:

# Check if first resting-state scan performed and there was mismatch between entries for surgical site pain

m2kirerror5.1 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2,fmricuffrest1yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss))) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanss2) )) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:surgical site pain"=fmricuffcurrpainaftfirstscanss,"After 1st resting fMRI scan:surgical site pain(double entry)"=fmricuffcurrpainaftfirstscanss2,"1st resting state"= fmricuffrest1yn.factor) 

# Check  if first resting-state scan and there was mismatch between entries for overall body pain

m2kirerror5.2 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffrest1yn.factor,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall))) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscanovrall2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 1st resting fMRI scan:body pain"=fmricuffcurrpainaftfirstscanovrall,"After 1st resting fMRI scan:body pain(double entry)"=fmricuffcurrpainaftfirstscanovrall2,"1st resting state"= fmricuffrest1yn.factor) 



m2kirerror5.a <- full_join(m2kirerror5.1,m2kirerror5.2,by = intersect(names(m2kirerror5.1), names(m2kirerror5.2)))


# Check if individualized and standard performed but baseline was missing after first resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
m2kirerror5.bb <- m2kirdf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffcpyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancp - fmricuffcurrpainaftfirstscancp2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffcurrpainaftfirstscancp,fmricuffcurrpainaftfirstscancp2,fmricuffrest1yn.factor,fmricuffcpyn.factor,
         fmricuffipyn.factor) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancp = case_when(is.na(fmricuffcurrpainaftfirstscancp) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancp))) %>%
  mutate(fmricuffcurrpainaftfirstscancp2 = case_when(is.na(fmricuffcurrpainaftfirstscancp2) ~ "missing",TRUE ~ as.character(fmricuffcurrpainaftfirstscancp2))) %>%
  rename("Test Completed"=fmricuffcompletescl.factor,"1st resting state"= fmricuffrest1yn.factor,"After 1st resting fMRI scan:cuff pain"=fmricuffcurrpainaftfirstscancp,"After 1st resting fMRI scan:cuff pain(double entry)"=fmricuffcurrpainaftfirstscancp2,"fMRI individualized pressure" = fmricuffipyn.factor, "fMRI standard pressure"= fmricuffcpyn.factor)


m2kirerror1_2_3_4_5a <- full_join(m2kirerror1_2_3_4,m2kirerror5.a,by=intersect(names(m2kirerror1_2_3_4), names(m2kirerror5.a)))


m2kirerror1_2_3_4_5 <- full_join(m2kirerror1_2_3_4_5a,m2kirerror5.bb,by=intersect(names(m2kirerror1_2_3_4_5a), names(m2kirerror5.bb)))





# After first cuff fMRI scan

# check if first cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

m2kirerror6.1 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainbegin, fmricuffpainbegin2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainbegin))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain beginning"=fmricuffpainbegin,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain beginning)"=fmricuffpainbegin2)


# check if first cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

m2kirerror6.2 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainmid,fmricuffpainmid2,fmricuffipyn.factor) %>% mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "missing",TRUE ~ as.character(fmricuffpainmid))) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "missing",TRUE ~ as.character(fmricuffpainmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain mid"=fmricuffpainmid,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpainmid2)

# check if first cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

m2kirerror6.3 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainend,fmricuffpainend2,fmricuffipyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "missing",TRUE ~ as.character(fmricuffpainend))) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "missing",TRUE ~ as.character(fmricuffpainend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI individualized pressure" = fmricuffipyn.factor,"After 1st cuff fMRI scan:cuff pain end"=fmricuffpainend,"After 1st cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpainend2)

#create final set



m2kirerror6a <- full_join(m2kirerror6.1,m2kirerror6.2,by=intersect(names(m2kirerror6.1), names(m2kirerror6.2)))

m2kirerror6 <- full_join(m2kirerror6a,m2kirerror6.3,by=intersect(names(m2kirerror6a), names(m2kirerror6.3)))

m2kirerror1_2_3_4_5_6 <- full_join(m2kirerror1_2_3_4_5,m2kirerror6,by=intersect(names(m2kirerror1_2_3_4_5), names(m2kirerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

m2kirerror7.1 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpbegin, fmricuffpaincpbegin2,fmricuffcpyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin))) %>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "missing",TRUE ~ as.character(fmricuffpaincpbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd cuff fMRI scan:cuff pain begin"=fmricuffpaincpbegin,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain begin)"=fmricuffpaincpbegin2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

m2kirerror7.2 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpmid,fmricuffpaincpmid2,fmricuffcpyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid))) %>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "missing",TRUE ~ as.character(fmricuffpaincpmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd cuff fMRI scan:cuff pain mid"=fmricuffpaincpmid,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain mid)"=fmricuffpaincpmid2)

# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

m2kirerror7.3 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpaincpend,fmricuffpaincpend2,fmricuffcpyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "missing",TRUE ~ as.character(fmricuffpaincpend))) %>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "missing",TRUE ~ as.character(fmricuffpaincpend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd cuff fMRI scan:cuff pain end"=fmricuffpaincpend,"After 2nd cuff fMRI scan:cuff pain(double entry cuff pain end)"=fmricuffpaincpend2)

#create final set

m2kirerror7a <- full_join(m2kirerror7.1,m2kirerror7.2,by=intersect(names(m2kirerror7.1), names(m2kirerror7.2))) 

m2kirerror7 <- full_join(m2kirerror7.3,m2kirerror7a,by=intersect(names(m2kirerror7.3), names(m2kirerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
m2kirerror8.1 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2,fmricuffcpyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin))) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanbegin2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd Resting state:cuff pain beginning"=fmricuffpainrestscanbegin,"After 2nd Resting state:cuff pain(double entry cuff pain beginning)"=fmricuffpainrestscanbegin2,"2nd Resting state" = fmricuffrest2yn.factor)


m2kirerror8.2 <- m2kirdf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanmid,fmricuffpainrestscanmid2,fmricuffcpyn.factor,fmricuffrest2yn.factor) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid))) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanmid2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd Resting state:cuff pain mid"=fmricuffpainrestscanmid,"After 2nd Resting state:cuff pain(double entry cuff pain mid)"=fmricuffpainrestscanmid2,"2nd Resting state" = fmricuffrest2yn.factor)


m2kirerror8.3 <- m2kirdf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainrestscanend,fmricuffpainrestscanend2,fmricuffcpyn.factor,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend)))%>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "missing",TRUE ~ as.character(fmricuffpainrestscanend2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"fMRI standard pressure"= fmricuffcpyn.factor,"After 2nd Resting state:cuff pain end"=fmricuffpainrestscanend,"After 2nd Resting state:cuff pain(double entry cuff pain end)"=fmricuffpainrestscanend2,"2nd Resting state" = fmricuffrest2yn.factor)

#create full irerror8


m2kirerror8a1 <- full_join(m2kirerror8.1,m2kirerror8.2,by=intersect(names(m2kirerror8.1), names(m2kirerror8.2))) 

m2kirerror8a <- full_join(m2kirerror8.3,m2kirerror8a1,by=intersect(names(m2kirerror8.3), names(m2kirerror8a1))) 

#merge 7 and 8a 

m2kirerror7_8a <- full_join(m2kirerror7,m2kirerror8a,by=intersect(names(m2kirerror7), names(m2kirerror8a)))


#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
m2kirerror8.4 <- m2kirdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss)))%>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanss2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:surgical site pain"=fmricuffpainaftlastscanss,"After 2nd Resting state:surgical site pain(double entry)"=fmricuffpainaftlastscanss2,"2nd Resting state" = fmricuffrest2yn.factor)

#"Body pain (double entry)"

m2kirerror8.5 <- m2kirdf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2,fmricuffrest2yn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany)))%>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "missing",TRUE ~ as.character(fmricuffpainaftlastscanany2))) %>% 
  rename("Test Completed"=fmricuffcompletescl.factor,"After 2nd Resting state:body pain"=fmricuffpainaftlastscanany,"After 2nd Resting state:body pain(double entry)"=fmricuffpainaftlastscanany2,"2nd Resting state" = fmricuffrest2yn.factor)


m2kirerror8b<- full_join(m2kirerror8.4,m2kirerror8.5,by=intersect(names(m2kirerror8.4), names(m2kirerror8.5)))



#merge 7_8a and 8b

m2kirerror7_8a_8b <- full_join(m2kirerror7_8a,m2kirerror8b,by=intersect(names(m2kirerror7_8a), names(m2kirerror8b)))



#merge all

m2kirerror1_2_3_4_5_6_7_8 <- full_join(m2kirerror1_2_3_4_5_6,m2kirerror7_8a_8b,by=intersect(names(m2kirerror1_2_3_4_5_6), names(m2kirerror7_8a_8b)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") 



#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

m2kirerror9.1 <- m2kirimaging %>% 
  filter((imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffdicuploaded.factor = case_when(is.na(fmricuffdicuploaded.factor) ~ "missing",TRUE ~ as.character(fmricuffdicuploaded.factor))) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl.factor,imaging_mcc1_v09_complete.factor,fmricuffdicuploaded.factor)%>% 
  rename("complete?"=imaging_mcc1_v09_complete.factor,"Dicom files uploaded to TACC?"=fmricuffdicuploaded.factor,"Test Completed"=fmricuffcompletescl.factor)





#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
m2kirerror9.2 <- m2kirimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmricuffcompletescl.factor = case_when(is.na(fmricuffcompletescl.factor) ~ "missing",TRUE ~ as.character(fmricuffcompletescl.factor))) %>% 
  select(record_id,redcap_event_name,imaging_mcc1_v09_complete.factor,fmricuffcompletescl.factor,fmricuffdicuploaded.factor) %>% 
  rename("complete?"=imaging_mcc1_v09_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"Dicom files uploaded to TACC"=fmricuffdicuploaded.factor)


#merge 9.1 and 9.2 

m2kirerror9.a <- full_join(m2kirerror9.1,m2kirerror9.2,by=intersect(names(m2kirerror9.1), names(m2kirerror9.2))) 

# calculate visit date - mask field introduced date
m2kresult_surg_no_na <- m2kresult_surg %>% 
  add_column(mask_date = as.Date("2021-11-05")) %>% 
  mutate("baseline_visit_arm_1" = difftime(sp_v1_preop_date,mask_date,units="days")) %>% 
  mutate("6wks_postop_arm_1" = difftime(sp_v2_6wk_date,mask_date,units="days")) %>% 
  mutate("3mo_postop_arm_1" = difftime(sp_v3_3mo_date,mask_date,units="days")) %>% 
  select(record_id,"baseline_visit_arm_1","6wks_postop_arm_1","3mo_postop_arm_1") %>% 
  pivot_longer(cols=2:4,names_to = "redcap_event_name", values_to = "mask_date_diff") %>% 
  mutate(mask_date_diff = gsub("days","",mask_date_diff)) %>% 
  mutate(record_id=as.character(record_id)) %>% 
  mutate(mask_date_diff = as.numeric(mask_date_diff))

# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

m2kirerror9.b <- m2kirimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffcpyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "missing",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc1_v09_complete.factor,fmricuffcompletescl.factor,fmri_face_mask) %>% 
  rename("complete?"=imaging_mcc1_v09_complete.factor,"Test Completed"=fmricuffcompletescl.factor,"face mask worn"= fmri_face_mask) %>% 
  left_join(.,m2kresult_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(-mask_date_diff)



m2kirerror9 <- full_join(m2kirerror9.a,m2kirerror9.b,by=intersect(names(m2kirerror9.a), names(m2kirerror9.b))) 

#merge all plus error 9

m2kirerror1_2_3_4_5_6_7_8_9 <- full_join(m2kirerror1_2_3_4_5_6_7_8,m2kirerror9,by=intersect(names(m2kirerror1_2_3_4_5_6_7_8), names(m2kirerror9)))%>% 
  relocate("Test Completed", .after = "redcap_event_name") %>% 
  mutate_all(as.character)



#fetch notes wit dag
m2knotes.imaging <- m2kirimaging %>% 
  select(record_id,redcap_event_name,fmricuffnotes, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  rename("notes"=fmricuffnotes)



m2kirerror1_2_3_4_5_6_7_8_shrink <- m2kirerror1_2_3_4_5_6_7_8_9 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#now merge with notes

m2kirerror1_2_3_4_5_6_7_8_notes <- left_join(m2kirerror1_2_3_4_5_6_7_8_shrink,m2knotes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  left_join(.,m2kdays_from_sysdate, by=c("record_id","redcap_event_name"))


# mcc2 knee QST



m2kqdata<- datam2k


#fetch imaging data to link with QST
m2ktrdata.image <- datam2k



#Setting Labels

label(m2kqdata$record_id)="Record ID"
label(m2kqdata$redcap_event_name)="Event Name"
label(m2kqdata$pptcompleteyn)="Test completed"
label(m2kqdata$pptpainlocation)="Location of greater knee pain(index site):"
label(m2kqdata$pptremote1val)="Rep 1:"
label(m2kqdata$pptremote1val1)="Rep 1: (double entry)"
label(m2kqdata$pptremote2val)="Rep 2:"
label(m2kqdata$pptremote2val1)="Rep 2: (double entry)"
label(m2kqdata$pptremote3val)="Rep 3:"
label(m2kqdata$pptremote3val1)="Rep 3:  (double entry)"
label(m2kqdata$pptindex1val)="Rep 1:"
label(m2kqdata$pptindex1val1)="Rep 1: (double entry)"
label(m2kqdata$pptindex2val)="Rep 2:"
label(m2kqdata$pptindex2val1)="Rep 2: (double entry)"
label(m2kqdata$pptindex3val)="Rep 3:"
label(m2kqdata$pptindex3val1)="Rep 3: (double entry)"
label(m2kqdata$pptnotes)="Additional notes for baseline PPTs"
label(m2kqdata$tscompleted)="Test completed"
label(m2kqdata$tsrep1initialpainrem)="Initial Pain Rating:"
label(m2kqdata$tsrep1initialpainrem_d)="Initial Pain Rating: (double entry)"
label(m2kqdata$tsrep1finalpainrem)="Final Pain Rating:"
label(m2kqdata$tsrep1finalpainrem_d)="Final Pain Rating: (double entry)"
label(m2kqdata$tsrep2initialpainrem)="Initial Pain Rating:"
label(m2kqdata$tsrep2initialpainrem_d)="Initial Pain Rating: (double entry)"
label(m2kqdata$tsrep2finalpainrem)="Final Pain Rating:"
label(m2kqdata$tsrep2finalpainrem_d)="Final Pain Rating: (double entry)"
label(m2kqdata$tsinitialpainremsclr3)="Initial Pain Rating:"
label(m2kqdata$tsinitialpainremscl1r3)="Initial Pain Rating: (double entry)"
label(m2kqdata$tsfinalpainremsclr3)="Final Pain Rating:"
label(m2kqdata$tsfinalpainremscl1r3)="Final Pain Rating: (double entry)"
label(m2kqdata$tsfinalpainremafts15)="Remote After-sensations: 	15 sec "
label(m2kqdata$tsfinalpainremafts30)="(single entry)	30 sec "
label(m2kqdata$tsrep1initialpainindex)="Initial Pain Rating:"
label(m2kqdata$tsrep1initialpainindex_d)="Initial Pain Rating: (double entry)"
label(m2kqdata$tsrep1finalpainindex)="Final Pain Rating:"
label(m2kqdata$tsrep1finalpainindex_d)="Final Pain Rating: (double entry)"
label(m2kqdata$tsinitialpainindexsclr2)="Initial Pain Rating:"
label(m2kqdata$tsinitialpainindexscl1r2)="Initial Pain Rating: (double entry)"
label(m2kqdata$tsfinalpainindexsclr2)="Final Pain Rating:"
label(m2kqdata$tsfinalpainindexscl1r2)="Final Pain Rating: (double entry)"
label(m2kqdata$tsinitialpainindexsclr3)="Initial Pain Rating:"
label(m2kqdata$tsinitialpainindexscl1r3)="Initial Pain Rating: (double entry)"
label(m2kqdata$tsfinalpainindexsclr3)="Final Pain Rating:"
label(m2kqdata$tsfinalpainindexscl1r3)="Final Pain Rating: (double entry)"
label(m2kqdata$tsfinalpainindafts15)="Index After-sensations: 	15 sec "
label(m2kqdata$tsfinalpainindafts30)="(single entry)	30 sec "
label(m2kqdata$tsnotes)="Additional notes for Temporal Summation"
label(m2kqdata$cpmcompleteyn)="Test Completed:"
label(m2kqdata$cpmcoldwatertempc)="Confirm water temp 10 deg C (+/-1 deg): "
label(m2kqdata$cpmcoldwaterpain30sscl)="Cold Water Pain Rating at 30 sec:"
label(m2kqdata$cpmcoldwaterpain30sscl1)="Cold Water Pain Rating at 30 sec: (double entry)"
label(m2kqdata$cpmcoldwaterpain60sscl)="Cold Water Pain Rating at 60 sec:"
label(m2kqdata$cpmcoldwaterpain60sscl1)="Cold Water Pain Rating at 60 sec: (double entry)"
label(m2kqdata$cpmbathrangeyn)="Water bath duration?"
label(m2kqdata$cpmoutrangetime)="If outside of range, enter time (sec)"
label(m2kqdata$cpmppt1val)="Rep 1:"
label(m2kqdata$cpmppt1val1)="Rep 1: (double entry)"
label(m2kqdata$cpmppt2val)="Rep 2:"
label(m2kqdata$cpmppt2val1)="Rep 2: (double entry)"
label(m2kqdata$cpmppt3val)="Rep 3:"
label(m2kqdata$cpmppt3val1)="Rep 3: (double entry)"
label(m2kqdata$cpmnotes)="Additional notes for Conditioned Pain Modulation "
label(m2kqdata$fmricuffcontrayn)="Cuff pressure contraindicated:"
label(m2kqdata$fmricuffcalfpressure)="Calf pressure, contralateral calf, Pressure 1: "
label(m2kqdata$fmricuffcalfpressure2)="Calf pressure, contralateral calf, Pressure 1: (double entry) "
label(m2kqdata$qst_mcc1_v03_complete)="Complete?"




#Setting Units


#Setting Factors(will create new variable for factors)
m2kqdata$redcap_event_name.factor = factor(m2kqdata$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m2kqdata$pptcompleteyn.factor = factor(m2kqdata$pptcompleteyn,levels=c("1","2","3","0"))
m2kqdata$pptpainlocation.factor = factor(m2kqdata$pptpainlocation,levels=c("1","2","3"))
m2kqdata$tscompleted.factor = factor(m2kqdata$tscompleted,levels=c("1","2","3","0"))
m2kqdata$tsrep1initialpainrem.factor = factor(m2kqdata$tsrep1initialpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1initialpainrem_d.factor = factor(m2kqdata$tsrep1initialpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1finalpainrem.factor = factor(m2kqdata$tsrep1finalpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1finalpainrem_d.factor = factor(m2kqdata$tsrep1finalpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep2initialpainrem.factor = factor(m2kqdata$tsrep2initialpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep2initialpainrem_d.factor = factor(m2kqdata$tsrep2initialpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep2finalpainrem.factor = factor(m2kqdata$tsrep2finalpainrem,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep2finalpainrem_d.factor = factor(m2kqdata$tsrep2finalpainrem_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsinitialpainremsclr3.factor = factor(m2kqdata$tsinitialpainremsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsinitialpainremscl1r3.factor = factor(m2kqdata$tsinitialpainremscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsfinalpainremsclr3.factor = factor(m2kqdata$tsfinalpainremsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsfinalpainremscl1r3.factor = factor(m2kqdata$tsfinalpainremscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1initialpainindex.factor = factor(m2kqdata$tsrep1initialpainindex,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1initialpainindex_d.factor = factor(m2kqdata$tsrep1initialpainindex_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1finalpainindex.factor = factor(m2kqdata$tsrep1finalpainindex,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsrep1finalpainindex_d.factor = factor(m2kqdata$tsrep1finalpainindex_d,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsinitialpainindexsclr2.factor = factor(m2kqdata$tsinitialpainindexsclr2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsinitialpainindexscl1r2.factor = factor(m2kqdata$tsinitialpainindexscl1r2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsfinalpainindexsclr2.factor = factor(m2kqdata$tsfinalpainindexsclr2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsfinalpainindexscl1r2.factor = factor(m2kqdata$tsfinalpainindexscl1r2,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsinitialpainindexsclr3.factor = factor(m2kqdata$tsinitialpainindexsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsinitialpainindexscl1r3.factor = factor(m2kqdata$tsinitialpainindexscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsfinalpainindexsclr3.factor = factor(m2kqdata$tsfinalpainindexsclr3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$tsfinalpainindexscl1r3.factor = factor(m2kqdata$tsfinalpainindexscl1r3,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$cpmcompleteyn.factor = factor(m2kqdata$cpmcompleteyn,levels=c("1","0"))
m2kqdata$cpmcoldwatertempc.factor = factor(m2kqdata$cpmcoldwatertempc,levels=c("1","0"))
m2kqdata$cpmcoldwaterpain30sscl.factor = factor(m2kqdata$cpmcoldwaterpain30sscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$cpmcoldwaterpain30sscl1.factor = factor(m2kqdata$cpmcoldwaterpain30sscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$cpmcoldwaterpain60sscl.factor = factor(m2kqdata$cpmcoldwaterpain60sscl,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$cpmcoldwaterpain60sscl1.factor = factor(m2kqdata$cpmcoldwaterpain60sscl1,levels=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10"))
m2kqdata$cpmbathrangeyn.factor = factor(m2kqdata$cpmbathrangeyn,levels=c("1","2"))
m2kqdata$fmricuffcontrayn.factor = factor(m2kqdata$fmricuffcontrayn,levels=c("1","0"))
m2kqdata$qst_mcc1_v03_complete.factor = factor(m2kqdata$qst_mcc1_v03_complete,levels=c("0","1","2"))

levels(m2kqdata$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(m2kqdata$pptcompleteyn.factor)=c("yes, both sites","only remote (shoulder)","only index (knee)","no, neither site")
levels(m2kqdata$pptpainlocation.factor)=c("medial","lateral","equal")
levels(m2kqdata$tscompleted.factor)=c("yes, at least 1 repetition for both sites","only remote (shoulder)","only index (knee)","no, neither site")
levels(m2kqdata$tsrep1initialpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1initialpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1finalpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1finalpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep2initialpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep2initialpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep2finalpainrem.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep2finalpainrem_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsinitialpainremsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsinitialpainremscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsfinalpainremsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsfinalpainremscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1initialpainindex.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1initialpainindex_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1finalpainindex.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsrep1finalpainindex_d.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsinitialpainindexsclr2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsinitialpainindexscl1r2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsfinalpainindexsclr2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsfinalpainindexscl1r2.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsinitialpainindexsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsinitialpainindexscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsfinalpainindexsclr3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$tsfinalpainindexscl1r3.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$cpmcompleteyn.factor)=c("Yes","No")
levels(m2kqdata$cpmcoldwatertempc.factor)=c("Yes","No")
levels(m2kqdata$cpmcoldwaterpain30sscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$cpmcoldwaterpain30sscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$cpmcoldwaterpain60sscl.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$cpmcoldwaterpain60sscl1.factor)=c("0","0.5","1.0","1.5","2.0","2.5","3.0","3.5","4.0","4.5","5.0","5.5","6.0","6.5","7.0","7.5","8.0","8.5","9.0","9.5","10")
levels(m2kqdata$cpmbathrangeyn.factor)=c("Standard range (60sec +/- 5 sec)","Outside of range: < 55sec or > 65 sec")
levels(m2kqdata$fmricuffcontrayn.factor)=c("Yes","No")
levels(m2kqdata$qst_mcc1_v03_complete.factor)=c("Incomplete","Unverified","Complete")






# Ask hablar to guess most appropriate datatype
m2kqdata <- retype(m2kqdata)




#PPTs


#keep records with complete qst test and  ppt test.
m2kqdata2  <- m2kqdata  %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(pptcompleteyn ==2 |pptcompleteyn ==  1 | pptcompleteyn == 3)




#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):








#check location of index site entered if test completed (both sites =1 OR 3 = Index site (med/lat joint line) )

m2kqerror1 <- m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  filter(is.na(pptpainlocation)) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptpainlocation.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"location of greater knee pain"= pptpainlocation.factor )) %>% 
  mutate("location of greater knee pain"=replace_na("missing")) 







#Remote site (contralateral deltoid):
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral deltoid:

#rep1
m2kqerror2.1 <-  m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremote1val - pptremote1val1) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>%  
  as_tibble() %>%
  mutate_all(as.character) %>%  
  mutate(pptremote1val = case_when(is.na(pptremote1val) ~ "missing",TRUE ~ as.character(pptremote1val))) %>% 
  mutate(pptremote1val1 = case_when(is.na(pptremote1val1) ~ "missing",TRUE ~ as.character(pptremote1val1) )) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote1val,pptremote1val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremote1val,"ppt remote rep1(double entry)"= pptremote1val1 )) 

#rep2
m2kqerror2.2 <-  m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremote2val - pptremote2val1) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote2val = case_when(is.na(pptremote2val) ~ "missing",TRUE ~ as.character(pptremote2val))) %>% 
  mutate(pptremote2val1 = case_when(is.na(pptremote2val1) ~ "missing",TRUE ~ as.character(pptremote2val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote2val,pptremote2val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep2"= pptremote2val,"ppt remote rep2(double entry)"= pptremote2val1 ))



#rep3

m2kqerror2.3 <-  m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremote3val - pptremote3val1) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote3val = case_when(is.na(pptremote3val) ~ "missing",TRUE ~ as.character(pptremote3val))) %>% 
  mutate(pptremote3val1 = case_when(is.na(pptremote3val1) ~ "missing",TRUE ~ as.character(pptremote3val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote3val,pptremote3val1)%>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep3"= pptremote3val,"ppt remote rep3(double entry)"= pptremote3val1 ))

m2kqerror2 <-  full_join(m2kqerror2.1,m2kqerror2.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,m2kqerror2.3,by= c("record_id","redcap_event_name","PPT test completed?")) 




#merge error1 and 2


m2kqerror1_2 <- full_join(m2kqerror1,m2kqerror2,by = intersect(names(m2kqerror1), names(m2kqerror2)))




#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site (med/lat joint line)::

#rep1
m2kqerror3.1 <- m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff1 = pptindex1val - pptindex1val1) %>% 
  filter(ppt_index_diff1 != 0 | is.na(ppt_index_diff1)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex1val = case_when(is.na(pptindex1val) ~ "missing",TRUE ~ as.character(pptindex1val))) %>% 
  mutate(pptindex1val1 = case_when(is.na(pptindex1val1) ~ "missing",TRUE ~ as.character(pptindex1val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex1val,pptindex1val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"= pptindex1val,"ppt index rep1(double entry)"= pptindex1val1 ))


#rep2
m2kqerror3.2 <-  m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff2 = pptindex2val - pptindex2val1) %>% 
  filter(ppt_index_diff2 != 0 | is.na(ppt_index_diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex2val = case_when(is.na(pptindex2val) ~ "missing",TRUE ~ as.character(pptindex2val))) %>% 
  mutate(pptindex2val1 = case_when(is.na(pptindex2val1) ~ "missing",TRUE ~ as.character(pptindex2val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex2val,pptindex2val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep2"= pptindex2val,"ppt index rep2(double entry)"= pptindex2val1 ))


#rep3

m2kqerror3.3 <-  m2kqdata2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff3 = pptindex3val - pptindex3val1) %>% 
  filter(ppt_index_diff3 != 0 | is.na(ppt_index_diff3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex3val = case_when(is.na(pptindex3val) ~ "missing",TRUE ~ as.character(pptindex3val))) %>% 
  mutate(pptindex3val1 = case_when(is.na(pptindex3val1) ~ "missing",TRUE ~ as.character(pptindex3val1) )) %>%
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex3val,pptindex3val1) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep3"= pptindex3val,"ppt index rep3(double entry)"= pptindex3val1 ))

m2kqerror3a <-  full_join(m2kqerror3.1,m2kqerror3.2,by=c("record_id","redcap_event_name","PPT test completed?")) %>% 
  full_join(.,m2kqerror3.3,by= c("record_id","redcap_event_name","PPT test completed?")) 






#merge error1,2 and 3a


m2kqerror1_3 <- full_join(m2kqerror1_2,m2kqerror3a,by = intersect(names(m2kqerror1_2), names(m2kqerror3a)))



#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 



m2kqerror3b.1 <- m2kqdata %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindex1val) & !is.na(pptindex1val1))  | (!is.na(pptindex2val)  & !is.na(pptindex2val1)) | (!is.na(pptindex3val)  & !is.na(pptindex3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(as.character(.)))

m2kqerror3b.2 <- m2kqdata %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindex1val) & is.na(pptindex1val1))  | (is.na(pptindex2val)  & is.na(pptindex2val1)) | (is.na(pptindex3val)  & is.na(pptindex3val1))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

m2kqerror3b.2 <- m2kqerror3b.2 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



m2kqerror3b.3 <- m2kqdata %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremote1val) & !is.na(pptremote1val1))  | (!is.na(pptremote2val) & !is.na(pptremote2val1)) | (!is.na(pptremote3val)  & !is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(as.character(.)))

m2kqerror3b.4 <- m2kqdata %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremote1val) & is.na(pptremote1val1))  | (is.na(pptremote2val)  & is.na(pptremote2val1)) | (is.na(pptremote3val)  & is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,pptcompleteyn.factor,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote2)


m2kqerror3b.4 <- m2kqerror3b.4 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )




#merge error 3
###########
m2kqerror3c <- full_join(m2kqerror3b.1,m2kqerror3b.2,by = intersect(names(m2kqerror3b.1), names(m2kqerror3b.2)))
m2kqerror3d <- full_join(m2kqerror3b.3,m2kqerror3b.4,by = intersect(names(m2kqerror3b.3), names(m2kqerror3b.4)))

###########
m2kqerror3b <- full_join(m2kqerror3c,m2kqerror3d,by = intersect(names(m2kqerror3c), names(m2kqerror3d))) %>% 
  select(c(-index1,-index2,-remote1,-remote2)) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt index rep1"= pptindex1val,"ppt index rep1(double entry)"= pptindex1val1,"ppt index rep2"= pptindex2val,
           "ppt index rep2(double entry)"= pptindex2val1,"ppt index rep3"= pptindex3val,"ppt index rep3(double entry)"= pptindex3val1,"ppt remote rep1"= pptremote1val,
           "ppt remote rep1(double entry)"= pptremote1val1,"ppt remote rep2"= pptremote2val,"ppt remote rep2(double entry)"= pptremote2val1,"ppt remote rep3"= pptremote3val,"ppt remote rep3(double entry)"= pptremote3val1  ))  %>%
  as_tibble() %>% 
  mutate_all(as.character)


# 
# error3b[] <- lapply(error3b, as.character)
# error2_3[] <- lapply(error2_3, as.character)


m2kqerror1_3_3b <- full_join(m2kqerror1_3,m2kqerror3b,by = intersect(names(m2kqerror1_3), names(m2kqerror3b)))




# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


m2kqppt.biomarker <- m2kqdata %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindex1val,pptindex2val,pptindex3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindex1val,pptindex2val,pptindex3val,pptcompleteyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


m2kqppt.biomarker1 <- m2kqdata %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote2val,pptremote3val,pptcompleteyn.factor) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2kqppt.all.biomarker <- full_join(m2kqppt.biomarker,m2kqppt.biomarker1,by=c("record_id","redcap_event_name","pptcompleteyn.factor")) %>% 
  rename(c("PPT test completed?" = pptcompleteyn.factor,"ppt remote rep1"= pptremote1val,"ppt remote rep2"= pptremote2val,"ppt remote rep3"= pptremote3val,"ppt index rep1"= pptindex1val,"ppt index rep2"= pptindex2val,"ppt index rep3"= pptindex3val ))





m2kqerror2_3_3b_endpoint <- full_join(m2kqerror1_3_3b,m2kqppt.all.biomarker,by=c("record_id","redcap_event_name","PPT test completed?","ppt index rep1","ppt index rep2","ppt index rep3","ppt remote rep1","ppt remote rep2","ppt remote rep3"))





#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kqerror2_3_3b_endpoint [m2kqerror2_3_3b_endpoint == ""] <- NA

m2kqerror2_3_3b_endpoint1 <- m2kqerror2_3_3b_endpoint %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#Temporal Summation:





#PPTs

# check for missingness in "ts test completed"




#Remove records with missing "ts test completed",# keep record with "tscompleted test completed"

m2ktr.complete <- m2kqdata %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(tscompleted ==2 |tscompleted ==  1 | tscompleted == 3)


#check if all ppt.completed now has completed records, where 0= niether site, 1= yes atleast 1 rep for both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):




#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
m2ktrerror4.1 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsrep1initialpainrem - tsrep1initialpainrem_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainrem = case_when(is.na(tsrep1initialpainrem) ~ "missing",TRUE ~ as.character(tsrep1initialpainrem))) %>% 
  mutate(tsrep1initialpainrem_d = case_when(is.na(tsrep1initialpainrem_d) ~ "missing",TRUE ~ as.character(tsrep1initialpainrem_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1initialpainrem_d,tscompleted) 


#rep1 final
m2ktrerror4.2 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsrep1finalpainrem - tsrep1finalpainrem_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainrem = case_when(is.na(tsrep1finalpainrem) ~ "missing",TRUE ~ as.character(tsrep1finalpainrem))) %>% 
  mutate(tsrep1finalpainrem_d = case_when(is.na(tsrep1finalpainrem_d) ~ "missing",TRUE ~ as.character(tsrep1finalpainrem_d) )) %>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1finalpainrem,tsrep1finalpainrem_d,tscompleted) 


#rep1 set 
m2ktrrep1.set <- full_join(m2ktrerror4.1,m2ktrerror4.2,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#rep2 initial

m2ktrerror4.3 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsrep2initialpainrem - tsrep2initialpainrem_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep2initialpainrem = case_when(is.na(tsrep2initialpainrem) ~ "missing",TRUE ~ as.character(tsrep2initialpainrem))) %>% 
  mutate(tsrep2initialpainrem_d = case_when(is.na(tsrep2initialpainrem_d) ~ "missing",TRUE ~ as.character(tsrep2initialpainrem_d) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep2initialpainrem,tsrep2initialpainrem_d,tscompleted)

#rep2 final

m2ktrerror4.4 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsrep2finalpainrem - tsrep2finalpainrem_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep2finalpainrem = case_when(is.na(tsrep2finalpainrem) ~ "missing",TRUE ~ as.character(tsrep2finalpainrem))) %>% 
  mutate(tsrep2finalpainrem_d = case_when(is.na(tsrep2finalpainrem_d) ~ "missing",TRUE ~ as.character(tsrep2finalpainrem_d) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep2finalpainrem,tsrep2finalpainrem_d,tscompleted) 

#rep2 set 
m2ktrrep2.set <- full_join(m2ktrerror4.3,m2ktrerror4.4,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


#rep3 initial

m2ktrerror4.5 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsinitialpainremsclr3 - tsinitialpainremscl1r3) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainremsclr3 = case_when(is.na(tsinitialpainremsclr3) ~ "missing",TRUE ~ as.character(tsinitialpainremsclr3))) %>% 
  mutate(tsinitialpainremscl1r3 = case_when(is.na(tsinitialpainremscl1r3) ~ "missing",TRUE ~ as.character(tsinitialpainremscl1r3) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsinitialpainremsclr3,tsinitialpainremscl1r3,tscompleted)

#rep3 final
m2ktrerror4.6 <-   m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsfinalpainremsclr3 - tsfinalpainremscl1r3) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremsclr3 = case_when(is.na(tsfinalpainremsclr3) ~ "missing",TRUE ~ as.character(tsfinalpainremsclr3))) %>% 
  mutate(tsfinalpainremscl1r3 = case_when(is.na(tsfinalpainremscl1r3) ~ "missing",TRUE ~ as.character(tsfinalpainremscl1r3) ))%>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremsclr3,tsfinalpainremscl1r3,tscompleted) 

#rep3 set 
m2ktrrep3.set <- full_join(m2ktrerror4.5,m2ktrerror4.6,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

m2ktr_remote_all_reps1 <- full_join(m2ktrrep1.set,m2ktrrep2.set,by = c("record_id","redcap_event_name","tscompleted.factor","tscompleted")) %>% 
  full_join(.,m2ktrrep3.set,by= c("record_id","redcap_event_name","tscompleted.factor","tscompleted"))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
m2ktr1 <- m2ktr_remote_all_reps1 %>% 
  mutate(trrep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep1initialpainrem))  & (is.na(tsrep1initialpainrem_d))  & (is.na(tsrep1finalpainrem)) & (is.na(tsrep1finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(trrep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep2initialpainrem))  & (is.na(tsrep2initialpainrem_d))  & (is.na(tsrep2finalpainrem)) & (is.na(tsrep2finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(trrep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsinitialpainremsclr3))  & (is.na(tsinitialpainremscl1r3))  & (is.na(tsfinalpainremsclr3)) & (is.na(tsfinalpainremscl1r3))~ 1,TRUE ~ 0))


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,"TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3 ))







#index site Index site (med/lat knee)

# check for missing or mismatch in pain ratings for  Index site (med/lat knee) in both site OR  Index site (med/lat knee):

#rep1 initial
m2ktrerror6.1 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsrep1initialpainindex - tsrep1initialpainindex_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainindex = case_when(is.na(tsrep1initialpainindex) ~ "missing",TRUE ~ as.character(tsrep1initialpainindex))) %>%
  mutate(tsrep1initialpainindex_d = case_when(is.na(tsrep1initialpainindex_d) ~ "missing",TRUE ~ as.character(tsrep1initialpainindex_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainindex,tsrep1initialpainindex_d,tscompleted)

#rep1 final 

m2ktrerror6.2 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsrep1finalpainindex - tsrep1finalpainindex_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainindex = case_when(is.na(tsrep1finalpainindex) ~ "missing",TRUE ~ as.character(tsrep1finalpainindex))) %>%
  mutate(tsrep1finalpainindex_d = case_when(is.na(tsrep1finalpainindex_d) ~ "missing",TRUE ~ as.character(tsrep1finalpainindex_d) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1finalpainindex,tsrep1finalpainindex_d,tscompleted)



#rep1 set 
m2ktrrep1.index.set <- full_join(m2ktrerror6.1,m2ktrerror6.2,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))

#rep2 initial

m2ktrerror6.3 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsinitialpainindexsclr2 - tsinitialpainindexscl1r2) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr2 = case_when(is.na(tsinitialpainindexsclr2) ~ "missing",TRUE ~ as.character(tsinitialpainindexsclr2)))%>%
  mutate(tsinitialpainindexscl1r2 = case_when(is.na(tsinitialpainindexscl1r2) ~ "missing",TRUE ~ as.character(tsinitialpainindexscl1r2) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tscompleted)


#rep2 final
m2ktrerror6.4 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsfinalpainindexsclr2 - tsfinalpainindexscl1r2) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr2 = case_when(is.na(tsfinalpainindexsclr2) ~ "missing",TRUE ~ as.character(tsfinalpainindexsclr2)))%>%
  mutate(tsfinalpainindexscl1r2 = case_when(is.na(tsfinalpainindexscl1r2) ~ "missing",TRUE ~ as.character(tsfinalpainindexscl1r2) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tscompleted)


#rep2 set 
m2ktrrep2.index.set <- full_join(m2ktrerror6.3,m2ktrerror6.4,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor"))


#rep3 initial

m2ktrerror6.5 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsinitialpainindexsclr3 - tsinitialpainindexscl1r3) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr3 = case_when(is.na(tsinitialpainindexsclr3) ~ "missing",TRUE ~ as.character(tsinitialpainindexsclr3)))%>%
  mutate(tsinitialpainindexscl1r3 = case_when(is.na(tsinitialpainindexscl1r3) ~ "missing",TRUE ~ as.character(tsinitialpainindexscl1r3) ))%>%
  select(record_id,redcap_event_name,tscompleted.factor,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tscompleted) 

#rep3 final
m2ktrerror6.6 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsfinalpainindexsclr3 - tsfinalpainindexscl1r3) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr3 = case_when(is.na(tsfinalpainindexsclr3) ~ "missing",TRUE ~ as.character(tsfinalpainindexsclr3)))%>%
  mutate(tsfinalpainindexscl1r3 = case_when(is.na(tsfinalpainindexscl1r3) ~ "missing",TRUE ~ as.character(tsfinalpainindexscl1r3) )) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindexsclr3,tsfinalpainindexscl1r3,tscompleted) 

#rep3 set 
m2ktrrep3.index.set <- full_join(m2ktrerror6.5,m2ktrerror6.6,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
m2ktr_index_all_reps1 <- full_join(m2ktrrep1.index.set,m2ktrrep2.index.set,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  full_join(.,m2ktrrep3.index.set,by= c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0




m2ktr.index1 <- m2ktr_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsrep1initialpainindex))  & (is.na(tsrep1initialpainindex_d))  & (is.na(tsrep1finalpainindex)) & (is.na(tsrep1finalpainindex_d))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2ktr.index1 <- m2ktr.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr2))  & (is.na(tsinitialpainindexscl1r2))  & (is.na(tsfinalpainindexsclr2)) & (is.na(tsfinalpainindexscl1r2))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2ktr.index1 <- m2ktr.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr3))  & (is.na(tsinitialpainindexscl1r3))  & (is.na(tsfinalpainindexsclr3)) & (is.na(tsfinalpainindexscl1r3))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS index rep3 final(double entry)"= tsfinalpainindexscl1r3))




#if one rep is complete with no mismatch then all.reps.rem == 1 else 0
m2ktr1 <- m2ktr1 %>% 
  mutate(all.reps.rem = case_when(trrep1 == 0  & trrep2==0  & trrep3==0  ~ 0,TRUE ~ 1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
m2ktr.index1 <- m2ktr.index1 %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == 0  & ind.rep2==0  & ind.rep3==0  ~ 0,TRUE ~ 1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
m2ktrrem.ind <- full_join(m2ktr1,m2ktr.index1,by = c("record_id","redcap_event_name","tscompleted","tscompleted.factor")) %>% 
  filter((tscompleted == 2 & all.reps.rem == 0)| (tscompleted == 3 & all.reps.ind == 0) | (tscompleted == 1 & all.reps.rem == 0 |all.reps.ind == 0 ) ) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2ktrrem_index_all_reps <- m2ktrrem.ind %>% 
  select(c(-tscompleted,-trrep1,-trrep2,-trrep3,-all.reps.rem,-all.reps.ind,-ind.rep1,-ind.rep2,-ind.rep3)) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,
           "TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,
           "TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,
           "TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,
           "TS index rep3 final(double entry)"= tsfinalpainindexscl1r3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,
           "TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,
           "TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,
           "TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,
           "TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)






# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

m2ktrerror5.1 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremafts15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 15sec"= tsfinalpainremafts15 )) %>% 
  mutate("TS remote after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
m2ktrerror5.2 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts30)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainremafts30) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS remote after sensation 30sec"= tsfinalpainremafts30 ))  %>% 
  mutate("TS remote after sensation 30sec"=replace_na("missing")) 

# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# error5.1[] <- lapply(error5.1, as.character)
# error5.2[] <- lapply(error5.2, as.character)


m2ktr_remote_all_reps_sensations <- full_join(m2ktrrem_index_all_reps,m2ktrerror5.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,m2ktrerror5.2,by= c("record_id","redcap_event_name","TS test completed?")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# once TS  Index site (med/lat knee)is completed
# missing after sensation at 15 secs

m2ktrerror7.1 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts15)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindafts15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 15sec"= tsfinalpainindafts15 )) %>% 
  mutate("TS index after sensation 15sec"=replace_na("missing")) 


# missing after sensation at 30 secs
m2ktrerror7.2 <-  m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts30)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsfinalpainindafts30) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index after sensation 30sec"= tsfinalpainindafts30 )) %>% 
  mutate("TS index after sensation 30sec"=replace_na("missing"))



# convert all char for merging
# Ts_remote_all_reps_sensations[] <- lapply(Ts_remote_all_reps_sensations, as.character)
# error7.1[] <- lapply(error7.1, as.character)
# error7.2[] <- lapply(error7.2, as.character)


#merge all
m2ktr_index_remote_all_reps_sensation <- full_join(m2ktr_remote_all_reps_sensations,m2ktrerror7.1,by = c("record_id","redcap_event_name","TS test completed?")) %>% 
  full_join(.,m2ktrerror7.2,by= c("record_id","redcap_event_name","TS test completed?")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

m2ktrerror7.3a <- m2ktr.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsrep1initialpainindex) & !is.na(tsrep1initialpainindex_d))  | (!is.na(tsrep1finalpainindex)  & !is.na(tsrep1finalpainindex_d)) | (!is.na(tsinitialpainindexsclr2)  & !is.na(tsinitialpainindexscl1r2)) | (!is.na(tsfinalpainindexsclr2) & !is.na(tsfinalpainindexscl1r2))  | (!is.na(tsinitialpainindexsclr3)  & !is.na(tsinitialpainindexscl1r3)) | (!is.na(tsfinalpainindexsclr3)  & !is.na(tsfinalpainindexscl1r3))  ~ 1,TRUE ~ 0))  %>% 
  filter(ts.index1 == 1)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3) 



#OR b.if both sites was checked but pain ratings not filled out for the index site 

m2ktrerror7.3b <- m2ktr.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsrep1initialpainindex) & is.na(tsrep1initialpainindex_d)  & is.na(tsrep1finalpainindex)  & is.na(tsrep1finalpainindex_d) & is.na(tsinitialpainindexsclr2)  & is.na(tsinitialpainindexscl1r2) & is.na(tsfinalpainindexsclr2) & is.na(tsfinalpainindexscl1r2)  & is.na(tsinitialpainindexsclr3)  & is.na(tsinitialpainindexscl1r3) & is.na(tsfinalpainindexsclr3)  & is.na(tsfinalpainindexscl1r3)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )



# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 


m2ktrerror7.4a <- m2ktr.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsrep1initialpainrem) & !is.na(tsrep1initialpainrem_d))  | (!is.na(tsrep1finalpainrem)  & !is.na(tsrep1finalpainrem_d)) | (!is.na(tsrep2initialpainrem)  & !is.na(tsrep2initialpainrem_d)) | (!is.na(tsrep2finalpainrem) & !is.na(tsrep2finalpainrem_d))  | (!is.na(tsinitialpainremsclr3)  & !is.na(tsinitialpainremscl1r3)) | (!is.na(tsfinalpainremsclr3)  & !is.na(tsfinalpainremscl1r3))  ~ 1,TRUE ~ 0))  %>%
  filter(ts.remote1 == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3)


#OR b.if both sites was checked but pain ratings not filled out for the remote site

m2ktrerror7.4b <- m2ktr.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsrep1initialpainrem) & is.na(tsrep1initialpainrem_d)  & is.na(tsrep1finalpainrem)  & is.na(tsrep1finalpainrem_d) & is.na(tsrep2initialpainrem)  & is.na(tsrep2initialpainrem_d) & is.na(tsrep2finalpainrem) & is.na(tsrep2finalpainrem_d)  & is.na(tsinitialpainremsclr3)  & is.na(tsinitialpainremscl1r3) & is.na(tsfinalpainremsclr3)  & is.na(tsfinalpainremscl1r3)  ~ 1,TRUE ~ 0)) %>% 
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )






#merge 7.3a,7.3b,7.4a,7.4b





m2ktrerror7.3a[] <- lapply(m2ktrerror7.3a, as.character)
m2ktrerror7.3b[] <- lapply(m2ktrerror7.3b, as.character)
m2ktrerror7.4a[] <- lapply(m2ktrerror7.4a, as.character)
m2ktrerror7.4b[] <- lapply(m2ktrerror7.4b, as.character)


m2ktrmerged7.3 <- full_join(m2ktrerror7.3a,m2ktrerror7.3b,by = intersect(names(m2ktrerror7.3a), names(m2ktrerror7.3b))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2ktrmerged7.4 <- full_join(m2ktrerror7.4a,m2ktrerror7.4b,by = intersect(names(m2ktrerror7.4a), names(m2ktrerror7.4b))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2ktrmerged7 <- full_join(m2ktrmerged7.3,m2ktrmerged7.4,by = intersect(names(m2ktrmerged7.3), names(m2ktrmerged7.4))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#rename merged7
m2ktrmerged7.1 <- m2ktrmerged7 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS index rep3 final(double entry)"= tsfinalpainindexscl1r3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,"TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3))  




# change  to as.character for merging
m2ktr_index_remote_all_reps_sensation [] <- lapply(m2ktr_index_remote_all_reps_sensation , as.character)
m2ktrmerged7.1[] <- lapply(m2ktrmerged7.1, as.character)




#merge Ts_index_remote_all_reps_sensation and merged7.1 

m2ktrmerge8 <- full_join(m2ktrmerged7.1,m2ktr_index_remote_all_reps_sensation ,by = intersect(names(m2ktrmerged7.1), names(m2ktr_index_remote_all_reps_sensation ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
m2ktrprim.outcome.index <- m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsrep1finalpainindex,tsrep1initialpainindex)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsrep1initialpainindex) %>% 
  mutate(max.rep2.index = pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2)) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsinitialpainindexsclr2) %>% 
  mutate(max.rep3.index = pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsinitialpainindexsclr3) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2ktrprim.outcome.remote <- m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsrep1initialpainrem,tsrep1finalpainrem)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsrep1initialpainrem) %>% 
  mutate(max.rep2.remote = pmax(tsrep2initialpainrem,tsrep2finalpainrem)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsrep2initialpainrem) %>% 
  mutate(max.rep3.remote = pmax(tsinitialpainremsclr3,tsfinalpainremsclr3)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsinitialpainremsclr3) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2ktr_primary_outcome <-  full_join(m2ktrprim.outcome.index, m2ktrprim.outcome.remote ,by = intersect(names(m2ktrprim.outcome.remote), names(m2ktrprim.outcome.index ))) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 final"= tsfinalpainremsclr3))  




# # change  to as.character for merging
m2ktrmerge8 [] <- lapply(m2ktrmerge8 , as.character)
m2ktr_primary_outcome[] <- lapply(m2ktr_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

m2ktr.all.prim.outcome <- full_join(m2ktrmerge8,m2ktr_primary_outcome ,by = intersect(names(m2ktrmerge8), names(m2ktr_primary_outcome))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m2ktrsec.outcome.index <- m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsrep1finalpainindex,tsrep1initialpainindex))) %>% 
  mutate(init.rep1.index1 = 1+(tsrep1initialpainindex)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2))) %>% 
  mutate(init.rep2.index1 = 1+(tsinitialpainindexsclr2)) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3))) %>% 
  mutate(init.rep3.index1 = 1+(tsinitialpainindexsclr3)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m2ktrsec.outcome.remote <- m2ktr.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsrep1initialpainrem,tsrep1finalpainrem))) %>% 
  mutate(init.rep1.remote1 = 1+(tsrep1initialpainrem)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsrep2initialpainrem,tsrep2finalpainrem))) %>% 
  mutate(init.rep2.remote1 = 1+(tsrep2initialpainrem)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsinitialpainremsclr3,tsfinalpainremsclr3))) %>% 
  mutate(init.rep3.remote1 = 1+(tsinitialpainremsclr3)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tscompleted.factor,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )

m2ktr_sec_outcome <-  full_join(m2ktrsec.outcome.index,m2ktrsec.outcome.remote ,by = intersect(names(m2ktrsec.outcome.remote), names(m2ktrsec.outcome.index ))) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 final"= tsfinalpainremsclr3)) 



# change  to as.character for merging
m2ktr_sec_outcome [] <- lapply(m2ktr_sec_outcome , as.character)
m2ktr.all.prim.outcome[] <- lapply(m2ktr.all.prim.outcome, as.character)

#merge ts_sec_outcome  with ts.all.prim.outcome

m2ktr.all.prim.sec.outcome <- full_join(m2ktr_sec_outcome ,m2ktr.all.prim.outcome ,by = intersect(names(m2ktr_sec_outcome), names(m2ktr.all.prim.outcome ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2ktr.all.prim.sec.outcome <- m2ktr.all.prim.sec.outcome %>%
  relocate("record_id","redcap_event_name","TS test completed?","TS index rep1 initial","TS index rep1 initial(double entry)","TS index rep1 final"
           ,"TS index rep1 final(double entry)","TS index rep2 initial",  "TS index rep2 initial(double entry)", "TS index rep2 final", "TS index rep2 final(double entry)","TS index rep3 initial","TS index rep3 initial(double entry)","TS index rep3 final", 
           "TS index rep3 final(double entry)" , "TS index after sensation 15sec","TS index after sensation 30sec","TS contralateral rep1 initial" , 
           "TS contralateral rep1 initial(double entry)", "TS contralateral rep1 final" ,"TS contralateral rep1 final(double entry)",
           "TS contralateral rep2 initial","TS contralateral rep2 initial(double entry)","TS contralateral rep2 final" ,   "TS contralateral rep2 final(double entry)" ,
           "TS contralateral rep3 initial", "TS contralateral rep3 initial(double entry)", "TS contralateral rep3 final" ,  "TS contralateral rep3 final(double entry)" ,"TS remote after sensation 15sec" ,
           "TS remote after sensation 30sec" ) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2ktr.all.prim.sec.outcome [m2ktr.all.prim.sec.outcome == ""] <- NA

m2ktr.all.prim.sec.outcome <- m2ktr.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# mcc2 knee pain Conditioned Pain Modulation

#CPM



#Remove records with missing "cp test completed"

m2ktrdata1cp <- m2kqdata %>% 
  filter(!is.na(cpmcompleteyn))



# keep record with "cpm test completed"

m2ktrcpm.complete <- m2ktrdata1cp %>% 
  filter(cpmcompleteyn != 0 & qst_mcc1_v03_complete == 2)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):







#water temp not checked

m2ktrcpm.error1 <- m2ktrcpm.complete %>% 
  filter(cpmcoldwatertempc != 1) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmcoldwatertempc) %>% 
  mutate(cpmcoldwatertempc = case_when(cpmcoldwatertempc != 1 ~ "missing",TRUE ~ as.character(cpmcoldwatertempc))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"confirm water temp"=cpmcoldwatertempc)




# missing or mismatch in cold water pain rating at 30 sec

m2ktrcpm.error2 <- m2ktrcpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30sscl - cpmcoldwaterpain30sscl1) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain30sscl = case_when(is.na(cpmcoldwaterpain30sscl) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30sscl)))%>%
  mutate(cpmcoldwaterpain30sscl1 = case_when(is.na(cpmcoldwaterpain30sscl1) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain30sscl1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain30sscl,cpmcoldwaterpain30sscl1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 30 sec"=cpmcoldwaterpain30sscl,"Cold Water Pain Rating at 30 sec(double entry)"=cpmcoldwaterpain30sscl1)





# missing or mismatch in cold water pain rating at 60 sec
m2ktrcpm.error3 <- m2ktrcpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60sscl - cpmcoldwaterpain60sscl1) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain60sscl = case_when(is.na(cpmcoldwaterpain60sscl) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60sscl)))%>%
  mutate(cpmcoldwaterpain60sscl1 = case_when(is.na(cpmcoldwaterpain60sscl1) ~ "missing",TRUE ~ as.character(cpmcoldwaterpain60sscl1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmbathrangeyn.factor,cpmoutrangetime,cpmcoldwaterpain60sscl,cpmcoldwaterpain60sscl1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"water bath duration"=cpmbathrangeyn.factor,"if outside range: time"=cpmoutrangetime,"Cold Water Pain Rating at 60 sec"=cpmcoldwaterpain60sscl,"Cold Water Pain Rating at 60 sec(double entry)"=cpmcoldwaterpain60sscl1)





#merge error 2&3
m2ktrerrorcpm2_3 <- full_join(m2ktrcpm.error2,m2ktrcpm.error3,by = c("record_id","redcap_event_name","cpm test completed","water bath duration","if outside range: time")) %>%
  as_tibble() %>% 
  mutate_all(as.character)

##merge error 1 with 2&3
m2ktrerrorcpm1_2_3 <- full_join(m2ktrcpm.error1,m2ktrerrorcpm2_3,by = c("record_id","redcap_event_name","cpm test completed")) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#check for missing/mismatch in ppts

m2ktrcpm.error4.1 <- m2ktrcpm.complete %>% 
  mutate(diff_cpm1 = cpmppt1val - cpmppt1val1) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt1val = case_when(is.na(cpmppt1val) ~ "missing",TRUE ~ as.character(cpmppt1val)))%>%
  mutate(cpmppt1val1 = case_when(is.na(cpmppt1val1) ~ "missing",TRUE ~ as.character(cpmppt1val1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmppt1val,cpmppt1val1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmppt1val,"conditioned pain modulation PPT:rep1(double entry)"=cpmppt1val1)





#check for missing/mismatch in ppts

m2ktrcpm.error4.2 <- m2ktrcpm.complete %>% 
  mutate(diff_cpm2 = cpmppt2val - cpmppt2val1) %>% 
  filter(diff_cpm2!=0 | is.na(diff_cpm2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt2val = case_when(is.na(cpmppt2val) ~ "missing",TRUE ~ as.character(cpmppt2val)))%>%
  mutate(cpmppt2val1 = case_when(is.na(cpmppt2val1) ~ "missing",TRUE ~ as.character(cpmppt2val1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmppt2val,cpmppt2val1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep2"=cpmppt2val,"conditioned pain modulation PPT:rep2(double entry)"=cpmppt2val1)




#check for missing/mismatch in ppts

m2ktrcpm.error4.3 <- m2ktrcpm.complete %>% 
  mutate(diff_cpm3 = cpmppt3val - cpmppt3val1) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt3val = case_when(is.na(cpmppt3val) ~ "missing",TRUE ~ as.character(cpmppt3val)))%>%
  mutate(cpmppt3val1 = case_when(is.na(cpmppt3val1) ~ "missing",TRUE ~ as.character(cpmppt3val1) )) %>% 
  select(record_id,redcap_event_name,cpmcompleteyn.factor,cpmppt3val,cpmppt3val1) %>% 
  rename("cpm test completed"=cpmcompleteyn.factor,"conditioned pain modulation PPT:rep3"=cpmppt3val,"conditioned pain modulation PPT:rep3(double entry)"=cpmppt3val1)





#merge 4.1-.3

m2ktrcpm.error4 <- full_join(m2ktrcpm.error4.1,m2ktrcpm.error4.2,by = c("record_id","redcap_event_name","cpm test completed")) %>% 
  full_join(.,m2ktrcpm.error4.3,by= c("record_id","redcap_event_name","cpm test completed")) %>%
  as_tibble() %>% 
  mutate_all(as.character)



m2ktrcpm.final <- full_join(m2ktrcpm.error4,m2ktrerrorcpm1_2_3,by = c("record_id","redcap_event_name","cpm test completed")) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


m2ktrcmp.prim.outcome <- m2ktrcpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )










#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


m2ktrcmp.sec.outcome <- m2ktrcpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn.factor,pptcompleteyn.factor,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "missing",
                TRUE ~ as.character(.)
    ))
  )


m2ktrcmp.outcome <- full_join(m2ktrcmp.prim.outcome ,m2ktrcmp.sec.outcome ,by = intersect(names(m2ktrcmp.prim.outcome), names(m2ktrcmp.sec.outcome))) %>% rename("cpm test completed"=cpmcompleteyn.factor,"PPT test completed?" = pptcompleteyn.factor,"conditioned pain modulation PPT:rep1"=cpmppt1val,"conditioned pain modulation PPT:rep2"=cpmppt2val,
                                                                                                                                                                 "conditioned pain modulation PPT:rep3"=cpmppt3val,"ppt remote rep1"= pptremote1val,"ppt remote rep2"= pptremote2val,"ppt remote rep3"= pptremote3val) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#change  to as.character for merging
m2ktrcmp.outcome [] <- lapply(m2ktrcmp.outcome , as.character)
m2ktrcpm.final[] <- lapply(m2ktrcpm.final, as.character)

#merge all cmp errors

m2ktrall.cmp <-  full_join(m2ktrcmp.outcome ,m2ktrcpm.final ,by = intersect(names(m2ktrcmp.outcome), names(m2ktrcpm.final))) %>% 
  relocate("record_id", "redcap_event_name","cpm test completed","PPT test completed?","ppt remote rep1","ppt remote rep2",   
           "ppt remote rep3","conditioned pain modulation PPT:rep1", "conditioned pain modulation PPT:rep1(double entry)",             
           "conditioned pain modulation PPT:rep2","conditioned pain modulation PPT:rep2(double entry)","conditioned pain modulation PPT:rep3",      "conditioned pain modulation PPT:rep3(double entry)","confirm water temp","water bath duration","Cold Water Pain Rating at 30 sec","Cold Water Pain Rating at 30 sec(double entry)","Cold Water Pain Rating at 60 sec","Cold Water Pain Rating at 60 sec(double entry)") %>% 
  arrange(record_id) %>%
  as_tibble() %>% 
  mutate_all(as.character)








#ensure each combination of ID and redcap event has one row with all values and is not duplicated

#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2ktrall.cmp[m2ktrall.cmp== ""] <- NA

m2ktrall.cmp <- m2ktrall.cmp%>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#link with imaging data
label(m2ktrdata.image$fmricuffcompletescl)="Test Completed:"
label(m2ktrdata.image$fmricuffcontrarecal)="imaging_Re-calibration of pressure needed:"
label(m2ktrdata.image$fmricuffcalfpressurerecal)="imaging:Pressure 2:"
label(m2ktrdata.image$fmricuffcalfpressurerecal2)="imaging:Pressure 2: (double entry)"
label(m2ktrdata.image$fmricuffipyn)="imaging_fMRI individualized pressure"
m2ktrdata.image$fmricuffcontrarecal.factor = factor(m2ktrdata.image$fmricuffcontrarecal,levels=c("1","0"))
m2ktrdata.image$fmricuffcompletescl.factor = factor(m2ktrdata.image$fmricuffcompletescl,levels=c("1","2","0"))
m2ktrdata.image$fmricuffipyn.factor = factor(m2ktrdata.image$fmricuffipyn,levels=c("1","0"))

levels(m2ktrdata.image$fmricuffcontrarecal.factor)=c("Yes","No")


levels(m2ktrdata.image$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
levels(m2ktrdata.image$fmricuffipyn.factor)=c("Yes","No")


# select needed variables
m2ktrdata.image1 <- m2ktrdata.image %>% 
  filter(qst_mcc1_v03_complete == 2)  %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcontrarecal.factor,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl,fmricuffipyn.factor,fmricuffcompletescl.factor)

m2ktrdata.qst <- m2kqdata %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrayn,fmricuffcontrayn.factor,fmricuffcalfpressure,fmricuffcalfpressure2,qst_mcc1_v03_complete)



# change  to as.character for merging
m2ktrdata.image1 [] <- lapply(m2ktrdata.image1 , as.character)
m2ktrdata.qst[] <- lapply(m2ktrdata.qst, as.character)

#merge both
m2ktrqst.image <-  full_join(m2ktrdata.image1 ,m2ktrdata.qst ,by = intersect(names(m2ktrdata.image1), names(m2ktrdata.qst)))  %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging



m2ktrqst.image1 <- m2ktrqst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(fmricuffcalfpressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_event_name,redcap_data_access_group,fmricuffipyn.factor,fmricuffcompletescl.factor,fmricuffcontrayn.factor,
         fmricuffcontrarecal.factor,fmricuffcalfpressure,fmricuffcalfpressure2,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcontrayn.factor = case_when(is.na(fmricuffcontrayn.factor) ~ "missing",TRUE ~ as.character(fmricuffcontrayn.factor)))%>% 
  mutate(fmricuffcontrarecal.factor = case_when(is.na(fmricuffcontrarecal.factor) ~ "missing",TRUE ~ as.character(fmricuffcontrarecal.factor) )) %>% 
  mutate(fmricuffcalfpressure = case_when(is.na(fmricuffcalfpressure) ~ "missing",TRUE ~ as.character(fmricuffcalfpressure) )) %>% 
  mutate(fmricuffcalfpressure2 = case_when(is.na(fmricuffcalfpressure2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressure2) )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal) )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "missing",TRUE ~ as.character(fmricuffcalfpressurerecal2) )) %>%
  rename ("qst cuff prssure C/I"=fmricuffcontrayn.factor,"image:Re-calibration of pressure needed:"=fmricuffcontrarecal.factor,"qst pressure1"=fmricuffcalfpressure,"qst pressure(double)"=fmricuffcalfpressure2,"imaging recal pressure"=fmricuffcalfpressurerecal,"imaging recal pressure(double)"=fmricuffcalfpressurerecal2, "imaging_fMRI individualized pressure"=fmricuffipyn.factor,"Test Completed:"=fmricuffcompletescl.factor) %>% 
  add_column(QST_test = "No_Recal_pressure")




#fetch notes and dag

m2ktrnotes.ppt <- m2kqdata %>% 
  select(record_id,redcap_event_name,pptnotes,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2ktrnotes.ts <- m2kqdata %>% 
  select(record_id,redcap_event_name,tsnotes,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2ktrnotes.cpm <- m2kqdata %>% 
  select(record_id,redcap_event_name,cpmnotes,redcap_data_access_group)%>% 
  as_tibble() %>% 
  mutate_all(as.character)






#ppt with notes
# 

m2kqerror2_3_3b_endpoint1[] <- lapply(m2kqerror2_3_3b_endpoint1, as.character)
m2ktrnotes.ppt[] <- lapply(m2ktrnotes.ppt, as.character)

m2kqerror2_3_3b_endpoint1_notes <- left_join(m2kqerror2_3_3b_endpoint1,m2ktrnotes.ppt,by=c("record_id","redcap_event_name")) %>%
  add_column(QST_test = "PPT") %>%
  as_tibble() %>% 
  mutate_all(as.character)


#render table for ppt test

# error2_3_3b_endpoint1_notes %>%
#   
#   datatable(filter = 'top',class = 'cell-border stripe', options = list(
#     pageLength = 10, autoWidth = TRUE,extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))) %>%
#   formatStyle(columns = colnames(.), fontSize = '10%')


#TS with notes

m2ktr.all.prim.sec.outcome[] <- lapply(m2ktr.all.prim.sec.outcome, as.character)
m2ktrnotes.ts[] <- lapply(m2ktrnotes.ts, as.character)

m2ktr.all.prim.sec.outcome_notes <- left_join(m2ktr.all.prim.sec.outcome,m2ktrnotes.ts,by=c("record_id","redcap_event_name")) %>% 
  add_column(QST_test = "Temporal_Summation") %>%
  as_tibble() %>% 
  mutate_all(as.character)



#render table for ts test
# 
# 
# ts.all.prim.sec.outcome_notes  %>%
#   datatable(filter = 'top',class = 'cell-border stripe', options = list(
#     pageLength = 10, autoWidth = TRUE,extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))) %>%
#   formatStyle(columns = colnames(.), fontSize = '10%')











#cpm with notes

m2ktrall.cmp[] <- lapply(m2ktrall.cmp, as.character)
m2ktrnotes.cpm[] <- lapply(m2ktrnotes.cpm, as.character)

m2ktrall.cmp_notes <- left_join(m2ktrall.cmp,m2ktrnotes.cpm,by=c("record_id","redcap_event_name")) %>%
  add_column(QST_test = "Conditioned_Pain_Modulation") %>%
  as_tibble() %>% 
  mutate_all(as.character)

#render table for cpm test


# all.cmp_notes %>%
#   datatable(filter = 'top',class = 'cell-border stripe', options = list(
#     pageLength = 10, autoWidth = TRUE,extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))) %>%
#   formatStyle(columns = colnames(.), fontSize = '10%')









#create final qst table for the app 



m2ktrqst_table <- full_join(m2ktr.all.prim.sec.outcome_notes,m2kqerror2_3_3b_endpoint1_notes,by = intersect(names(m2ktr.all.prim.sec.outcome_notes), names(m2kqerror2_3_3b_endpoint1_notes
)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2ktrqst_table1 <- full_join(m2ktrqst_table,m2ktrall.cmp_notes,by = intersect(names(m2ktrqst_table), names(m2ktrall.cmp_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2ktr_final_image <-  full_join(m2ktrqst_table1,m2ktrqst.image1,by = intersect(names(m2ktrqst_table1), names(m2ktrqst.image1))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character)%>% 
  left_join(.,m2kdays_from_sysdate, by=c("record_id","redcap_event_name"))




# mcc2 knee blood draw



#Read Data

m2kbrdata <- datam2k 

label(m2kbrdata$record_id)="Record ID"
label(m2kbrdata$redcap_event_name)="Event Name"
label(m2kbrdata$bscp_sample_obtained___1)="7. Blood sample (choice=Not obtained)"
label(m2kbrdata$bscp_time_blood_draw)="Time completed blood draw: "
label(m2kbrdata$bscp_aliq_cnt)="Number of aliquots:"
label(m2kbrdata$bscp_time_centrifuge)="Time completed centrifuging: "
label(m2kbrdata$bscp_aliquot_freezer_time)="Time placed in freezer:"
label(m2kbrdata$bscp_deg_of_hemolysis)="Assess the degree of hemolysis of the plasma (Lavender tube) after centrifugation according to the laminated hemolysis color scale, and record the estimated hemoglobin value in g/L:"
label(m2kbrdata$bscp_lav1_not_obt___1)="Lavender #1: (choice=Not obtained)"
label(m2kbrdata$bscp_paxg_aliq_na___1)="PAXgene DNA tube: (choice=N/A)"
label(m2kbrdata$bscp_protocol_dev)="Did a protocol deviation occur:"
label(m2kbrdata$bscp_protocol_dev_reason)="Reason for protocol deviation:"
label(m2kbrdata$bscp_comments)="Comments"
#Setting Units









#Setting Factors(will create new variable for factors)
m2kbrdata$redcap_event_name.factor = factor(m2kbrdata$redcap_event_name,levels=c("informed_consent_arm_1","baseline_visit_arm_1","3_days_preop_arm_1","day_3_postop_arm_1","day_4_postop_arm_1","day_5_postop_arm_1","day_6_postop_arm_1","day_7_postop_arm_1","day_8_postop_arm_1","day_9_postop_arm_1","day_10_postop_arm_1","day_11_postop_arm_1","day_12_postop_arm_1","day_13_postop_arm_1","day_14_postop_arm_1","day_15_postop_arm_1","day_16_postop_arm_1","day_17_postop_arm_1","day_18_postop_arm_1","day_19_postop_arm_1","day_20_postop_arm_1","day_21_postop_arm_1","day_22_postop_arm_1","day_23_postop_arm_1","day_24_postop_arm_1","day_25_postop_arm_1","day_26_postop_arm_1","day_27_postop_arm_1","day_28_postop_arm_1","6wks_postop_arm_1","3mo_postop_arm_1","6mo_postop_arm_1","6mo_postop_day_1_arm_1","6mo_postop_day_2_arm_1","6mo_postop_day_3_arm_1","6mo_postop_day_4_arm_1","6mo_postop_day_5_arm_1","6mo_postop_day_6_arm_1","6mo_postop_day_7_arm_1","12mo_postop_arm_1","event_reporting_arm_1"))
m2kbrdata$bscp_sample_obtained___1.factor = factor(m2kbrdata$bscp_sample_obtained___1,levels=c("0","1"))
m2kbrdata$bscp_aliq_cnt.factor = factor(m2kbrdata$bscp_aliq_cnt,levels=c("0","1","2","3","4","5","6","7","8"))
m2kbrdata$bscp_deg_of_hemolysis.factor = factor(m2kbrdata$bscp_deg_of_hemolysis,levels=c("0",".25",".5","1","2","4","8"))
m2kbrdata$bscp_lav1_not_obt___1.factor = factor(m2kbrdata$bscp_lav1_not_obt___1,levels=c("0","1"))
m2kbrdata$bscp_paxg_not_obt___1.factor = factor(m2kbrdata$bscp_paxg_not_obt___1,levels=c("0","1"))

m2kbrdata$bscp_paxg_aliq_na___1.factor = factor(m2kbrdata$bscp_paxg_aliq_na___1,levels=c("0","1"))
m2kbrdata$bscp_protocol_dev.factor = factor(m2kbrdata$bscp_protocol_dev,levels=c("1","0"))
m2kbrdata$bscp_protocol_dev_reason.factor = factor(m2kbrdata$bscp_protocol_dev_reason,levels=c("1","2","3"))

levels(m2kbrdata$redcap_event_name.factor)=c("Informed Consent","Baseline Visit","3 Days Pre-Op","Day 3 Post-Op","Day 4 Post-Op","Day 5 Post-Op","Day 6 Post-Op","Day 7 Post-Op","Day 8 Post-Op","Day 9 Post-Op","Day 10 Post-Op","Day 11 Post-Op","Day 12 Post-Op","Day 13 Post-Op","Day 14 Post-Op","Day 15 Post-Op","Day 16 Post-Op","Day 17 Post-Op","Day 18 Post-Op","Day 19 Post-Op","Day 20 Post-Op","Day 21 Post-Op","Day 22 Post-Op","Day 23 Post-Op","Day 24 Post-Op","Day 25 Post-Op","Day 26 Post-Op","Day 27 Post-Op","Day 28 Post-Op","6-Wks Post-Op","3-Mo Post-Op","6-Mo Post-Op","6-Mo Post-Op Day 1","6-Mo Post-Op Day 2","6-Mo Post-Op Day 3","6-Mo Post-Op Day 4","6-Mo Post-Op Day 5","6-Mo Post-Op Day 6","6-Mo Post-Op Day 7","12-Mo Post-Op","Event Reporting")
levels(m2kbrdata$bscp_sample_obtained___1.factor)=c("Unchecked","Checked")
levels(m2kbrdata$bscp_aliq_cnt.factor)=c("0","1","2","3","4","5","6","7","8")
levels(m2kbrdata$bscp_deg_of_hemolysis.factor)=c("0","0.25","0.5","1","2","4","8")
levels(m2kbrdata$bscp_lav1_not_obt___1.factor)=c("Unchecked","Checked")
levels(m2kbrdata$bscp_paxg_aliq_na___1.factor)=c("Unchecked","Checked")
levels(m2kbrdata$bscp_paxg_not_obt___1.factor)=c("Unchecked","Checked")
levels(m2kbrdata$bscp_protocol_dev.factor)=c("Yes","No")
levels(m2kbrdata$bscp_protocol_dev_reason.factor)=c("Unable to obtain blood sample -technical reason","Unable to obtain blood sample -patient related","Sample handling/processing error")







# inspect data

problems(m2kbrdata)

glimpse(m2kbrdata)

# retype m2kbrdata incase future m2kbrdata has problems

m2kbrdata <- retype(m2kbrdata)

# inspect data again to make sure retyping didnt make erroneous assumptions
glimpse(m2kbrdata)






# detailed protocol on pg.230 of MOP



# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)




m2kbrdata1 <- m2kbrdata %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1.factor == "Unchecked" & blood_sample_collection_and_processing_crf_complete == 2)






# format time
m2kbrdata1$bscp_time_blood_draw <- ymd_hms(m2kbrdata1$bscp_time_blood_draw)

m2kbrdata1$bscp_time_centrifuge <- ymd_hms(m2kbrdata1$bscp_time_centrifuge)

m2kbrdata1$bscp_aliquot_freezer_time <- ymd_hms(m2kbrdata1$bscp_aliquot_freezer_time)


#check if blood draw time < centri time < freezer time 
m2kbrdata2 <- m2kbrdata1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor) 



m2kbrflag5 <- m2kbrdata2 %>%
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#missing info on hours since last drink

m2kbrflag6 <- m2kbrdata1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "missing",TRUE ~ as.character(bscp_hrs_since_water))) 






m2kbrflag1_6 <- full_join(m2kbrflag5,m2kbrflag6,by = intersect(names(m2kbrflag5), names(m2kbrflag6))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#missing info on hours since last food


m2kbrflag7 <- m2kbrdata1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "missing",TRUE ~ as.character(bscp_hrs_since_food))) 





m2kbrflag1_7 <- full_join(m2kbrflag1_6,m2kbrflag7,by = intersect(names(m2kbrflag1_6), names(m2kbrflag7))) %>%
  as_tibble() %>% 
  mutate_all(as.character)



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

m2kbrflag8 <- m2kbrdata1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "missing",TRUE ~ as.character(bscp_hrs_since_cafstim)))


m2kbrflag1_8 <- full_join(m2kbrflag1_7,m2kbrflag8,by = intersect(names(m2kbrflag1_7), names(m2kbrflag8))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on amount of caff
m2kbrflag9 <- m2kbrdata1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "missing",TRUE ~ as.character(bscp_caff_cups_amt))) 


m2kbrflag1_9 <- full_join(m2kbrflag1_8,m2kbrflag9,by = intersect(names(m2kbrflag1_8), names(m2kbrflag9 ))) %>%
  as_tibble() %>% 
  mutate_all(as.character)





#missing info on any vacc
m2kbrflag10 <- m2kbrdata1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "missing",TRUE ~ as.character(bscp_any_vacc))) 

m2kbrflag1_10 <- full_join(m2kbrflag1_9,m2kbrflag10,by = intersect(names(m2kbrflag1_9), names(m2kbrflag10)))






# if level of hemolysis was not entered

m2kbrflag11 <- m2kbrdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



m2kbrflag1_11<- full_join(m2kbrflag1_10,m2kbrflag11,by = intersect(names(m2kbrflag1_10), names(m2kbrflag11))) %>%
  as_tibble() %>% 
  mutate_all(as.character)







# if centrifuge time entered but freezing time not entered

m2kbrflag14.1 <- m2kbrdata1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "missing",TRUE ~ as.character(bscp_aliquot_freezer_time))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_aliquot_freezer_time)


m2kbrflag14.1 [] <- lapply(m2kbrflag14.1 , as.character)
m2kbrflag1_11 [] <- lapply(m2kbrflag1_11 , as.character)



m2kbrflag1_14.1<- full_join(m2kbrflag1_11,m2kbrflag14.1,by = intersect(names(m2kbrflag1_11), names(m2kbrflag14.1))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time entered but degree of hemolysis  not entered

m2kbrflag14.2 <- m2kbrdata1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "missing",TRUE ~ as.character(bscp_deg_of_hemolysis))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)




m2kbrflag1_14.1 [] <- lapply(m2kbrflag1_14.1 , as.character)
m2kbrflag14.2 [] <- lapply(m2kbrflag14.2 , as.character)



m2kbrflag1_14.2<- full_join(m2kbrflag1_14.1,m2kbrflag14.2,by = intersect(names(m2kbrflag1_14.1), names(m2kbrflag14.2))) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# if centrifuge time not entered but degree of hemolysis entered

m2kbrflag14.3 <- m2kbrdata1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "missing",TRUE ~ as.character(bscp_time_centrifuge))) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge,bscp_deg_of_hemolysis)



m2kbrflag1_14.2 [] <- lapply(m2kbrflag1_14.2 , as.character)
m2kbrflag14.3 [] <- lapply(m2kbrflag14.3 , as.character)




m2kbrflag1_14<- full_join(m2kbrflag1_14.2,m2kbrflag14.3,by = intersect(names(m2kbrflag1_14.2), names(m2kbrflag14.3))) %>%
  as_tibble() %>% 
  mutate_all(as.character)


#rename columns
m2kbrflag1_14 <- m2kbrflag1_14 %>% 
  rename("Time completed blood draw:"= bscp_time_blood_draw,"Time completed centrifuging:"=bscp_time_centrifuge,
         "Time placed in freezer:"= bscp_aliquot_freezer_time,"Assess the degree of hemolysis of the plasma (Lavender tube)"= bscp_deg_of_hemolysis,
         "hours since water"=bscp_hrs_since_water,"hours since food"=bscp_hrs_since_food,"amount of caffeine"= bscp_caff_cups_amt,
         "Any vaccine in last two weeks"= bscp_any_vacc,"hours since caffiene"=bscp_hrs_since_cafstim) %>%
  as_tibble() %>% 
  mutate_all(as.character)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kbrflag1_14[] <- lapply(m2kbrflag1_14, as.character)

m2kbrflag1_14_shrink <- m2kbrflag1_14 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>%
  as_tibble() %>% 
  mutate_all(as.character)




m2kbrcomments <- m2kbrdata1  %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bscp_comments,bscp_sample_obtained___1.factor,bscp_lav1_not_obt___1.factor,bscp_paxg_aliq_na___1.factor,bscp_protocol_dev.factor,bscp_protocol_dev_reason.factor,bscp_samplekit_brcd)

m2kbrcomments[] <- lapply(m2kbrcomments, as.character)

m2kbrflag1_14_shrink[] <- lapply(m2kbrflag1_14_shrink, as.character)

m2kbrflag_comments <- left_join(m2kbrflag1_14_shrink,m2kbrcomments,by = intersect(names(m2kbrflag1_14_shrink), names(m2kbrcomments))) %>% 
  rename("Blood sample (choice=Not obtained)"= bscp_sample_obtained___1.factor,
         "Lavender #1: (choice=Not obtained)"= bscp_lav1_not_obt___1.factor,
         "PAXgene DNA tube: (choice=N/A)"= bscp_paxg_aliq_na___1.factor,
         "Did a protocol deviation occur:"= bscp_protocol_dev.factor,
         "Reason for protocol deviation:"= bscp_protocol_dev_reason.factor,
         "Comments"= bscp_comments,"sample kit barcode" = bscp_samplekit_brcd) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  left_join(.,m2kdays_from_sysdate, by=c("record_id","redcap_event_name")) 






m2kfrfunc_table <- m2kfrfunc_table %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group))

m2kirerror1_2_3_4_5_6_7_8_notes<- m2kirerror1_2_3_4_5_6_7_8_notes %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group))

m2ktr_final_image <- m2ktr_final_image %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group)) %>% 
  relocate(QST_test, .after = last_col()) %>% 
  mutate(QST_test=as.factor(QST_test))

m2kbrflag_comments<- m2kbrflag_comments %>% 
  mutate(redcap_data_access_group=as.factor(redcap_data_access_group))

### mcc2 knee surveys
# Ask hablar to guess most appropriate datatype

# mcc2 knee bpi

m2kappdata.bpi <- retype(datam2k)




#Check for subjects who did not complete the test.
table(m2kappdata.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)


#remove records with missing values for test completed.
m2kappdata.bpi2 <- m2kappdata.bpi %>% 
  drop_na(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete)


#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2kappdata.bpi2$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)


#keep records for subjects who completed the test.
m2kappdata.bpi3 <- m2kappdata.bpi2 %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2)

#check
table(m2kappdata.bpi3$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete, exclude = NULL)



#if  average pain at a site was indicated but length of time was not indicated


m2kerror.bpi1 <- m2kappdata.bpi3 %>%
  filter((!is.na(bpi_mbm_z1_rate) & bpi_mbm_z1_rate > 0 & is.na(bpi_mbm_z1_dur)) |(!is.na(bpi_mbm_z2_rate) & bpi_mbm_z2_rate > 0 & is.na(bpi_mbm_z2_dur)) |
           (!is.na(bpi_mbm_z3_rate) & bpi_mbm_z3_rate > 0 & is.na(bpi_mbm_z3_dur)) |(!is.na(bpi_mbm_z4_rate) & bpi_mbm_z4_rate > 0 & is.na(bpi_mbm_z4_dur)) |
           (!is.na(bpi_mbm_z5_rate) & bpi_mbm_z5_rate > 0 & is.na(bpi_mbm_z5_dur))|(!is.na(bpi_mbm_z6_rate) & bpi_mbm_z6_rate > 0 & is.na(bpi_mbm_z6_dur))|
           (!is.na(bpi_mbm_z7_rate) & bpi_mbm_z7_rate > 0 & is.na(bpi_mbm_z7_dur))|(!is.na(bpi_mbm_z8_rate) & bpi_mbm_z8_rate > 0 & is.na(bpi_mbm_z8_dur)) | 
           (!is.na(bpi_mbm_z9_rate) & bpi_mbm_z9_rate > 0 & is.na(bpi_mbm_z9_dur))) %>% 
  select(record_id,redcap_event_name,bpi_mbm_z1_rate,bpi_mbm_z1_dur,bpi_mbm_z2_rate,bpi_mbm_z2_dur,bpi_mbm_z3_rate,bpi_mbm_z3_dur,bpi_mbm_z4_rate,bpi_mbm_z4_dur,bpi_mbm_z5_rate,
         bpi_mbm_z5_dur,bpi_mbm_z6_rate,bpi_mbm_z6_dur,bpi_mbm_z7_rate,bpi_mbm_z7_dur,bpi_mbm_z8_rate,bpi_mbm_z8_dur,bpi_mbm_z9_rate,bpi_mbm_z9_dur) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpi_mbm_z1 = case_when((is.na(bpi_mbm_z1_rate) & !is.na(bpi_mbm_z1_dur)) | (!is.na(bpi_mbm_z1_rate) & is.na(bpi_mbm_z1_dur))  ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z2 = case_when((is.na(bpi_mbm_z2_rate) & !is.na(bpi_mbm_z2_dur))| (!is.na(bpi_mbm_z2_rate) & is.na(bpi_mbm_z2_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z3 = case_when((is.na(bpi_mbm_z3_rate) & !is.na(bpi_mbm_z3_dur))| (!is.na(bpi_mbm_z3_rate) & is.na(bpi_mbm_z3_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z4 = case_when((is.na(bpi_mbm_z4_rate) & !is.na(bpi_mbm_z4_dur)) |(!is.na(bpi_mbm_z4_rate) & is.na(bpi_mbm_z4_dur))~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z5 = case_when((is.na(bpi_mbm_z5_rate) & !is.na(bpi_mbm_z5_dur))| (!is.na(bpi_mbm_z5_rate) & is.na(bpi_mbm_z5_dur))~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z6 = case_when((is.na(bpi_mbm_z6_rate) & !is.na(bpi_mbm_z6_dur))|(!is.na(bpi_mbm_z6_rate) & is.na(bpi_mbm_z6_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z7 = case_when((is.na(bpi_mbm_z7_rate) & !is.na(bpi_mbm_z7_dur))|(!is.na(bpi_mbm_z7_rate) & is.na(bpi_mbm_z7_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z8 = case_when((is.na(bpi_mbm_z8_rate) & !is.na(bpi_mbm_z8_dur))|(!is.na(bpi_mbm_z8_rate) & is.na(bpi_mbm_z8_dur)) ~ "x",TRUE ~ "1")) %>% 
  mutate(bpi_mbm_z9 = case_when((is.na(bpi_mbm_z9_rate) & !is.na(bpi_mbm_z9_dur)) |(!is.na(bpi_mbm_z9_rate) & is.na(bpi_mbm_z9_dur)) ~ "x",TRUE ~ "1")) %>% 
  select(record_id,redcap_event_name,bpi_mbm_z1,bpi_mbm_z2,bpi_mbm_z3,bpi_mbm_z4,bpi_mbm_z5,bpi_mbm_z6,bpi_mbm_z7,bpi_mbm_z8,bpi_mbm_z9)



# missing pain interference score
m2kerror.bpi2 <- m2kappdata.bpi3 %>%
  select(record_id,redcap_event_name,bpipainintrfrscore) %>% 
  filter(is.na(bpipainintrfrscore)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bpipainintrfrscore = case_when(is.na(bpipainintrfrscore) ~ "x"))

m2kerrorbpi1_2 <- full_join(m2kerror.bpi1,m2kerror.bpi2,by = intersect(names(m2kerror.bpi1), names(m2kerror.bpi2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols=3:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2kbpi_complete = 0) %>% # added new step here
  as_tibble() %>% 
  mutate_all(as.character) 



glimpse(m2kerrorbpi1_2)



# recode 0,1 ie incomplete/unverified to 2
m2kerror.bpi3 <- m2kappdata.bpi %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 0 |bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 1) %>% 
  mutate(m2kbpi_complete = case_when(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 0 |bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete== 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kbpi_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character)


table(m2kerror.bpi3$m2kbpi_complete)



#merge all
m2kerrorbpi1_3 <- full_join(m2kerrorbpi1_2,m2kerror.bpi3,by = intersect(names(m2kerrorbpi1_2), names(m2kerror.bpi3))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")

table(m2kerrorbpi1_3$m2kbpi_complete)



# recode NAs to 8 in the original dataset, select DAG as well
m2kdata.bpi <- datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete = case_when(is.na(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) ~ "8", TRUE ~ as.character(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) 


table(m2kdata.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,exclude = NULL)





#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerrorbpi1_3[m2kerrorbpi1_3== ""] <- NA


m2kerrorbpi1_3 <- m2kerrorbpi1_3 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>%
  as_tibble() %>% 
  mutate_all(as.character)




# bpi_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_bpi <- full_join(m2kdata.bpi,m2kerrorbpi1_3,by = intersect(names(m2kdata.bpi), names(m2kerrorbpi1_3))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kbpi_complete = case_when(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete  == "8" ~ "8", TRUE ~ as.character(m2kbpi_complete))) %>% 
  replace(is.na(.), "1") %>% 
  select(-bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




table(m2kfull_bpi$m2kbpi_complete,exclude = NULL) 





# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
m2kdat.bpi <- m2kfull_bpi %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_BPI") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kbpi_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_BPI") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.bpi = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


m2kdata_bpi <- m2kdat.bpi %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdata_bpi$m2kb.bpi) 
table(m2kappdata.bpi$bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,exclude = NULL) 




# mcc2 knee koos


#Read Data

m2kdata.koos <- datam2k
# data.koos <- list.files(path = here("data"),
#                pattern = "^A2CPSMainStudy-KOOS_DATA", 
#                full.names = T) %>% 
#     map_df(~read_csv(.))











# Ask hablar to guess most appropriate datatype
m2kdata.koos <- retype(m2kdata.koos)








names(m2kdata.koos)

#Check for subjects who did not complete the survey.
table(m2kdata.koos$knee_injury_osteoarthritis_outcome_score_koos12_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kdata.koos2 <- m2kdata.koos %>% 
  drop_na(knee_injury_osteoarthritis_outcome_score_koos12_complete)






#Recheck if all records with missing data for completed tests were removed.
table(m2kdata.koos2$knee_injury_osteoarthritis_outcome_score_koos12_complete, exclude = NULL)






#keep records for subjects who completed the test, where 2 is complete and 0 is incomplete
m2kdata.koos3 <- m2kdata.koos2 %>% 
  filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 2)

#check
table(m2kdata.koos3$knee_injury_osteoarthritis_outcome_score_koos12_complete, exclude = NULL)





#if transformed scores were missing

#summary score
m2kerror.koos1 <- m2kdata.koos3 %>%
  filter(is.na(koossummaryscore)) %>% 
  select(record_id,redcap_event_name,koossummaryscore) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koossummaryscore = case_when((is.na(koossummaryscore))  ~ "x",TRUE ~ "1")) 

#pain score
m2kerror.koos2 <- m2kdata.koos3 %>%
  filter(is.na(koospainscoret)) %>% 
  select(record_id,redcap_event_name,koospainscoret) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koospainscoret = case_when((is.na(koospainscoret))  ~ "x",TRUE ~ "1")) 

# function score 
m2kerror.koos3 <- m2kdata.koos3 %>%
  filter(is.na(koosfunctionscoret)) %>% 
  select(record_id,redcap_event_name,koosfunctionscoret) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koosfunctionscoret = case_when((is.na(koosfunctionscoret))  ~ "x",TRUE ~ "1")) 


# qol score
m2kerror.koos4 <- m2kdata.koos3 %>%
  filter(is.na(koosqolscoret)) %>% 
  select(record_id,redcap_event_name,koosqolscoret) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(koosqolscoret = case_when((is.na(koosqolscoret))  ~ "x",TRUE ~ "1")) 






# recode 0,1 ie incomplete/unverified to 2
m2kerror.koos5 <- m2kdata.koos %>% 
  filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 0 |knee_injury_osteoarthritis_outcome_score_koos12_complete == 1) %>% 
  mutate(m2kkoos12_complete = case_when(knee_injury_osteoarthritis_outcome_score_koos12_complete == 1 | knee_injury_osteoarthritis_outcome_score_koos12_complete == 0 ~ 2)) %>%    
  select(record_id,redcap_event_name,m2kkoos12_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 







m2kerror.koos1_2 <- full_join(m2kerror.koos1,m2kerror.koos2,by = intersect(names(m2kerror.koos1), names(m2kerror.koos2)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

m2kerror.koos1_3 <- full_join(m2kerror.koos1_2,m2kerror.koos3,by = intersect(names(m2kerror.koos1_2), names(m2kerror.koos3)))   %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

m2kerror.koos1_4 <- full_join(m2kerror.koos1_3,m2kerror.koos4,by = intersect(names(m2kerror.koos1_3), names(m2kerror.koos4))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols=3:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2kkoos12_complete = 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  

m2kerror.koos1_5 <- full_join(m2kerror.koos1_4,m2kerror.koos5,by = intersect(names(m2kerror.koos1_4), names(m2kerror.koos5)))%>% 
  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")





# recode NAs to 8 in the original dataset, select DAG as well

m2kdata.koos1 <-m2kdata.koos %>%
  as_tibble() %>%
  mutate_all(as.character)  %>% 
  mutate(knee_injury_osteoarthritis_outcome_score_koos12_complete = case_when(is.na(knee_injury_osteoarthritis_outcome_score_koos12_complete) ~ "8", TRUE ~ as.character(knee_injury_osteoarthritis_outcome_score_koos12_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 






#ensure each combination of ID and redcap event has one row with all values and is not duplicated



m2kerror.koos1_5[m2kerror.koos1_5== ""] <- NA

m2kerror.koos1_5 <- m2kerror.koos1_5 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#recode koos12_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)

m2kfull_koos <- full_join(m2kdata.koos1,m2kerror.koos1_5,by = intersect(names(m2kdata.koos1), names(m2kerror.koos1_5))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kkoos12_complete = case_when(knee_injury_osteoarthritis_outcome_score_koos12_complete == "8" ~ "8", TRUE ~ as.character(m2kkoos12_complete))) %>%  
  replace(is.na(.), "1") %>% 
  select(-knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


table(m2kfull_koos$m2kkoos12_complete,exclude = NULL)




m2kdat.koos <- m2kfull_koos %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_KOOS") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kkoos12_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_KOOS") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.koos = case_when(error == "clean" ~ 1,
                               error == 2 ~ 2,
                               error == 8 ~ 8,
                               TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


m2kdata_koos <- m2kdat.koos %>%
  pivot_wider (names_from = dataset,values_from = error) 


table(m2kdata_koos$m2kb.koos)

table(datam2k$knee_injury_osteoarthritis_outcome_score_koos12_complete,exclude = NULL)








#ANXIETY




m2kdata.anxiety <- datam2k 









#Check for subjects who did not complete the test.
table(m2kdata.anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kdata.anxiety2 <- m2kdata.anxiety %>% 
  drop_na(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete)






#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2kdata.anxiety2$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2kdata.anxiety3 <- m2kdata.anxiety2 %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 2)

#check
table(m2kdata.anxiety3$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete, exclude = NULL)


m2kerror.anxiety.1.1 <- m2kdata.anxiety3 %>% 
  select(record_id,redcap_event_name,starts_with("gad"),-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,-gad7difficulttowork) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("gad"), ~ifelse(!is.na(.x),"1","x"))) 

m2kerror.anxiety.1.2 <- m2kdata.anxiety3 %>% 
  select(record_id,redcap_event_name,starts_with("gad"),-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(gad2feelnervscl !="0"  | gad2notstopwryscl!="0" | gad7wrytoomchscl !="0" | gad7troubrelxscl !="0" | gad7rstlessscl !="0" | gad7easyannoyedscl !="0" | gad7feelafrdscl !="0") %>% 
  filter(is.na(gad7difficulttowork)) %>% 
  select(record_id,redcap_event_name,gad7difficulttowork) %>% 
  mutate(gad7difficulttowork = replace_na(gad7difficulttowork, "x"))


m2kerror.anxiety1  <- full_join(m2kerror.anxiety.1.1 ,m2kerror.anxiety.1.2 ,by = intersect(names(m2kerror.anxiety.1.1 ), names(m2kerror.anxiety.1.2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# recode 0,1 ie incomplete/unverified to 2

m2kerror.anxiety2 <- m2kdata.anxiety %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 0 |generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 1) %>% 
  mutate(m2kanxiety_complete = case_when(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 0 |generalized_anxiety_disorder_7_item_gad7_scale_sco_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kanxiety_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#merge all
m2kerroranxiety1_2 <- full_join(m2kerror.anxiety1,m2kerror.anxiety2,by = intersect(names(m2kerror.anxiety1), names(m2kerror.anxiety2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_anxiety <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete = case_when(is.na(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) ~ "8", TRUE ~      as.character(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) 


table(m2kdata_anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,exclude = NULL)





#ensure each combination of ID and redcap event has one row with all values and is not duplicated




m2kerroranxiety1_2[m2kerroranxiety1_2== ""] <- NA

m2kerroranxiety1_2 <- m2kerroranxiety1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(m2kerroranxiety1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_anxiety <- full_join(m2kdata_anxiety,m2kerroranxiety1_2,by = intersect(names(m2kdata_anxiety), names(m2kerroranxiety1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kanxiety_complete = case_when(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete  == "8" ~ "8", TRUE ~ as.character(m2kanxiety_complete))) %>% 
  filter(!is.na(m2kanxiety_complete)) %>% # If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  replace(is.na(.), "1") %>% 
  select(-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))











m2kdat.anxiety <- m2kfull_anxiety %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_Anxiety") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kanxiety_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_Anxiety") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.anxiety = case_when(error == "clean" ~ 1,
                                  error == 2 ~ 2,
                                  error == 8 ~ 8,
                                  TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2kdata.anxiety_wide <- m2kdat.anxiety %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdat.anxiety$m2kb.anxiety)


table(m2kdata.anxiety$generalized_anxiety_disorder_7_item_gad7_scale_sco_complete,exclude = NULL)



# depression


m2kdata.dep <- datam2k


#Check for subjects who did not complete the test.
table(m2kdata.dep$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kdata.dep2 <- m2kdata.dep %>% 
  drop_na(patient_health_questionnaire_depression_scale_phq_complete)


#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2kdata.dep2$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)


#keep records for subjects who completed the test.
m2kdata.dep3 <- m2kdata.dep2 %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete == 2)

#check
table(m2kdata.dep3$patient_health_questionnaire_depression_scale_phq_complete, exclude = NULL)



m2kerror.dep1 <- m2kdata.dep3 %>% 
  select(record_id,redcap_event_name,starts_with("phq"),-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("phq"), ~ifelse(!is.na(.x),"1","x"))) 


m2kerror.dep2 <- m2kdata.dep %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete == 0 |patient_health_questionnaire_depression_scale_phq_complete == 1) %>% 
  mutate(m2kdep_complete = case_when(patient_health_questionnaire_depression_scale_phq_complete == 0 |patient_health_questionnaire_depression_scale_phq_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kdep_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

table(m2kerror.dep2$m2kdep_complete)



m2kerrordep1_2 <- full_join(m2kerror.dep1,m2kerror.dep2,by = intersect(names(m2kerror.dep1), names(m2kerror.dep2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")

# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_dep <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(patient_health_questionnaire_depression_scale_phq_complete = case_when(is.na(patient_health_questionnaire_depression_scale_phq_complete) ~ "8", TRUE ~ as.character(patient_health_questionnaire_depression_scale_phq_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,patient_health_questionnaire_depression_scale_phq_complete) 


table(m2kdata_dep$patient_health_questionnaire_depression_scale_phq_complete,exclude = NULL)



#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerrordep1_2[m2kerrordep1_2== ""] <- NA

m2kerrordep1_2 <- m2kerrordep1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_dep <- full_join(m2kdata_dep,m2kerrordep1_2,by = intersect(names(m2kdata_dep), names(m2kerrordep1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kdep_complete = case_when(patient_health_questionnaire_depression_scale_phq_complete  == "8" ~ "8", TRUE ~ as.character(m2kdep_complete))) %>% 
  filter(!is.na(m2kdep_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))






m2kdat.dep <- m2kfull_dep %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_Depression") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kdep_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_Depression") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.dep = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2kdata.dep_wide <- m2kdat.dep %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(m2kdata.dep_wide$m2kb.dep)

table(datam2k$patient_health_questionnaire_depression_scale_phq_complete,exclude = NULL)


###############################


#Read Data

m2kdata.cat <- datam2k


m2kdata.cat <- retype(m2kdata.cat)



#Check for subjects who did not complete the test.
table(m2kdata.cat$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)


#remove records with missing values for test completed.
m2kdata.cat2 <- m2kdata.cat %>% 
  drop_na(pain_catastrophizing_questionnaire_pcs6_complete)



#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2kdata.cat2$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)


#keep records for subjects who completed the test.
m2kdata.cat3 <- m2kdata.cat2 %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete == 2)

#check
table(m2kdata.cat3$pain_catastrophizing_questionnaire_pcs6_complete, exclude = NULL)


m2kerror.cat1 <- m2kdata.cat3 %>% 
  select(record_id,redcap_event_name,-pain_catastrophizing_questionnaire_pcs6_complete,starts_with("pcq")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("pcq"), ~ifelse(!is.na(.x),"1","x"))) 



m2kerror.cat2 <- m2kdata.cat2 %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete == 0 |pain_catastrophizing_questionnaire_pcs6_complete == 1 ) %>% 
  mutate(m2kcat_complete = case_when(pain_catastrophizing_questionnaire_pcs6_complete == 0 |pain_catastrophizing_questionnaire_pcs6_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kcat_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  

table(m2kerror.cat2$m2kcat_complete)


m2kerrorcat1_2 <- full_join(m2kerror.cat1,m2kerror.cat2,by = intersect(names(m2kerror.cat1), names(m2kerror.cat2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")


table(m2kerrorcat1_2$m2kcat_complete)




# recode NAs to 8 in the original dataset, select DAG as well

m2kdata.cat1 <-m2kdata.cat %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(pain_catastrophizing_questionnaire_pcs6_complete = case_when(is.na(pain_catastrophizing_questionnaire_pcs6_complete) ~ "8", TRUE ~ as.character(pain_catastrophizing_questionnaire_pcs6_complete))) %>%
  select(record_id,redcap_event_name,redcap_data_access_group,pain_catastrophizing_questionnaire_pcs6_complete)

table(m2kdata.cat1$pain_catastrophizing_questionnaire_pcs6_complete)




m2kerrorcat1_2[m2kerrorcat1_2== ""] <- NA

m2kerrorcat1_2 <- m2kerrorcat1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(m2kerrorcat1_2$m2kcat_complete,exclude = NULL)




#recode koos12_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)


m2kfull_cat <- full_join(m2kdata.cat1,m2kerrorcat1_2,by = intersect(names(m2kdata.cat1), names(m2kerrorcat1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kcat_complete = case_when(pain_catastrophizing_questionnaire_pcs6_complete  == "8" ~ "8", TRUE ~ as.character(m2kcat_complete))) %>% 
  filter(!is.na(m2kcat_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


table(m2kfull_cat$m2kcat_complete,exclude = NULL)


m2kdat.cat <- m2kfull_cat %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_Catastrophizing") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kcat_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_Catastrophizing") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.cat = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2kdata.cat_wide <- m2kdat.cat %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdata.cat_wide$m2kb.cat)


table(datam2k$pain_catastrophizing_questionnaire_pcs6_complete,exclude = NULL)




#Read Data

m2kdata.move <- datam2k



#begin checks for uchicago
# data.anxiety <- data.anxiety %>%
#   filter(redcap_data.anxiety_access_group == "uchicago")


# Ask hablar to guess most appropriate datatype
m2kdata.move  <- retype(m2kdata.move)



#Check for subjects who did not complete the test.
table(m2kdata.move$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)


#remove records with missing values for test completed.
m2kdata.move2 <- m2kdata.move %>% 
  drop_na(fearavoidance_beliefs_questionnaire_v03_fabq_complete)



#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2kdata.move2$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)


#keep records for subjects who completed the test.
m2kdata.move3 <- m2kdata.move2 %>% 
  filter(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 2)

#check
table(m2kdata.move3$fearavoidance_beliefs_questionnaire_v03_fabq_complete, exclude = NULL)



m2kerror.move1 <- m2kdata.move3 %>% 
  select(record_id,redcap_event_name,-fearavoidance_beliefs_questionnaire_v03_fabq_complete,starts_with("fabq")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("fabq"), ~ifelse(!is.na(.x),"1","x"))) 



m2kerror.move2 <- m2kdata.move %>% 
  filter(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 0 |fearavoidance_beliefs_questionnaire_v03_fabq_complete == 1) %>% 
  mutate(m2kFearMovement_complete = case_when(fearavoidance_beliefs_questionnaire_v03_fabq_complete == 0 |fearavoidance_beliefs_questionnaire_v03_fabq_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kFearMovement_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  



m2kerrormove1_2 <- full_join(m2kerror.move1,m2kerror.move2,by = intersect(names(m2kerror.move1), names(m2kerror.move2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")




m2kerrormove1_2[m2kerrormove1_2== ""] <- NA

m2kerrormove1_2 <- m2kerrormove1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(m2kerrormove1_2$m2kFearMovement_complete)





m2kdata.move1 <-m2kdata.move %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(fearavoidance_beliefs_questionnaire_v03_fabq_complete = case_when(is.na(fearavoidance_beliefs_questionnaire_v03_fabq_complete) ~ "8", TRUE ~ as.character(fearavoidance_beliefs_questionnaire_v03_fabq_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fearavoidance_beliefs_questionnaire_v03_fabq_complete) 


table(m2kdata.move1$fearavoidance_beliefs_questionnaire_v03_fabq_complete,exclude = NULL)




# bpi_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_move <- full_join(m2kdata.move1,m2kerrormove1_2,by = intersect(names(m2kdata.move1), names(m2kerrormove1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kFearMovement_complete = case_when(fearavoidance_beliefs_questionnaire_v03_fabq_complete  == "8" ~ "8", TRUE ~ as.character(m2kFearMovement_complete))) %>% 
  filter(!is.na(m2kFearMovement_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-fearavoidance_beliefs_questionnaire_v03_fabq_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))



table(m2kfull_move$m2kFearMovement_complete,exclude = NULL) 


m2kdat.move <- m2kfull_move  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_FearMovement") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kFearMovement_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_FearMovement") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.move = case_when(error == "clean" ~ 1,
                               error == 2 ~ 2,
                               error == 8 ~ 8,
                               TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2kdata.move_wide <- m2kdat.move %>%
  pivot_wider (names_from = dataset,values_from = error)


table(m2kdat.move$m2kb.move,exclude = NULL) 

table(datam2k$fearavoidance_beliefs_questionnaire_v03_fabq_complete,exclude = NULL)





#Read Data

m2kdata.sleep1 <- datam2k





# checking func access sites

m2kdata.sleep  <- retype(m2kdata.sleep1) %>% 
  select(record_id,redcap_event_name,starts_with("promis"))


#Check for subjects who did not complete the test.
table(m2kdata.sleep$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kdata.sleep2 <- m2kdata.sleep %>% 
  drop_na(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete)


#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2kdata.sleep2$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)






#keep records for subjects who completed the test.
m2kdata.sleep3 <- m2kdata.sleep2 %>% 
  filter(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 2)

#check
table(m2kdata.sleep3$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete, exclude = NULL)






m2kerror.sleep1 <- m2kdata.sleep3 %>% 
  select(-promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,promissleepwasrefreshscl,promisproblemwithslpscl,promisdifficltfallaslpscl,promisslpwasrestlessscl,promistryhardgettoslpscl, promissleepqualityscl) %>% 
  mutate(across(starts_with("promis"), ~ifelse(!is.na(.x),"1","x"))) 



m2kerror.sleep2 <- m2kdata.sleep %>% 
  filter(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 0 |promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 1) %>% 
  mutate(m2ksleep_complete = case_when(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 0 |promis_sf_v10_sleep_disturbance_6a_sleep_i_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2ksleep_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2kerrorsleep1_2 <- full_join(m2kerror.sleep1,m2kerror.sleep2,by = intersect(names(m2kerror.sleep1), names(m2kerror.sleep2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_slp <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete = case_when(is.na(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) ~ "8", TRUE ~ as.character(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,promis_sf_v10_sleep_disturbance_6a_sleep_i_complete)


table(m2kdata_slp$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete,exclude = NULL)




m2kerrorsleep1_2[m2kerrorsleep1_2== ""] <- NA
m2kerrorsleep1_2 <- m2kerrorsleep1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_slp <- full_join(m2kdata_slp,m2kerrorsleep1_2,by = intersect(names(m2kdata_slp), names(m2kerrorsleep1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2ksleep_complete = case_when(promis_sf_v10_sleep_disturbance_6a_sleep_i_complete  == "8" ~ "8", TRUE ~ as.character(m2ksleep_complete))) %>% 
  filter(!is.na(m2ksleep_complete)) %>% 
  replace(is.na(.), "1") %>% 
  select(-promis_sf_v10_sleep_disturbance_6a_sleep_i_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))





table(m2kfull_slp$m2ksleep_complete,exclude = NULL) 



m2kdat.sleep <- m2kfull_slp %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset ="MCC2_TKA_Promis_Sleep") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2ksleep_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_Promis_Sleep") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.sleep = case_when(error == "clean" ~ 1,
                                error == 2 ~ 2,
                                error == 8 ~ 8,
                                TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))






m2kdata.sleep_wide <- m2kdat.sleep %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(m2kdata.sleep_wide$m2kb.sleep)

table(datam2k$promis_sf_v10_sleep_disturbance_6a_sleep_i_complete,exclude = NULL)




#Read Data

m2kdata.sleep_hours1 <-   datam2k1 %>% 
  
  mutate(sleepnighthourmindurhrs = as.numeric(sleepnighthourmindurhrs)) %>% 
  mutate(sleepnighthourmindurmins= as.numeric(sleepnighthourmindurmins)) %>% 
  mutate(sleepnighthourmindur = as.numeric(sleepnighthourmindur)) 



m2kdata.sleep_hours <- m2kdata.sleep_hours1 %>% 
  filter(!record_id %in% withdrawm2k & !record_id %in% test_records) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur,painsleep_duration_sleep_ii_complete) 


# event <- c("baseline_visit_arm_1","6wks_postop_arm_1",	
#            "3mo_postop_arm_1","6mo_postop_arm_1","12mo_postop_arm_1")
# data.sleep_hours <- data.sleep_hours %>% 
#   filter(redcap_event_name %in% event)

names(m2kdata.sleep_hours)

#Check for subjects who did not complete the test.
table(m2kdata.sleep_hours$painsleep_duration_sleep_ii_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kdata.sleep_hours2 <- m2kdata.sleep_hours %>% 
  drop_na(painsleep_duration_sleep_ii_complete)



#Recheck if all records with missing data.anxiety for completed tests were removed.
table(m2kdata.sleep_hours2$painsleep_duration_sleep_ii_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2kdata.sleep_hours3 <- m2kdata.sleep_hours2 %>% 
  filter(painsleep_duration_sleep_ii_complete == 2)

#check
table(m2kdata.sleep_hours3$painsleep_duration_sleep_ii_complete, exclude = NULL)



m2kerror.sleep_hours1 <- m2kdata.sleep_hours3 %>% 
  select(-painsleep_duration_sleep_ii_complete) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(empty_1 = case_when(is.na(sleepnighthourmindurhrs) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_2 = case_when(is.na(sleepnighthourmindur) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_3 = case_when(is.na(sleepnighthourmindurmins) ~ "x", TRUE ~ "1")) %>% 
  mutate(empty_4= case_when(empty_1 == "x" & empty_2 == "x" & empty_3 == "x" ~ "x",TRUE ~ "1")) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,empty_4) %>% 
  rename("sleepnighthourmindur"= empty_4) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



m2kerror.sleep_hours2 <- m2kdata.sleep_hours %>% 
  filter(painsleep_duration_sleep_ii_complete ==0 |painsleep_duration_sleep_ii_complete == 1) %>% 
  mutate(m2ksleep_hours_complete = case_when(painsleep_duration_sleep_ii_complete == 0 |painsleep_duration_sleep_ii_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2ksleep_hours_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2kerrorsleep_hours1_2 <- full_join(m2kerror.sleep_hours1,m2kerror.sleep_hours2,by = intersect(names(m2kerror.sleep_hours1), names(m2kerror.sleep_hours2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1")



# recode NAs to 8 in the original dataset, select DAG as well
m2kdata.slp_hours <- m2kdata.sleep_hours %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(painsleep_duration_sleep_ii_complete = case_when(is.na(painsleep_duration_sleep_ii_complete) ~ "8", TRUE ~ as.character(painsleep_duration_sleep_ii_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,painsleep_duration_sleep_ii_complete) 



table(m2kdata.slp_hours$painsleep_duration_sleep_ii_complete,exclude = NULL)




m2kerrorsleep_hours1_2[m2kerrorsleep_hours1_2== ""] <- NA
m2kerrorsleep_hours1_2 <- m2kerrorsleep_hours1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_slp_hrs <- full_join(m2kdata.slp_hours,m2kerrorsleep_hours1_2,by = intersect(names(m2kdata.slp_hours), names(m2kerrorsleep_hours1_2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2ksleep_hours_complete= case_when(painsleep_duration_sleep_ii_complete  == "8" ~ "8", TRUE ~ as.character(m2ksleep_hours_complete))) %>% 
  filter(!is.na(m2ksleep_hours_complete)) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-painsleep_duration_sleep_ii_complete)



table(m2kfull_slp_hrs$m2ksleep_hours_complete,exclude = NULL) 





m2kdat.sleep_hours <- m2kfull_slp_hrs  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_sleep_hours") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2ksleep_hours_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_sleep_hours") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.sleep_hours = case_when(error == "clean" ~ 1,
                                      error == 2 ~ 2,
                                      error == 8 ~ 8,
                                      TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2kdata.sleep_hours_wide <- m2kdat.sleep_hours %>%
  pivot_wider (names_from = dataset,values_from = error) 


table(m2kdata.sleep_hours_wide$m2kb.sleep_hours)

table(m2kdata.sleep_hours$painsleep_duration_sleep_ii_complete,exclude = NULL)

########## Read Data cognition   ##########



# Ask hablar to guess most appropriate datatype
m2kappdata.cog <- retype(datam2k)


#Check for subjects who did not complete the test.
table(m2kappdata.cog$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)


#remove records with missing values for test completed.
m2kappdata.cog2 <- m2kappdata.cog %>% 
  drop_na(multidimensional_inventory_of_subjective_cognitive_complete)


#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2kappdata.cog2$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)


#keep records for subjects who completed the test.
m2kappdata.cog3 <- m2kappdata.cog2 %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete== 2)

#check
table(m2kappdata.cog3$multidimensional_inventory_of_subjective_cognitive_complete, exclude = NULL)



m2kerror.cog1 <- m2kappdata.cog3 %>% 
  select(record_id,redcap_event_name,-multidimensional_inventory_of_subjective_cognitive_complete,starts_with("misc")) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("misc"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2kerror.cog2 <- m2kappdata.cog %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete == 0 | multidimensional_inventory_of_subjective_cognitive_complete == 1) %>% 
  mutate(m2kcog_complete = case_when(multidimensional_inventory_of_subjective_cognitive_complete == 0 | multidimensional_inventory_of_subjective_cognitive_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kcog_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)

table(m2kerror.cog2$m2kcog_complete)


#merge all
m2kerrorcog1_2 <- full_join(m2kerror.cog1,m2kerror.cog2,by = intersect(names(m2kerror.cog1), names(m2kerror.cog2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 


table(m2kerrorcog1_2$m2kcog_complete, exclude = NULL)




# recode NAs to 8 in the original dataset, select DAG as well
m2kappdata.cog <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(multidimensional_inventory_of_subjective_cognitive_complete = case_when(is.na(multidimensional_inventory_of_subjective_cognitive_complete) ~ "8", TRUE ~ as.character(multidimensional_inventory_of_subjective_cognitive_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,multidimensional_inventory_of_subjective_cognitive_complete) 


table(m2kappdata.cog$multidimensional_inventory_of_subjective_cognitive_complete,exclude = NULL)


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerrorcog1_2[m2kerrorcog1_2== ""] <- NA

m2kerrorcog1_2 <- m2kerrorcog1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_cog <- full_join(m2kappdata.cog,m2kerrorcog1_2,by = intersect(names(m2kappdata.cog), names(m2kerrorcog1_2))) %>% 
  mutate(m2kcog_complete = case_when(multidimensional_inventory_of_subjective_cognitive_complete == "8" ~ "8", TRUE ~ as.character(m2kcog_complete))) %>% 
  filter(!is.na(m2kcog_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))


m2kdat.cog <- m2kfull_cog %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_cognition") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kcog_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_cognition") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.cog = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2kdata.cog_wide <- m2kdat.cog %>%
  pivot_wider (names_from = dataset,values_from = error) 


table(m2kdat.cog$m2kb.cog,exclude = NULL)

table(datam2k$multidimensional_inventory_of_subjective_cognitive_complete ,exclude = NULL)


########## Read Data Resilience   ##########



# Ask hablar to guess most appropriate datatype
m2kappdata.res <- retype(datam2k)


#Check for subjects who did not complete the test.
table(m2kappdata.res$pain_resilience_scale_prs_complete, exclude = NULL)


#remove records with missing values for test completed.
m2kappdata.res2 <- m2kappdata.res %>% 
  drop_na(pain_resilience_scale_prs_complete)



#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2kappdata.res2$pain_resilience_scale_prs_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2kappdata.res3 <- m2kappdata.res2 %>% 
  filter(pain_resilience_scale_prs_complete== 2)

#check
table(m2kappdata.res3$pain_resilience_scale_prs_complete, exclude = NULL)


m2kappdata.res3 <- m2kappdata.res3 %>% 
  select(record_id,redcap_event_name,-pain_resilience_scale_prs_complete,starts_with("prs"))


m2kerror.res1 <- m2kappdata.res3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("prs"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2kerror.res2 <- m2kappdata.res %>% 
  filter(pain_resilience_scale_prs_complete == 0 | pain_resilience_scale_prs_complete == 1) %>% 
  mutate(m2kres_complete = case_when(pain_resilience_scale_prs_complete == 0 | pain_resilience_scale_prs_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kres_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
m2kerrorres1_2 <- full_join(m2kerror.res1,m2kerror.res2,by = intersect(names(m2kerror.res1), names(m2kerror.res2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 


# recode NAs to 8 in the original dataset, select DAG as well

m2kappdata.res <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(pain_resilience_scale_prs_complete = case_when(is.na(pain_resilience_scale_prs_complete) ~ "8", TRUE ~ as.character(pain_resilience_scale_prs_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,pain_resilience_scale_prs_complete) 


table(m2kappdata.res$pain_resilience_scale_prs_complete,exclude = NULL)


#ensure each combination of ID and redcap event has one row with all values and is not duplicated


m2kerrorres1_2[m2kerrorres1_2== ""] <- NA

m2kerrorres1_2 <- m2kerrorres1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_res <- full_join(m2kappdata.res,m2kerrorres1_2,by = intersect(names(m2kappdata.res), names(m2kerrorres1_2))) %>% 
  mutate(m2kres_complete = case_when(pain_resilience_scale_prs_complete == "8" ~ "8", TRUE ~ as.character(m2kres_complete))) %>% 
  filter(!is.na(m2kres_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-pain_resilience_scale_prs_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2kdat.res <- m2kfull_res %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_resilience") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kres_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_resilience") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.res = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2kdata.res_wide <- m2kdat.res %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdat.res$m2kb.res)


table(datam2k$pain_resilience_scale_prs_complete ,exclude = NULL)



########## Read social  ##########



# Ask hablar to guess most appropriate datatype
m2kappdata.social <- retype(datam2k)




#Check for subjects who did not complete the test.
table(m2kappdata.social$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kappdata.social2 <- m2kappdata.social %>% 
  drop_na(promis_sf_v20_emotional_support_6a_complete)






#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2kappdata.social2$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2kappdata.social3 <- m2kappdata.social2 %>% 
  filter(promis_sf_v20_emotional_support_6a_complete== 2)

#check
table(m2kappdata.social3$promis_sf_v20_emotional_support_6a_complete, exclude = NULL)


m2kappdata.social3 <- m2kappdata.social3 %>% 
  select(record_id,redcap_event_name,-promis_sf_v20_emotional_support_6a_complete,starts_with("ess"))




names(m2kappdata.social3)



m2kerror.social1 <- m2kappdata.social3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("ess"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2kerror.social2 <- m2kappdata.social %>% 
  filter(promis_sf_v20_emotional_support_6a_complete == 0 | promis_sf_v20_emotional_support_6a_complete == 1) %>% 
  mutate(m2ksocial_complete = case_when(promis_sf_v20_emotional_support_6a_complete == 0 | promis_sf_v20_emotional_support_6a_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2ksocial_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
m2kerrorsocial1_2 <- full_join(m2kerror.social1,m2kerror.social2,by = intersect(names(m2kerror.social1), names(m2kerror.social2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2kappdata.social <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(promis_sf_v20_emotional_support_6a_complete = case_when(is.na(promis_sf_v20_emotional_support_6a_complete) ~ "8", TRUE ~ as.character(promis_sf_v20_emotional_support_6a_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,promis_sf_v20_emotional_support_6a_complete) 


table(m2kappdata.social$promis_sf_v20_emotional_support_6a_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerrorsocial1_2[m2kerrorsocial1_2== ""] <- NA

m2kerrorsocial1_2 <- m2kerrorsocial1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_social <- full_join(m2kappdata.social,m2kerrorsocial1_2,by = intersect(names(m2kappdata.social), names(m2kerrorsocial1_2))) %>% 
  mutate(m2ksocial_complete = case_when(promis_sf_v20_emotional_support_6a_complete == "8" ~ "8", TRUE ~ as.character(m2ksocial_complete))) %>% 
  filter(!is.na(m2ksocial_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-promis_sf_v20_emotional_support_6a_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2kdat.social <- m2kfull_social %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_social_support") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2ksocial_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_social_support") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.social = case_when(error == "clean" ~ 1,
                                 error == 2 ~ 2,
                                 error == 8 ~ 8,
                                 TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2kdata.social_wide <- m2kdat.social %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdat.social$m2kb.social)


table(datam2k$promis_sf_v20_emotional_support_6a_complete ,exclude = NULL)


########## Read ace ##########



# Ask hablar to guess most appropriate datatype
m2kappdata.ace <- retype(datam2k)



#Check for subjects who did not complete the test.
table(m2kappdata.ace$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)




#remove records with missing values for test completed.
m2kappdata.ace2 <- m2kappdata.ace %>% 
  drop_na(adverse_childhood_experience_questionnaire_ace_complete)



#Recheck if all records with missing data.bpi for completed tests were removed.
table(m2kappdata.ace2$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)



#keep records for subjects who completed the test.
m2kappdata.ace3 <- m2kappdata.ace2 %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete== 2)

#check
table(m2kappdata.ace3$adverse_childhood_experience_questionnaire_ace_complete, exclude = NULL)


m2kappdata.ace3 <- m2kappdata.ace3 %>% 
  select(record_id,redcap_event_name,-adverse_childhood_experience_questionnaire_ace_complete,starts_with("ace"))




m2kerror.ace1 <- m2kappdata.ace3 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(starts_with("ace"), ~ifelse(!is.na(.x),"1","x"))) 



# recode 0,1 ie incomplete/unverified to 2

m2kerror.ace2 <- m2kappdata.ace %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete == 0 | adverse_childhood_experience_questionnaire_ace_complete == 1) %>% 
  mutate(m2kace_complete = case_when(adverse_childhood_experience_questionnaire_ace_complete == 0 | adverse_childhood_experience_questionnaire_ace_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kace_complete) %>%  
  as_tibble() %>% 
  mutate_all(as.character)



#merge all
m2kerrorace1_2 <- full_join(m2kerror.ace1,m2kerror.ace2,by = intersect(names(m2kerror.ace1), names(m2kerror.ace2))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 





# recode NAs to 8 in the original dataset, select DAG as well
m2kappdata.ace <-datam2k %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(adverse_childhood_experience_questionnaire_ace_complete = case_when(is.na(adverse_childhood_experience_questionnaire_ace_complete) ~ "8", TRUE ~ as.character(adverse_childhood_experience_questionnaire_ace_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,adverse_childhood_experience_questionnaire_ace_complete) 


table(m2kappdata.ace$adverse_childhood_experience_questionnaire_ace_complete,exclude = NULL)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerrorace1_2[m2kerrorace1_2== ""] <- NA

m2kerrorace1_2 <- m2kerrorace1_2 %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

names(errorace1_2)



# anxiety_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_ace <- full_join(m2kappdata.ace,m2kerrorace1_2,by = intersect(names(m2kappdata.ace), names(m2kerrorace1_2))) %>% 
  mutate(m2kace_complete = case_when(adverse_childhood_experience_questionnaire_ace_complete == "8" ~ "8", TRUE ~ as.character(m2kace_complete))) %>% 
  filter(!is.na(m2kace_complete)) %>%# If errors are checked across using the entire data such as error.anxiety1, then filtering at this step is important to avoid duplicates
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  select(-adverse_childhood_experience_questionnaire_ace_complete) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0")))




m2kdat.ace <- m2kfull_ace %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_ACE") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kace_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_ACE") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.ace = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2kdata.ace_wide <- m2kdat.ace %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdat.ace$m2kb.ace)

table(datam2k$adverse_childhood_experience_questionnaire_ace_complete ,exclude = NULL)




#mcc1 baseline (acute) trajectory

#read in data

m2kdata.tr.baseline <- m2k_complete_result1 




#select completion vars only
# filter daily items that are complete

m2kdata.tr1.baseline <- m2kdata.tr.baseline %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,acute_phase_trajectory_items_v05_acute_daily_complete) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(acute_phase_trajectory_items_v05_acute_daily_complete == 2)






# count complete daily items per subject

m2kdata.tr.baseline.count <- m2kdata.tr1.baseline%>% 
  group_by(record_id) %>% 
  summarise(N=n())


# identify subjects who have >= 2 daily item for 6 month trajectory


m2kbaseline_pheno <- m2kdata.tr.baseline.count %>% 
  filter(N >= 5) %>% 
  select(record_id)


# select record ids and redcap_data_access_group , redcap_event_name from data to provide redcap data access group for the ids

m2kbaseline_traj_data <- datam2k %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) 


# provide redcap data access group and event name to 

m2kbaseline_phenom1 <- inner_join(m2kbaseline_pheno,m2kbaseline_traj_data, by = "record_id") %>% 
  mutate(MCC2_TKA_acute_traj = case_when(redcap_event_name == "baseline_visit_arm_1" ~ 1,TRUE ~ 7))

# isolate 6 month IDs
m2kbaseline_ids <- m2kbaseline_phenom1 %>% 
  select(record_id) %>% 
  distinct()

#creata a dataset with no 6 months IDs
m2kbaseline_traj_data1 <- m2kbaseline_traj_data %>% 
  filter(!record_id %in% m2kbaseline_ids$record_id) %>% 
  mutate(MCC2_TKA_acute_traj = case_when(redcap_event_name == "baseline_visit_arm_1" ~ 8,TRUE ~ 7))

#combine both datasets to create a dataframe with ids that have 6 mo trajectory and ids with no 6 mo trajectory

m2kbaseline_traj_wide <- rbind(m2kbaseline_phenom1,m2kbaseline_traj_data1) %>% 
  mutate(m2kb.base_traj = MCC2_TKA_acute_traj) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

############################

#mcc1 6 mon trajectory

#read in data

m2kdata.tr <- m2k_complete_result1 


#read in data

m2kdata.bpi <- retype(datam2k) %>% 
  select(record_id,redcap_event_name,starts_with("bpi"))


#select completion vars only
# filter daily items that are complete

m2kdata.tr1 <- m2kdata.tr %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,daily_items_6_mo_v03_6month_daily_complete,traj6moavgkneepainscl) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(daily_items_6_mo_v03_6month_daily_complete == 2) %>% 
  ungroup()



# count complete daily items per subject

m2kdata.tr.count <- m2kdata.tr1%>% 
  group_by(record_id) %>% 
  summarise(N=n())


# identify subjects who have >= 2 daily item for 6 month trajectory


m2ksix_month_tr <- m2kdata.tr.count %>% 
  filter(N >= 1) %>% 
  select(record_id)




m2kdata.bpi1 <- m2kdata.bpi %>% 
  select(record_id,redcap_event_name,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete,bpipainintrfrscore) %>% 
  group_by(record_id,redcap_event_name) %>% 
  filter(!is.na(bpipainintrfrscore),redcap_event_name == "6mo_postop_arm_1" & bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2) %>% 
  ungroup() %>% 
  select(record_id)



#combine all id from bpi and tr to generate ids of patients with 6 months complete

m2ksix_mo_pheno <- rbind(m2kdata.bpi1,m2ksix_month_tr) %>% 
  distinct(record_id)

# select record ids and redcap_data_access_group , redcap_event_name from data to provide redcap data access group for the ids

m2ktraj_data <- datam2k %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) 


# provide redcap data access group and event name to 

m2ksix_mo_phenom1 <- inner_join(m2ksix_mo_pheno,m2ktraj_data, by = c("record_id")) %>% 
  mutate(MCC2_TKA_six_mo_traj = case_when(redcap_event_name == "6mo_postop_arm_1" ~ 1,TRUE ~ 7))

# isolate 6 month IDs
m2ksix_mo_ids <- m2ksix_mo_phenom1 %>% 
  select(record_id) %>% 
  distinct()

#creata a dataset with no 6 months IDs
m2ktraj_data1 <- m2ktraj_data %>% 
  filter(!record_id %in% m2ksix_mo_ids$record_id) %>% 
  mutate(MCC2_TKA_six_mo_traj = case_when(redcap_event_name == "6mo_postop_arm_1" ~ 8,TRUE ~ 7))

#combine both datasets to create a dataframe with ids that have 6 mo trajectory and ids with no 6 mo trajectory

m2ksix.mo_wide <- rbind(m2ksix_mo_phenom1,m2ktraj_data1) %>% 
  mutate(m2kb.traj = MCC2_TKA_six_mo_traj) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

#Read Data

m2kfafunc <- datam2k



m2kfafunc <- retype(m2kfafunc)#Recheck if all records with missing data for completed tests were removed.
table(fafunc$walk10completeyn, exclude = NULL)


#keep records for subjects who completed the test.
m2kfadata3 <- m2kfafunc %>% 
  filter(walk10completeyn == 1 & functional_testing_complete == 2)

table(m2kfadata3$walk10completeyn, exclude = NULL)



#look for discrepancies in the first and the second initial pain rating 
m2kfadata4 <- m2kfadata3 %>% 
  mutate(init_pain_diff = walk10initialpainscl - walk10initialpainscl1) %>% 
  filter(init_pain_diff != 0 | is.na(init_pain_diff))

m2kfaerror1 <- m2kfadata4 %>% 
  select(record_id,redcap_event_name,walk10initialpainscl,walk10initialpainscl1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10initialpainscl = case_when(is.na(walk10initialpainscl) ~ "x",TRUE ~ "x")) %>% 
  mutate(walk10initialpainscl1 = case_when(is.na(walk10initialpainscl1) ~ "x",TRUE ~ "x"))



#look for discrepancies between the first and the second final pain rating 
m2kfadata5 <- m2kfadata3 %>% 
  mutate(final_pain_diff = walk10finalpainscl - walk10finalpainscl1) %>% 
  filter(final_pain_diff != 0 | is.na(final_pain_diff)) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kfaerror2 <- m2kfadata5 %>% 
  select(record_id,redcap_event_name,walk10finalpainscl,walk10finalpainscl1) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10finalpainscl = case_when(is.na(walk10finalpainscl) ~ "x",TRUE ~ "x")) %>% 
  mutate(walk10finalpainscl1 = case_when(is.na(walk10finalpainscl1) ~ "x",TRUE ~ "x"))


m2kfaerror1_2 <- full_join(m2kfaerror1,m2kfaerror2,by = intersect(names(m2kfaerror1), names(m2kfaerror2)))





#look for discrepancies between the first and the second walk time 
m2kfadata6 <- m2kfadata3 %>% 
  mutate(walk_time_diff = walk10time - walk10time1) %>% 
  filter(walk_time_diff != 0 | is.na(walk_time_diff))

m2kfaerror3 <- m2kfadata6 %>% 
  select(record_id,redcap_event_name,walk10time,walk10time1)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10time = case_when(is.na(walk10time) ~ "x",TRUE ~ "x")) %>% 
  mutate(walk10time1 = case_when(is.na(walk10time1) ~ "x",TRUE ~ "x"))

m2kfaerror1_2_3 <- full_join(m2kfaerror1_2,m2kfaerror3,by = intersect(names(m2kfaerror1_2), names(m2kfaerror3)))


# check if a reason for test not completed was marked off


m2kfadata7 <- m2kfafunc  %>% 
  filter(walk10completeyn == 0) %>%
  filter(is.na(walk10incompletereason))

m2kfaerror4 <- m2kfadata7 %>% 
  select(record_id,redcap_event_name,walk10incompletereason) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10incompletereason = case_when(is.na(walk10incompletereason) ~ "x"))



m2kfaerror1_2_3_4 <- full_join(m2kfaerror1_2_3,m2kfaerror4,by = intersect(names(m2kfaerror1_2_3), names(m2kfaerror4)))



#if walk was completed, check for records with missing values for any assistance 

m2kfaerror5 <- m2kfadata3 %>% 
  filter(walk10completeyn == 1) %>% 
  filter(is.na(walk10assistyn)) %>% 
  select(record_id,redcap_event_name,walk10assistyn)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(walk10assistyn = case_when(is.na(walk10assistyn) ~ "x"))

m2kfaerror1_2_3_4_5 <- full_join(m2kfaerror1_2_3_4,m2kfaerror5,by = intersect(names(m2kfaerror1_2_3_4), names(m2kfaerror5)))





#if any assistance during walk test was checked off, check for records with unchecked type of assistance 

m2kfaerror6 <- m2kfadata3 %>% 
  filter(walk10assistyn == 1) %>% 
  filter(walk10assist_cane___1 == 0 & walk10assist_crutch___1 == 0 & walk10assist_perssuppt___1 == 0 & walk10assist_other___1 == 0 & walk10assist_walkder___1 == 0) %>% 
  mutate(type_of_walk_assistance_not_checked = case_when(walk10assist_cane___1 == 0 & walk10assist_crutch___1 == 0 & walk10assist_perssuppt___1 == 0 & walk10assist_other___1 == 0 & walk10assist_walkder___1 == 0 ~ "x")) %>% 
  select(record_id,redcap_event_name,type_of_walk_assistance_not_checked) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kfaerror1_2_3_4_5_6 <- full_join(m2kfaerror1_2_3_4_5,m2kfaerror6,by = intersect(names(m2kfaerror1_2_3_4_5), names(m2kfaerror6)))






### 5 times sit to stand test#####




#Check for subjects who did not complete the test.
table(m2kfafunc$tstscompleteyn, exclude = NULL)




#remove records with missing values for test completed.
m2kfadata.sit <- m2kfafunc %>% 
  drop_na(tstscompleteyn)




#Recheck if all records with missing m2kfadata for completed tests were removed.
table(m2kfadata.sit$tstscompleteyn, exclude = NULL)




#check for missing bp values if tsts was completed

m2kfaerror.bp <- m2kfadata.sit %>% 
  filter(tstscompleteyn == 1 &  is.na(tstsbpscreen) ) %>% 
  select(record_id,redcap_event_name,tstsbpscreen) %>% 
  as_tibble() %>% 
  mutate_all(as.character)

m2kfaerror.bp$tstsbpscreen <- m2kfaerror.bp$tstsbpscreen %>% replace_na("x")




#keep records for subjects who completed the test.
m2kfadata.sit1 <- m2kfadata.sit %>% 
  filter(tstscompleteyn == 1 & functional_testing_complete == 2)





#look for discrepancies in the first and the second initial pain rating 
m2kfadata.sit4 <- m2kfadata.sit1 %>% 
  mutate(init_pain_diff.sit = tstsprepainscl - tstsprepainscl1) %>% 
  filter(init_pain_diff.sit != 0 | is.na(init_pain_diff.sit))

m2kfaerror1.sit <- m2kfadata.sit4 %>% 
  select(record_id,redcap_event_name,tstsprepainscl,tstsprepainscl1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsprepainscl = case_when(is.na(tstsprepainscl) ~ "x",TRUE ~ "x")) %>% 
  mutate(tstsprepainscl1 = case_when(is.na(tstsprepainscl1) ~ "x",TRUE ~ "x"))










#look for discrepancies between the first and the second final pain rating 
m2kfadata.sit5 <- m2kfadata.sit1 %>% 
  mutate(final_pain_diff.sit = tstspostpainscl - tstspostpainscl1) %>% 
  filter(final_pain_diff.sit != 0 | is.na(final_pain_diff.sit))

m2kfaerror2.sit <- m2kfadata.sit5 %>% 
  select(record_id,redcap_event_name,tstspostpainscl,tstspostpainscl1)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstspostpainscl = case_when(is.na(tstspostpainscl) ~ "x",TRUE ~ "x"))%>% 
  mutate(tstspostpainscl1 = case_when(is.na(tstspostpainscl1) ~ "x",TRUE ~ "x"))


m2kfaerrorsit1_2 <- full_join(m2kfaerror1.sit,m2kfaerror2.sit,by = intersect(names(m2kfaerror1.sit), names(m2kfaerror2.sit)))




#look for discrepancies between the first and the second activity  time 
m2kfadata.sit6 <- m2kfadata.sit1 %>% 
  mutate(sit_time_diff = tststime - tststime1) %>% 
  filter(sit_time_diff != 0 | is.na(sit_time_diff))

m2kfaerror3.sit <- m2kfadata.sit6 %>% 
  select(record_id,redcap_event_name,tststime,tststime1)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tststime = case_when(is.na(tststime) ~ "x",TRUE ~ "x"))%>% 
  mutate(tststime1 = case_when(is.na(tststime1) ~ "x",TRUE ~ "x"))


m2kfaerrorsit1_2_3 <- full_join(m2kfaerrorsit1_2,m2kfaerror3.sit,by = intersect(names(m2kfaerrorsit1_2), names(m2kfaerror3.sit)))




# check if a reason for test not completed was marked off


m2kfadata.sit7 <- m2kfadata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(is.na(tstsnonreasonyn))

m2kfaerror4.sit <- m2kfadata.sit7 %>% 
  select(record_id,redcap_event_name,tstsnonreasonyn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnonreasonyn = case_when(is.na(tstsnonreasonyn) ~ "x")) # recode NA to missing or leave as is




m2kfaerrorsit1_2_3_4 <- full_join(m2kfaerrorsit1_2_3,m2kfaerror4.sit,by = intersect(names(m2kfaerrorsit1_2_3), names(m2kfaerror4.sit)))





#check if test was not completed but was Initiated, and the number of reps completed (n/5) were not specified)
m2kfadata.sit8 <- m2kfadata.sit %>% 
  filter(tstscompleteyn == 0) %>% 
  filter(tstsnonreasonyn == 1) %>% 
  filter(is.na(tstsnumbrepsyn))

m2kfaerror5.sit <- m2kfadata.sit8 %>% 
  select(record_id,redcap_event_name,tstsnumbrepsyn)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsnumbrepsyn = case_when(is.na(tstsnumbrepsyn) ~ "x")) # recode NA to missing or leave as is

m2kfaerrorsit1_2_3_4_5 <- full_join(m2kfaerrorsit1_2_3_4,m2kfaerror5.sit,by = intersect(names(m2kfaerrorsit1_2_3_4), names(m2kfaerror5.sit)))




# check for records with missing values for any assistance if test was completed

m2kfaerror6.sit <- m2kfadata.sit1 %>% 
  filter(tstscompleteyn == 1) %>% 
  filter(is.na(tstsassistyn)) %>% 
  select(record_id,redcap_event_name,tstsassistyn)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tstsassistyn = case_when(is.na(tstsassistyn) ~ "x",TRUE ~ "x")) # recode NA to missing or leave as is

m2kfaerrorsit1_2_3_4_5_6 <- full_join(m2kfaerrorsit1_2_3_4_5,m2kfaerror6.sit,by = intersect(names(m2kfaerrorsit1_2_3_4_5), names(m2kfaerror6.sit)))




# check for records with 0 for type of assistance if walk any assistance was checked off

m2kfaerror7.sit <- m2kfadata.sit1 %>% 
  filter(tstsassistyn == 1) %>% 
  filter(tstsassist_1___1 == 0 & tstsassist_2___1 == 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(type_of_tsts_assistance_not_checked = case_when(tstsassist_1___1 == "0" & tstsassist_2___1 == "0"  ~ "x")) %>% 
  select(record_id,redcap_event_name,type_of_tsts_assistance_not_checked)

m2kfaerrorsit1_2_3_4_5_6_7 <- full_join(m2kfaerrorsit1_2_3_4_5_6,m2kfaerror7.sit,by = intersect(names(m2kfaerrorsit1_2_3_4_5_6), names(m2kfaerror7.sit)))

m2kfaerrorsit1_2_3_4_5_6_7_bp <- full_join(m2kfaerrorsit1_2_3_4_5_6_7,m2kfaerror.bp,by = intersect(names(m2kfaerrorsit1_2_3_4_5_6_7), names(m2kfaerror.bp)))


# c0nvert record ids to as.character
# 
# #10min walk test faerrors
# faerror1$record_id <- as.character(faerror1$record_id)
# faerror2$record_id <- as.character(faerror2$record_id)
# faerror3$record_id <- as.character(faerror3$record_id)
# faerror4$record_id <- as.character(faerror4$record_id)
# faerror5$record_id <- as.character(faerror5$record_id)
# faerror6$record_id <- as.character(faerror6$record_id)
# 
# #tsts test
# faerror1.sit$record_id <- as.character(faerror1.sit$record_id)
# faerror2.sit$record_id <- as.character(faerror2.sit$record_id)
# faerror3.sit$record_id <- as.character(faerror3.sit$record_id)
# faerror4.sit$record_id <- as.character(faerror4.sit$record_id)
# faerror5.sit$record_id <- as.character(faerror5.sit$record_id)
# faerror6.sit$record_id <- as.character(faerror6.sit$record_id)
# faerror7.sit$record_id <- as.character(faerror7.sit$record_id)
# faerror.bp$record_id <- as.character(faerror.bp$record_id)


list.func <- full_join(m2kfaerror1,m2kfaerror2,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror3,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror4,by= c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror5,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror6,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror1.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror2.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror3.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror4.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror5.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror6.sit,by=c("record_id","redcap_event_name"))%>% 
  full_join(.,m2kfaerror7.sit,by=c("record_id","redcap_event_name")) %>% 
  full_join(.,m2kfaerror.bp,by=c("record_id","redcap_event_name")) 





#fetch notes, for app we dont need notes bit need DAG

m2kfanotes.walk <- m2kfafunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)


m2kfanotes.tsts <- m2kfafunc %>% 
  select(record_id,redcap_event_name,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)










# create table for walk test

m2kfawalk <- m2kfaerror1_2_3_4_5_6 %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#create table for tsts test

m2kfatsts <- m2kfaerrorsit1_2_3_4_5_6_7_bp %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#ensure each combination of ID and redcap event has one row with all values and is not duplicated


m2kfawalk[m2kfawalk== ""] <- NA
m2kfawalk1 <- m2kfawalk  %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




# now add notes
#walk with notes

m2kfawalk1_notes <- left_join(m2kfawalk1,m2kfanotes.walk,by=c("record_id","redcap_event_name"))



#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kfatsts[] <- lapply(m2kfatsts, as.character)

m2kfatsts[m2kfatsts== ""] <- NA
m2kfatsts1 <- m2kfatsts %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





#tsts with notes
m2kfatsts1[] <- lapply(m2kfatsts1, as.character)
m2kfanotes.tsts[] <- lapply(m2kfanotes.tsts, as.character)

m2kfatsts_notes <- left_join(m2kfatsts1,m2kfanotes.tsts,by=c("record_id","redcap_event_name")) %>% 
  as_tibble() %>% 
  mutate_all(as.character)





#create final table

m2kfatsts_notes[] <- lapply(m2kfatsts_notes, as.character)
m2kfawalk1_notes[] <- lapply(m2kfawalk1_notes, as.character)

m2kfafunc_table <- full_join(m2kfawalk1_notes,m2kfatsts_notes,by = intersect(names(m2kfawalk1_notes), names(m2kfatsts_notes))) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kfafunc_table[m2kfafunc_table== ""] <- NA
m2kfafunc_table <-  m2kfafunc_table %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)  %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2kfunc_complete = 0) %>% # added new step here
  as_tibble() %>% 
  mutate_all(as.character)


# recode 0,1 ie incomplete/unverified to 2
m2kfunc_all <- m2kfafunc %>% 
  filter(functional_testing_complete == 0 |functional_testing_complete == 1) %>% 
  mutate(func_complete = case_when(functional_testing_complete == 0 |functional_testing_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,func_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




m2kfafunc_table[] <- lapply(m2kfafunc_table, as.character)
m2kfunc_all[] <- lapply(m2kfunc_all, as.character)

#merge all
m2kerror_func_all <- full_join(m2kfafunc_table,m2kfunc_all,by = intersect(names(m2kfafunc_table), names(m2kfunc_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 



# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_func_all <- m2kfafunc %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(functional_testing_complete = case_when(is.na(functional_testing_complete) ~ "8", TRUE ~ as.character(functional_testing_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,functional_testing_complete) 


table(m2kdata_func_all$functional_testing_complete,exclude = NULL)


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerror_func_all[m2kerror_func_all== ""] <- NA


m2kerror_func_all <- m2kerror_func_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character)



# func_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_func <- full_join(m2kerror_func_all,m2kdata_func_all,by = intersect(names(m2kerror_func_all), names(m2kdata_func_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kfunc_complete = case_when( functional_testing_complete == "8" ~ "8", TRUE ~ as.character(m2kfunc_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-functional_testing_complete)




table(m2kfull_func$func_complete,exclude = NULL) 





# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
m2kdat.func <- m2kfull_func %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_Functional") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kfunc_complete") %>% 
  
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_Functional") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.func = case_when(error == "clean" ~ 1,
                               error == 2 ~ 2,
                               error == 8 ~ 8,
                               TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))





m2kdata_func_wide <- m2kdat.func %>%
  pivot_wider (names_from = dataset,values_from = error) 

table(m2kdata_func_wide$m2kb.func) 
table(m2kfafunc$functional_testing_complete, exclude = NULL)




#blood draw


m2kbadata_blood<- datam2k



# Remove subjects that haven't come in for a vist yet. (No time and 'No blood obtained' marked)



m2kbadata_blood1 <- m2kbadata_blood   %>% 
  filter(!is.na(bscp_time_blood_draw) & bscp_sample_obtained___1 == 0 & blood_sample_collection_and_processing_crf_complete == 2)



# format time
m2kbadata_blood1$bscp_time_blood_draw <- ymd_hms(m2kbadata_blood1$bscp_time_blood_draw)

m2kbadata_blood1$bscp_time_centrifuge <- ymd_hms(m2kbadata_blood1$bscp_time_centrifuge)

m2kbadata_blood1$bscp_aliquot_freezer_time <- ymd_hms(m2kbadata_blood1$bscp_aliquot_freezer_time)



#check if blood draw time < centri time < freezer time 
m2kbadata_blood2 <- m2kbadata_blood1 %>%  
  select(record_id,redcap_event_name,bscp_time_blood_draw,bscp_time_centrifuge,bscp_aliquot_freezer_time) 



m2kbaflagblood1 <- m2kbadata_blood2 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time) %>% 
  mutate(blood_draw_time = case_when(bscp_time_blood_draw > bscp_time_centrifuge | bscp_time_centrifuge > bscp_aliquot_freezer_time | bscp_time_blood_draw > bscp_aliquot_freezer_time ~ "x")) %>% 
  select(record_id,redcap_event_name,blood_draw_time) 




#missing info on hours since last drink

m2kbaflagblood6 <- m2kbadata_blood1 %>% 
  filter(is.na(bscp_hrs_since_water)) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_water) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_water = case_when(is.na(bscp_hrs_since_water) ~ "x")) 




m2kbaflagblood1_6 <- full_join(m2kbaflagblood1,m2kbaflagblood6,by = intersect(names(m2kbaflagblood1), names(m2kbaflagblood6)))



#missing info on hours since last food


m2kbaflagblood7 <- m2kbadata_blood1 %>% 
  filter(is.na(bscp_hrs_since_food))%>% 
  select(record_id,redcap_event_name,bscp_hrs_since_food) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_food = case_when(is.na(bscp_hrs_since_food) ~ "x")) 







m2kbaflagblood1_7 <- full_join(m2kbaflagblood1_6,m2kbaflagblood7,by = intersect(names(m2kbaflagblood1_6), names(m2kbaflagblood7)))



#number of hours since last caff,will be missing if not a coffee drinker ie bscp_caff_cups_amt ==4 (I assume)

m2kbaflagblood8 <- m2kbadata_blood1 %>% 
  filter(is.na(bscp_hrs_since_cafstim)  & bscp_caff_cups_amt!= 4) %>% 
  select(record_id,redcap_event_name,bscp_hrs_since_cafstim)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_hrs_since_cafstim = case_when(is.na(bscp_hrs_since_cafstim)~ "x"))


m2kbaflagblood1_8 <- full_join(m2kbaflagblood1_7,m2kbaflagblood8,by = intersect(names(m2kbaflagblood1_7), names(m2kbaflagblood8)))



#missing info on amount of caff
m2kbaflagblood9 <- m2kbadata_blood1 %>% 
  filter(is.na( bscp_caff_cups_amt)) %>% 
  select(record_id,redcap_event_name,bscp_caff_cups_amt)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_caff_cups_amt = case_when(is.na(bscp_caff_cups_amt)~ "x")) 


m2kbaflagblood1_9 <- full_join(m2kbaflagblood1_8,m2kbaflagblood9,by = intersect(names(m2kbaflagblood1_8), names(m2kbaflagblood9 )))





#missing info on any vacc
m2kbaflagblood10 <- m2kbadata_blood1 %>% 
  filter(is.na( bscp_any_vacc)) %>% 
  select(record_id,redcap_event_name,bscp_any_vacc)%>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_any_vacc = case_when(is.na(bscp_any_vacc)~ "x")) 

m2kbaflagblood1_10 <- full_join(m2kbaflagblood1_9,m2kbaflagblood10,by = intersect(names(m2kbaflagblood1_9), names(m2kbaflagblood10)))






# if level of hemolysis was not entered

m2kbaflagblood11 <- m2kbadata_blood1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis)~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)



m2kbaflagblood1_11<- full_join(m2kbaflagblood1_10,m2kbaflagblood11,by = intersect(names(m2kbaflagblood1_10), names(m2kbaflagblood11)))





# if centrifuge time entered but freezing time not entered

m2kbaflagblood14.1 <- m2kbadata_blood1 %>% 
  filter(bscp_lav1_not_obt___1==0 & !is.na(bscp_time_centrifuge) & is.na(bscp_aliquot_freezer_time)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_aliquot_freezer_time = case_when(is.na(bscp_aliquot_freezer_time)~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_aliquot_freezer_time)





#baflagblood1_13$bscp_aliquot_freezer_time <- as.character(flag1_13$bscp_aliquot_freezer_time)



m2kbaflagblood1_14.1<- full_join(m2kbaflagblood1_11,m2kbaflagblood14.1,by = intersect(names(m2kbaflagblood1_11), names(m2kbaflagblood14.1))) 




# if centrifuge time entered but degree of hemolysis  not entered

m2kbaflagblood14.2 <- m2kbadata_blood1 %>% 
  filter(!is.na(bscp_time_centrifuge) & is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_deg_of_hemolysis = case_when(is.na(bscp_deg_of_hemolysis) ~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_deg_of_hemolysis)




m2kbaflagblood1_14.2<- full_join(m2kbaflagblood1_14.1,m2kbaflagblood14.2,by = intersect(names(m2kbaflagblood1_14.1), names(m2kbaflagblood14.2))) 




# if centrifuge time not entered but degree of hemolysis entered

m2kbaflagblood14.3 <- m2kbadata_blood1 %>% 
  filter(is.na(bscp_time_centrifuge) & !is.na(bscp_deg_of_hemolysis)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(bscp_time_centrifuge = case_when(is.na(bscp_time_centrifuge) ~ "x")) %>% 
  select(record_id,redcap_event_name,bscp_time_centrifuge)







m2kbaflagblood1_14<- full_join(m2kbaflagblood1_14.2,m2kbaflagblood14.3,by = intersect(names(m2kbaflagblood1_14.2), names(m2kbaflagblood14.3))) 


#fetch notes with dag
m2kba.notes.blood <- m2kbadata_blood %>% 
  select(record_id,redcap_event_name, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character)




m2kbaflagblood_notes <- left_join(m2kbaflagblood1_14,m2kba.notes.blood,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) 



m2kbablood_table<- m2kbaflagblood_notes %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name", "redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)   %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2kbld_complete = 0) %>% # added new step here
  as_tibble() %>% 
  mutate_all(as.character)





# recode 0,1 ie incomplete/unverified to 2
m2kbld_all <- m2kbadata_blood %>% 
  filter(blood_sample_collection_and_processing_crf_complete == 0 |blood_sample_collection_and_processing_crf_complete == 1) %>% 
  mutate(m2kbld_complete = case_when(blood_sample_collection_and_processing_crf_complete == 0 |blood_sample_collection_and_processing_crf_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kbld_complete,redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2kbablood_table[] <- lapply(m2kbablood_table, as.character)
m2kbld_all[] <- lapply(m2kbld_all, as.character)




#merge all
m2kerror_bld_all <- full_join(m2kbablood_table,m2kbld_all,by = intersect(names(m2kbablood_table), names(m2kbld_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 




# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_bld_all <- m2kbadata_blood %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(blood_sample_collection_and_processing_crf_complete= case_when(is.na(blood_sample_collection_and_processing_crf_complete) ~ "8", TRUE ~ as.character(blood_sample_collection_and_processing_crf_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,blood_sample_collection_and_processing_crf_complete) 


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerror_bld_all[m2kerror_bld_all== ""] <- NA


m2kerror_bld_all <- m2kerror_bld_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# imaging_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_bld <- full_join(m2kerror_bld_all,m2kdata_bld_all,by = intersect(names(m2kerror_bld_all), names(m2kdata_bld_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character)  %>% 
  mutate(m2kbld_complete = case_when(blood_sample_collection_and_processing_crf_complete == "8" ~ "8", TRUE ~ as.character(m2kbld_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-blood_sample_collection_and_processing_crf_complete)


m2kdat.blood <- m2kfull_bld %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_BloodDraw") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kbld_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_BloodDraw") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.blood = case_when(error == "clean" ~ 1,
                                error == 2 ~ 2,
                                error == 8 ~ 8,
                                TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))




m2kdata_blood_wide <- m2kdat.blood %>%
  pivot_wider (names_from = dataset,values_from = error) 




table(m2kdata_blood_wide$m2kb.blood)
table(datam2k$blood_sample_collection_and_processing_crf_complete, exclude = NULL)

#stopped

#imaging
#Read Data



#Read Data
m2kiaimaging <-  datam2k






#keep subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl

m2kiadf.complete <- m2kiaimaging %>% 
  filter(fmricuffcompletescl != 0 & imaging_mcc1_v09_complete == 2)



#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl, Check if cuff site entered for subjects who underwent fMRI individualized pressure and/or fMRI standard pressure


m2kiaerror1a <-m2kiadf.complete %>%
  filter(fmricuffcompletescl == 1|fmricuffcpyn == 1| fmricuffipyn == 1) %>% 
  filter (is.na(fmricuffleg) &  fmricuffcontrayn != 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffleg) %>%  
  mutate(fmricuffleg=replace_na("x")) 



m2kiaerror1b <-m2kiadf.complete %>%
  filter(fmricuffcompletescl == 2 & (is.na(fmricufft1yn) | is.na(fmricuffdwiyn) | is.na(fmricuffrest1yn)
                                     |is.na(fmricuffipyn) | is.na(fmricuffcpyn)|is.na(fmricuffrest2yn))) %>% 
  select(record_id,redcap_event_name,fmricufft1yn,fmricuffdwiyn,fmricuffrest1yn,fmricuffipyn,fmricuffcpyn,fmricuffrest2yn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_all(~replace_na(., "x")) 


m2kiaerror1 <- full_join(m2kiaerror1a,m2kiaerror1b,by = intersect(names(m2kiaerror1a), names(m2kiaerror1b)))



# In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" for fmricuffcompletescl AND cuff applied AND recaliberation of pressure needed then check for mismatch between fmricuffcalfpressurerecal(pressure2) and fmricuffcalfpressurerecal2 (pressure 2 double entry) or missing value

m2kiaerror2 <- m2kiadf.complete%>% 
  filter(!is.na(fmricuffleg)) %>% 
  filter(fmricuffcontrarecal == 1) %>% 
  mutate(pressure_diff = fmricuffcalfpressurerecal-fmricuffcalfpressurerecal2) %>% 
  filter(pressure_diff != 0 | is.na(pressure_diff)) %>% 
  
  select(record_id,redcap_event_name,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "x",TRUE ~ "x")) 



# merge error1 and 2 



m2kiaerror1_2 <- full_join(m2kiaerror1,m2kiaerror2,by = intersect(names(m2kiaerror1), names(m2kiaerror2)))




#In subjects marked as "Yes, all scans were completed" or "Yes, but only the scans indicated below were completed" AND with T1 scan done (i.e 1) check if the scan was rated OR if T1 scan was repeated then if the scan was rated on repeated scan



# T1

m2kiaerror3 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricufft1yn) & fmricufft1yn == 1)) %>% 
  filter(is.na(fmricufft1techrating)| (!is.na(fmricufft1repeated) & is.na(fmricufft1techrating2)) ) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl,fmricufft1yn,fmricufft1techrating,fmricufft1repeated,fmricufft1repeated,fmricufft1techrating2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricufft1techrating = case_when(is.na(fmricufft1techrating)  ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricufft1techrating2 = case_when(is.na(fmricufft1techrating2) & fmricufft1repeated==1  ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricufft1techrating,fmricufft1techrating2) 



m2kiaerror1_2_3 <- full_join(m2kiaerror1_2,m2kiaerror3,by = intersect(names(m2kiaerror1_2), names(m2kiaerror3)))






#before fiast resting state

# Check if fiast resting-state scan performed and there was mismatch between entries for surgical site pain

m2kiaerror4.1 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff1 = fmricuffrestpainss-fmricuffrestpainss2) %>% 
  filter(surg.pain.diff1 != 0 | is.na(surg.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainss = case_when(is.na(fmricuffrestpainss) ~ "x",TRUE ~ "X")) %>% 
  mutate(fmricuffrestpainss2 = case_when(is.na(fmricuffrestpainss2) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,fmricuffrestpainss,fmricuffrestpainss2) 


# Check if fiast resting-state scan performed and there was a mismatch between entries overall body pain

m2kiaerror4.2 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | ( fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff1 = fmricuffrestpainovrall - fmricuffrestpainovrall2) %>% 
  filter(all.pain.diff1 != 0 | is.na(all.pain.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffrestpainovrall= case_when(is.na(fmricuffrestpainovrall) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffrestpainovrall2 = case_when(is.na(fmricuffrestpainovrall2) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,fmricuffrestpainovrall, fmricuffrestpainovrall2) 

m2kiaerror4 <- full_join(m2kiaerror4.1,m2kiaerror4.2,by = intersect(names(m2kiaerror4.1), names(m2kiaerror4.2)))


m2kiaerror1_2_3_4 <- full_join(m2kiaerror1_2_3,m2kiaerror4,by = intersect(names(m2kiaerror1_2_3), names(m2kiaerror4)))




# After fiast resting fMRI scan:

# Check if fiast resting-state scan performed and there was mismatch between entries for surgical site pain

m2kiaerror5.1 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(surg.pain.diff2 = fmricuffcurrpainaftfirstscanss - fmricuffcurrpainaftfirstscanss2) %>% 
  filter(surg.pain.diff2 != 0 | is.na(surg.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscanss,fmricuffcurrpainaftfirstscanss2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanss = case_when(is.na(fmricuffcurrpainaftfirstscanss) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcurrpainaftfirstscanss2 = case_when(is.na(fmricuffcurrpainaftfirstscanss2) ~ "x",TRUE ~ "x"))

# Check  if fiast resting-state scan and there was mismatch between entries for overall body pain

m2kiaerror5.2 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>% 
  mutate(all.pain.diff2 = fmricuffcurrpainaftfirstscanovrall - fmricuffcurrpainaftfirstscanovrall2) %>% 
  filter(all.pain.diff2 != 0 | is.na(all.pain.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall,fmricuffcurrpainaftfirstscanovrall2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall = case_when(is.na(fmricuffcurrpainaftfirstscanovrall) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcurrpainaftfirstscanovrall2 = case_when(is.na(fmricuffcurrpainaftfirstscanovrall2) ~ "x",TRUE ~ "x"))


m2kiaerror5.a <- full_join(m2kiaerror5.1,m2kiaerror5.2,by = intersect(names(m2kiaerror5.1), names(m2kiaerror5.2)))


# Check if individualized and standard performed but baseline was missing after fiast resting MRI (if standard and personalized/individualized were not performed, it is assumed that cuff was C/I)
m2kiaerror5.bb <- m2kiadf.complete%>%
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffrest1yn) & fmricuffrest1yn == 1)) %>%
  filter(fmricuffipyn == 1 & fmricuffcpyn == 1) %>% 
  mutate(cuff.pain.diff1 = fmricuffcurrpainaftfirstscancp - fmricuffcurrpainaftfirstscancp2) %>%
  filter(cuff.pain.diff1 != 0 | is.na(cuff.pain.diff1)) %>%
  select(record_id,redcap_event_name,fmricuffcurrpainaftfirstscancp,fmricuffcurrpainaftfirstscancp2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcurrpainaftfirstscancp = case_when(is.na(fmricuffcurrpainaftfirstscancp) ~ "x",TRUE ~ "x")) %>%
  mutate(fmricuffcurrpainaftfirstscancp2 = case_when(is.na(fmricuffcurrpainaftfirstscancp2) ~ "x",TRUE ~ "x"))

m2kiaerror1_2_3_4_5a <- full_join(m2kiaerror1_2_3_4,m2kiaerror5.a,by=intersect(names(m2kiaerror1_2_3_4), names(m2kiaerror5.a)))


m2kiaerror1_2_3_4_5 <- full_join(m2kiaerror1_2_3_4_5a,m2kiaerror5.bb,by=intersect(names(m2kiaerror1_2_3_4_5a), names(m2kiaerror5.bb)))





# After fiast cuff fMRI scan

# check if fiast cuff task complete (individualized) and mismatch between cuff pain at the beginning of the scan OR missing values

m2kiaerror6.1 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 |(fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.begin.diff1 = fmricuffpainbegin - fmricuffpainbegin2) %>% 
  filter(cuff.begin.diff1 != 0 | is.na(cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainbegin, fmricuffpainbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainbegin = case_when(is.na(fmricuffpainbegin) ~"x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainbegin2 = case_when(is.na(fmricuffpainbegin2) ~ "x",TRUE ~ "x"))
# check if fiast cuff task complete (individualized) and mismatch beween cuff pain at the mid of the scan  OR missing values

m2kiaerror6.2 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (fmricuffcompletescl==2 & !is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.mid.diff1 = fmricuffpainmid -fmricuffpainmid2) %>% 
  filter(cuff.mid.diff1 != 0 | is.na(cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainmid,fmricuffpainmid2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainmid = case_when(is.na(fmricuffpainmid) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainmid2 = case_when(is.na(fmricuffpainmid2) ~ "x",TRUE ~ "x")) 
# check if fiast cuff task complete (individualized) and mismatch beween cuff pain at the end of the scan  OR missing values

m2kiaerror6.3 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffipyn) & fmricuffipyn == 1)) %>% 
  mutate(cuff.end.diff1 = fmricuffpainend - fmricuffpainend2) %>% 
  filter(cuff.end.diff1 != 0 | is.na(cuff.end.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainend,fmricuffpainend2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainend = case_when(is.na(fmricuffpainend) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainend2 = case_when(is.na(fmricuffpainend2) ~ "x",TRUE ~ "x")) 
#create final set



m2kiaerror6a <- full_join(m2kiaerror6.1,m2kiaerror6.2,by=intersect(names(m2kiaerror6.1), names(m2kiaerror6.2)))

m2kiaerror6 <- full_join(m2kiaerror6a,m2kiaerror6.3,by=intersect(names(m2kiaerror6a), names(m2kiaerror6.3)))

m2kiaerror1_2_3_4_5_6 <- full_join(m2kiaerror1_2_3_4_5,m2kiaerror6,by=intersect(names(m2kiaerror1_2_3_4_5), names(m2kiaerror6)))




# After second cuff fMRI scan



# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the beginning of the scan

m2kiaerror7.1 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.begin.diff2 = fmricuffpaincpbegin - fmricuffpaincpbegin2) %>% 
  filter(cuff.begin.diff2 != 0 | is.na(cuff.begin.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpbegin, fmricuffpaincpbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpbegin = case_when(is.na(fmricuffpaincpbegin) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpbegin2 = case_when(is.na(fmricuffpaincpbegin2) ~ "x",TRUE ~ "x")) 
# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the mid of the scan

m2kiaerror7.2 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.mid.diff2 = fmricuffpaincpmid-fmricuffpaincpmid2) %>% 
  filter(cuff.mid.diff2 != 0 | is.na(cuff.mid.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpmid,fmricuffpaincpmid2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpmid = case_when(is.na(fmricuffpaincpmid) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpmid2 = case_when(is.na(fmricuffpaincpmid2) ~ "x",TRUE ~ "x")) 
# check if  cuff task is complete(standard pressure) and mismatch beween cuff pain at the end of the scan

m2kiaerror7.3 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1 | (!is.na(fmricuffcpyn) & fmricuffcpyn == 1)) %>% 
  mutate(cuff.end.diff2 = fmricuffpaincpend - fmricuffpaincpend2) %>% 
  filter(cuff.end.diff2 != 0 | is.na(cuff.end.diff2)) %>% 
  select(record_id,redcap_event_name,fmricuffpaincpend,fmricuffpaincpend2) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpaincpend = case_when(is.na(fmricuffpaincpend) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffpaincpend2 = case_when(is.na(fmricuffpaincpend2) ~ "x",TRUE ~ "x"))
#create final set

m2kiaerror7a <- full_join(m2kiaerror7.1,m2kiaerror7.2,by=intersect(names(m2kiaerror7.1), names(m2kiaerror7.2))) 

m2kiaerror7 <- full_join(m2kiaerror7.3,m2kiaerror7a,by=intersect(names(m2kiaerror7.3), names(m2kiaerror7a))) 






# After 2nd Resting state
#cuff pain
#Cuff pain (fmricuffpainrestscanbegin/mid/end) entries: " (IF all scans completed) OR (IF some scans completed AND standard pressure performed) then check for mismatch in cuff pain entries or NAs."."
m2kiaerror8.1 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.begin.diff1 = fmricuffpainrestscanbegin - fmricuffpainrestscanbegin2) %>% 
  filter(rest.cuff.begin.diff1 != 0 | is.na(rest.cuff.begin.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanbegin,fmricuffpainrestscanbegin2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainrestscanbegin = case_when(is.na(fmricuffpainrestscanbegin) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanbegin2 = case_when(is.na(fmricuffpainrestscanbegin2) ~ "x",TRUE ~ "x"))


m2kiaerror8.2 <- m2kiadf.complete%>% 
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.mid.diff1 = fmricuffpainrestscanmid - fmricuffpainrestscanmid2) %>% 
  filter(rest.cuff.mid.diff1 != 0 | is.na(rest.cuff.mid.diff1)) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanmid,fmricuffpainrestscanmid2) %>%  
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainrestscanmid = case_when(is.na(fmricuffpainrestscanmid) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanmid2 = case_when(is.na(fmricuffpainrestscanmid2) ~ "x",TRUE ~ "x"))

m2kiaerror8.3 <- m2kiadf.complete%>%
  filter(fmricuffcompletescl == 1| (!is.na(fmricuffcpyn) & fmricuffcpyn == 1 & fmricuffrest2yn == 1)|  (!is.na(fmricuffipyn) & fmricuffipyn == 1 & fmricuffrest2yn == 1)) %>% 
  mutate(rest.cuff.end.diff1 = fmricuffpainrestscanend-fmricuffpainrestscanend2) %>% 
  filter(rest.cuff.end.diff1 != 0 | is.na(rest.cuff.end.diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,fmricuffpainrestscanend,fmricuffpainrestscanend2) %>% 
  mutate(fmricuffpainrestscanend = case_when(is.na(fmricuffpainrestscanend) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainrestscanend2 = case_when(is.na(fmricuffpainrestscanend2) ~ "x",TRUE ~ "x")) 

#create full iaerror8


m2kiaerror8a1 <- full_join(m2kiaerror8.1,m2kiaerror8.2,by=intersect(names(m2kiaerror8.1), names(m2kiaerror8.2))) 

m2kiaerror8a <- full_join(m2kiaerror8.3,m2kiaerror8a1,by=intersect(names(m2kiaerror8.3), names(m2kiaerror8a1))) 

#merge 7 and 8a 

m2kiaerror7_8a <- full_join(m2kiaerror7,m2kiaerror8a,by=intersect(names(m2kiaerror7), names(m2kiaerror8a)))







#"Surgical site pain (double entry)"
#Surgical site pain and body pain entries: "(IF all scans completed) OR (IF some scans completed AND 2nd resting-state) performed then check for mismatch in surgical site/ body pain entries or NAs.
m2kiaerror8.4 <- m2kiadf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(surg.diff3 = fmricuffpainaftlastscanss -fmricuffpainaftlastscanss2) %>% 
  filter(surg.diff3 != 0 | is.na(surg.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffpainaftlastscanss,fmricuffpainaftlastscanss2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainaftlastscanss = case_when(is.na(fmricuffpainaftlastscanss) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainaftlastscanss2 = case_when(is.na(fmricuffpainaftlastscanss2) ~"x",TRUE ~ "x"))
#"Body pain (double entry)"

m2kiaerror8.5 <- m2kiadf.complete%>% 
  filter((!is.na(fmricuffrest2yn) & fmricuffrest2yn==1) | fmricuffcompletescl == 1 ) %>% 
  mutate(body.diff3 = fmricuffpainaftlastscanany- fmricuffpainaftlastscanany2) %>% 
  filter(body.diff3 != 0 | is.na(body.diff3)) %>% 
  select(record_id,redcap_event_name,fmricuffpainaftlastscanany,fmricuffpainaftlastscanany2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffpainaftlastscanany = case_when(is.na(fmricuffpainaftlastscanany) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffpainaftlastscanany2 = case_when(is.na(fmricuffpainaftlastscanany2) ~ "x",TRUE ~ "x"))  


m2kiaerror8b<- full_join(m2kiaerror8.4,m2kiaerror8.5,by=intersect(names(m2kiaerror8.4), names(m2kiaerror8.5)))



#merge 7_8a and 8b

m2kiaerror7_8a_8b <- full_join(m2kiaerror7_8a,m2kiaerror8b,by=intersect(names(m2kiaerror7_8a), names(m2kiaerror8b)))



#merge all

m2kiaerror1_2_3_4_5_6_7_8 <- full_join(m2kiaerror1_2_3_4_5_6,m2kiaerror7_8a_8b,by=intersect(names(m2kiaerror1_2_3_4_5_6), names(m2kiaerror7_8a_8b)))






#Add checkbox for files uploaded to tacc
#IF a record (imaging_mcc1_v09_complete) is marked as completed then check for Dicom files uploaded to TACC

m2kiaerror9.1 <- m2kiaimaging %>% 
  filter((imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 1) | (imaging_mcc1_v09_complete == 2 & fmricuffcompletescl == 2)) %>% 
  filter(fmricuffdicuploaded != 1 | is.na(fmricuffdicuploaded)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffdicuploaded= case_when(is.na(fmricuffdicuploaded) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricuffdicuploaded)




#IF a record (imaging_mcc1_v09_complete) is marked as completed AND Test Completed (fmricuffcompletescl) is NA then flag IF uploaded to TACC?
m2kiaerror9.2 <- m2kiaimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(is.na(fmricuffcompletescl)) %>% 
  filter(fmricuffdicuploaded == 1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcompletescl = case_when(is.na(fmricuffcompletescl) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,fmricuffcompletescl) 
#merge 9.1 and 9.2 

m2kiaerror9.a <- full_join(m2kiaerror9.1,m2kiaerror9.2,by=intersect(names(m2kiaerror9.1), names(m2kiaerror9.2))) 



# if test completed fmricuffcompletescl == 1 or T1 completed fmricufft1yn == 1 or DWI completed fmricuffdwiyn == 1
# or 1st resting state completed fmricuffrest1yn completed == 1 or individualized fmricuffipyn == 1 completed
# or standard pressure completed fmricuffcpyn ==1 or 2nd resting state completed fmricuffrest2yn ==1 and mask work
# is NA fmri_face_mask 

m2kiaerror9.b <- m2kiaimaging %>% 
  filter(imaging_mcc1_v09_complete == 2) %>% 
  filter(fmricuffcompletescl == 1 | fmricufft1yn == 1 |fmricuffdwiyn == 1 | fmricuffrest1yn == 1 |
           fmricuffipyn == 1 | fmricuffcpyn ==1 |fmricuffrest2yn ==1) %>% 
  filter(is.na(fmri_face_mask)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(fmri_face_mask = case_when(is.na(fmri_face_mask) ~ "x",TRUE ~ as.character(fmri_face_mask))) %>% 
  select(record_id,redcap_event_name,imaging_mcc1_v09_complete,fmricuffcompletescl,fmri_face_mask) %>% 
  left_join(.,m1result_surg_no_na,by = c("record_id","redcap_event_name")) %>% 
  filter(mask_date_diff >= 0) %>% 
  select(record_id,redcap_event_name,fmri_face_mask) 



m2kiaerror9 <- full_join(m2kiaerror9.a,m2kiaerror9.b,by=intersect(names(m2kiaerror9.a), names(m2kiaerror9.b))) 


#merge all plus error 9

m2kiaerror1_2_3_4_5_6_7_8_9 <- full_join(m2kiaerror1_2_3_4_5_6_7_8,m2kiaerror9,by=intersect(names(m2kiaerror1_2_3_4_5_6_7_8), names(m2kiaerror9)))



#fetch notes wit dag
m2kianotes.imaging <- m2kiaimaging %>% 
  select(record_id,redcap_event_name, redcap_data_access_group) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




m2kiaerror1_2_3_4_5_6_7_8_notes <- left_join(m2kiaerror1_2_3_4_5_6_7_8_9,m2kianotes.imaging,by=c("record_id","redcap_event_name")) %>% 
  relocate(redcap_data_access_group, .after=redcap_event_name) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


names(m2kiaimaging)
m2kiaimage_table<- m2kiaerror1_2_3_4_5_6_7_8_notes %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name", "redcap_data_access_group"), 
              names_from = val_name,
              values_from = values)   %>% 
  replace(is.na(.), "1") %>% 
  
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2kimg_complete = 0) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

table(m2kiaimage_table$m2kimg_complete)


# compare line by line with qst from here
# recode 0,1 ie incomplete/unverified to 2
m2kimg_all <- m2kiaimaging %>% 
  filter(imaging_mcc1_v09_complete  == 0 |imaging_mcc1_v09_complete  == 1) %>% 
  mutate(m2kimg_complete = case_when(imaging_mcc1_v09_complete == 0 |imaging_mcc1_v09_complete == 1 ~ 2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(record_id,redcap_event_name,m2kimg_complete,redcap_data_access_group)



m2kiaimage_table[] <- lapply(m2kiaimage_table, as.character)
m2kimg_all[] <- lapply(m2kimg_all, as.character)

#merge all
m2kerror_img_all <- full_join(m2kiaimage_table,m2kimg_all,by = intersect(names(m2kiaimage_table), names(m2kimg_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") 



# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_img_all <- m2kiaimaging %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(imaging_mcc1_v09_complete= case_when(is.na(imaging_mcc1_v09_complete) ~ "8", TRUE ~ as.character(imaging_mcc1_v09_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,imaging_mcc1_v09_complete) 


#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerror_img_all[m2kerror_img_all== ""] <- NA


m2kerror_img_all <- m2kerror_img_all%>% 
  pivot_longer(cols = 4:last_col(), 
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# imaging_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_img <- full_join(m2kerror_img_all,m2kdata_img_all,by = intersect(names(m2kerror_img_all), names(m2kdata_img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kimg_complete = case_when(imaging_mcc1_v09_complete == "8" ~ "8", TRUE ~ as.character(m2kimg_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-imaging_mcc1_v09_complete)




m2kdat.image <- m2kfull_img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_Imaging") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kimg_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_Imaging") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>%
  mutate(m2kb.img = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))


m2kdata_imaging_wide <- m2kdat.image %>%
  pivot_wider (names_from = dataset,values_from = error) 



table(datam2k$imaging_mcc1_v09_complete, exclude = FALSE)
table(m2kdata_imaging_wide$m2kb.img)


### QST###



#fetch imaging data to link with QST
m2ktadata.image <- datam2k

# Ask hablar to guess most appropriate datatype
m2kdata.qst <- datam2k


#explore variables

#pptcompleteyn

#Check for subjects who did not complete ppt.
table(m2kdata.qst$pptcompleteyn, exclude = NULL)

#Check for subjects who did not complete the test.
table(m2kdata.qst$qst_mcc1_v03_complete, exclude = NULL)




#PPTs


#keep records with complete qst test and  ppt test.
m2kdata.qst2 <- m2kdata.qst %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(pptcompleteyn ==2 |pptcompleteyn ==  1 | pptcompleteyn == 3)




#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):

tabyl(m2kdata.qst2,pptcompleteyn,show_na= TRUE)


#check location of index site entered if test completed (both sites =1 OR 3 = Index site (med/lat joint line) )

m2kq2error1 <- m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  filter(is.na(pptpainlocation)) %>% 
  select(record_id,redcap_event_name,pptpainlocation) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptpainlocation = case_when(is.na(pptpainlocation) ~ "x"))






#Remote site (contralateral deltoid):
# check for missing or mismatch in PPT ratings for Remote site in both sites OR only contralateral deltoid:

#rep1
m2kq2error2.1 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff1 = pptremote1val - pptremote1val1) %>% 
  filter(ppt_contr_diff1 != 0 | is.na(ppt_contr_diff1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote1val = case_when(is.na(pptremote1val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptremote1val1 = case_when(is.na(pptremote1val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote1val1) 

#rep2
m2kq2error2.2 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff2 = pptremote2val - pptremote2val1) %>% 
  filter(ppt_contr_diff2 != 0 | is.na(ppt_contr_diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote2val = case_when(is.na(pptremote2val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptremote2val1 = case_when(is.na(pptremote2val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptremote2val,pptremote2val1) 


#rep3

m2kq2error2.3 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2) %>% 
  mutate(ppt_contr_diff3 = pptremote3val - pptremote3val1) %>% 
  filter(ppt_contr_diff3 != 0 | is.na(ppt_contr_diff3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptremote3val = case_when(is.na(pptremote3val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptremote3val1 = case_when(is.na(pptremote3val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptremote3val,pptremote3val1)




m2kq2error2a <-  full_join(m2kq2error2.1,m2kq2error2.2,by = intersect(names(m2kq2error2.1), names(m2kq2error2.2))) 

m2kq2error2 <-  full_join(m2kq2error2a,m2kq2error2.3,by = intersect(names(m2kq2error2a), names(m2kq2error2.3))) 




#merge error1 and 2


m2kq2error1_2 <- full_join(m2kq2error1,m2kq2error2,by = intersect(names(m2kq2error1), names(m2kq2error2)))



#Index site (med/lat joint line)::
# check for missing or mismatch in PPT ratings for index site in both site OR only Index site (med/lat joint line)::

#rep1
m2kq2error3.1 <-   m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff1 = pptindex1val - pptindex1val1) %>% 
  filter(ppt_index_diff1 != 0 | is.na(ppt_index_diff1)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex1val = case_when(is.na(pptindex1val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptindex1val1 = case_when(is.na(pptindex1val1) ~ "x",TRUE ~ "x")) %>%
  select(record_id,redcap_event_name,pptindex1val,pptindex1val1) 

#rep2
m2kq2error3.2 <-   m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff2 = pptindex2val - pptindex2val1) %>% 
  filter(ppt_index_diff2 != 0 | is.na(ppt_index_diff2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex2val = case_when(is.na(pptindex2val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptindex2val1 = case_when(is.na(pptindex2val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptindex2val,pptindex2val1) 

#rep3

m2kq2error3.3 <-   m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 3) %>% 
  mutate(ppt_index_diff3 = pptindex3val - pptindex3val1) %>% 
  filter(ppt_index_diff3 != 0 | is.na(ppt_index_diff3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(pptindex3val = case_when(is.na(pptindex3val) ~ "x",TRUE ~ "x")) %>% 
  mutate(pptindex3val1 = case_when(is.na(pptindex3val1) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,pptindex3val,pptindex3val1) 


m2kq2error3a1 <-  full_join(m2kq2error3.1,m2kq2error3.2,by = intersect(names(m2kq2error3.1), names(m2kq2error3.2))) 
m2kq2error3a <-  full_join(m2kq2error3a1,m2kq2error3.3,by = intersect(names(m2kq2error3a1), names(m2kq2error3.3))) 


#merge error1,2 and 3a


m2kq2error1_3 <- full_join(m2kq2error1_2,m2kq2error3a,by = intersect(names(m2kq2error1_2), names(m2kq2error3a))) 


#3b.1 check if remote site (pptcompleteyn == 2)  was checked  but PPt information was filled out for the index site 
#3b.2OR if both sites was checked but PPt information not filled out for the index site
#AND
# 3b.3check if index site(pptcompleteyn == 3) was checked  but PPt information was filled out for the remote site OR
#3b.4if both sites was checked but PPt information not filled out for the remote site 



m2kq2error3b.1 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 2) %>% 
  mutate(index1 = case_when((!is.na(pptindex1val) & !is.na(pptindex1val1))  | (!is.na(pptindex2val)  & !is.na(pptindex2val1)) | (!is.na(pptindex3val)  & !is.na(pptindex3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(index1 == 1)  %>% 
  select(record_id,redcap_event_name,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(as.character(.)))

m2kq2error3b.2 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(index2 = case_when((is.na(pptindex1val) & is.na(pptindex1val1))  | (is.na(pptindex2val)  & is.na(pptindex2val1)) | (is.na(pptindex3val)  & is.na(pptindex3val1))  ~ 1,TRUE ~ 0))%>% 
  filter(index2 == 1) %>% 
  select(record_id,redcap_event_name,pptindex1val,pptindex1val1,pptindex2val,pptindex2val1,pptindex3val,pptindex3val1,index2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2kq2error3b.2 <- m2kq2error3b.2 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  ) 



m2kq2error3b.3 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 3) %>% 
  mutate(remote1 = case_when((!is.na(pptremote1val) & !is.na(pptremote1val1))  | (!is.na(pptremote2val)  & !is.na(pptremote2val1)) | (!is.na(pptremote3val)  & !is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote1 == 1) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote1) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(as.character(.))) 


m2kq2error3b.4 <-  m2kdata.qst2 %>% 
  filter(pptcompleteyn == 1) %>% 
  mutate(remote2 = case_when((is.na(pptremote1val) & is.na(pptremote1val1))  | (is.na(pptremote2val)  & is.na(pptremote2val1)) | (is.na(pptremote3val)  & is.na(pptremote3val1))  ~ 1,TRUE ~ 0)) %>% 
  filter(remote2 == 1) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote1val1,pptremote2val,pptremote2val1,pptremote3val,pptremote3val1,remote2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2kq2error3b.4 <-m2kq2error3b.4 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



#merge error 3
###########
m2kq2error3c <- full_join(m2kq2error3b.1,m2kq2error3b.2,by = intersect(names(m2kq2error3b.1), names(m2kq2error3b.2)))
m2kq2error3d <- full_join(m2kq2error3b.3,m2kq2error3b.4,by = intersect(names(m2kq2error3b.3), names(m2kq2error3b.4)))

###########
m2kq2error3b <- full_join(m2kq2error3c,m2kq2error3d,by = intersect(names(m2kq2error3c), names(m2kq2error3d))) %>% 
  select(c(-index1,-index2,-remote1,-remote2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(across(.cols = 3:last_col(),
                .fns = ~ ifelse(!is.na(.x) == TRUE, "x", 1)))
# 
m2kq2error1_3[] <- lapply(m2kq2error1_3, as.character)
m2kq2error3b[] <- lapply(m2kq2error3b, as.character)


m2kq2error1_3_3b <- full_join(m2kq2error1_3,m2kq2error3b,by = intersect(names(m2kq2error1_3), names(m2kq2error3b))) 



# check if all information was available to compute mean PPT values at each site as outcome variables (index site = primary data point; remote site = secondary data point).


m2kq2ppt.biomarker <-  m2kdata.qst2 %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 3)) %>% 
  rowwise() %>%
  mutate(mean1 = mean(c(pptindex1val,pptindex2val,pptindex3val))) %>%  
  filter(is.na(mean1)) %>%
  select(record_id,redcap_event_name,pptindex1val,pptindex2val,pptindex3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptindex")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



# secondary data point


m2kq2ppt.biomarker1 <-  m2kdata.qst2 %>% 
  filter((pptcompleteyn == 1 | pptcompleteyn == 2)) %>% 
  rowwise() %>%
  mutate(mean2 = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  filter(is.na(mean2)) %>% 
  select(record_id,redcap_event_name,pptremote1val,pptremote2val,pptremote3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(starts_with("pptremote")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


m2kq2ppt.all.biomarker <- full_join(m2kq2ppt.biomarker,m2kq2ppt.biomarker1,by=c("record_id","redcap_event_name"))


m2kq2ppt.all.biomarker[] <- lapply(m2kq2ppt.all.biomarker, as.character)
m2kq2error1_3_3b[] <- lapply(m2kq2error1_3_3b, as.character)

m2kq2error2_3_3b_endpoint <- full_join(m2kq2error1_3_3b,m2kq2ppt.all.biomarker,by = intersect(names(m2kq2error1_3_3b), names(m2kq2ppt.all.biomarker))) 


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kq2error2_3_3b_endpoint [m2kq2error2_3_3b_endpoint == ""] <- NA

m2kq2error2_3_3b_endpoint1 <- m2kq2error2_3_3b_endpoint %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#Temporal Summation:


#PPTs

# check for missingness in "ts test completed"



#Remove records with missing "ts test completed",# keep record with "tscompleted test completed"

m2kta.complete <- m2kdata.qst %>% 
  filter(qst_mcc1_v03_complete == 2) %>%
  filter(tscompleted ==2 |tscompleted ==  1 | tscompleted == 3)




#Remote site (contralateral deltoid):
# check for missing or mismatch in pain ratings for Remote site in both sites OR only contralateral deltoid:

#rep1 initial
m2ktaerror4.1 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init1 = tsrep1initialpainrem - tsrep1initialpainrem_d) %>% 
  filter(ts_contr_init1 != 0 | is.na(ts_contr_init1))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainrem = case_when(is.na(tsrep1initialpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep1initialpainrem_d = case_when(is.na(tsrep1initialpainrem_d) ~ "x",TRUE ~ "x" )) %>%
  select(record_id,redcap_event_name,tscompleted,tsrep1initialpainrem,tsrep1initialpainrem_d) 


#rep1 final
m2ktaerror4.2 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin1 = tsrep1finalpainrem - tsrep1finalpainrem_d) %>% 
  filter(ts_contr_fin1 != 0 | is.na(ts_contr_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainrem = case_when(is.na(tsrep1finalpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep1finalpainrem_d = case_when(is.na(tsrep1finalpainrem_d) ~ "x",TRUE ~ "x")) %>%
  select(record_id,redcap_event_name,tscompleted,tsrep1finalpainrem,tsrep1finalpainrem_d) 


#rep1 set 
m2ktarep1.set <- full_join(m2ktaerror4.1,m2ktaerror4.2,by = intersect(names(m2ktaerror4.1), names(m2ktaerror4.2))) 

#rep2 initial

m2ktaerror4.3 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init2 = tsrep2initialpainrem - tsrep2initialpainrem_d) %>% 
  filter(ts_contr_init2 != 0 | is.na(ts_contr_init2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>%
  mutate(tsrep2initialpainrem = case_when(is.na(tsrep2initialpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep2initialpainrem_d = case_when(is.na(tsrep2initialpainrem_d) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,tscompleted,tsrep2initialpainrem,tsrep2initialpainrem_d)

#rep2 final
m2ktaerror4.4 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin2 = tsrep2finalpainrem - tsrep2finalpainrem_d) %>% 
  filter(ts_contr_fin2 != 0 | is.na(ts_contr_fin2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep2finalpainrem = case_when(is.na(tsrep2finalpainrem) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsrep2finalpainrem_d = case_when(is.na(tsrep2finalpainrem_d) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,tscompleted,tsrep2finalpainrem,tsrep2finalpainrem_d) 

#rep2 set 
m2ktarep2.set <- full_join(m2ktaerror4.3,m2ktaerror4.4,by = intersect(names(m2ktaerror4.3),names(m2ktaerror4.4)))


#rep3 initial

m2ktaerror4.5 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_init3 = tsinitialpainremsclr3 - tsinitialpainremscl1r3) %>% 
  filter(ts_contr_init3 != 0 | is.na(ts_contr_init3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainremsclr3 = case_when(is.na(tsinitialpainremsclr3) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsinitialpainremscl1r3 = case_when(is.na(tsinitialpainremscl1r3) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,tscompleted,tsinitialpainremsclr3,tsinitialpainremscl1r3)

#rep3 final
m2ktaerror4.6 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  mutate(ts_contr_fin3 = tsfinalpainremsclr3 - tsfinalpainremscl1r3) %>% 
  filter(ts_contr_fin3!=0 | is.na(ts_contr_fin3))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremsclr3 = case_when(is.na(tsfinalpainremsclr3) ~ "x",TRUE ~ "x")) %>% 
  mutate(tsfinalpainremscl1r3 = case_when(is.na(tsfinalpainremscl1r3) ~ "x",TRUE ~ "x" ))%>% 
  select(record_id,redcap_event_name,tscompleted,tsfinalpainremsclr3,tsfinalpainremscl1r3) 

#rep3 set 
m2ktarep3.set <- full_join(m2ktaerror4.5,m2ktaerror4.6,by = intersect(names(m2ktaerror4.5),names(m2ktaerror4.6)))


# # convert all char for merging
# rep1.set[] <- lapply(rep1.set, as.character)
# rep2.set[] <- lapply(rep2.set, as.character)
# rep3.set[] <- lapply(rep3.set, as.character)


#all reps

m2kta_remote_all_reps1a <- full_join(m2ktarep1.set,m2ktarep2.set,by = intersect(names(m2ktarep1.set),names(m2ktarep2.set)))
m2kta_remote_all_reps1 <-full_join(m2kta_remote_all_reps1a,m2ktarep3.set,by = intersect(names(m2kta_remote_all_reps1a),names(m2ktarep3.set)))

#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be assigned 1, missing information will be coded as 0 
m2kta1 <- m2kta_remote_all_reps1 %>% 
  mutate(tarep1 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep1initialpainrem))  & (is.na(tsrep1initialpainrem_d))  & (is.na(tsrep1finalpainrem)) & (is.na(tsrep1finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(tarep2 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsrep2initialpainrem))  & (is.na(tsrep2initialpainrem_d))  & (is.na(tsrep2finalpainrem)) & (is.na(tsrep2finalpainrem_d))~ 1,TRUE ~ 0)) %>% 
  mutate(tarep3 = case_when((tscompleted == 1 | tscompleted == 2) & (is.na(tsinitialpainremsclr3))  & (is.na(tsinitialpainremscl1r3))  & (is.na(tsfinalpainremsclr3)) & (is.na(tsfinalpainremscl1r3))~ 1,TRUE ~ 0)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# ts2 <- ts1 %>% 
#   filter(rep1 ==0 & rep2 ==0 & rep3 ==0)
# 
# Ts_remote_all_reps <- ts2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS contralateral rep1 initial"= tsrep1initialpainrem,"TS contralateral rep1 initial(double entry)"= tsrep1initialpainrem_d,"TS contralateral rep1 final"= tsrep1finalpainrem,"TS contralateral rep1 final(double entry)"= tsrep1finalpainrem_d,"TS contralateral rep2 initial"= tsrep2initialpainrem,"TS contralateral rep2 initial(double entry)"= tsrep2initialpainrem_d,"TS contralateral rep2 final"= tsrep2finalpainrem,"TS contralateral rep2 final(double entry)"= tsrep2finalpainrem_d ,"TS contralateral rep3 initial"= tsinitialpainremsclr3,"TS contralateral rep3 initial(double entry)"= tsinitialpainremscl1r3,"TS contralateral rep3 final"= tsfinalpainremsclr3,"TS contralateral rep3 final(double entry)"= tsfinalpainremscl1r3 ))







#index site Index site (med/lat knee)

# check for missing or mismatch in pain ratings for  Index site (med/lat knee) in both site OR  Index site (med/lat knee):

#rep1 initial
m2ktaerror6.1 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init1 = tsrep1initialpainindex - tsrep1initialpainindex_d) %>% 
  filter(ts_ind_init1 != 0 | is.na(ts_ind_init1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1initialpainindex = case_when(is.na(tsrep1initialpainindex) ~ "x",TRUE ~ "x")) %>%
  mutate(tsrep1initialpainindex_d = case_when(is.na(tsrep1initialpainindex_d) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsrep1initialpainindex,tsrep1initialpainindex_d,tscompleted)

#rep1 final 

m2ktaerror6.2 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin1 = tsrep1finalpainindex - tsrep1finalpainindex_d) %>% 
  filter(ts_ind_fin1 != 0 | is.na(ts_ind_fin1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsrep1finalpainindex = case_when(is.na(tsrep1finalpainindex) ~ "x",TRUE ~ "x")) %>%
  mutate(tsrep1finalpainindex_d = case_when(is.na(tsrep1finalpainindex_d) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1finalpainindex_d,tscompleted)



#rep1 set 
m2ktarep1.index.set <- full_join(m2ktaerror6.1,m2ktaerror6.2,by = intersect(names(m2ktaerror6.1),names(m2ktaerror6.2)))

#rep2 initial

m2ktaerror6.3 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init2 = tsinitialpainindexsclr2 - tsinitialpainindexscl1r2) %>% 
  filter(ts_ind_init2 != 0 | is.na(ts_ind_init2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr2 = case_when(is.na(tsinitialpainindexsclr2) ~ "x",TRUE ~ "x"))%>%
  mutate(tsinitialpainindexscl1r2 = case_when(is.na(tsinitialpainindexscl1r2) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tscompleted)


#rep2 final
m2ktaerror6.4 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin2 = tsfinalpainindexsclr2 - tsfinalpainindexscl1r2) %>% 
  filter(ts_ind_fin2 != 0 | is.na(ts_ind_fin2)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr2 = case_when(is.na(tsfinalpainindexsclr2) ~ "x",TRUE ~ "x"))%>%
  mutate(tsfinalpainindexscl1r2 = case_when(is.na(tsfinalpainindexscl1r2) ~ "x",TRUE ~ "x"))%>%
  select(record_id,redcap_event_name,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tscompleted)


#rep2 set 
m2ktarep2.index.set <- full_join(m2ktaerror6.3,m2ktaerror6.4,by = intersect(names(m2ktaerror6.3),names(m2ktaerror6.4)))


#rep3 initial

m2ktaerror6.5 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_init3 = tsinitialpainindexsclr3 - tsinitialpainindexscl1r3) %>% 
  filter(ts_ind_init3 != 0 | is.na(ts_ind_init3)) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsinitialpainindexsclr3 = case_when(is.na(tsinitialpainindexsclr3) ~ "x",TRUE ~ "x"))%>%
  mutate(tsinitialpainindexscl1r3 = case_when(is.na(tsinitialpainindexscl1r3) ~ "x",TRUE ~ "x" ))%>%
  select(record_id,redcap_event_name,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tscompleted) 

#rep3 final
m2ktaerror6.6 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  mutate(ts_ind_fin3 = tsfinalpainindexsclr3 - tsfinalpainindexscl1r3) %>% 
  filter(ts_ind_fin3!=0 | is.na(ts_ind_fin3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindexsclr3 = case_when(is.na(tsfinalpainindexsclr3) ~ "x",TRUE ~ "x"))%>%
  mutate(tsfinalpainindexscl1r3 = case_when(is.na(tsfinalpainindexscl1r3) ~ "x",TRUE ~ "x")) %>% 
  select(record_id,redcap_event_name,tsfinalpainindexsclr3,tsfinalpainindexscl1r3,tscompleted) 

#rep3 set 
m2ktarep3.index.set <- full_join(m2ktaerror6.5,m2ktaerror6.6,by = intersect(names(m2ktaerror6.5),names(m2ktaerror6.6)))

# # convert all char for merging
# rep1.index.set[] <- lapply(rep1.index.set, as.character)
# rep2.index.set[] <- lapply(rep2.index.set, as.character)
# rep3.index.set[] <- lapply(rep3.index.set, as.character)

#all reps 
m2kta_index_all_reps1s <- full_join(m2ktarep1.index.set,m2ktarep2.index.set,by = intersect(names(m2ktarep1.index.set),names(m2ktarep2.index.set)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2kta_index_all_reps1 <- full_join(m2kta_index_all_reps1s,m2ktarep3.index.set,by = intersect(names(m2kta_index_all_reps1s),names(m2ktarep3.index.set)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

##all reps,create variables for reps completed, 
#all reps,create variables for reps completed, NAs here means that the information was present and correct and will be given 1, missing information will be coded as 0


m2kta.index1 <- m2kta_index_all_reps1 %>% 
  mutate(ind.rep1 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsrep1initialpainindex))  & (is.na(tsrep1initialpainindex_d))  & (is.na(tsrep1finalpainindex)) & (is.na(tsrep1finalpainindex_d))~ 1,TRUE ~ 0))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2kta.index1 <- m2kta.index1 %>% 
  mutate(ind.rep2 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr2))  & (is.na(tsinitialpainindexscl1r2))  & (is.na(tsfinalpainindexsclr2)) & (is.na(tsfinalpainindexscl1r2))~ 1,TRUE ~ 0))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2kta.index1 <- m2kta.index1 %>% 
  mutate(ind.rep3 = case_when((tscompleted == 1 | tscompleted == 3) & (is.na(tsinitialpainindexsclr3))  & (is.na(tsinitialpainindexscl1r3))  & (is.na(tsfinalpainindexsclr3)) & (is.na(tsfinalpainindexscl1r3))~ 1,TRUE ~ 0))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# ts.index2 <- ts.index1 %>% 
#   filter(ind.rep1 ==0 & ind.rep2 ==0 & ind.rep3 ==0)
# 
# Ts_index_all_reps <- ts.index2 %>% 
#   select(c(-tscompleted,-rep1,-rep2,-rep3)) %>% 
#   rename(c("TS test completed?" = tscompleted.factor,"TS index rep1 initial"= tsrep1initialpainindex,"TS index rep1 initial(double entry)"= tsrep1initialpainindex_d,"TS index rep1 final"= tsrep1finalpainindex,"TS index rep1 final(double entry)"= tsrep1finalpainindex_d,"TS index rep2 initial"= tsinitialpainindexsclr2,"TS index rep2 initial(double entry)"= tsinitialpainindexscl1r2 ,"TS index rep2 final"= tsfinalpainindexsclr2,"TS index rep2 final(double entry)"= tsfinalpainindexscl1r2,"TS index rep3 initial"= tsinitialpainindexsclr3,"TS index rep3 initial(double entry)"= tsinitialpainindexscl1r3,"TS index rep3 final"= tsfinalpainindexsclr3,"TS index rep3 final(double entry)"= tsfinalpainindexscl1r3))





#if one rep is complete with no mismatch then all.reps.rem == 1 else 0
m2kta1 <- m2kta1 %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(all.reps.rem = case_when(tarep1 == "0"  & tarep2== "0"  & tarep3== "0"  ~ "x",TRUE ~ "1"))

glimpse(m2kta1)

#if one rep is complete with no mismatch then all.reps.ind== 1 else 0
m2kta.index1 <- m2kta.index1 %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(all.reps.ind = case_when(ind.rep1 == "0"  & ind.rep2=="0"  & ind.rep3== "0"  ~ "x",TRUE ~ "1"))
# 
# # convert all char for merging
# ts1[] <- lapply(ts1, as.character)
# ts.index1[] <- lapply(ts.index1, as.character)


# combine temp summation at remote and index site to see if ts was completed for both sites and yet there was missing info for either remote or index site OR ts completed for index site and there was missing info for index site  OR ts was completed for remote site but there was missing info for remote site
m2ktarem.ind <- full_join(m2kta1,m2kta.index1,by = intersect(names(m2kta1),names(m2kta.index1)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter((tscompleted == "2" & all.reps.rem == "x")| (tscompleted == "3" & all.reps.ind == "x") | (tscompleted == "1" & all.reps.rem == 0 |all.reps.ind == "x" ) )

m2ktarem_index_all_reps <- m2ktarem.ind %>% 
  select(record_id,redcap_event_name,all.reps.rem,all.reps.ind)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  rename("all_TS_remote_missing" = all.reps.rem,"all_TS_index_missing"= all.reps.ind)

glimpse(m2ktarem.ind)





# once TS Remote site (contralateral deltoid) is completed
# missing after sensation at 15 secs

m2ktaerror5.1 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts15)) %>% 
  select(record_id,redcap_event_name,tsfinalpainremafts15) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremafts15=replace_na("x")) 


# missing after sensation at 30 secs
m2ktaerror5.2 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>% 
  filter(is.na(tsfinalpainremafts30)) %>% 
  select(record_id,redcap_event_name,tsfinalpainremafts30)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainremafts30=replace_na("x")) 

# 
# # convert all char for merging
# rem_index_all_reps[] <- lapply(rem_index_all_reps, as.character)
# error5.1[] <- lapply(error5.1, as.character)
# error5.2[] <- lapply(error5.2, as.character)


m2kta_remote_all_reps_sensations <- full_join(m2ktarem_index_all_reps,m2ktaerror5.1,by = c("record_id","redcap_event_name")) %>% 
  full_join(.,m2ktaerror5.2,by= c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# once TS  Index site (med/lat knee)is completed
# missing after sensation at 15 secs

m2ktaerror7.1 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts15)) %>% 
  select(record_id,redcap_event_name,tsfinalpainindafts15)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindafts15=replace_na("x")) 


# missing after sensation at 30 secs
m2ktaerror7.2 <-  m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>% 
  filter(is.na(tsfinalpainindafts30)) %>% 
  select(record_id,redcap_event_name,tsfinalpainindafts30) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(tsfinalpainindafts30=replace_na("x"))





# convert all char for merging
# Ts_remote_all_reps_sensations[] <- lapply(Ts_remote_all_reps_sensations, as.character)
# error7.1[] <- lapply(error7.1, as.character)
# error7.2[] <- lapply(error7.2, as.character)


#merge all
m2kta_index_remote_all_reps_sensation <- full_join(m2kta_remote_all_reps_sensations,m2ktaerror7.1,by = c("record_id","redcap_event_name")) %>% 
  full_join(.,m2ktaerror7.2,by= c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




# check if a.only remote site was checked  but pain ratings were filled out for the index site or both
#will not recode NA as missing b/c we are highlighting filled data 

m2ktaerror7.3a <- m2kta.complete %>% 
  filter(tscompleted == 2) %>% 
  mutate(ts.index1 = case_when((!is.na(tsrep1initialpainindex) & !is.na(tsrep1initialpainindex_d))  | (!is.na(tsrep1finalpainindex)  & !is.na(tsrep1finalpainindex_d)) | (!is.na(tsinitialpainindexsclr2)  & !is.na(tsinitialpainindexscl1r2)) | (!is.na(tsfinalpainindexsclr2) & !is.na(tsfinalpainindexscl1r2))  | (!is.na(tsinitialpainindexsclr3)  & !is.na(tsinitialpainindexscl1r3)) | (!is.na(tsfinalpainindexsclr3)  & !is.na(tsfinalpainindexscl1r3))  ~ "x",TRUE ~ "1"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(ts.index1 == "x")  %>% 
  select(record_id,redcap_event_name,ts.index1) %>% 
  rename("mismatch_bw_site_and_datafilled"=ts.index1)




#OR b.if both sites was checked but pain ratings not filled out for the index site 

m2ktaerror7.3b <- m2kta.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothindex1 = case_when(is.na(tsrep1initialpainindex) & is.na(tsrep1initialpainindex_d)  & is.na(tsrep1finalpainindex)  & is.na(tsrep1finalpainindex_d) & is.na(tsinitialpainindexsclr2)  & is.na(tsinitialpainindexscl1r2) & is.na(tsfinalpainindexsclr2) & is.na(tsfinalpainindexscl1r2)  & is.na(tsinitialpainindexsclr3)  & is.na(tsinitialpainindexscl1r3) & is.na(tsfinalpainindexsclr3)  & is.na(tsfinalpainindexscl1r3)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothindex1 == 1) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainindex,tsrep1initialpainindex_d,tsrep1finalpainindex,tsrep1finalpainindex_d,tsinitialpainindexsclr2,tsinitialpainindexscl1r2,tsfinalpainindexsclr2,tsfinalpainindexscl1r2,tsinitialpainindexsclr3,tsinitialpainindexscl1r3,tsfinalpainindexsclr3,tsfinalpainindexscl1r3) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )




# check if a.index site was checked  but pain ratings were filled out for the remote site or both sites, 
#will not recode NA as missing b/c we are highlighting filled data 


m2ktaerror7.4a <- m2kta.complete %>% 
  filter(tscompleted == 3) %>% 
  mutate(ts.remote1 = case_when((!is.na(tsrep1initialpainrem) & !is.na(tsrep1initialpainrem_d))  | (!is.na(tsrep1finalpainrem)  & !is.na(tsrep1finalpainrem_d)) | (!is.na(tsrep2initialpainrem)  & !is.na(tsrep2initialpainrem_d)) | (!is.na(tsrep2finalpainrem) & !is.na(tsrep2finalpainrem_d))  | (!is.na(tsinitialpainremsclr3)  & !is.na(tsinitialpainremscl1r3)) | (!is.na(tsfinalpainremsclr3)  & !is.na(tsfinalpainremscl1r3))  ~ "x",TRUE ~ "1"))  %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  filter(ts.remote1 == "x") %>% 
  select(record_id,redcap_event_name,ts.remote1) %>% 
  rename("mismatch_bw_site_and_datafilled"=ts.remote1)


#OR b.if both sites was checked but pain ratings not filled out for the remote site


m2ktaerror7.4b <- m2kta.complete %>% 
  filter(tscompleted == 1) %>% 
  mutate(ts.bothrem1 = case_when(is.na(tsrep1initialpainrem) & is.na(tsrep1initialpainrem_d)  & is.na(tsrep1finalpainrem)  & is.na(tsrep1finalpainrem_d) & is.na(tsrep2initialpainrem)  & is.na(tsrep2initialpainrem_d) & is.na(tsrep2finalpainrem) & is.na(tsrep2finalpainrem_d)  & is.na(tsinitialpainremsclr3)  & is.na(tsinitialpainremscl1r3) & is.na(tsfinalpainremsclr3)  & is.na(tsfinalpainremscl1r3)  ~ 1,TRUE ~ 0))  %>%
  filter(ts.bothrem1 == 1) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainrem,tsrep1initialpainrem_d,tsrep1finalpainrem,tsrep1finalpainrem_d,tsrep2initialpainrem,tsrep2initialpainrem_d,tsrep2finalpainrem,tsrep2finalpainrem_d,tsinitialpainremsclr3,tsinitialpainremscl1r3,tsfinalpainremsclr3,tsfinalpainremscl1r3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )






#merge 7.3a,7.3b,7.4a,7.4b





m2ktaerror7.3a[] <- lapply(m2ktaerror7.3a, as.character)
m2ktaerror7.3b[] <- lapply(m2ktaerror7.3b, as.character)
m2ktaerror7.4a[] <- lapply(m2ktaerror7.4a, as.character)
m2ktaerror7.4b[] <- lapply(m2ktaerror7.4b, as.character)


m2ktamerged7.3 <- full_join(m2ktaerror7.3a,m2ktaerror7.3b,by = intersect(names(m2ktaerror7.3a), names(m2ktaerror7.3b)))
m2ktamerged7.4 <- full_join(m2ktaerror7.4a,m2ktaerror7.4b,by = intersect(names(m2ktaerror7.4a), names(m2ktaerror7.4b)))

m2ktamerged7 <- full_join(m2ktamerged7.3,m2ktamerged7.4,by = intersect(names(m2ktamerged7.3), names(m2ktamerged7.4)))


#rename merged7
m2ktamerged7.1 <- m2ktamerged7 


# change  to as.character for merging
m2kta_index_remote_all_reps_sensation [] <- lapply(m2kta_index_remote_all_reps_sensation , as.character)
m2ktamerged7.1[] <- lapply(m2ktamerged7.1, as.character)


#merge Ts_index_remote_all_reps_sensation and merged7.1 

m2ktamerge8 <- full_join(m2ktamerged7.1,m2kta_index_remote_all_reps_sensation ,by = intersect(names(m2ktamerged7.1), names(m2kta_index_remote_all_reps_sensation ))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# Biomarker

# Primary endpoint(primary (index) and secondary biomarker(remote)): Mean of 3 MTS Difference scores computed (Max  initial);
# Secondary endpoint(primary (index) and secondary biomarker(remote): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <1 rep it will not be flagged
m2ktaprim.outcome.index <- m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index = pmax(tsrep1finalpainindex,tsrep1initialpainindex)) %>% 
  mutate(diff.rep1.index = max.rep1.index - tsrep1initialpainindex) %>% 
  mutate(max.rep2.index = pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2)) %>% 
  mutate(diff.rep2.index = max.rep2.index - tsinitialpainindexsclr2) %>% 
  mutate(max.rep3.index = pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3)) %>% 
  mutate(diff.rep3.index = max.rep3.index - tsinitialpainindexsclr3) %>% 
  mutate(diff.rep1.index = as.numeric(diff.rep1.index)) %>% 
  mutate(diff.rep2.index = as.numeric(diff.rep2.index)) %>%
  mutate(diff.rep3.index = as.numeric(diff.rep3.index)) %>%
  rowwise() %>%
  mutate(mean.index = mean(c(diff.rep1.index,diff.rep2.index,diff.rep3.index))) %>% 
  filter(is.na(mean.index) & is.na(diff.rep1.index) & is.na(diff.rep2.index) & is.na(diff.rep3.index)) %>% 
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


m2ktaprim.outcome.remote <- m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote = pmax(tsrep1initialpainrem,tsrep1finalpainrem)) %>% 
  mutate(diff.rep1.remote = max.rep1.remote - tsrep1initialpainrem) %>% 
  mutate(max.rep2.remote = pmax(tsrep2initialpainrem,tsrep2finalpainrem)) %>% 
  mutate(diff.rep2.remote = max.rep2.remote - tsrep2initialpainrem) %>% 
  mutate(max.rep3.remote = pmax(tsinitialpainremsclr3,tsfinalpainremsclr3)) %>% 
  mutate(diff.rep3.remote = max.rep3.remote - tsinitialpainremsclr3) %>% 
  mutate(diff.rep1.remote = as.numeric(diff.rep1.remote)) %>% 
  mutate(diff.rep2.remote = as.numeric(diff.rep2.remote)) %>%
  mutate(diff.rep3.remote = as.numeric(diff.rep3.remote)) %>%
  rowwise() %>%
  mutate(mean.remote = mean(c(diff.rep1.remote,diff.rep2.remote,diff.rep3.remote))) %>% 
  filter(is.na(mean.remote) & is.na(diff.rep1.remote) & is.na(diff.rep2.remote) & is.na(diff.rep3.remote)) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3)%>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



m2kta_primary_outcome <-  full_join(m2ktaprim.outcome.index, m2ktaprim.outcome.remote ,by = intersect(names(m2ktaprim.outcome.remote), names(m2ktaprim.outcome.index )))





# # change  to as.character for merging
m2ktamerge8 [] <- lapply(m2ktamerge8 , as.character)
m2kta_primary_outcome[] <- lapply(m2kta_primary_outcome, as.character)

#merge merge8.1  with ts_primary_outcome

m2kta.all.prim.outcome <- full_join(m2ktamerge8,m2kta_primary_outcome ,by = intersect(names(m2ktamerge8), names(m2kta_primary_outcome)))

# Secondary(primary (index) and secondary biomarker(remote)): Mean of 3 Wind-up ratios (WUR) computed ([Max +1]/ [initial +1]). (1 added
# to handle possibility of zero initial pain rating in denominator). 

#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m2ktasec.outcome.index <- m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 3) %>%
  mutate(max.rep1.index1 = 1+(pmax(tsrep1finalpainindex,tsrep1initialpainindex))) %>% 
  mutate(init.rep1.index1 = 1+(tsrep1initialpainindex)) %>% 
  mutate(div.rep1.index1 = max.rep1.index1/init.rep1.index1) %>% 
  
  mutate(max.rep2.index1 = 1+(pmax(tsfinalpainindexsclr2,tsinitialpainindexsclr2))) %>% 
  mutate(init.rep2.index1 = 1+(tsinitialpainindexsclr2)) %>% 
  mutate(div.rep2.index1 = max.rep2.index1/init.rep2.index1) %>% 
  
  mutate(max.rep3.index1 = 1+(pmax(tsfinalpainindexsclr3,tsinitialpainindexsclr3))) %>% 
  mutate(init.rep3.index1 = 1+(tsinitialpainindexsclr3)) %>% 
  mutate(div.rep3.index1 = max.rep3.index1/init.rep3.index1) %>%
  rowwise() %>%
  mutate(mean.sec.index = mean(c(div.rep1.index1,div.rep2.index1,div.rep3.index1))) %>% 
  filter(is.na(mean.sec.index) & is.na(div.rep1.index1) & is.na(div.rep2.index1) & is.na(div.rep3.index1)) %>% 
  select(record_id,redcap_event_name,tsrep1finalpainindex,tsrep1initialpainindex,tsfinalpainindexsclr2,tsinitialpainindexsclr2,tsfinalpainindexsclr3,tsinitialpainindexsclr3) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("index")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


#this is conditioned on having 3 reps, if a record has <3 reps it will not be flagged
m2ktasec.outcome.remote <- m2kta.complete %>% 
  filter(tscompleted == 1 | tscompleted == 2) %>%
  mutate(max.rep1.remote1 = 1+(pmax(tsrep1initialpainrem,tsrep1finalpainrem))) %>% 
  mutate(init.rep1.remote1 = 1+(tsrep1initialpainrem)) %>% 
  mutate(div.rep1.remote1 = max.rep1.remote1/init.rep1.remote1) %>% 
  
  mutate(max.rep2.remote1 = 1+(pmax(tsrep2initialpainrem,tsrep2finalpainrem))) %>% 
  mutate(init.rep2.remote1 = 1+(tsrep2initialpainrem)) %>% 
  mutate(div.rep2.remote1 = max.rep2.remote1/init.rep2.remote1) %>% 
  
  mutate(max.rep3.remote1 = 1+(pmax(tsinitialpainremsclr3,tsfinalpainremsclr3))) %>% 
  mutate(init.rep3.remote1 = 1+(tsinitialpainremsclr3)) %>% 
  mutate(div.rep3.remote1 = max.rep3.remote1/init.rep3.remote1) %>%
  rowwise() %>%
  mutate(mean.sec.remote = mean(c(div.rep1.remote1,div.rep2.remote1,div.rep3.remote1))) %>% 
  filter(is.na(mean.sec.remote) & is.na(div.rep1.remote1) & is.na(div.rep2.remote1) & is.na(div.rep3.remote1)) %>% 
  select(record_id,redcap_event_name,tsrep1initialpainrem,tsrep1finalpainrem,tsrep2initialpainrem,tsrep2finalpainrem,tsinitialpainremsclr3,tsfinalpainremsclr3) %>%
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("painrem")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )

m2kta_sec_outcome <-  full_join(m2ktasec.outcome.index, m2ktasec.outcome.remote ,by = intersect(names(m2ktasec.outcome.remote), names(m2ktasec.outcome.index )))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# change  to as.character for merging
m2kta_sec_outcome [] <- lapply(m2kta_sec_outcome , as.character)
m2kta.all.prim.outcome[] <- lapply(m2kta.all.prim.outcome, as.character)


#merge ts_sec_outcome  with ts.all.prim.outcome
m2kta.all.prim.sec.outcome <- full_join(m2kta_sec_outcome ,m2kta.all.prim.outcome ,by = intersect(names(m2kta_sec_outcome), names(m2kta.all.prim.outcome )))



m2kta.all.prim.sec.outcome <- m2kta.all.prim.sec.outcome  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#ensure each combination of ID and redcap event has one row with all values and is not duplicated
m2kta.all.prim.sec.outcome[m2kta.all.prim.sec.outcome== ""] <- NA


m2kta.all.prim.sec.outcome <- m2kta.all.prim.sec.outcome %>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#CPM

#


#Remove records with missing "cp test completed"

m2ktadata1cp <- m2kdata.qst %>% 
  filter(!is.na(cpmcompleteyn))

#recheck if NAs removed

tabyl(m2ktadata1cp,cpmcompleteyn,show_na= TRUE)

# keep record with "cpm test completed"

m2ktacpm.complete <- m2ktadata1cp %>% 
  filter(cpmcompleteyn != 0 & qst_mcc1_v03_complete == 2)

#check if all ppt.completed now has completed records, where 0= niether site, 1= both sites, 2= remote(shoulder) ,3 = Index site (med/lat joint line):

tabyl(m2ktacpm.complete,cpmcompleteyn,show_na= TRUE)



#water temp not checked

m2ktacpm.error1 <- m2ktacpm.complete %>% 
  filter(cpmcoldwatertempc != 1) %>% 
  select(record_id,redcap_event_name,cpmcoldwatertempc) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwatertempc = case_when(cpmcoldwatertempc != 1 ~ "x",TRUE ~ "x"))



# missing or mismatch in cold water pain rating at 30 sec

m2ktacpm.error2 <- m2ktacpm.complete %>% 
  filter(cpmbathrangeyn == 1 |(cpmbathrangeyn == 2 & cpmoutrangetime >= 30)) %>% 
  mutate(diff_30 = cpmcoldwaterpain30sscl - cpmcoldwaterpain30sscl1) %>% 
  filter(diff_30!=0 | is.na(diff_30)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain30sscl = case_when(is.na(cpmcoldwaterpain30sscl) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmcoldwaterpain30sscl1 = case_when(is.na(cpmcoldwaterpain30sscl1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmcoldwaterpain30sscl,cpmcoldwaterpain30sscl1) 




# missing or mismatch in cold water pain rating at 60 sec
m2ktacpm.error3 <- m2ktacpm.complete %>% 
  filter(cpmbathrangeyn == 1| (cpmbathrangeyn == 2 & cpmoutrangetime >= 60))  %>% 
  mutate(diff_60 = cpmcoldwaterpain60sscl - cpmcoldwaterpain60sscl1) %>% 
  filter(diff_60!=0 | is.na(diff_60)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmcoldwaterpain60sscl = case_when(is.na(cpmcoldwaterpain60sscl) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmcoldwaterpain60sscl1 = case_when(is.na(cpmcoldwaterpain60sscl1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmcoldwaterpain60sscl,cpmcoldwaterpain60sscl1) 




#merge error 2&3

m2kta_sec_outcome <-  full_join(m2ktasec.outcome.index, m2ktasec.outcome.remote ,by = intersect(names( m2ktasec.outcome.remote), names(m2ktasec.outcome.index )))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2ktaerrorcpm2_3 <- full_join(m2ktacpm.error2,m2ktacpm.error3,by = intersect(names(m2ktacpm.error2), names(m2ktacpm.error3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


##merge error 1 with 2&3
m2ktaerrorcpm1_2_3 <- full_join(m2ktacpm.error1,m2ktaerrorcpm2_3,by = intersect(names(m2ktacpm.error1), names(m2ktaerrorcpm2_3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#check for missing/mismatch in ppts

m2ktacpm.error4.1 <- m2ktacpm.complete %>% 
  mutate(diff_cpm1 = cpmppt1val - cpmppt1val1) %>% 
  filter(diff_cpm1!=0 | is.na(diff_cpm1)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt1val = case_when(is.na(cpmppt1val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmppt1val1 = case_when(is.na(cpmppt1val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmppt1val,cpmppt1val1) 




#check for missing/mismatch in ppts

m2ktacpm.error4.2 <- m2ktacpm.complete %>% 
  mutate(diff_cpm2 = cpmppt2val - cpmppt2val1) %>% 
  filter(diff_cpm2!=0 | is.na(diff_cpm2)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt2val = case_when(is.na(cpmppt2val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmppt2val1 = case_when(is.na(cpmppt2val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmppt2val,cpmppt2val1) 



#check for missing/mismatch in ppts

m2ktacpm.error4.3 <- m2ktacpm.complete %>% 
  mutate(diff_cpm3 = cpmppt3val - cpmppt3val1) %>% 
  filter(diff_cpm3!=0 | is.na(diff_cpm3)) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(cpmppt3val = case_when(is.na(cpmppt3val) ~ "x",TRUE ~ "x"))%>%
  mutate(cpmppt3val1 = case_when(is.na(cpmppt3val1) ~ "x",TRUE ~ "x" )) %>% 
  select(record_id,redcap_event_name,cpmppt3val,cpmppt3val1) 


#merge 4.1-.3


#merge error 2&3
m2ktaerror4a <-  full_join(m2ktacpm.error4.1,m2ktacpm.error4.2 ,by = intersect(names(m2ktacpm.error4.1), names(m2ktacpm.error4.2)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2ktacpm.error4 <- full_join(m2ktaerror4a,m2ktacpm.error4.3,by = intersect(names(m2ktaerror4a), names(m2ktacpm.error4.3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

m2ktacpm.final <- full_join(m2ktacpm.error4,m2ktaerrorcpm1_2_3,by = intersect(names(m2ktacpm.error4), names(m2ktaerrorcpm1_2_3)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# Primary: CPM % change computed as [mean(pre hand immersion -mean(PPT-post immersion
# PPT)/mean(pre immersion PPT]) *100 (primary outcome)


m2ktacmp.prim.outcome <- m2ktacpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_change = ((mean_pre - mean_post)/mean_pre) * 100)  %>% 
  filter(is.na(cpm_change)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn,pptcompleteyn,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )



#Secondary: CPM difference score
# computed as mean (pre hand immersion)- mean( PPT-post immersion PPT)


m2ktacmp.sec.outcome <- m2ktacpm.complete %>% 
  filter(pptcompleteyn == 1 | pptcompleteyn == 2 ) %>% 
  rowwise() %>% 
  mutate(mean_pre = mean(c(pptremote1val,pptremote2val,pptremote3val))) %>% 
  rowwise() %>% 
  mutate(mean_post = mean(c(cpmppt1val,cpmppt2val,cpmppt3val))) %>% 
  mutate(cpm_diff = mean_pre - mean_post)  %>% 
  filter(is.na(cpm_diff)) %>% 
  select(record_id, redcap_event_name,cpmcompleteyn,pptcompleteyn,pptremote1val,pptremote2val,pptremote3val,cpmppt1val,cpmppt2val,cpmppt3val) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate_at(
    vars(contains("val")),
    ~(case_when(is.na(.) ~ "x",
                TRUE ~ as.character(.)
    ))
  )


m2ktacmp.outcome <- full_join(m2ktacmp.prim.outcome ,m2ktacmp.sec.outcome ,by = intersect(names(m2ktacmp.prim.outcome), names(m2ktacmp.sec.outcome)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#change  to as.character for merging
m2ktacmp.outcome [] <- lapply(m2ktacmp.outcome , as.character)
m2ktacpm.final[] <- lapply(m2ktacpm.final, as.character)

#merge all cmp errors

m2ktaall.cmp <-  full_join(m2ktacmp.outcome ,m2ktacpm.final ,by = intersect(names(m2ktacmp.outcome), names(m2ktacpm.final)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#ensure each combination of ID and redcap event has one row with all values and is not duplicated

#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2ktaall.cmp[m2ktaall.cmp== ""] <- NA

m2ktaall.cmp <- m2ktaall.cmp%>% 
  pivot_longer(cols = 3:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name"), 
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 





#link with imaging data
# label(tadata.image$fmricuffcompletescl)="Test Completed:"
# label(tadata.image$fmricuffcontrarecal)="imaging_Re-calibration of pressure needed:"
# label(tadata.image$fmricuffcalfpressurerecal)="imaging:Pressure 2:"
# label(tadata.image$fmricuffcalfpressurerecal2)="imaging:Pressure 2: (double entry)"
# label(tadata.image$fmricuffipyn)="imaging_fMRI individualized pressure"
# tadata.image$fmricuffcontrarecal.factor = factor(tadata.image$fmricuffcontrarecal,levels=c("1","0"))
# tadata.image$fmricuffcompletescl.factor = factor(tadata.image$fmricuffcompletescl,levels=c("1","2","0"))
# tadata.image$fmricuffipyn.factor = factor(tadata.image$fmricuffipyn,levels=c("1","0"))
# 
# levels(tadata.image$fmricuffcontrarecal.factor)=c("Yes","No")
# 
# 
# levels(tadata.image$fmricuffcompletescl.factor)=c("Yes, all scans were completed","Yes, but only the scans indicated below were completed","No, no scans were completed (add reason(s) to notes below)")
# levels(tadata.image$fmricuffipyn.factor)=c("Yes","No")
# 


# select needed variables
m2ktadata.image1 <- m2ktadata.image %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrarecal,fmricuffcontrarecal,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2,fmricuffipyn,fmricuffcompletescl,fmricuffipyn) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

m2ktadata.qst <- m2kdata.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,fmricuffcontrayn,fmricuffcalfpressure,fmricuffcalfpressure2,qst_mcc1_v03_complete) %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




# change  to as.character for merging
m2ktadata.image1 [] <- lapply(m2ktadata.image1 , as.character)
m2ktadata.qst[] <- lapply(m2ktadata.qst, as.character)

#merge both
m2ktaqst.image <-  full_join(m2ktadata.image1 ,m2ktadata.qst ,by = intersect(names(m2ktadata.image1), names(m2ktadata.qst))) %>% 
  filter(qst_mcc1_v03_complete == 2)

#if personalized pressure was performed during imaging AND there were no pressure values for Cuff Pressure to achieve 4/10 pain outside of scanner (in mmHg) during QST AND  no recal pressure values for Cuff Pressure during imaging

m2ktaqst.image1 <- m2ktaqst.image %>% 
  mutate(no.qst = case_when(is.na(fmricuffcalfpressurerecal) & is.na(fmricuffcalfpressure)  ~ 1,TRUE ~ 0)) %>% 
  mutate(personal.cuff = case_when(fmricuffcompletescl == 1 | fmricuffipyn == 1 ~ 1,TRUE ~ 0)) %>%
  filter(personal.cuff ==1 & no.qst == 1) %>% 
  select(record_id,record_id,redcap_event_name,redcap_data_access_group,fmricuffipyn,fmricuffcompletescl,fmricuffcontrayn,fmricuffcontrarecal,fmricuffcalfpressure,fmricuffcalfpressure2,fmricuffcalfpressurerecal,fmricuffcalfpressurerecal2 ) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(fmricuffcontrayn = case_when(is.na(fmricuffcontrayn) ~ "x",TRUE ~ "x"))%>% 
  mutate(fmricuffcontrarecal = case_when(is.na(fmricuffcontrarecal) ~ "x",TRUE ~"x" )) %>% 
  mutate(fmricuffcalfpressure = case_when(is.na(fmricuffcalfpressure) ~ "x",TRUE ~ "x")) %>% 
  mutate(fmricuffcalfpressure2 = case_when(is.na(fmricuffcalfpressure2) ~ "x",TRUE ~ "x" )) %>%
  mutate(fmricuffcalfpressurerecal = case_when(is.na(fmricuffcalfpressurerecal) ~ "x",TRUE ~ "x" )) %>%
  mutate(fmricuffcalfpressurerecal2 = case_when(is.na(fmricuffcalfpressurerecal2) ~ "x",TRUE ~ "x" )) 



#fetch notes

m2ktanotes.ppt <- m2kdata.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2ktanotes.ts <- m2kdata.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2ktanotes.cpm <- m2kdata.qst %>% 
  select(record_id,redcap_event_name,redcap_data_access_group)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


##### Data entries from REDCap were checked for errors and the the following IDs and their respective events were flagged:


#ppt with notes
# 
m2kq2error2_3_3b_endpoint1[] <- lapply(m2kq2error2_3_3b_endpoint1, as.character)
m2ktanotes.ppt[] <- lapply(m2ktanotes.ppt, as.character)

m2kq2error2_3_3b_endpoint1_notes <- left_join(m2kq2error2_3_3b_endpoint1,m2ktanotes.ppt,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




#TS with notes

m2kta.all.prim.sec.outcome[] <- lapply(m2kta.all.prim.sec.outcome, as.character)

m2ktanotes.ts[] <- lapply(m2ktanotes.ts, as.character)

m2kta.all.prim.sec.outcome_notes <- left_join(m2kta.all.prim.sec.outcome,m2ktanotes.ts,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#cpm with notes

m2ktaall.cmp[] <- lapply(m2ktaall.cmp, as.character)
m2ktanotes.cpm[] <- lapply(m2ktanotes.cpm, as.character)


m2ktaall.cmp_notes <- left_join(m2ktaall.cmp,m2ktanotes.cpm,by=c("record_id","redcap_event_name"))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


##### **After linking QST data with Imaging data**
#####  The records enlisted below were flagged when checking for one or more than one of the following errors:


m2ktaqst_table <- full_join(m2kta.all.prim.sec.outcome_notes,m2kq2error2_3_3b_endpoint1_notes,by = intersect(names(m2kta.all.prim.sec.outcome_notes), names(m2kq2error2_3_3b_endpoint1_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2ktaqst_table1 <- full_join(m2ktaqst_table,m2ktaall.cmp_notes,by = intersect(names(m2ktaqst_table), names(m2ktaall.cmp_notes)))  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


m2kta_final_image <-  full_join(m2ktaqst_table1,m2ktaqst.image1,by = intersect(names(m2ktaqst_table1), names(m2ktaqst.image1))) %>% 
  relocate(redcap_data_access_group, .after = redcap_event_name)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



m2kta_final_image [m2kta_final_image == ""] <- NA


m2kta_img_table <- m2kta_final_image %>% 
  pivot_longer(cols = 4:last_col(), 
               names_to = "val_name", values_to = "values",
               values_drop_na = TRUE) %>% 
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>% 
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group"), 
              names_from = val_name,
              values_from = values) %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . != "x" , "1"))) %>% 
  add_column(m2kqst_complete = 0)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# recode 0,1 ie incomplete/unverified to 2
m2kta.img_all <- m2kdata.qst %>% 
  filter(qst_mcc1_v03_complete == 0 |qst_mcc1_v03_complete == 1) %>% 
  mutate(m2kqst_complete = case_when(qst_mcc1_v03_complete == 0 |qst_mcc1_v03_complete == 1 ~ 2)) %>% 
  select(record_id,redcap_event_name,m2kqst_complete,redcap_data_access_group)




m2kta_img_table[] <- lapply(m2kta_img_table, as.character)
m2kta.img_all[] <- lapply(m2kta.img_all, as.character)

#merge all
m2kerror_ta_img_all <- full_join(m2kta_img_table,m2kta.img_all,by = intersect(names(m2kta_img_table), names(m2kta.img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  replace(is.na(.), "1") %>% 
  relocate(m2kqst_complete, .after = redcap_data_access_group)


table(m2kta.img_all$m2kqst_complete)
table(m2kerror_ta_img_all$m2kqst_complete,exclude = FALSE)


# recode NAs to 8 in the original dataset, select DAG as well
m2kdata_ta.img_all <- m2kdata.qst %>%
  as_tibble() %>%
  mutate_all(as.character)  %>%
  mutate(qst_mcc1_v03_complete = case_when(is.na(qst_mcc1_v03_complete) ~ "8", TRUE ~ as.character(qst_mcc1_v03_complete))) %>% 
  select(record_id,redcap_event_name,redcap_data_access_group,qst_mcc1_v03_complete) 


table(m2kdata_ta.img_all$qst_mcc1_v03_complete,exclude = NULL)




#e#ensure each combination of ID and redcap event has one row with all values and is not duplicated

m2kerror_ta_img_all[m2kerror_ta_img_all== ""] <- NA


m2kerror_ta_img_all <- m2kerror_ta_img_all%>%
  pivot_longer(cols = 5:last_col(),
               names_to ="val_name", values_to = "values",
               values_drop_na = TRUE) %>%
  distinct(record_id, redcap_event_name, val_name, .keep_all = TRUE) %>%
  pivot_wider(id_cols = c("record_id", "redcap_event_name","redcap_data_access_group","m2kqst_complete"),
              names_from = val_name,
              values_from = values)  %>% 
  as_tibble() %>% 
  mutate_all(as.character) 




# qst_complete to account for records with missing completion data, where 1 is complete and complete plus errors, 2 is incomplete/unverified and 8 is NA)
m2kfull_ta.img <- full_join(m2kerror_ta_img_all,m2kdata_ta.img_all,by = intersect(names(m2kerror_ta_img_all), names(m2kdata_ta.img_all))) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  mutate(m2kqst_complete = case_when(qst_mcc1_v03_complete == "8" ~ "8", TRUE ~ as.character(m2kqst_complete))) %>% 
  replace(is.na(.), "1") %>% 
  mutate(across(.cols=4:last_col(),.fns = ~replace(., . == "x" , "0"))) %>% 
  select(-qst_mcc1_v03_complete) %>% 
  relocate(m2kqst_complete,.after=redcap_data_access_group)

table(m2kerror_ta_img_all$m2kqst_complete)

table(m2kfull_ta.img$m2kqst_complete,exclude = NULL) 


table(m2kdata.qst$qst_mcc1_v03_complete,exclude=NULL)



# create a dataset where 0=errors,1=clean,2=incomplete/unverified and 8 = NA
m2kdat.qst <- m2kfull_ta.img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "MCC2_TKA_QST") %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group, .drop = FALSE) %>%
  mutate(nr = n()) %>%
  ungroup() %>%
  mutate(error = if_else(error == "clean" &
                           nr > 1, "delete", error)) %>%
  filter(error != "delete") %>%
  select(-nr) %>%
  group_by(record_id, redcap_event_name,redcap_data_access_group,.drop = FALSE) %>%
  filter(error != "m2kqst_complete") %>% 
  mutate(error = paste0(error, collapse = "*")) %>%
  mutate(dataset = "MCC2_TKA_QST") %>%
  ungroup() %>%
  distinct(record_id,redcap_event_name,redcap_data_access_group,error, .keep_all = TRUE) %>% #
  mutate(m2kb.qst = case_when(error == "clean" ~ 1,
                              error == 2 ~ 2,
                              error == 8 ~ 8,
                              TRUE ~ 0)) %>%
  mutate(error = if_else(error == "clean", "1", error))



m2kdat1 <- m2kdat.qst %>% 
  filter(m2kb.qst == 0) %>% 
  select(record_id,redcap_event_name)



m2kdata_qst_wide <- m2kdat.qst %>%
  pivot_wider (names_from = dataset,values_from = error) 

table(m2kdata_qst_wide$m2kb.qst) 
table(datam2k$qst_mcc1_v03_complete,exclude = NULL)

# create mcc2 tka ds tbl

m2kdata_wide1 <- full_join(m2kdata_bpi,m2kdata_koos,by = intersect(names(m2kdata_bpi), names(m2kdata_koos))) 

m2kdata_wide2 <- full_join(m2kdata_wide1,m2kdata.anxiety_wide,by = intersect(names(m2kdata_wide1), names(m2kdata.anxiety_wide))) 


m2kdata_wide3 <- full_join(m2kdata_wide2,m2kdata.dep_wide,by = intersect(names(m2kdata_wide2), names(m2kdata.dep_wide))) 

m2kdata_wide4 <- full_join(m2kdata_wide3,m2kdata.cat_wide,by = intersect(names(m2kdata_wide3), names(m2kdata.cat_wide)))

m2kdata_wide5 <- full_join(m2kdata_wide4,m2kdata.move_wide,by = intersect(names(m2kdata_wide4), names(m2kdata.move_wide))) 
m2kdata_wide6 <- full_join(m2kdata_wide5,m2kdata.sleep_wide,by = intersect(names(m2kdata_wide5), names(m2kdata.sleep_wide))) 

m2kdata_wide7 <- full_join(m2kdata_wide6,m2kdata.sleep_hours_wide,by = intersect(names(m2kdata_wide6), names(m2kdata.sleep_hours_wide))) 

m2kdata_wide8 <- full_join(m2kdata_wide7,m2kdata_func_wide,by = intersect(names(m2kdata_wide7), names(m2kdata_func_wide))) 

m2kdata_wide9 <- full_join(m2kdata_wide8,m2kdata_blood_wide,by = intersect(names(m2kdata_wide8), names(m2kdata_blood_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood, .after = MCC2_TKA_BloodDraw)


m2kdata_wide10 <- full_join(m2kdata_wide9,m2kdata_imaging_wide,by = intersect(names(m2kdata_wide9), names(m2kdata_imaging_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img, .after = MCC2_TKA_Imaging)

m2kdata_wide11 <- full_join(m2kdata_wide10,m2kdata_qst_wide,by = intersect(names(m2kdata_wide10), names(m2kdata_qst_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,m2kb.qst, .after = MCC2_TKA_QST)

m2kdata_wide12 <- full_join(m2kdata_wide11,m2kdata.cog_wide,by = intersect(names(m2kdata_wide11), names(m2kdata.cog_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,m2kb.qst,m2kb.cog, .after = MCC2_TKA_cognition)

m2kdata_wide13 <- full_join(m2kdata_wide12,m2kdata.res_wide,by = intersect(names(m2kdata_wide12), names(m2kdata.res_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,m2kb.qst,m2kb.cog,m2kb.res, .after = MCC2_TKA_resilience)

m2kdata_wide14 <- full_join(m2kdata_wide13,m2kdata.social_wide,by = intersect(names(m2kdata_wide13), names(m2kdata.social_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,m2kb.qst,m2kb.cog,m2kb.res,m2kb.social, .after = MCC2_TKA_social_support)


m2kdata_wide15 <- full_join(m2kdata_wide14,m2kdata.ace_wide,by = intersect(names(m2kdata_wide14), names(m2kdata.ace_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,m2kb.qst,m2kb.cog,m2kb.res,m2kb.social,
           m2kb.ace,.after = MCC2_TKA_ACE)

m2kdata_wide16 <- full_join(m2kdata_wide15,m2ksix.mo_wide,by = intersect(names(m2kdata_wide15), names(m2ksix.mo_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,
           m2kb.qst,m2kb.cog,m2kb.res,m2kb.social,m2kb.ace,m2kb.traj,
           .after = MCC2_TKA_six_mo_traj)


m2kdata_wide17 <- full_join(m2kdata_wide16,m2kbaseline_traj_wide,by = intersect(names(m2kdata_wide16), names(m2kbaseline_traj_wide))) %>% 
  relocate(m2kb.bpi,m2kb.koos,m2kb.anxiety,m2kb.dep,m2kb.cat,m2kb.move,m2kb.sleep,m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,
           m2kb.qst,m2kb.cog,m2kb.res,m2kb.social,m2kb.ace,m2kb.traj,m2kb.base_traj,
           .after = MCC2_TKA_acute_traj)


#recode data for visit not scheduled from 8 to 7 where 7 is NOT APPLICABLE
m2kdata_wide17 <- m2kdata_wide17 %>% 
  mutate(m2kb.base_traj = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ as.numeric(m2kb.base_traj) )) %>% #ghis step was already done, repeating here and reformatting to as.numeric to keep data format consistent
  mutate(m2kb.traj = case_when(redcap_event_name != "6mo_postop_arm_1" ~ 7,TRUE ~ as.numeric(m2kb.traj) )) %>% #ghis step was already done, repeating here and reformatting to as.numeric to keep data format consistent
  mutate(m2kb.ace = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ m2kb.ace )) %>% 
  mutate(m2kb.social = case_when(redcap_event_name == "6mo_postop_arm_1" & m2kb.social==8 | redcap_event_name == "12mo_postop_arm_1"  & m2kb.social==8   ~ 7,TRUE ~ m2kb.social )) %>% 
  mutate(m2kb.res = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ m2kb.res )) %>% 
  mutate(m2kb.cog = case_when( redcap_event_name == "12mo_postop_arm_1"  & m2kb.cog==8   ~ 7,TRUE ~ m2kb.cog )) %>% 
  mutate(m2kb.koos = case_when( redcap_event_name == "6wks_postop_arm_1" & m2kb.koos==8 | redcap_event_name == "12mo_postop_arm_1" & m2kb.koos== 8  ~ 7,TRUE ~ m2kb.koos )) %>% 
  mutate(m2kb.anxiety = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.anxiety==8   ~ 7,TRUE ~ m2kb.anxiety )) %>% 
  mutate(m2kb.dep = case_when(redcap_event_name == "12mo_postop_arm_1"  & m2kb.dep==8   ~ 7,TRUE ~ m2kb.dep )) %>% 
  mutate(m2kb.bpi=case_when(redcap_event_name == "12mo_postop_arm_1"  & m2kb.bpi==8   ~ 7,TRUE ~ m2kb.bpi )) %>% 
  mutate(m2kb.img = case_when(redcap_event_name == "12mo_postop_arm_1" &  m2kb.img == 8|redcap_event_name == "6mo_postop_arm_1" & m2kb.img == 8|redcap_event_name == "6wks_postop_arm_1" & m2kb.img == 8 ~ 7,TRUE ~ m2kb.img )) %>% 
  mutate(m2kb.cat = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.cat == 8|redcap_event_name == "6mo_postop_arm_1" & m2kb.cat == 8 ~ 7,TRUE ~ m2kb.cat )) %>% 
  mutate(m2kb.move = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.move == 8|redcap_event_name == "6mo_postop_arm_1" & m2kb.move == 8 ~ 7,TRUE ~ m2kb.move )) %>% 
  mutate(m2kb.sleep = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.sleep == 8 ~ 7,TRUE ~ m2kb.sleep ))%>% 
  mutate(m2kb.sleep_hours = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.sleep_hours == 8 ~ 7,TRUE ~ m2kb.sleep_hours )) %>% 
  mutate(m2kb.func = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.func == 8|redcap_event_name == "6mo_postop_arm_1" & m2kb.func == 8|redcap_event_name == "6wks_postop_arm_1" & m2kb.func == 8 ~ 7,TRUE ~ m2kb.func )) %>% 
  mutate(m2kb.blood = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.blood==8|redcap_event_name == "6mo_postop_arm_1" & m2kb.blood == 8 ~ 7,TRUE ~ m2kb.blood )) %>% 
  mutate(m2kb.qst = case_when(redcap_event_name == "12mo_postop_arm_1" & m2kb.qst==8|redcap_event_name == "6mo_postop_arm_1" & m2kb.qst == 8|redcap_event_name == "6wks_postop_arm_1" & m2kb.qst == 8 ~ 7,TRUE ~ m2kb.qst ))






m2kds_tbl_1 <- m2kdata_wide17 %>% 
  select(-MCC2_TKA_BPI,-MCC2_TKA_KOOS,-MCC2_TKA_Anxiety,-MCC2_TKA_Depression,-MCC2_TKA_Promis_Sleep,-MCC2_TKA_sleep_hours,-MCC2_TKA_Functional,
         -MCC2_TKA_BloodDraw,-MCC2_TKA_Imaging, -MCC2_TKA_Catastrophizing,
         -MCC2_TKA_Functional,-MCC2_TKA_FearMovement, -MCC2_TKA_QST,-MCC2_TKA_cognition,-MCC2_TKA_resilience,-MCC2_TKA_social_support,-MCC2_TKA_ACE,-MCC2_TKA_six_mo_traj,
         -MCC2_TKA_acute_traj) %>% 
  rename("BPI" =m2kb.bpi,"koos"=m2kb.koos,"Anxiety"=m2kb.anxiety,"Depression"=m2kb.dep,"Catastrophizing"=m2kb.cat,
         "FearMovement"=m2kb.move,"Promis_Sleep"=m2kb.sleep,"sleep_hours"=m2kb.sleep_hours, "Functional"=m2kb.func,
         "BloodDraw"=m2kb.blood ,"Imaging"=m2kb.img,"QST"= m2kb.qst,"cognition"=m2kb.cog,"resilience"=m2kb.res,"social_support"=m2kb.social,
         "ACE"=m2kb.ace,"six_mo_traj"=m2kb.traj,"acute_traj"=m2kb.base_traj) %>% 
  pivot_longer(cols = BPI : last_col(), 
               names_to = "var",
               values_to = "data_type") %>% 
  mutate(across(everything(), as.factor)) %>% 
  mutate(data_type = factor(data_type, 
                            levels = c(0,1,2,7,8), 
                            labels = c("datacomplete_with_errors", 
                                       "datacomplete_with_no_errors", 
                                       "dataincomplete", 
                                       "dataNot_applicable", 
                                       "datanot_available")))




#pivot wider and recode NA as 9 if no visit yet and 7 if f not applicable, where 1 = complete,0 = complete with errors,2 = incomplete, 7= Not applicable, 8= Not avaialable

m2kdata_explore <- m2kdata_wide17

table(m2kdata_wide17$redcap_event_name,exclude = NULL)

m2kdata_explore1 <-  m2kdata_explore%>% 
  select(-MCC2_TKA_BPI,-MCC2_TKA_KOOS,-MCC2_TKA_Anxiety,-MCC2_TKA_Depression,-MCC2_TKA_Promis_Sleep,-MCC2_TKA_sleep_hours,-MCC2_TKA_Functional,
         -MCC2_TKA_BloodDraw,-MCC2_TKA_Imaging, -MCC2_TKA_Catastrophizing,
         -MCC2_TKA_Functional,-MCC2_TKA_FearMovement, -MCC2_TKA_QST,-MCC2_TKA_cognition,-MCC2_TKA_resilience,-MCC2_TKA_social_support,-MCC2_TKA_ACE,-MCC2_TKA_six_mo_traj,
         -MCC2_TKA_acute_traj) %>% 
  pivot_wider(names_from = redcap_event_name , values_from = c(m2kb.bpi,m2kb.koos,m2kb.dep,m2kb.anxiety,m2kb.cat,m2kb.move,m2kb.sleep,
                                                               m2kb.sleep_hours,m2kb.func,m2kb.blood,m2kb.img,m2kb.qst,
                                                               m2kb.cog,m2kb.res,m2kb.social,m2kb.ace,m2kb.traj,m2kb.base_traj)) %>% 
  replace_na(list(m2kb.bpi_baseline_visit_arm_1 = 9,m2kb.bpi_6wks_postop_arm_1=9,m2kb.bpi_3mo_postop_arm_1=9,m2kb.bpi_6mo_postop_arm_1=9,m2kb.bpi_12mo_postop_arm_1=7,
                  m2kb.koos_baseline_visit_arm_1 = 9,m2kb.koos_3_days_preop_arm_1=7,m2kb.koos_6wks_postop_arm_1=7,m2kb.koos_3mo_postop_arm_1=9,m2kb.koos_6mo_postop_arm_1=9,m2kb.koos_12mo_postop_arm_1=7,
                  m2kb.anxiety_baseline_visit_arm_1 = 9,m2kb.anxiety_3_days_preop_arm_1=7,m2kb.anxiety_6wks_postop_arm_1=9,m2kb.anxiety_3mo_postop_arm_1=9,m2kb.anxiety_6mo_postop_arm_1=9,m2kb.anxiety_12mo_postop_arm_1=7,
                  m2kb.dep_baseline_visit_arm_1 = 9,m2kb.dep_3_days_preop_arm_1=7,m2kb.dep_6wks_postop_arm_1=9,m2kb.dep_3mo_postop_arm_1=9,m2kb.dep_6mo_postop_arm_1=9,m2kb.dep_12mo_postop_arm_1=7,
                  m2kb.cat_baseline_visit_arm_1 = 9,m2kb.cat_3_days_preop_arm_1=7,m2kb.cat_6wks_postop_arm_1=9,m2kb.cat_3mo_postop_arm_1=9,m2kb.cat_6mo_postop_arm_1=7,m2kb.cat_12mo_postop_arm_1=7,
                  m2kb.move_baseline_visit_arm_1 = 9,m2kb.move_3_days_preop_arm_1=7,m2kb.move_6wks_postop_arm_1=9,m2kb.move_3mo_postop_arm_1=9,m2kb.move_6mo_postop_arm_1=7,m2kb.move_12mo_postop_arm_1=7,
                  m2kb.sleep_baseline_visit_arm_1 = 9,m2kb.sleep_3_days_preop_arm_1=7,m2kb.sleep_6wks_postop_arm_1=9,m2kb.sleep_3mo_postop_arm_1=9,m2kb.sleep_6mo_postop_arm_1=9,m2kb.sleep_12mo_postop_arm_1=7,
                  m2kb.sleep_hours_baseline_visit_arm_1 = 9,m2kb.sleep_hours_3_days_preop_arm_1=7,m2kb.sleep_hours_6wks_postop_arm_1=9,m2kb.sleep_hours_3mo_postop_arm_1=9,m2kb.sleep_hours_6mo_postop_arm_1=9,m2kb.sleep_hours_12mo_postop_arm_1=7,
                  m2kb.func_baseline_visit_arm_1 = 9,m2kb.func_3_days_preop_arm_1=7,m2kb.func_6wks_postop_arm_1=7,m2kb.func_3mo_postop_arm_1=9,m2kb.func_6mo_postop_arm_1=7,m2kb.func_12mo_postop_arm_1=7,
                  m2kb.img_baseline_visit_arm_1 = 9,m2kb.img_3_days_preop_arm_1=7,m2kb.img_6wks_postop_arm_1=7,m2kb.img_3mo_postop_arm_1=9,m2kb.img_6mo_postop_arm_1=7,m2kb.img_12mo_postop_arm_1=7,
                  m2kb.qst_baseline_visit_arm_1 = 9,m2kb.qst_3_days_preop_arm_1=7,m2kb.qst_6wks_postop_arm_1=7,m2kb.qst_3mo_postop_arm_1=9,m2kb.qst_6mo_postop_arm_1=7,m2kb.qst_12mo_postop_arm_1=7,
                  m2kb.blood_baseline_visit_arm_1 = 9,m2kb.blood_3_days_preop_arm_1=7,m2kb.blood_6wks_postop_arm_1=9,m2kb.blood_3mo_postop_arm_1=9,m2kb.blood_6mo_postop_arm_1=7,m2kb.blood_12mo_postop_arm_1=7,
                  m2kb.cog_baseline_visit_arm_1 = 9,m2kb.cog_3_days_preop_arm_1=7,m2kb.cog_6wks_postop_arm_1=9,m2kb.cog_3mo_postop_arm_1=9,m2kb.cog_6mo_postop_arm_1=9,m2kb.cog_12mo_postop_arm_1=7,
                  m2kb.social_baseline_visit_arm_1 = 9,m2kb.social_3_days_preop_arm_1=7,m2kb.social_6wks_postop_arm_1=9,m2kb.social_3mo_postop_arm_1=9,m2kb.social_6mo_postop_arm_1=7,m2kb.social_12mo_postop_arm_1=7,
                  m2kb.res_baseline_visit_arm_1 = 9,m2kb.res_3_days_preop_arm_1=7,m2kb.res_6wks_postop_arm_1=7,m2kb.res_3mo_postop_arm_1=7,m2kb.res_6mo_postop_arm_1=7,m2kb.res_12mo_postop_arm_1=7,
                  m2kb.ace_baseline_visit_arm_1 = 9,m2kb.ace_3_days_preop_arm_1=7,m2kb.ace_6wks_postop_arm_1=7,m2kb.ace_3mo_postop_arm_1=7,m2kb.ace_6mo_postop_arm_1=7,m2kb.ace_12mo_postop_arm_1=7,
                  m2kb.traj_baseline_visit_arm_1 = 7,m2kb.traj_3_days_preop_arm_1=7,m2kb.traj_6wks_postop_arm_1=7,m2kb.traj_3mo_postop_arm_1=7,m2kb.traj_6mo_postop_arm_1=9,m2kb.traj_12mo_postop_arm_1=7,
                  m2kb.base_traj_baseline_visit_arm_1 = 9,m2kb.base_traj_3_days_preop_arm_1=7,m2kb.base_traj_6wks_postop_arm_1=7,m2kb.base_traj_3mo_postop_arm_1=7,m2kb.base_traj_6mo_postop_arm_1=7,m2kb.base_traj_12mo_postop_arm_1=7))


#filter complete records # removing all items with 12 month since no 6 months data available right now

m2kdata_complete<- m2kdata_explore1 %>%
  filter(m2kb.bpi_baseline_visit_arm_1 == 1&m2kb.bpi_6wks_postop_arm_1==1 &m2kb.bpi_3mo_postop_arm_1==1 &m2kb.bpi_6mo_postop_arm_1==1  &
           m2kb.koos_baseline_visit_arm_1 == 1 &m2kb.koos_6wks_postop_arm_1==7 &m2kb.koos_3mo_postop_arm_1==1 &m2kb.koos_6mo_postop_arm_1==1 &
           m2kb.anxiety_baseline_visit_arm_1 == 1  &m2kb.anxiety_6wks_postop_arm_1==1 &m2kb.anxiety_3mo_postop_arm_1==1 &m2kb.anxiety_6mo_postop_arm_1==1  &
           m2kb.dep_baseline_visit_arm_1 == 1  &m2kb.dep_6wks_postop_arm_1==1 &m2kb.dep_3mo_postop_arm_1==1 &m2kb.dep_6mo_postop_arm_1==1  &
           m2kb.cat_baseline_visit_arm_1 == 1  &m2kb.cat_6wks_postop_arm_1==1 &m2kb.cat_3mo_postop_arm_1==1 &m2kb.cat_6mo_postop_arm_1==7&
           m2kb.move_baseline_visit_arm_1 == 1  &m2kb.move_6wks_postop_arm_1==1 &m2kb.move_3mo_postop_arm_1==1 &m2kb.move_6mo_postop_arm_1==7 &
           m2kb.sleep_baseline_visit_arm_1 == 1  &m2kb.sleep_6wks_postop_arm_1==1 &m2kb.sleep_3mo_postop_arm_1==1 &m2kb.sleep_6mo_postop_arm_1==1 &
           m2kb.sleep_hours_baseline_visit_arm_1 == 1  &m2kb.sleep_hours_6wks_postop_arm_1==1 &m2kb.sleep_hours_3mo_postop_arm_1==1 &m2kb.sleep_hours_6mo_postop_arm_1==1 &
           m2kb.func_baseline_visit_arm_1 == 1  &m2kb.func_6wks_postop_arm_1==7 &m2kb.func_3mo_postop_arm_1==1 &m2kb.func_6mo_postop_arm_1==7  &
           m2kb.img_baseline_visit_arm_1 == 1  &m2kb.img_6wks_postop_arm_1==7 &m2kb.img_3mo_postop_arm_1==1 &m2kb.img_6mo_postop_arm_1==7  &
           m2kb.qst_baseline_visit_arm_1 == 1  &m2kb.qst_6wks_postop_arm_1==7 &m2kb.qst_3mo_postop_arm_1==1 &m2kb.qst_6mo_postop_arm_1==7 &
           m2kb.blood_baseline_visit_arm_1 == 1  &m2kb.blood_6wks_postop_arm_1==1 &m2kb.blood_3mo_postop_arm_1==1 &m2kb.blood_6mo_postop_arm_1==7&
           m2kb.cog_baseline_visit_arm_1 == 1&m2kb.cog_6wks_postop_arm_1==1&m2kb.cog_3mo_postop_arm_1==1&m2kb.cog_6mo_postop_arm_1==1&
           m2kb.social_baseline_visit_arm_1 == 1&m2kb.social_6wks_postop_arm_1==1&m2kb.social_3mo_postop_arm_1==1&m2kb.social_6mo_postop_arm_1==7&
           m2kb.res_baseline_visit_arm_1 == 1&m2kb.res_6wks_postop_arm_1==7&m2kb.res_3mo_postop_arm_1==7&m2kb.res_6mo_postop_arm_1==7&
           m2kb.ace_baseline_visit_arm_1 == 1&m2kb.ace_6wks_postop_arm_1==7&m2kb.ace_3mo_postop_arm_1==7&m2kb.ace_6mo_postop_arm_1==7&
           m2kb.traj_baseline_visit_arm_1 == 7&m2kb.traj_6wks_postop_arm_1==7&m2kb.traj_3mo_postop_arm_1==7&m2kb.traj_6mo_postop_arm_1==1&
           m2kb.base_traj_baseline_visit_arm_1 == 1 & m2kb.base_traj_6wks_postop_arm_1==7 & m2kb.base_traj_3mo_postop_arm_1==7&
           m2kb.base_traj_6mo_postop_arm_1==7)


#same code as above with complete records and records with errors as well  # removing all items with 12 month since no 6 months data available right now
m2kdata_complete_errors <- m2kdata_explore1 %>% 
  filter(
    (m2kb.bpi_baseline_visit_arm_1 == 1 |m2kb.bpi_baseline_visit_arm_1 == 0) &(m2kb.bpi_6wks_postop_arm_1==1 | m2kb.bpi_6wks_postop_arm_1==0) &(m2kb.bpi_3mo_postop_arm_1==1 | m2kb.bpi_3mo_postop_arm_1==0) &
      (m2kb.bpi_6mo_postop_arm_1==1 | m2kb.bpi_6mo_postop_arm_1==0) &
      (m2kb.koos_baseline_visit_arm_1 == 1 | m2kb.koos_baseline_visit_arm_1 == 0)  &m2kb.koos_6wks_postop_arm_1==7 & (m2kb.koos_3mo_postop_arm_1==1|m2kb.koos_3mo_postop_arm_1==0) & 
      (m2kb.koos_6mo_postop_arm_1==1 | m2kb.koos_6mo_postop_arm_1== 0)  &
      (m2kb.anxiety_baseline_visit_arm_1 == 1 | m2kb.anxiety_baseline_visit_arm_1 == 0)  & (m2kb.anxiety_6wks_postop_arm_1==1|m2kb.anxiety_6wks_postop_arm_1==0) &(m2kb.anxiety_3mo_postop_arm_1==1|
                                                                                                                                                                     m2kb.anxiety_3mo_postop_arm_1==0) & (m2kb.anxiety_6mo_postop_arm_1==1|m2kb.anxiety_6mo_postop_arm_1==0) &
      (m2kb.dep_baseline_visit_arm_1 == 1|m2kb.dep_baseline_visit_arm_1 == 0)  &(m2kb.dep_6wks_postop_arm_1==1|m2kb.dep_6wks_postop_arm_1==0) &(m2kb.dep_3mo_postop_arm_1==1|m2kb.dep_3mo_postop_arm_1==0)
    & (m2kb.dep_6mo_postop_arm_1==1|m2kb.dep_6mo_postop_arm_1==0) &
      (m2kb.cat_baseline_visit_arm_1 == 1|m2kb.cat_baseline_visit_arm_1 == 0)  & (m2kb.cat_6wks_postop_arm_1==1|m2kb.cat_6wks_postop_arm_1==0) & (m2kb.cat_3mo_postop_arm_1==1|m2kb.cat_3mo_postop_arm_1==0)
    &m2kb.cat_6mo_postop_arm_1==7 &
      (m2kb.move_baseline_visit_arm_1 == 1| m2kb.move_baseline_visit_arm_1 == 0)  & (m2kb.move_6wks_postop_arm_1==1|m2kb.move_6wks_postop_arm_1==0) &(m2kb.move_3mo_postop_arm_1==1|m2kb.move_3mo_postop_arm_1==0)
    &m2kb.move_6mo_postop_arm_1==7  &
      (m2kb.sleep_baseline_visit_arm_1 == 1|m2kb.sleep_baseline_visit_arm_1 == 0)  &(m2kb.sleep_6wks_postop_arm_1==1|m2kb.sleep_6wks_postop_arm_1==0) &(m2kb.sleep_3mo_postop_arm_1==1|m2kb.sleep_3mo_postop_arm_1==0)
    & (m2kb.sleep_6mo_postop_arm_1==1|m2kb.sleep_6mo_postop_arm_1==0) &
      (m2kb.sleep_hours_baseline_visit_arm_1 == 1|m2kb.sleep_hours_baseline_visit_arm_1 == 0)  &(m2kb.sleep_hours_6wks_postop_arm_1==1|m2kb.sleep_hours_6wks_postop_arm_1==0) &(m2kb.sleep_hours_3mo_postop_arm_1==1|
                                                                                                                                                                                  m2kb.sleep_hours_3mo_postop_arm_1==0) & (m2kb.sleep_hours_6mo_postop_arm_1==1|m2kb.sleep_hours_6mo_postop_arm_1==0)  &
      (m2kb.func_baseline_visit_arm_1 == 1|m2kb.func_baseline_visit_arm_1 == 0)  &m2kb.func_6wks_postop_arm_1==7 &(m2kb.func_3mo_postop_arm_1==1|m2kb.func_3mo_postop_arm_1==0) &m2kb.func_6mo_postop_arm_1==7 &
      (m2kb.img_baseline_visit_arm_1 == 1|m2kb.img_baseline_visit_arm_1 == 0)  &m2kb.img_6wks_postop_arm_1==7 &(m2kb.img_3mo_postop_arm_1==1|m2kb.img_3mo_postop_arm_1==0) &m2kb.img_6mo_postop_arm_1==7 &
      (m2kb.blood_baseline_visit_arm_1 == 1|m2kb.blood_baseline_visit_arm_1 == 0) &(m2kb.blood_6wks_postop_arm_1==1|m2kb.blood_6wks_postop_arm_1==0) & (m2kb.blood_3mo_postop_arm_1==1|m2kb.blood_3mo_postop_arm_1==0)
    & m2kb.blood_6mo_postop_arm_1==7  &
      (m2kb.qst_baseline_visit_arm_1 == 1|m2kb.qst_baseline_visit_arm_1 == 0)  &m2kb.qst_6wks_postop_arm_1==7 
    & (m2kb.qst_3mo_postop_arm_1==1|m2kb.qst_3mo_postop_arm_1==0)  &
      (m2kb.cog_baseline_visit_arm_1 == 1|m2kb.cog_baseline_visit_arm_1 == 0)  &(m2kb.cog_6wks_postop_arm_1==1|m2kb.cog_6wks_postop_arm_1==0) &(m2kb.cog_3mo_postop_arm_1==1|m2kb.cog_3mo_postop_arm_1==0)
    & (m2kb.cog_6mo_postop_arm_1==1|m2kb.cog_6mo_postop_arm_1==0) &
      (m2kb.social_baseline_visit_arm_1 == 1|m2kb.social_baseline_visit_arm_1 == 0)  &(m2kb.social_6wks_postop_arm_1==1|m2kb.social_6wks_postop_arm_1==0) &(m2kb.social_3mo_postop_arm_1==1|m2kb.social_3mo_postop_arm_1==0)
    & m2kb.social_6mo_postop_arm_1== 7  &
      (m2kb.res_baseline_visit_arm_1 == 1|m2kb.res_baseline_visit_arm_1 == 0)  & m2kb.res_6wks_postop_arm_1==7 & m2kb.res_3mo_postop_arm_1==7 & 
      m2kb.res_6mo_postop_arm_1==7 & 
      (m2kb.ace_baseline_visit_arm_1 == 1|m2kb.ace_baseline_visit_arm_1 == 0)  & m2kb.ace_6wks_postop_arm_1==7 & m2kb.ace_3mo_postop_arm_1==7 & 
      m2kb.ace_6mo_postop_arm_1==7 &
      m2kb.traj_baseline_visit_arm_1 == 7&m2kb.traj_6wks_postop_arm_1==7&m2kb.traj_3mo_postop_arm_1==7&m2kb.traj_6mo_postop_arm_1==1&
      m2kb.base_traj_baseline_visit_arm_1 == 1 & m2kb.base_traj_6wks_postop_arm_1==7 & m2kb.base_traj_3mo_postop_arm_1==7&
      m2kb.base_traj_6mo_postop_arm_1==7)





#idenitify IDs with complete data

m2kdata_complet1 <- m2kdata_complete %>% 
  select(record_id,redcap_data_access_group)


#merge ids with data_explore, create error free dataset

m2kcomp_tbl <- right_join(m2kdata_explore,m2kdata_complet1,by = c("record_id","redcap_data_access_group")) %>% 
  add_column(status = "error free streak")


#idenitify IDs in  with errors

m2kdata_errrorcomplet1 <- m2kdata_complete_errors %>% 
  select(record_id,redcap_data_access_group)


#merge ids with data_explore to create a dataset of ids with errors and id with no errors

m2kcomp_error_tbl1 <- right_join(m2kdata_explore,m2kdata_errrorcomplet1,by = c("record_id","redcap_data_access_group"))

#isolate records with errors by anti join 

m2kcomp_error_tbl <- anti_join(m2kcomp_error_tbl1,m2kcomp_tbl,by = c("record_id","redcap_data_access_group"))  %>% 
  add_column(status = "streak with errors")


# combine comp_erro_tbl and comp_tbl


m2ktemp_table <- rbind(m2kcomp_tbl,m2kcomp_error_tbl)


#extract ids not in temp_table and then add  to temp table vertically

m2kother_tbl <- anti_join(m2kdata_explore,m2ktemp_table,by = c("record_id","redcap_data_access_group"))  %>% 
  add_column(status = "incomplete streak")



# for datatable
m2knew_tbl <- rbind(m2ktemp_table,m2kother_tbl) %>% 
  mutate(across(everything(), as.factor))



# create a dataset for complete records to download for the user

# reformat both datasets for merging

m2kdata_original <- datam2k
m2kdata_original[] <- lapply(m2kdata_original, as.character)
m2kcomp_tbl[] <- lapply(m2kcomp_tbl, as.character)


m2kcomp_dta_tbl <- inner_join(m2kdata_original,m2kcomp_tbl,by = intersect(names(m2kdata_original), names(m2kcomp_tbl)))




# create a dataset of IDs with complete baseline biomarker data plus 6 months outcome

m2kdata_biomarker <-  m2kdata_explore1 %>% 
  
  filter(m2kb.bpi_baseline_visit_arm_1 == 1 &
           m2kb.koos_baseline_visit_arm_1 == 1  &
           m2kb.anxiety_baseline_visit_arm_1 == 1 &
           m2kb.dep_baseline_visit_arm_1 == 1  &
           m2kb.cat_baseline_visit_arm_1 == 1  &
           m2kb.move_baseline_visit_arm_1 == 1  &
           m2kb.sleep_baseline_visit_arm_1 == 1  &
           m2kb.sleep_hours_baseline_visit_arm_1 == 1  &
           m2kb.func_baseline_visit_arm_1 == 1  &
           m2kb.img_baseline_visit_arm_1 == 1  &
           m2kb.qst_baseline_visit_arm_1 == 1  &
           m2kb.blood_baseline_visit_arm_1 == 1  &
           m2kb.cog_baseline_visit_arm_1 == 1&
           m2kb.social_baseline_visit_arm_1 == 1&
           m2kb.res_baseline_visit_arm_1 == 1&
           m2kb.ace_baseline_visit_arm_1 == 1 &
           m2kb.traj_baseline_visit_arm_1 == 7&m2kb.traj_6wks_postop_arm_1==7&m2kb.traj_3mo_postop_arm_1==7&m2kb.traj_6mo_postop_arm_1==1&
           m2kb.base_traj_baseline_visit_arm_1 == 1 & m2kb.base_traj_6wks_postop_arm_1==7 & m2kb.base_traj_3mo_postop_arm_1==7&
           m2kb.base_traj_6mo_postop_arm_1==7) %>% 
  select(record_id,redcap_data_access_group) 


#merge ids with data_explore, create error free dataset with error free baseline surverys and error free 6 months outcome

m2kcomp_tbl_biomarker <- right_join(m2kdata_explore,m2kdata_biomarker,by = c("record_id","redcap_data_access_group")) %>% 
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  mutate(MCC2_TKA_six_mo_traj = ifelse(MCC2_TKA_six_mo_traj == 7, 1,7)) %>% 
  mutate(m2kb.traj = ifelse(m2kb.traj == 7, 1,7)) %>% 
  add_column(status = "complete without errors") %>% 
  select(-redcap_event_name) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  mutate(status = as.factor(status))




# create a dataset of IDs with complete or with error baseline biomarker data plus 6 months outcome

m2kdata_biomarker_errors <-  m2kdata_explore1 %>% 
  filter((m2kb.bpi_baseline_visit_arm_1 == 1 |m2kb.bpi_baseline_visit_arm_1 == 0) &
           (m2kb.koos_baseline_visit_arm_1 == 1 | m2kb.koos_baseline_visit_arm_1 == 0)  &
           (m2kb.anxiety_baseline_visit_arm_1 == 1 | m2kb.anxiety_baseline_visit_arm_1 == 0)   &
           (m2kb.dep_baseline_visit_arm_1 == 1|m2kb.dep_baseline_visit_arm_1 == 0) &
           (m2kb.cat_baseline_visit_arm_1 == 1|m2kb.cat_baseline_visit_arm_1 == 0)  & 
           (m2kb.move_baseline_visit_arm_1 == 1| m2kb.move_baseline_visit_arm_1 == 0)  &
           (m2kb.sleep_baseline_visit_arm_1 == 1|m2kb.sleep_baseline_visit_arm_1 == 0)  &
           (m2kb.sleep_hours_baseline_visit_arm_1 == 1|m2kb.sleep_hours_baseline_visit_arm_1 == 0)  &
           (m2kb.func_baseline_visit_arm_1 == 1|m2kb.func_baseline_visit_arm_1 == 0)  &
           (m2kb.img_baseline_visit_arm_1 == 1|m2kb.img_baseline_visit_arm_1 == 0) & 
           (m2kb.blood_baseline_visit_arm_1 == 1|m2kb.blood_baseline_visit_arm_1 == 0) &
           (m2kb.qst_baseline_visit_arm_1 == 1|m2kb.qst_baseline_visit_arm_1 == 0)  & 
           (m2kb.social_baseline_visit_arm_1 == 1|m2kb.social_baseline_visit_arm_1 == 0) &
           (m2kb.cog_baseline_visit_arm_1 == 1|m2kb.cog_baseline_visit_arm_1 == 0)  & 
           (m2kb.res_baseline_visit_arm_1 == 1|m2kb.res_baseline_visit_arm_1 == 0)  & 
           (m2kb.ace_baseline_visit_arm_1 == 1|m2kb.ace_baseline_visit_arm_1 == 0) & 
           (m2kb.traj_baseline_visit_arm_1 == 7&m2kb.traj_6wks_postop_arm_1==7&m2kb.traj_3mo_postop_arm_1==7&m2kb.traj_6mo_postop_arm_1==1)&
           (m2kb.base_traj_baseline_visit_arm_1 == 1 & m2kb.base_traj_6wks_postop_arm_1==7 & m2kb.base_traj_3mo_postop_arm_1==7&
              m2kb.base_traj_6mo_postop_arm_1==7)) %>% 
  select(record_id,redcap_data_access_group) 


#merge ids with data_explore, create error free dataset with error free baseline surverys and error free 6 months outcome

m2kcomp_tbl_biomarker_errors <- right_join(m2kdata_explore,m2kdata_biomarker_errors,by = c("record_id","redcap_data_access_group")) %>% 
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  mutate(MCC2_TKA_six_mo_traj = ifelse(MCC2_TKA_six_mo_traj == 7, 1,7)) %>% 
  mutate(m2kb.traj = ifelse(m2kb.traj == 7, 1,7)) %>% 
  add_column(status = "complete with and without errors") %>% 
  select(-redcap_event_name)

# creat a final table of data with baseline biomarker + 6 m traj with and without errors


m2kall_tbl_biomarker <- rbind(m2kcomp_tbl_biomarker,m2kcomp_tbl_biomarker_errors)

# create a table for upset plots with either date with or without error 1/0 and baseline and 6 months data


# create a dataset of IDs with complete or with error baseline biomarker data plus 6 months outcome for upset plots

m2k_biomarker_upset <-  m2kdata_explore1 %>% 
  filter((m2kb.bpi_baseline_visit_arm_1 == 1 |m2kb.bpi_baseline_visit_arm_1 == 0) &
           (m2kb.koos_baseline_visit_arm_1 == 1 | m2kb.koos_baseline_visit_arm_1 == 0)  &
           (m2kb.anxiety_baseline_visit_arm_1 == 1 | m2kb.anxiety_baseline_visit_arm_1 == 0)   &
           (m2kb.dep_baseline_visit_arm_1 == 1|m2kb.dep_baseline_visit_arm_1 == 0) &
           (m2kb.cat_baseline_visit_arm_1 == 1|m2kb.cat_baseline_visit_arm_1 == 0)  & 
           (m2kb.move_baseline_visit_arm_1 == 1| m2kb.move_baseline_visit_arm_1 == 0)  &
           (m2kb.sleep_baseline_visit_arm_1 == 1|m2kb.sleep_baseline_visit_arm_1 == 0)  &
           (m2kb.sleep_hours_baseline_visit_arm_1 == 1|m2kb.sleep_hours_baseline_visit_arm_1 == 0)  &
           (m2kb.func_baseline_visit_arm_1 == 1|m2kb.func_baseline_visit_arm_1 == 0)  &
           (m2kb.img_baseline_visit_arm_1 == 1|m2kb.img_baseline_visit_arm_1 == 0) & 
           (m2kb.blood_baseline_visit_arm_1 == 1|m2kb.blood_baseline_visit_arm_1 == 0) &
           (m2kb.qst_baseline_visit_arm_1 == 1|m2kb.qst_baseline_visit_arm_1 == 0)  & 
           (m2kb.social_baseline_visit_arm_1 == 1|m2kb.social_baseline_visit_arm_1 == 0) &
           (m2kb.cog_baseline_visit_arm_1 == 1|m2kb.cog_baseline_visit_arm_1 == 0)  & 
           (m2kb.res_baseline_visit_arm_1 == 1|m2kb.res_baseline_visit_arm_1 == 0)  & 
           (m2kb.ace_baseline_visit_arm_1 == 1|m2kb.ace_baseline_visit_arm_1 == 0)) %>% 
  select(record_id,redcap_data_access_group,ends_with("baseline_visit_arm_1"),m2kb.traj_6mo_postop_arm_1,-m2kb.traj_baseline_visit_arm_1) %>% 
  mutate_at(vars(-c(1:2)), ~ifelse(. != 1, 0, .)) %>% 
  rename("BPI"="m2kb.bpi_baseline_visit_arm_1","KOOS"="m2kb.koos_baseline_visit_arm_1","Depression"="m2kb.dep_baseline_visit_arm_1" ,"Anxiety"= "m2kb.anxiety_baseline_visit_arm_1" ,"Catastophizing"="m2kb.cat_baseline_visit_arm_1",       
         "FearMovement"="m2kb.move_baseline_visit_arm_1" ,"Sleep"= "m2kb.sleep_baseline_visit_arm_1" , "Sleep_hours"="m2kb.sleep_hours_baseline_visit_arm_1","Funtional"="m2kb.func_baseline_visit_arm_1","Blood_Draw"="m2kb.blood_baseline_visit_arm_1",      
         "Imaging"="m2kb.img_baseline_visit_arm_1"  ,"QST"= "m2kb.qst_baseline_visit_arm_1"  ,"Cognition" ="m2kb.cog_baseline_visit_arm_1" ,"Resilience"="m2kb.res_baseline_visit_arm_1" ,"Social_Support" ="m2kb.social_baseline_visit_arm_1" ,   
         "ACE"="m2kb.ace_baseline_visit_arm_1"  , "Baseline_Traj" ="m2kb.base_traj_baseline_visit_arm_1","6_months_Traj"="m2kb.traj_6mo_postop_arm_1")

# data wrangling for upset plots
# create an m1 days from sysdate dataframe, with <= 35 days from baseline visit only
m2kdays_from_sysdate_35baseline <- m2kdays_from_sysdate %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" & days_from_today >= -35) %>% 
  filter(!record_id %in% result_withdraw)

#create an appendix dataframe for upset plot <= 35days
m2k_biomarker_35upset_df <-m2k_biomarker_upset%>% 
  right_join(.,m2kdays_from_sysdate_35baseline, by= "record_id") %>% 
  select(-"6_months_Traj",-last_seen) %>%
  add_column(cohort = "MCC2_TKA") %>% 
  as.data.frame() 

#create a dataframe for upset plot, <= 35 days

m2k_biomarker_35upsetplot <- m2k_biomarker_upset %>% 
  right_join(.,m2kdays_from_sysdate_35baseline, by= "record_id") %>% 
  select(-"6_months_Traj",-record_id,-redcap_event_name,- redcap_data_access_group,-days_from_today,-last_seen)

m2k_biomarker_35upsetplot<-m2k_biomarker_35upsetplot%>%
  filter(rowSums(is.na(m2k_biomarker_35upsetplot)) != ncol(m2k_biomarker_35upsetplot)) %>% 
  as.data.frame()

# create an m2k days from sysdate dataframe, with ~7 months from baseline visit only
m2kdays_from_sysdate_7mobaseline <- m2kdays_from_sysdate %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" & days_from_today <= -220) %>% 
  filter(!record_id %in% result_withdraw)

#create an appendix dataframe for upset plot ~ 7 months from baseline visit
m2k_biomarker_7moupset_df <-m2k_biomarker_upset%>% 
  right_join(.,m2kdays_from_sysdate_7mobaseline, by= "record_id") %>% 
  select(-last_seen) %>%
  add_column(cohort = "MCC2_TKA") %>% 
  as.data.frame()

#create a dataframe for upset plot,  ~ 7 months from baseline

m2k_biomarker_7moupsetplot <- m2k_biomarker_upset %>% 
  right_join(.,m2kdays_from_sysdate_7mobaseline, by= "record_id") %>% 
  select(-record_id,-redcap_event_name,- redcap_data_access_group,-days_from_today,-last_seen)

m2k_biomarker_7moupsetplot<- m2k_biomarker_7moupsetplot %>%
  filter(rowSums(is.na(m2k_biomarker_7moupsetplot)) != ncol(m2k_biomarker_7moupsetplot)) %>% 
  as.data.frame()




#### CREATE ALL FREQ DATA


# MCC1 1 TKA
# creat freq_data



#bpi
freq.bpi <- full_bpi %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "bpi_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BPI") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

#koos
freq.koos <- full_koos %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "koos12_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "koos") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#anxiety
freq.anxiety <- full_anxiety %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "anxiety_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Anxiety") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#dep
freq.dep <- full_dep %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "dep_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Depression") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# cat

freq.cat <- full_cat %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "cat_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Catastrophizing") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#fearmove


freq.move <- full_move  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "FearMovement_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "FearMovement") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#promis sleep


freq.sleep <- full_slp %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "sleep_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset ="Promis_Sleep") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#sleep hours

freq.sleep_hours <- full_slp_hrs  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "sleep_hours_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "sleep_hours") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#cognition

freq.cog <- full_cog  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "cog_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "cognition") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#resilience

freq.res <- full_res  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "res_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "resilience") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#social

freq.social <- full_social  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "social_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "social_support") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#ACE
freq.ace <- full_ace  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "ace_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "ACE") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 
# func
freq.func <- full_func %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "func_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Functional") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#blood

freq.blood <- full_bld %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "bld_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BloodDraw") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#img



freq.image <- full_img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "img_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Imaging") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

#qst

freq.qst <- full_ta.img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "qst_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "QST") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


# creat freq_data mcc2 thoracic



#bpi
mfreq.bpi <- m2full_bpi %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2bpi_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BPI") %>% 
  as_tibble() %>% 
  mutate_all(as.character) #keeo dataset same for mcc1 and mcc2 since we will rbind later


#anxiety
mfreq.anxiety <- m2full_anxiety %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2anxiety_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Anxiety") %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#dep
mfreq.dep <- m2full_dep %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2dep_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Depression") %>% 
  as_tibble() %>% 
  mutate_all(as.character)

# cat

mfreq.cat <- m2full_cat %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2cat_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Catastrophizing") %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#fearmove


mfreq.move <- m2full_move  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2FearMovement_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "FearMovement") %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#promis sleep


mfreq.sleep <- m2full_slp %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2sleep_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset ="Promis_Sleep") %>% 
  as_tibble() %>% 
  mutate_all(as.character)



#sleep hours

mfreq.sleep_hours <- m2full_slp_hrs  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2sleep_hours_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "sleep_hours") %>% 
  as_tibble() %>% 
  mutate_all(as.character)

# cognition


mfreq.cog <- m2full_cog %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2cog_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "cognition") %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# resilience


mfreq.res <- m2full_res %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2res_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "resilience") %>% 
  as_tibble() %>% 
  mutate_all(as.character)


# social_support


mfreq.social <- m2full_social %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2social_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "social_support") %>% 
  as_tibble() %>% 
  mutate_all(as.character)


#ACE

mfreq.ace <- m2full_ace  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2ace_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  mutate(dataset = "ACE") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



# func
freq.func <- full_func %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "func_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Functional") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 







# mcc2 TKA creat freq_data



#bpi
m2kfreq.bpi <- m2kfull_bpi %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kbpi_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BPI") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

#koos
m2kfreq.koos <- m2kfull_koos %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kkoos12_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "koos") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#anxiety
m2kfreq.anxiety <- m2kfull_anxiety %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kanxiety_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Anxiety") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#dep
m2kfreq.dep <- m2kfull_dep %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kdep_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Depression") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# cat

m2kfreq.cat <- m2kfull_cat %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kcat_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Catastrophizing") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#fearmove


m2kfreq.move <- m2kfull_move  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kFearMovement_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "FearMovement") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#promis sleep


m2kfreq.sleep <- m2kfull_slp %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2ksleep_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset ="Promis_Sleep") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 



#sleep hours

m2kfreq.sleep_hours <- m2kfull_slp_hrs  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2ksleep_hours_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "sleep_hours") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#cognition

m2kfreq.cog <- m2kfull_cog  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kcog_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "cognition") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#resilience

m2kfreq.res <- m2kfull_res  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kres_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "resilience") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#social

m2kfreq.social <- m2kfull_social  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2ksocial_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "social_support") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#ACE
m2kfreq.ace <- m2kfull_ace  %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kace_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "ACE") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

# func
m2kfreq.func <- m2kfull_func %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kfunc_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Functional") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#blood

m2kfreq.blood <- m2kfull_bld %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kbld_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "BloodDraw") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#img



m2kfreq.image <- m2kfull_img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kimg_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "Imaging") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 

#qst

m2kfreq.qst <- m2kfull_ta.img %>%
  pivot_longer(cols = c(-record_id,-redcap_event_name,-redcap_data_access_group), names_to = "var",
               values_to = "missing") %>%
  filter(var != "m2kqst_complete") %>% 
  group_by(record_id,redcap_event_name,redcap_data_access_group) %>%
  mutate(error = case_when(missing == 1 ~ "clean",
                           missing == 2 ~ "2",
                           missing == 8 ~ "8",
                           TRUE ~ as.character(var))) %>%
  select(-var) %>%
  
  mutate(dataset = "QST") %>% 
  as_tibble() %>% 
  mutate_all(as.character) 


#create final freq dataset for mcc1 and mcc2

# create m2k freqdata 


m2kfreq <- rbind(m2kfreq.bpi,m2kfreq.cat,m2kfreq.anxiety,m2kfreq.dep,m2kfreq.move,m2kfreq.sleep,m2kfreq.sleep_hours,m2kfreq.cog,
                 m2kfreq.res,m2kfreq.social,m2kfreq.ace) %>% 
  mutate(redcap_data_access_group = case_when(redcap_data_access_group == "university_of_mich" ~ "MCC2_TKA_university_of_mich",
                                              redcap_data_access_group == "spectrum_health" ~ "MCC2_TKA_spectrum_health")) 

freq_datam1m2 <- rbind(freq.bpi,freq.cat,freq.anxiety,freq.dep,freq.move,freq.sleep,freq.sleep_hours,freq.cog,
                       freq.res,freq.social,freq.ace,
                       mfreq.bpi,mfreq.cat,mfreq.anxiety,mfreq.dep,mfreq.move,mfreq.sleep,
                       mfreq.sleep_hours,mfreq.cog,mfreq.res,mfreq.social,mfreq.ace,
                       m2kfreq) %>% 
  mutate(dataset=as.factor(dataset)) %>% 
  ungroup() %>% 
  filter(missing == 0) %>% 
  select(-missing,-redcap_event_name) %>% 
  group_by(redcap_data_access_group,dataset,error) %>%
  summarise(total=n())



####################################
##########select vars mcc1 tka and mcc2 thoracic ###############
###################################


# bpi vars mcc1

selectbpim1 <- data %>% 
  select(bpi_mbm_z1_rate,bpi_mbm_z1_dur,bpi_mbm_z2_rate,bpi_mbm_z2_dur,bpi_mbm_z3_rate,bpi_mbm_z3_dur,bpi_mbm_z4_rate,bpi_mbm_z4_dur,bpi_mbm_z5_rate,
         bpi_mbm_z5_dur,bpi_mbm_z6_rate,bpi_mbm_z6_dur,bpi_mbm_z7_rate,bpi_mbm_z7_dur,bpi_mbm_z8_rate,bpi_mbm_z8_dur,bpi_mbm_z9_rate,bpi_mbm_z9_dur,bpipainintrfrscore)  


selectbpim2 <- mcc2data %>% 
  select(bpi_mbm_z1_rate,bpi_mbm_z1_dur,bpi_mbm_z2_rate,bpi_mbm_z2_dur,bpi_mbm_z3_rate,bpi_mbm_z3_dur,bpi_mbm_z4_rate,bpi_mbm_z4_dur,bpi_mbm_z5_rate,
         bpi_mbm_z5_dur,bpi_mbm_z6_rate,bpi_mbm_z6_dur,bpi_mbm_z7_rate,bpi_mbm_z7_dur,bpi_mbm_z8_rate,bpi_mbm_z8_dur,bpi_mbm_z9_rate,bpi_mbm_z9_dur,bpipainintrfrscore)  



# anxiety vars

selectanxietym1 <- data %>% 
  select(gad2feelnervscl   ,gad2notstopwryscl   ,     gad7wrytoomchscl   ,                 
         gad7troubrelxscl   ,gad7rstlessscl   ,  gad7easyannoyedscl   ,  gad7feelafrdscl   ,      gad7_tot_not_sure   ,                  gad7_tot_several   ,                 
         gad7_tot_over_half   ,    gad7_tot_every_day   , gad7totscore   ,                     
         gad7difficulttowork)


selectanxietym2 <- mcc2data %>% 
  select(gad2feelnervscl   ,gad2notstopwryscl   ,     gad7wrytoomchscl   ,                 
         gad7troubrelxscl   ,gad7rstlessscl   ,  gad7easyannoyedscl   ,  gad7feelafrdscl   ,      gad7_tot_not_sure   ,                  gad7_tot_several   ,                 
         gad7_tot_over_half   ,    gad7_tot_every_day   , gad7totscore   ,                     
         gad7difficulttowork)

# dep vars

selectdepm1 <- data %>% 
  select(phqlitintrstscore,phqdeprssnscore,phqsleepimpairscore,phqtirdlittleenrgyscore,phqabnrmldietscore,phqflngfailrscore,phqconcntrtnimprmntscore,phqmovmntspchimprmntscore,phqtotalscore)


selectdepm2 <- mcc2data %>% 
  select(phqlitintrstscore,phqdeprssnscore,phqsleepimpairscore,phqtirdlittleenrgyscore,phqabnrmldietscore,phqflngfailrscore,phqconcntrtnimprmntscore,phqmovmntspchimprmntscore,phqtotalscore)



# cat var

selectcatm1 <- data %>% 
  select(pcqpainawfulovrwhlmscl,pcqfeelcantwithstandscl,pcqafraidpainworsescl,pcqhurtscl,pcqpainstopscl,pcqseriousscl,pcqtotalscoreval)


selectcatm2 <- mcc2data %>% 
  select(pcqpainawfulovrwhlmscl,pcqfeelcantwithstandscl,pcqafraidpainworsescl,pcqhurtscl,pcqpainstopscl,pcqseriousscl,pcqtotalscoreval)



#  fear movement

selectmovem1 <- data %>% 
  select(fabqphysclactvtywrsscl,fabqphysclactvtybckhrmscl,fabqphysactvtyshldntdoscl,fabqphysactvtycnntdoscl)  

selectmovem2 <- mcc2data %>% 
  select(fabqphysclactvtywrsscl,fabqphysclactvtybckhrmscl,fabqphysactvtyshldntdoscl,fabqphysactvtycnntdoscl)  

# sleep

selectsleepm1 <- data %>% 
  select(promissleepwasrefreshscl,promisproblemwithslpscl,promisdifficltfallaslpscl,promisslpwasrestlessscl,promistryhardgettoslpscl,promissleepqualityscl)  

selectsleepm2 <- mcc2data %>% 
  select(promissleepwasrefreshscl,promisproblemwithslpscl,promisdifficltfallaslpscl,promisslpwasrestlessscl,promistryhardgettoslpscl,promissleepqualityscl)  


# sleep hours

selectsleephrsm1 <- data.sleep_hours1 %>% 
  select(sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur) 

selectsleephrsm2 <- mcc2data %>% 
  select(sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur) 



# cognition

selectcogm1 <- data %>% 
  select("miscithinkclrscl"  , "miscimindsharpscl", "miscirememberscl","miscilearnscl"  ,   "misciconcentratescl" , "misciattentionscl"  ,  
         "miscishiftactivscl", "misciplanningscl" , "misciexpressscl"   , "miscirightwordsscl" ,"miscitotalscore"  ) 


# cognition

selectcogm2 <- mcc2data %>% 
  select("miscithinkclrscl"  , "miscimindsharpscl", "miscirememberscl","miscilearnscl"  ,   "misciconcentratescl" , "misciattentionscl"  ,  
         "miscishiftactivscl", "misciplanningscl" , "misciexpressscl"   , "miscirightwordsscl" ,"miscitotalscore"  )   


#resilience

selectresm1 <- data %>% 
  select(names(error.res1),-record_id,-redcap_event_name,-pain_resilience_scale_prs_complete)

#resilience
selectresm2 <- mcc2data %>% 
  select(names(error.res1),-record_id,-redcap_event_name,-pain_resilience_scale_prs_complete)


#social

selectsocialm1 <- data %>% 
  select(names(error.social1),-record_id,-redcap_event_name,-promis_sf_v20_emotional_support_6a_complete)


#social

selectsocialm2 <- mcc2data %>% 
  select(names(error.social1),-record_id,-redcap_event_name,-promis_sf_v20_emotional_support_6a_complete)

#ACE

selectacem1 <- data %>% 
  select(names(error.ace1),-record_id,-redcap_event_name)

selectacem2 <- mcc2data %>% 
  select(names(error.ace1),-record_id,-redcap_event_name)

####################################
##########select vars mcc2 TKA ###############
###################################


# bpi vars

m2kselectbpi <- datam2k %>% 
  select(bpi_mbm_z1_rate,bpi_mbm_z1_dur,bpi_mbm_z2_rate,bpi_mbm_z2_dur,bpi_mbm_z3_rate,bpi_mbm_z3_dur,bpi_mbm_z4_rate,bpi_mbm_z4_dur,bpi_mbm_z5_rate,
         bpi_mbm_z5_dur,bpi_mbm_z6_rate,bpi_mbm_z6_dur,bpi_mbm_z7_rate,bpi_mbm_z7_dur,bpi_mbm_z8_rate,bpi_mbm_z8_dur,bpi_mbm_z9_rate,bpi_mbm_z9_dur,bpipainintrfrscore)  


# koos vars

m2kselectkoos <- datam2k %>% 
  select(koospainfreqscl,koospainwalkflatscl   ,              koospainstairsscl   ,                koospainsitlyingscl ,              
         koosfuncdiffrisesitscl  ,           koosfuncdiffstandscl     ,           koosfuncdiffcarscl ,                
         koosfunctwistpivotscl  ,         koosqolkneeawarescl    ,             koosqollifestylemodscl,            
         koosqolconfidencescl ,              koosqolkneedifficultyscl  ,      koospainscore ,                
         koospainscoret,                     koosfunctionscore ,                 koosfunctionscoret ,               
         koosqolscore ,                     koosqolscoret   ,                    koossummaryscore )


# anxiety vars

m2kselectanxiety <- datam2k %>% 
  select(gad2feelnervscl   ,gad2notstopwryscl   ,     gad7wrytoomchscl   ,                 
         gad7troubrelxscl   ,gad7rstlessscl   ,  gad7easyannoyedscl   ,  gad7feelafrdscl   ,      gad7_tot_not_sure   ,                  gad7_tot_several   ,                 
         gad7_tot_over_half   ,    gad7_tot_every_day   , gad7totscore   ,                     
         gad7difficulttowork)


# dep vars

m2kselectdep <- datam2k %>% 
  select(phqlitintrstscore,phqdeprssnscore,phqsleepimpairscore,phqtirdlittleenrgyscore,phqabnrmldietscore,phqflngfailrscore,phqconcntrtnimprmntscore,phqmovmntspchimprmntscore,phqtotalscore)


# cat var

m2kselectcat <- datam2k %>% 
  select(pcqpainawfulovrwhlmscl,pcqfeelcantwithstandscl,pcqafraidpainworsescl,pcqhurtscl,pcqpainstopscl,pcqseriousscl,pcqtotalscoreval)


#  fear movement

m2kselectmove <- datam2k %>% 
  select(fabqphysclactvtywrsscl,fabqphysclactvtybckhrmscl,fabqphysactvtyshldntdoscl,fabqphysactvtycnntdoscl)  


# sleep

m2kselectsleep <- datam2k %>% 
  select(promissleepwasrefreshscl,promisproblemwithslpscl,promisdifficltfallaslpscl,promisslpwasrestlessscl,promistryhardgettoslpscl,promissleepqualityscl)  



# sleep hours

m2kselectsleephrs <- m2kdata.sleep_hours1 %>% 
  select(sleepnighthourmindurhrs,sleepnighthourmindurmins,sleepnighthourmindur) 

# cognition

m2kselectcog <- datam2k %>% 
  select("miscithinkclrscl"  , "miscimindsharpscl", "miscirememberscl","miscilearnscl"  ,   "misciconcentratescl" , "misciattentionscl"  ,  
         "miscishiftactivscl", "misciplanningscl" , "misciexpressscl"   , "miscirightwordsscl" ,"miscitotalscore"  )                                          

#resilience

m2kselectres <- datam2k %>% 
  select(names(m2kerror.res1),-record_id,-redcap_event_name,-pain_resilience_scale_prs_complete)


#social

m2kselectsocial <- datam2k %>% 
  select(names(m2kerror.social1),-record_id,-redcap_event_name,-promis_sf_v20_emotional_support_6a_complete)


#ace

m2kselectace <- datam2k %>% 
  select(names(m2kerror.ace1),-record_id,-redcap_event_name)



#func


m2kselectfun <- datam2k %>% 
  select (walk10initialpainscl     ,            
          walk10initialpainscl1 ,                 walk10finalpainscl ,                    walk10finalpainscl1 ,   
          walk10time ,              walk10time1 ,                           walk10completeyn ,                    
          walk10incompletereason ,                walk10assistyn ,                        walk10assist_cane___1 ,               
          walk10assist_crutch___1 ,               walk10assist_walkder___1 ,              walk10assist_perssuppt___1 ,          
          walk10assist_other___1 ,                walk10comments ,                      
          tstsbpscreen ,                          tstsprepainscl ,                        tstsprepainscl1 ,                     
          tstspostpainscl ,        tstspostpainscl1 ,       tststime ,   
          tststime1 ,  tstscompleteyn ,                        tstsnonreasonyn ,                     
          tstsnumbrepsyn ,  tstsassistyn ,       tstsassist_1___1 ,                    
          tstsassist_2___1 ,    tstsaddnotes ,     functional_testing_complete)

# qst vars

m2kselectqst <- datam2k %>% 
  select(pptpainlocation ,                       pptremote1val ,                         pptremote1val1 ,                      
         pptremote2val ,                         pptremote2val1 ,                        pptremote3val ,                       
         pptremote3val1 ,                        pptindex1val ,                          pptindex1val1 ,                       
         pptindex2val ,                          pptindex2val1 ,                         pptindex3val ,                        
         pptindex3val1 ,                         pptcompleteyn ,                         pptnotes ,   
         tsrep1initialpainrem ,                  tsrep1initialpainrem_d ,                tsrep1finalpainrem ,                  
         tsrep1finalpainrem_d ,                  tsrep2initialpainrem ,                  tsrep2initialpainrem_d ,              
         tsrep2finalpainrem ,                    tsrep2finalpainrem_d ,                  tsinitialpainremsclr3 ,               
         tsinitialpainremscl1r3 ,                tsfinalpainremsclr3 ,                   tsfinalpainremscl1r3 ,                
         tsfinalpainremafts15 ,                  tsfinalpainremafts30 ,                  tsrep1initialpainindex ,              
         tsrep1initialpainindex_d ,              tsrep1finalpainindex ,                  tsrep1finalpainindex_d ,              
         tsinitialpainindexsclr2 ,               tsinitialpainindexscl1r2 ,              tsfinalpainindexsclr2 ,               
         tsfinalpainindexscl1r2 ,                tsinitialpainindexsclr3 ,               tsinitialpainindexscl1r3 ,            
         tsfinalpainindexsclr3 ,                 tsfinalpainindexscl1r3 ,                tsfinalpainindafts15 ,                
         tsfinalpainindafts30 ,                  tscompleted ,                           tsnotes ,    
         cpmcoldwatertempc ,                     cpmcoldwaterpain30sscl ,                cpmcoldwaterpain30sscl1 ,             
         cpmcoldwaterpain60sscl ,                cpmcoldwaterpain60sscl1 ,               cpmbathrangeyn ,                      
         cpmoutrangetime , cpmppt1val , cpmppt1val1 ,  cpmppt2val ,  cpmppt2val1 ,   cpmppt3val ,  cpmppt3val1 , 
         cpmcompleteyn , cpmnotes ,  fmricuffcontrayn ,  fmricuffcalfpressure ,    fmricuffcalfpressure2)

# blood vars

m2kselectbld <- datam2k %>% 
  select (bscp_hrs_since_water ,                  bscp_hrs_since_food ,                 
          bscp_caff_cups_amt ,                    bscp_hrs_since_cafstim ,                bscp_any_vacc ,                       
          bscp_verify_pt ,                       bscp_procby_initials ,                      bscp_phleb_by_init ,                  
          bscp_sample_obtained___1 ,              bscp_no_sample_reason ,                 bscp_samplekit_brcd ,                 
          bscp_time_blood_draw ,                  bscp_lav1_not_obt___1 ,                 bscp_lav1_brcd ,                      
          bscp_paxg_not_obt___1 ,                 bscp_paxg_brcd ,                        bscp_time_centrifuge ,                
          bscp_lav1_centrif_brcd ,                bscp_plugcap_centrif_brcd ,             bscp_deg_of_hemolysis ,               
          bscp_aliquot_box_brcd ,                 bscp_buffycoat_na___1 ,                 bscp_buffycoat_brcd ,                 
          bscp_plasma_brcd ,                      bscp_aliq_cnt ,                         bscp_paxg_box_brcd ,                  
          bscp_paxg_aliq_na___1 ,                 bscp_paxg_aliq_brcd ,                   bscp_aliquot_freezer_time ,           
          bscp_protocol_dev ,                     bscp_protocol_dev_reason ,              bscp_comments)                    



#img vars
m2kselectimg <- datam2k %>% 
  select(fmricuff_initials ,                   
         fmripatientname ,                       fmricuffleg ,                           fmricuffcontrarecal ,                 
         fmricuffcalfpressurerecal ,             fmricuffcalfpressurerecal2 ,            fmricufft1techrating ,                
         fmricufft1repeated ,                    fmricufft1techrating2 ,                 fmricuffrestpainss ,                  
         fmricuffrestpainss2 ,                   fmricuffrestpainovrall ,                fmricuffrestpainovrall2 ,             
         fmricuffcurrpainaftfirstscanss ,        fmricuffcurrpainaftfirstscanss2 ,       fmricuffcurrpainaftfirstscanovrall ,  
         fmricuffcurrpainaftfirstscanovrall2 ,   fmricuffcurrpainaftfirstscancp ,        fmricuffcurrpainaftfirstscancp2 ,     
         fmricuffpainbegin ,                     fmricuffpainbegin2 ,                    fmricuffpainmid ,                     
         fmricuffpainmid2 ,                      fmricuffpainend ,                       fmricuffpainend2 ,                    
         fmricuffpaincpbegin ,                   fmricuffpaincpbegin2 ,                  fmricuffpaincpmid ,                   
         fmricuffpaincpmid2 ,                    fmricuffpaincpend ,                     fmricuffpaincpend2 ,                  
         fmricuffpainrestscanbegin ,             fmricuffpainrestscanbegin2 ,            fmricuffpainrestscanmid ,             
         fmricuffpainrestscanmid2 ,              fmricuffpainrestscanend ,               fmricuffpainrestscanend2 ,            
         fmricuffpainaftlastscanss ,             fmricuffpainaftlastscanss2 ,            fmricuffpainaftlastscanany ,          
         fmricuffpainaftlastscanany2 ,           fmricuffcompletescl ,                   fmricufft1yn ,                        
         fmricuffdwiyn ,                         fmricuffrest1yn ,                       fmricuffipyn ,                        
         fmricuffcpyn ,                          fmricuffrest2yn ,                       fmri_face_mask ,                      
         fmricuffdicuploaded ,                   fmricuffdicupdate ,                     fmricuffnotes  )          









# create data the  with counts for errors and 0 for no vars with no errrors

###########################
#####NORTHSHORE############
###########################


#isolate errors
nfrebpim1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "northshore")

#bind with var names
ntblbpim1 <- selectbpim1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% nfrebpim1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(nfrebpim1)


# Anxiety

nfreanxietym1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "northshore")


ntblanxietym1 <- selectanxietym1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfreanxietym1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(nfreanxietym1)

# depression


nfredepm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "northshore")


ntbldepm1 <- selectdepm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfredepm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(nfredepm1)



# catatastrophizing


nfrecatm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "northshore")


ntblcatm1 <- selectcatm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfrecatm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(nfrecatm1)


# fear movement


nfremovem1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "northshore")


ntblmovem1 <- selectmovem1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfremovem1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(nfremovem1)


# sleep


nfreslpm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "northshore")


ntblslpm1 <- selectsleepm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfreslpm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(nfreslpm1)


# sleep_hours


nfreslp_hrsm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "northshore")


ntblslp_hrsm1 <- selectsleephrsm1 %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfreslp_hrsm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(nfreslp_hrsm1)


#cognition


nfrecogm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "northshore")


ntblcogm1 <- selectcogm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfrecogm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(nfrecogm1)


# resilience


nfreresm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "northshore")


ntblresm1 <- selectresm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfreresm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(nfreresm1)


# social


nfresocialm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "northshore")


ntblsocialm1 <- selectsocialm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfresocialm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(nfresocialm1)



# ACE


nfreacem1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "northshore")


ntblacem1 <- selectacem1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% nfreacem1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "northshore") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(nfreacem1)

# merge all set for northshore

northfreqm1 <- rbind(ntblanxietym1,ntblbpim1,ntblcatm1,ntbldepm1,ntblmovem1,
                     ntblslpm1,ntblslp_hrsm1,ntblcogm1,ntblresm1,ntblsocialm1,ntblacem1) 




###########################
#####UCHICAGO############
###########################

##BPI

#isolate errors
cfrebpim1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "uchicago")

#bind with var names
ctblbpim1 <- selectbpim1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% cfrebpim1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(cfrebpim1)



# Anxiety

cfreanxietym1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblanxietym1 <- selectanxietym1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfreanxietym1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(cfreanxietym1)

# depression


cfredepm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "uchicago")


ctbldepm1 <- selectdepm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfredepm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(cfredepm1)



# catatastrophizing


cfrecatm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblcatm1 <- selectcatm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfrecatm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(cfrecatm1)


# fear movement


cfremovem1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblmovem1 <- selectmovem1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfremovem1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(cfremovem1)


# sleep


cfreslpm1 <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblslpm1 <- selectsleepm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfreslpm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(cfreslpm1)


# sleep_hours


cfreslp_hrsm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblslp_hrsm1 <- selectsleephrsm1 %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfreslp_hrsm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(cfreslp_hrsm1)

#cognition
cfrecogm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblcogm1 <- selectcogm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfrecogm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(cfrecogm1)

# resilience


cfreresm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblresm1 <- selectresm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfreresm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(cfreresm1)


# social


cfresocialm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblsocialm1 <- selectsocialm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfresocialm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(cfresocialm1)



# ACE

cfreacem1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "uchicago")


ctblacem1 <- selectacem1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% cfreacem1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "uchicago") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(cfreacem1)


# merge all set for  uchicago

chicfreqm1 <- rbind(ctblanxietym1,ctblbpim1,ctblcatm1,ctbldepm1,ctblmovem1,ctblslpm1,
                    ctblslp_hrsm1,ctblcogm1,ctblresm1,ctblsocialm1,ctblacem1) 


###########################
#####RUSH############
###########################

##BPI

#isolate errors
rfrebpim1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "rush_university_me")

#bind with var names
rtblbpim1 <- selectbpim1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% rfrebpim1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(rfrebpim1)


# Anxiety

rfreanxietym1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblanxietym1 <- selectanxietym1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfreanxietym1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(rfreanxietym1)

# depression


rfredepm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtbldepm1 <- selectdepm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfredepm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(rfredepm1)



# catatastrophizing


rfrecatm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblcatm1 <- selectcatm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfrecatm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(rfrecatm1)


# fear movement


rfremovem1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblmovem1 <- selectmovem1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfremovem1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(rfremovem1)


# sleep


rfreslpm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblslpm1 <- selectsleepm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfreslpm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(rfreslpm1)


# sleep_hours


rfreslp_hrsm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblslp_hrsm1 <- selectsleephrsm1 %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfreslp_hrsm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(rfreslp_hrsm1)

#cognition

rfrecogm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblcogm1 <- selectcogm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfrecogm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(rfrecogm1)


# resilience


rfreresm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblresm1 <- selectresm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfreresm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(rfreresm1)


# social


rfresocialm1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblsocialm1 <- selectsocialm1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfresocialm1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(rfresocialm1)


# ACE

rfreacem1 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "rush_university_me")


rtblacem1 <- selectacem1 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% rfreacem1$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "rush_university_me") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(rfreacem1)


# merge all set for   rush_university_me

rushfreqm1 <- rbind(rtblanxietym1,rtblbpim1,rtblcatm1,rtbldepm1,
                    rtblmovem1,rtblslpm1,rtblslp_hrsm1,rtblcogm1,rtblresm1,
                    rtblsocialm1,rtblacem1) 

###########################
#####***umich***############
###########################

##BPI

#isolate errors
mfrebpim2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "university_of_mich")

#bind with var names
mtblbpim2 <- selectbpim2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% mfrebpim2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(mfrebpim2)


# Anxiety

mfreanxietym2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblanxietym2 <- selectanxietym2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfreanxietym2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(mfreanxietym2)

# depression


mfredepm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtbldepm2 <- selectdepm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfredepm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(mfredepm2)



# catatastrophizing


mfrecatm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblcatm2 <- selectcatm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfrecatm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(mfrecatm2)


# fear movement


mfremovem2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblmovem2 <- selectmovem2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfremovem2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(mfremovem2)


# sleep


mfreslpm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblslpm2 <- selectsleepm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfreslpm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(mfreslpm2)


# sleep_hours


mfreslp_hrsm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblslp_hrsm2 <- selectsleephrsm2 %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfreslp_hrsm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(mfreslp_hrsm2)

# cognition

mfrecogm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblcogm2 <- selectcogm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfrecogm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(mfrecogm2)



# resilience


mfreresm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblresm2 <- selectresm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfreresm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(mfreresm2)


# social


mfresocialm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblsocialm2 <- selectsocialm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfresocialm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(mfresocialm2)



# ACE


mfreacem2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "university_of_mich")


mtblacem2 <- selectacem2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% mfreacem2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "university_of_mich") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(mfreacem2)




# merge all set for umich

michfreqm2 <- rbind(mtblanxietym2,mtblbpim2,mtblcatm2,mtbldepm2,mtblmovem2,
                    mtblslpm2,mtblslp_hrsm2,mtblcogm2,mtblresm2,mtblsocialm2,
                    mtblacem2) 




###########################
#####***spectrum***############
###########################

##BPI

#isolate errors
spfrebpim2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "spectrum_health")

#bind with var names
sptblbpim2 <- selectbpim2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols =1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% spfrebpim2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(spfrebpim2)


# Anxiety

spfreanxietym2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptblanxietym2 <- selectanxietym2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfreanxietym2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(spfreanxietym2)

# depression


spfredepm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptbldepm2 <- selectdepm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfredepm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(spfredepm2)



# catatastrophizing


spfrecatm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptblcatm2 <- selectcatm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfrecatm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(spfrecatm2)


# fear movement


spfremovem2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptblmovem2 <- selectmovem2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfremovem2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(spfremovem2)


# sleep


spfreslpm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptblslpm2 <- selectsleepm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfreslpm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(spfreslpm2)


# sleep_hours


spfreslp_hrsm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptblslp_hrsm2 <- selectsleephrsm2 %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfreslp_hrsm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(spfreslp_hrsm2)


# cognition

spfrecogm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "spectrum_health")


sptblcogm2 <- selectcogm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% spfrecogm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(spfrecogm2)


# resilience


sfreresm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "spectrum_health")


stblresm2 <- selectresm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% sfreresm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(sfreresm2)


# social


sfresocialm2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "spectrum_health")


stblsocialm2 <- selectsocialm2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% sfresocialm2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(sfresocialm2)

# ACE


sfreacem2 <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "spectrum_health")


stblacem2 <- selectacem2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% sfreacem2$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "spectrum_health") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(sfreacem2)



# merge all set for spectrum

spfreqm2 <- rbind(sptblanxietym2,sptblbpim2,sptblcatm2,sptbldepm2,sptblmovem2,sptblslpm2,
                  sptblslp_hrsm2,sptblcogm2,stblresm2,stblsocialm2,stblacem2) 

# create data the  with counts for errors and 0 for no vars with no errrors

###########################
#####mcc2 TKA umich############
###########################

##BPI

#isolate errors
m2kmfrebpi <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")

#bind with var names
m2kmtblbpi <- m2kselectbpi %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% m2kmfrebpi$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(m2kmfrebpi)



# KOOS

m2kmfrekoos <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "koos") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblkoos <- m2kselectkoos %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfrekoos$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "koos") %>% 
  rbind(m2kmfrekoos)


# Anxiety

m2kmfreanxiety <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblanxiety <- m2kselectanxiety %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfreanxiety$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(m2kmfreanxiety)

# depression


m2kmfredep <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtbldep<- m2kselectdep %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfredep$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(m2kmfredep)


# catatastrophizing


m2kmfrecat <-freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblcat <- m2kselectcat %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfrecat$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(m2kmfrecat)



# fear movement


m2kmfremove <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblmove <- freq_datam1m2 %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfremove$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(m2kmfremove)



# sleep


m2kmfreslp<- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblslp <- m2kselectsleep %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfreslp$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(m2kmfreslp)





# sleep_hours


m2kmfreslp_hrs<- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblslp_hrs <- m2kselectsleephrs %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfreslp_hrs$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(m2kmfreslp_hrs)





# cognition


m2kmfrecog <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblcog <- m2kselectcog %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfrecog$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(m2kmfrecog)




# resilience


m2kmfreres <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblres <- m2kselectres %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfreres$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(m2kmfreres)



# social


m2kmfresocial <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblsocial <- m2kselectsocial %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfresocial$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(m2kmfresocial)



# ACE


m2kmfreace <- freq_datam1m2 %>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_university_of_mich")


m2kmtblace <- m2kselectace %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2kmfreace$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_university_of_mich") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(m2kmfreace)


# merge all set for university_of_mich

m2k_umich_freq <- rbind(m2kmtblanxiety,m2kmtblbpi,m2kmtblcat,m2kmtbldep,m2kmtblkoos,m2kmtblmove,m2kmtblslp,m2kmtblslp_hrs,m2kmtblcog,
                        m2kmtblres,m2kmtblsocial,m2kmtblace) 


###########################
#####spectrum_health############
###########################


##BPI

#isolate errors
m2ksfrebpi <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "BPI") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")

#bind with var names
m2kstblbpi <- m2kselectbpi %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  filter(variable != "bpipainintrfrscore") %>% 
  mutate(variable = str_sub(variable,1, 10)) %>%
  distinct() %>% 
  filter(!variable %in% m2ksfrebpi$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "BPI") %>% 
  rbind(m2ksfrebpi)



# KOOS

m2ksfrekoos <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "koos") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblkoos <- m2kselectkoos %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfrekoos$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "koos") %>% 
  rbind(m2ksfrekoos)


# Anxiety

m2ksfreanxiety <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "Anxiety") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblanxiety <- m2kselectanxiety %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfreanxiety$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "Anxiety") %>% 
  rbind(m2ksfreanxiety)

# depression


m2ksfredep <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "Depression") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstbldep<- m2kselectdep %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfredep$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "Depression") %>% 
  rbind(m2ksfredep)


# catatastrophizing


m2ksfrecat <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "Catastrophizing") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblcat <- m2kselectcat %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfrecat$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "Catastrophizing") %>% 
  rbind(m2ksfrecat)



# fear movement


m2ksfremove <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "FearMovement") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblmove <- m2kselectmove %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfremove$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "FearMovement") %>% 
  rbind(m2ksfremove)



# sleep


m2ksfreslp<- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "Promis_Sleep") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblslp <- m2kselectsleep %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfreslp$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "Promis_Sleep") %>% 
  rbind(m2ksfreslp)





# sleep_hours


m2ksfreslp_hrs<- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "sleep_hours") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblslp_hrs <- m2kselectsleephrs %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfreslp_hrs$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "sleep_hours") %>% 
  rbind(m2ksfreslp_hrs)





# cognition


m2ksfrecog <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "cognition") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblcog <- m2kselectcog %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfrecog$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "cognition") %>% 
  rbind(m2ksfrecog)




# resilience


m2ksfreres <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "resilience") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblres <- m2kselectres %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfreres$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "resilience") %>% 
  rbind(m2ksfreres)



# social


m2ksfresocial <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "social_support") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblsocial <- m2kselectsocial %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfresocial$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "social_support") %>% 
  rbind(m2ksfresocial)



# ACE


m2ksfreace <- freq_datam1m2%>% 
  ungroup() %>% 
  filter(dataset == "ACE") %>% 
  filter(redcap_data_access_group == "MCC2_TKA_spectrum_health")


m2kstblace <- m2kselectace %>%  
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = 1:last_col(),names_to = "variable") %>% 
  select(-value) %>% 
  distinct() %>% 
  filter(!variable %in% m2ksfreace$error) %>% 
  rename( error = variable) %>% 
  mutate(total = 0) %>% 
  mutate(redcap_data_access_group = "MCC2_TKA_spectrum_health") %>% 
  mutate(dataset = "ACE") %>% 
  rbind(m2ksfreace)


# merge all spectrum

m2k_spec_freq <- rbind(m2kstblanxiety,m2kstblbpi,m2kstblcat,m2kstbldep,m2kstblkoos,m2kstblmove,m2kstblslp,m2kstblslp_hrs,m2kstblcog,
                       m2kstblres,m2kstblsocial,m2kstblace) 






# bind all DAGS

all_dag_freqm1m2 <- rbind(rushfreqm1,chicfreqm1,northfreqm1,michfreqm2,spfreqm2,m2k_umich_freq,m2k_spec_freq)


# remove  previous survey data that has only problematin vars from freq data, and update with new data that has all vars



survey_varsm1m2 <- c("BPI","Anxiety","Catastrophizing","Depression","FearMovement","Promis_Sleep",
                     "sleep_hours","cognition","resilience","social_support","ACE")

freq_datam1m2_1 <- freq_datam1m2 %>% 
  filter(!dataset %in% survey_varsm1m2)

# now bind updated dag data with freq data1

freq_datam1m2_2 <- rbind(freq_datam1m2_1,all_dag_freqm1m2) %>% 
  mutate(dataset=as.factor(dataset))

# create a table with distribution of scores


#bpi
#mcc1


m1bpi_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,bpipainintrfrscore,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  add_column(form = "BPI") %>% 
  rename(score = bpipainintrfrscore) 

#mcc2 

m2bpi_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,bpipainintrfrscore,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  add_column(form = "BPI") %>% 
  rename(score = bpipainintrfrscore) 

# mcc2 TKA
m2kbpi_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,bpipainintrfrscore,bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  filter(bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-bpisf_the_brief_pain_inventory_v23_short_form_bpi_complete) %>% 
  add_column(form = "BPI") %>% 
  rename(score = bpipainintrfrscore) 

# koos
#mcc1

m1koos_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,koossummaryscore,knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  add_column(form = "KOOS") %>% 
  rename(score = koossummaryscore) 

#mcc2

# m2koos_score <- mcc2data %>% 
#   select(record_id,redcap_data_access_group,redcap_event_name,koossummaryscore,knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
#   filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 2) %>% 
#   as_tibble() %>% 
#   mutate_all(as.character) %>% 
#   select(-knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
#   add_column(form = "KOOS") %>% 
#   rename(score = koossummaryscore) 

# mcc2 tka
m2kkoos_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,koossummaryscore,knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  filter(knee_injury_osteoarthritis_outcome_score_koos12_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-knee_injury_osteoarthritis_outcome_score_koos12_complete) %>% 
  add_column(form = "KOOS") %>% 
  rename(score = koossummaryscore) 

#Anxiety

#mcci

m1anxiety_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,gad7totscore,generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  add_column(form = "Anxiety") %>% 
  rename(score = gad7totscore) 

#mcc2

m2anxiety_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,gad7totscore,generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  add_column(form = "Anxiety") %>% 
  rename(score = gad7totscore) 

# mcc2 tka 

m2kanxiety_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,gad7totscore,generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  filter(generalized_anxiety_disorder_7_item_gad7_scale_sco_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-generalized_anxiety_disorder_7_item_gad7_scale_sco_complete) %>% 
  add_column(form = "Anxiety") %>% 
  rename(score = gad7totscore) 


#depression

#mcc1
m1dep_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,phqtotalscore,patient_health_questionnaire_depression_scale_phq_complete) %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  add_column(form = "Depression") %>% 
  rename(score = phqtotalscore) 

#mcc2

m2dep_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,phqtotalscore,patient_health_questionnaire_depression_scale_phq_complete) %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  add_column(form = "Depression") %>% 
  rename(score = phqtotalscore) 

# mcc2 tka

#mcc1
m2kdep_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,phqtotalscore,patient_health_questionnaire_depression_scale_phq_complete) %>% 
  filter(patient_health_questionnaire_depression_scale_phq_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-patient_health_questionnaire_depression_scale_phq_complete) %>% 
  add_column(form = "Depression") %>% 
  rename(score = phqtotalscore) 

#Catastrophizing


#mcc1
m1cat_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,pcqtotalscoreval,pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  add_column(form = "Catastrophizing") %>% 
  rename(score = pcqtotalscoreval) 

#mcc2

m2cat_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,pcqtotalscoreval,pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  add_column(form = "Catastrophizing") %>% 
  rename(score = pcqtotalscoreval) 

#mcc2 tka
m2kcat_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,pcqtotalscoreval,pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  filter(pain_catastrophizing_questionnaire_pcs6_complete  == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-pain_catastrophizing_questionnaire_pcs6_complete) %>% 
  add_column(form = "Catastrophizing") %>% 
  rename(score = pcqtotalscoreval) 

#FearMovement: total score not available for both mcc1 and mcc2

# promis sleep: total score not available for both mcc1 and mcc2

# total sleep: total score not available for both mcc1 and mcc2

# danish Danish Thoracic Surgery Questionnaire v0.2 (sub for koos) score not available for mcc2

#cognition
#mcc1
m1cog_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,miscitotalscore,multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  add_column(form = "cognition") %>% 
  rename(score = miscitotalscore) 

#mcc2

m2cog_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,miscitotalscore,multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  add_column(form = "cognition") %>% 
  rename(score = miscitotalscore)

#mcc2 tka
m2kcog_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,miscitotalscore,multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  filter(multidimensional_inventory_of_subjective_cognitive_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-multidimensional_inventory_of_subjective_cognitive_complete) %>% 
  add_column(form = "cognition") %>% 
  rename(score = miscitotalscore) 

#resilience

#mcc1
m1res_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,prscognitivescore,pain_resilience_scale_prs_complete) %>% 
  filter(pain_resilience_scale_prs_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-pain_resilience_scale_prs_complete) %>% 
  add_column(form = "resilience") %>% 
  rename(score = prscognitivescore) 

#mcc2

m2res_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,prscognitivescore,pain_resilience_scale_prs_complete) %>% 
  filter(pain_resilience_scale_prs_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-pain_resilience_scale_prs_complete) %>% 
  add_column(form = "resilience") %>% 
  rename(score = prscognitivescore)


#mcc2 tka
m2kres_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,prscognitivescore,pain_resilience_scale_prs_complete) %>% 
  filter(pain_resilience_scale_prs_complete == 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-pain_resilience_scale_prs_complete) %>% 
  add_column(form = "resilience") %>% 
  rename(score = prscognitivescore) 

# social

#mcc1
m1soc_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,essf6atotalscore,promis_sf_v20_emotional_support_6a_complete) %>% 
  filter(promis_sf_v20_emotional_support_6a_complete== 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-promis_sf_v20_emotional_support_6a_complete) %>% 
  add_column(form = "social_support") %>% 
  rename(score = essf6atotalscore) 

#mcc2

m2soc_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,essf6atotalscore,promis_sf_v20_emotional_support_6a_complete) %>% 
  filter(promis_sf_v20_emotional_support_6a_complete== 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-promis_sf_v20_emotional_support_6a_complete) %>% 
  add_column(form = "social_support") %>% 
  rename(score = essf6atotalscore) 

#mcc1
m2ksoc_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,essf6atotalscore,promis_sf_v20_emotional_support_6a_complete) %>% 
  filter(promis_sf_v20_emotional_support_6a_complete== 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-promis_sf_v20_emotional_support_6a_complete) %>% 
  add_column(form = "social_support") %>% 
  rename(score = essf6atotalscore) 

# ACE

#mcc1
m1ace_score <- data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,aceadvchlexpqstttlscore,adverse_childhood_experience_questionnaire_ace_complete) %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete== 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-adverse_childhood_experience_questionnaire_ace_complete) %>% 
  add_column(form = "ACE") %>% 
  rename(score = aceadvchlexpqstttlscore) 

#mcc2

m2ace_score <- mcc2data %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,aceadvchlexpqstttlscore,adverse_childhood_experience_questionnaire_ace_complete) %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete== 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-adverse_childhood_experience_questionnaire_ace_complete) %>% 
  add_column(form = "ACE") %>% 
  rename(score = aceadvchlexpqstttlscore) 

#mcc1
m2kace_score <- datam2k %>% 
  select(record_id,redcap_data_access_group,redcap_event_name,aceadvchlexpqstttlscore,adverse_childhood_experience_questionnaire_ace_complete) %>% 
  filter(adverse_childhood_experience_questionnaire_ace_complete== 2) %>% 
  as_tibble() %>% 
  mutate_all(as.character) %>% 
  select(-adverse_childhood_experience_questionnaire_ace_complete) %>% 
  add_column(form = "ACE") %>% 
  rename(score = aceadvchlexpqstttlscore) 

# mcc1 and mcc1 score data

# mcc1 and mcc1 score data
score_data <- rbind(m1bpi_score,m2bpi_score,
                    m1koos_score,
                    m1anxiety_score,m2anxiety_score,
                    m1dep_score,m2dep_score,
                    m1cat_score,m2cat_score,
                    m1cog_score,m2cog_score,
                    m1res_score,m2res_score,
                    m1soc_score,m2soc_score,
                    m1ace_score,m2ace_score) %>% 
  mutate(form=as.factor(form)) %>% 
  mutate(redcap_event_name=as.factor(redcap_event_name)) %>% 
  mutate(score = as.numeric(score)) %>% 
  mutate(score=round(score,0))


# score data by cohort

tka_score_data <- rbind(m1bpi_score,
                        m1koos_score,
                        m1anxiety_score,
                        m1dep_score,
                        m1cat_score,
                        m1cog_score,
                        m1res_score,
                        m1soc_score,
                        m1ace_score,
                        m2kbpi_score,
                        m2kkoos_score,
                        m2kanxiety_score,
                        m2kdep_score,
                        m2kcat_score,
                        m2kcog_score,
                        m2kres_score,
                        m2ksoc_score,
                        m2kace_score) %>% 
  add_column(cohort = "TKA")
thoracic_score_data <- rbind(m2bpi_score,
                             m2anxiety_score,
                             m2dep_score,
                             m2cat_score,
                             m2cog_score,
                             m2res_score,
                             m2soc_score,
                             m2ace_score) %>% 
  add_column(cohort = "Thoracic")

cohort_score_data <- rbind(tka_score_data,thoracic_score_data) %>% 
  mutate(form=as.factor(form)) %>% 
  mutate(cohort=as.factor(cohort)) %>%
  mutate(redcap_event_name=as.factor(redcap_event_name)) %>% 
  mutate(score = as.numeric(score)) %>% 
  mutate(score=round(score,0)) %>% 
  select(-redcap_data_access_group)





# filter trajectories from the tables that are rendered in the tabs with frequencies

ds_tbl <- ds_tbl_1 %>% 
  filter(var != "six_mo_traj") %>% 
  droplevels() #Factors in R do not automatically, using the droplevels function on the result.

##########

# create mcc2 data wide table





m2data_wide1 <- full_join(m2data_bpi,m2data.anxiety_wide,by = intersect(names(m2data_bpi), names(m2data.anxiety_wide))) 
m2data_wide2 <- full_join(m2data_wide1,m2data.dep_wide,by = intersect(names(m2data_wide1), names(m2data.dep_wide))) 
m2data_wide3 <- full_join(m2data_wide2,m2data.cat_wide,by = intersect(names(m2data_wide2), names(m2data.cat_wide)))
m2data_wide4 <- full_join(m2data_wide3,m2data.move_wide,by = intersect(names(m2data_wide3), names(m2data.move_wide))) 
m2data_wide5 <- full_join(m2data_wide4,m2data.sleep_wide,by = intersect(names(m2data_wide4), names(m2data.sleep_wide))) 
m2data_wide6 <- full_join(m2data_wide5,m2data.sleep_hours_wide,by = intersect(names(m2data_wide5), names(m2data.sleep_hours_wide))) 
m2data_wide7 <- full_join(m2data_wide6,m2data.cog_wide,by = intersect(names(m2data_wide6), names(m2data.cog_wide))) %>% 
  relocate(mb.bpi,mb.anxiety,mb.dep,mb.cat,mb.move,mb.sleep,mb.sleep_hours,mb.cog, .after = "mcc2 cognition")
m2data_wide8 <- full_join(m2data_wide7,m2data.res_wide,by = intersect(names(m2data_wide7), names(m2data.res_wide))) %>% 
  relocate(mb.bpi,mb.anxiety,mb.dep,mb.cat,mb.move,mb.sleep,mb.sleep_hours,mb.cog,mb.res, .after = "mcc2 resilience")
m2data_wide9 <- full_join(m2data_wide8,m2data.social_wide,by = intersect(names(m2data_wide8), names(m2data.social_wide))) 


m2data_wide10 <- full_join(m2data_wide9,m2data.ace_wide,by = intersect(names(m2data_wide9), names(m2data.ace_wide))) %>% 
  relocate(mb.bpi,mb.anxiety,mb.dep,mb.cat,mb.move,mb.sleep,mb.sleep_hours,mb.cog,mb.res,mb.social,mb.ace,
           .after = "mcc2 ACE")

m2data_wide11 <- full_join(m2data_wide10,m2six.mo_wide,by = intersect(names(m2data_wide10), names(m2six.mo_wide))) 

m2data_wide12 <- full_join(m2data_wide11,m2baseline_traj_wide,by = intersect(names(m2data_wide11), names(m2baseline_traj_wide))) 

m2data_wide13 <- full_join(m2data_wide12,m2data_blood_wide,by = intersect(names(m2data_wide12), names(m2data_blood_wide))) 

m2data_wide14 <- full_join(m2data_wide13,m2data_imaging_wide,by = intersect(names(m2data_wide13), names(m2data_imaging_wide))) 

m2data_wide15 <- full_join(m2data_wide14,m2data_func_wide,by = intersect(names(m2data_wide14), names(m2data_func_wide))) %>% 
  relocate(mb.bpi,mb.anxiety,mb.dep,mb.cat,mb.move,mb.sleep,mb.sleep_hours,mb.cog,mb.res,mb.social,mb.ace,mb.traj,mb.base_traj,mb.blood,mb.img,mb.func,
           .after = mcc2_Functional) %>% 
  relocate(mcc2_Functional,mcc2_Imaging,mcc2_BloodDraw,
           .after = redcap_data_access_group) 


m2data_wide16 <- full_join(m2data_wide15,appm2data_qst_wide,by = intersect(names(m2data_wide14), names(appm2data_qst_wide))) %>% 
  relocate(mb.bpi,mb.anxiety,mb.dep,mb.cat,mb.move,mb.sleep,mb.sleep_hours,mb.cog,mb.res,mb.social,mb.ace,mb.traj,mb.base_traj,mb.blood,mb.img,mb.func,mb.qst,
           .after = mcc2_QST) %>% 
  relocate(mcc2_Functional,mcc2_Imaging,mcc2_BloodDraw,mcc2_QST,
           .after = redcap_data_access_group) 


#recode data for visit not scheduled from 8 to 7 where 7 is NOT APPLICABLE
m2data_wide16 <- m2data_wide16 %>% 
  mutate(mb.ace = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ mb.ace )) %>% 
  mutate(mb.social = case_when(redcap_event_name == "6mo_postop_arm_1" & mb.social==8 | redcap_event_name == "12mo_postop_arm_1"  & mb.social==8   ~ 7,TRUE ~ mb.social )) %>% 
  mutate(mb.res = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ mb.res )) %>% 
  mutate(mb.cog = case_when( redcap_event_name == "12mo_postop_arm_1"  & mb.cog==8   ~ 7,TRUE ~ mb.cog )) %>% 
  mutate(mb.anxiety = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.anxiety==8   ~ 7,TRUE ~ mb.anxiety )) %>% 
  mutate(mb.dep = case_when(redcap_event_name == "12mo_postop_arm_1"  & mb.dep==8   ~ 7,TRUE ~ mb.dep )) %>% 
  mutate(mb.bpi=case_when(redcap_event_name == "12mo_postop_arm_1"  & mb.bpi==8   ~ 7,TRUE ~ mb.bpi )) %>% 
  mutate(mb.cat = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.cat == 8|redcap_event_name == "6mo_postop_arm_1" & mb.cat == 8 ~ 7,TRUE ~ mb.cat )) %>% 
  mutate(mb.move = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.move == 8|redcap_event_name == "6mo_postop_arm_1" & mb.move == 8 ~ 7,TRUE ~ mb.move )) %>% 
  mutate(mb.sleep = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.sleep == 8 ~ 7,TRUE ~ mb.sleep ))%>% 
  mutate(mb.sleep_hours = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.sleep_hours == 8 ~ 7,TRUE ~ mb.sleep_hours )) %>% 
  mutate(mb.traj = case_when(redcap_event_name != "6mo_postop_arm_1" ~ 7,TRUE ~ as.numeric(mb.traj) )) %>% #ghis step was already done, repeating here and reformatting to as.numeric to keep data format consistent
  mutate(mb.base_traj = case_when(redcap_event_name != "baseline_visit_arm_1" ~ 7,TRUE ~ as.numeric(mb.base_traj) )) %>% #ghis step was already done, repeating here and reformatting to as.numeric to keep data format consistent
  mutate(mb.img = case_when(redcap_event_name == "12mo_postop_arm_1" &  mb.img == 8|redcap_event_name == "6mo_postop_arm_1" & mb.img == 8|redcap_event_name == "6wks_postop_arm_1" & mb.img == 8 ~ 7,TRUE ~ mb.img )) %>% 
  mutate(mb.func = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.func == 8|redcap_event_name == "6mo_postop_arm_1" & mb.func == 8|redcap_event_name == "6wks_postop_arm_1" & mb.func == 8 ~ 7,TRUE ~ mb.func )) %>% 
  mutate(mb.blood = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.blood==8|redcap_event_name == "6mo_postop_arm_1" & mb.blood == 8 ~ 7,TRUE ~ mb.blood )) %>% 
  mutate(mb.qst = case_when(redcap_event_name == "12mo_postop_arm_1" & mb.qst==8|redcap_event_name == "6mo_postop_arm_1" & mb.qst == 8|redcap_event_name == "6wks_postop_arm_1" & mb.qst == 8 ~ 7,TRUE ~ mb.qst))








m2ds_tbl_1 <- m2data_wide16 %>% 
  select(-starts_with("mcc2")) %>% 
  rename("mcc2 BPI" = mb.bpi,"mcc2 Anxiety"= mb.anxiety,"mcc2 Depression"= mb.dep,"mcc2 Catastrophizing"= mb.cat,
         "mcc2 FearMovement"= mb.move,"mcc2 Promis_Sleep"= mb.sleep,"mcc2 sleep_hours"= mb.sleep_hours,"mcc2 cognition"= mb.cog,"mcc2 resilience"= mb.res,
         "mcc2 social_support"= mb.social, "mcc2 ACE" = mb.ace, "mcc2_six_mo_traj"=mb.traj,"mcc2_acute_traj"= mb.base_traj,"mcc2_Functional" = mb.func,"mcc2_Imaging"=mb.img,"mcc2_BloodDraw"=mb.blood,
         "mcc2_QST"=mb.qst) %>% 
  pivot_longer(cols = "mcc2 BPI" : last_col(), 
               names_to = "var",
               values_to = "data_type") %>% 
  mutate(across(everything(), as.factor)) %>% 
  mutate(data_type = factor(data_type, 
                            levels = c(0,1,2,7,8), 
                            labels = c("datacomplete_with_errors", 
                                       "datacomplete_with_no_errors", 
                                       "dataincomplete", 
                                       "dataNot_applicable", 
                                       "datanot_available")))



#pivot wider and recode NA as 9 if no visit yet and 7 if f not applicable, where 1 = complete,0 = complete with errors,2 = incomplete, 7= Not applicable, 8= Not avaialable

m2data_explore <- m2data_wide16



m2data_explore1 <-  m2data_explore%>% 
  select(-starts_with("mcc2")) %>% 
  pivot_wider(names_from = redcap_event_name , values_from = c(mb.bpi,mb.dep,mb.anxiety,mb.cat,mb.move,mb.sleep,
                                                               mb.sleep_hours,mb.cog,mb.res,mb.social,mb.ace,mb.traj,mb.base_traj,mb.blood,mb.func,mb.img,mb.qst)) %>% 
  replace_na(list(mb.bpi_baseline_visit_arm_1 = 9,mb.bpi_6wks_postop_arm_1=9,b.mb.bpi_3mo_postop_arm_1=9,mb.bpi_6mo_postop_arm_1=9,mb.bpi_12mo_postop_arm_1=7,
                  mb.anxiety_baseline_visit_arm_1 = 9,mb.anxiety_3_days_preop_arm_1=7,mb.anxiety_6wks_postop_arm_1=9,mb.anxiety_3mo_postop_arm_1=9,mb.anxiety_6mo_postop_arm_1=9,mb.anxiety_12mo_postop_arm_1=7,
                  mb.dep_baseline_visit_arm_1 = 9,mb.dep_3_days_preop_arm_1=7,mb.dep_6wks_postop_arm_1=9,mb.dep_3mo_postop_arm_1=9,mb.dep_6mo_postop_arm_1=9,mb.dep_12mo_postop_arm_1=7,
                  mb.cat_baseline_visit_arm_1 = 9,mb.cat_3_days_preop_arm_1=7,mb.cat_6wks_postop_arm_1=9,mb.cat_3mo_postop_arm_1=9,mb.cat_6mo_postop_arm_1=7,mb.cat_12mo_postop_arm_1=7,
                  mb.move_baseline_visit_arm_1 = 9,mb.move_3_days_preop_arm_1=7,mb.move_6wks_postop_arm_1=9,mb.move_3mo_postop_arm_1=9,mb.move_6mo_postop_arm_1=7,mb.move_12mo_postop_arm_1=7,
                  mb.sleep_baseline_visit_arm_1 = 9,mb.sleep_3_days_preop_arm_1=7,mb.sleep_6wks_postop_arm_1=9,mb.sleep_3mo_postop_arm_1=9,mb.sleep_6mo_postop_arm_1=9,mb.sleep_12mo_postop_arm_1=7,
                  mb.sleep_hours_baseline_visit_arm_1 = 9,mb.sleep_hours_3_days_preop_arm_1=7,mb.sleep_hours_6wks_postop_arm_1=9,mb.sleep_hours_3mo_postop_arm_1=9,mb.sleep_hours_6mo_postop_arm_1=9,mb.sleep_hours_12mo_postop_arm_1=7,
                  mb.cog_baseline_visit_arm_1 = 9,mb.cog_3_days_preop_arm_1=7,mb.cog_6wks_postop_arm_1=9,mb.cog_3mo_postop_arm_1=9,mb.cog_6mo_postop_arm_1=9,mb.cog_12mo_postop_arm_1=7,
                  mb.social_baseline_visit_arm_1 = 9,mb.social_3_days_preop_arm_1=7,mb.social_6wks_postop_arm_1=9,mb.social_3mo_postop_arm_1=9,mb.social_6mo_postop_arm_1=7,mb.social_12mo_postop_arm_1=7,
                  mb.res_baseline_visit_arm_1 = 9,mb.res_3_days_preop_arm_1=7,mb.res_6wks_postop_arm_1=7,mb.res_3mo_postop_arm_1=7,mb.res_6mo_postop_arm_1=7,mb.res_12mo_postop_arm_1=7,
                  mb.ace_baseline_visit_arm_1 = 9,mb.ace_3_days_preop_arm_1=7,mb.ace_6wks_postop_arm_1=7,mb.ace_3mo_postop_arm_1=7,mb.ace_6mo_postop_arm_1=7,mb.ace_12mo_postop_arm_1=7,
                  mb.traj_baseline_visit_arm_1 = 7,mb.traj_3_days_preop_arm_1=7,mb.traj_6wks_postop_arm_1=7,mb.traj_3mo_postop_arm_1=7,mb.traj_6mo_postop_arm_1=9,mb.traj_12mo_postop_arm_1=7,
                  mb.base_traj_baseline_visit_arm_1 = 9,mb.base_traj_3_days_preop_arm_1=7,mb.base_traj_6wks_postop_arm_1=7,mb.base_traj_3mo_postop_arm_1=7,mb.base_traj_6mo_postop_arm_1=7,mb.base_traj_12mo_postop_arm_1=7,
                  mb.func_baseline_visit_arm_1 = 9,mb.func_3_days_preop_arm_1=7,mb.func_6wks_postop_arm_1=7,mb.func_3mo_postop_arm_1=9,mb.func_6mo_postop_arm_1=7,mb.func_12mo_postop_arm_1=7,
                  mb.img_baseline_visit_arm_1 = 9,mb.img_3_days_preop_arm_1=7,mb.img_6wks_postop_arm_1=7,mb.img_3mo_postop_arm_1=9,mb.img_6mo_postop_arm_1=7,mb.img_12mo_postop_arm_1=7,
                  mb.blood_baseline_visit_arm_1 = 9,mb.blood_3_days_preop_arm_1=7,mb.blood_6wks_postop_arm_1=9,mb.blood_3mo_postop_arm_1=9,mb.blood_6mo_postop_arm_1=7,mb.blood_12mo_postop_arm_1=7,
                  mb.qst_baseline_visit_arm_1 = 9,mb.qst_3_days_preop_arm_1=7,mb.qst_6wks_postop_arm_1=7,mb.qst_3mo_postop_arm_1=9,mb.qst_6mo_postop_arm_1=7,mb.qst_12mo_postop_arm_1=7))


#filter complete records

m2data_complete<- m2data_explore1 %>%
  filter(mb.bpi_baseline_visit_arm_1 == 1&mb.bpi_6wks_postop_arm_1==1 & mb.bpi_3mo_postop_arm_1==1 & mb.bpi_6mo_postop_arm_1==1 & mb.bpi_12mo_postop_arm_1==7 &
           mb.anxiety_baseline_visit_arm_1 == 1  &mb.anxiety_6wks_postop_arm_1==1 & mb.anxiety_3mo_postop_arm_1==1 &mb.anxiety_6mo_postop_arm_1==1 &mb.anxiety_12mo_postop_arm_1==7 &
           mb.dep_baseline_visit_arm_1 == 1  &mb.dep_6wks_postop_arm_1==1 & mb.dep_3mo_postop_arm_1==1 &mb.dep_6mo_postop_arm_1==1 &mb.dep_12mo_postop_arm_1==7 &
           mb.cat_baseline_visit_arm_1 == 1  &mb.cat_6wks_postop_arm_1==1 & mb.cat_3mo_postop_arm_1==1 & mb.cat_6mo_postop_arm_1==7 & mb.cat_12mo_postop_arm_1==7 &
           mb.move_baseline_visit_arm_1 == 1  &mb.move_6wks_postop_arm_1==1 & mb.move_3mo_postop_arm_1==1 & mb.move_6mo_postop_arm_1==7 & mb.move_12mo_postop_arm_1==7 &
           mb.sleep_baseline_visit_arm_1 == 1  &mb.sleep_6wks_postop_arm_1==1 & mb.sleep_3mo_postop_arm_1==1 & mb.sleep_6mo_postop_arm_1==1 & mb.sleep_12mo_postop_arm_1==7 &
           mb.sleep_hours_baseline_visit_arm_1 == 1  &mb.sleep_hours_6wks_postop_arm_1==1 & mb.sleep_hours_3mo_postop_arm_1==1 & mb.sleep_hours_6mo_postop_arm_1==1 & mb.sleep_hours_12mo_postop_arm_1==7 &
           mb.cog_baseline_visit_arm_1 == 1&mb.cog_6wks_postop_arm_1==1& mb.cog_3mo_postop_arm_1==1& mb.cog_6mo_postop_arm_1==1& mb.cog_12mo_postop_arm_1==7&
           mb.social_baseline_visit_arm_1 == 1&mb.social_6wks_postop_arm_1==1 & mb.social_3mo_postop_arm_1==1& mb.social_6mo_postop_arm_1==7& mb.social_12mo_postop_arm_1==7&
           mb.res_baseline_visit_arm_1 == 1&mb.res_6wks_postop_arm_1==7& mb.res_3mo_postop_arm_1==7& mb.res_6mo_postop_arm_1==7& mb.res_12mo_postop_arm_1==7&
           mb.ace_baseline_visit_arm_1 == 1& mb.ace_6wks_postop_arm_1==7& mb.ace_3mo_postop_arm_1==7& mb.ace_6mo_postop_arm_1==7& mb.ace_12mo_postop_arm_1==7&
           mb.traj_baseline_visit_arm_1 == 7&mb.traj_6wks_postop_arm_1==7&mb.traj_3mo_postop_arm_1==7&mb.traj_6mo_postop_arm_1==1&mb.traj_12mo_postop_arm_1==7 &
           mb.base_traj_baseline_visit_arm_1 == 1 & mb.base_traj_6wks_postop_arm_1==7 & mb.base_traj_3mo_postop_arm_1==7&
           mb.base_traj_6mo_postop_arm_1==7&mb.base_traj_12mo_postop_arm_1==7 &
           mb.func_baseline_visit_arm_1 == 1 &mb.func_6wks_postop_arm_1==7 &mb.func_3mo_postop_arm_1==1 &mb.func_6mo_postop_arm_1==7 &mb.func_12mo_postop_arm_1==7 &
           mb.img_baseline_visit_arm_1 == 1  &mb.img_6wks_postop_arm_1==7 &mb.img_3mo_postop_arm_1==1 &mb.img_6mo_postop_arm_1==7 &mb.img_12mo_postop_arm_1==7 &
           mb.blood_baseline_visit_arm_1 == 1  &mb.blood_6wks_postop_arm_1==1 &mb.blood_3mo_postop_arm_1==1 &mb.blood_6mo_postop_arm_1==7 &mb.blood_12mo_postop_arm_1==7 &
           mb.qst_baseline_visit_arm_1 == 1  & mb.qst_6wks_postop_arm_1==7 & mb.qst_3mo_postop_arm_1==1 & mb.qst_6mo_postop_arm_1==7 & mb.qst_12mo_postop_arm_1==7 )


#same code as above with complete records and records with errors as well
m2data_complete_errors <- m2data_explore1 %>% 
  filter(
    (mb.bpi_baseline_visit_arm_1 == 1 |mb.bpi_baseline_visit_arm_1 == 0) &(mb.bpi_6wks_postop_arm_1==1 | mb.bpi_6wks_postop_arm_1==0) &(mb.bpi_3mo_postop_arm_1==1 | mb.bpi_3mo_postop_arm_1==0) &
      (mb.bpi_6mo_postop_arm_1==1 | mb.bpi_6mo_postop_arm_1==0) & mb.bpi_12mo_postop_arm_1==7 &
      (mb.anxiety_baseline_visit_arm_1 == 1 | mb.anxiety_baseline_visit_arm_1 == 0)  & (mb.anxiety_6wks_postop_arm_1==1|mb.anxiety_6wks_postop_arm_1==0) &(mb.anxiety_3mo_postop_arm_1==1|
                                                                                                                                                             mb.anxiety_3mo_postop_arm_1==0) & (mb.anxiety_6mo_postop_arm_1==1|mb.anxiety_6mo_postop_arm_1==0) &mb.anxiety_12mo_postop_arm_1==7 &
      (mb.dep_baseline_visit_arm_1 == 1|mb.dep_baseline_visit_arm_1 == 0)  &(mb.dep_6wks_postop_arm_1==1|mb.dep_6wks_postop_arm_1==0) &(mb.dep_3mo_postop_arm_1==1|mb.dep_3mo_postop_arm_1==0)
    & (mb.dep_6mo_postop_arm_1==1|mb.dep_6mo_postop_arm_1==0) &mb.dep_12mo_postop_arm_1==7 &
      (mb.cat_baseline_visit_arm_1 == 1|mb.cat_baseline_visit_arm_1 == 0)  & (mb.cat_6wks_postop_arm_1==1|mb.cat_6wks_postop_arm_1==0) & (mb.cat_3mo_postop_arm_1==1|mb.cat_3mo_postop_arm_1==0)
    &mb.cat_6mo_postop_arm_1==7 &mb.cat_12mo_postop_arm_1==7 &
      (mb.move_baseline_visit_arm_1 == 1| mb.move_baseline_visit_arm_1 == 0)  & (mb.move_6wks_postop_arm_1==1|mb.move_6wks_postop_arm_1==0) &(mb.move_3mo_postop_arm_1==1|mb.move_3mo_postop_arm_1==0)
    &mb.move_6mo_postop_arm_1==7 &mb.move_12mo_postop_arm_1==7 &
      (mb.sleep_baseline_visit_arm_1 == 1|mb.sleep_baseline_visit_arm_1 == 0)  &(mb.sleep_6wks_postop_arm_1==1|mb.sleep_6wks_postop_arm_1==0) &(mb.sleep_3mo_postop_arm_1==1|mb.sleep_3mo_postop_arm_1==0)
    & (mb.sleep_6mo_postop_arm_1==1|mb.sleep_6mo_postop_arm_1==0) &mb.sleep_12mo_postop_arm_1==7 &
      (mb.sleep_hours_baseline_visit_arm_1 == 1|mb.sleep_hours_baseline_visit_arm_1 == 0)  &(mb.sleep_hours_6wks_postop_arm_1==1|mb.sleep_hours_6wks_postop_arm_1==0) &(mb.sleep_hours_3mo_postop_arm_1==1|
                                                                                                                                                                          mb.sleep_hours_3mo_postop_arm_1==0) & (mb.sleep_hours_6mo_postop_arm_1==1|mb.sleep_hours_6mo_postop_arm_1==0) &mb.sleep_hours_12mo_postop_arm_1==7  &
      (mb.cog_baseline_visit_arm_1 == 1|mb.cog_baseline_visit_arm_1 == 0)  &(mb.cog_6wks_postop_arm_1==1|mb.cog_6wks_postop_arm_1==0) &(mb.cog_3mo_postop_arm_1==1|mb.cog_3mo_postop_arm_1==0)
    & (mb.cog_6mo_postop_arm_1==1|mb.cog_6mo_postop_arm_1==0) &mb.cog_12mo_postop_arm_1==7 &
      (mb.social_baseline_visit_arm_1 == 1|mb.social_baseline_visit_arm_1 == 0)  &(mb.social_6wks_postop_arm_1==1|mb.social_6wks_postop_arm_1==0) &(mb.social_3mo_postop_arm_1==1|mb.social_3mo_postop_arm_1==0)
    & mb.social_6mo_postop_arm_1== 7 &mb.social_12mo_postop_arm_1==7 &
      (mb.res_baseline_visit_arm_1 == 1|mb.res_baseline_visit_arm_1 == 0)  & mb.res_6wks_postop_arm_1==7 & mb.res_3mo_postop_arm_1==7 & 
      mb.res_6mo_postop_arm_1==7 & mb.res_12mo_postop_arm_1==7 &
      (mb.ace_baseline_visit_arm_1 == 1|mb.ace_baseline_visit_arm_1 == 0)  & mb.ace_6wks_postop_arm_1==7 & mb.ace_3mo_postop_arm_1==7 & 
      mb.ace_6mo_postop_arm_1==7 & mb.ace_12mo_postop_arm_1==7  &
      mb.traj_baseline_visit_arm_1 == 7&mb.traj_6wks_postop_arm_1==7&mb.traj_3mo_postop_arm_1==7&mb.traj_6mo_postop_arm_1==1&mb.traj_12mo_postop_arm_1==7 &
      mb.base_traj_baseline_visit_arm_1 == 1 & mb.base_traj_6wks_postop_arm_1==7 & mb.base_traj_3mo_postop_arm_1==7&
      mb.base_traj_6mo_postop_arm_1==7&mb.base_traj_12mo_postop_arm_1==7 &
      (mb.func_baseline_visit_arm_1 == 1|mb.func_baseline_visit_arm_1 == 0)  &mb.func_6wks_postop_arm_1==7 &(mb.func_3mo_postop_arm_1==1|mb.func_3mo_postop_arm_1==0) &mb.func_6mo_postop_arm_1==7 &mb.func_12mo_postop_arm_1==7 &
      (mb.img_baseline_visit_arm_1 == 1|mb.img_baseline_visit_arm_1 == 0)  &mb.img_6wks_postop_arm_1==7 &(mb.img_3mo_postop_arm_1==1|mb.img_3mo_postop_arm_1==0) &mb.img_6mo_postop_arm_1==7 &mb.img_12mo_postop_arm_1==7 &
      (mb.blood_baseline_visit_arm_1 == 1|mb.blood_baseline_visit_arm_1 == 0) &(mb.blood_6wks_postop_arm_1==1|mb.blood_6wks_postop_arm_1==0) & (mb.blood_3mo_postop_arm_1==1|mb.blood_3mo_postop_arm_1==0)
    & mb.blood_6mo_postop_arm_1==7 &mb.blood_12mo_postop_arm_1==7&  
      (mb.qst_baseline_visit_arm_1 == 1|mb.qst_baseline_visit_arm_1 == 0)  &mb.qst_6wks_postop_arm_1==7 
    & (mb.qst_3mo_postop_arm_1==1|mb.qst_3mo_postop_arm_1==0)  &mb.qst_12mo_postop_arm_1==7 )


#idenitify IDs with complete data

m2data_complet1 <- m2data_complete %>% 
  select(record_id,redcap_data_access_group)


#merge ids with data_explore, create error free dataset

m2comp_tbl <- right_join(m2data_explore,m2data_complet1,by = c("record_id","redcap_data_access_group")) %>% 
  add_column(status = "error free streak")


#idenitify IDs in  with errors

m2data_errrorcomplet1 <- m2data_complete_errors %>% 
  select(record_id,redcap_data_access_group)


#merge ids with data_explore to create a dataset of ids with errors and id with no errors

m2comp_error_tbl1 <- right_join(m2data_explore,m2data_errrorcomplet1,by = c("record_id","redcap_data_access_group"))

#isolate records with errors by anti join 

m2comp_error_tbl <- anti_join(m2comp_error_tbl1,m2comp_tbl,by = c("record_id","redcap_data_access_group"))  %>% 
  add_column(status = "streak with errors")


# combine comp_erro_tbl and comp_tbl


m2temp_table <- rbind(m2comp_tbl,m2comp_error_tbl)


#extract ids not in temp_table and then add  to temp table vertically

m2other_tbl <- anti_join(m2data_explore,m2temp_table,by = c("record_id","redcap_data_access_group"))  %>% 
  add_column(status = "incomplete streak")



# for datatable
m2new_tbl <- rbind(m2temp_table,m2other_tbl) %>% 
  mutate(across(everything(), as.factor)) 





# create a dataset for complete records to download for the user

# reformat both datasets for merging

m2data_original <- mcc2data
m2data_original[] <- lapply(m2data_original, as.character)
m2comp_tbl[] <- lapply(m2comp_tbl, as.character)


m2comp_dta_tbl <- inner_join(m2data_original,m2comp_tbl,by = intersect(names(m2data_original), names(m2comp_tbl)))




# create a dataset of IDs with complete baseline biomarker data plus 6 months outcome

m2data_biomarker <-  m2data_explore1 %>% 
  filter(mb.bpi_baseline_visit_arm_1 == 1 &
           mb.anxiety_baseline_visit_arm_1 == 1 &
           mb.dep_baseline_visit_arm_1 == 1  &
           mb.cat_baseline_visit_arm_1 == 1  &
           mb.move_baseline_visit_arm_1 == 1  &
           mb.sleep_baseline_visit_arm_1 == 1  &
           mb.sleep_hours_baseline_visit_arm_1 == 1  &
           mb.cog_baseline_visit_arm_1 == 1&
           mb.social_baseline_visit_arm_1 == 1&
           mb.res_baseline_visit_arm_1 == 1&
           mb.ace_baseline_visit_arm_1 == 1 &
           mb.func_baseline_visit_arm_1 == 1  &
           mb.img_baseline_visit_arm_1 == 1  &
           mb.blood_baseline_visit_arm_1 == 1 &
           mb.qst_baseline_visit_arm_1 == 1  &
           mb.traj_baseline_visit_arm_1 == 7&mb.traj_6wks_postop_arm_1==7&mb.traj_3mo_postop_arm_1==7&mb.traj_6mo_postop_arm_1==1&mb.traj_12mo_postop_arm_1==7&
           mb.base_traj_baseline_visit_arm_1 == 1 & mb.base_traj_6wks_postop_arm_1==7 & mb.base_traj_3mo_postop_arm_1==7&
           mb.base_traj_6mo_postop_arm_1==7&mb.base_traj_12mo_postop_arm_1==7) %>% 
  select(record_id,redcap_data_access_group) 


#merge ids with data_explore, create error free dataset with error free baseline surverys and error free 6 months outcome

m2comp_tbl_biomarker <- right_join(m2data_explore,m2data_biomarker,by = c("record_id","redcap_data_access_group")) %>% 
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  mutate(mcc2_six_mo_traj = ifelse(mcc2_six_mo_traj == 7, 1,7)) %>% 
  mutate(mb.traj = ifelse(mb.traj == 7, 1,7)) %>% 
  add_column(status = "complete without errors") %>% 
  select(-redcap_event_name) %>% 
  mutate(redcap_data_access_group = as.factor(redcap_data_access_group)) %>% 
  mutate(status = as.factor(status))




# create a dataset of IDs with complete or with error baseline biomarker data plus 6 months outcome

m2data_biomarker_errors <-  m2data_explore1 %>% 
  filter((mb.bpi_baseline_visit_arm_1 == 1 |mb.bpi_baseline_visit_arm_1 == 0) &
           (mb.anxiety_baseline_visit_arm_1 == 1 | mb.anxiety_baseline_visit_arm_1 == 0)   &
           (mb.func_baseline_visit_arm_1 == 1|mb.func_baseline_visit_arm_1 == 0)  &
           (mb.img_baseline_visit_arm_1 == 1|mb.img_baseline_visit_arm_1 == 0) & 
           (mb.blood_baseline_visit_arm_1 == 1|mb.blood_baseline_visit_arm_1 == 0) &
           (mb.dep_baseline_visit_arm_1 == 1|mb.dep_baseline_visit_arm_1 == 0) &
           (mb.cat_baseline_visit_arm_1 == 1|mb.cat_baseline_visit_arm_1 == 0)  & 
           (mb.move_baseline_visit_arm_1 == 1| mb.move_baseline_visit_arm_1 == 0)  &
           (mb.sleep_baseline_visit_arm_1 == 1|mb.sleep_baseline_visit_arm_1 == 0)  &
           (mb.sleep_hours_baseline_visit_arm_1 == 1|mb.sleep_hours_baseline_visit_arm_1 == 0)  &
           (mb.social_baseline_visit_arm_1 == 1|mb.social_baseline_visit_arm_1 == 0) &
           (mb.cog_baseline_visit_arm_1 == 1|mb.cog_baseline_visit_arm_1 == 0)  & 
           (mb.res_baseline_visit_arm_1 == 1|mb.res_baseline_visit_arm_1 == 0)  & 
           (mb.ace_baseline_visit_arm_1 == 1|mb.ace_baseline_visit_arm_1 == 0) & 
           (mb.qst_baseline_visit_arm_1 == 1|mb.qst_baseline_visit_arm_1 == 0)  & 
           (mb.traj_baseline_visit_arm_1 == 7&mb.traj_6wks_postop_arm_1==7&mb.traj_3mo_postop_arm_1==7&mb.traj_6mo_postop_arm_1==1&mb.traj_12mo_postop_arm_1==7)&
           (mb.base_traj_baseline_visit_arm_1 == 1 & mb.base_traj_6wks_postop_arm_1==7 & mb.base_traj_3mo_postop_arm_1==7&
              mb.base_traj_6mo_postop_arm_1==7&mb.base_traj_12mo_postop_arm_1==7)) %>% 
  select(record_id,redcap_data_access_group) 





#merge ids with data_explore, create error free dataset with error free baseline surverys and error free 6 months outcome

m2comp_tbl_biomarker_errors <- right_join(m2data_explore,m2data_biomarker_errors,by = c("record_id","redcap_data_access_group")) %>% 
  filter(redcap_event_name == "baseline_visit_arm_1") %>% 
  mutate(mcc2_six_mo_traj = ifelse(mcc2_six_mo_traj == 7, 1,7)) %>% 
  mutate(mb.traj = ifelse(mb.traj == 7, 1,7)) %>% 
  add_column(status = "complete with and without errors") %>% 
  select(-redcap_event_name)

# creat a final table of data with baseline biomarker + 6 m traj with and without errors


m2all_tbl_biomarker <- rbind(m2comp_tbl_biomarker,m2comp_tbl_biomarker_errors) 


# create a table for upset plots with either date with or without error 1/0 and baseline and 6 months data


# create a dataset of IDs with complete or with error baseline biomarker data plus 6 months outcome for upset plots

m2_biomarker_upset <-  m2data_explore1 %>% 
  filter((mb.bpi_baseline_visit_arm_1 == 1 |mb.bpi_baseline_visit_arm_1 == 0) &
           (mb.anxiety_baseline_visit_arm_1 == 1 | mb.anxiety_baseline_visit_arm_1 == 0)   &
           (mb.dep_baseline_visit_arm_1 == 1|mb.dep_baseline_visit_arm_1 == 0) &
           (mb.cat_baseline_visit_arm_1 == 1|mb.cat_baseline_visit_arm_1 == 0)  & 
           (mb.move_baseline_visit_arm_1 == 1| mb.move_baseline_visit_arm_1 == 0)  &
           (mb.sleep_baseline_visit_arm_1 == 1|mb.sleep_baseline_visit_arm_1 == 0)  &
           (mb.sleep_hours_baseline_visit_arm_1 == 1|mb.sleep_hours_baseline_visit_arm_1 == 0)  &
           (mb.func_baseline_visit_arm_1 == 1|mb.func_baseline_visit_arm_1 == 0)  &
           (mb.img_baseline_visit_arm_1 == 1|mb.img_baseline_visit_arm_1 == 0) & 
           (mb.blood_baseline_visit_arm_1 == 1|mb.blood_baseline_visit_arm_1 == 0) &
           (mb.qst_baseline_visit_arm_1 == 1|mb.qst_baseline_visit_arm_1 == 0)  & 
           (mb.social_baseline_visit_arm_1 == 1|mb.social_baseline_visit_arm_1 == 0) &
           (mb.cog_baseline_visit_arm_1 == 1|mb.cog_baseline_visit_arm_1 == 0)  & 
           (mb.res_baseline_visit_arm_1 == 1|mb.res_baseline_visit_arm_1 == 0)  & 
           (mb.ace_baseline_visit_arm_1 == 1|mb.ace_baseline_visit_arm_1 == 0)) %>% 
  select(record_id,redcap_data_access_group,ends_with("baseline_visit_arm_1"),mb.traj_6mo_postop_arm_1,-mb.traj_baseline_visit_arm_1) %>% 
  mutate_at(vars(-c(1:2)), ~ifelse(. != 1, 0, .)) %>% 
  rename("BPI"="mb.bpi_baseline_visit_arm_1","Depression"="mb.dep_baseline_visit_arm_1" ,"Anxiety"= "mb.anxiety_baseline_visit_arm_1" ,"Catastophizing"="mb.cat_baseline_visit_arm_1",       
         "FearMovement"="mb.move_baseline_visit_arm_1" ,"Sleep"= "mb.sleep_baseline_visit_arm_1" , "Sleep_hours"="mb.sleep_hours_baseline_visit_arm_1","Funtional"="mb.func_baseline_visit_arm_1","Blood_Draw"="mb.blood_baseline_visit_arm_1",      
         "Imaging"="mb.img_baseline_visit_arm_1"  ,"QST"= "mb.qst_baseline_visit_arm_1"  ,"Cognition" ="mb.cog_baseline_visit_arm_1" ,"Resilience"="mb.res_baseline_visit_arm_1" ,"Social_Support" ="mb.social_baseline_visit_arm_1" ,   
         "ACE"="mb.ace_baseline_visit_arm_1"  , "Baseline_Traj" ="mb.base_traj_baseline_visit_arm_1","6_months_Traj"="mb.traj_6mo_postop_arm_1")

# data wrangling for upset plots
# create an m1 days from sysdate dataframe, with <= 35 days from baseline visit only
m2days_from_sysdate_35baseline <- m2days_from_sysdate %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" & days_from_today >= -35) %>% 
  filter(!record_id %in% result_withdraw)

#create an appendix dataframe for upset plot <= 35days
m2_biomarker_35upset_df <-m2_biomarker_upset%>% 
  right_join(.,m2days_from_sysdate_35baseline, by= "record_id") %>% 
  select(-"6_months_Traj",-last_seen) %>%
  add_column(cohort = "MCC2_Thoracic") %>% 
  as.data.frame() 

#create a dataframe for upset plot, <= 35 days

m2_biomarker_35upsetplot <- m2_biomarker_upset %>% 
  right_join(.,m2days_from_sysdate_35baseline, by= "record_id") %>% 
  select(-"6_months_Traj",-record_id,-redcap_event_name,- redcap_data_access_group,-days_from_today,-last_seen)

m2_biomarker_35upsetplot<-m2_biomarker_35upsetplot%>%
  filter(rowSums(is.na(m2_biomarker_35upsetplot)) != ncol(m2_biomarker_35upsetplot)) %>% 
  as.data.frame()

# create an m2 days from sysdate dataframe, with ~7 months from baseline visit only
m2days_from_sysdate_7mobaseline <- m2days_from_sysdate %>% 
  filter(redcap_event_name == "baseline_visit_arm_1" & days_from_today <= -220) %>% 
  filter(!record_id %in% result_withdraw)

#create an appendix dataframe for upset plot ~ 7 months from baseline visit
m2_biomarker_7moupset_df <-m2_biomarker_upset%>% 
  right_join(.,m2days_from_sysdate_7mobaseline, by= "record_id") %>% 
  select(-last_seen) %>%
  add_column(cohort = "MCC2_Thoracic") %>% 
  as.data.frame()

#create a dataframe for upset plot,  ~ 7 months from baseline

m2_biomarker_7moupsetplot <- m2_biomarker_upset %>% 
  right_join(.,m2days_from_sysdate_7mobaseline, by= "record_id") %>% 
  select(-record_id,-redcap_event_name,- redcap_data_access_group,-days_from_today,-last_seen)

m2_biomarker_7moupsetplot<- m2_biomarker_7moupsetplot %>%
  filter(rowSums(is.na(m2_biomarker_7moupsetplot)) != ncol(m2_biomarker_7moupsetplot)) %>% 
  as.data.frame()





# this table is specifically for the first tab, this is different than the above table, the difference is that the Vars do not have mcc2 as a prefix.
m2ds_tbl_2 <- m2data_wide16 %>% 
  select(-starts_with("mcc2")) %>% 
  rename("BPI" = mb.bpi,"Anxiety"= mb.anxiety,"Depression"= mb.dep,"Catastrophizing"= mb.cat,
         "FearMovement"= mb.move,"Promis_Sleep"= mb.sleep,"sleep_hours"= mb.sleep_hours,"cognition"= mb.cog,"resilience"= mb.res,
         "social_support"= mb.social, "ACE" = mb.ace,"Functional" = mb.func,"Imaging"=mb.img,"BloodDraw"=mb.blood,"QST"=mb.qst ) %>% 
  pivot_longer(cols = "BPI" : last_col(), 
               names_to = "var",
               values_to = "data_type") %>% 
  mutate(across(everything(), as.factor)) %>% 
  mutate(data_type = factor(data_type, 
                            levels = c(0,1,2,7,8), 
                            labels = c("datacomplete_with_errors", 
                                       "datacomplete_with_no_errors", 
                                       "dataincomplete", 
                                       "dataNot_applicable", 
                                       "datanot_available")))






# merging mcc1 and mcc2 ds_tbl for the first tab, the mcc2 ds_tbl is m2ds_tbl_2  which does not have mcc2 before values the in column var
m1m2ds_tbl <- rbind(ds_tbl_1,m2ds_tbl_2) %>% 
  as_tibble() %>% 
  mutate_all(as.factor) %>% 
  filter(var != "six_mo_traj") %>% 
  filter(var != "acute_traj") %>% 
  filter(var != "mb.traj") %>% 
  filter(var != "mb.base_traj") %>% 
  droplevels() 



## create mcc1 mcc2 table for the plots by DAGs tab

m1m2_plots <- m1m2ds_tbl%>% 
  as_tibble() %>% 
  mutate_all(as.factor) %>% 
  filter(var != "six_mo_traj") %>% 
  filter(var != "acute_traj") %>% 
  filter(var != "mb.traj") %>% 
  filter(var != "mb.base_traj") %>% 
  droplevels() 


custom_render <- c(
  "function(data, type, row, meta) {",
  "  if (type === 'display' && data.length > 4) {",
  "    data = '<span title=' + data + ' onclick=window.alert(\"' + data + '\")>' + data + '</span>';",
  "  }",
  "  return data;",
  "}"
)





# Define UI 
ui <- navbarPage(theme = shinytheme("superhero"),title = "A2CPS: Data Monitoring WebApp",
                 
                 
                 tabPanel(title = "Explore", 
                          
                          # Sidebar with a slider input for number of bins 
                          sidebarLayout(
                            sidebarPanel(
                              selectInput(inputId = "inputVAR", 
                                          label = "select CRF/Survey:",
                                          choices = levels(m1m2ds_tbl$var),
                                          selected = "Imaging",multiple = FALSE),
                              
                              selectInput(inputId = "inputTime", 
                                          label = "select event:",
                                          choices = levels(m1m2ds_tbl$redcap_event_name),
                                          selected = "baseline_visit_arm_1", multiple = TRUE),
                              
                              selectInput(inputId = "inputLocation", 
                                          label = "select DAG:",
                                          choices = levels(m1m2ds_tbl$redcap_data_access_group), 
                                          selected = "rush_university_me", multiple = TRUE),
                              
                              img(src = "A2cps.png", height = 100, width = 250),
                              
                              h5("Once the forms are filled, they are marked either as complete, incomplete or blank (NA). Completed forms were checked for errors which resulted in 4 datatypes: 1. complete forms without errors, 2. complete forms with errors
          3. Incomplete forms and 4. Forms with blank status(NA). The frequencies are calculated as follows: type of completion status/complete+complete with errors + incomplete 
             + NA. Not applicable such as 6 weeks visit for imaging was excluded from calculation. If certain data does not exist for example if there is no incomplete data, then the  quadrant for incomplete forms will not display")
                              
                            ),
                            
                            
                            
                            
                            # Show a plot of the generated distribution
                            mainPanel(
                              tags$style(type="text/css", # Sanitize the output so that it is not rendered instead of showing warnings/errors
                                         ".shiny-output-error { visibility: hidden; }",
                                         ".shiny-output-error:before { visibility: hidden; }"),
                              tabsetPanel(
                                tabPanel("Plots by levels of data completion", 
                                         splitLayout(style = "border: 1px solid silver;",cellWidths = c("50%", "50%"),
                                                     plotlyOutput("plot_complete"),
                                                     plotlyOutput("plot_errors")),
                                         splitLayout(style = "border: 2px solid silver;",cellWidths = c("50%", "50%"),
                                                     plotlyOutput("plot_incomplete"),
                                                     plotlyOutput("plot_notavailable"))), 
                                
                                tabPanel("Schedule of Activities by visit", imageOutput("extra"))
                              )
                            )
                          )
                 ),
                 tabPanel(title = "MCC1: Data", 
                          sidebarLayout(
                            sidebarPanel(
                              
                              
                              selectInput(inputId = "iLocation_newtbl", 
                                          label = "select DAG:",
                                          choices = levels(new_tbl$redcap_data_access_group)),
                              
                              selectInput(inputId = "istatus_newtbl", 
                                          label = "select streak status:",
                                          choices = levels(new_tbl$status),
                                          selected = "error free streak", multiple = TRUE),
                              
                              
                              img(src = "legend.png", height = 125, width = 265)
                              
                            ),
                            mainPanel(
                              downloadButton('downloadData', 'Download 6 months complete data'),
                              tabsetPanel(
                                tabPanel("Data", DTOutput(outputId = "new_tbl")) ,
                                tabPanel("Schedule of Activities by visit",imageOutput("extra1"))
                              )
                            )
                          )),
                 
                 tabPanel(title = "MCC2: Data", 
                          sidebarLayout(
                            sidebarPanel(
                              
                              
                              selectInput(inputId = "iLocation_m2newtbl", 
                                          label = "select DAG:",
                                          choices = levels(m2new_tbl$redcap_data_access_group),
                                          selected = "university_of_mich",multiple = TRUE),
                              
                              selectInput(inputId = "istatus_m2newtbl", 
                                          label = "select streak status:",
                                          choices = levels(m2new_tbl$status),
                                          selected = "error free streak", multiple = TRUE),
                              
                              
                              img(src = "legend.png", height = 125, width = 265)
                              
                            ),
                            mainPanel(
                              "Mcc2 Data", 
                              DTOutput(outputId = "m2new_tbl")
                              
                            )
                          )
                 ),
                 
                 tabPanel(
                   title = "UpSet plots for Biomarkers",
                   fluidRow(
                     column(width = 6,offset = 0,textOutput("text30m1"),
                            plotOutput("plot30m1")
                            
                     ),
                     column(width = 6,offset = 0,textOutput("text7m1"),
                            plotOutput("plot7m1")
                            
                     )
                   ),
                   fluidRow(
                     column(width = 6,offset = 0,textOutput("text30m2"),
                            plotOutput("plot30m2")
                            
                     ),
                     column(width = 6,offset = 0,textOutput("text7m2"),
                            plotOutput("plot7m2")
                            
                     )
                   ),
                   fluidRow(
                     column(width = 6,offset = 0,textOutput("text30m2k"),
                            plotOutput("plot30m2k")
                            
                     ),
                     column(width = 6,offset = 0,textOutput("text7m2k"),
                            plotOutput("plot7m2k")
                            
                     )
                   )
                 ),
                 
                 
                 tabPanel(title = "Biomarker score distribution by surgical cohort", 
                          sidebarLayout(
                            sidebarPanel(
                              
                              
                              selectInput(inputId = "cohort_form", 
                                          label = "select form:",
                                          choices = levels(cohort_score_data$form),
                                          selected = "BPI",multiple = FALSE),
                              
                              selectInput(inputId = "cohort_time", 
                                          label = "select Redcap event:",
                                          choices = levels(cohort_score_data$redcap_event_name),
                                          selected = "baseline_visit_arm_1", multiple = TRUE),
                              
                              
                              img(src = "legend.png", height = 125, width = 265)
                              
                            ),
                            mainPanel(
                              "Overlay Plot", 
                              plotlyOutput(outputId = "cohort_overlay"),
                              "Violin Plot",
                              plotlyOutput(outputId = "cohort_violin")
                              
                            )
                          )
                 ),
                 
        
                 
                 tabPanel(title = "Biomarker Score Distribution by DAG(s)", 
                          
                          # Sidebar with a slider input for number of bins 
                          sidebarLayout(
                            sidebarPanel(
                              selectInput(inputId = "form_var", 
                                          label = "select CRF/Survey:",
                                          choices = levels(score_data$form),
                                          selected = "BPI", multiple = FALSE),
                              
                              selectInput(inputId = "form_time", 
                                          label = "select event:",
                                          choices = levels(score_data$redcap_event_name),
                                          selected = "baseline_visit_arm_1", multiple = TRUE),
                              
                              
                              
                              
                              img(src = "A2cps.png", height = 100, width = 250),
                              
                              h5("Distribution of Biomarker Scores")
                              
                            ),
                            
                            
                            
                            
                            # Show a plot of the generated distribution
                            mainPanel(
                              tags$style(type="text/css", # Sanitize the output so that it is not rendered instead of showing warnings/errors
                                         ".shiny-output-error { visibility: hidden; }",
                                         ".shiny-output-error:before { visibility: hidden; }"),
                              tabsetPanel(
                                tabPanel("Plots", 
                                         splitLayout(cellArgs = list(style = "padding: 6px"),cellWidths = c("33%","33%","33%"),
                                                     plotlyOutput("ns_score"),
                                                     plotlyOutput("chic_score"),
                                                     plotlyOutput("rush_score")),
                                         splitLayout(style = "border: 1px grey;",cellWidths = c("50%","50%"),
                                                     plotlyOutput("mich_score"),
                                                     plotlyOutput("sp_score"))) 
                                
                              )
                            )
                          )
                 ),
                 
                 
                 tabPanel(title = "Comparison across MCC sites", 
                          
                          # Sidebar with a slider input for number of bins 
                          sidebarLayout(
                            sidebarPanel(
                              selectInput(inputId = "mdag_error", 
                                          label = "select CRF/Survey:",
                                          choices = levels(freq_datam1m2_2$dataset)),
                              
                              
                              
                              img(src = "A2cps.png", height = 100, width = 250),
                              
                              h5("Counts of each error across DAGs")
                              
                            ),
                            
                            
                            
                            
                            # Show a plot of the generated distribution
                            mainPanel(
                              tags$style(type="text/css", # Sanitize the output so that it is not rendered instead of showing warnings/errors
                                         ".shiny-output-error { visibility: hidden; }",
                                         ".shiny-output-error:before { visibility: hidden; }"),
                              tabsetPanel(
                                tabPanel("Plots", 
                                         splitLayout(cellArgs = list(style = "padding: 6px"),cellWidths = c("33%","33%","33%"),
                                                     plotlyOutput("plot_ns_comp"),
                                                     plotlyOutput("plot_chic_comp"),
                                                     plotlyOutput("plot_rush_comp")),
                                         splitLayout(style = "border: 1px grey;",cellWidths = c("50%","50%"),
                                                     plotlyOutput("plot_mich_comp"),
                                                     plotlyOutput("plot_sp_comp")),
                                         splitLayout(cellArgs = list(style = "padding: 6px"),cellWidths = c("50%","50%"),
                                                     plotlyOutput("plot_m2kmich_comp"),
                                                     plotlyOutput("plot_m2ksp_comp")))
                                
                              )
                            )
                          )
                 ),
                 
                 
                 tabPanel(title = "MCC1 TKA Reports", 
                          sidebarLayout(
                            sidebarPanel(
                              conditionalPanel(condition = "input.tabselected==1",
                                               
                                               
                                               selectInput(inputId = "iLocation_img", 
                                                           label = "select DAG:",
                                                           choices = levels(irerror1_2_3_4_5_6_7_8_notes$redcap_data_access_group)),
                                               
                                               selectInput(inputId = "img_last_seen", 
                                                           label = "Last seen:",
                                                           choices = levels(irerror1_2_3_4_5_6_7_8_notes$last_seen))
                                               
                                               
                              ),
                              conditionalPanel(condition = "input.tabselected==2",
                                               
                                               selectInput(inputId = "iLocation_func", 
                                                           label = "select DAG:",
                                                           choices = levels(frfunc_table$redcap_data_access_group)),
                                               selectInput(inputId = "func_last_seen", 
                                                           label = "Last seen:",
                                                           choices = levels(frfunc_table$last_seen))
                                               
                              ),
                              conditionalPanel(condition = "input.tabselected==3",
                                               
                                               selectInput(inputId = "iLocation_qst", 
                                                           label = "select DAG:",
                                                           choices = levels(tr_final_image$redcap_data_access_group)),
                                               
                                               selectInput(inputId = "iqst_test", 
                                                           label = "select QST Test:",
                                                           choices = levels(tr_final_image$QST_test)),
                                               
                                               selectInput(inputId = "qst_last_seen", 
                                                           label = "Last seen:",
                                                           choices = levels(tr_final_image$last_seen))
                                               
                                               
                                               
                              ),
                              conditionalPanel(condition = "input.tabselected==4",
                                               
                                               selectInput(inputId = "iLocation_bld", 
                                                           label = "select DAG:",
                                                           choices = levels(brflag_comments$redcap_data_access_group)),
                                               selectInput(inputId = "bld_last_seen", 
                                                           label = "Last seen",
                                                           choices = levels(brflag_comments$last_seen))
                                               
                              )
                            ),
                            mainPanel(
                              tabsetPanel(id = "tabselected",
                                          tabPanel("MCC1 Functional",value = 2, DTOutput(outputId = "func")) ,
                                          tabPanel("MCC1 Imaging",value = 1, DTOutput(outputId = "img")), 
                                          tabPanel("MCC1 QST",value = 3, DTOutput(outputId = "qst")),
                                          tabPanel("MCC1 Blood Draw",value = 4, DTOutput(outputId = "bld"))
                              )
                            ))),
                 
                 
                 tabPanel(title = "MCC2 TKA Reports", 
                          sidebarLayout(
                            sidebarPanel(
                              conditionalPanel(condition = "input.tabselectedm2k==1",
                                               
                                               
                                               selectInput(inputId = "iLocation_imgm2k", 
                                                           label = "select DAG:",
                                                           choices = levels(m2kirerror1_2_3_4_5_6_7_8_notes$redcap_data_access_group)),
                                               
                                               selectInput(inputId = "img_last_seenm2k", 
                                                           label = "Last seen:",
                                                           choices = levels(m2kirerror1_2_3_4_5_6_7_8_notes$last_seen))
                                               
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm2k==2",
                                               
                                               selectInput(inputId = "iLocation_funcm2k", 
                                                           label = "select DAG:",
                                                           choices = levels(m2kfrfunc_table$redcap_data_access_group)),
                                               selectInput(inputId = "func_last_seenm2k", 
                                                           label = "Last seen:",
                                                           choices = levels(m2kfrfunc_table$last_seen))
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm2k==3",
                                               
                                               selectInput(inputId = "iLocation_qstm2k", 
                                                           label = "select DAG:",
                                                           choices = levels(m2ktr_final_image$redcap_data_access_group)),
                                               
                                               selectInput(inputId = "iqst_testm2k", 
                                                           label = "select QST Test:",
                                                           choices = levels(m2ktr_final_image$QST_test)),
                                               
                                               selectInput(inputId = "qst_last_seenm2k", 
                                                           label = "Last seen:",
                                                           choices = levels(m2ktr_final_image$last_seen))
                                               
                                               
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm2k==4",
                                               
                                               selectInput(inputId = "iLocation_bldm2k", 
                                                           label = "select DAG:",
                                                           choices = levels(m2kbrflag_comments$redcap_data_access_group)),
                                               selectInput(inputId = "bld_last_seenm2k", 
                                                           label = "Last seen",
                                                           choices = levels(m2kbrflag_comments$last_seen))
                                               
                              )
                            ),
                            mainPanel(
                              tabsetPanel(id = "tabselectedm2k",
                                          tabPanel("MCC2 TKA Functional",value = 2, DTOutput(outputId = "funcm2k")) ,
                                          tabPanel("MCC2 TKA Imaging",value = 1, DTOutput(outputId = "imgm2k")), 
                                          tabPanel("MCC2 TKA QST",value = 3, DTOutput(outputId = "qstm2k")),
                                          tabPanel("MCC2 TKA Blood Draw",value = 4, DTOutput(outputId = "bldm2k"))
                              )
                            ))),
                 
                 
                 
                 tabPanel(title = "MCC1 Thoracic Reports", 
                          sidebarLayout(
                            sidebarPanel(
                              conditionalPanel(condition = "input.tabselectedm1t==1",
                                               
                                               
                                               selectInput(inputId = "iLocation_imgm1t", 
                                                           label = "select DAG:",
                                                           choices = levels(m1tirerror1_2_3_4_5_6_7_8_notes$redcap_data_access_group)),
                                               selectInput(inputId = "img_lastseenm1t", 
                                                           label = "Last seen",
                                                           choices = levels(m1tirerror1_2_3_4_5_6_7_8_notes$last_seen))
                                               
                                               
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm1t==2",
                                               
                                               selectInput(inputId = "iLocation_funcm1t", 
                                                           label = "select DAG:",
                                                           choices = levels(m1tcough1_notes$redcap_data_access_group)),
                                               selectInput(inputId = "func_lastseenm1t", 
                                                           label = "Last seen",
                                                           choices = levels(m1tcough1_notes$last_seen))
                                               
                              ),
                              
                              
                              conditionalPanel(condition = "input.tabselectedm1t==3",
                                               
                                               selectInput(inputId = "iLocation_qstm1t", 
                                                           label = "select DAG:",
                                                           choices = levels(m1ttr_final_image$redcap_data_access_group)),
                                               
                                               selectInput(inputId = "iqst_testm1t", 
                                                           label = "select QST Test:",
                                                           choices = levels(m1ttr_final_image$QST_test)),
                                               
                                               selectInput(inputId = "qst_lastseenm1t", 
                                                           label = "Last seen",
                                                           choices = levels(m1ttr_final_image$last_seen))
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm1t==4",
                                               
                                               selectInput(inputId = "iLocation_bldm1t", 
                                                           label = "select DAG:",
                                                           choices = levels(m1tbrflag_comments$redcap_data_access_group)),
                                               selectInput(inputId = "bld_lastseenm1t", 
                                                           label = "Last seen",
                                                           choices = levels(m1tbrflag_comments$last_seen))
                                               
                              )
                            ),
                            mainPanel(
                              tabsetPanel(id = "tabselectedm1t",
                                          tabPanel("MCC1 Thoracic Imaging",value = 1, DTOutput(outputId = "imgm1t")),
                                          tabPanel("MCC1 Thoracic Functional",value = 2, DTOutput(outputId = "funcm1t")) ,
                                          tabPanel("MCC1 Thoracic QST",value = 3, DTOutput(outputId = "qstm1t")),
                                          tabPanel("MCC1 Thoracic Blood Draw",value = 4, DTOutput(outputId = "bldm1t"))
                              )
                            ))),
                 
                 tabPanel(title = "MCC2 Thoracic Reports", 
                          sidebarLayout(
                            sidebarPanel(
                              conditionalPanel(condition = "input.tabselectedm2==1",
                                               
                                               
                                               selectInput(inputId = "iLocation_imgm2", 
                                                           label = "select DAG:",
                                                           choices = levels(m2irerror1_2_3_4_5_6_7_8_notes$redcap_data_access_group)),
                                               selectInput(inputId = "imgm2_lastseen", 
                                                           label = "Last seen",
                                                           choices = levels(m2irerror1_2_3_4_5_6_7_8_notes$last_seen))
                                               
                                               
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm2==2",
                                               
                                               selectInput(inputId = "iLocation_funcm2", 
                                                           label = "select DAG:",
                                                           choices = levels(cough1_notes$redcap_data_access_group)),
                                               selectInput(inputId = "funcm2_lastseen", 
                                                           label = "Last seen",
                                                           choices = levels(cough1_notes$last_seen))
                                               
                              ),
                              
                              
                              conditionalPanel(condition = "input.tabselectedm2==3",
                                               
                                               selectInput(inputId = "iLocation_qstm2", 
                                                           label = "select DAG:",
                                                           choices = levels(m2tr_final_image$redcap_data_access_group)),
                                               
                                               selectInput(inputId = "iqst_testm2", 
                                                           label = "select QST Test:",
                                                           choices = levels(m2tr_final_image$QST_test)),
                                               
                                               selectInput(inputId = "qstm2_lastseen", 
                                                           label = "Last seen",
                                                           choices = levels(m2tr_final_image$last_seen))
                                               
                              ),
                              conditionalPanel(condition = "input.tabselectedm2==4",
                                               
                                               selectInput(inputId = "iLocation_bldm2", 
                                                           label = "select DAG:",
                                                           choices = levels(m2brflag_comments$redcap_data_access_group)),
                                               selectInput(inputId = "bldm2_lastseen", 
                                                           label = "Last seen",
                                                           choices = levels(m2brflag_comments$last_seen))
                                               
                              )
                            ),
                            mainPanel(
                              tabsetPanel(id = "tabselectedm2",
                                          tabPanel("MCC2 Imaging",value = 1, DTOutput(outputId = "imgm2")),
                                          tabPanel("MCC2 Functional",value = 2, DTOutput(outputId = "funcm2")) ,
                                          tabPanel("MCC2 QST",value = 3, DTOutput(outputId = "qstm2")),
                                          tabPanel("MCC2 Blood Draw",value = 4, DTOutput(outputId = "bldm2"))
                              )
                            )))
                 
                 
)








# Define server logic required to draw a histogram
server <- function(input, output, session) {
  
  output$plot_complete <- renderPlotly({
    m1m2ds_tbl %>%
      filter(data_type != "dataNot_applicable") %>% 
      filter(var == input$inputVAR) %>% 
      filter(redcap_event_name %in%  input$inputTime) %>% 
      filter(redcap_data_access_group %in% input$inputLocation) %>% 
      group_by(redcap_data_access_group, redcap_event_name,data_type) %>%
      summarise(total=n()) %>% 
      group_by(redcap_data_access_group) %>% 
      pivot_wider(names_from = data_type,values_from = total) %>% 
      rowwise() %>%
      mutate(sum_all = sum(across(starts_with("data")), na.rm = T)) %>% 
      mutate(prop = datacomplete_with_no_errors/sum_all) %>% 
      ggplot(aes(x = redcap_data_access_group, y = prop, fill = redcap_event_name)) +
      geom_bar(position="dodge", stat="identity") +
      labs(title="Plot showing % error free forms completed",
           x ="Forms completed without errors", y = "Percent") +
      scale_y_continuous(labels = percent)
  })
  
  output$plot_errors <-  renderPlotly({
    m1m2ds_tbl %>%
      filter(data_type != "dataNot_applicable") %>% 
      filter(var == input$inputVAR) %>% 
      filter(redcap_event_name %in%  input$inputTime) %>% 
      filter(redcap_data_access_group %in% input$inputLocation) %>% 
      group_by(redcap_data_access_group, redcap_event_name,data_type) %>%
      summarise(total=n()) %>% 
      group_by(redcap_data_access_group) %>% 
      pivot_wider(names_from = data_type,values_from = total) %>% 
      rowwise() %>%
      mutate(sum_all = sum(across(starts_with("data")), na.rm = T)) %>% 
      mutate(prop = datacomplete_with_errors/sum_all) %>% 
      ggplot(aes(x = redcap_data_access_group, y = prop, fill = redcap_event_name)) +
      geom_bar(position="dodge", stat="identity") +
      labs(title="Plot showing % forms completed with errors with errors",
           x ="Forms completed with errors", y = "Percent") +
      scale_y_continuous(labels = percent)
  })
  
  
  output$plot_incomplete <-  renderPlotly({
    m1m2ds_tbl %>%
      filter(data_type != "dataNot_applicable") %>% 
      filter(var == input$inputVAR) %>% 
      filter(redcap_event_name %in%  input$inputTime) %>% 
      filter(redcap_data_access_group %in% input$inputLocation) %>% 
      group_by(redcap_data_access_group, redcap_event_name,data_type) %>%
      summarise(total=n()) %>% 
      group_by(redcap_data_access_group) %>% 
      pivot_wider(names_from = data_type,values_from = total) %>% 
      rowwise() %>%
      mutate(sum_all = sum(across(starts_with("data")), na.rm = T)) %>% 
      mutate(prop = dataincomplete/sum_all) %>% 
      ggplot(aes(x = redcap_data_access_group, y = prop, fill = redcap_event_name)) +
      geom_bar(position="dodge", stat="identity") +
      labs(title="Plot showing % incomplete forms ",
           x ="incomplete forms",  y = "Percent") +
      scale_y_continuous(labels = percent)
    
  })
  
  
  output$plot_notavailable <- renderPlotly({
    m1m2ds_tbl %>%
      filter(data_type != "dataNot_applicable") %>% 
      filter(var == input$inputVAR) %>% 
      filter(redcap_event_name %in%  input$inputTime) %>% 
      filter(redcap_data_access_group %in% input$inputLocation) %>% 
      group_by(redcap_data_access_group, redcap_event_name,data_type) %>%
      summarise(total=n()) %>% 
      group_by(redcap_data_access_group) %>% 
      pivot_wider(names_from = data_type,values_from = total) %>% 
      rowwise() %>%
      mutate(sum_all = sum(across(starts_with("data")), na.rm = T)) %>% 
      mutate(prop = datanot_available/sum_all) %>% 
      ggplot(aes(x = redcap_data_access_group, y = prop, fill = redcap_event_name)) +
      geom_bar(position="dodge", stat="identity") +
      labs(title="Plot showing % forms with completion status 'Not Available'",
           x ="Status: Not Available", y = "Percent") +
      scale_y_continuous(labels = percent)
    
    
  })
  
  output$plot30m1 <- renderPlot({
    
    upset(m1_biomarker_35upsetplot, sets = c("KOOS","BPI", "Depression" ,  "Anxiety",  "Catastophizing" ,"FearMovement" ,"Sleep" , 
                                          "Sleep_hours" ,"Funtional","Blood_Draw" , "Imaging" , "QST" , "Cognition" ,"Resilience" ,"Social_Support" ,  "ACE","Baseline_Traj"),
          keep.order = TRUE, mb.ratio = c(0.55, 0.45), order.by = "freq")
  })
  
  output$text30m1 <- renderText({"MCC1 TKA < 35 days from Baseline visit"})

  output$plot7m1 <- renderPlot({
    
    upset(m1_biomarker_7moupsetplot, sets = c("KOOS","BPI", "Depression" ,  "Anxiety",  "Catastophizing" ,"FearMovement" ,"Sleep" , 
                                          "Sleep_hours" ,"Funtional","Blood_Draw" , "Imaging" , "QST" , "Cognition" ,"Resilience" ,"Social_Support" ,  "ACE" ,"Baseline_Traj", "6_months_Traj"),
          keep.order = TRUE, mb.ratio = c(0.55, 0.45), order.by = "freq")
  })
  
  output$text7m1 <- renderText({"MCC1 TKA > 7 months from Baseline visit"})
 
  output$plot30m2 <- renderPlot({
    
    upset(m2_biomarker_35upsetplot, sets = c("BPI", "Depression" ,  "Anxiety",  "Catastophizing" ,"FearMovement" ,"Sleep" , 
                                          "Sleep_hours" ,"Funtional","Blood_Draw" , "Imaging" , "QST" , "Cognition" ,"Resilience" ,"Social_Support" ,  "ACE","Baseline_Traj"),
          keep.order = TRUE, mb.ratio = c(0.55, 0.45), order.by = "freq")
  })
  
  output$text30m2 <- renderText({"MCC2 Thoracic < 35 days from Baseline visit"})
  
  output$plot7m2 <- renderPlot({
    
    upset(m2_biomarker_7moupsetplot, sets = c("BPI", "Depression" ,  "Anxiety",  "Catastophizing" ,"FearMovement" ,"Sleep" , 
                                             "Sleep_hours" ,"Funtional","Blood_Draw" , "Imaging" , "QST" , "Cognition" ,"Resilience" ,"Social_Support" ,  "ACE" ,"Baseline_Traj", "6_months_Traj"),
          keep.order = TRUE, mb.ratio = c(0.55, 0.45), order.by = "freq")
  })
  
  output$text7m2 <- renderText({"MCC2 Thoracic > 7 months from Baseline visit"})
  
  
  output$plot30m2k <- renderPlot({
    
    upset(m2k_biomarker_35upsetplot, sets = c("BPI", "Depression" ,  "Anxiety",  "Catastophizing" ,"FearMovement" ,"Sleep" , 
                                             "Sleep_hours" ,"Funtional","Blood_Draw" , "Imaging" , "QST" , "Cognition" ,"Resilience" ,"Social_Support" ,  "ACE","Baseline_Traj"),
          keep.order = TRUE, mb.ratio = c(0.55, 0.45), order.by = "freq")
  })
  
  output$text30m2k <- renderText({"MCC2 TKA < 35 days from Baseline visit"})
  
  output$plot7m2k <- renderPlot({
    
    upset(m2k_biomarker_7moupsetplot, sets = c("BPI", "Depression" ,  "Anxiety",  "Catastophizing" ,"FearMovement" ,"Sleep" , 
                                              "Sleep_hours" ,"Funtional","Blood_Draw" , "Imaging" , "QST" , "Cognition" ,"Resilience" ,"Social_Support" ,  "ACE" ,"Baseline_Traj", "6_months_Traj"),
          keep.order = TRUE, mb.ratio = c(0.55, 0.45), order.by = "freq")
  })
  
  output$text7m2k <- renderText({"MCC2 TKA > 7 months from Baseline visit"})
  

  
  output$extra <- renderImage({list(src='www/screen.png',height=1100,width=1000)
  })
  
  new_tbl_react <- reactive({
    new_tbl %>% 
      filter(redcap_data_access_group == input$iLocation_newtbl & status %in% input$istatus_newtbl)
  })
  
  output$new_tbl <- renderDT({
    datatable(
      new_tbl_react(),escape = -1,
      style = "bootstrap",
      options = list(
        columnDefs = list(
          list(targets = 4:21, render = JS(custom_render))
          ,list(visible=FALSE,targets = 22:39))
      )
    ) %>% 
      formatStyle(
        'BPI',"b.bpi",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))%>%
      formatStyle(
        'koos',"b.koos",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'Anxiety',"b.anxiety",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'Depression',"b.dep",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'Catastrophizing',"b.cat",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'FearMovement',"b.move",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'Promis_Sleep',"b.sleep",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'sleep_hours',"b.sleep_hours",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'Functional',"b.func",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'BloodDraw',"b.blood",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'Imaging',"b.img",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'QST',"b.qst",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'cognition',"b.cog",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'social_support',"b.social",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'resilience',"b.res",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'ACE',"b.ace",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'six_mo_traj',"b.traj",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'acute_traj',"b.base_traj",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))
    
    
    
    
    
    
    
    
    
  })
  
  
  
  
  
  
### mcc1 knee reports 
  
  func_table_react <- reactive({
    frfunc_table %>% 
      filter(redcap_data_access_group == input$iLocation_func & last_seen == input$func_last_seen)
  })
  
  output$func <- renderDT({
    
    datatable(func_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
  
  })
  
  image_table_react <- reactive({
    irerror1_2_3_4_5_6_7_8_notes %>% 
      filter(redcap_data_access_group == input$iLocation_img & last_seen == input$img_last_seen)
  })
  
  output$img <- renderDT({
    
    datatable(image_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
  })
  
  qst_table_react <- reactive({
    tr_final_image  %>% 
      filter(redcap_data_access_group == input$iLocation_qst & QST_test == input$iqst_test  & last_seen == input$qst_last_seen)
  })
  
  output$qst <- renderDT({
    
    datatable(qst_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
  })
  
  bld_table_react <- reactive({
    brflag_comments  %>% 
      filter(redcap_data_access_group == input$iLocation_bld  & last_seen == input$bld_last_seen)
  })
  
  output$bld <- renderDT({
    
    datatable(bld_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    })
 
 # mcc2 knee reports
    
  
 
  m2kfunc_table_react <- reactive({
    m2kfrfunc_table %>% 
      filter(redcap_data_access_group == input$iLocation_funcm2k & last_seen == input$func_last_seenm2k)
  })
  
  output$funcm2k <- renderDT({
    
    datatable(m2kfunc_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
    
  })
  
  m2kimage_table_react <- reactive({
    m2kirerror1_2_3_4_5_6_7_8_notes %>% 
      filter(redcap_data_access_group == input$iLocation_imgm2k & last_seen == input$img_last_seenm2k)
  })
  
  output$imgm2k <- renderDT({
    
    datatable(m2kimage_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
  })
  
  m2kqst_table_react <- reactive({
    m2ktr_final_image  %>% 
      filter(redcap_data_access_group == input$iLocation_qstm2k & QST_test == input$iqst_testm2k  & last_seen == input$qst_last_seenm2k)
  })
  
  output$qstm2k <- renderDT({
    
    datatable(m2kqst_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
  })
  
  m2kbld_table_react <- reactive({
    m2kbrflag_comments  %>% 
      filter(redcap_data_access_group == input$iLocation_bldm2k  & last_seen == input$bld_last_seenm2k)
  })
  
  output$bldm2k <- renderDT({
    
    datatable(m2kbld_table_react(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
    
    
  })
  

#download button    
  
  output$downloadData <- downloadHandler(
    filename = function() { 
      paste("6_mo_dataset-", Sys.Date(), ".csv", sep="")
    },
    content = function(file) {
      write.csv(comp_dta_tbl, file)
    })
  
  output$extra1 <- renderImage({list(src='www/screen.png',height=1100,width=1000)
  })
  
  
  
  output$plot_ns_comp <-  renderPlotly({
    freq_datam1m2_2 %>% 
      ungroup() %>% 
      filter(dataset == input$mdag_error) %>% 
      filter(redcap_data_access_group == "northshore") %>% 
      group_by(redcap_data_access_group,dataset,error) %>%
      ggplot(aes(x = error, y = total, fill = error)) +
      geom_bar(stat="identity") +
      labs(title="Northshore",
           x ="Errors", y = "Count") +
      theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
    
    
    
    
    
  })
  
  
  
  output$plot_chic_comp <-  renderPlotly({
    freq_datam1m2_2 %>% 
      ungroup() %>% 
      filter(dataset == input$mdag_error) %>% 
      filter(redcap_data_access_group == "uchicago") %>% 
      group_by(redcap_data_access_group,dataset,error) %>%
      ggplot(aes(x = error, y = total, fill = error)) +
      geom_bar(stat="identity") +
      labs(title="Uchicago",
           x ="Errors", y = "Count") +
      theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
    
    
    
    
    
  })
  
  
  output$plot_rush_comp <-  renderPlotly({
    freq_datam1m2_2 %>% 
      ungroup() %>% 
      filter(dataset == input$mdag_error) %>% 
      filter(redcap_data_access_group == "rush_university_me") %>% 
      group_by(redcap_data_access_group,dataset,error) %>%
      ggplot(aes(x = error, y = total, fill = error)) +
      geom_bar(stat="identity") +
      labs(title="Rush University",
           x ="Errors", y = "Count") +
      theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
    
    
    
    
    
  })
  
  output$plot_sp_comp <-  renderPlotly({
    freq_datam1m2_2 %>% 
      ungroup() %>% 
      filter(dataset == input$mdag_error) %>% 
      filter(redcap_data_access_group == "spectrum_health") %>% 
      group_by(redcap_data_access_group,dataset,error) %>%
      ggplot(aes(x = error, y = total, fill = error)) +
      geom_bar(stat="identity") +
      labs(title="Spectrum Health",
           x ="Errors", y = "Count") +
      theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
    
    
    
    
    
  })
  
  output$plot_mich_comp <-  renderPlotly({
    freq_datam1m2_2 %>% 
      ungroup() %>% 
      filter(dataset == input$mdag_error) %>% 
      filter(redcap_data_access_group == "university_of_mich") %>% 
      group_by(redcap_data_access_group,dataset,error) %>%
      ggplot(aes(x = error, y = total, fill = error)) +
      geom_bar(stat="identity") +
      labs(title="UMich",
           x ="Errors", y = "Count") +
      theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
    
    
  })
  
  output$plot_m2kmich_comp <-  renderPlotly({
    freq_datam1m2_2 %>% 
      ungroup() %>% 
      filter(dataset == input$mdag_error) %>% 
      filter(redcap_data_access_group == "MCC2_TKA_university_of_mich") %>% 
      group_by(redcap_data_access_group,dataset,error) %>%
      ggplot(aes(x = error, y = total, fill = error)) +
      geom_bar(stat="identity") +
      labs(title="TKA UMich",
           x ="Errors", y = "Count") +
      theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
    
    
    
  })
  
  


output$plot_m2ksp_comp <-  renderPlotly({
  freq_datam1m2_2 %>% 
    ungroup() %>% 
    filter(dataset == input$mdag_error) %>% 
    filter(redcap_data_access_group == "MCC2_TKA_spectrum_health") %>% 
    group_by(redcap_data_access_group,dataset,error) %>%
    ggplot(aes(x = error, y = total, fill = error)) +
    geom_bar(stat="identity") +
    labs(title="TKA Spectrum Health",
         x ="Errors", y = "Count") +
    theme(axis.text.x=element_text(angle=60,hjust=0.5,vjust=0.5))
  
  
  
})
  
  output$chic_score <-  renderPlotly({
    score_data %>% 
      filter(redcap_data_access_group == "uchicago") %>% 
      filter(form == input$form_var) %>% 
      filter(redcap_event_name == input$form_time) %>% 
      count(redcap_event_name,redcap_data_access_group,score, sort = TRUE) %>% 
      ggplot(aes(x = score,y = n,fill=redcap_event_name)) +
      geom_bar(stat="identity", position = 'dodge') +
      labs(title="Uchicago",
           x ="Score", y = "Count") +
      theme(axis.text.x=element_text(angle=70,hjust=1,vjust=0.5))
    
    
  })
  
  output$rush_score <- renderPlotly({
    score_data %>% 
      filter(redcap_data_access_group == "rush_university_me") %>% 
      filter(form == input$form_var) %>% 
      filter(redcap_event_name == input$form_time) %>% 
      count(redcap_event_name,redcap_data_access_group,score, sort = TRUE) %>% 
      ggplot(aes(x = score,y = n,fill=redcap_event_name)) +
      geom_bar(stat="identity", position = 'dodge') +
      labs(title="Rush",
           x ="Score", y = "Count") +
      theme(axis.text.x=element_text(angle=70,hjust=1,vjust=0.5))
    
    
    
    
    
  })
  
  output$ns_score <-  renderPlotly({
    score_data %>% 
      filter(redcap_data_access_group == "northshore") %>% 
      filter(form == input$form_var) %>% 
      filter(redcap_event_name == input$form_time) %>% 
      count(redcap_event_name,redcap_data_access_group,score, sort = TRUE) %>% 
      ggplot(aes(x = score,y = n,fill=redcap_event_name)) +
      geom_bar(stat="identity", position = 'dodge') +
      labs(title="Northshore",
           x ="Score", y = "Count") +
      theme(axis.text.x=element_text(angle=70,hjust=1,vjust=0.5))
    
    
    
    
  })
  
  
  output$mich_score <-  renderPlotly({
    score_data %>% 
      filter(redcap_data_access_group == "university_of_mich") %>% 
      filter(form == input$form_var) %>% 
      filter(redcap_event_name == input$form_time) %>% 
      count(redcap_event_name,redcap_data_access_group,score, sort = TRUE) %>% 
      ggplot(aes(x = score,y = n,fill=redcap_event_name)) +
      geom_bar(stat="identity", position = 'dodge') +
      labs(title="Umich",
           x ="Score", y = "Count") +
      theme(axis.text.x=element_text(angle=70,hjust=1,vjust=0.5))
    
  })
  
  output$sp_score <-  renderPlotly({
    score_data %>% 
      filter(redcap_data_access_group == "spectrum_health") %>% 
      filter(form == input$form_var) %>% 
      filter(redcap_event_name == input$form_time) %>% 
      count(redcap_event_name,redcap_data_access_group,score, sort = TRUE) %>% 
      ggplot(aes(x = score,y = n,fill=redcap_event_name)) +
      geom_bar(stat="identity", position = 'dodge') +
      labs(title="spectrum",
           x ="Score", y = "Count") +
      theme(axis.text.x=element_text(angle=70,hjust=1,vjust=0.5))
    
    
    
    
  })
  
  
  #mcc2 thoraci reports
  
  
  func_table_reactm2 <- reactive({
    cough1_notes %>% 
      filter(redcap_data_access_group == input$iLocation_funcm2 & last_seen == input$funcm2_lastseen)
  })
  
  output$funcm2 <- renderDT({
    
    datatable(func_table_reactm2(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  
  image_table_reactm2 <- reactive({
    m2irerror1_2_3_4_5_6_7_8_notes %>% 
      filter(redcap_data_access_group == input$iLocation_imgm2 & last_seen == input$imgm2_lastseen)
  })
  
  output$imgm2 <- renderDT({
    
    datatable(image_table_reactm2(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  
  bld_table_reactm2 <- reactive({
    m2brflag_comments %>% 
      filter(redcap_data_access_group == input$iLocation_bldm2 & last_seen == input$bldm2_lastseen)
  })
  
  output$bldm2 <- renderDT({
    
    datatable(bld_table_reactm2(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  dma_table_reactm2 <- reactive({
    dma_shrink_notes %>% 
      filter(redcap_data_access_group == input$iLocation_m2dma)
  })
  
  output$dmam2 <- renderDT({
    
    datatable(dma_table_reactm2(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  m2qst_table_reactm2 <- reactive({
    m2tr_final_image %>% 
      filter(redcap_data_access_group == input$iLocation_qstm2 & QST_test == input$iqst_testm2 & last_seen == input$qstm2_lastseen)
  })
  
  output$qstm2 <- renderDT({
    
    datatable(m2qst_table_reactm2(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })

  
  #mcc1 thoraci reports
  
  
  func_table_reactm1t <- reactive({
    m1tcough1_notes %>% 
      filter(redcap_data_access_group == input$iLocation_funcm1t & last_seen == input$func_lastseenm1t)
  })
  
  output$funcm1t <- renderDT({
    
    datatable(func_table_reactm1t(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  
  image_table_reactm1t <- reactive({
    m1tirerror1_2_3_4_5_6_7_8_notes %>% 
      filter(redcap_data_access_group == input$iLocation_imgm1t & last_seen == input$img_lastseenm1t)
  })
  
  output$imgm1t <- renderDT({
    
    datatable(image_table_reactm1t(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  
  bld_table_reactm1t <- reactive({
    m1tbrflag_comments %>% 
      filter(redcap_data_access_group == input$iLocation_bldm1t & last_seen == input$bld_lastseenm1t)
  })
  
  output$bldm1t <- renderDT({
    
    datatable(bld_table_reactm1t(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  

  
  qst_table_reactm1t <- reactive({
    m1ttr_final_image %>% 
      filter(redcap_data_access_group == input$iLocation_qstm1t & QST_test == input$iqst_testm1t & last_seen == input$qst_lastseenm1t)
  })
  
  output$qstm1t <- renderDT({
    
    datatable(qst_table_reactm1t(), style = "bootstrap",extensions = 'Buttons',filter = 'top',class = 'cell-border stripe', options = list(
      pageLength = 10, autoWidth = TRUE,dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
      formatStyle(columns = colnames(.), fontSize = '10%')
    
  })
  
  
  
  

  
  m2new_tbl_react <- reactive({
    m2new_tbl %>% 
      filter(redcap_data_access_group == input$iLocation_m2newtbl & status %in% input$istatus_m2newtbl)
  })
  
  
  output$m2new_tbl <- renderDT({
    datatable(
      m2new_tbl_react(),escape = -1,
      style = "bootstrap",
      options = list(
        columnDefs = list(
          list(targets = 4:20, render = JS(custom_render))
          ,list(visible=FALSE,targets = 21:37))
      )
    )  %>% 
      formatStyle(
        'mcc2_QST',"mb.qst",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2_Imaging',"mb.img",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))%>%
      formatStyle(
        'mcc2_BloodDraw',"mb.blood",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2_Functional',"mb.func",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 BPI',"mb.bpi",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))%>%
      formatStyle(
        'mcc2 Anxiety',"mb.anxiety",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 Depression',"mb.dep",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 Catastrophizing',"mb.cat",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 FearMovement',"mb.move",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 Promis_Sleep',"mb.sleep",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 sleep_hours',"mb.sleep_hours",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 cognition',"mb.cog",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'mcc2 social_support',"mb.social",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'mcc2 resilience',"mb.res",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2 ACE',"mb.ace",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow"))) %>% 
      formatStyle(
        'mcc2_six_mo_traj',"mb.traj",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))  %>% 
      formatStyle(
        'mcc2_acute_traj',"mb.base_traj",
        color = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")),
        border = '2px solid #FFFFFF',
        backgroundColor = styleEqual(c(1,0,2,7), c('lightblue','lightseagreen',"slategrey","lightyellow")))
    
    
  })
  
  
  # overlay plots
  
  
  output$cohort_overlay <-  renderPlotly({
    cohort_score_data %>% 
      ungroup() %>% 
      filter(form == input$cohort_form) %>% 
      filter(redcap_event_name == input$cohort_time) %>% 
      ggplot(aes(x=score, fill=cohort)) +
      geom_density(alpha=0.25)
    
    
    
    
  })
  
  
  output$cohort_violin <-  renderPlotly({
    cohort_score_data %>% 
      filter(form == input$cohort_form) %>% 
      filter(redcap_event_name == input$cohort_time) %>% 
      ggplot(aes(x=cohort,y=score,fill=cohort)) +
      geom_violin(trim = FALSE) +
      stat_summary(fun.y ="median", geom="point", size=2, color="blue")
    
   
    
  })
  
  
  
}



# Run the application 
shinyApp(ui = ui, server = server)
